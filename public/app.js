window._WebRegisterLoaded=!0;import{e,a as t,_ as n,b as s,r as a,c as i,d as r,i as o,f as l,V as c,g as d,m as u,h,j as m,k as g,l as p,s as v,n as y,o as f,p as S,q as C,t as b,u as _,v as w,w as M,x as T,y as E,z as k,A as I,B as P,C as R,D as A,E as D,F as N,G as x,H as O,I as $,J as L,K as F,L as U,T as B,M as q,N as V,O as K,P as G,S as j,Q,R as W,U as H,W as Y,X as z,Y as J,Z as X,$ as Z,a0 as ee,a1 as te,a2 as ne,a3 as se,a4 as ae,a5 as ie,a6 as re,a7 as oe,a8 as le,a9 as ce,aa as de,ab as ue,ac as he,ad as me,ae as ge,af as pe,ag as ve,ah as ye,ai as fe,aj as Se,ak as Ce,al as be,am as _e,an as we,ao as Me,ap as Te,aq as Ee,ar as ke,as as Ie,at as Pe,au as Re,av as Ae,aw as De,ax as Ne,ay as xe,az as Oe,aA as $e,aB as Le,aC as Fe}from"https://1mil.vercel.app/vend.js";function Ue(e){return e.data.data}let Be,qe,Ve,Ke,Ge,je,Qe,We,He,Ye,ze,Je,Xe,Ze,et,tt,nt;e(),t.module("vendQuickKeys",[]),t.module("webregister.http",[]),t.module("webregister.constants",[]),t.module("webregister.resolvers",[]),t.module("webregister.routes",[]),t.module("webregister.controllers",[]),t.module("webregister.filters",[]),t.module("webregister.directives",[]),t.module("webregister.components",[]),t.module("webregister.modals",[]),t.module("webregister.models",[]),t.module("webregister.factories",[]),t.module("webregister.services",[]),t.module("webregister.managers",[]),t.module("webregister.vendor",[]),t.module("webregister",["webregister.vendor","webregister.http","webregister.constants","webregister.components","webregister.resolvers","webregister.routes","webregister.filters","webregister.factories","webregister.managers","webregister.controllers","webregister.directives","webregister.modals","webregister.models","webregister.services"]),t.module("webregister").run(["$injector",e=>{Be=e.get("$compile"),qe=e.get("$document"),Ve=e.get("$filter"),Ke=e.get("$http"),Ge=e,je=e.get("$interval"),Qe=e.get("$log"),We=e.get("$q"),He=e.get("$rootScope"),Ye=e.get("$sce"),ze=e.get("$templateCache"),Je=e.get("$timeout"),Xe=e.get("$window"),Ze=e.get("$resource"),et=e.get("$state"),tt=e.get("$stateParams"),nt=e.get("$transitions")}]);const st=(e,t)=>{const n=`/api/2.0/button_layouts/${e}/nodes`;return t?`${n}/${t}`:n};let at,it;t.module("vendQuickKeys").factory("qkNodesResource",class{deleteQuickKey(e,t){const n=st(e,t);return Ke.delete(n)}createQuickKey(e,t){const n=st(e);return Ke.post(n,t).then(Ue)}updateQuickKey(e,t){const s=n(t,["id"]),a=st(e,t.id);return Ke.put(a,s).then(Ue)}}),function(e){e.RED="red",e.ORANGE="orange",e.YELLOW="yellow",e.GREEN="green",e.BLUE="blue",e.PURPLE="purple",e.WHITE="white"}(at||(at={})),function(e){e.ROOT="root",e.PAGE="page",e.FOLDER="folder",e.QUICK_KEY="quick-key",e.BLANK="blank"}(it||(it={}));const rt={color:at.WHITE,isChild:0,showImage:1,columns:1,rows:1},ot=rt,lt={columns:5,rows:5};var ct;!function(e){e[e.END_OF_ROW=0]="END_OF_ROW",e[e.BLANK_ROW=1]="BLANK_ROW",e[e.FULL_PAGE=2]="FULL_PAGE"}(ct||(ct={}));const dt=function(e){const t=e.node;return{label:mt("label",t),productId:t.product_id,isChild:pt("isChild",t)}},ut=function(e){const t=e&&e.id;return Boolean(t&&t.startsWith("qk-placeholder-page-"))},ht=function e(t,n){Tt(t,n),t.type!==it.ROOT&&t.type!==it.PAGE&&t.type!==it.FOLDER||t.children.forEach(t=>e(t,n))},mt=function(e,t){if(t&&t.attributes)for(const n of t.attributes)if(n.key===e)return n.value},gt=e=>mt("color",e),pt=function(e,t){return Boolean(Number(mt(e,t)))},vt=function({node:e,nodesByParentId:t,parentNode:n,options:s}){const{padEmptyRows:a}=s,i=t[e.id]||[],r=n?it.FOLDER:it.ROOT;let o=!1;if(a){let n;o=i.every((e,s)=>{const{pageSize:a,rowSize:r}=wt(e),o=(t[e.id]||[]).length,l=o===a;return s===i.length-1?(n=l,l||o%r==0):l}),(!i.length||o&&n)&&i.push(bt(e,r,{position:i.length}))}const l=i.sort((e,t)=>e.position-t.position).map((n,a,i)=>yt({node:n,parentNode:e,parentNodeType:r,nodesByParentId:t,pageIndex:a,numberOfPages:i.length,layerFull:o,options:s}));let c;return r===it.FOLDER&&(c={folderSize:l.reduce((e,t)=>e+t.children.length,0),label:mt("label",e),color:gt(e)}),{type:r,node:e,parentNode:n,children:l,viewData:c}},yt=function({node:e,nodesByParentId:t,parentNode:n,parentNodeType:s,pageIndex:a,numberOfPages:i,layerFull:r,options:o}){const{padEmptyRows:l,lockedQuickKeys:c}=o,d=(t[e.id]||[]).sort((e,t)=>e.position-t.position).map(n=>{const s={node:n,parentNode:e,nodesByParentId:t,options:o};return n.product_id?ft(s):vt(s)}),u=wt(e);let h=ct.END_OF_ROW;a<i-1?h=ct.FULL_PAGE:l&&(0===a?h=ct.FULL_PAGE:r&&(h=ct.BLANK_ROW));const m=St(e,d,{padBlanks:h,pageDimensions:u}),g={pageDimensions:u,nodes:m,pageColumns:Ct(m,u.rowSize),numberOfPages:i,pageIndex:a};s===it.ROOT&&0===a&&(g.close_folder=pt("close_folder",e));const p={type:it.PAGE,node:e,parentNode:n,children:d,viewData:g};return Tt(p,c),p},ft=function({node:e,parentNode:t}){const n={label:mt("label",e),color:gt(e),showImage:pt("showImage",e)};return{type:it.QUICK_KEY,node:e,parentNode:t,viewData:n}},St=function(e,t,{padBlanks:n,pageDimensions:s}){const a=[],{pageSize:i,rowSize:r}=s;if(t.forEach(t=>{const{position:n}=t.node;_t(e,a,n),a.push(t)}),n===ct.FULL_PAGE)a.length<i&&_t(e,a,i);else{const t=a.length%r;if(0!==t||n===ct.BLANK_ROW){const n=r-t;_t(e,a,a.length+n)}}return a},Ct=function(e,t){const n=[];for(let s=0;s<t;s+=1){const a=[];for(let n=s;n<e.length;n+=t)a.push(e[n]);n.push(a)}return n},bt=function(e,t,{position:n}){return{id:"qk-placeholder-page-"+e.id,parent_node_id:t===it.ROOT?null:e.id,position:n,product_id:null,attributes:[{key:"columns",value:"5"},{key:"rows",value:"5"}]}},_t=function(e,t,n){for(let s=t.length;s<n;s+=1){const n={type:it.BLANK,viewData:{color:it.BLANK},node:{id:`${e.id}-blank-${s}`,product_id:null,attributes:[],parent_node_id:e.id,position:s},parentNode:e};t.push(n)}},wt=function(e){const t=Number(mt("columns",e))||5,n=Number(mt("rows",e))||5;return{pageSize:t*n,rowSize:t,columnSize:n}},Mt=function(e){const t={};return e.nodes.forEach(n=>{const s=n.parent_node_id||e.id;let a=t[s];a||(a=[],t[s]=a),a.push(n)}),t},Tt=function(e,t){const n=e.type===it.PAGE&&e.viewData.nodes;n&&n.forEach(e=>{e.locked=Boolean(t&&-1!==t.indexOf(e.node.id))})};t.module("vendQuickKeys").service("qkModals",["Modal",function(e){this.editQuicKey=function(n,s){e({template:'<vd-dialog class="vd-edit-qk-modal"\n  header="Edit {{modalCtrl.displayQuickKeyType}}"\n  focus-first-element="false"\n  close="modalCtrl.close">\n  <div class="vd-dialog-content">\n    <form name="qkEditForm" id="qkEditForm">\n      <div ng-if="modalCtrl.isQuickKey" class="vd-edit-qk-modal-row">\n        <vd-quick-key quick-key="modalCtrl.quickKey"\n          layout="modalCtrl.layout"\n          read-only="true"\n          class="vd-quick-key"\n          ng-class="[\n            \'vd-quick-key--\' + modalCtrl.quickKey.viewData.color,\n            \'vd-quick-key--\' + modalCtrl.quickKey.type\n          ]">\n        </vd-quick-key>\n        <div class="vd-flex vd-flex--justify-center vd-flex--column">\n          <div ng-if="modalCtrl.loadingProductInfo"\n            class="vd-flex vd-flex--justify-center vd-flex--column vd-flex--align-center">\n            <div class="vd-loader vd-loader--small vd-mb1"></div>\n            <div class="vd-text--sub">Retrieving product information</div>\n          </div>\n          <div ng-if="!modalCtrl.loadingProductInfo">\n            <vd-header ng-if="modalCtrl.productName">{{::modalCtrl.productName}}</vd-header>\n            <div ng-if="modalCtrl.productName && modalCtrl.productSku" class="vd-text--sub">\n              {{::modalCtrl.productSku}}\n            </div>\n            <em ng-if="!modalCtrl.productName" class="vd-text--sub">\n              Product information can\'t be displayed at the moment.<br />\n              Don\'t worry you can still save this Quick Key.\n            </em>\n          </div>\n        </div>\n      </div>\n      <div class="vd-edit-qk-modal-row">\n        <div class="vd-field">\n          <div class="vd-label">{{modalCtrl.displayQuickKeyType}} Label</div>\n          <div class="vd-value">\n            <input name="qkLabel"\n              ng-model="modalCtrl.quickKey.viewData.label"\n              ng-disabled="modalCtrl.awaitingServer"\n              ng-maxlength="255"\n              autocomplete="off"\n              spellcheck="false"\n              vd-focus="{ isFocusable: true }"\n              class="vd-input"\n              ng-class="{ \'vd-error\': !qkEditForm.qkLabel.$valid }">\n          </div>\n        </div>\n      </div>\n      <div class="vd-edit-qk-modal-row">\n        <div class="vd-field">\n          <div class="vd-label">{{modalCtrl.displayQuickKeyType}} Color</div>\n          <div class="vd-value">\n            <vd-quick-key-colour-palette selected-colour="modalCtrl.quickKey.viewData.color" on-change="modalCtrl.changeColour"></vd-quick-key-colour-palette>\n          </div>\n        </div>\n      </div>\n      <div ng-if="modalCtrl.isQuickKey" class="vd-edit-qk-modal-row">\n        <div class="vd-field">\n          <label class="vd-value">\n            <vd-switch modifier="small" ng-model="modalCtrl.quickKey.viewData.showImage" class="vd-mr3"></vd-switch>\n            Show image\n          </label>\n        </div>\n      </div>\n    </form>\n  </div>\n\n  <div class="vd-dialog-actions">\n    <div class="vd-btn-group">\n      <button type="button"\n        class="vd-btn vd-btn--text-no"\n        ng-click="modalCtrl.deleteQuickKey()"\n        ng-disabled="modalCtrl.awaitingServer">\n        <i class="fa fa-trash vd-edit-qk-modal-delete-icon"></i> Delete {{modalCtrl.displayQuickKeyType}}\n      </button>\n      <button type="submit"\n        class="vd-btn vd-btn--do"\n        form="qkEditForm"\n        ng-click="modalCtrl.saveChanges()"\n        ng-disabled="modalCtrl.awaitingServer || !qkEditForm.$valid">\n        <span ng-if-start="modalCtrl.awaitingServer">Saving\u2026</span>\n        <span ng-if-end class="vd-loader vd-loader--small"></span>\n        <span ng-if="!modalCtrl.awaitingServer">Save</span>\n      </button>\n    </div>\n  </div>\n</vd-dialog>\n',dismissible:!0}).then(e=>{const a=e.controller;function i(t){e.scope.$applyAsync(()=>{a.awaitingServer=t})}a.layout=n,a.isQuickKey=s.type===it.QUICK_KEY,a.displayQuickKeyType=a.isQuickKey?"Quick Key":"Folder",a.isQuickKey&&(a.loadingProductInfo=!0,n.getProduct(s).then(e=>{if(e){const{isChild:t}=dt(s);a.productName=t?e.variant_name:e.name,e.has_variants&&!t||(a.productSku=e.sku)}}).finally(()=>{a.loadingProductInfo=!1})),a.quickKey=t.copy(s),a.awaitingServer=!1,a.changeColour=t=>{e.scope.$applyAsync(()=>{a.quickKey.viewData.color=t})},a.saveChanges=function(){i(!0),n.updateQuickKey(a.quickKey).finally(()=>a.close())},a.deleteQuickKey=function(){i(!0),n.deleteQuickKey(s).finally(()=>a.close())},e.scope.$watch("modalCtrl.awaitingServer",e=>{a.dismissible=!e})})}}]);class Et{constructor(){s(this,"listeners",{})}on(e,t,n){let s=this.listeners[e];if(s||(s=this.listeners[e]=[]),n){const e=t.bind(n);e._=t,s.push(e)}else s.push(t)}once(e,t,n){const s=(...a)=>{this.off(e,s),t.apply(n,a)};return s._=t,this.on(e,s)}emit(e,...t){const n=this.listeners[e];n&&n.forEach(e=>{e(...t)})}off(e,t){const n=this.listeners[e];if(!n)return;const s=t?n.filter(e=>e!==t&&e._!==t):[];s.length?this.listeners[e]=s:delete this.listeners[e]}}t.module("vendQuickKeys").factory("QuickKeysLayoutDataAdaptor",(function(){return class extends Et{constructor(e={}){super(),s(this,"_getProduct",void 0),s(this,"_layout",void 0),s(this,"_registered",void 0),this._getProduct=e.getProductFn||function(){},this._registered=We.defer()}whenRegistered(){return this._registered.promise}addProduct(e,t){return We((n,s)=>this._layout?this._layout.editable?void this._layout.addQuickKey(e,t).then(n,s):s(new Error("The layout registered with the edit adaptor is not currently editable")):s(new Error("No layout has been registered with the edit adaptor yet")))}getProduct(e){return this._getProduct(e)}getCloseFolderOption(){return Boolean(this._layout&&this._layout.getCloseFolderOption())}setCloseFolderOption(e){return We((t,n)=>{if(!this._layout)return n(new Error("No layout has been registered with the edit adaptor yet"));this._layout.setCloseFolderOption(e).then(t,n)})}get updateInProgress(){return this._layout&&this._layout.updateInProgress}_registerQuickKeysLayout(e){this._layout=e,this._layout.registerDataAdaptor(this),this._layout.on("layoutUpdatingChange",e=>this.emit("layoutUpdatingChange",e)),this._layout.on("layoutUpdate",e=>this.emit("layoutUpdate",e)),this._layout.on("layoutUpdateError",e=>this.emit("layoutUpdateError",e)),this._registered.resolve()}}}));const kt=(e,t,{includeBlanks:n=!1,excludeNonBlanks:s=!1}={})=>{const{direction:a}=t,i=t.fromPosition||{pageIndex:0,position:-1},r=It(e,i);let o,{toPosition:l,to:c}=t;const d=e=>{const t=e.type===it.BLANK;return e.locked||!n&&t||s&&!t},u=t=>{let n=t;do{if(n=Pt(e,n,a),c=n&&It(e,n),c&&o!==c?o||(o=c):n=null,!n){n=null,c=null;break}}while(d(c));l=n};return l||c?c||(c=It(e,l),d(c)&&u(l)):u(i),{from:r,fromPosition:i,to:c,toPosition:l}},It=(e,t)=>{const n=e.children[t.pageIndex];return n&&n.viewData.nodes[t.position]},Pt=(e,t,n)=>{const s=e.children;if(!s.length)return null;const a=s.length-1;let i,r,{pageIndex:o,position:l}=t;function c(){const e=s[o];i=e.viewData.nodes.length,r=e.viewData.pageDimensions.rowSize}function d(){o="RIGHT"===n||"DOWN"===n?o<a?o+1:0:o>0?o-1:a,c()}switch(c(),n){case"UP":l>=r?l-=r:(d(),l=i-r+l,o===a&&(l-=1,l<i-r&&(l=i-1)));break;case"DOWN":l<i-r?l+=r:(d(),l=(0===o?l+1:l)%r);break;case"LEFT":l>0?l-=1:(d(),l=i-1);break;case"RIGHT":default:l<i-1?l+=1:(d(),l=0)}return{pageIndex:o,position:l}};function Rt(e){return class extends Et{constructor(e,t={}){super(),s(this,"_draggedQuickKey",void 0),s(this,"_editTarget",void 0),s(this,"_editable",void 0),s(this,"_folder",void 0),s(this,"_layoutData",void 0),s(this,"_layoutLocked",void 0),s(this,"_lockedQuickKeys",void 0),s(this,"_queue",void 0),s(this,"_queuedUpdates",void 0),s(this,"_quickKeysLayoutDataAdaptor",void 0),s(this,"_rootNode",void 0),s(this,"_updateInProgress",void 0),this._queue=We.resolve(),this._lockedQuickKeys={},this._layoutData=e,this._editable=Boolean(t.editable),this._layoutLocked=!1,this._rootNode=null,this._folder=null,this._editTarget=null,this._draggedQuickKey=null,this._updateInProgress=!1,this._queuedUpdates=0,this.updateLayout()}get rootNode(){return this._rootNode}get folder(){return this._folder}set folder(e){this._folder=e,this._editable&&this._resetEditTarget()}get editable(){return!this._layoutLocked&&this._editable}set editable(e){const t=this._editable;this._editable=Boolean(e),t!==this._editable&&this.updateLayout()}get updateInProgress(){return this._updateInProgress}get editTarget(){return this._editTarget}set editTarget(e){this._editTarget=e}get draggedQuickKey(){return this._draggedQuickKey}set draggedQuickKey(e){this._draggedQuickKey=e}selectQuickKey(e){const t=dt(e);this.getCloseFolderOption()&&(this._folder=null),this.emit("quick-key-selected",t)}updateLayout(e){t.isUndefined(e)||(this._layoutData=e);const n=this._rootNode&&this._rootNode.node.id;this._layoutData&&this._layoutData.nodes?(this._rootNode=function(e,t={}){const n=Mt(e),s={id:e.id,product_id:null,name:e.name,attributes:[],parent_node_id:null,position:0};return vt({node:s,nodesByParentId:n,parentNode:void 0,options:t})}(this._layoutData,{padEmptyRows:this._editable,lockedQuickKeys:Object.keys(this._lockedQuickKeys)}),this._folder&&(this._folder=function(e,t,n){if(t!==n.node.id)return null;const s=e.node.id;let a=null;return n.children.some(e=>{const t=e.children.find(e=>s===e.node.id);return t&&(a=t),t}),a}(this._folder,n,this._rootNode)),this._editable&&this._resetEditTarget()):(this._rootNode=null,this._folder=null)}addQuickKey(e,t={}){return We((n,s)=>{if(!this.editable||!this._editTarget)return s(new Error("This layout is not currently editable"));if(!e||!e.id)return s(new TypeError("The given product is not defined or has no product ID"));const{exactMatch:a}=t,{node:i,parentNode:r}=this._editTarget,o=this._buildQuickKeyNode({quickKeyData:{product_id:e.id,position:i.position,parent_node_id:i.parent_node_id},attributeData:{label:a?e.variant_name:e.name,isChild:a?1:0},nodeDefaults:rt}),l=[this._operationEnsurePageExists(r),this._operationCreateQuickKey(o)];this._queueUpdate({operations:l,affectedQuickKeys:[this._editTarget]}).then(n,s)})}getCloseFolderOption(){return this._rootNode.children[0].viewData.close_folder}setCloseFolderOption(e=!1){const t=this._rootNode.children[0],n=[this._operationEnsurePageExists(t.node),this._operationSetCloseFolderOption(e)];return this._queueUpdate({operations:n})}processDragAndDrop({quickKeyOrigin:e,quickKeyDestination:t}){const{QUICK_KEY:n}=it;return e.type===n&&t.type===n?this.mergeQuickKeysIntoFolder({quickKeyOrigin:e,quickKeyDestination:t}):this.moveQuickKey({quickKeyOrigin:e,quickKeyDestination:t})}moveQuickKey({quickKeyOrigin:e,quickKeyDestination:t}){const n=[];if(t.type===it.FOLDER&&(n.push(t),t=this._findFirstBlankNode(t)),!t)return We.reject(new Error("The destination to move that quick key to is invalid"));const s=[this._operationMoveQuickKey({quickKeyOrigin:e,quickKeyDestination:t})];return t.node.parent_node_id!==e.node.parent_node_id&&(s.unshift(this._operationEnsurePageExists(t.parentNode)),s.push(this._operationDeleteContainingPageIfEmpty(e))),this._queueUpdate({operations:s,affectedQuickKeys:n})}mergeQuickKeysIntoFolder({quickKeyOrigin:e,quickKeyDestination:n}){const{node:s,viewData:a}=n,i=this._buildQuickKeyNode({quickKeyData:{product_id:null,position:s.position,parent_node_id:s.parent_node_id},attributeData:{label:"New Folder",color:a.color},nodeDefaults:ot}),r=this._buildQuickKeyNode({quickKeyData:{position:0},nodeDefaults:lt}),o=t.merge({},n.node,{position:0});delete o.id;const l=t.merge({},n,{node:{position:1}}),c=[{affectedQuickKeys:[e,n],performUpdate:()=>this._deleteQuickKey(n).then(()=>this._createQuickKey(i)).then(e=>this._createQuickKey(r,e)).then(e=>this._createQuickKey(o,e).then(()=>e)).then(t=>this._moveQuickKey({quickKeyOrigin:e,quickKeyDestination:l,parentNode:t}))},this._operationDeleteContainingPageIfEmpty(e)];return this._queueUpdate({operations:c})}updateQuickKey(e){return this._queueUpdate({operations:[this._operationUpdateQuickKey(e)]})}deleteQuickKey(e){const t=[this._operationDeleteQuickKey(e),this._operationDeleteContainingPageIfEmpty(e)];return this._queueUpdate({operations:t})}isValidDropDestination(e){if(!this._draggedQuickKey||e.locked)return!1;const{FOLDER:t,QUICK_KEY:n,BLANK:s}=it,a=this._draggedQuickKey.type===t;switch(e.type){case t:return!a;case n:{const t=Boolean(e.parentNode.parent_node_id);return!(a||t)}case s:return!0;default:return!1}}getProduct(e){const t=this._quickKeysLayoutDataAdaptor;return We.resolve(t&&t.getProduct(e.node.product_id))}registerDataAdaptor(e){this._quickKeysLayoutDataAdaptor=e}_findFirstBlankNode(e){return kt(e,{fromPosition:{pageIndex:0,position:-1}},{includeBlanks:!0,excludeNonBlanks:!0}).to}_resetEditTarget(){const e=this._folder||this._rootNode;this._editTarget=this._findFirstBlankNode(e)}_queueUpdate({operations:e,affectedQuickKeys:t=[]}){const n=[],s=[];e.forEach(e=>{e.affectedQuickKeys&&Array.prototype.push.apply(t,e.affectedQuickKeys),e.performUpdate&&n.push(e.performUpdate),e.finally&&s.push(e.finally)});if(t.some(e=>e.locked))return We.reject(new Error("Cannot perform operation as one or more of the affected quick keys is locked."));this._lockQuickKeys(t),this._editTarget&&this._editTarget.locked&&this._resetEditTarget(),this._updateQueuedCount(!0);return this._queue=this._queue.then(()=>(()=>{let e=We.resolve();return n.forEach(t=>{e=e.then(e=>t(e))}),e})().then(()=>this._handleLayoutUpdate(),e=>this._handleUpdateError(e)).finally(()=>s.forEach(e=>e()))).finally(()=>{this._updateQueuedCount(!1),this._unlockQuickKeys(t)}),this._queue}_updateQueuedCount(e){e?(this._queuedUpdates+=1,this.updateInProgress||this._setUpdateInProgress(!0)):(this._queuedUpdates-=1,this._queuedUpdates||this._setUpdateInProgress(!1))}_lockQuickKeys(e){e.forEach(e=>{this._lockedQuickKeys[e.node.id]=!0}),ht(this._rootNode,Object.keys(this._lockedQuickKeys)),this.emit("quick-keys-locked",{quickKeys:e})}_unlockQuickKeys(e){e.forEach(e=>delete this._lockedQuickKeys[e.node.id]),ht(this._rootNode,Object.keys(this._lockedQuickKeys)),this.emit("quick-keys-unlocked",{quickKeys:e})}_handleLayoutUpdate(){return this.updateLayout(),this.emit("layoutUpdate",{layoutData:this._layoutData}),this._layoutData}_handleUpdateError(e){return this.emit("layoutUpdateError",{error:e}),We.reject(e)}_setUpdateInProgress(e){this._updateInProgress=e,this.emit("layoutUpdatingChange",{layoutUpdating:this._updateInProgress})}_operationEnsurePageExists(t){return ut(t)?(this._layoutLocked=!0,{performUpdate:()=>{const n=this._buildQuickKeyNode({quickKeyData:{position:t.position,parent_node_id:t.parent_node_id},nodeDefaults:lt});return e.createQuickKey(this._layoutData.id,n).then(e=>this._addNodeToLayoutData(e))},finally:()=>{this._layoutLocked=!1}}):{performUpdate:()=>t}}_operationDeleteContainingPageIfEmpty(e){const t=e.parentNode;if(ut(t))return{};const n=function e(t,n){if(t.node.id===n)return t;const s=t.type===it.PAGE&&t.viewData.nodes||t.children;let a;for(const i of s)if(i.node.id===n?a=i:i.type!==it.PAGE&&i.type!==it.FOLDER||(a=e(i,n)),a)break;return a}(this.rootNode,t.id);if(!n||n.children.length>1||n.children[0].node.id!==e.node.id)return{};const{pageIndex:s,numberOfPages:a}=n.viewData;return 0===s||s!==a-1?{}:(this._layoutLocked=!0,{performUpdate:()=>{if(this._layoutData.nodes.every(e=>e.parent_node_id!==t.id))return this._deleteQuickKey(n)},finally:()=>{this._layoutLocked=!1}})}_operationCreateQuickKey(e){return{performUpdate:t=>this._createQuickKey(e,t)}}_operationMoveQuickKey({quickKeyOrigin:e,quickKeyDestination:t}){return{affectedQuickKeys:[t,e],performUpdate:n=>this._moveQuickKey({quickKeyOrigin:e,quickKeyDestination:t,parentNode:n})}}_operationUpdateQuickKey(n){return n.node.attributes.forEach(e=>{const s=n.viewData[e.key];t.isUndefined(s)||("showImage"===e.key?e.value=s?1:0:e.value=s)}),{affectedQuickKeys:[n],performUpdate:()=>e.updateQuickKey(this._layoutData.id,n.node).then(e=>this._replaceNodeInLayoutData(e))}}_operationSetCloseFolderOption(t){return{affectedQuickKeys:[],performUpdate:n=>{let s=n.attributes.find(e=>"close_folder"===e.key);return s||(s={key:"close_folder"},n.attributes.push(s)),s.value=t?"1":"0",e.updateQuickKey(this._layoutData.id,n).then(e=>this._replaceNodeInLayoutData(e))}}}_operationDeleteQuickKey(e){return{affectedQuickKeys:[e],performUpdate:()=>this._deleteQuickKey(e)}}_createQuickKey(t,n){return n&&(t.parent_node_id=n.id),e.createQuickKey(this._layoutData.id,t).then(e=>this._addNodeToLayoutData(e))}_moveQuickKey({quickKeyOrigin:t,quickKeyDestination:n,parentNode:s}){const a=s&&s.id||n.node.parent_node_id,i={id:t.node.id,parent_node_id:a,position:n.node.position};return e.updateQuickKey(this._layoutData.id,i).then(e=>this._replaceNodeInLayoutData(e))}_deleteQuickKey(t){return e.deleteQuickKey(this._layoutData.id,t.node.id).then(()=>this._removeNodeFromLayoutData(t.node))}_addNodeToLayoutData(e){return this._layoutData.nodes.push(e),e}_replaceNodeInLayoutData(e){const t=this._findNodeIndex(e);if(-1===t)throw new Error("Unable to find the quickKey within the layout");return this._layoutData.nodes[t]=e,e}_removeNodeFromLayoutData(e){const t=this._findNodeIndex(e);if(-1===t)throw new Error("Unable to find the quickKey within the layout");return this._layoutData.nodes.splice(t,1),e}_findNodeIndex(e){return this._layoutData.nodes.findIndex(t=>t.id===e.id)}_buildQuickKeyNode({quickKeyData:e,attributeData:n,nodeDefaults:s}){const a=t.merge({attributes:[]},e),i=t.merge({},s,n||{});return t.forEach(i,(e,t)=>a.attributes.push({key:t,value:e})),a}}}Rt.$inject=["qkNodesResource"],t.module("vendQuickKeys").factory("QuickKeysLayout",Rt);t.module("vendQuickKeys").directive("vdQuickKeys",["$templateCache",function(e){return{restrict:"E",scope:{layoutData:"=",editMode:"=",layoutDataAdaptor:"="},template:'<vd-quick-key-grid layout="vdQuickKeysCtrl.layout"\n  root-node="vdQuickKeysCtrl.layout.rootNode"\n  masked="!!vdQuickKeysCtrl.layout.folder">\n</vd-quick-key-grid>\n<vd-quick-key-folder-view ng-if="vdQuickKeysCtrl.layout.folder" layout="vdQuickKeysCtrl.layout">\n</vd-quick-key-folder-view>\n',bindToController:!0,controllerAs:"vdQuickKeysCtrl",controller:["$scope","$element","QuickKeysLayout",function(e,t,n){this.$onInit=function(){this.layout=new n(this.layoutData,{editable:this.editMode}),this.layout.on("quick-keys-locked",t=>e.$applyAsync()),this.layout.on("quick-keys-unlocked",t=>e.$applyAsync()),this.layout.on("quick-key-selected",e=>{He.$emit("vd-quick-keys:product-selected",e)})},e.$watch("vdQuickKeysCtrl.layoutData",()=>this.layout.updateLayout(this.layoutData)),e.$watch("vdQuickKeysCtrl.editMode",(e,n)=>{const s=Boolean(e);this.layout.editable=s,t.toggleClass("vd-quick-keys--edit-mode",s)}),e.$watch("vdQuickKeysCtrl.layoutDataAdaptor",e=>{e&&e._registerQuickKeysLayout(this.layout)})}],link(e,t,n){n.$addClass("vd-quick-keys")}}}]);t.module("vendQuickKeys").directive("vdQuickKeyGrid",(function(){return{restrict:"E",scope:{rootNode:"=",inFolder:"=",masked:"=",layout:"="},template:'<div ng-repeat="page in qkGridCtrl.rootNode.children track by page.node.id"\n  ng-init="pageIndex = $index"\n  class="vd-quick-key-page">\n  <div ng-repeat="column in page.viewData.pageColumns track by $index" class="vd-quick-key-page-column">\n    <vd-quick-key ng-repeat="quickKey in column track by quickKey.node.id"\n      id="qk-{{quickKey.node.id}}"\n      ng-attr-draggable="{{qkGridCtrl.layout.editable && !quickKey.locked && quickKey.type !== \'blank\'}}"\n      ng-class="[\n        \'vd-quick-key\',\n        \'vd-quick-key--\' + quickKey.viewData.color,\n        \'vd-quick-key--\' + quickKey.type,\n        {\n          \'vd-quick-key--target\': (quickKey === qkGridCtrl.layout.editTarget),\n          \'vd-quick-key--locked\': quickKey.locked\n        }\n      ]"\n      quick-key="quickKey"\n      page-index="pageIndex"\n      layout="qkGridCtrl.layout">\n    </vd-quick-key>\n  </div>\n</div>\n',bindToController:!0,controllerAs:"qkGridCtrl",controller:["$element","$scope",function(e,n){let s,a,i;function r(e){return t.element(qe[0].getElementById("qk-"+e.node.id))}this._focusQuickKey=function(t){t.fromPosition=t.fromPosition||s;const n=kt(this.rootNode,t,{includeBlanks:this.layout.editable});if(n.from){const e=r(n.from);e&&e.removeAttr("tabindex")}if(n.to){const e=r(n.to);e.length&&e.attr("tabindex",0)[0].focus()}s=n.toPosition,a=n.to,a&&e.attr("tabindex",-1)},this._focusGrid=function(e=s){this._focusQuickKey({toPosition:e})},n.$on("vd-quick-keys:keyboard-navigate",(e,t)=>this._focusQuickKey(t)),n.$on("vd-quick-keys:focus-at-position",(e,t)=>this._focusQuickKey({toPosition:t})),n.$watch("qkGridCtrl.masked",(t,n)=>{"boolean"==typeof t&&(e.toggleClass("vd-quick-key-grid--masked",t),n&&!t&&this._focusGrid())}),n.$watch("qkGridCtrl.layout.editable",t=>{!t&&a&&a.type===it.BLANK&&(s=null,a=null,e.attr("tabindex",0))}),e.attr("tabindex",0),n.$on("vd-quick-keys:mousedown-at-position",(e,t)=>{i={time:Date.now()}}),n.$on("vd-quick-keys:drag-start",(t,n)=>{this.layout.draggedQuickKey=n,e.addClass("vd-quick-key-grid--dragging")}),n.$on("vd-quick-keys:drag-end",t=>{e.removeClass("vd-quick-key-grid--dragging")}),n.$on("vd-quick-keys:drop",(t,s,a)=>{e.removeClass("vd-quick-key-grid--dragging");const i=this.layout.draggedQuickKey;if(!this.layout.isValidDropDestination(s)||i.node.id===s.node.id)return!1;this.layout.processDragAndDrop({quickKeyOrigin:i,quickKeyDestination:s}).then(()=>n.$applyAsync(()=>{this._focusQuickKey({toPosition:a}),this.layout.draggedQuickKey=null}))}),e.on("focus",e=>{e.preventDefault(),(!i||Date.now()-i.time>50)&&this._focusGrid()})}],link(e,t,n){n.$addClass("vd-quick-key-grid"),e.qkGridCtrl.inFolder&&Je(()=>e.qkGridCtrl._focusGrid())}}}));t.module("vendQuickKeys").directive("vdQuickKey",(function(){const e=["dragstart","dragenter","dragleave","dragover","drop"],n=["click","mouseenter","mouseleave","mousedown"].concat(e);return{restrict:"E",scope:{quickKey:"=",pageIndex:"=",layout:"=",readOnly:"@?"},template:'<div ng-if="vdQuickKeyCtrl.quickKey.type !== \'blank\' && !vdQuickKeyCtrl.quickKey.locked"\n  class="vd-quick-key-inner"\n  ng-class="{ \'vd-quick-key-inner--with-image\': vdQuickKeyCtrl.imageUrl}">\n  <span ng-if="vdQuickKeyCtrl.quickKey.type === \'folder\'" class="vd-quick-key-folder-count">\n    {{vdQuickKeyCtrl.quickKey.viewData.folderSize}}\n  </span>\n  <div ng-if="vdQuickKeyCtrl.imageUrl"\n    class="vd-quick-key-image"\n    style="background-image: url({{vdQuickKeyCtrl.imageUrl}})">\n  </div>\n  <span class="vd-quick-key-label" title="{{vdQuickKeyCtrl.quickKey.viewData.label}}">\n    {{vdQuickKeyCtrl.quickKey.viewData.label}}\n  </span>\n</div>\n<div ng-if="vdQuickKeyCtrl.quickKey.locked" class="vd-quick-key--loader">\n  <div class="vd-loader"></div>\n</div>\n',bindToController:!0,controllerAs:"vdQuickKeyCtrl",controller:["$scope","$element","key","qkModals",function(s,a,i,r){this._getPosition=function(){return{position:this.quickKey.node.position,pageIndex:this.pageIndex}},this._quickKeySelected=function(){switch(this.quickKey.type){case it.FOLDER:s.$applyAsync(()=>{this.layout.folder=this.quickKey});break;case it.BLANK:s.$applyAsync(()=>{this.layout.editTarget=this.quickKey});break;case it.QUICK_KEY:this.layout.editable?r.editQuicKey(this.layout,this.quickKey):s.$applyAsync(()=>{this.layout.selectQuickKey(this.quickKey)})}},this._keyboardNavigate=function(e){const t=this._getPosition();s.$emit("vd-quick-keys:keyboard-navigate",{fromPosition:t,direction:e})},this._bindEvents=function(){a.on("mouseenter",e=>a.addClass("vd-quick-key--hover")),a.on("mouseleave",e=>a.removeClass("vd-quick-key--hover")),a.on("mousedown",e=>{s.$emit("vd-quick-keys:mousedown-at-position",this._getPosition())}),a.on("click",()=>{s.$emit("vd-quick-keys:focus-at-position",this._getPosition()),this._quickKeySelected()}),this._keyEvents=i.on(a,{ENTER:()=>this._quickKeySelected(),UP:()=>this._keyboardNavigate("UP"),DOWN:()=>this._keyboardNavigate("DOWN"),LEFT:()=>this._keyboardNavigate("LEFT"),RIGHT:()=>this._keyboardNavigate("RIGHT")},{preventDefault:!0}),a.on(e.join(" "),e=>this._manageDragEvent(e))},this._manageDragEvent=function(e){switch(e.type){case"dragstart":e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",this.quickKey.node.id),e.dataTransfer.setDragImage&&e.dataTransfer.setDragImage(a[0],5,5),a.removeClass("vd-quick-key--hover"),s.$emit("vd-quick-keys:drag-start",this.quickKey);break;case"dragenter":this.layout.draggedQuickKey&&this.layout.draggedQuickKey.node.id!==this.quickKey.node.id&&(a.addClass("vd-quick-key--drag-over"),this.layout.isValidDropDestination(this.quickKey)||a.addClass("vd-quick-key--not-allowed"));break;case"dragleave":a.removeClass("vd-quick-key--drag-over vd-quick-key--not-allowed");break;case"dragover":e.preventDefault(),e.dataTransfer.dropEffect="move";break;case"drop":{e.preventDefault();const t=e.dataTransfer.getData("text");if(this.layout.draggedQuickKey&&t!==this.layout.draggedQuickKey.node.id)return void a.removeClass("vd-quick-key--drag-over");a.removeClass("vd-quick-key--drag-over vd-quick-key--not-allowed"),s.$emit("vd-quick-keys:drop",this.quickKey,this._getPosition());break}}},this._detachEvents=function(){a.off(n.join(" ")),this._keyEvents&&this._keyEvents.off()},this._resolveImageUrl=function(){this.quickKey.viewData.showImage?this.layout.getProduct(this.quickKey).then(e=>{e&&e.images.length&&(this.imageUrl=e.images[0].url)}):this.imageUrl=null},this.$onInit=function(){s.$watch("vdQuickKeyCtrl.quickKey.viewData.showImage",()=>this._resolveImageUrl());t.isUndefined(this.readOnly)?this.quickKey.type!==it.BLANK?this._bindEvents():s.$watch("vdQuickKeyCtrl.layout.editable",e=>{e?this._bindEvents():(this._detachEvents(),a.removeAttr("tabindex"))}):a.addClass("vd-quick-key--read-only")}}]}}));t.module("vendQuickKeys").directive("vdQuickKeyFolderView",(function(){return{restrict:"E",scope:{layout:"="},template:'<div class="vd-quick-key-folder-view vd-quick-key-folder-view--{{qkFolderViewCtrl.layout.folder.viewData.color}}">\n  <div class="vd-quick-key-folder-header">\n    <button ng-if="qkFolderViewCtrl.layout.editable"\n      ng-click="qkFolderViewCtrl.editFolder()"\n      title="Edit folder"\n      class="vd-quick-key-folder-action vd-quick-key-folder-action--edit">\n      <i class="fa fa-pencil"></i>\n    </button>\n    <button class="vd-quick-key-folder-action vd-quick-key-folder-action--close"\n      title="Close folder"\n      ng-click="qkFolderViewCtrl.closeFolder()">\n      <i class="vd-i vd-i-times"></i>\n    </button>\n    {{qkFolderViewCtrl.layout.folder.viewData.label}}\n  </div>\n  <vd-quick-key-grid layout="qkFolderViewCtrl.layout"\n    root-node="qkFolderViewCtrl.layout.folder"\n    in-folder="true">\n  </vd-quick-key-grid>\n</div>\n',bindToController:!0,controllerAs:"qkFolderViewCtrl",controller:["$scope","$element","key","qkModals",function(e,t,n,s){this.closeFolder=function(){e.$applyAsync(()=>{this.layout.folder=null})},this.editFolder=function(){s.editQuicKey(this.layout,this.layout.folder)},n.on(t,{ESC:()=>this.closeFolder()})}],link(e,t,n){n.$addClass("vd-quick-key-folder-view-container")}}}));const At=(e,t=[])=>{var n;const r={};for(const s of t)r[s]="<";return{bindings:r,controller:["$element",(n=class{constructor(e){this.$element=e,s(this,"props",{})}$onChanges(t){for(const e in t)t.hasOwnProperty(e)&&(this.props[e]=t[e].currentValue);a.render(i.createElement(e,this.props),this.$element[0])}$onDestroy(){a.unmountComponentAtNode(this.$element[0])}},n)]}};t.module("vendQuickKeys").component("vdQuickKeyColourPalette",At(({onChange:e,selectedColour:t})=>{const n=t=>{e(t.target.value)};return i.createElement("ul",{className:"vd-qk-color-palette"},Object.keys(at).map(e=>{const s=at[e];return i.createElement("li",{key:e,className:"vd-qk-color-palette-item"},i.createElement("label",null,i.createElement("input",{type:"radio",name:"quickKeyColor",className:"vd-qk-color-palette-input",checked:t===s,value:s,onChange:n}),i.createElement("span",{className:"vd-qk-color-palette-color vd-qk-color-palette-color--"+s})))}))},["onChange","selectedColour"])),t.module("webregister.http").factory("abortRequestWhenOffline",(function(){return{request:function(e){return We((t,n)=>{const s=Ge.get("webRegisterStatusManager");s&&!s.isOnline()&&function(e){return 0===e.url.indexOf("/api")}(e)?(Qe.debug("Request blocked as application is offline",e),n({config:e,status:0,statusText:"Request blocked as application is offline",data:"Request blocked as application is offline"})):t(e)})}}}));const Dt="undefined"!=typeof window&&window.location.hostname,Nt=Dt&&Dt.match(/^localhost$/);let xt;const Ot={DEVELOPMENT:"development",PRODUCTION:"production",TEST:"test"};function $t(){return xt}function Lt(e){!function(e){if(!Object.keys(Ut.ENVS).some(t=>Ut.ENVS[t]===e))throw new Error('"'+e+'" is not valid environment.')}(e),xt=e}function Ft(e){return $t()===e}const Ut={get:$t,set:Lt,is:Ft,isDevelopment:()=>Ft(Ot.DEVELOPMENT),isProduction:()=>Ft(Ot.PRODUCTION),isTest:()=>Ft(Ot.TEST),ENVS:Ot,DEFAULT_ENV:Ot.DEVELOPMENT};Lt("production"),Nt&&Lt(Ot.TEST);const Bt="webregister",qt="webregister.restricted",Vt="webregister.restricted.registers-unavailable",Kt="webregister.restricted.duplicate-window",Gt="webregister.current-sale",jt="webregister.current-sale.sale",Qt="webregister.current-sale.payment-panel",Wt="webregister.current-sale.payment-panel.payment",Ht="webregister.current-sale.payment-panel.sale-confirmation",Yt="webregister.register-closure",zt="webregister.register-closure.resolve-register-closure-state",Jt="webregister.register-closure.close-register",Xt="webregister.register-closure.open-register",Zt="webregister.sales-history",en="webregister.status",tn="webregister.settings",nn="webregister.settings.quickkeys",sn="webregister.settings.quickkeys.edit",an="error",rn="error.offline",on="webregister.cash-management",ln="load-sale",cn="/webregister",dn="/",un="/confirmation",hn="/registerclosure",mn="/history?customer_id&promo_code_id&promo_code",gn="/sales/all",pn="/sales/continue",vn="/sales/redirect",yn="/status",fn="/settings",Sn="/error-offline",Cn="/cash-management",bn="/sale/{sale:[a-zA-Z0-9-]+}?action&close_after_complete",_n={CLIENT_VERSION:"3320",APPLICATION_NAME:"web_register",DISPLAY_NAME:"Web Register",URL:cn+"/",CONTACT_SUPPORT_URL:"https://support.vendhq.com/hc/en-us/requests/new?ticket_form_id=1375",VEND_STATUS_URL:"http://status.vendhq.com/",VEND_URI:"vendhq.com"};t.module("webregister.http").factory("apiIdentification",(function(){const e=_n.CLIENT_VERSION;let t=0,n=!1;return{request:function(s){return s.headers["X-Requested-With"]="XMLHttpRequest",function(e){return 0===e.url.indexOf("/api")}(s)&&(s.headers["X-Vend-Client-Platform"]=_n.APPLICATION_NAME,Ut.isProduction()&&(s.headers["X-Vend-Client-Version"]=e,s.headers["X-Vend-Client-Timestamp"]=1616546737),n&&t++),s},startCountingRequests:function(){n=!0,t=0},stopCountingRequests:function(){return n=!1,t},getRequestCount:function(){return t}}})),t.module("webregister.http").factory("redirectSigninOn401",(function(){let e=!1;return{hasEncountered401:()=>e,responseError(t){if(401===t.status){e=!0;const{href:t}=Xe.location,n=t.includes(Sn)?cn:t;Xe.location.href="/signin?return="+encodeURI(n)}return We.reject(t)}}})),t.module("webregister.http").factory("redirectBillingOn402",(function(){let e=!1;return{hasEncountered402:()=>e,responseError:t=>(402===t.status&&(e=!0,Xe.location.href="/billing"),We.reject(t))}}));class wn extends Error{constructor(...e){super(...e),this.name="InsufficientStateForOfflineError"}}class Mn extends Error{constructor(...e){super(...e),this.name="SyncInterruptedError"}}const Tn={[Ot.PRODUCTION]:{cardholder_data_validation_webregister:!1,cash_discounting:!1,direct_econduit:!1,parked_sales_from_read_api:!1,pay_screen_integrated_promo:!1,payment_type_controls:!1,tender_flow_for_non_cash_rounding:!1,custom_business_rules:!1,terminal_tipping:!1,product_codes_sell_screen_scanning:!1,gift_receipts:!1,promotions:!1,promotions_advanced:!1,customer_groups:!0,inbound_indicator:!1,fulfill_from_another_outlet:!1,react_variant_picker:!1,react_promotion_modal:!1},[Ot.TEST]:{},[Ot.DEVELOPMENT]:{cardholder_data_validation_webregister:!1,cash_discounting:!1,dark_mode:!1,promotions_advanced:!1,tender_flow_for_non_cash_rounding:!0,terminal_tipping:!0,parked_sales_from_read_api:!0,payment_type_controls:!1,custom_business_rules:!1,customer_groups:!0,inbound_indicator:!1,fulfill_from_another_outlet:!0,react_variant_picker:!1,react_promotion_modal:!0}};function En(e){return e.init()}function kn(e){e.state(ln,{url:bn,onEnter:["$state","$stateParams",function(e,t){if(!t||"view"!==t.action)return e.target(jt,r(r({},t),{},{closeAfterComplete:"true"===t.close_after_complete}));window.location.href=`${vn}/${t.sale}`}]})}En.$inject=["webRegisterStatusManager"],t.module("webregister.resolvers").factory("webRegisterStatusManagerResolver",En),t.module("webregister.resolvers").factory("syncManagerResolver",["syncManager",function(e){return e.init()}]),t.module("webregister.resolvers").factory("saleSyncManagerResolver",["saleSyncManager",function(e){return e.init()}]),t.module("webregister.resolvers").factory("posStateManagerResolver",["posStateManager",function(e){return e.init()}]),t.module("webregister.resolvers").factory("registerManagerResolver",["registerManager",function(e){return e.init()}]),kn.$inject=["$stateProvider"],t.module("webregister.routes").config(kn);let In,Pn,Rn;!function(e){e.ONLINE="ONLINE",e.UNREACHABLE="UNREACHABLE",e.REMOTE_DISABLED="REMOTE_DISABLED",e.LOCAL_DISABLED="LOCAL_DISABLED",e.UNAUTHENTICATED="UNAUTHENTICATED"}(In||(In={})),function(e){e.statusChange="webRegisterStatusChange",e.transitionOnline="webRegisterTransitionOnline",e.transitionOffline="webRegisterTransitionOffline",e.insufficientStateForOffline="webRegisterInsufficientStateForOffline",e.softRefreshRequired="webRegisterSoftRefreshRequired",e.restrictedAccessChange="webRegisterRestrictedAccessChange"}(Pn||(Pn={})),function(e){e.VEND_ERROR_SALES_COUNT="VEND_ERROR_SALES_COUNT"}(Rn||(Rn={}));function An(e,t,n){e.html5Mode(!0),t.state(Bt,{abstract:!0,template:'<div ng-include="\'loading-skeleton/loading-skeleton.html\'"\n  ng-if="(!webRegisterCtrl.initComplete && !webRegisterCtrl.restrictedAccess) || webRegisterCtrl.isUnAuthenticated()">\n</div>\n\n<wr-no-products-modal ng-if="webRegisterCtrl.hasNoProducts"></wr-no-products-modal>\n\n<wr-toast-notifications></wr-toast-notifications>\n\n<wr-html-navigation ng-if="webRegisterCtrl.initComplete"></wr-html-navigation>\n\n<div class="vd-main-content-container">\n  <div class="vd-main-content-inner-container">\n    <div class="vd-main-content">\n      <div ui-view class="up-animate"></div>\n    </div>\n  </div>\n</div>\n\n<training-tour></training-tour>\n\n<wr-printer></wr-printer>\n<preload-receipt-images></preload-receipt-images>\n',controller:"WebRegisterCtrl",controllerAs:"webRegisterCtrl",resolve:{errorHandler:["redirectSigninOn401",function(e){function t(){et.go(rn,{location:"replace"})}nt.onError({},n=>{const s=n.error().detail;!e.hasEncountered401()&&s&&s instanceof wn&&t()}),He.$on(Pn.insufficientStateForOffline,()=>t())}],posStateManager:"posStateManagerResolver",webRegisterStatusManager:["errorHandler","posStateManager","webRegisterStatusManagerResolver",function(e,t,n){return n}],syncManager:"syncManagerResolver",saleSyncManager:"saleSyncManagerResolver",registerManager:["webRegisterStatusManager","registerManagerResolver",function(e,t){return t}],loggedInUser:["webRegisterStatusManager","userManager",function(e,t){return t.init().then(()=>t.getLoggedInUser())}]}}),n.otherwise(dn)}An.$inject=["$locationProvider","$stateProvider","$urlRouterProvider"],t.module("webregister.routes").config(An);function Dn(e){const t={workspace:{controller:"WorkspaceCtrl",controllerAs:"$ctrl",template:'<div class="wr-global-search">\n  <div class="vd-text-label vd-mb1">Search for products</div>\n  <vd-autocomplete source="$ctrl.suggestionSource"\n    hotkey="{ combo: \'alt+s\', action: $ctrl.focusProductSearch, summary: \'Focus product search\', tip: \'s\', count: true }"\n    error-template="{{ ::$ctrl.productErrorTemplate }}"\n    on-select="$ctrl.onSelectResult($event.selected)"\n    placeholder="Start typing or scanning\u2026"\n    icon="fa-search"\n    vd-focus="{ focusOn: \'autocomplete:global-search:focus\' }">\n  </vd-autocomplete>\n</div>\n<div class="wr-workspace-module-container" ng-if="$ctrl.quickKeysEnabled">\n  <wr-quick-keys class="wr-quick-keys wr-workspace-module wr-workspace-module--fit-container" register="webRegisterCtrl.register">\n  </wr-quick-keys>\n</div>\n'},sale:{controller:"SaleCtrl",controllerAs:"saleCtrl",template:'<div ng-if-start="webRegisterCtrl.registerManager.isActiveRegisterOpen() &&\n  (!saleCtrl.showRegisterOpenReminder || saleCtrl.hasActiveSale)"\n  class="sale-actions-container">\n  <div class="vd-btn-group sale-actions" ng-if="!saleCtrl.isInitialising">\n    <button class="vd-btn vd-btn--text-supplementary"\n      ng-click="saleCtrl.retrieveSale($event)"\n      ng-disabled="!saleCtrl.webRegisterStatusManager.isOnline() || webRegisterCtrl.trainingModeEnabled || saleCtrl.saleManager.sale.isMarkedAsUnfulfilled()">\n      <i class="fa fa-share vd-mr1"></i>Retrieve<span class="wr-hide-on-mobile"> Sale</span>\n    </button>\n\n    <button ng-if="saleCtrl.saleManager.sale.isConfirmedNotReadyToComplete()"\n      id="pro-sl-btn-dismiss-sale"\n      class="vd-btn vd-btn--text-supplementary"\n      ng-click="saleCtrl.dismissSale()"\n      ng-disabled="saleCtrl.shouldDisableActions()">\n      <i class="fa fa-close vd-mr1"></i> Dismiss<span class="wr-hide-on-mobile"> Sale</span>\n    </button>\n\n    <button ng-if-start="!saleCtrl.saleManager.sale.isConfirmedNotReadyToComplete()"\n      id="pro-sl-btn-park-sale"\n      hotkey="{ combo: \'f5\', summary: \'Park Sale\' }"\n      class="vd-btn vd-btn--text-supplementary"\n      ng-click="saleCtrl.parkSale()"\n      ng-disabled="saleCtrl.saleManager.sale.isEmptySale() || saleCtrl.shouldDisableActions() || saleCtrl.saleManager.sale.isMarkedAsUnfulfilled()">\n      <i class="vd-i vd-i-park vd-mr1"></i>Park<span class="wr-hide-on-mobile"> Sale</span>\n    </button>\n\n    <button ng-if-end\n      class="vd-btn vd-btn--text-supplementary"\n      ng-click="saleCtrl.openMoreActionsDropdown($event)"\n      ng-disabled="saleCtrl.shouldDisableActions() || saleCtrl.loadingMarkUnfulfilledModal"\n      aria-label="More actions dropdown">\n      <i class="fa fa-caret-down vd-mr1"></i>More<span class="wr-hide-on-mobile"> Actions\u2026</span>\n    </button>\n\n  </div>\n</div>\n\n<form ng-if-end id="pro-sl-sale-form"\n  name="saleCtrl.saleForm"\n  class="sale"\n  ng-class="{ \'pro-sale-ready\' : !saleCtrl.saleManager.saleCalculating }">\n  <div class="sale-header">\n    <div ng-if="!saleCtrl.saleManager.sale.hasValidCustomer()"\n      class="vd-pa1 wr-customer-search">\n      <vd-autocomplete ng-if="!webRegisterCtrl.trainingModeEnabled && webRegisterCtrl.webRegisterOnline"\n        error-template="{{ ::saleCtrl.customerErrorTemplate }}"\n        source="saleCtrl.customerSource"\n        hotkey="{ combo: \'alt+c\', action: saleCtrl.focusCustomerSearch, summary: \'Focus customer search\', tip:\'c\', count: true }"\n        on-select="saleCtrl.onCustomerSelect($event.selected)"\n        placeholder="Add a customer"\n        icon="fa-user"\n        vd-focus="{ isFocusable: false, focusOn: \'autocomplete:customer-search:focus\' }">\n      </vd-autocomplete>\n      <vd-autocomplete ng-if="webRegisterCtrl.trainingModeEnabled || !webRegisterCtrl.webRegisterOnline"\n        error-template="{{ ::saleCtrl.customerErrorTemplate }}"\n        source="saleCtrl.readOnlyCustomerSource"\n        hotkey="{ combo: \'alt+c\', action: saleCtrl.focusCustomerSearch, summary: \'Focus customer search\', tip:\'c\', count: true }"\n        on-select="saleCtrl.onCustomerSelect($event.selected)"\n        placeholder="Add a customer"\n        icon="fa-user"\n        vd-focus="{ isFocusable: false, focusOn: \'autocomplete:customer-search:focus\' }">\n      </vd-autocomplete>\n    </div>\n    <wr-customer-badge ng-if="saleCtrl.saleManager.sale.hasValidCustomer()"\n      customer="saleCtrl.saleManager.sale.customer"\n      class="sale-customer wr-customer-badge--no-frame">\n    </wr-customer-badge>\n  </div>\n  <div class="vd-banner vd-banner--info sale-banner" data-cy="promotion-helper-banner" ng-if="saleCtrl.shouldShowPromoBanner()">\n    <span class="vd-text-supplementary">\n      <vd-icon icon="fa-ticket" class="fa fa-ticket vd-mr1"></vd-icon>\n      A promotion is available on this sale.&nbsp;\n      <a href="#" class="vd-link vd-link--secondary"\n        ng-click="saleCtrl.openPromotionModal(saleCtrl.saleManager.sale.potentialPromotionId)"\n      >\n        Show details.\n      </a>\n    </span>\n  </div>\n\n  <div class="vd-banner vd-banner--info sale-banner" ng-if="saleCtrl.shouldShowUnfulfilledBanner()">\n    <span class="vd-text-supplementary">\n      <vd-icon icon="fa-circle-o" class="vd-mr1"></vd-icon>\n      Unfulfilled sale. This order will be {{ saleCtrl.saleManager.sale.isUnfulfilledPickUp() ? \'picked up\' : \'delivered\'}}.\n    </span>\n  </div>\n\n  <div class="vd-banner vd-banner--negative sale-banner" data-cy="sale-error-banner" ng-if="saleCtrl.shouldShowSaleErrorBanner()">\n    <span class="vd-text-supplementary">\n      <vd-icon icon="fa-exclamation-triangle" class="vd-mr1"></vd-icon>\n      Please fix the sale errors before continuing.\n    </span>\n  </div>\n\n  <div class="vd-banner vd-banner--negative sale-banner" ng-if="saleCtrl.shouldShowMarkUnfulfilledBanner()">\n    <span class="vd-text-supplementary">\n      <vd-icon icon="fa-exclamation-triangle" class="vd-mr1"></vd-icon>\n      You don\u2018t have enough inventory available.&nbsp;\n      <a href="#" class="vd-link vd-link--secondary" ng-click="saleCtrl.markAsUnfufilled(false)">\n        Mark sale as unfulfilled\n      </a>?\n    </span>\n  </div>\n\n  <div class="vd-banner vd-banner--info sale-banner" ng-if="saleCtrl.shouldShowBlindReturnBanner()">\n    <span class="vd-text-supplementary">\n      <vd-icon icon="fa-undo" class="fa fa-undo vd-mr1"></vd-icon>\n      Are you making a return?&nbsp;\n      <a class="vd-link vd-link--secondary" href="/sales/completed">\n        Find the original sale.\n      </a>\n    </span>\n  </div>\n\n  <div ng-if="saleCtrl.isInitialising" class="vd-loader sale-list-loader"></div>\n\n  <div ng-if="!saleCtrl.isInitialising" class="sale-body" wr-sale-list-scroll>\n    <ul class="sale-list" toggle-last-line-item>\n      <li ng-repeat="item in combined = saleCtrl.saleManager.sale.lineItems.concat(saleCtrl.saleManager.sale.unknownLineItems) | orderBy: \'dateAdded\' track by item.localId"\n        class="sale-list-item line-item--separator">\n        <line-item ng-if="item.product" line-item="item"></line-item>\n        <unknown-line-item ng-if="!item.product" item="item" on-delete="saleCtrl.removeUnknownProduct" data-cy="unknown-line-item-{{item.name}}"></unknown-line-item>\n      </li>\n    </ul>\n    <div class="sale-list-footer">\n      <ul class="sale-totals">\n        <li ng-if="!saleCtrl.shouldShowDiscount || !saleCtrl.shouldShowSaleNote || saleCtrl.shouldShowPromoCodeLink()" class="sale-total-line sale-add-line">\n          <div class="vd-text-signpost">ADD</div>\n          <div>\n            <span ng-if="!saleCtrl.shouldShowDiscount"\n              class="vd-text-label pro-sale-discount-link sale-total-header--link"\n              ng-class="{\'vd-link\': !saleCtrl.isDiscountDisabled(), \'sale-disabled-add-link\': saleCtrl.isDiscountDisabled()}"\n              ng-click="saleCtrl.discountClickHandler()">\n              Discount\n            </span>\n            <sale-promo-code ng-if="saleCtrl.shouldShowPromoCodeLink()"></sale-promo-code>\n            <span ng-if="!saleCtrl.shouldShowSaleNote"\n              class="vd-text-label vd-link pro-sale-note-link sale-total-header--link"\n              ng-click="saleCtrl.showSaleNote()">\n              Note\n            </span>\n          </div>\n        </li>\n        <li ng-if="saleCtrl.shouldShowSaleNote" class="sale-add-line sale-note-line">\n          <div class="sale-note-label-line">\n            <span class="vd-text-label">{{ saleCtrl.isCustomerNote() ? \'Note\' : \'Staff Note\' }}</span>\n            <span class="vd-text--sub sale-note-label vd-text--secondary">Customers will {{ saleCtrl.isCustomerNote() ? \'be able to\' : \'not\' }} see this note on their receipt</span>\n          </div>\n          <div class="add-action-line-container">\n            <sale-note-redux vd-focus="{ isFocusable: !saleCtrl.currentSale.note, focusDelay: 200 }"\n              class="sale-note"\n              placeholder="Enter a note about this sale"\n              min-size="1">\n            </sale-note-redux>\n            <button ng-if="!saleCtrl.saleManager.sale.isMarkedAsUnfulfilled()" ng-click="saleCtrl.hideSaleNote()" class="vd-btn vd-btn--icon-no vd-ml1 sale-note-remove-button" type="button">\n              <vd-icon icon="fa-trash"></vd-icon>\n            </button>\n          </div>\n        </li>\n        <li ng-if="!saleCtrl.registerManager.isTaxInclusive()"\n          class="vd-text-label sale-total-line sale-add-line"\n          data-cy="sale-subtotal">\n          <div>Subtotal</div>\n          <div class="sale-total-line-item--value">\n            {{saleCtrl.saleManager.sale.finals.subtotal | vdCurrency}}\n            <span class="sale-total-line-end-space"></span>\n          </div>\n        </li>\n        <li ng-if="saleCtrl.shouldShowDiscount" class="sale-add-line" data-cy="sale-discount">\n          <div class="sale-total-line"\n            ng-class="{\'sale-total-line--disabled\' : saleCtrl.isDiscountDisabled()}">\n            <sale-discount show-popover-on-init="saleCtrl.showDiscountPopover"\n              has-active-sale="saleCtrl.hasActiveSale"\n              is-disabled="saleCtrl.isDiscountDisabled"\n              confirmed-not-ready-to-complete="saleCtrl.saleManager.sale.isConfirmedNotReadyToComplete()">\n            </sale-discount>\n            <div class="sale-total-line-item--value">\n              \x3c!-- When we have a valid discount --\x3e\n              <wr-sale-discount-value ng-if="saleCtrl.saleManager.sale.isSaleDiscountValid()"\n                sale-discount="saleCtrl.saleManager.sale.discount" class="vd-text-label">\n              </wr-sale-discount-value>\n              \x3c!-- When the discount value entered is invalid --\x3e\n              <div ng-if="saleCtrl.saleManager.sale && !saleCtrl.saleManager.sale.isSaleDiscountValid()"\n                class="vd-text--negative">\n                Please fix the discount to complete the sale\n                <vd-icon class="fa fa-exclamation-triangle vd-pl1"></vd-icon>\n              </div>\n              <div class="sale-total-line-end-space">\n                <button class="vd-btn vd-btn--icon-no vd-ml1 pro-sale-discount-remove-button"\n                  ng-if="!saleCtrl.isDiscountDisabled() && saleCtrl.hasPermissionToDiscount()"\n                  ng-click="saleCtrl.hideSaleDiscount()"\n                  type="button">\n                  <vd-icon icon="fa-trash"></vd-icon>\n                </button>\n              </div>\n            </div>\n          </div>\n        </li>\n\n        <li ng-if="saleCtrl.saleManager.sale.hasPromotions()"\n          class="sale-total-line sale-add-line"\n          data-cy="sale-promotion-data">\n          <sale-promotion></sale-promotion>\n          <div class="vd-text-label sale-total-line-item--value">\n            {{saleCtrl.saleManager.getTotalPromotionAmount() | vdCurrency}}\n            <span class="sale-total-line-end-space"></span>\n          </div>\n        </li>\n        <li class="sale-total-line sale-add-line pro-total-line-total-tax">\n          <sale-tax-breakdown sale-manager="saleCtrl.saleManager"></sale-tax-breakdown>\n          <div class="vd-text-label sale-total-line-item--value">\n            {{saleCtrl.saleManager.sale.finals.tax | vdCurrency}}\n            <span class="sale-total-line-end-space"></span>\n          </div>\n        </li>\n        <li ng-if="saleCtrl.saleManager.hasCashDiscountingServiceFee()" class="sale-total-line sale-add-line">\n          <div>\n            <a href="javascript:void(0)"\n              class="vd-text-label vd-link"\n              ng-click="saleCtrl.showRemoveServiceFeePopover($event)"\n              ng-if="!saleCtrl.saleManager.sale.hasPayments()">\n              Service Fee\n            </a>\n            <span class="vd-text-label"\n              ng-if="saleCtrl.saleManager.sale.hasPayments()">\n              Service Fee\n            </span>\n            <span class="sale-total-line-item--sub">\n              {{webRegisterCtrl.registerManager.getDisplayCashDiscountingRate()}}%\n            </span>\n          </div>\n          <div class="vd-text-label sale-total-line-item--value">\n            {{saleCtrl.saleManager.sale.totals.saleServiceFee | vdCurrency}}\n            <span class="sale-total-line-end-space"></span>\n          </div>\n        </li>\n        <li ng-if="saleCtrl.saleManager.sale.hasPayments()"\n          class="vd-text-label sale-total-line sale-add-line pro-sale-total-line-total">\n          <div>Total</div>\n          <div class="sale-total-line-item--value">\n            {{saleCtrl.saleManager.sale.finals.inclusivePrice | vdCurrency}}\n            <span class="sale-total-line-end-space"></span>\n          </div>\n        </li>\n        <li ng-if="saleCtrl.saleManager.sale.hasPayments()"\n          class="sale-total-line sale-add-line pro-total-line-payments">\n          <sale-payment></sale-payment>\n          <div class="vd-text-label sale-total-line-item--value">\n            {{saleCtrl.saleManager.sale.getPaymentsTotal() | vdCurrency}}\n            <span class="sale-total-line-end-space"></span>\n          </div>\n        </li>\n      </ul>\n    </div>\n  </div>\n\n  <div class="sale-footer">\n    <button\n      type="button"\n      hotkey="{ combo: [\'f4\', \'alt+p\'], summary: \'Go to the pay screen\', tip: \'p\', count: true }"\n      ng-class="[\n        \'vd-btn vd-btn--jumbo btn--pay\',\n        saleCtrl.saleManager.sale.getOutstandingBalance() < 0 ? \'vd-btn--no\' : \'vd-btn--do\'\n      ]"\n      ng-click="saleCtrl.transitionToPaymentScreen()"\n      ng-disabled="saleCtrl.preventTransitionToPaymentScreen()">\n      \x3c!-- Extra container is because display:flex doesn\'t work on a button on Firefox --\x3e\n      <div vd-flex vd-flex-justify="between">\n        <div ng-if="saleCtrl.saleCalculating">\n          Just a moment<span class="vd-loader vd-loader--small"></span>\n        </div>\n        <div ng-if="!saleCtrl.saleCalculating" class="label-and-items-container">\n          <div class="pay-action pay-action-label">\n            {{saleCtrl.getCompleteSaleLabel()}}\n          </div>\n          <span ng-pluralize\n            count="saleCtrl.saleManager.sale.getBasketSize()"\n            when="{\'one\': \'{} item\', \'other\': \'{} items\'}"\n            class="vd-text--sub">\n          </span>\n        </div>\n        <div class="pay-action pay-action-value">\n          {{saleCtrl.saleManager.sale.getOutstandingBalance() | vdCurrency}}\n        </div>\n      </div>\n    </button>\n  </div>\n</form>\n\n<open-register-panel ng-if="!webRegisterCtrl.registerManager.isActiveRegisterOpen()"\n  register="webRegisterCtrl.register"\n  web-register-online="webRegisterCtrl.webRegisterOnline"\n  modifier="boxed fill">\n</open-register-panel>\n\n<register-open-reminder ng-if="webRegisterCtrl.registerManager.isActiveRegisterOpen() &&\n  !saleCtrl.isInitialising &&\n  !saleCtrl.hasActiveSale &&\n  saleCtrl.showRegisterOpenReminder">\n</register-open-reminder>\n'},saleSummary:{controller:"SaleSummaryCtrl",controllerAs:"saleSummaryCtrl",template:'<back-to-sale-header class="vd-mb1"></back-to-sale-header>\n\n<hr class="vd-hr vd-hr--full vd-hide-desktop">\n\n<div ng-if="!saleSummaryCtrl.saleManager.sale" class="vd-loader sale-summary-loader vd-mt5"></div>\n\n<div class="sale-summary" ng-if="saleSummaryCtrl.saleManager.sale">\n  <vd-scrollable class="sale-summary-content">\n    <section class="sale-summary-section sale-summary-section--sale-items sale-summary-section-divider-btm">\n      <wr-receipt-preview-line-items sale="saleSummaryCtrl.sale"></wr-receipt-preview-line-items>\n    </section>\n\n    <section class="sale-summary-section sale-summary-section--indent">\n      <ul class="sale-summary-list">\n\n        \x3c!-- Render this subtotal section for tax exclusive retailers --\x3e\n        <li ng-if="!saleSummaryCtrl.isTaxInclusive" class="sale-summary-line sale-summary-line--sub-total">\n          <div class="sale-summary-line-item sale-summary-line-item--label">Sub-total</div>\n          <div class="sale-summary-line-item sale-summary-line-item--value">\n            {{saleSummaryCtrl.sale.finals.subtotal | vdCurrency}}\n          </div>\n        </li>\n\n        <li ng-if="saleSummaryCtrl.sale.discount"\n          class="sale-summary-line--discount">\n          <wr-display-sale-discount sale="saleSummaryCtrl.sale"\n            custom-classes="{label: \'sale-summary-line-item--label\', value: \'sale-summary-line-item--value\'}"\n            class="sale-summary-line">\n          </wr-display-sale-discount>\n        </li>\n\n        \x3c!-- Render this subtotal section for tax inclusive retailers --\x3e\n        <li ng-if="saleSummaryCtrl.isTaxInclusive" class="sale-summary-line sale-summary-line--sub-total">\n          <div class="sale-summary-line-item sale-summary-line-item--label">Sub-total</div>\n          <div class="sale-summary-line-item sale-summary-line-item--value">\n            {{saleSummaryCtrl.sale.finals.subtotal | vdCurrency}}\n          </div>\n        </li>\n\n        <li class="sale-summary-line sale-summary-line--tax">\n          <div class="sale-summary-line-item sale-summary-line-item--label">\n            Tax {{saleSummaryCtrl.sale.finals.taxDisplayProperties.taxName}}\n          </div>\n          <div class="sale-summary-line-item sale-summary-line-item--value">\n            {{saleSummaryCtrl.sale.finals.tax | vdCurrency}}\n          </div>\n        </li>\n        <li ng-if="saleSummaryCtrl.sale.hasMultipleTaxGroups()"\n          ng-repeat="(id, tax) in saleSummaryCtrl.sale.finals.taxes track by $index"\n          class="sale-summary-line sale-summary-line--tax-breakdown">\n          <div class="sale-summary-line-item sale-summary-line-item--label">{{tax.name}}</div>\n          <div class="sale-summary-line-item sale-summary-line-item--value">{{tax.total | vdCurrency}}</div>\n        </li>\n        <li ng-if="saleSummaryCtrl.hasCashDiscountingServiceFee()" class="sale-summary-line">\n          <div class="sale-summary-line-item sale-summary-line-item--label">Service fee</div>\n          <div class="sale-summary-line-item sale-summary-line-item--value">\n            {{saleSummaryCtrl.sale.totals.saleServiceFee | vdCurrency}}\n          </div>\n        </li>\n        <li class="sale-summary-line" ng-if="saleSummaryCtrl.sale.hasTip()">\n          <div class="sale-summary-line-item sale-summary-line-item--label">Tip</div>\n          <div class="sale-summary-line-item sale-summary-line-item--value">\n            {{saleSummaryCtrl.sale.finals.tip | vdCurrency }}\n          </div>\n        </li>\n      </ul>\n    </section>\n\n    \x3c!-- Adjusted Cash Discounted Sale Total --\x3e\n    <section ng-if="saleSummaryCtrl.hasCashDiscountingServiceFee() && saleSummaryCtrl.sale.totals.cashDiscount < 0"\n      class="sale-summary-section sale-summary-section--indent">\n      <ul class="sale-summary-list">\n        <li class="sale-summary-line sale-summary-line--total">\n          <div class="sale-summary-line-item sale-summary-line-item--label">\n            Total\n          </div>\n          <div class="sale-summary-line-item sale-summary-line-item--value">\n            {{saleSummaryCtrl.sale.getCashDiscountedSaleTotal()| vdCurrency}}\n          </div>\n        </li>\n        <li class="sale-summary-line sale-summary-line--total">\n          <div class="sale-summary-line-item sale-summary-line-item--label">\n            Cash Discount\n          </div>\n          <div class="sale-summary-line-item sale-summary-line-item--value">\n            {{saleSummaryCtrl.sale.totals.cashDiscount | vdCurrency}}\n          </div>\n        </li>\n      </ul>\n    </section>\n\n    <section class="sale-summary-section sale-summary-section-divider-top sale-summary-section-divider-btm">\n      <ul class="sale-summary-list">\n        <li class="sale-summary-line sale-summary-line--total">\n          <div class="sale-summary-line-item sale-summary-line-item--label">\n            <span class="vd-text-signpost">SALE TOTAL</span>\n            <span class="vd-text-supplementary">{{saleSummaryCtrl.sale.getBasketSize()}}\n              <ng-pluralize count="saleSummaryCtrl.sale.getBasketSize()"\n               when="{\'1\': \'item\', \'other\': \'items\'}">\n              </ng-pluralize>\n            </span>\n          </div>\n          <div class="sale-summary-line-item sale-summary-line-item--value vd-text-intro">\n            {{ saleSummaryCtrl.sale.finals.inclusivePrice| vdCurrency }}\n          </div>\n        </li>\n      </ul>\n    </section>\n\n    <section ng-if="saleSummaryCtrl.sale.payments.length"\n      class="sale-summary-section sale-summary-section--indent pro-summary-section-payments">\n      <ul class="sale-summary-list">\n        <li ng-if="!payment.shouldHide()"\n          ng-repeat="payment in saleSummaryCtrl.sale.payments"\n          class="wr-sale-summary-payments sale-summary-line">\n          <div class="sale-summary-line-item sale-summary-line-item--label">\n            <span ng-if="payment.isForeignCurrency()" class="pro-sale-summary-payment-name">\n            {{payment.paymentType.name}} (Converted at {{payment.paymentType.config.conversionRate | displayRound}})\n            {{payment.amount / payment.paymentType.config.conversionRate | vdCurrency}}\n            </span>\n            <span ng-if="!payment.isForeignCurrency()" class="pro-sale-summary-payment-name">\n              {{payment.paymentType.name}}\n            </span>\n            <div class="vd-text-supplementary">{{payment.paymentDate | wrDateFormat: \'ddd, D MMM YY h:mma\'}}</div>\n          </div>\n          <div class="sale-summary-line-item sale-summary-line-item--value">\n            <span ng-if="payment.isForeignCurrency()">\n            {{payment.amount / payment.paymentType.config.conversionRate | vdCurrency}}\n            </span>\n            <span ng-if="!payment.isForeignCurrency()">{{payment.amount | vdCurrency}}</span>\n          </div>\n        </li>\n      </ul>\n    </section>\n\n\n    <section ng-if="saleSummaryCtrl.sale.hasChange()"\n      class="sale-summary-section sale-summary-section--indent sale-summary-section--change sale-summary-section-divider-top">\n      <ul class="sale-summary-list">\n        <li class="sale-summary-line">\n          <div class="sale-summary-line-item sale-summary-line-item--label">\n            Change\n          </div>\n          <div class="sale-summary-line-item sale-summary-line-item--value">\n            {{::saleSummaryCtrl.sale.getChangeAmountForDisplay() | vdCurrency}}\n          </div>\n        </li>\n      </ul>\n    </section>\n\n    <section ng-if="saleSummaryCtrl.sale.payments.length"\n      class="sale-summary-section sale-summary-section--indent sale-summary-section--balance sale-summary-section-divider-top sale-summary-section-divider-btm">\n      <ul class="sale-summary-list">\n        <li class="sale-summary-line">\n          <div class="sale-summary-line-item sale-summary-line-item--label vd-text-signpost">\n            To Pay\n          </div>\n          <div class="sale-summary-line-item sale-summary-line-item--value vd-text-intro">\n            {{saleSummaryCtrl.sale.getOutstandingBalanceAfterChange() | vdCurrency}}\n          </div>\n        </li>\n      </ul>\n    </section>\n\n    <section ng-if="saleSummaryCtrl.note" class="sale-summary-section sale-summary-section--note">\n      <div class="wr-honour-line-breaks">Note: {{saleSummaryCtrl.note}}</div>\n    </section>\n\n    <section ng-if="saleSummaryCtrl.saleManager.getTotalSavings() > 0"\n      class="sale-summary-section sale-summary-section-divider-top sale-summary-section-divider-btm">\n      <div class="sale-summary-line">\n        <div class="vd-text-signpost">\n          Total Savings\n        </div>\n        <div class="sale-summary-line-item--value vd-text-intro">\n          {{saleSummaryCtrl.saleManager.getTotalSavings() | vdCurrency}}\n        </div>\n      </div>\n    </section>\n  </vd-scrollable>\n</div>\n'},paymentPanel:{template:'<div class="vd-g-row payment-container">\n  <div ui-view="payment-panel-summary"\n    class="vd-g-col vd-g-xs-12 vd-g-s-12 vd-g-m-12 vd-g-l-5 payment-panel payment-panel--summary">\n  </div>\n  <div ui-view="payment-panel-action"\n    class="vd-g-col vd-g-xs-12 vd-g-s-12 vd-g-m-12 vd-g-l-7 payment-panel payment-panel--action">\n  </div>\n</div>\n'},payment:{controller:"PaymentCtrl",controllerAs:"paymentCtrl",template:'<div class="vd-card payment-panel-content payment-panel-content--action" ng-class="{\n  \'pro-payments-ready\': !paymentCtrl.paymentProcessing\n}">\n  <div ng-if="paymentCtrl.saleManager.hasCashDiscountingServiceFee()" class="wr-cash-discounting-banner vd-banner vd-banner--info">\n    <div class="vd-banner-wrapper" vd-flex vd-flex-justify="between">\n      <span>\n        <vd-icon icon="fa-info-circle" class="vd-banner-icon"></vd-icon>\n        Pay less with Cash.\n      </span>\n      <span>\n        {{paymentCtrl.saleManager.getCashDiscountedOutstandingBalance() | vdCurrency}}\n      </span>\n    </div>\n  </div>\n\n  \x3c!-- Amount Tendered --\x3e\n  <form name="paymentCtrl.paymentFormCtrl" novalidate class="payment-form-container">\n    <div class="payment-form vd-pb1" ng-class="{ \'payment-form-with-cash-discounting\': paymentCtrl.saleManager.hasCashDiscountingServiceFee() }">\n      <wr-sale-payment-heading class="payment-header vd-text-hero"></wr-sale-payment-heading>\n      <input class="vd-input wr-input--amount-tendered"\n        name="tenderedAmount"\n        vd-focus="{ focusDelay: 600, selectText: true }"\n        ng-model="paymentCtrl.amountTendered"\n        ng-required="true"\n        vd-number\n        vd-number-options="paymentCtrl.vendNumberOptions"\n        ng-disabled="paymentCtrl.shouldDisableTenderedAmount()"\n        autocomplete="off"\n        inputmode="decimal">\n    </div>\n    <div class="payment-form-messages vd-text-supplementary">\n      <div ng-if="paymentCtrl.hasValidTenderedAmount">\n        <span ng-if="paymentCtrl.getRemainingAmountIfTendered() > 0 && paymentCtrl.saleManager.sale.getOutstandingBalance() > 0" class="payment-form-message">{{paymentCtrl.getRemainingAmountIfTendered() | vdCurrency}} left to pay.</span>\n        <span ng-if="paymentCtrl.getRemainingAmountIfTendered() === 0 && paymentCtrl.saleManager.sale.getOutstandingBalance() > 0" class="payment-form-message">Edit to make a partial payment.</span>\n        <span ng-if="paymentCtrl.getRemainingAmountIfTendered() < 0 && paymentCtrl.saleManager.sale.getOutstandingBalance() < 0" class="payment-form-message">{{paymentCtrl.getRemainingAmountIfTendered() | vdCurrency}} left to refund.</span>\n        <span ng-if="paymentCtrl.getRemainingAmountIfTendered() === 0 && paymentCtrl.saleManager.sale.getOutstandingBalance() < 0" class="payment-form-message">Edit to make a partial refund.</span>\n      </div>\n      <ng-messages ng-if="!paymentCtrl.hasValidTenderedAmount"\n        for="paymentCtrl.paymentFormCtrl.tenderedAmount.$error"\n        class="payment-form-error-message vd-colour-no">\n        <ng-message when="required">\n          Please enter an amount\n        </ng-message>\n        <ng-message when="validCharacters">\n          Invalid character\n        </ng-message>\n        <ng-message when="validMinValue">\n          Amount entered exceeds balance of {{paymentCtrl.currentBalance | vdCurrency}}\n        </ng-message>\n      </ng-messages>\n    </div>\n  </form>\n\n  \x3c!-- Payment Options --\x3e\n  <div id="payment-options-group" class="payment-type-button-group vd-btn-group vd-mt5">\n    <button ng-attr-data-id="{{paymentType.type_id}}"\n      ng-class="[\'vd-btn vd-btn--jumbo btn--payment-type\',\n        paymentCtrl.saleManager.sale.getOutstandingBalance() < 0 ? \'vd-btn--no\' : \'vd-btn--do\']"\n      ng-repeat="paymentType in ::paymentCtrl.paymentTypes | orderBy: \'name\'"\n      ng-click="paymentCtrl.pay(paymentType)"\n      hotkey="{{ $index < 9 ? { combo: \'alt+\'+($index+1), summary: \'Select payment option \' + $index, tip: ($index+1), count: true } : null }}"\n      ng-disabled="paymentCtrl.disablePayment(paymentType)"\n      >\n      <div ng-if="paymentCtrl.disableOnlinePaymentInOfflineMode(paymentType)"\n        class="vd-btn-hover-assist"\n        vd-tooltip-trigger="paymentCtrl.disableOnlinePaymentInOfflineMode(paymentType) && paymentCtrl.paymentTypeDisabledTooltip">\n      </div>\n        {{::paymentType.name}}\n        <div ng-if="paymentType.config.conversionRate" class="vd-text--sub">\n        {{paymentCtrl.amountTendered | vdCurrency}}\n        =\n        {{paymentType.config.currencySymbol}}{{paymentCtrl.amountTendered / paymentType.config.conversionRate | displayRound}}\n        </div>\n    </button>\n  </div>\n\n  \x3c!-- Integrated Pay Promo --\x3e\n  <vd-panel ng-if="paymentCtrl.showIntegratedPayPromo" class="vd-mt5">\n    <vd-section type="panel">\n      <div class="vd-card">\n        <vd-promo modifier="full"\n          headline="\'Make less mistakes when accepting credit cards.\' | vdRemoveWidow"\n          cdn-image="\'payments/integrated-payments-v4.svg\'"\n          class="vd-ma3">\n          <p class="vd-p" vd-no-widow>\n            Sync payment amounts directly from Vend to your terminal, so you don\u2019t have to worry about keying it in wrong.\n          </p>\n          <div class="vd-promo-actions">\n            <a href="/setup/payments?payment_recommendation=Sell%20Screen%20Payment"\n              class="vd-link"\n              target="_blank"\n              rel="noreferrer noopener">\n              I want to know more, please get in touch\n            </a>\n            <a ng-click="paymentCtrl.dismissIntegratedPayPromo()"\n              href="javascript:void(0)"\n              class="vd-link vd-link--secondary">\n              No thanks\n            </a>\n          </div>\n        </vd-promo>\n      </div>\n    </vd-section>\n  </vd-panel>\n\n  <div class="vd-mt5 payment-add-customer">\n    \x3c!-- Attached Customer --\x3e\n    <wr-customer-badge ng-if="paymentCtrl.sale.hasValidCustomer()"\n      customer="paymentCtrl.saleManager.sale.customer"\n      customer-balances="paymentCtrl.sale.customerBalances"\n      view-options="{ canViewDetails: false }">\n    </wr-customer-badge>\n\n    \x3c!-- Attach New Customer --\x3e\n    <vd-autocomplete ng-if="!paymentCtrl.sale.hasValidCustomer()"\n      error-template="{{ ::paymentCtrl.customerErrorTemplate }}"\n      attach-customer-tooltip\n      source="paymentCtrl.customerSource"\n      on-select="paymentCtrl.onCustomerResultSelected($event.selected)"\n      placeholder="{{paymentCtrl.getAddCustomerPlaceholder()}}"\n      icon="fa-user">\n    </vd-autocomplete>\n  </div>\n\n  \x3c!-- Customer Payment Options --\x3e\n  <div id="confirmed-payment-options-group" class="payment-type-button-group vd-btn-group vd-mt5">\n    <div class="payment-offline-message vd-ml1 vd-text--sub"\n      ng-if="!webRegisterCtrl.webRegisterOnline &&\n        (paymentCtrl.loyaltyButtonConfig || paymentCtrl.isStoreCreditEnabled) &&\n        paymentCtrl.sale.hasValidCustomer()">\n      <span class="vd-i vd-i-wifi-out vd-mr1"></span>\n      You\u2019re currently offline and unable to process this sale with some payment methods.\n    </div>\n    <button\n      modifier="big"\n      class="vd-btn vd-btn--supplementary vd-btn--jumbo btn--payment-type"\n      ng-repeat="customerPaymentOption in paymentCtrl.customerPaymentOptions track by customerPaymentOption.id"\n      ng-click="customerPaymentOption.action()"\n      ng-disabled="customerPaymentOption.isDisabled || !paymentCtrl.hasValidTenderedAmount || paymentCtrl.invalidCustomerPaymentAmount(customerPaymentOption.id)">\n      {{::customerPaymentOption.label}}\n    </button>\n  </div>\n  <div class="vd-text-supplementary vd-text--secondary vd-mt2" ng-if="paymentCtrl.sale.containsGiftCard()">\n    Laybys cannot be used with gift cards.\n  </div>\n  <div class="vd-text-supplementary vd-text--secondary vd-mt2" ng-if="paymentCtrl.sale.isMarkedAsUnfulfilled()">\n    Laybys and On Accounts cannot be used for unfulfilled sales.\n  </div>\n  <div class="vd-text-supplementary vd-text--secondary vd-mt2" ng-if="!paymentCtrl.sale.isMarkedAsUnfulfilled() && paymentCtrl.sale.hasValidCustomer() && paymentCtrl.hasValidTenderedAmount && paymentCtrl.isPartialPayment()">\n    Layby and On Account cannot be used for partial payments.\n  </div>\n</div>\n'},saleConfirmation:{controller:"SaleConfirmationCtrl",controllerAs:"saleConfirmationCtrl",template:'<div class="vd-card payment-panel-content payment-panel-content--action">\n  \x3c!-- Loader --\x3e\n  <div ng-if="saleConfirmationCtrl.loading" class="vd-loader vd-mt10"></div>\n  <div>\n    \x3c!-- Sale Confirmation --\x3e\n    <div ng-if="!saleConfirmationCtrl.loading" class="sale-confirmation-container">\n      <div class="sale-confirmation-header">\n        <div class="vd-text-grand pro-sale-confirmation-header">\n          <div ng-if="::saleConfirmationCtrl.sale.isQuote()">\n            Sale Quoted.\n          </div>\n\n          \x3c!-- When change is present on a sale --\x3e\n          <div ng-if="saleConfirmationCtrl.sale.hasChange()">\n            Give {{::saleConfirmationCtrl.sale.getChangeAmountForDisplay() | wrMakeAbsolute | vdCurrency}} Change\n          </div>\n\n          \x3c!-- When no change is present on the sale --\x3e\n          <div ng-if="!saleConfirmationCtrl.sale.hasChange()">\n\n            \x3c!-- When the sale total is zero --\x3e\n            <div ng-if="saleConfirmationCtrl.sale.isSaleTotalZero()">\n\n              \x3c!-- And dealing with an exchange --\x3e\n              <div ng-if="saleConfirmationCtrl.isExchange()">\n                <ng-pluralize count="saleConfirmationCtrl.getNegativeQuantity()"\n                  when="{\'-1\': \'Item\', \'other\': \'Items\'}">\n                </ng-pluralize>\n                Exchanged\n              </div>\n\n              \x3c!-- When not dealing with an exchange --\x3e\n              <div ng-if="!saleConfirmationCtrl.isExchange()">\n                Completed\n              </div>\n            </div>\n\n            \x3c!-- When completing a sale (no outstanding balance) --\x3e\n            <div ng-if="saleConfirmationCtrl.sale.isSaleTotalGreaterThanZero() &&\n              !saleConfirmationCtrl.sale.hasOutstandingBalance()">\n              Payment Received\n            </div>\n\n            \x3c!-- When dealing with a non-completed confirmed sale --\x3e\n            <div ng-if="saleConfirmationCtrl.isConfirmedReadyToComplete &&\n              saleConfirmationCtrl.sale.hasOutstandingBalance()">\n              {{::saleConfirmationCtrl.sale.getOutstandingBalance() | vdCurrency}} on\n              <span ng-if="saleConfirmationCtrl.sale.isOnAccount()">Account</span>\n              <span ng-if="saleConfirmationCtrl.sale.isLayby()">Layby</span>\n            </div>\n          </div>\n\n          \x3c!-- When dealing with a return --\x3e\n          <div ng-if="saleConfirmationCtrl.sale.isSaleTotalLessThanZero()">\n            Refund Complete\n          </div>\n        </div>\n\n        \x3c!-- Payment subtext --\x3e\n        <div class="vd-text-heading vd-pt3 pro-sale-confirmation-sub-header">\n          <span ng-if="saleConfirmationCtrl.sale.isSaleTotalLessThanZero()" class="wr-comma-separator">\n            {{::saleConfirmationCtrl.sale.finals.inclusivePrice | wrMakeAbsolute | vdCurrency}} refunded\n          </span>\n\n          \x3c!-- When dealing with an exchange --\x3e\n          <span ng-if="saleConfirmationCtrl.isExchange()" class="wr-comma-separator">\n            {{::saleConfirmationCtrl.getNegativeQuantity() | wrMakeAbsolute}}\n            <ng-pluralize count="saleConfirmationCtrl.getNegativeQuantity()"\n              when="{\'-1\': \'item\', \'other\': \'items\'}">\n            </ng-pluralize>\n            exchanged\n          </span>\n\n          \x3c!-- When payments are available on a sale but the sale is not yet completed --\x3e\n          <span ng-if="(saleConfirmationCtrl.sale.finals.inclusivePrice\n            !== saleConfirmationCtrl.sale.getOutstandingBalance()) &&\n            saleConfirmationCtrl.sale.getOutstandingBalance() > 0 &&\n            saleConfirmationCtrl.sale.hasPayments()"\n            class="wr-comma-separator">\n            {{::saleConfirmationCtrl.sale.getPaymentsTotal() | vdCurrency}} paid\n          </span>\n\n          \x3c!-- When completing and on-account / layby sale --\x3e\n          <span ng-if="!saleConfirmationCtrl.sale.hasOutstandingBalance() &&\n            saleConfirmationCtrl.sale.isConfirmedCompleted()"\n            class="wr-comma-separator">\n            <span ng-if="saleConfirmationCtrl.sale.isOnAccount()">On Account</span>\n            <span ng-if="saleConfirmationCtrl.sale.isLayby()">Layby</span>\n            complete\n          </span>\n\n          \x3c!-- When loyalty is earned / deducted --\x3e\n          <span ng-if="saleConfirmationCtrl.loyaltyManager.canDisplayReceiptLoyalty() &&\n            (saleConfirmationCtrl.loyaltyManager.saleHasLoyaltyEarned() ||\n            saleConfirmationCtrl.loyaltyManager.saleHasLoyaltyDeducted()) &&\n            saleConfirmationCtrl.sale.hasValidCustomerWithLoyalty()"\n            class="wr-comma-separator">\n            {{::saleConfirmationCtrl.loyaltyManager.getTotalLoyalty() | wrMakeAbsolute | vdCurrency}} loyalty\n            <span ng-if="saleConfirmationCtrl.loyaltyManager.saleHasLoyaltyEarned()">earned</span>\n            <span ng-if="saleConfirmationCtrl.loyaltyManager.saleHasLoyaltyDeducted()">deducted</span>\n          </span>\n        </div>\n      </div>\n\n      <div class="vd-mt5 vd-btn-group">\n        <button class="vd-btn vd-btn--text-supplementary"\n          ng-click="saleConfirmationCtrl.printReceipt()"\n          aria-label="Print default receipt">\n          <i class="fa fa-print sale-summary-print-receipt-icon"></i>\n          <span class="sale-summary-print-receipt-label">\n            Print\n          </span>\n        </button>\n\n        <button class="vd-btn vd-btn--text-supplementary"\n          ng-if="saleConfirmationCtrl.canPrintGiftReceipt()"\n          ng-click="saleConfirmationCtrl.printGiftReceipt()"\n          aria-label="Print gift receipt">\n          <i class="fa fa-gift sale-summary-print-receipt-icon"></i>\n          <span class="sale-summary-print-receipt-label">\n              Gift Receipt</span>\n        </button>\n\n        <button class="vd-btn vd-btn--text-supplementary"\n          ng-if="saleConfirmationCtrl.hasMultipleReceipts"\n          ng-click="saleConfirmationCtrl.openReceiptSelectionPopover($event)"\n          aria-label="Print other receipt">\n          <i class="fa fa-print sale-summary-print-receipt-icon"></i>\n          <span class="sale-summary-print-receipt-label">\n            Other...\n          </span>\n        </button>\n      </div>\n\n      <wr-customer-badge ng-if="saleConfirmationCtrl.sale.hasValidCustomer()"\n        customer="saleConfirmationCtrl.sale.customer"\n        customer-balances="saleConfirmationCtrl.sale.customerBalances"\n        view-options="{ canViewDetails: false, hideRemoveFromSale: true }"\n        class="vd-mt10">\n      </wr-customer-badge>\n\n      \x3c!-- Add user retrospectively to sale --\x3e\n      <vd-autocomplete class="vd-mt10" ng-if="!saleConfirmationCtrl.sale.hasValidCustomer()"\n        error-template="{{ ::saleConfirmationCtrl.customerErrorTemplate }}"\n        source="saleConfirmationCtrl.customerSource"\n        on-select="saleConfirmationCtrl.onCustomerResultSelected($event.selected)"\n        placeholder="Add a customer to email them a receipt"\n        icon="fa-envelope">\n      </vd-autocomplete>\n\n      <div class="vd-card vd-mt4" ng-if="saleConfirmationCtrl.sale.hasValidCustomer() &&\n        !saleConfirmationCtrl.sale.hasValidCustomerWithEmail() &&\n        !saleConfirmationCtrl.trainingModeManager.trainingModeEnabled">\n        <vd-action-bar class="vd-pl5 vd-pr5">\n          <div>\n            <vd-dott use-absolute-url="false"></vd-dott>\n          </div>\n          <p class="vd-p vd-align-left vd-ml3">\n              <button\n              ng-click="saleConfirmationCtrl.editCustomerInformation()"\n              class="vd-btn vd-btn--link">\n                Add an email address\n            </button>\n            to this customer so that you can email them receipts or promotional emails.\n          </p>\n        </vd-action-bar>\n      </div>\n\n      <receipt-selection-email-toggle\n        class="vd-mt10"\n        ng-if="saleConfirmationCtrl.sale.hasValidCustomerWithEmail()"\n      ></receipt-selection-email-toggle>\n\n      <form name="saleConfirmationFormCtrl" class="sale-confirmation-form" novalidate>\n        <div ng-if="saleConfirmationCtrl.shouldDisplaySaleNote()" class="sale-confirmation-form-row sale-confirmation-form-row--space">\n          <sale-note-redux\n            ng-model-options="::saleConfirmationCtrl.getModelOptions()"\n            placeholder="Type to add a sale note..."\n            min-size="2">\n          </sale-note-redux>\n          <has-cc-error-message ng-if="saleConfirmationFormCtrl.saleNote.$error.hasCreditCard" class="vd-align-left" />\n        </div>\n        <div ng-if="saleConfirmationCtrl.trainingModeManager.trainingModeOnboardingState" class="sale-confirmation-form-row">\n          <button class="vd-btn vd-btn--do vd-btn--jumbo btn--exit-mode"\n            ng-click="saleConfirmationCtrl.completeTutorial()">\n            Complete tutorial\n          </button>\n        </div>\n        <div ng-if="!saleConfirmationCtrl.trainingModeManager.trainingModeOnboardingState" class="sale-confirmation-form-row">\n          <button class="vd-btn vd-btn--do vd-btn--jumbo btn--complete-sale vd-flex vd-flex--align-center vd-flex--justify-center"\n            ng-disabled="saleConfirmationFormCtrl.saleNote.$invalid || saleConfirmationCtrl.isFinalisingSale"\n            ng-click="saleConfirmationCtrl.closeSaleConfirmation({ source: \'button\' })">\n            {{saleConfirmationCtrl.completeSaleLabel}}\n            <span class="vd-loader vd-loader--small vd-ml2" ng-if="saleConfirmationCtrl.isFinalisingSale"></span>\n          </button>\n        </div>\n      </form>\n    </div>\n  </div>\n</div>\n'}};e.state(Gt,{abstract:!0,template:'<vd-section class="wr-current-sale" ng-if="webRegisterCtrl.initComplete">\n  <div class="wr-current-sale-panel wr-current-sale-panel--workspace">\n    <div ui-view="current-sale-workspace" class="wr-transition-fade wr-full-height wr-current-sale-panel-content"></div>\n  </div>\n\n  <div class="wr-current-sale-panel wr-current-sale-panel--summary">\n    <div ui-view="current-sale-summary" class="wr-transition-fade wr-full-height wr-current-sale-panel-content"></div>\n  </div>\n\n  <div ui-view="payment-panel" class="payment-panel-view wr-transition-slide-up"></div>\n</vd-section>\n'}).state(jt,{url:dn,views:{"current-sale-workspace":t.workspace,"current-sale-summary":t.sale},params:{sale:null,action:null,closeAfterComplete:!1}}).state(Qt,{abstract:!0,views:{"payment-panel":t.paymentPanel}}).state(Wt,{views:{"payment-panel-summary":t.saleSummary,"payment-panel-action":t.payment}}).state(Ht,{url:un,views:{"payment-panel-summary":t.saleSummary,"payment-panel-action":t.saleConfirmation}})}function Nn(e){e.state(Zt,{url:mn,onEnter:["$transition",function(e){const t=e.params()||{},{customer_id:n,promo_code:s,promo_code_id:a}=t,i={customerId:n,promoCode:s,promoCodeId:a},r=[];Object.keys(i).forEach(e=>{const t=i[e];void 0!==t&&r.push(`${e}=${t}`)});const o=r.length?"?"+r.join("&"):"";window.location.href=`${gn}${o}`}],params:{filterData:null,tab:null,customer:null}})}Dn.$inject=["$stateProvider"],t.module("webregister.routes").config(Dn),Nn.$inject=["$stateProvider"],t.module("webregister.routes").config(Nn);function xn(e){e.state(Yt,{url:hn,template:'<div class="wr-register-closure-view" ui-view></div>\n',abstract:!0}).state(zt,{url:"",redirectTo:e=>e.injector().getAsync("registerManager").then(e=>e.isActiveRegisterOpen()?Jt:Xt)}).state(Jt,{template:'<vd-section>\n  <vd-header category="page">\n    Close Register\n  </vd-header>\n</vd-section>\n\n\n<div class="vd-section vd-section--secondary">\n  <div class="vd-section-wrap">\n    Close your register to finalize payments and sales for the day.\n  </div>\n</div>\n\n<vd-section ng-if="!$ctrl.isRetrieving && $ctrl.isErrored" class="vd-pt10">\n  <div class="vd-flex vd-flex--column vd-flex--align-center vd-mt10">\n    <img src="https://vendfrontendassets.freetls.fastly.net/images/error/cannot-fetch-data-v3.svg" />\n    <section class="vd-section">\n      <div class="vd-section-wrap vd-align-center">\n        <h1 class="vd-header vd-header--section">\n          Sorry, we couldn\u2019t fetch some data.\n        </h1>\n        <p class="vd-p">Please refresh this page and try again.</p>\n      </div>\n    </section>\n  </div>\n</vd-section>\n\n<vd-section>\n  <div ng-if="$ctrl.isRetrieving" class="vd-loader"></div>\n\n  <div class="wr-register-closure-info-container" ng-if="!$ctrl.isRetrieving && !$ctrl.isErrored">\n    <div class="wr-register-closure-info-section">\n      <div class="vd-g-row">\n        <div class="vd-g-col vd-g-s-12 vd-g-m-3 vd-grid-settings-item">\n          <h2 class="vd-header vd-header--settings">Register Details</h2>\n        </div>\n        <div class="vd-g-col vd-g-s-12 vd-g-m-9">\n          <register-closure-info register-closure="$ctrl.registerClosure"></register-closure-info>\n        </div>\n      </div>\n    </div>\n    <hr class="vd-hr">\n    <div class="wr-register-closure-info-section">\n      <wr-register-closure-form register-closure="$ctrl.registerClosure"></wr-register-closure-form>\n    </div>\n  </div>\n</vd-section>\n',controller:"CloseRegisterController",controllerAs:"$ctrl"}).state(Xt,{template:'<vd-section>\n  <vd-header category="page">\n    Open Register\n  </vd-header>\n</vd-section>\n\n<div class="vd-section vd-section--action-bar">\n  <div class="vd-section-wrap">\n    <div ng-if="!$ctrl.isCashManagementEnabled" class="vd-section--action-bar-about">\n      To make a sale, please open the register.\n    </div>\n    <div ng-if="$ctrl.isCashManagementEnabled" class="vd-section--action-bar-about">\n      Set an opening float to open the register and make a sale.\n    </div>\n    <div class="vd-section--action-bar-actions">\n      <button class="vd-btn vd-btn--supplementary"\n        ng-click="$ctrl.printSummary()"\n        ng-disabled="!$ctrl.registerClosure">\n        Print Last Summary\n      </button>\n    </div>\n  </div>\n</div>\n\n<div class="vd-section vd-section--tertiary">\n  <open-register-panel ng-if="!$ctrl.isRegisterOpen"\n    register="webRegisterCtrl.register"\n    web-register-online="webRegisterCtrl.webRegisterOnline"\n    minimal="true">\n  </open-register-panel>\n</div>\n\n<vd-section>\n\n  <div ng-if="$ctrl.registerClosure"\n    class="wr-last-register-closure-summary-container">\n    <div class="wr-register-closure-info-section">\n      <div class="wr-register-closure-info-section">\n        <div class="vd-g-row">\n          <div class="vd-g-col vd-g-s-12 vd-g-m-3 vd-grid-settings-item">\n            <h2 class="vd-header vd-header--settings">Last Closure Details</h2>\n          </div>\n          <div class="vd-g-col vd-g-s-12 vd-g-m-9">\n            <register-closure-info register-closure="$ctrl.registerClosure"></register-closure-info>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <hr class="vd-hr">\n\n    <div class="wr-register-closure-info-section">\n      <h2 class="vd-header vd-header--settings">Last Payments Summary</h2>\n      <div class="vd-g-row">\n        <div class="vd-g-col vd-g-s-12 vd-g-m-3 vd-grid-settings-item"></div>\n        <div class="vd-g-col vd-g-s-12 vd-g-m-9">\n          <wr-register-closure-summary-table register-closure="$ctrl.registerClosure"></wr-register-closure-summary-table>\n        </div>\n      </div>\n    </div>\n    <hr ng-if-start="$ctrl.registerClosure.note" class="vd-hr">\n    <div ng-if-end class="wr-register-closure-info-section">\n      <div class="vd-g-row">\n        <div class="vd-g-col vd-g-s-12 vd-g-m-3 vd-grid-settings-item">\n          <h2 class="vd-header vd-header--settings">Last Closing Summary</h2>\n        </div>\n        <div class="vd-g-col vd-g-s-12 vd-g-m-9">\n          <register-closure-summary-notes register-closure="$ctrl.registerClosure"></register-closure-summary-notes>\n        </div>\n      </div>\n    </div>\n    <div class="vd-mt5 vd-btn-group">\n      <button class="vd-btn vd-btn--supplementary"\n        ng-click="$ctrl.printSummary()"\n        ng-disabled="!$ctrl.registerClosure">\n        Print Last Summary\n      </button>\n      <a ng-if="$ctrl.registerClosureSalesUrl"\n        ng-href="{{$ctrl.registerClosureSalesUrl}}"\n        ng-click="$ctrl.registerSaleTracking()"\n        class="vd-btn vd-btn--supplementary">\n        View Register Closure Sales\n      </a>\n    </div>\n</vd-section>\n',controller:"OpenRegisterController",controllerAs:"$ctrl"})}xn.$inject=["$stateProvider"],t.module("webregister.routes").config(xn);t.module("webregister.routes").config(["$stateProvider",function(e){e.state(en,{url:yn,template:'<vd-section>\n  <vd-header category="page">\n    Status\n  </vd-header>\n</vd-section>\n\n<div ng-include="\'status/status-error-sales.html\'" ng-controller="StatusErrorSalesCtrl as statusErrorSalesCtrl"></div>\n\n<vd-section>\n  <reset-data></reset-data>\n</vd-section>\n',controller:"StatusCtrl",controllerAs:"statusCtrl"})}]);function On(e){e.state(tn,{url:fn,template:'<vd-section>\n  <vd-header category="page">Settings</vd-header>\n</vd-section>\n\n<vd-section type="secondary">Manage your register settings.</vd-section>\n\n<vd-section class="vd-mt5">\n  <vd-header category="settings">Training Mode</vd-header>\n\n  <div class="vd-g-row">\n    <div class="vd-g-col vd-g-s-12 vd-g-m-3 wr-settings-item-summary">\n      <p class="vd-p">\n        Enable Training Mode if you\u2019re new to Vend and want to learn the ropes. You\u2019ll be selling like a\n        pro in no time.\n      </p>\n    </div>\n    <div class="vd-g-col vd-g-s-12 vd-g-m-9">\n      <wr-enable-training-button button-class="register-enable-training"></wr-enable-training-button>\n    </div>\n  </div>\n</vd-section>\n\n<hr class="vd-hr">\n\n<vd-section ng-if="settingsCtrl.quickKeysManager.hasPermission()">\n  <vd-header category="settings">Quick Keys</vd-header>\n  <div class="vd-g-row">\n    <div class="vd-g-col vd-g-s-12 vd-g-m-3 wr-settings-item-summary">\n      <p class="vd-p">\n        Assign products as Quick&nbsp;Keys to help process sales faster. Rename, reposition and recolor keys, or organize\n        your buttons into folders and pages.\n      </p>\n    </div>\n    <div class="vd-g-col vd-g-s-12 vd-g-m-9">\n      <div class="wr-media wr-media--center vd-mb10">\n        <vd-switch ng-model="settingsCtrl.toggleQuickKeysEnabled"\n          ng-model-options="{ getterSetter: true, debounce: 300 }"\n          class="wr-media-object"\n          ng-class="{ \'wr-settings-qk-switch-updating\' : settingsCtrl.awaitingServerResponse }">\n        </vd-switch>\n        <div class="wr-media-body">\n          <div class="vd-header vd-mb1">Enable Quick&nbsp;Keys for this register.</div>\n          <p class="vd-p vd-text--sub">Toggle the switch to enable your Quick Keys for your\n            register. You can turn this back on at anytime without losing your settings.</p>\n        </div>\n      </div>\n      <wr-qk-layouts></wr-qk-layouts>\n    </div>\n  </div>\n</vd-section>\n',controller:"SettingsCtrl",controllerAs:"settingsCtrl"}).state(nn,{url:"/quickkeys",abstract:!0}).state(sn,{url:"/:layoutId",params:{newLayout:!1},views:{"@webregister":{template:'<vd-section level="2" ng-if-start="editQuickKeyLayoutCtrl.quickKeyLayout">\n  <vd-header category="page">\n    <vd-section-back ui-sref="{{editQuickKeyLayoutCtrl.settingsState}}"></vd-section-back>\n    {{editQuickKeyLayoutCtrl.isNewLayout ? \'Add Quick Key Layout\' : editQuickKeyLayoutCtrl.quickKeyLayout.name}}\n  </vd-header>\n</vd-section>\n\n<vd-section type="secondary">\n  <div vd-flex vd-flex-justify="between" vd-flex-align="center">\n    <span class="vd-pr3">Rename, reposition and recolor keys, or organize your products into folders.</span>\n    <button ng-click="editQuickKeyLayoutCtrl.save()"\n      class="vd-btn vd-btn--do pro-quick-key-edit-save-button"\n      ng-disabled="editQuickKeyLayoutCtrl.isSaving">\n      {{editQuickKeyLayoutCtrl.quickKeySettingsForm.$dirty ||  editQuickKeyLayoutCtrl.isNewLayout ? \'Save\' : \'Done\'}}\n      <i ng-if="editQuickKeyLayoutCtrl.isSaving" class="vd-loader vd-loader--small"></i>\n    </button>\n  </div>\n</vd-section>\n\n<vd-section ng-if-end>\n  <form name="editQuickKeyLayoutCtrl.quickKeySettingsForm">\n    <div class="vd-g-row">\n      <div class="vd-g-col vd-g-s-12 vd-g-m-3 vd-grid-settings-item">\n        <vd-header category="settings">General</vd-header>\n      </div>\n      <div class="vd-g-col vd-g-s-12 vd-g-m-9">\n        <div class="vd-field vd-field--short">\n          <div class="vd-label">Layout Name</div>\n          <div class="vd-value">\n            <input type="text"\n              name="layoutName"\n              class="vd-input"\n              ng-model="editQuickKeyLayoutCtrl.quickKeyLayoutName"\n              placeholder="Quick Key Layout name"\n              vd-focus="{ isFocusable: true }"\n              spellcheck="false"\n              autocomplete="off"\n              maxlength="64"\n              required>\n            <ng-messages ng-if="editQuickKeyLayoutCtrl.quickKeySettingsForm.layoutName.$invalid &&\n              editQuickKeyLayoutCtrl.quickKeySettingsForm.layoutName.$dirty"\n              class="vd-input-error-message-section" for="editQuickKeyLayoutCtrl.quickKeySettingsForm.layoutName.$error">\n              <ng-message when="required">\n                <vd-icon icon="fa-exclamation-triangle"></vd-icon>\n                <span class="vd-input-error-message-text">\n                  This field is required.\n                <span>\n              </ng-message>\n            </ng-messages>\n          </div>\n        </div>\n        <div><strong>Quick Key Behavior</strong></div>\n        <vd-checkbox ng-model="editQuickKeyLayoutCtrl.isCloseFolderEnabled"\n          label="Leave selected folder open until end of the sale"\n          class="vd-ml0 vd-mt3">\n        </vd-checkbox>\n      </div>\n    </div>\n  </form>\n\n  <hr class="vd-hr">\n  <vd-header category="settings">Add Products</vd-header>\n  <div class="vd-g-row">\n    <div class="vd-g-col vd-g-s-12 vd-g-m-3 vd-grid-settings-item">\n      <p class="vd-p">\n        Search for products to add to your Quick Key layout. Drag and drop to rearrange.\n      </p>\n    </div>\n    <div class="vd-g-col vd-g-s-12 vd-g-m-9">\n      <div ng-if="editQuickKeyLayoutCtrl.quickKeyLayout" class="edit-qk-layout-workspace">\n        <div>\n          <div class="vd-text-label vd-mb1">Search for products</div>\n          <vd-autocomplete source="editQuickKeyLayoutCtrl.suggestionSource"\n            on-select="editQuickKeyLayoutCtrl.onSelectResult($event.selected)"\n            placeholder="Start typing or scanning\u2026"\n            icon="fa-search">\n          </vd-autocomplete>\n        </div>\n        <div class="edit-qk-layout-panel-layout">\n          <vd-quick-keys vd-flex\n            edit-mode="editQuickKeyLayoutCtrl.canUpdateLayout()"\n            layout-data="editQuickKeyLayoutCtrl.quickKeyLayout"\n            layout-data-adaptor="editQuickKeyLayoutCtrl.layoutDataAdaptor">\n          </vd-quick-keys>\n        </div>\n      </div>\n      <div ng-if="!editQuickKeyLayoutCtrl.quickKeyLayout"\n        class="edit-qk-layout-workspace edit-qk-layout-workspace--loading">\n        <div class="vd-loader"></div>\n      </div>\n    </div>\n  </div>\n</vd-section>\n',controller:"EditQuickKeyLayoutCtrl",controllerAs:"editQuickKeyLayoutCtrl"}}})}On.$inject=["$stateProvider"],t.module("webregister.routes").config(On);t.module("webregister.routes").config(["$stateProvider",function(e){e.state(an,{abstract:!0,template:'<div class="wr-error-page" ui-view></div>\n'}).state(rn,{url:Sn,template:"<offline-notice heading=\"Unable to load Register\"></offline-notice>\n<div class=\"wr-offline-requirements\">\n  <p class=\"vd-p\">Trying to run Vend Register offline? Make sure you have:</p>\n  <div>\n    <ul class=\"wr-offline-requirement-list\">\n      <li ng-class=\"{\n        'wr-offline-requirement-check': offlineErrorCtrl.hasCompletedSync,\n        'wr-offline-requirement-cross': !offlineErrorCtrl.hasCompletedSync\n        }\">\n        <i ng-class=\"{\n          'fa fa-check': offlineErrorCtrl.hasCompletedSync,\n          'fa fa-times': !offlineErrorCtrl.hasCompletedSync\n        }\"></i>\n        Loaded full store in this browser before\n      </li>\n      <li ng-class=\"{\n        'wr-offline-requirement-check': offlineErrorCtrl.hasLoggedInUser,\n        'wr-offline-requirement-cross': !offlineErrorCtrl.hasLoggedInUser\n        }\">\n        <i ng-class=\"{\n          'fa fa-check': offlineErrorCtrl.hasLoggedInUser,\n          'fa fa-times': !offlineErrorCtrl.hasLoggedInUser\n        }\"></i>\n        At least one user logged in\n      </li>\n    </ul>\n    Right now, you can not run Vend Register offline\n  </div>\n</div>\n",controller:"OfflineErrorCtrl",controllerAs:"offlineErrorCtrl"})}]);function $n(e){e.state(on,{url:Cn,template:'<div ng-if="cashManagementCtrl.activeRegister">\n  <vd-section ng-if="!cashManagementCtrl.cashManagementEnabled">\n    <vd-panel class="wr-cash-management-panel">\n      <vd-section type="panel" class="vd-align-center wr-cash-management-panel-header">\n        <img class="wr-cash-management-panel-image"\n             ng-src="{{ \'sell/cash-management-onboarding-v1.png\' | vdImageCdnPath }}"/>\n        <vd-header category="page">Introducing Cash Management</vd-header>\n        <p class="vd-p vd-mb0">Start tracking cash movements across shifts, days and cashiers, and take control of your register.</p>\n\n        <div ng-if="cashManagementCtrl.canEnableCashManagement">\n          <a ng-click="cashManagementCtrl.showrefresh = true"\n            href="{{cashManagementCtrl.enableCashManagementUrl}}"\n            target="_blank"\n            class="vd-mt5 vd-btn vd-btn--do">\n            Enable Cash Management\n          </a>\n        </div>\n\n        <p ng-if="cashManagementCtrl.canEnableCashManagement && cashManagementCtrl.showrefresh"\n          class="vd-p vd-text--negative vd-mt5">\n          <vd-icon icon="fa-exclamation-triangle" class="vd-mr1"></vd-icon> Please manually refresh this page after enabling Cash Management.\n        </p>\n\n        <div ng-if="!cashManagementCtrl.canEnableCashManagement">\n          <p class="vd-p vd-text--negative vd-mt5">\n            Please switch to an admin to enable Cash Management.\n          </p>\n          <button class="vd-btn vd-btn--do" ng-click="cashManagementCtrl.switchUser()">\n            Switch users\n          </button>\n        </div>\n      </vd-section>\n      <vd-section type="panel">\n        <div vd-flex vd-flex-justify="center">\n          <ul class="wr-cash-management-value-props vd-mt5 vd-mb5">\n            <li class="vd-pl10">\n              <vd-icon class="wr-cash-management-value-prop-icon" icon="fa-exchange"></vd-icon>\n              <vd-header>Track petty cash in and out, plus safe deposit drops</vd-header>\n              <p class="vd-p">\n                Need to buy supplies? Want to make a cash deposit at the bank? Cash Management records the money you take out of your cash drawer so you know exactly where your cash is. You can even make notes to remind yourself. When you close your register each day, Vend will automatically adjust the amount.\n              </p>\n            </li>\n            <li class="vd-pl10 vd-mt5">\n              <vd-icon class="wr-cash-management-value-prop-icon" icon="fa-user-secret"></vd-icon>\n              <vd-header>Check for discrepancies and reduce theft</vd-header>\n              <p class="vd-p">\n                With visibility over all your cash movements throughout the day, it\'s easier to track discrepancies and reduce theft.\n              </p>\n            </li>\n            <li class="vd-pl10 vd-mt5">\n              <vd-icon class="wr-cash-management-value-prop-icon" icon="fa-calculator"></vd-icon>\n              <vd-header>Keep your accounting in check</vd-header>\n              <p class="vd-p">\n                Use Xero? Every cash movement will also be sent to Xero. Your accountant will love you.\n              </p>\n            </li>\n          </ul>\n        </div>\n      </vd-section>\n      <vd-section class="vd-align-center">\n        <p class="vd-p">\n          Find out more about Vend Cash Management in our\n          <a target="_blank"\n            href="https://support.vendhq.com/hc/en-us/articles/207884598-Cash-Management-in-Vend"\n            class="vd-link">\n            Help Center\n          </a>\n        </p>\n      </vd-section>\n    </vd-panel>\n  </vd-section>\n\n  <vd-section ng-if-start="cashManagementCtrl.cashManagementEnabled">\n    <vd-header category="page">\n      Cash Management\n    </vd-header>\n  </vd-section>\n\n  <div ng-if="webRegisterCtrl.registerManager.isActiveRegisterOpen()">\n    <vd-banner ng-if="cashManagementCtrl.failedCashMovementsRetrieval" type="negative">\n      Sorry, there was a problem loading recent cash movements.\n      <button class="vd-btn vd-btn--supplementary vd-ml10" ng-click="cashManagementCtrl.retrieveCashMovements()">Retry</button>\n    </vd-banner>\n\n    <wr-set-register-cash-float ng-if="!cashManagementCtrl.waitingForInitialCashMovements &&\n      !cashManagementCtrl.failedCashMovementsRetrieval && !cashManagementCtrl.isCashFloatSet"\n      on-cash-float-set="cashManagementCtrl.retrieveCashMovements()">\n    </wr-set-register-cash-float>\n\n    <vd-section ng-if-start="!cashManagementCtrl.waitingForInitialCashMovements && cashManagementCtrl.isCashFloatSet"\n      type="secondary">\n      <div vd-flex vd-flex-justify="between" vd-flex-align="center">\n        <div>\n          Record your cash movements for the day.\n          <a target="_blank"\n            href="https://support.vendhq.com/hc/en-us/articles/207884598-Cash-Management-in-Vend"\n            class="vd-link vd-link--secondary">\n            Need help?\n          </a>\n        </div>\n\n        <div class="vd-btn-group">\n          <button class="vd-btn vd-btn--no" ng-click="cashManagementCtrl.recordCashMovement(\'remove\')">\n            Remove Cash\n          </button>\n          <button class="vd-btn vd-btn--do" ng-click="cashManagementCtrl.recordCashMovement(\'add\')">\n            Add Cash\n          </button>\n        </div>\n      </div>\n    </vd-section>\n    <vd-section ng-if-end>\n      <wr-cash-movements cash-movements="cashManagementCtrl.cashMovements"></wr-cash-movements>\n    </vd-section>\n  </div>\n\n  <vd-section ng-if-end ng-if="!webRegisterCtrl.registerManager.isActiveRegisterOpen()">\n    <open-register-panel register="webRegisterCtrl.register"\n      web-register-online="webRegisterCtrl.webRegisterOnline"\n      modifier="boxed">\n    </open-register-panel>\n  </vd-section>\n</div>\n',controller:"CashManagementCtrl",controllerAs:"cashManagementCtrl"})}function Ln(e){return"string"!=typeof e||0===e.length?e:e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}$n.$inject=["$stateProvider"],t.module("webregister.routes").config($n),t.module("webregister.filters").filter("ucFirst",()=>Ln);function Fn(t,n,s){let a;o(n)&&(s=n),s=!!o(s)&&s,n=l(n)?n:2;try{a=c.round(t,n)}catch(e){a=t}return s&&(a=d(parseFloat(a))?a:parseFloat(a).toString()),a}t.module("webregister.filters").filter("displayRound",()=>Fn);function Un(e,t="ddd, Do MMMM, YYYY, h:mma",n){if(!e)return"\u2013";const s=u(e);return n&&s.tz(n),s.format(t)}function Bn(e){return h(e)}let qn;t.module("webregister.filters").filter("wrDateFormat",()=>Un),t.module("webregister.filters").filter("wrCustomerName",(function(){return Bn})),function(e){e.CLOSED="CLOSED",e.PARKED="SAVED",e.VOIDED="VOIDED",e.ACCOUNT_SALE="ONACCOUNT",e.ACCOUNT_SALE_CLOSED="ONACCOUNT_CLOSED",e.LAYBY_SALE="LAYBY",e.LAYBY_SALE_CLOSED="LAYBY_CLOSED",e.RETURN_PARKED="RETURN_PARKED",e.RETURN_CLOSED="RETURN_CLOSED",e.EXCHANGE_PARKED="EXCHANGE_PARKED",e.EXCHANGE_CLOSED="EXCHANGE_CLOSED",e.DISPATCHED_CLOSED="DISPATCHED_CLOSED",e.PICKED_UP_CLOSED="PICKED_UP_CLOSED",e.QUOTE="QUOTE",e.AWAITING_DISPATCH="AWAITING_DISPATCH",e.AWAITING_PICKUP="AWAITING_PICKUP"}(qn||(qn={}));const Vn=[qn.ACCOUNT_SALE,qn.LAYBY_SALE],Kn=[qn.ACCOUNT_SALE_CLOSED,qn.LAYBY_SALE_CLOSED],Gn=[qn.CLOSED,qn.ACCOUNT_SALE_CLOSED,qn.LAYBY_SALE_CLOSED,qn.EXCHANGE_CLOSED,qn.RETURN_CLOSED,qn.DISPATCHED_CLOSED,qn.PICKED_UP_CLOSED],jn=Gn.concat(qn.VOIDED),Qn=[qn.LAYBY_SALE,qn.ACCOUNT_SALE,qn.PARKED,qn.EXCHANGE_PARKED,qn.RETURN_PARKED,qn.AWAITING_DISPATCH,qn.AWAITING_PICKUP],Wn=jn.concat(qn.AWAITING_DISPATCH,qn.AWAITING_PICKUP),Hn=[qn.ACCOUNT_SALE,qn.ACCOUNT_SALE_CLOSED,qn.LAYBY_SALE,qn.LAYBY_SALE_CLOSED,qn.EXCHANGE_CLOSED,qn.RETURN_CLOSED,qn.AWAITING_DISPATCH,qn.AWAITING_PICKUP],Yn=[qn.CLOSED,qn.ACCOUNT_SALE_CLOSED,qn.LAYBY_SALE_CLOSED,qn.EXCHANGE_CLOSED,qn.AWAITING_DISPATCH,qn.AWAITING_PICKUP];let zn;!function(e){e.ATTEMPTED="ATTEMPTED",e.UNMODIFIED="UNMODIFIED",e.MODIFIED="MODIFIED",e.UPLOAD="UPLOAD",e.UPLOADED="UPLOADED",e.ERROR="ERROR"}(zn||(zn={}));const Jn=[zn.UNMODIFIED,zn.UPLOADED],Xn=[zn.ATTEMPTED,zn.UPLOAD,zn.ERROR],Zn=[zn.ATTEMPTED,zn.UPLOAD];t.module("webregister.filters").filter("wrSaleStatus",(function(){const e={[qn.CLOSED]:"Completed",[qn.PARKED]:"Parked",[qn.VOIDED]:"Voided",[qn.ACCOUNT_SALE]:"On Account",[qn.ACCOUNT_SALE_CLOSED]:"On Account, completed",[qn.LAYBY_SALE]:"Layby",[qn.LAYBY_SALE_CLOSED]:"Layby, completed",[qn.RETURN_PARKED]:"Parked Return",[qn.RETURN_CLOSED]:"Return, completed",[qn.EXCHANGE_PARKED]:"Parked Exchange",[qn.EXCHANGE_CLOSED]:"Exchange, completed"};return function(t,n="\u2013"){const s=t&&(t.displayStatus||t.status)||t;return e[s]||n}})),t.module("webregister.filters").filter("wrUserName",(function(){return function(e){return e?e.display_name||e.username:""}})),t.module("webregister.filters").filter("wrGiftCardTransactionStatus",["vdTitleCaseFilter",function(e){const t={ACTIVATION:"Issued",REDEEMING:"Redeemed",IMPORTING:"Imported",VOIDING:"Cancelled",REVERSING:"Reversed",EXPIRING:"Expired"};return function(n){return t[n]||e(n)}}]),t.module("webregister.filters").filter("wrMakeAbsolute",(function(){return function(e){if(e)return c.vn(e).absoluteValue().toNumber()}})),t.module("webregister.directives").directive("wrPrintOpenDrawer",(function(){return{template:'<p class="vd-show-print">**** Open Cash Drawer ****</p>',controller(){}}}));t.module("webregister.directives").directive("hasCreditCard",["vdFeatureManager",function(e){return{restrict:"A",require:"ngModel",link(t,n,s,a){a.$validators.hasCreditCard=(t,n)=>!e.get("cardholder_data_validation_webregister")||!m(n)}}}]);t.module("webregister.directives").directive("wrInfoField",(function(){return{scope:{label:"<",value:"<"},transclude:!0,restrict:"EA",template:'<div class="wr-info-field-label">{{infoFieldCtrl.label}}</div>\n<div ng-if="infoFieldCtrl.hasValueAttribute" class="wr-info-field-value">{{infoFieldCtrl.value || \'\u2013\'}}</div>\n<div ng-if="!infoFieldCtrl.hasValueAttribute" class="wr-info-field-value" ng-transclude></div>\n',controllerAs:"infoFieldCtrl",bindToController:!0,link(e,t,n){n.$addClass("wr-info-field")},controller:["$attrs",function(e){this.hasValueAttribute=e.$attr.hasOwnProperty("value")}]}})),t.module("webregister.directives").directive("wrCurrencySymbol",(function(){return{restrict:"E",template:"{{currencySymbolCtrl.currencySymbol}}",controllerAs:"currencySymbolCtrl",controller:["$scope","registerManager",function(e,t){this.setCurrencySymbol=function(){const e=t.getActiveOutlet();this.currencySymbol=e?e.currency_symbol:"$"},this._onActiveOutletChange=function(){e.$applyAsync(()=>this.setCurrencySymbol())},t.on("activeOutletChange",this._onActiveOutletChange,this),e.$on("$destroy",()=>t.off("activeOutletChange",this._onActiveOutletChange)),this.setCurrencySymbol()}]}}));t.module("webregister.directives").directive("offlineNotice",(function(){return{scope:{heading:"@"},restrict:"E",template:'<img class="wr-offline-notice-icon" ng-src="{{ \'sell/error-v1.svg\' | vdImageCdnPath }}" />\n<h1 class="wr-offline-notice-heading vd-text-heading">{{offlineNoticeCtrl.heading}}</h1>\n<div class="wr-offline-notice-body">\n  Not sure why? Check your Internet connection and\n  <a href="{{offlineNoticeCtrl.vendStatusUrl}}" target="_blank" class="vd-link">Vend\'s system status</a>.\n</div>\n',bindToController:!0,controllerAs:"offlineNoticeCtrl",link(e,t){t.addClass("wr-offline-notice")},controller(){this.vendStatusUrl=_n.VEND_STATUS_URL}}}));t.module("webregister.directives").directive("wrQuickKeys",(function(){return{restrict:"E",template:'<vd-quick-keys ng-if="wrQuickKeysCtrl.quickKeyLayout"\n  layout-data="wrQuickKeysCtrl.quickKeyLayout"\n  layout-data-adaptor="wrQuickKeysCtrl.layoutDataAdaptor">\n</vd-quick-keys>\n\n<div ng-if="wrQuickKeysCtrl.initialised && !wrQuickKeysCtrl.quickKeyLayout && webRegisterCtrl.register &&\n  !webRegisterCtrl.trainingModeEnabled && webRegisterCtrl.webRegisterOnline"\n  class="wr-workspace-quickkey-setup wr-workspace-faux-quick-keys">\n\n  <div class="wr-workspace-faux-quick-keys-bg">\n    <vd-header category="page">Quick Keys</vd-header>\n    <div class="wr-workspace-quickkey-setup-splash"></div>\n\n    <div class="wr-workspace-quickkey-splash-content">\n      <div ng-include="\'current-sale/faux-quick-keys.html\'"></div>\n      <div class="vd-p vd-text--secondary vd-mt10">\n        Create custom buttons or Quick Keys for your most popular products, and speed up&nbsp;checkouts.\n        <span ng-if="!wrQuickKeysCtrl.quickKeysManager.hasPermission()">\n          Switch to an Admin or Manager to set up your Quick Keys.\n        </span>\n      </div>\n    </div>\n\n    <div ng-if="!wrQuickKeysCtrl.quickKeysSetupInProgress" class="wr-workspace-quickkey-setup-actions vd-mt5">\n      <button ng-if="wrQuickKeysCtrl.quickKeysManager.hasPermission()"\n        class="vd-btn vd-btn--supplementary"\n        ng-click="wrQuickKeysCtrl.setUpQuickKeys()">\n        Set up Quick Keys\n      </button>\n      <div ng-if="!wrQuickKeysCtrl.quickKeysManager.hasPermission()">\n        <button ng-click="wrQuickKeysCtrl.switchUser()" class="vd-btn vd-btn--supplementary">Switch users</button>\n      </div>\n    </div>\n\n    <div ng-if="wrQuickKeysCtrl.quickKeysSetupInProgress" class="wr-workspace-faux-quick-keys">\n      <div class="vd-loader vd-mt3"></div>\n      <div class="vd-text--secondary vd-mt3">Setting up</div>\n      <div class="vd-text--sub vd-text--secondary vd-mt3">This may take a few minutes to complete</div>\n    </div>\n  </div>\n</div>\n',controllerAs:"wrQuickKeysCtrl",controller:"wrQuickKeysCtrl"}})),t.module("webregister.directives").directive("wrSalePaymentHeading",(function(){return{restrict:"E",template:"{{::salePaymentHeadingCtrl.heading}}",controllerAs:"salePaymentHeadingCtrl",bindToController:!0,controller:["saleManager",function(e){const t=e.sale;this._determineHeading=function(){return t.isReturn()||t.isExchange()?t.isExchange()?"Exchange":"Return":t.isCompleted()?"Payment":"Amount to Pay"},this.heading=this._determineHeading()}]}})),t.module("webregister.directives").directive("wrSaleListScroll",(function(){return{restrict:"A",controller:["$scope",function(e){this._scrollContainer=function(){Je(()=>{const e=document.querySelector(".sale-list .sale-list-item:last-child");e&&e.scrollIntoView(!1)})};const t=[He.$on("sale:add-line-item",this._scrollContainer),He.$on("sale:add-unknown-line-item",this._scrollContainer)];e.$on("$destroy",()=>{t.forEach(e=>e())})}]}}));var es;t.module("webregister.directives").directive("wrDisplaySaleDiscount",(function(){return{restrict:"E",scope:{sale:"=",customClasses:"="},template:'<div data-cy="discount-label" ng-class="customClasses.label">\n  Additional Discount\n</div>\n\n<wr-sale-discount-value ng-class="customClasses.value"\n  sale-discount="sale.discount">\n</wr-sale-discount-value>\n'}})),t.module("webregister.directives").directive("wrSaleDiscountValue",(function(){return{restrict:"E",scope:{saleDiscount:"<"},template:"{{ctrl.getDiscount() | vdCurrency}}",controllerAs:"ctrl",bindToController:!0,controller:["registerManager",function(e){const t=e.isTaxInclusive();this.getDiscount=function(){let e;if(this.saleDiscount&&this.saleDiscount.price){const{price:n,tax:s}=this.saleDiscount;e=t?c.add(n,s):n}else e=0;return-e}}]}})),function(e){e.ACCESS="sell_screen.view",e.SALE_DISCOUNT="sale.discount.manage",e.SALE_LAYBY="sale.layby.process",e.SALE_NOTES="sale.note.manage",e.SALE_ON_ACCOUNT="sale.on_account.process",e.SALE_PARKED="sale.parked.process",e.SALE_REMOVE_TAX="sale.tax.remove",e.SALE_RETURN="sale.return.process",e.PRODUCT_VIEW_COST="product.cost.view",e.CUSTOMER_ADD_EDIT="customer.add_edit",e.REGISTER_OPEN_CLOSE="register.closures.perform",e.CASH_FLOAT="cash_movement.float.add",e.CASH_IN_OUT="cash_movement.cash_in_out.add",e.CASH_PETTY="cash_movement.petty_cash_in_out.add",e.STORE_CREDIT_ISSUE_MANUAL="store_credit.issue.manual",e.STORE_CREDIT_ISSUE_RETURN="store_credit.issue.return",e.STORE_CREDIT_MANAGE="store_credit.manage",e.QUICK_KEYS_MANAGE="quick_keys.manage",e.PAYMENT_TYPE_ADD_EDIT="payment_type.add_edit",e.HISTORY_VIEW="sale.history.view",e.PRODUCT_VIEW="product.view"}(es||(es={}));var ts=es;t.module("webregister.directives").directive("wrProductVariantTable",["vdFeatureManager",function(e){const t={inventory_level:"\u2013"};return{scope:{parentProduct:"=",variantProducts:"=",inventoryData:"=",outlet:"="},restrict:"E",template:'<table class="vd-table vd-table--fixed vd-table--report wr-table--report">\n  <thead>\n    <tr>\n      <th ng-repeat="variantOption in ::productVariantTableCtrl.variantOptions">\n        {{::variantOption.name}}\n      </th>\n      <th>SKU</th>\n      <th ng-if="::productVariantTableCtrl.hasInventory"\n        class="vd-align-right">\n        Inventory Count\n      </th>\n      <th ng-if="::productVariantTableCtrl.canViewSupplierPrice"\n        class="vd-align-right">\n        Supplier Price\n      </th>\n      <th class="vd-align-right">Price</th>\n    </tr>\n  </thead>\n\n  <tbody>\n    <tr ng-repeat="product in ::productVariantTableCtrl.variantProducts">\n      <td ng-repeat="variantOption in ::productVariantTableCtrl.variantOptions">\n        {{::productVariantTableCtrl.getVariantOptionValue(product, variantOption)}}\n      </td>\n      <td>{{::product.sku}}</td>\n      <td ng-if="::productVariantTableCtrl.hasInventory" class="vd-align-right">\n        <wr-inventory-level inventory="::productVariantTableCtrl.getInventoryData(product)" has-feature-inbound-indicator="productVariantTableCtrl.hasFeatureInboundIndicator"></wr-inventory-level>\n      </td>\n      <td ng-if="::productVariantTableCtrl.canViewSupplierPrice" class="vd-align-right">\n        {{::product.supply_price | vdCurrency}}\n      </td>\n      <td class="vd-align-right">\n        {{::product.basePrice | vdCurrency}}\n      </td>\n    </tr>\n  </tbody>\n</table>\n',controllerAs:"productVariantTableCtrl",bindToController:!0,controller:["userManager",function(n){this.$onInit=()=>{this.hasFeatureInboundIndicator=e.get("inbound_indicator"),this.variantOptions=this.parentProduct.variant_options,this.hasInventory=Boolean(this.parentProduct.has_inventory&&this.outlet),this.canViewSupplierPrice=n.hasPermission(ts.PRODUCT_VIEW_COST)},this.getVariantOptionValue=function(e,t){const n=g(e.variant_options,{id:t.id});return n&&n.value||"\u2013"},this.getInventoryData=function(e){return g(this.inventoryData,{product_id:e.id,outlet_id:this.outlet.id})||t}}]}}]);t.module("webregister.directives").directive("wrProductOutletInventoryTable",["vdFeatureManager",function(e){return{scope:{outlets:"=",inventoryData:"="},restrict:"E",template:'<table class="vd-table vd-table--fixed vd-table--report wr-table--report">\n  <thead>\n    <tr>\n      <th>Outlet</th>\n      <th class="vd-align-right">Inventory Count</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr ng-repeat="outletInventory in ::productOutletInventoryTableCtrl.inventoryByOutlet">\n      <td>{{::outletInventory.outletName}}</td>\n      <td class="vd-align-right">\n        <sr-inbound-indicator-wrapper\n          product-id="outletInventory.product_id"\n          outlet-id="outletInventory.outlet_id"\n          ng-if="!productOutletInventoryTableCtrl.hasFeatureInboundIndicator && outletInventory.hasInboundOrders">\n        </sr-inbound-indicator-wrapper>\n        <wr-inventory-level inventory="::outletInventory" has-feature-inbound-indicator="productOutletInventoryTableCtrl.hasFeatureInboundIndicator"></wr-inventory-level>\n      </td>\n    </tr>\n  </tbody>\n</table>\n',controllerAs:"productOutletInventoryTableCtrl",bindToController:!0,controller(){this.$onInit=()=>{this.hasFeatureInboundIndicator=e.get("inbound_indicator");const t=p(this.inventoryData,e=>{const t=g(this.outlets,{id:e.outlet_id});return y({},e,{outletName:t&&t.name})});this.inventoryByOutlet=v(t,"outletName")}}}}]);t.module("webregister.directives").directive("wrProductVariantInventoryByOutlet",(function(){return{scope:{outlets:"=",parentProduct:"=",variantProducts:"=",inventoryData:"="},restrict:"E",template:'<vd-tabs model="productVariantInventoryByOutletCtrl.selectedOutlet">\n  <vd-tab ng-repeat="outlet in ::productVariantInventoryByOutletCtrl.outlets"\n    active="$index === productVariantInventoryByOutletCtrl.selectedOutlet"\n    value="$index">\n    {{::outlet.name}}\n  </vd-tab>\n</vd-tabs>\n\n<div ng-if="$index === productVariantInventoryByOutletCtrl.selectedOutlet"\n  ng-repeat="outlet in ::productVariantInventoryByOutletCtrl.outlets">\n  <wr-product-variant-table parent-product="::productVariantInventoryByOutletCtrl.parentProduct"\n    variant-products="::productVariantInventoryByOutletCtrl.variantProducts"\n    outlet="::outlet"\n    inventory-data="::productVariantInventoryByOutletCtrl.inventoryData">\n  </wr-product-variant-table>\n</div>\n',controllerAs:"productVariantInventoryByOutletCtrl",bindToController:!0,controller:["registerManager",function(e){this.$onInit=()=>{const t=e.getActiveOutlet();this.selectedOutlet=f(this.outlets,e=>e.id===t.id)}}]}})),t.module("webregister.directives").directive("wrCustomerGroup",(function(){return{scope:{customer:"="},restrict:"E",template:'<span ng-if="customerGroupCtrl.group"\n      class="wr-customer-group-name">{{customerGroupCtrl.group.name}}</span>',bindToController:!0,controllerAs:"customerGroupCtrl",controller:["$scope","customerManager","vdFeatureManager",function(e,t,n){this._fetchGroup=function(){t.getCustomerGroup(this.customer).then(e=>{this.group=e}).catch(e=>{Qe.warn("[wrCustomerGroup] Failed to lookup customer group",e)})},e.$watch("customerGroupCtrl.customer.customer_group_id",()=>{n.get("customer_groups")&&this._fetchGroup()})}]}}));t.module("webregister.directives").directive("wrCustomerLoyaltyBalance",["saleManager","loyaltyManager",function(e,t){return{scope:{customer:"=",customerBalances:"="},restrict:"E",template:'<span ng-if="customerLoyaltyBalanceCtrl.customer.enable_loyalty" class="wr-customer-loyalty-balance">\n  {{customerLoyaltyBalanceCtrl.calculateCustomerLoyaltyBalance() | vdCurrency}}\n</span>\n<span ng-if="customerLoyaltyBalanceCtrl.customer && !customerLoyaltyBalanceCtrl.customer.enable_loyalty"\n  class="wr-customer-loyalty-balance wr-customer-loyalty-balance--disabled">\n  Disabled\n</span>\n',bindToController:!0,controllerAs:"customerLoyaltyBalanceCtrl",controller(){this.calculateCustomerLoyaltyBalance=function(){const n=e.sale,s=n&&n.customer,a=this.customerBalances&&this.customerBalances.loyalty||0;return s&&s.id===this.customer.id?t.getCustomerLoyaltyBalance(n):a}}}}]);const ns=["address_1","address_2","suburb","city","postcode","state","country_id"],ss=/\b[\w.-]+@[\w.-]+\.\w{2,}\b/,as=/^\s*(?:\+?(\d{1,}))?([-. (]*(\d{1,})[-. )]*)?((\d{1,})[-. ]*(\d{1,})(?:[-.x ]*(\d+))?)\s*$/;t.module("webregister.directives").directive("wrCustomerForm",["retailerSettingsManager","VD_COUNTRY_CODES","vdFeatureManager",function(e,t,n){return{scope:{customer:"=",form:"=",customerGroups:"="},restrict:"E",template:'<vd-tabs model="customerFormCtrl.selectedCustomerTab" class="vd-mb5" data-cy="customer-tab-contact">\n  <vd-tab active="true" value="\'customerContact\'">\n    Contact\n  </vd-tab>\n  <vd-tab value="\'customerDetails\'" value="\'customer-details\'" data-cy="customer-tab-details">\n    Details\n  </vd-tab>\n</vd-tabs>\n\n<div ng-show="customerFormCtrl.selectedCustomerTab === \'customerContact\'">\n  <div ng-include="\'customer/wr-customer-form--contact.html\'"></div>\n</div>\n<div ng-show="customerFormCtrl.selectedCustomerTab === \'customerDetails\'">\n  <div ng-include="\'customer/wr-customer-form--details.html\'"></div>\n</div>\n',bindToController:!0,controllerAs:"customerFormCtrl",require:{form:"^form"},controller:["$scope","$element",function(s,a){const i=ns;this.emailRegex=ss,this.phoneOptions=[{name:"Mobile",value:"mobile"},{name:"Phone",value:"phone"},{name:"Fax",value:"fax"}],this.DOBFormatOptions={maxDate:new Date,format:"ll"},this.DOBOptions=r(r({},this.DOBFormatOptions),{},{yearRange:[1900,(new Date).getFullYear()]}),this.countryOptions=t,this.loyaltyEnabled=e.isLoyaltyEnabled(),this.selectedCustomerTab=null,this.showCustomerGroup=n.get("customer_groups"),this.genderOptions=[{name:"Choose a gender\u2026",value:null},{name:"Man",value:"M"},{name:"Woman",value:"F"},{name:"Non-binary",value:"N"}],this.$onInit=()=>{null==this.customer.do_not_email&&(this.customer.do_not_email=!0),this.customerOptIn=!this.customer.do_not_email,""===this.customer.postal_country_id&&(this.customer.postal_country_id=null),""===this.customer.physical_country_id&&(this.customer.physical_country_id=null),this.customer.gender||(this.customer.gender=this.genderOptions[0].value),this.selectedPhoneOption=this._defaultContactNumber(),this.differentAddresses=this._areAddressesDifferent()},this._defaultContactNumber=()=>{if(!this.customer.mobile){if(this.customer.phone)return this.phoneOptions[1].value;if(this.customer.fax)return this.phoneOptions[2].value}return this.phoneOptions[0].value},this._areAddressesDifferent=()=>i.some(e=>this.customer["postal_"+e]!==this.customer["physical_"+e]),this._matchAddresses=()=>{i.forEach(e=>{this.customer["physical_"+e]=this.customer["postal_"+e]})},this._focusCustomerField=e=>{const t=!this.customer.id&&"customerContact"===this.selectedCustomerTab,n=this.customer.email&&!ss.test(this.customer.email);Je(()=>{if(!t&&n){const e=a[0].querySelector('input[name="email"]');return void(e&&e.focus())}const s=S({element:a[0],elementsToMatch:'input:not([type="checkbox"])',hasNoValue:e&&t});s&&s.focus()})},s.$watch("customerFormCtrl.selectedCustomerTab",(e,t)=>{const n=Boolean(!t);e!==t&&this._focusCustomerField(n)}),s.$watchGroup(i.map(e=>"customerFormCtrl.customer.postal_"+e),()=>{this.differentAddresses||this._matchAddresses()}),this.updateMatchingAddresses=()=>{this.differentAddresses?i.forEach(e=>{this.customer["physical_"+e]=null}):this._matchAddresses()},this.hasMissingContactInfo=()=>Boolean(!this.customer.first_name&&!this.customer.last_name&&!this.customer.company_name)}]}}]);const is=e=>"1111111111"===e.group_id,rs={address:["physical_","postal_"],physical_address:["physical_"],postal_address:["postal_"],custom_fields:["custom_field"]},os=(e,t)=>rs[t]?C(rs[t],t=>C(e,(e,n)=>Boolean(e)&&n.startsWith(t))):Boolean(e[t]);function ls(e,t){return[e[t+"_address_1"],e[t+"_address_2"],e[t+"_suburb"],e[t+"_city"],e[t+"_state"],e[t+"_postcode"],e[t+"_country_id"]].filter(e=>e).join(", ")}const cs=e=>{const t={email:"",mobile:"",firstName:"",lastName:""};if(e.indexOf("@")>-1)t.email=e;else if(e.match(as))t.mobile=e;else{const n=e.match(/[-\w]+/g);n&&(t.firstName=n[0],n.length>1&&(n.shift(),t.lastName=n.join(" ")))}return t};t.module("webregister.directives").directive("wrViewCustomerDetails",(function(){return{scope:{title:"@",customer:"=",fields:"="},restrict:"E",template:'<h3 class="wr-view-customer-details-title">{{viewCustomerDetailsCtrl.title}}</h3>\n<ul>\n  <li ng-if="viewCustomerDetailsCtrl.customerFieldHasValue(field)"\n    ng-repeat="field in ::viewCustomerDetailsCtrl.fields"\n    class="wr-view-customer-details-field">\n    <div class="wr-view-customer-details-field-label">\n      {{::viewCustomerDetailsCtrl.getLabel(field) | vdTitleCase }}\n    </div>\n    <div class="wr-view-customer-details-field-value">\n      <span class="pro-view-customer-details-field-value">\n      {{::viewCustomerDetailsCtrl.getValue(field)}}\n      </span>\n      <vd-flag class="vd-ml1" ng-if="viewCustomerDetailsCtrl.getFlag(field)">{{::viewCustomerDetailsCtrl.getFlag(field)}}</vd-flag>\n    </div>\n  </li>\n</ul>\n',bindToController:!0,controllerAs:"viewCustomerDetailsCtrl",controller:["$element",function(e){this.$onInit=()=>{e.addClass("wr-view-customer-details")},this.customerFieldHasValue=function(e){return os(this.customer,e)},this.getLabel=function(e){return"gender"===e?"Gender":e.replace(/_/g," ")},this.getValue=function(e){let t;switch(e){case"gender":if("M"===this.customer[e])return"Man";if("F"===this.customer[e])return"Woman";if("N"===this.customer[e])return"Non-binary";break;case"date_of_birth":t=Un(this.customer[e],"Do MMMM YYYY");break;case"twitter":t=(n=this.customer[e])&&!n.startsWith("@")?"@"+n:n;break;case"physical_address":t=ls(this.customer,"physical");break;case"postal_address":t=ls(this.customer,"postal");break;default:t=this.customer[e]}var n;return t},this.getFlag=function(e){let t;switch(e){case"email":this.customer.do_not_email&&(t="Do not email");break;default:t=!1}return t}}]}}));t.module("webregister.directives").directive("wrCustomerBalances",(function(){return{scope:{customer:"=",customerBalances:"="},restrict:"E",template:'<div ng-if="customerBalancesCtrl.isStoreCreditEnabled && customerBalancesCtrl.customerBalances.storeCredit === null"\n  class="wr-customer-balances-error-message vd-text--sub">\n  Error fetching some customer data.\n</div>\n\n<ul ng-if="customerBalancesCtrl.customerBalances"\n  class="wr-info-fields wr-info-fields--large wr-info-fields--center vd-mb3">\n  <li class="wr-info-field">\n    <div class="wr-info-field-label">\n      Account Balance\n    </div>\n    <div class="wr-info-field-value pro-customer-balances-amount--account">\n      {{customerBalancesCtrl.customerBalances.account | vdCurrency}}\n    </div>\n  </li>\n\n  <li ng-if="customerBalancesCtrl.loyaltyEnabled" class="wr-info-field">\n    <div class="wr-info-field-label">\n      Loyalty\n    </div>\n    <div class="wr-info-field-value">\n      <wr-customer-loyalty-balance customer="customerBalancesCtrl.customer"\n        customer-balances="customerBalancesCtrl.customerBalances"\n        class="pro-customer-balances-amount--loyalty">\n      </wr-customer-loyalty-balance>\n    </div>\n  </li>\n\n  <li ng-if="customerBalancesCtrl.isStoreCreditEnabled" class="wr-info-field">\n    <div class="wr-info-field-label">\n      Store Credit\n    </div>\n    <div class="wr-info-field-value">\n      <wr-customer-store-credit-balance store-credit="customerBalancesCtrl.customerBalances.storeCredit"\n        class="pro-customer-balances-amount--store-credit">\n      </wr-customer-store-credit-balance>\n    </div>\n  </li>\n</ul>\n',bindToController:!0,controllerAs:"customerBalancesCtrl",controller:["retailerSettingsManager",function(e){this.loyaltyEnabled=e.isLoyaltyEnabled(),this.isStoreCreditEnabled=e.isStoreCreditEnabled()}]}}));t.module("webregister.directives").directive("wrCustomerStoreCreditBalance",(function(){return{scope:{storeCredit:"="},restrict:"E",template:'<span ng-if="customerStoreCreditBalanceCtrl.storeCredit">\n  {{customerStoreCreditBalanceCtrl.determineStoreCreditBalance() | vdCurrency}}\n</span>\n<vd-icon ng-if="customerStoreCreditBalanceCtrl.storeCredit === null"\n  icon="fa-exclamation-triangle"\n  class="wr-customer-balances-error-icon">\n</vd-icon>\n',bindToController:!0,controllerAs:"customerStoreCreditBalanceCtrl",controller:["saleManager","customerBalancesManager",function(e,t){this.determineStoreCreditBalance=function(){const n=e.sale,s=n&&n.customer;let a=0;return this.storeCredit&&(a=this.storeCredit.balance),s&&this.storeCredit&&(a=t.calculateStoreCreditBalance(n)),c.round(a,2,c.ROUNDING_MODES.ROUND_DOWN)}}]}}));var ds;t.module("webregister.directives").directive("wrCustomerStoreCreditHistory",(function(){return{scope:{storeCredit:"="},restrict:"E",template:'<table ng-if="customerStoreCreditHistoryCtrl.storeCredit.store_credit_transactions.length"\n  class="vd-table vd-table--compact">\n  <thead>\n    <tr>\n      <th class="vd-tight vd-no-pad-l">Date</th>\n      <th class="vd-tight">User</th>\n      <th class="vd-tight">Status</th>\n      <th class="vd-tight">Notes</th>\n      <th class="vd-tight vd-align-right">Amount</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr ng-repeat="transaction in customerStoreCreditHistoryCtrl.storeCredit.store_credit_transactions |\n    orderBy: \'-created_at\' |\n    limitTo: 5">\n      <td class="vd-no-pad-l">\n        {{transaction.created_at | wrDateFormat:\'MMM D, YYYY HH:mm\':customerStoreCreditHistoryCtrl.outletTimeZone}}\n      </td>\n      <td>\n        <vd-user-badge\n          ng-if="customerStoreCreditHistoryCtrl.userList"\n          user="customerStoreCreditHistoryCtrl.getUser(transaction.id)" size="x-small">\n        </vd-user-badge>\n      </td>\n      <td>{{transaction.type}}</td>\n      <td>{{transaction.notes ? transaction.notes : \'-\'}}</td>\n      <td class="vd-align-right">\n        {{customerStoreCreditHistoryCtrl.getDisplayStoreCredit(transaction.amount) | vdCurrency}}\n      </td>\n    </tr>\n  </tbody>\n</table>\n<p ng-if="customerStoreCreditHistoryCtrl.storeCredit === null" class="wr-view-customer-no-details">\n  <vd-icon icon="fa-exclamation-triangle" class="wr-customer-balances-error-icon vd-mr3"></vd-icon>\n  <span>There was an error retrieving store credit transactions.</span>\n</p>\n\n<p ng-if="customerStoreCreditHistoryCtrl.storeCredit !== null &&\n  !customerStoreCreditHistoryCtrl.storeCredit.store_credit_transactions.length"\n  class="wr-view-customer-no-details">\n  There are no recent store credit transactions.\n</p>\n',bindToController:!0,controllerAs:"customerStoreCreditHistoryCtrl",controller:["$scope","registerManager","userManager",function(e,t,n){const s=t.getActiveOutlet();this.outletTimeZone=s&&s.time_zone,this.getDisplayStoreCredit=function(e){return c.round(e,2,c.ROUNDING_MODES.ROUND_DOWN)},this._getAllUsers=()=>{this.storeCredit&&n.hydrateUsers(this.storeCredit.store_credit_transactions).then(e=>{this.userList=e})},this.getUser=e=>{const t=g(this.userList,{id:e});return t&&t.user},e.$watch("customerStoreCreditHistoryCtrl.storeCredit",()=>this._getAllUsers())}]}})),t.module("webregister.directives").directive("wrCustomerAddress",(function(){return{scope:{customer:"="},template:"{{wrCustomerAddressCtrl.getCustomerAddress()}}",controllerAs:"wrCustomerAddressCtrl",bindToController:!0,controller(){this.getCustomerAddress=function(){if(this.customer)return os(this.customer,"postal_address")?ls(this.customer,"postal"):ls(this.customer,"physical")}}}})),function(e){e.CLOSING_CASH_FLOAT="Closing float",e.OPENING_CASH_FLOAT="Opening float",e.CASH_IN="Cash in",e.CASH_OUT="Cash out",e.PETTY_CASH_IN="Petty cash in",e.PETTY_CASH_OUT="Petty cash out",e.FLOAT_ADJUSTMENT="Float adjustment",e.TILL_DISCREPANCY="Till discrepancy"}(ds||(ds={}));var us=ds;let hs;!function(e){e[e.CASH=1]="CASH",e[e.CHEQUE=2]="CHEQUE",e[e.CREDIT_CARD=3]="CREDIT_CARD",e[e.OTHER_PAYMENT_METHOD=3]="OTHER_PAYMENT_METHOD",e[e.EFTPOS=4]="EFTPOS",e[e.FINANCE=9]="FINANCE",e[e.VOUCHER=10]="VOUCHER",e[e.CREDIT_NOTE=11]="CREDIT_NOTE",e[e.CASH_CONCEALED=101]="CASH_CONCEALED",e[e.LOYALTY=106]="LOYALTY",e[e.XERO=107]="XERO",e[e.TYRO=108]="TYRO",e[e.GIFT_CARD=118]="GIFT_CARD",e[e.STORE_CREDIT=121]="STORE_CREDIT",e[e.ROUNDING=122]="ROUNDING",e[e.CURRENCY_ADJUST=126]="CURRENCY_ADJUST",e[e.CURRENCY=127]="CURRENCY",e[e.WORLDPAY=130]="WORLDPAY",e[e.AFTER_PAY=132]="AFTER_PAY",e[e.PAYJUNCTION=138]="PAYJUNCTION",e[e.KLARNA=139]="KLARNA",e[e.BIGCOMMERCE_GIFT_CERT=161]="BIGCOMMERCE_GIFT_CERT"}(hs||(hs={}));const ms=[hs.CASH,hs.GIFT_CARD,hs.LOYALTY,hs.STORE_CREDIT],gs=[hs.CURRENCY_ADJUST];var ps;!function(e){e.TIP="TIP",e.SALE="SALE"}(ps||(ps={}));const vs=["aid","application_label","cryptogram"],ys=({receiptStatus:e,transaction:t})=>{const n=t.tenders[0];return`\n        <div class="vd-text-signpost">\n          ${e}\n        </div>\n        ${function(){const e=[`<li>TRANSACTION ID: ${n.external_transaction_id}</li>`];return vs.forEach(t=>{const s=n.emv[t];void 0!==s&&e.push(`<li>${t.replace("_"," ").toUpperCase()}: ${s}</li>`)}),`<ul class="vd-align-left">${e.join("")}</ul>`}()}\n        ${"DECLINED"!==e?"":`<ul class="vd-align-left">${n.emv.tags.map(e=>`<li>${e.key}: ${e.value}</li>`).join("")}</ul>`}\n        `},fs=({payments:e=[],paymentTypeId:t})=>e.filter(e=>e.paymentType.type_id===t),Ss=({payments:e=[],paymentTypeId:t})=>e.some(e=>e.paymentType.type_id===t),Cs=({payments:e=[],paymentTypeId:t})=>e.some(e=>e.paymentType.type_id!==t),bs=e=>{const t=e.paymentType;switch(t.type_id){case hs.CASH:return Boolean(t.config&&t.config.conceal_cash_totals);case hs.CASH_CONCEALED:return!0}return!1},_s=e=>ms.includes(e),ws=[hs.GIFT_CARD,hs.STORE_CREDIT,hs.LOYALTY,hs.ROUNDING,hs.CURRENCY_ADJUST,hs.AFTER_PAY,hs.KLARNA,hs.BIGCOMMERCE_GIFT_CERT],Ms=e=>ws.includes(e.paymentType.type_id),Ts=(e,t)=>!e.disabled&&(!e.outlet_ids||-1!==e.outlet_ids.indexOf(t)),Es=e=>{const t=e.config,n=t&&t.url;return n&&n.startsWith("https://econduitapp.com")},ks=e=>{var t,n;return Es(e)&&(null===(t=e.payment_type)||void 0===t?void 0:t.id)!==hs.PAYJUNCTION&&(null===(n=e.payment_type)||void 0===n?void 0:n.id)!==hs.OTHER_PAYMENT_METHOD};function Is(e,n,s,a,i,r){return{scope:{registerClosure:"=",editable:"=",closeRegister:"&"},restrict:"E",template:'<table class="vd-table vd-table--compact vd-table--expandable wr-closure-summary-table">\n  <thead>\n    <tr>\n      <th>Payment Types</th>\n      <th class="wr-closure-summary-table-column vd-align-right">\n        Expected (<wr-currency-symbol></wr-currency-symbol>)\n      </th>\n      <th class="wr-closure-summary-table-column vd-align-right">\n        Counted (<wr-currency-symbol></wr-currency-symbol>)\n      </th>\n      <th class="wr-closure-summary-table-column vd-align-right">\n        Differences (<wr-currency-symbol></wr-currency-symbol>)\n      </th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr ng-repeat-start="payment in registerClosureSummaryTableCtrl.filteredPayments track by $index"\n      ng-click="registerClosureSummaryTableCtrl.toggleRowClick($event, payment)"\n      class="wr-closure-summary-table-row vd-expandable"\n      ng-class="{\n        \'vd-expandable--nt\': !registerClosureSummaryTableCtrl.paymentManager.isCashManagementPaymentType(payment),\n        \'vd-expandable--expanded\': registerClosureSummaryTableCtrl.paymentManager.isCashManagementPaymentType(payment),\n        \'wr-closure-summary-table-row--last\': $last\n      }"\n        >\n      <td>\n\n        \x3c!--Payment type name--\x3e\n        <div ng-if="!registerClosureSummaryTableCtrl.paymentManager.isCashManagementPaymentType(payment)">\n          {{payment.payment_type_name}}\n        </div>\n        <div ng-if="registerClosureSummaryTableCtrl.paymentManager.isCashManagementPaymentType(payment)"\n          class="wr-cash-management-row-title">\n          <div class="vd-pr1">{{payment.payment_type_name}}</div>\n          <div class="wr-cash-management-row-title vd-text--sub vd-text--secondary">\n            <div class="vd-pr1">View Cash Payments, Floats and Movements</div>\n            <vd-flag ng-if="!registerClosureSummaryTableCtrl.isCashFloatSet && registerClosureSummaryTableCtrl.editable"\n              category="negative">\n              NO FLOAT SET\n            </vd-flag>\n          </div>\n        </div>\n      </td>\n\n      \x3c!--Expected section--\x3e\n      <td class="vd-align-right wr-closure-summary-table-expected-field">\n        {{registerClosureSummaryTableCtrl.registerClosureManager.determineExpectedPaymentTotal(payment,\n          registerClosureSummaryTableCtrl.registerClosure)}}\n      </td>\n\n      \x3c!--Counted section--\x3e\n      <td class="vd-align-right wr-closure-summary-table-counted-field">\n        <div class="wr-closure-summary-table-input-field">\n\n          \x3c!-- Input for non cash management payment types --\x3e\n          <input ng-if="registerClosureSummaryTableCtrl.editable &&\n            !registerClosureSummaryTableCtrl.isReadOnlyPaymentType(payment) &&\n            !registerClosureSummaryTableCtrl.paymentManager.isCashManagementPaymentType(payment)"\n            type="text"\n            ng-keypress="registerClosureSummaryTableCtrl.keyPressHandler($event)"\n            class="vd-input wr-closure-summary-table-input"\n            name="counted"\n            ng-model="payment.totalCounted"\n            ng-change="registerClosureSummaryTableCtrl.determineSummaryTotals()"\n            vd-number\n            vd-number-options="{ allowEmpty: true }"\n            placeholder="Enter amount"\n            ng-required="true"\n            inputmode="decimal">\n\n          \x3c!-- Input for cash management payment type --\x3e\n          <input type="text"\n            ng-if="registerClosureSummaryTableCtrl.editable &&\n              !registerClosureSummaryTableCtrl.isReadOnlyPaymentType(payment) &&\n              registerClosureSummaryTableCtrl.paymentManager.isCashManagementPaymentType(payment)"\n            ng-keypress="registerClosureSummaryTableCtrl.keyPressHandler($event)"\n            class="vd-input wr-closure-summary-table-input"\n            name="counted"\n            ng-model="registerClosureSummaryTableCtrl.registerClosure.countedCashInDrawer"\n            ng-change="registerClosureSummaryTableCtrl.setTotalCountedForCashManagementPaymentType()"\n            placeholder="Enter amount"\n            vd-number\n            vd-number-options="{ allowEmpty: true }"\n            ng-required="true"\n            inputmode="decimal">\n\n          <div ng-if="registerClosureSummaryTableCtrl.editable &&\n            registerClosureSummaryTableCtrl.isReadOnlyPaymentType(payment)"\n            class="wr-closure-summary-table-counted-read-only">\n            {{payment.totalCounted | displayRound}}\n          </div>\n          <vd-icon icon="fa fa-exclamation-triangle" class="wr-closure-summary-table-field-error-icon vd-mr3"></vd-icon>\n        </div>\n\n        \x3c!--Non editable counted section--\x3e\n        <div ng-if="!registerClosureSummaryTableCtrl.editable">\n          <div ng-if="registerClosureSummaryTableCtrl.paymentManager.isCashManagementPaymentType(payment)">\n            {{registerClosureSummaryTableCtrl.registerClosure.countedCashInDrawer | displayRound}}\n          </div>\n          <div ng-if="!registerClosureSummaryTableCtrl.paymentManager.isCashManagementPaymentType(payment)">\n            {{payment.totalCounted | displayRound}}\n          </div>\n        </div>\n      </td>\n      <td class="vd-align-right wr-closure-summary-table-differences-field">\n        <span ng-if="!registerClosureSummaryTableCtrl.isCashConcealedPaymentType(payment)">\n          <wr-coloured-number ng-if="registerClosureSummaryTableCtrl.paymentManager.isCashManagementPaymentType(payment)"\n            number="registerClosureSummaryTableCtrl.registerClosureManager.differenceBetweenExpectedAndCounted(\n              registerClosureSummaryTableCtrl.registerClosure.cashDrawerTotals.cashDrawerBalance,\n              registerClosureSummaryTableCtrl.registerClosure.countedCashInDrawer)">\n          </wr-coloured-number>\n          <wr-coloured-number ng-if="!registerClosureSummaryTableCtrl.paymentManager.isCashManagementPaymentType(payment)"\n            number="registerClosureSummaryTableCtrl.registerClosureManager.differenceBetweenExpectedAndCounted(payment.total, payment.totalCounted)">\n          </wr-coloured-number>\n        </span>\n        <span ng-if="registerClosureSummaryTableCtrl.isCashConcealedPaymentType(payment)">-</span>\n      </td>\n    </tr>\n    <tr ng-repeat-end>\n      <td class="vd-table-nested-report-container" colspan="4">\n\n        \x3c!--Cash movement expanded section--\x3e\n        <table class="vd-table">\n          <tbody>\n\n            \x3c!--When a float is not set--\x3e\n            <tr ng-if="!registerClosureSummaryTableCtrl.isCashFloatSet">\n              <td ng-if="registerClosureSummaryTableCtrl.editable" colspan="4">\n                <wr-cash-float-not-set class="vd-text--negative"\n                  on-cash-float-set="registerClosureSummaryTableCtrl.updateCashMovementsAndTotals()">\n                </wr-cash-float-not-set>\n              </td>\n\n              <td ng-if="!registerClosureSummaryTableCtrl.editable" colspan="100%">\n                <div vd-flex vd-flex-justify="between">\n                  <div>Cash Movements</div>\n                  <div class="wr-cash-mangement-table-total-expected vd-text--secondary vd-text--sub">\n                    Opening Float not set.\n                  </div>\n                </div>\n              </td>\n            </tr>\n\n            \x3c!--When a float has been set--\x3e\n            <tr ng-if="registerClosureSummaryTableCtrl.isCashFloatSet">\n              <td class="vd-tight vd-valign-t">\n                <div class="wr-cash-management-table-title">Cash Movements</div>\n              </td>\n              <td>\n\n                \x3c!--Nested tables containing the cash movements--\x3e\n                <table class="vd-table wr-cash-management-table-container">\n                  <thead>\n                    <tr>\n                      <th class="vd-no-pad-l">Time</th>\n                      <th>User</th>\n                      <th class="vd-no-pad-l vd-no-pad-r vd-align-right">\n                        Amount (<wr-currency-symbol></wr-currency-symbol>)\n                      </th>\n                      <th class="vd-no-pad-r">Reason</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    <tr ng-repeat="cashMovement in registerClosureSummaryTableCtrl.registerClosure.cashMovements |\n                      orderBy: \'date\' track by $index">\n                      <td class="vd-no-pad-l">\n                        {{cashMovement.date | wrDateFormat:\'h:mma\':registerClosureSummaryTableCtrl.outletTimeZone}}\n                      </td>\n                      <td class="wr-cash-management-table-user">{{cashMovement.user | wrUserName}}</td>\n                      <td class="vd-no-pad-l vd-no-pad-r vd-align-right">\n                        <span ng-if="cashMovement.type === registerClosureSummaryTableCtrl.openingCashFloatType">\n                          {{cashMovement.amount | displayRound}}\n                        </span>\n                        <wr-coloured-number number="cashMovement.amount | displayRound"\n                          ng-if="cashMovement.type !== registerClosureSummaryTableCtrl.openingCashFloatType"\n                          class="cash-type--{{ccashMovement.type}}">\n                        </wr-coloured-number>\n                      </td>\n                      <td class="vd-no-pad-r wr-cash-management-table-reason">\n                        <div class="wr-movement-reason">\n                          <span class="wr-movement-reason-type">{{cashMovement.type}}</span>\n                          <span class="wr-movement-reason-note vd-hide-print">{{cashMovement.note}}</span>\n                        </div>\n                      </td>\n                    </tr>\n                  </tbody>\n                </table>\n              </td>\n            </tr>\n\n            \x3c!--Cash movement totals--\x3e\n            <tr>\n              <td colspan="100%">\n                <div vd-flex vd-flex-justify="between">\n                  <div>Cash Payments Received</div>\n                  <div class="wr-cash-mangement-table-total-expected">\n                    {{registerClosureSummaryTableCtrl.registerClosure.cashDrawerTotals.cash_sales_total | displayRound}}\n                  </div>\n                </div>\n              </td>\n            </tr>\n            <tr ng-if="!registerClosureSummaryTableCtrl.editable">\n              <td colspan="100%">\n                <div vd-flex vd-flex-justify="between">\n                  <div>Closing Float</div>\n                  <div ng-if="registerClosureSummaryTableCtrl.isCashFloatSet"\n                    class="wr-cash-mangement-table-total-counted">\n                    {{registerClosureSummaryTableCtrl.registerClosureManager.calculateClosingFloat(\n                      registerClosureSummaryTableCtrl.registerClosure.openingCashFloat,\n                      registerClosureSummaryTableCtrl.registerClosure.countedCashInDrawer)}}\n                  </div>\n                  <div ng-if="!registerClosureSummaryTableCtrl.isCashFloatSet"\n                    class="wr-cash-mangement-table-total-expected vd-text--secondary vd-text--sub">\n                    Cash Float not set.\n                  </div>\n                </div>\n              </td>\n            </tr>\n            <tr ng-if="!registerClosureSummaryTableCtrl.editable">\n              <td colspan="100%">\n                <div vd-flex vd-flex-justify="between">\n                  <div><strong>Cash to Bank</strong></div>\n                  <div class="wr-cash-mangement-table-total-counted">\n                    <strong>\n                      {{registerClosureSummaryTableCtrl.registerClosureManager.calculateCashToBank(\n                        registerClosureSummaryTableCtrl.registerClosure.openingCashFloat,\n                        registerClosureSummaryTableCtrl.registerClosure.countedCashInDrawer)}}\n                    </strong>\n                  </div>\n                </div>\n              </td>\n            </tr>\n          </tbody>\n        </table>\n      </td>\n    </tr>\n  </tbody>\n  <tfoot>\n    <tr class="wr-closure-summary-totals">\n      <td>\n        <div>Totals</div>\n      </td>\n      <td class="vd-align-right" data-cy="expected-totals">{{registerClosureSummaryTableCtrl.summaryTotals.expectedTotal}}</td>\n      <td class="vd-align-right">\n\n        \x3c!-- wr-closure-summary-table-counted-read-only adds additional padding on the right so the counted total\n        will align with the input counted amount in the table above --\x3e\n        <div ng-class="{\'wr-closure-summary-table-counted-read-only\' : registerClosureSummaryTableCtrl.editable}" data-cy="counted-totals">\n          {{registerClosureSummaryTableCtrl.summaryTotals.countedTotal}}\n        </div>\n      </td>\n      <td class="vd-align-right" data-cy="differences-totals" >{{registerClosureSummaryTableCtrl.summaryTotals.differenceTotal}}</td>\n    </tr>\n  </tfoot>\n</table>\n',controllerAs:"registerClosureSummaryTableCtrl",bindToController:!0,controller(){this.paymentManager=s,this.isCashConcealedPaymentType=bs,this.isReadOnlyPaymentType=Ms,this.registerClosureManager=a,this.summaryTotals={},this.hasCashConcealedPaymentType=!1,this.setTotalCountedForCashManagementPaymentType=function(){if(this.registerClosure.countedCashInDrawer){const{countedCashInDrawer:e}=this.registerClosure,{cashDrawerBalance:t,cash_sales_total:n}=this.registerClosure.cashDrawerTotals;if(0!==c.vn(e).cmp(t)){const s=this.registerClosureManager.differenceBetweenExpectedAndCounted(t,e);this.cashManagementPayment.totalCounted=c.round(c.add(n,s),2)}else this.cashManagementPayment.totalCounted=c.round(n,2);Qe.debug("[REGISTER CLOSURE SUMMARY TABLE] Total Cash Counted: "+this.cashManagementPayment.totalCounted)}this.determineSummaryTotals()},this.keyPressHandler=function(e){const t=e.keyCode;this.summaryTotals.countedValid&&13===t&&(e.preventDefault(),i.closeRegisterConfirmation().then(()=>this.closeRegister()))},this.updateCashMovementsAndTotals=function(){We.all({cashMovements:e.getCashMovements(),cashDrawerTotals:e.getCashDrawerTotals()}).then(e=>{this.registerClosure.cashMovements=e.cashMovements,this.registerClosure.cashDrawerTotals=e.cashDrawerTotals,this._prepareCashDrawerSummaryForCashManagement()})},this.toggleRowClick=(e,n)=>{this.paymentManager.isCashManagementPaymentType(n)&&(t.element(e.target).hasClass("vd-input")||t.element(e.currentTarget).toggleClass("vd-expandable--expanded"))},this.determineSummaryTotals=function(){this.summaryTotals=a.determineSummaryTotals(this.registerClosure,this.hasCashConcealedPaymentType)},this._defaultPaymentTotalCounted=function(e){e.isSystemPaymentType||Ms(e)?e.totalCounted=e.total:t.isUndefined(e.totalCounted)&&0===parseFloat(e.total)&&(e.totalCounted="0")},this._prepareCashDrawerSummaryForCashManagement=function(){const t=g(this.registerClosure.cashMovements,{type:us.OPENING_CASH_FLOAT});this.isCashFloatSet=Boolean(t),this.registerClosure.openingCashFloat=t&&t.amount||0,this.cashManagementPaymentTypeId=e.getCashManagementPaymentTypeId(),this.cashManagementPayment=g(this.registerClosure.payments,{payment_type_id:this.cashManagementPaymentTypeId})},this._filterPayments=function(e,t){return e.filter(e=>e.total>0||Ts(e.paymentType,t))},this.$onInit=function(){const t=n.getActiveOutlet();this.isCashManagementEnabled=e.isCashManagementEnabled(),this.openingCashFloatType=us.OPENING_CASH_FLOAT,this.outletTimeZone=t&&t.time_zone,this.isCashManagementEnabled&&this._prepareCashDrawerSummaryForCashManagement(),C(this.registerClosure.payments,e=>{if(bs(e))return this.hasCashConcealedPaymentType=!0,!0}),b(this.registerClosure.payments,e=>this._defaultPaymentTotalCounted(e)),this.determineSummaryTotals(),r.get("payment_type_controls")?this.filteredPayments=this._filterPayments(this.registerClosure.payments,t.id):this.filteredPayments=this.registerClosure.payments}}}}Is.$inject=["cashMovementsManager","registerManager","paymentManager","registerClosureManager","registerModals","vdFeatureManager"],t.module("webregister.directives").directive("wrRegisterClosureSummaryTable",Is);t.module("webregister.directives").directive("wrRegisterClosureForm",(function(){return{scope:{registerClosure:"="},restrict:"E",template:'<form novalidate name="closureSummaryForm">\n  <div class="wr-register-closure-info-section">\n    <h2 class="vd-header vd-header--settings">Payments Summary</h2>\n    <div class="vd-g-row">\n      <div class="vd-g-col vd-g-s-12 vd-g-m-3 vd-grid-settings-item">\n        <p class="vd-p">\n          Balance your register by entering the amount counted from the till and other payment terminals into the empty fields here.\n        </p>\n      </div>\n      <div class="vd-g-col vd-g-s-12 vd-g-m-9">\n        <wr-register-closure-summary-table register-closure="registerClosureFormCtrl.registerClosure"\n          close-register="registerClosureFormCtrl.closeRegister(closureSummaryForm)"\n          editable="true">\n        </wr-register-closure-summary-table>\n      </div>\n    </div>\n\n    <hr class="vd-hr" />\n\n    <div class="vd-g-row">\n      <div class="vd-g-col vd-g-s-12 vd-g-m-3">\n        <h2 class="vd-header vd-header--settings">Closing Summary</h2>\n      </div>\n      <div class="vd-g-col vd-g-s-12 vd-g-m-9">\n        <register-closure-summary-notes register-closure="registerClosureFormCtrl.registerClosure" editable="true"></register-closure-summary-notes>\n        <button class="vd-btn vd-btn--do vd-btn--jumbo vd-mt10 wr-closure-summary-form-close-register-button"\n          type="submit"\n          ng-click="registerClosureFormCtrl.closeRegister(closureSummaryForm)"\n          ng-disabled="registerClosureFormCtrl.closingRegister">\n          <span ng-if="!registerClosureFormCtrl.closingRegister">\n            Close Register\n          </span>\n          <span ng-if="registerClosureFormCtrl.closingRegister">\n            Closing Register <span class="vd-loader vd-loader--small"></span>\n          </span>\n        </button>\n      </div>\n    </div>\n</form>\n',controllerAs:"registerClosureFormCtrl",bindToController:!0,controller:["$scope","registerClosureManager","vdToastNotificationService","saleManager","saleModals",function(e,t,n,s,a){this._doCloseRegister=function(){return this.closingRegister=!0,t.closeRegister(this.registerClosure).catch(()=>{this.closingRegister=!1}).then(()=>et.go(zt))},this.closeRegister=function(e){return s.hasActiveSale()?s.actionExistingSaleIfRequired({context:a.CONTEXTS.CLOSE_REGISTER}):e.$valid?this._doCloseRegister():n.negative({message:"Please enter the amount for the highlighted fields."})},e.$watch("registerClosureFormCtrl.registerClosure",(function(e){t.saveRegisterClosure(e)}),!0)}]}}));t.module("webregister.directives").directive("wrPrintRegisterClosure",(function(){return{scope:{data:"="},template:'<vd-header>Register closure summary</vd-header>\n<wr-info-field label="\'Current User\'" value="wrPrintRegisterClosureCtrl.user | wrUserName"></wr-info-field>\n\n<register-closure-info\n  register-closure="::wrPrintRegisterClosureCtrl.data.registerClosure">\n</register-closure-info>\n\n\x3c!--Register closure payments--\x3e\n<div class="wr-register-closure-print-container">\n  <div class="wr-register-closure-print-heading">\n    <div>Payment Types</div>\n    <div class="wr-register-closure-print-values-container">\n      <div class="wr-register-closure-print-value">Expected</div>\n      <div class="wr-register-closure-print-value">Counted</div>\n    </div>\n  </div>\n  <div class="wr-register-closure-print-payments-container">\n    <div ng-repeat-start="payment in wrPrintRegisterClosureCtrl.data.registerClosure.payments"\n      vd-flex\n      vd-flex-justify="between"\n      class="vd-pt1">\n      <div class="wr-register-closure-print-payment-type">\n        <vd-icon icon="fa fa-circle" class="wr-register-closure-print-bullet-icon"></vd-icon>\n        <span>{{payment.payment_type_name}}</span>\n      </div>\n      <div class="wr-register-closure-print-values-container">\n        <div class="wr-register-closure-print-value">{{payment.expectedPaymentTotal}}</div>\n        <div class="wr-register-closure-print-value">{{payment.countedPaymentTotal | displayRound}}</div>\n      </div>\n    </div>\n    <div ng-repeat-end>\n\n      \x3c!--Cash movements section--\x3e\n      <div ng-if="wrPrintRegisterClosureCtrl.data.isCashManagementEnabled && payment.isCashManagementPaymentType"\n        class="wr-register-closure-print-movements-totals">\n        <div vd-flex vd-flex-justify="between">\n          <div>Cash Movements</div>\n          <div class="wr-register-closure-print-values-container wr-register-closure-print-values-container--left">\n            <div class="wr-register-closure-print-value">\n              {{wrPrintRegisterClosureCtrl.data.cashManagement.isCashFloatSet ? \'\' : \'Not Set\'}}\n            </div>\n          </div>\n        </div>\n\n        \x3c!--Cash movements--\x3e\n        <div ng-if="wrPrintRegisterClosureCtrl.data.cashManagement.isCashFloatSet"\n          class="wr-register-closure-print-movements-container">\n          <div class="wr-register-closure-print-heading">\n            <div>User</div>\n            <div class="wr-register-closure-print-values-container">\n              <div class="wr-register-closure-print-value">Amount</div>\n              <div class="wr-register-closure-print-value wr-register-closure-print-value--text">Type</div>\n            </div>\n          </div>\n          <div class="wr-register-closure-print-movements">\n            <div ng-repeat="cashMovement in wrPrintRegisterClosureCtrl.data.registerClosure.cashMovements"\n              vd-flex\n              vd-flex-justify="between"\n              class="wr-register-closure-print-movement">\n              <div>{{cashMovement.user | wrUserName}}</div>\n              <div class="wr-register-closure-print-values-container">\n                <div class="wr-register-closure-print-value">{{cashMovement.amount | displayRound}}</div>\n                <div class="wr-register-closure-print-value wr-register-closure-print-value--text">\n                  {{cashMovement.type}}\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        \x3c!--Cash movement totals--\x3e\n        <div vd-flex vd-flex-justify="between" class="vd-pt1">\n          <div>Cash Payments Received</div>\n          <div class="wr-register-closure-print-values-container wr-register-closure-print-values-container--left">\n            <div class="wr-register-closure-print-value">\n              {{wrPrintRegisterClosureCtrl.data.registerClosure.cashDrawerTotals.cash_sales_total | displayRound}}\n            </div>\n          </div>\n        </div>\n        <div vd-flex vd-flex-justify="between" class="vd-pt1">\n          <div>Closing Float</div>\n          <div class="wr-register-closure-print-values-container wr-register-closure-print-values-container--left">\n            <div class="wr-register-closure-print-value">\n              {{wrPrintRegisterClosureCtrl.data.cashManagement.isCashFloatSet ?\n                wrPrintRegisterClosureCtrl.data.cashManagement.closingFloat : \'Not Set\'}}\n            </div>\n          </div>\n        </div>\n        <div vd-flex vd-flex-justify="between" class="vd-pt1 wr-register-closure-print-cash-to-bank">\n          <div>Cash to Bank</div>\n          <div class="wr-register-closure-print-values-container wr-register-closure-print-values-container--right">\n            <div class="wr-register-closure-print-value">\n              {{wrPrintRegisterClosureCtrl.data.cashManagement.cashToBank}}\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="wr-register-closure-print-heading">\n    <div class="wr-register-closure-print-totals-title">Totals</div>\n    <div class="wr-register-closure-print-values-container">\n      <div class="wr-register-closure-print-value">{{wrPrintRegisterClosureCtrl.data.summaryTotals.expectedTotal}}</div>\n      <div class="wr-register-closure-print-value">{{wrPrintRegisterClosureCtrl.data.summaryTotals.countedTotal}}</div>\n    </div>\n  </div>\n  <div ng-if="wrPrintRegisterClosureCtrl.data.registerClosure.note" class="vd-pt3">\n    <div class="wr-info-field-label">Note</div>\n    <div class="wr-info-field-value">{{wrPrintRegisterClosureCtrl.data.registerClosure.note}}</div>\n  </div>\n</div>\n',controllerAs:"wrPrintRegisterClosureCtrl",bindToController:!0,controller:["userManager",function(e){this.user=e.getLoggedInUser()}]}}));const Ps="noInventory",Rs="invalidCharacters",As="invalidMin",Ds="invalidMax";t.module("webregister.directives").directive("lineItem",(function(){return{require:"^form",scope:{lineItem:"="},restrict:"E",replace:!0,template:'<ul class="li-cell"\n  data-line-item-id="{{lineItemCtrl.lineItem.localId}}"\n  data-adjusted="{{lineItemCtrl.lineItem.adjusted}}">\n\n  <line-item-display line-item="lineItemCtrl.lineItem"\n    has-invalid-input="lineItemCtrl.hasInvalidInput()"\n    is-marked-as-unfulfilled="lineItemCtrl.isMarkedAsUnfulfilled()"\n    on-key-press="lineItemCtrl.handleLineItemKeypress"\n    on-remove="lineItemCtrl.remove"\n    on-toggle="lineItemCtrl.toggleLineItem"\n  ></line-item-display>\n\n  <li class="li-cell-actions-container">\n    <div ng-if="lineItemCtrl.lineItem.calculating"\n      class="li-cell-actions-container-section">\n      <div class="wr-media wr-media--center li-cell-actions--calculating">\n        <span class="vd-loader vd-loader--small wr-media-object"></span>\n        <div class="wr-media-body vd-text--secondary">Loading product information</div>\n      </div>\n    </div>\n\n    <div ng-if="!lineItemCtrl.lineItem.calculating"\n      class="li-cell-actions-container-section">\n      <div vd-flex>\n        <div class="li-cell-actions">\n          <line-item-quantity line-item="lineItemCtrl.lineItem"\n            on-error="lineItemCtrl.onQuantityError"\n            ref="lineItemCtrl.setQuantityRef">\n        </div>\n        <div class="li-cell-actions">\n          <line-item-display-price line-item="lineItemCtrl.lineItem"\n            on-error="lineItemCtrl.onPriceError"\n            ref="lineItemCtrl.setPriceRef"></line-item-display-price>\n        </div>\n        <div ng-if="!lineItemCtrl.lineItem.isPriceMarkedUp()" class="li-cell-actions pro-line-item-discount">\n          <line-item-discount-percent line-item="lineItemCtrl.lineItem"\n            on-error="lineItemCtrl.onDiscountError"></line-item-discount-percent>\n        </div>\n        <div ng-if="lineItemCtrl.lineItem.isPriceMarkedUp()" class="li-cell-actions pro-line-item-markup">\n          <line-item-markup-percent line-item="lineItemCtrl.lineItem"></line-item-markup-percent>\n        </div>\n      </div>\n\n      <div data-cy="no-permission-return"\n        ng-if="!lineItemCtrl.isMarkedAsUnfulfilled() && lineItemCtrl.isInvalidMinQuantity() && !lineItemCtrl.hasReturnPermission()">\n        <div class="wr-input-messages wr-media wr-media--center">\n          <vd-icon icon="fa-exclamation-triangle" class="wr-media-object"></vd-icon>\n          <div class="wr-media-body">\n            You don\'t have permission to process a return.\n          </div>\n        </div>\n      </div>\n\n      <div ng-if="lineItemCtrl.isInvalidMinQuantity() && lineItemCtrl.isMarkedAsUnfulfilled()" data-cy="unfulfilled-sale-negative-quantity-warning">\n        <div class="wr-input-messages wr-media wr-media--center">\n          <vd-icon icon="fa-exclamation-triangle" class="wr-media-object"></vd-icon>\n          <div class="wr-media-body">\n            You cannot have negative quantities for unfulfilled sales.\n          </div>\n        </div>\n      </div>\n\n      <div ng-if="lineItemCtrl.isInvalidDigitLength()">\n        <div class="wr-input-messages wr-media wr-media--center">\n          <vd-icon icon="fa-exclamation-triangle" class="wr-media-object"></vd-icon>\n          <div class="wr-media-body">\n            Quantity can\'t be greater than 10 digits.\n          </div>\n        </div>\n      </div>\n\n      <div ng-if="lineItemCtrl.isLowStock()" data-cy="low-stock-warning">\n        <div class="wr-input-messages wr-media wr-media--center">\n          <vd-icon icon="fa-exclamation-triangle" class="wr-media-object"></vd-icon>\n          <div class="wr-media-body">\n            You only have {{lineItemCtrl.getInventoryLevel()}} available.\n            <a href="javascript:void(0)"\n              ng-click="lineItemCtrl.continueWithLowStock()"\n              class="vd-link--secondary"\n              data-cy="ignore-low-stock-warning">\n              Continue anyway?\n            </a>\n          </div>\n        </div>\n      </div>\n\n      <div class="vd-pb1 vd-pt1">\n        <line-item-note confirmed="lineItemCtrl.lineItem.confirmed"\n          note="lineItemCtrl.lineItem.note"\n          on-blur="lineItemCtrl.onNoteBlur"\n          on-change="lineItemCtrl.onNoteChange"></line-item-note>\n      </div>\n\n      <div class="li-cell-actions-container-info vd-pt1 vd-text-supplementary">\n        <div ng-if="lineItemCtrl.lineItem.confirmed">\n          <vd-icon icon="fa fa-lock"></vd-icon>\n          <span class="vd-ml1 li-cell-actions-locked-info">\n            <span>This can\u2019t be edited.</span>\n            <a class="vd-link vd-link--secondary"\n              target="_blank"\n              href="https://support.vendhq.com/hc/en-us/articles/115002616607">\n              Why?\n            </a>\n          </span>\n        </div>\n        <a href="javascript:void(0)" class="vd-text-supplementary wr-li-view-product-info vd-link" ng-click="lineItemCtrl.showInfo()">\n          <vd-icon icon="fa fa-info-circle"></vd-icon>\n          <span class="vd-ml1">Show Inventory & Details</span>\n        </a>\n      </div>\n    </div>\n  </li>\n</ul>\n',controllerAs:"lineItemCtrl",bindToController:!0,link(e,t,n,s){e.formCtrl=s},controller:["$scope","$element","productModals","userManager","vdTracking","saleInventoryData","saleManager","registerManager",function(e,n,s,a,i,r,o,l){const c=l.getActiveOutlet();this.saleInventoryData=r,this.outletTimeZone=c&&c.time_zone;const d={discount:null,price:null,quantity:null};let u,h,m=!1;this.$onInit=()=>{u=this.lineItem.isReturn,h=!this.lineItem.confirmed},this.remove=()=>{for(const t of Object.keys(d)){const n=d[t];n&&e.formCtrl.$setValidity(n,!0)}m=!0,e.$emit("sale:remove-line-item",this.lineItem)},this.hasInvalidInput=()=>{if(!e.formCtrl)return!1;return d.discount||d.price||d.quantity},this.isMarkedAsUnfulfilled=()=>o.sale.isMarkedAsUnfulfilled(),this.isInvalidMinQuantity=function(){return!this.lineItem.confirmed&&d.quantity===As},this.isInvalidDigitLength=function(){return d.quantity===Ds||d.quantity===As&&this.hasReturnPermission()&&!this.isMarkedAsUnfulfilled()},this.hasReturnPermission=function(){return a.hasPermission(ts.SALE_RETURN)},this.isLowStock=function(){return d.quantity===Ps},this.getInventoryLevel=()=>this.saleInventoryData.getInventoryData(this.lineItem).inventoryLevel,this.continueWithLowStock=function(){this.saleInventoryData.disableInventoryValidation(this.lineItem)},this.showInfo=function(){i.trackUserEvent({eventName:"Show Product Information",metadata:{view:"Line Item"}}),s.viewDetails(this.lineItem.product)},this.handleLineItemKeypress=e=>{13!==e.which&&32!==e.which||(this.toggleLineItem(e),e.preventDefault())},this.toggleLineItem=e=>{const s=qe[0],a=t.element(s.querySelectorAll(".sale-list .li-cell-actions-container")),i=t.element(s.querySelectorAll(".sale-list .li-cell")),r=t.element(n[0].querySelector(".sale-list .li-cell-actions-container")),o=t.element(n[0].parentNode.querySelector(".li-cell")),l=t.element(n[0].parentNode.querySelector(".wr-expandable-chevron")),c=t.element(n[0].querySelector(".wr-expandable-chevron"));if(!this.isReadonly())if(r.hasClass("li-cell-actions-container--expanded"))r.removeClass("li-cell-actions-container--expanded"),o.removeClass("li-cell--expanded"),c.removeClass("fa-angle-down"),c.addClass("fa-angle-right");else{const t=["li-cell-summary--totals-container","wr-li-cell-summary-price-value","li-cell-summary--total-base-price"],n=_(e.target.classList);if(a.removeClass("li-cell-actions-container--expanded"),i.removeClass("li-cell--expanded"),l.removeClass("fa-angle-down"),l.addClass("fa-angle-right"),c.removeClass("fa-angle-right"),c.addClass("fa-angle-down"),r.addClass("li-cell-actions-container--expanded"),o.addClass("li-cell--expanded"),h){const e=!u&&this._canApplyDiscount()&&w(t,n).length>0,s=e=>{e&&(e.focus(),e.setSelectionRange(0,e.value.length))};Je(e?()=>s(p):()=>s(v),200)}}};const g=t=>n=>{e.$applyAsync(()=>{m||(d[t]&&e.formCtrl.$setValidity(d[t],!0),n&&e.formCtrl.$setValidity(n,!1),d[t]=n)})};let p,v;this.onDiscountError=g("discount"),this.onPriceError=g("price"),this.onQuantityError=g("quantity"),this.setPriceRef=e=>{p=e},this.setQuantityRef=e=>{v=e};const y=M(()=>o.saveSale(),300);this.onNoteChange=t=>{e.$apply(()=>{this.lineItem.note=t,y()})},this.onNoteBlur=()=>{y.flush()},this.isReadonly=function(){return this.lineItem.isGiftCard()},this._canApplyDiscount=()=>a.hasPermission(ts.SALE_DISCOUNT)}]}}));t.module("webregister.directives").directive("resetData",(function(){return{restrict:"E",template:'<vd-header>Reset local data</vd-header>\n\n<p class="vd-p">\n  We keep a copy of some of your store data in your web browser so you can keep selling if you lose your Internet\n  connection. Sometimes, this gets out of sync. Resetting it can help if you\'re having trouble with Vend.\n</p>\n\n<button class="vd-btn vd-btn--no vd-ml0"\n  ng-click="resetDataCtrl.resetData()"\n  ng-disabled="!webRegisterCtrl.webRegisterOnline ||\n    resetDataCtrl.saleSyncManager.uploadSalesCount ||\n    resetDataCtrl.saleSyncManager.attemptedSalesCount">\n  Reset Data\n</button>\n',controllerAs:"resetDataCtrl",controller:["Database","webRegisterStatusManager","posStateManager","vdTracking","Confirm","saleSyncManager",function(e,t,n,s,a,i){function r(){const a=n.getRegisterId();s.trackUserEvent({eventName:"Reset Data",metadata:{register_id:a},useBatching:!1,useSendBeacon:!0}),e.drop().then(()=>t.refreshCacheAndReload({forceReload:!0}))}this.saleSyncManager=i,this.resetData=function(){return a({header:"Are you sure you want to reset data?",content:'<p class="vd-p">Resetting your data deletes:</p>\n\n<ul class="wr-bulleted-list vd-mb5">\n  <li>\n    The sale you\'re currently working on\n  </li>\n  <li>\n    Any completed sales that haven\'t yet been saved to our servers\n  </li>\n  <li>\n    The copy of your Web Register data saved in your browser (we\'ll re-sync this with the latest\n    version)\n  </li>\n</ul>\n\n<p class="vd-p">\n  <strong>Before resetting your data, check your sales history to make sure your most recent sales have been saved. Do\n  not reset data if they do not appear.</strong>\n</p>\n',cancel:"Cancel",confirm:{label:"Reset Data",category:"no"}}).then(r)}}]}}));t.module("webregister.directives").directive("wrEnableTrainingButton",(function(){return{scope:{buttonClass:"@",onEnable:"=?",buttonText:"@"},restrict:"E",template:'<button class="vd-btn vd-btn--do" ng-class="enableTrainingButtonCtrl.buttonClass"\n  ng-disabled="enableTrainingButtonCtrl.hasActiveSale ||\n    enableTrainingButtonCtrl.trainingModeEnabled ||\n    enableTrainingButtonCtrl.failedToSyncSales"\n  ng-click="enableTrainingButtonCtrl.enableTrainingMode()">\n  {{enableTrainingButtonCtrl.buttonText || \'Enable Training Mode\'}}\n</button>\n<div ng-if="enableTrainingButtonCtrl.disabledHelpText" class="vd-mt1 vd-text--sub">\n  {{enableTrainingButtonCtrl.disabledHelpText}}\n</div>\n',bindToController:!0,controllerAs:"enableTrainingButtonCtrl",controller:["$scope","posStateManager","trainingModeModals","trainingModeManager","saleSyncManager",function(e,t,n,s,a){this.updateButtonState=function(){this.hasActiveSale=Boolean(t.getActiveSaleLocalId()),this.trainingModeEnabled=t.getTrainingModeEnabled(),this.failedToSyncSales=a.failedToSyncSalesCount,this.disabledHelpText=null,this.trainingModeEnabled?this.disabledHelpText="Training Mode is already enabled":this.hasActiveSale?this.disabledHelpText="Sorry, you must complete the current open sale before entering Training Mode":this.failedToSyncSales&&(this.disabledHelpText="Sorry, you must resolve your errored sales before entering Training Mode")},this.enableTrainingMode=function(){(this.onEnable?this.onEnable():We.resolve()).then(()=>{s.initiateTrainingMode()&&n.confirmTrainingMode().then(()=>s.initiateTrainingTour())})},this.updateButtonState(),t.on("activeSaleLocalIdChange",this.updateButtonState,this),t.on("trainingModeEnabledChange",this.updateButtonState,this),a.on("unsyncedSalesChange",this.updateButtonState,this),e.$on("$destroy",()=>{t.off("activeSaleLocalIdChange",this.updateButtonState),t.off("trainingModeEnabledChange",this.updateButtonState),a.off("unsyncedSalesChange",this.updateButtonState)})}]}})),t.module("webregister.directives").directive("trainingTour",(function(){return{restrict:"E",scope:!0,bindToController:!0,controllerAs:"trainingTourCtrl",controller:["$scope","trainingModeManager","vdTracking",function(e,t,n){this._initiateTour=function(){this.tour=new T.Tour({defaults:{classes:"wr-tour",buttons:[],showCancelLink:!1}}),t.getTourSteps().then(t=>{this._bindSteps(t);(et.includes(jt)?We.resolve():et.go(jt)).then(()=>{e.$applyAsync(()=>this.tour.start())})})},this._bindStepTrigger=function(e){return He.$on(e.triggerEvent,()=>{const s=e.stepDelay||200,a=e.trackingData&&e.trackingData[e.triggerEvent];a&&n.trackUserEvent({eventName:t.currentTourType,metadata:a}),Je(()=>{this.tour&&this.tour.show(e.stepId)},s)})},this._bindSteps=function(e){const t=e.length;e.forEach((e,n)=>{const s={id:e.id,attachTo:e.attachTo,tetherOptions:e.tetherOptions},a=n+1;e.nextBtn&&(s.buttons=[{text:"Okay, thanks!",action:this.tour.next}]),e.title&&e.pagination?s.title=e.title.concat(`<span class="wr-tour-title-pagination vd-text-supplementary">\n              ${a}/${t}</span>`):s.title=e.title,e.actionText?s.text=e.text.concat(`<div class="wr-tour-content-action">\n              <i class="wr-tour-content-action-icon vd-i vd-i-walk"></i>\n              ${e.actionText}</div>`):s.text=e.text,this.tour.addStep(s);const i=this.tour.steps.indexOf(this.tour.getById(s.id)),r=this.tour.steps[i];e.triggerOn&&(Array.isArray(e.triggerOn)?(r.unbind=[],e.triggerOn.forEach(t=>{const n=this._bindStepTrigger({stepId:s.id,triggerEvent:t,stepDelay:e.delay,trackingData:e.trackingData});r.unbind.push(n)},this)):r.unbind=this._bindStepTrigger({stepId:s.id,triggerEvent:e.triggerOn,stepDelay:e.delay,trackingData:e.trackingData}))})},this._destroyTour=function(){this.tour&&(qe.off("mousedown",this._hideCurrentTourStep),this.tour.steps.forEach(e=>{const t=e.unbind;t&&(Array.isArray(t)?t.forEach(e=>e()):t()),e.destroy()}),this.tour=null)},this._onTourChange=function(e){t.tourEnabled?this._initiateTour():this._destroyTour()},this._hideCurrentTourStep=e=>{e&&Boolean(e.target.closest(".shepherd-step"))||this.tour.hide()},t.on("tourEnabledChange",this._onTourChange,this),e.$on("$destroy",()=>{this._destroyTour(),t.off("tourEnabledChange",this._onTourChange)})}]}}));t.module("webregister.directives").directive("wrHtmlNavigation",["vdPopover","saleSyncManager","saleModals","userManager","userSwitchingService","trainingModeManager","registerManager","webRegisterStatusManager",function(e,t,n,s,a,i,r,o){return{restrict:"E",link(l,c){const d=()=>i.tourEnabled=!i.tourEnabled,u=()=>{!t.saleSyncRetryInProgress&&o.isOnline()&&(t.erroredSalesCount?n.viewErroredSales():e.open({trigger:qe[0].querySelector(".register-info-popover-trigger"),template:'<vd-popover>\n  <ul class="vd-popover-list">\n    <li ng-if="$ctrl.canShowSwitchRegisterItem">\n      <a href="javascript:void(0)" ng-click="$ctrl.switchRegister()" class="vd-popover-list-item">\n        Switch Register\n      </a>\n    </li>\n    <li>\n      <a href="javascript:void(0)" ng-click="$ctrl.toggleTrainingMode()" class="vd-popover-list-item">\n        {{$ctrl.trainingModeManager.trainingModeEnabled ? \'Exit Training Mode\' : \'Switch to Training Mode\'}}\n      </a>\n    </li>\n    <li ng-if="$ctrl.saleSyncManager.uploadSalesCount">\n      <a href="javascript:void(0)" ng-click="$ctrl.syncOfflineSales()" class="vd-popover-list-item">\n        Sync Offline Sales\n      </a>\n    </li>\n  </ul>\n</vd-popover>\n',controller:"RegisterActionsPopoverController",hasPopoverList:!0}))},h=()=>{const{name:e}=r.getActiveRegister()||{},{name:n}=r.getActiveOutlet()||{};E({offline:!o.isOnline(),training:i.trainingModeEnabled,tutorial:i.tourEnabled,toggleTutorialMode:d,onRegisterInfoClick:()=>{u()},switchUser:()=>{Je(a.selectUser.bind(a))},signoutUser:()=>{s.logout()},register:{registerName:e,outletName:n,errorCount:t.erroredSalesCount},currentURL:window.location.pathname,isError:Boolean(t.erroredSalesCount)},{user:s.getLoggedInUser()})};Je(h),nt.onSuccess({},h),i.on("tourEnabledChange",h),i.on("trainingModeEnabledChange",h),r.on("activeRegisterChange",h),r.on("activeOutletChange",h),s.on("loggedInUserChange",h),o.on(Pn.statusChange,h)}}}]);let Ns;t.module("webregister.directives").directive("wrRefreshBanner",(function(){return{restrict:"E",template:'<vd-banner ng-if="refreshBannerCtrl.enabled">\n  We\'ve made some improvements.\n  <a href="javascript:void(0)" class="vd-link" ng-click="refreshBannerCtrl.refresh()">\n    Refresh now\n  </a>\n  to get the changes, or\n  <a href="javascript:void(0)" class="vd-link" ng-click="refreshBannerCtrl.closeBanner()">\n    close this\n  </a> and do it later.\n</vd-banner>\n',bindToController:!0,controllerAs:"refreshBannerCtrl",controller:["$scope","webRegisterStatusManager","vdTracking",function(e,t,n){const s={name:k.Browser,version:k.Version};this._updateEnabled=function(){this.enabled=t.softRefreshRequired,this.enabled&&n.trackUserEvent({eventName:"Refresh Banner Displayed",metadata:{browser:s},useSendBeacon:!0})},this.refresh=function(){n.trackUserEvent({eventName:"Refresh Banner:  Refresh Now Clicked",metadata:{browser:s},useSendBeacon:!0}),t.refreshCacheAndReload({forceReload:!0}),this.close()},this.closeBanner=function(){n.trackUserEvent({eventName:"Refresh Banner: Close Clicked",metadata:{browser:s},useSendBeacon:!0}),this.close()},this.close=function(){this.enabled=!1},this._updateEnabled(),t.on(Pn.softRefreshRequired,this._updateEnabled,this),e.$on("$destroy",()=>{t.off(Pn.softRefreshRequired,this._updateEnabled)})}]}})),function(e){e.PRINT="wr-printer:print",e.LINE_ITEM_UPDATE_VALIDATION="line-item:update-validation",e.SALE_CUSTOMER_UPDATED="sale:customer-updated"}(Ns||(Ns={})),t.module("webregister.directives").directive("wrPrinter",(function(){return{restrict:"E",bindToController:!0,controllerAs:"printerCtrl",controller:["$scope","receiptTemplateTypesStore","receiptSettingsStore",function(e,n,s){this._print=function(e){if(e&&e.type)if(this.printData=e.data,"receipt-settings-and-template"===e.type){const e=this.printData.selectedReceiptId?this.printData.selectedReceiptId:this.printData.register.receipt_template_id,t="receipt-print-selected";s.get(e).then(e=>(this.printOptions=e,n.get(this.printData.paymentData&&!0===this.printData.paymentData.isSignatureSlipReceipt?"slip_signature":e.default_type))).then(e=>{this.printOptions.templateHtml=e.html,this.printOptions.styling=e.css,this._compileDirective(t)})}else if("styled-gift-receipt"===e.type){const e="receipt-print-selected",t=this.printData.register.receipt_template_id;s.get(t).then(t=>{this.printOptions=t,n.get("gift").then(t=>{this.printOptions.templateHtml=t.html,this.printOptions.styling=t.css,this._compileDirective(e)})})}else{const t="wr-print-"+e.type;this._compileDirective(t)}},this._compileDirective=function(n){this.compiledPrintDirective=Be(`<${n}\n          id="wr-printer"\n          class="vd-show-print"\n          data="printerCtrl.printData"\n          options="printerCtrl.printOptions">\n        </${n}>`)(e),Je.cancel(this._removePrinterElementTimer),this._removePrinterElement(),t.element(qe[0].body).append(this.compiledPrintDirective),Je(()=>{const e=Array.from(this.compiledPrintDirective[0].querySelectorAll("img")).filter(e=>!e.complete);if(e.length){const n=Je(500,!1),s=e.map(e=>We(n=>{const s=t.element(e);s.one("load",n),s.one("error",n)}));return We.race([n,We.all(s)])}}).then(()=>Xe.print()).then(()=>{this._removePrinterElementTimer=Je(()=>this._removePrinterElement(),2e3)})},this._removePrinterElement=function(){const e=qe[0].getElementById("wr-printer");e&&e.remove()};const a=He.$on(Ns.PRINT,(e,t)=>this._print(t));e.$on("$destroy",a)}]}}));t.module("webregister.directives").directive("wrCashMovements",(function(){return{scope:{cashMovements:"="},restrict:"E",template:'<table class="vd-table vd-table--fixed">\n  <thead>\n    <tr>\n      <th class="vd-sml-pad-h vd-pl0" width="15%">Date</th>\n      <th class="wr-hide-on-mobile vd-sml-pad-h">User</th>\n      <th class="wr-hide-on-tablet vd-sml-pad-h ">Reasons</th>\n      <th class="vd-align-right vd-sml-pad-h vd-no-pad-r" width="15%">\n        Transaction (<wr-currency-symbol></wr-currency-symbol>)\n      </th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr ng-repeat="cashMovement in cashMovementsCtrl.cashMovements | orderBy: \'-date\' track by $index">\n      <td class="vd-hide-print vd-sml-pad-h vd-pl0">\n        {{cashMovement.date | wrDateFormat:\'DD MMM YYYY HH:mm\':cashMovementsCtrl.outletTimeZone}}\n      </td>\n      <td class="vd-sml-pad-h wr-hide-on-mobile">\n        <span class="vd-show-print">{{cashMovement.user | wrUserName}}</span>\n        <vd-user-badge class="vd-hide-print" user="cashMovement.user" size="x-small"></vd-user-badge>\n      </td>\n      <td class="vd-sml-pad-h wr-hide-on-tablet">\n        <div class="wr-movement-reason">\n          <span class="wr-movement-reason-type">{{cashMovement.type}}</span>\n          <span class="wr-movement-reason-note vd-hide-print">{{cashMovement.note}}</span>\n        </div>\n      </td>\n      <td class="vd-align-right vd-sml-pad-h vd-no-pad-r vd-text-label">\n        <span ng-if="cashMovement.type === cashMovementsCtrl.openingCashFloatType">\n          {{cashMovement.amount | displayRound}}\n        </span>\n        <wr-coloured-number number="cashMovement.amount | displayRound"\n          ng-if="cashMovement.type !== cashMovementsCtrl.openingCashFloatType"\n          class="cash-type--{{cashMovement.type}}">\n        </wr-coloured-number>\n      </td>\n    </tr>\n  </tbody>\n</table>\n',bindToController:!0,controllerAs:"cashMovementsCtrl",controller:["registerManager",function(e){const t=e.getActiveOutlet();this.openingCashFloatType=us.OPENING_CASH_FLOAT,this.outletTimeZone=t&&t.time_zone}]}}));t.module("webregister.directives").directive("wrSetRegisterCashFloat",(function(){return{scope:{onCashFloatSet:"&?"},restrict:"E",template:'<vd-section type="secondary">\n  Set opening cash drawer amount.\n  <a target="_blank"\n    href="https://support.vendhq.com/hc/en-us/articles/207884598-Cash-Management-in-Vend"\n    class="vd-link vd-link--secondary">\n    Need help?\n  </a>\n</vd-section>\n<vd-section type="tertiary">\n  <set-cash-float-form form="cashManagementForm"\n    on-submit="$ctrl.setCashFloat($event.cashFloatSettings)"\n    loading="$ctrl.waitingForCashFloat">\n    <div>\n      <button type="submit" class="vd-btn vd-btn--do"\n        ng-disabled="cashManagementForm.$invalid || $ctrl.waitingForCashFloat">\n        Set Float\n      </button>\n    </div>\n  </set-cash-float-form>\n</vd-section>\n',bindToController:!0,controllerAs:"$ctrl",controller:["vdTracking","cashMovementsManager","vdToastNotificationService",function(e,n,s){this.setCashFloat=function(a){this.waitingForCashFloat=!0,n.recordCashMovement(a).then(e=>{t.isFunction(this.onCashFloatSet)&&this.onCashFloatSet(e)}).catch(()=>{s.negative({message:"We had a problem saving your opening cash drawer amount. Please try again."}),e.trackUserEvent({eventName:"Cash Management",metadata:{"Failed Cash Float":!0}})}).finally(()=>{this.waitingForCashFloat=!1})}}]}}));t.module("webregister.directives").directive("wrCashFloatNotSet",(function(){return{scope:{onCashFloatSet:"&?"},restrict:"E",template:' <div class="vd-text-supplementary vd-pt2 vd-pb2">\n  <i class="fa fa-exclamation-triangle wr-cash-float-not-set-icon"></i>\n  <span class="wr-cash-float-not-set-msg">\n    You have not set the opening cash float.\n    <a href="#" ng-click="cashFloatNotSetCtrl.setCashFloat()" class="vd-link vd-link--secondary">Set now.</a>\n  </span>\n</div>\n',bindToController:!0,controllerAs:"cashFloatNotSetCtrl",controller:["cashManagementModals",function(e){this.setCashFloat=function(){e.openRegisterSetFloat().then(()=>{t.isFunction(this.onCashFloatSet)&&this.onCashFloatSet()})}}]}}));const xs=e=>{const t=n=>{if(n&&e(n))return n.continue().then(t)};return t};class Os{constructor(e,t){this.db=e,this.storeName=t}index(e){return new $s(this.db,this.storeName,e)}get(e){return this.db.then(t=>t.get(this.storeName,e))}all(){const e=[],t=xs(t=>(e.push(t.value),!0));return this.db.then(e=>e.transaction(this.storeName).store.openCursor()).then(e=>t(e)).then(()=>e)}transformAll(e){const t=xs(t=>(t.update(e(t.value)),!0));return this.db.then(e=>e.transaction(this.storeName,"readwrite").store.openCursor()).then(e=>t(e))}clear(){return this.db.then(e=>e.clear(this.storeName))}put(e,t){let n=e;return void 0===t&&(t=e,n=void 0),this.db.then(e=>e.put(this.storeName,t,n))}del(e){return this.db.then(t=>t.delete(this.storeName,e))}batch(e){return this.db.then(t=>{const n=t.transaction(this.storeName,"readwrite"),s=n.store;if(Array.isArray(e))for(const a of e)s.put(a);else for(const a of Object.keys(e)){const t=e[a];null===t?s.delete(a):s.keyPath?s.put(t):s.put(t,a)}return n.done})}count(){return this.db.then(e=>e.count(this.storeName))}cursor({range:e,iterator:t}){return this.db.then(t=>t.transaction(this.storeName).store.openCursor(e)).then(xs(t))}}class $s{constructor(e,t,n){this.db=e,this.storeName=t,this.indexName=n}get(e){return this.db.then(t=>t.getFromIndex(this.storeName,this.indexName,e))}getAll(e){const t=[],n=xs(e=>(t.push(e.value),!0));return this.db.then(t=>t.transaction(this.storeName).store.index(this.indexName).openCursor(e)).then(e=>n(e)).then(()=>t)}count(e){return this.db.then(t=>t.countFromIndex(this.storeName,this.indexName,e))}cursor({range:e,iterator:t}){return this.db.then(t=>t.transaction(this.storeName).store.index(this.indexName).openCursor(e)).then(xs(t))}}let Ls;function Fs(e){return new Os((Ls||(Ls=I("webregister",16,{upgrade:(e,t,n,s)=>function(e,t,n){const s=e=>n.objectStore(e);switch(t){case 0:e.createObjectStore("products",{keyPath:"id"}).createIndex("byVariantParentId","variant_parent_id"),e.createObjectStore("taxes",{keyPath:"id"}),e.createObjectStore("outlets",{keyPath:"id"}),e.createObjectStore("productTaxes",{keyPath:"product_id"}),e.createObjectStore("versions",{keyPath:"entityStoreName"}),e.createObjectStore("priceBooks",{keyPath:"id"}),e.createObjectStore("priceBookProducts",{keyPath:"id"}).createIndex("byProductId","product_id"),e.createObjectStore("settings"),e.createObjectStore("sales",{keyPath:"localId"}),e.createObjectStore("paymentTypes",{keyPath:"id"}),e.createObjectStore("registers",{keyPath:"id"}),e.createObjectStore("users",{keyPath:"id"});case 1:e.createObjectStore("customers",{keyPath:"id"}),e.createObjectStore("customerGroups",{keyPath:"id"});case 2:e.createObjectStore("brands",{keyPath:"id"}),e.createObjectStore("suppliers",{keyPath:"id"}),e.createObjectStore("tags",{keyPath:"id"}),e.createObjectStore("productTypes",{keyPath:"id"});case 3:e.createObjectStore("legacyRegisters",{keyPath:"id"});case 4:s("sales").createIndex("byId","id",{unique:!0});case 5:s("sales").createIndex("syncStatus","syncStatus");case 6:s("products").createIndex("byVersion","version",{unique:!0}),s("customers").createIndex("byVersion","version",{unique:!0});case 7:e.createObjectStore("quickKeyLayouts",{keyPath:"id"});case 8:s("products").createIndex("bySku","sku");case 9:s("customers").createIndex("byCustomerCode","customer_code");case 10:e.createObjectStore("receiptTemplates",{keyPath:"id"});case 11:s("products").createIndex("byDeletedAt","deleted_at");case 12:e.deleteObjectStore("legacyRegisters");case 13:e.createObjectStore("receiptTemplateTypes",{keyPath:"name"}),e.createObjectStore("receiptSettings",{keyPath:"id"});case 14:e.createObjectStore("channels",{keyPath:"id"}).createIndex("byChannelType","channel_type");case 15:s("products").createIndex("byProductCode","product_codes_array",{multiEntry:!0})}}(e,t,s),blocking(){Ls.then(e=>e.close())}}).catch(e=>{P("[Database] Failed to open IndexedDB",{data:{error:e}})})),Ls),e)}const Us={drop:function(){return We.resolve(Ls.then(e=>{e.close(),R("webregister")}))},store:Fs};t.module("webregister.services").factory("Database",["wrDebugTools",e=>(e.register("Database"),Us)]);class Bs extends Et{constructor(e){super(),s(this,"dbStore",void 0),s(this,"entityStoreName",void 0),s(this,"entityName",void 0),s(this,"filterByOutlet",void 0),s(this,"syncDeleted",void 0),this.dbStore=Fs(e.databaseStoreName||e.entityStoreName),this.entityStoreName=e.entityStoreName,this.entityName=e.entityName||e.entityStoreName,this.filterByOutlet=Boolean(e.filterByOutlet),this.syncDeleted=Boolean(e.syncDeleted)}syncData(e,t){if(!e.length)return We.resolve({updated:[],removed:[]});const[n,s]=A(e,e=>this.shouldStoreEntity(e));return We.all([this.updateEntities(n),this.removeEntities(s)]).then(([e,n])=>{const s={updated:e,removed:n};return t&&(s.versionData=t),s}).then(e=>this.emitSyncEvent(e))}refresh(){return this.fetchRefreshedEntityDataFromServer().then(this.processRefreshedData.bind(this))}get(e){return We.resolve(this.dbStore.get(e))}count(){return We.resolve(this.dbStore.count())}put(e,t){return We.resolve(this.dbStore.put.apply(this.dbStore,arguments))}all(){return We.resolve(this.dbStore.all())}clear(){return We.resolve(this.dbStore.clear())}processRefreshedData(e){return this.clear().then(()=>this.syncData(e)).then(()=>e)}fetchRefreshedEntityDataFromServer(){return We.reject("refresh() is not implemented by this entity store")}shouldStoreEntity(e){return this.syncDeleted||!e.deleted_at}updateEntities(e){return this.dbStore.batch(e).then(()=>e)}removeEntities(e){return We.all(e.map(this.removeEntity,this)).then(()=>e)}removeEntity(e){return this.dbStore.del(e.id)}emitSyncEvent(e){return this.emit("sync",e),e}}const qs=new Bs({entityStoreName:"registers"}),Vs=new Bs({entityStoreName:"quickKeyLayouts",entityName:"button_layouts"});function Ks(){return{defaultModuleName:_n.DISPLAY_NAME,environment:Ut.get(),systemName:_n.APPLICATION_NAME,systemVersion:_n.CLIENT_VERSION}}t.module("webregister.directives").directive("wrQkLayouts",(function(){return{restrict:"E",template:'<div ng-if="!qkLayoutsCtrl.quickKeyLayouts" class="vd-align-center">\n  <div class="vd-loader"></div>\n  <div class="vd-mt1">Loading your Quick Key layouts</div>\n</div>\n\n<div ng-if="qkLayoutsCtrl.quickKeyLayouts">\n  <button class="vd-btn vd-btn--do" ng-click="qkLayoutsCtrl.addNewLayout()"\n    ng-disabled="qkLayoutsCtrl.awaitingServerResponse">\n    {{qkLayoutsCtrl.awaitingServerResponse ? \'Adding Layout\' : \'Add Layout\'}}\n    <i ng-if="qkLayoutsCtrl.awaitingServerResponse" class="vd-loader vd-loader--small"></i>\n  </button>\n  <ul ng-if="qkLayoutsCtrl.quickKeyLayouts.length > 0" class="wr-qk-layouts">\n    <li class="wr-qk-layout"\n      ng-repeat="quickKeyLayout in qkLayoutsCtrl.quickKeyLayouts |\n        orderBy : qkLayoutsCtrl.orderQuickKeyLayout track by quickKeyLayout.id">\n      <div ng-if="qkLayoutsCtrl.isLayoutBeingProcessed(quickKeyLayout)" class="wr-qk-layout-loader">\n        <div class="vd-loader"></div>\n      </div>\n      <div class="wr-qk-layout-about">\n        <span class="vd-header wr-qk-layout-title">{{quickKeyLayout.name}}</span>\n        <div ng-if="qkLayoutsCtrl.quickKeyLayoutsInUse[quickKeyLayout.id]"\n          ng-pluralize\n          count="qkLayoutsCtrl.quickKeyLayoutsInUse[quickKeyLayout.id].length"\n          when="{\'one\': \'Used by 1 other register.\', \'other\': \'Used by {} other registers.\'}"\n          class="vd-text--sub vd-mt1">\n        </div>\n      </div>\n      <div class="wr-qk-layout-actions vd-btn-group">\n        <div ng-if="qkLayoutsCtrl.isCurrentLayout(quickKeyLayout)" class="vd-flag vd-mr5">\n          Current Layout\n        </div>\n        <button ng-if="!qkLayoutsCtrl.isCurrentLayout(quickKeyLayout)"\n          title="Set as current layout"\n          ng-disabled="qkLayoutsCtrl.isLayoutBeingProcessed(quickKeyLayout)"\n          ng-click="qkLayoutsCtrl.setCurrentLayout(quickKeyLayout)"\n          class="vd-btn vd-btn--supplementary vd-mr5 vd-ml0 pro-qk-layout-action--set-current">\n          Set as Current Layout\n        </button>\n        <button class="vd-btn vd-btn--icon-supplementary"\n          title="Edit layout"\n          ng-disabled="qkLayoutsCtrl.isLayoutBeingProcessed(quickKeyLayout)"\n          ng-click="qkLayoutsCtrl.editLayout(quickKeyLayout)">\n          <i class="fa fa-pencil"></i>\n        </button>\n        <button class="vd-btn vd-btn--icon-supplementary"\n          title="Duplicate layout"\n          ng-disabled="qkLayoutsCtrl.isLayoutBeingProcessed(quickKeyLayout)"\n          ng-click="qkLayoutsCtrl.duplicateLayout(quickKeyLayout)">\n          <i class="fa fa-files-o"></i>\n        </button>\n        <button class="vd-btn vd-btn--icon-no"\n          title="Delete layout"\n          ng-disabled="qkLayoutsCtrl.isLayoutBeingProcessed(quickKeyLayout) ||\n            qkLayoutsCtrl.isCurrentLayout(quickKeyLayout)"\n          ng-click="qkLayoutsCtrl.deleteLayout(quickKeyLayout)">\n          <i class="fa fa-trash"></i>\n        </button>\n      </div>\n    </li>\n  </ul>\n</div>\n',bindToController:!0,controllerAs:"qkLayoutsCtrl",controller:["$scope","quickKeysManager","registerManager","vdTracking","vdToastNotificationService","Confirm",function(e,t,n,s,a,i){const r=[];function o(e){s.trackUserEvent({eventName:"Quick Key Actions",metadata:{Event:e}})}this.setCurrentLayout=function(e){return o("Set As Current Layout"),r.push(e.id),n.setCurrentQuickKeyLayout(e).then(()=>this._removeLayoutFromInProcessList(e)).catch(()=>this._notifyAndResetLayoutProcessed({message:"setting this layout as the current layout",quickKeyLayout:e}))},this.deleteLayout=function(e){if(o("Delete Layout"),this.quickKeyLayoutsInUse[e.id]){const t=this.quickKeyLayoutsInUse[e.id].map(e=>e.name);return a.negative({message:`Unable to delete this layout as it's currently being used by ${t.join(", ")}.`}),We.reject()}return i({header:"You are about to delete this Quick Key Layout",content:"Other registers and outlets will no longer be able to use this layout in the future.",cancel:"Don\u2019t Delete",confirm:{label:"Delete",category:"no"}}).then(()=>(r.push(e.id),t.deleteLayout(e).then(()=>this._removeLayoutFromInProcessList(e)).catch(()=>this._notifyAndResetLayoutProcessed({message:"deleting this layout",quickKeyLayout:e}))))},this.duplicateLayout=function(e){return o("Duplicate Layout"),r.push(e.id),t.duplicateLayout(e).then(()=>{a.success({message:"Layout queued for duplication and will appear shortly"}),this._removeLayoutFromInProcessList(e)}).catch(()=>this._notifyAndResetLayoutProcessed({message:"duplicating this layout",quickKeyLayout:e}))},this.editLayout=function(e){o("Edit Layout"),et.go(sn,{layoutId:e.id})},this.addNewLayout=function(){o("Add New Layout"),this.awaitingServerResponse=!0,t.createLayout(t.defaultNewLayoutName).then(e=>t.navigateToEditState(e,!0),()=>{this.awaitingServerResponse=!1})},this.isCurrentLayout=function(e){return t.isCurrentLayout(e)},this.isLayoutBeingProcessed=function(e){return D(r,e.id)},this.orderQuickKeyLayout=e=>t.isCurrentLayout(e)?0:e.name,this._removeLayoutFromInProcessList=function(e){return N(r,e.id)},this._notifyAndResetLayoutProcessed=function({message:e,quickKeyLayout:t}){this._removeLayoutFromInProcessList(t),a.negative({message:`Sorry there was a problem ${e}, please try again.`})},this._retrieveLayoutsInUseByRegisters=function(){const e=n.getActiveRegister();return qs.all().then(t=>(this.quickKeyLayoutsInUse={},t.forEach(t=>{const n=t.button_layout_id;e&&e.id===t.id||!n||(this.quickKeyLayoutsInUse[n]?this.quickKeyLayoutsInUse[n].push(t):this.quickKeyLayoutsInUse[n]=[t])}),this.quickKeyLayoutsInUse))},this._retrieveQuickKeyLayouts=function(){return t.getAllQuickKeyLayouts().then(e=>(this.activeQuickKeyLayout=t.quickKeyLayout,this.quickKeyLayouts=e,this.quickKeyLayouts))},this._buildQuickKeyLayoutData=function(){return We.all([this._retrieveLayoutsInUseByRegisters(),this._retrieveQuickKeyLayouts()])},t.init().then(()=>{this._buildQuickKeyLayoutData(),qs.on("sync",this._buildQuickKeyLayoutData,this),Vs.on("sync",this._buildQuickKeyLayoutData,this),e.$on("$destroy",()=>{qs.off("sync",this._buildQuickKeyLayoutData),Vs.off("sync",this._buildQuickKeyLayoutData)})})}]}}));class Gs{constructor({vdTracking:e}){s(this,"_vdTracking",void 0),s(this,"_whenInitialised",void 0),this._vdTracking=e}init(){return this._whenInitialised||(this._whenInitialised=Ge.invoke(["retailerSettingsManager","posStateManager","userManager",(e,t,n)=>We.all([t.init(),e.init(),n.init()]).then(()=>this._vdTracking.init({deviceFingerprint:t.getClientId(),retailerId:e.get().id,userId:n.getLoggedInUser().id}))])),this._whenInitialised}setUser(e){this.init().then(()=>{this._vdTracking.updateUser(e)})}}const js=["Application is offline","Failed to fetch","Possibly unhandled rejection:"],Qs=e=>{var t;if(Boolean(null===(t=window.google_tag_manager)||void 0===t?void 0:t["UA-171730176-1"]))return!1;const n=e.Details.Error.Message;if(js.some(e=>n.startsWith(e)))return Math.random()<.05&&e;const s=e.Details.Error.StackString;return(!s||!s.match(/(safari|chrome)-extension/))&&e};Ut.isProduction()&&x(r(r({},Ks()),{},{raygun:{apiKey:"m7xNxyU82ueCe4bOWpXn9w==",saveIfOffline:!0,onBeforeSend:Qs}}));class Ws{constructor(e,t){s(this,"$get",void 0);const n=e.$get().location.hostname;t.configure(r(r({},Ks()),{},{retailerDomainPrefix:n,batchingTimeout:1e3})),this.$get=["vdTracking",function(e){return new Gs({vdTracking:e})}]}}function Hs(e){return{restrict:"A",require:"ngModel",scope:{sale:"<",discountIsPercentage:"<"},link(n,s,a,i){function r(){i.$validate(),t.isDefined(i.$modelValue)&&l()}function o(e){return O(e)?"0":e}function l(){i.$invalid||n.$applyAsync((function(){const e=o(s.val());i.$setViewValue(c(e)),i.$render()}))}function c(t){const s=n.discountIsPercentage;return e(t,2,s)}i.$validators.validDiscount=e=>n.sale.isSaleDiscountValid(e,n.discountIsPercentage),i.$parsers.push(o),i.$formatters.push((function(e){const t=s[0].matches(":focus");let n;n=null!=e?String(e):e;if(t)return s.val();!O(n)&&i.valid&&(n=c(n));return n})),s.on("blur",()=>l()),n.$watch("sale.returnFor",r),n.$watch("discountIsPercentage",r)}}}Ws.$inject=["$windowProvider","vdTrackingProvider"],Hs.$inject=["vdDisplayRoundFilter"];const Ys={bindings:{discountValue:"<",discountIsPercentage:"<",maxSaleDiscount:"<"},controller:class{constructor(){s(this,"discountValue",void 0),s(this,"isValidNumber",void 0)}$onChanges(e){e.discountValue&&(this.isValidNumber=c.isFinite(this.discountValue))}},template:'<div\n  vd-flex vd-flex-align="start"\n  class="vd-text--negative vd-text-supplementary vd-mt3 wr-sale-discount-popover-error-message"\n>\n  <vd-icon icon="fa-exclamation-triangle" class="wr-sale-discount-error-icon vd-pr1"></vd-icon>\n\n  \x3c!-- When a non numeric character is entered --\x3e\n  <div ng-if="!$ctrl.isValidNumber">\n    Please use numbers only.\n  </div>\n\n  \x3c!-- When a negative value is entered --\x3e\n  <div ng-if="$ctrl.isValidNumber && $ctrl.discountValue < 0">\n    Discount amount cannot be a negative value.\n  </div>\n\n  \x3c!-- When a valid number is entered --\x3e\n  <div ng-if="$ctrl.isValidNumber && $ctrl.discountValue >= 0">\n\n    \x3c!-- If the number is a currency discount that exceeds the max allowed --\x3e\n    <div ng-if="!$ctrl.discountIsPercentage">\n      A {{$ctrl.discountValue | vdCurrency}} discount is greater than the\n      {{$ctrl.maxSaleDiscount | vdCurrency}}  balance.\n    </div>\n\n    \x3c!-- If the number is a percentage discount that exceeds the max allowed --\x3e\n    <div ng-if="$ctrl.discountIsPercentage">\n      A discount can\'t be greater than 100%\n    </div>\n  </div>\n</div>\n'};class zs{constructor(e,t,n){this.close=e,this.$scope=t,this.saleManager=n,s(this,"discountIsPercentage",void 0),s(this,"displayDiscount",void 0),this.displayDiscount=this.saleManager.sale.displayDiscount,this.discountIsPercentage=this.saleManager.sale.discountIsPercentage,n.init()}discountTypeSwitched(){this.$scope.$emit("discount:discount-type-switch:focus")}handleAddBtnClicked(){var e;this.saleManager.sale.displayDiscount=this.displayDiscount,this.saleManager.sale.discountIsPercentage=this.discountIsPercentage,e=this.discountIsPercentage,window.sessionStorage.setItem("WR_SALE_DISCOUNT_IS_PERCENTAGE",e),this.saleManager.updateSaleDiscount().then(()=>this.close()).then(()=>He.$emit("autocomplete:global-search:focus"))}}zs.$inject=["close","$scope","saleManager"];class Js{constructor(e,t,n,a){this.$element=e,this.vdPopover=t,this.userManager=n,this.saleManager=a,s(this,"isDisabled",void 0),s(this,"showPopoverOnInit",void 0)}hasPermission(){return this.userManager.hasPermission(ts.SALE_DISCOUNT)}$postLink(){this.showPopoverOnInit&&!this.isDisabled()&&this.showDiscountPopover()}showDiscountPopover(){this.vdPopover.open({trigger:this.$element,template:'<vd-popover class="sale-popover wr-discount-popover">\n  <h1 class="vd-text-label">Add Discount</h1>\n  <hr class="vd-hr">\n  <form id="editDiscount" class="vd-flex">\n    <div class="vd-flex vd-flex--align-start" ng-click="$ctrl.discountTypeSwitched()">\n      \x3c!-- Discount input type segcontrol --\x3e\n      <label ng-class="{ \'vd-segcontrol--selected\': $ctrl.discountIsPercentage === true,\n        \'vd-segcontrol--disabled\': disabled }"\n        class="vd-segcontrol wr-sale-discount-percentage-segcontrol">\n        <input ng-model="$ctrl.discountIsPercentage"\n          class="vd-segcontrol-input"\n          type="radio"\n          ng-value="true">\n        <div class="vd-segcontrol-button">%</div>\n      </label>\n      <label ng-class="{ \'vd-segcontrol--selected\': $ctrl.discountIsPercentage === false,\n        \'vd-segcontrol--disabled\': disabled }"\n        class="vd-segcontrol wr-sale-discount-currency-segcontrol">\n        <input ng-model="$ctrl.discountIsPercentage"\n          class="vd-segcontrol-input"\n          type="radio"\n          ng-value="false">\n        <div class="vd-segcontrol-button">\n          <wr-currency-symbol></wr-currency-symbol>\n        </div>\n      </label>\n    </div>\n\n    \x3c!-- Discount input --\x3e\n    <div class="vd-field vd-mb0 vd-mt0">\n      <div class="vd-value">\n        <input ng-model="$ctrl.displayDiscount"\n          ng-model-options="{ allowInvalid: true }"\n          sale-discount-input\n          sale="$ctrl.saleManager.sale"\n          discount-is-percentage="$ctrl.discountIsPercentage"\n          vd-focus="{isFocusable: true, selectText: true, focusOn: \'discount:discount-type-switch:focus\'}"\n          class="vd-input wr-sale-discount-input"\n          ng-class="{\n            \'vd-input--icon-right\' : $ctrl.discountIsPercentage,\n            \'vd-input--icon-left\' : !$ctrl.discountIsPercentage\n          }"\n          inputmode="decimal">\n        <wr-currency-symbol ng-if="!$ctrl.discountIsPercentage"\n          class="wr-sale-discount-input-symbol vd-input-icon vd-input-icon--left">\n        </wr-currency-symbol>\n        <div ng-if="$ctrl.discountIsPercentage"\n          class="wr-sale-discount-input-symbol vd-input-icon vd-input-icon--right">\n          %\n        </div>\n      </div>\n      \x3c!-- Discount error messages --\x3e\n      <sale-discount-error ng-show="!$ctrl.saleManager.sale.isSaleDiscountValid($ctrl.displayDiscount, $ctrl.discountIsPercentage)"\n        discount-value="$ctrl.displayDiscount"\n        discount-is-percentage="$ctrl.discountIsPercentage"\n        max-sale-discount="$ctrl.saleManager.sale.totals.maxSaleDiscount">\n      </sale-discount-error>\n    </div>\n  </form>\n\n\n  <div class="vd-text--sub vd-text--secondary vd-mt3 vd-mb3">This discount will be applied to all items</div>\n\n  <div class="vd-flex wr-discount-popover-footer vd-pt3 vd-pb3 vd-btn-group" vd-flex-align="end">\n    <button ng-click="$ctrl.close()" class="vd-btn vd-btn--supplementary">Cancel</button>\n    <button class="vd-btn vd-btn--do pro-sl-discount-btn-add"\n      ng-disabled="!$ctrl.saleManager.sale.isSaleDiscountValid($ctrl.displayDiscount, $ctrl.discountIsPercentage)"\n      ng-click="$ctrl.handleAddBtnClicked()"\n      form="editDiscount">\n      Add\n    </button>\n  </div>\n\n</vd-popover>\n',controller:zs,direction:"left"})}}Js.$inject=["$element","vdPopover","userManager","saleManager"];const Xs={bindings:{hasActiveSale:"<",isDisabled:"<",confirmedNotReadyToComplete:"<",showPopoverOnInit:"<?"},controller:Js,template:'<span class="vd-text-label" ng-if="$ctrl.isDisabled() || !$ctrl.hasPermission()">Discount</span>\n<a ng-if="!$ctrl.isDisabled() && $ctrl.hasPermission()"\n  ng-click="$ctrl.showDiscountPopover($event)"\n  href="javascript:void(0)"\n  class="vd-text-label vd-link pro-sale-discount-link">\n  Discount\n</a>\n<span class="sale-total-line-item--sub"\n  ng-if="$ctrl.saleManager.sale.discountIsPercentage && $ctrl.saleManager.sale.displayDiscount != 0">\n  {{$ctrl.saleManager.sale.displayDiscount}}%\n</span>\n'};class Zs{constructor(e,t,n){this.$element=e,this.vdPopover=t,this.saleManager=n}isDisabled(){const e=this.saleManager.sale;return Boolean(!this.saleManager.getHasActivePromotions()||!this.saleManager.hasActiveSale()||!e.hasLineItems()||e.isReturn()||e.isConfirmed())}showAddPromoCodePopover(){this.vdPopover.open({trigger:this.$element,template:'<vd-popover class="sale-popover wr-discount-popover">\n  <h1 class="vd-text-label">Add Promo Code</h1>\n  <hr class="vd-hr">\n  <form id="addPromoCode" class="vd-flex">\n    <div class="vd-field vd-mb3 vd-mt0">\n      <div class="vd-value">\n        <input ng-model="$ctrl.promoCode"\n          class="vd-input" vd-input-symbol="{align: \'left\', icon: \'fa fa-key\'}"\n          ng-class="{\'vd-input--error\': $ctrl.isPromoCodeNotCorrect()}"\n          ng-change="$ctrl.removeErrorMsg()"\n          vd-focus="{ focusOn: \'invalidPromoCode\', isFocusable: true }">\n        <span ng-if="$ctrl.saleManager.saleCalculating" class="vd-loader vd-loader--small vd-loader--input"></span>\n      </div>\n    </div>\n  </form>\n\n  \x3c!-- Promo code error messages --\x3e\n  <div class="vd-text--negative vd-text-supplementary"\n    ng-if="$ctrl.isPromoCodeNotCorrect()">\n    <vd-icon icon="fa-exclamation-triangle" class="wr-sale-discount-error-icon vd-pr1"></vd-icon>\n    <span ng-if="!$ctrl.isStatusInsufficientBuyOrSpend() && !$ctrl.isStatusInsufficientGet()">\n      {{$ctrl.getValidationErrorMsg()}}\n      <a href="javascript:void(0)"\n      class="vd-link vd-link--secondary"\n      ng-if="$ctrl.showPromotionModalLink()"\n      ng-click="$ctrl.openPromotionModal()">\n        Check Promotion\n      </a>\n    </span>\n    <span ng-if="$ctrl.isStatusInsufficientBuyOrSpend() || $ctrl.isStatusInsufficientGet()">\n      Not quite there. {{ $ctrl.isStatusInsufficientGet() ? \' Add a \' : \'\' }}\n      <a href="javascript:void(0)"\n      class="vd-link vd-link--secondary"\n      ng-if="$ctrl.showPromotionModalLink()"\n      ng-click="$ctrl.openPromotionModal()">\n      {{ $ctrl.isStatusInsufficientGet() ? \'redeemable product \' : \'See what\u2019s required to redeem this code\' }}\n      </a>\n      {{ $ctrl.isStatusInsufficientGet() ? \'first to use this code.\' : \'\' }}\n    </span>\n  </div>\n\n  <div class="vd-flex wr-discount-popover-footer vd-pt3 vd-pb3" vd-flex-align="end">\n    <div class="vd-btn-group vd-mr5">\n      <button class="vd-btn vd-btn--supplementary" ng-click="$ctrl.close()">Cancel</button>\n      <button class="vd-btn vd-btn--do pro-sl-promo-btn-add"\n        ng-disabled="$ctrl.promoCode.length === 0 || $ctrl.saleManager.saleCalculating || $ctrl.isPromoCodeNotCorrect()"\n        ng-click="$ctrl.addPromoCode()"\n        form="addPromoCode">\n        Add\n      </button>\n    </div>\n  </div>\n\n</vd-popover>\n',controller:"SalePromoCodePopoverController",direction:"left"}).then(e=>{e.closed.then(e=>{e&&He.$emit("promo-code-added")})})}}Zs.$inject=["$element","vdPopover","saleManager"];const ea={bindings:{shouldShowLink:"<"},controller:Zs,template:'<span ng-if="!$ctrl.saleManager.promoCodeAdded"\n  class="vd-text-label pro-sale-promo-link sale-total-header--link"\n  ng-class="{\'vd-link\': !$ctrl.isDisabled(), \'sale-disabled-add-link\': $ctrl.isDisabled()}"\n  ng-click="!$ctrl.isDisabled() && $ctrl.showAddPromoCodePopover()">\n  Promo Code\n</span>\n'};class ta{constructor(e,t){this.close=e,this.saleManager=t}removeAllTax(){return this.saleManager.removeAllTax().then(()=>this._closeIfNoBreakdownToShow())}removeTax(e){return this.saleManager.removeTax(e).then(()=>this._closeIfNoBreakdownToShow())}_closeIfNoBreakdownToShow(){this.saleManager.sale.finals.taxDisplayProperties.showTaxBreakdown||this.close()}}ta.$inject=["close","saleManager"];class na{constructor(e,t){this.saleManager=e,this.vdPopover=t}toggleTaxBreakdownPopover(e){this.vdPopover.open({trigger:e.currentTarget,template:'<vd-popover class="sale-popover wr-tax-popover">\n  <h1 class="vd-text-label">Remove tax from sale</h1>\n  <hr class="vd-hr vd-mb0">\n  <table class="wr-sale-tax-breakdown-table">\n    <tr ng-repeat="(id, tax) in $ctrl.saleManager.sale.finals.taxes track by $index"\n       class="wr-sale-tax-breakdown-tax-item">\n      <td>\n        <wr-display-tax-rate tax="tax" show-tax-details="true"></wr-display-tax-rate>\n      </td>\n      <td class="wr-sale-tax-breakdown-tax-total">{{tax.total | vdCurrency}}</td>\n      <td class="wr-sale-tax-breakdown-tax-actions">\n        <button ng-disabled="!tax.removable"\n          class="vd-btn vd-btn--icon-no"\n          ng-click="$ctrl.removeTax(tax.rate)"\n          type="button">\n          <vd-icon icon="fa-trash"></vd-icon>\n        </button>\n      </td>\n    </tr>\n  </table>\n  <div class="vd-mt3">\n    <button ng-if="$ctrl.saleManager.sale.finals.taxDisplayProperties.showRemoveAll"\n      ng-click="$ctrl.removeAllTax()"\n      class="vd-btn vd-btn--no pro-sale-tax-breakdown-remove-all">\n      Remove all\n    </button>\n  </div>\n</vd-popover>\n',direction:"left",controller:ta})}}na.$inject=["saleManager","vdPopover"];const sa={controller:na,template:'<span ng-if="!$ctrl.saleManager.sale.finals.taxDisplayProperties.showTaxBreakdown" class="vd-text-label pro-sale-tax-breakdown-link">\n  Tax\n  <span class="vd-text-body sale-total-line-item--sub" ng-if="$ctrl.saleManager.sale.finals.taxDisplayProperties.taxName">\n    {{$ctrl.saleManager.sale.finals.taxDisplayProperties.taxName}}\n  </span>\n</span>\n<span ng-if="$ctrl.saleManager.sale.finals.taxDisplayProperties.showTaxBreakdown">\n  <a ng-click="$ctrl.toggleTaxBreakdownPopover($event)"\n    class="vd-text-label vd-link pro-sale-tax-breakdown-link"\n    href="javascript:void(0)">\n    Tax\n  </a>\n  <span class="sale-total-line-item--sub">\n    {{$ctrl.saleManager.sale.finals.taxDisplayProperties.taxName}}\n  </span>\n</span>\n'};class aa{constructor(e,t){this.close=e,this.saleManager=t,s(this,"promotionsList",void 0),this.promotionsList=this.saleManager.getPromotionSummary()}isPromoCodeDeleteDisabled(){const e=this.saleManager.sale;return Boolean(e.returnFor||e.isConfirmed())}removePromoCode(){this.saleManager.addOrRemovePromoCode("").then(()=>this.close())}}aa.$inject=["close","saleManager"];class ia{constructor(e,t,n){this.$element=e,this.vdPopover=t,this.saleManager=n,s(this,"unbindPromoAdded",void 0),this.unbindPromoAdded=He.$on("promo-code-added",()=>{const e=this.saleManager.sale.promoCode;e&&""!==e&&(this.saleManager.promoCodeAdded=!1,this.togglePromotionPopover())})}$onDestroy(){this.unbindPromoAdded()}togglePromotionPopover(){this.vdPopover.open({trigger:this.$element,template:'<vd-popover class="sale-popover wr-promotion-popover">\n  <h1 class="vd-text-label">Promotions</h1>\n  <hr class="vd-hr">\n  <div class="wr-promotions-container">\n    <div ng-repeat="promo in $ctrl.promotionsList track by promo.id" class="wr-sale-popover-item">\n      <vd-icon icon="fa-ticket" class="li-cell-actions-promotion-icon wr-promotion-popover-icon"></vd-icon>\n      <div class="wr-promotion-content-container">\n        <div class="wr-promotion-content">\n          <div class="wr-promotion-detail"> \x3c!-- Promotion name / description / promo code --\x3e\n            <span class="vd-text-label pro-promotion-name">\n              {{promo.name}}\n            </span>\n            <div class="vd-text--sub">{{promo.description}}</div>\n            <div ng-if="promo.promo_code">\n              <vd-icon icon="fa-key" class="li-cell-actions-promotion-icon"></vd-icon>\n              <span class="vd-text--sub">{{promo.promo_code}}</span>\n            </div>\n          </div>\n          <div class="vd-align-right"> \x3c!-- Discount price and remove button --\x3e\n            <p class="vd-text-label pro-sale-promotions-item--total">\n              {{promo.total | vdCurrency}}\n            </p>\n            <button ng-if="promo.promo_code && !$ctrl.isPromoCodeDeleteDisabled()"\n              class="vd-btn vd-btn--icon-no"\n              ng-click="$ctrl.removePromoCode()">\n              <i class="fa fa-trash"></i>\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</vd-popover>\n',controller:aa,direction:"left"})}}ia.$inject=["$element","vdPopover","saleManager"];const ra={controller:ia,template:'<a ng-click="$ctrl.togglePromotionPopover($event)"\n  class="vd-text-label vd-link pro-sale-promotion-link"\n  href="javascript:void(0)">\n  Promotions\n</a>\n<span class="sale-total-line-item--sub">\n  <vd-icon icon="fa-ticket" class="li-cell-actions-promotion-icon"></vd-icon>\n  <span ng-pluralize\n    class="pro-sale-promotion-count"\n    count="$ctrl.saleManager.getPromotionSummary().length"\n    when="{\'one\': \'{} Promotion\', \'other\': \'{} Promotions\'}">\n  </span>\n</span>\n'};class oa{constructor(e,t,n){this.close=e,s(this,"outletTimeZone",void 0),s(this,"payments",void 0),this.payments=t.sale.payments,this.outletTimeZone=n.getActiveOutlet().time_zone}}oa.$inject=["close","saleManager","registerManager"];class la{constructor(e,t,n){this.$element=e,this.vdPopover=t,this.saleManager=n}togglePaymentPopover(){this.vdPopover.open({trigger:this.$element,template:'<vd-popover class="sale-popover">\n  <h1 class="vd-text-label">Payments</h1>\n  <hr class="vd-hr">\n  <div>\n    <div ng-repeat="payment in $ctrl.payments track by payment.localId" class="wr-sale-popover-item">\n      <div>\n        <span class="pro-payment-name">\n          {{payment.paymentType.name}}\n        </span>\n        <div class="vd-text--sub vd-text--secondary">\n          {{::payment.paymentDate | wrDateFormat:\'DD MMM YYYY H:mm\':$ctrl.outletTimeZone}}\n        </div>\n      </div>\n      <span class="pro-payment-amount">{{payment.amount | vdCurrency}}</span>\n    </div>\n  </div>\n</vd-popover>\n',controller:oa,direction:"left"})}}la.$inject=["$element","vdPopover","saleManager"];const ca={controller:la,template:'<a ng-click="$ctrl.togglePaymentPopover($event)"\n  class="vd-text-label vd-link"\n  href="javascript:void(0)">\n  Payments\n</a>\n<span class="sale-total-line-item--sub pro-number-of-payments">\n   <span ng-pluralize\n    count="$ctrl.saleManager.sale.payments.length"\n    when="{\'one\': \'{} Payment Made\', \'other\': \'{} Payments Made\'}">\n  </span>\n</span>\n'};function da(e,t){const n=r(r({},t),{},{include_composites:!0,product_ids:e,size:1e3}),s=JSON.stringify(n);return Ke.get("/api/2.0/inventory_levels",{params:{options:s}}).then(Ue)}class ua extends Et{constructor(e,t,n){super(),this.vdToastNotificationService=e,this.registerManager=t,this.webRegisterStatusManager=n,s(this,"saleInventoryData",[])}lookupInventoryData(e){const t=e.product;if(!this.registerManager.isLowInventoryWarningEnabled()||!t.has_inventory||!this.webRegisterStatusManager.isOnline()||e.isGiftCard()||e.confirmed||this._isReturn(e))return We.resolve();let n=We.resolve();if(this._isInSaleInventoryData(e))this.addRemoveQuantity(e);else{const s=this.registerManager.getActiveOutlet().id;n=da([t.id],{include_variants:!1,location_ids:[s]}).then(t=>{if(t){const n=g(t,{location_id:s});if(n){const t={productId:n.product_id,inventoryLevel:c.add(n.levels.producible,n.levels.on_hand),currentInventoryInSale:e.quantity,validateInventoryLevel:!0};this.saleInventoryData.push(t)}}}).catch(()=>this.vdToastNotificationService.negative({message:"Failed to retrieve inventory levels, please refresh to try again."}))}return n.finally(()=>this.emit(Ns.LINE_ITEM_UPDATE_VALIDATION))}disableInventoryValidation(e){this.getInventoryData(e).validateInventoryLevel=!1,this.emit(Ns.LINE_ITEM_UPDATE_VALIDATION)}getInventoryData(e){return g(this.saleInventoryData,t=>t.productId===e.product.id)}shouldValidateInventory(e){const t=this.getInventoryData(e),n=Boolean(t&&t.validateInventoryLevel),s=Boolean(!e.confirmed&&!this._isReturn(e));return Boolean(n&&s&&!e.isGiftCard())}addRemoveQuantity(e,t={}){const n=this.getInventoryData(e);if(n){if(t.onRemove)return n.currentInventoryInSale=c.subtract(n.currentInventoryInSale,e.quantity),void(t.hasLineItems&&this.emit(Ns.LINE_ITEM_UPDATE_VALIDATION));n.currentInventoryInSale=c.add(n.currentInventoryInSale,e.quantity)}}reEvaluateQuantity(e){this._resetCurrentInventoryInSaleData();const t=[];return b(e,e=>{if(e.confirmed||this._isReturn(e))return;const n=this.getInventoryData(e);n?n.currentInventoryInSale=c.add(n.currentInventoryInSale,e.quantity):t.push(this.lookupInventoryData(e))}),We.all(t).then(()=>this.emit(Ns.LINE_ITEM_UPDATE_VALIDATION))}hasInventory(e){const t=this.getInventoryData(e),n=c.vn(t.currentInventoryInSale).eq(0)?0:c.subtract(t.inventoryLevel,t.currentInventoryInSale);return Boolean(!c.vn(n).lt(0))}reset(){this.saleInventoryData=[]}_resetCurrentInventoryInSaleData(){b(this.saleInventoryData,e=>{e.currentInventoryInSale=0})}_isInSaleInventoryData(e){const t=this.getInventoryData(e);return Boolean(t)}_isReturn(e){return Boolean(c.vn(e.quantity).lt(0))}}ua.$inject=["vdToastNotificationService","registerManager","webRegisterStatusManager"];class ha{constructor(e){this.saleTransformer=e}checkPromotions(e){const t=this.saleTransformer.toPromotion(e);return Ke.post("/api/2.0/discount",t).then(({data:e})=>e)}}ha.$inject=["saleTransformer"];class ma{constructor(e,t){this.Modal=e,this.saleManager=t}markUnfulfilled(e){return this.Modal({controller:"markUnfulfilledModalController",controllerAs:"$ctrl",template:'<mark-as-unfulfilled-modal\n  sale="$ctrl.sale"\n  close="$ctrl.internalClose"\n  outlets="$ctrl.outlets">\n</mark-as-unfulfilled-modal>\n',sale:this.saleManager.sale,outlets:e})}}ma.$inject=["Modal","saleManager"];class ga{constructor(e,t,n,a,i,r){this.close=t,this.options=n,this.saleSyncManager=a,s(this,"contactSupportUrl",void 0),s(this,"erroredSales",void 0),s(this,"erroredSalesButton",void 0),r.trackUserEvent({eventName:"Errored Sales Modal",metadata:{Event:"Modal Shown"}}),this.contactSupportUrl=_n.CONTACT_SUPPORT_URL,this.erroredSales=n.erroredSales,this.erroredSalesButton=Ye.trustAsHtml(`\n      <a href="${n.erroredSalesFileUrl}"\n        download="errored-sales.json"\n        target="_blank"\n        class="vd-btn vd-btn--supplementary">\n        Download Errored Sales\n      </a>`),a.on("saleSyncRetryComplete",this._evaluateErroredSales,this),i.on(Pn.statusChange,this.close,this),e.$on("$destroy",()=>{a.off("saleSyncRetryComplete",this._evaluateErroredSales),i.off(Pn.statusChange,this.close)})}_evaluateErroredSales(){this.saleSyncManager.getErroredSales().then(e=>{e.length?this.erroredSales=e:this.close()})}}ga.$inject=["$scope","close","options","saleSyncManager","webRegisterStatusManager","vdTracking"];const pa=new Bs({entityStoreName:"customers"}),va=$(L,F,p);class ya{constructor(e,t,n,a,i,r,o,l,c,d){this.$scope=e,this.close=t,this.registerManager=n,this.retailerSettingsManager=a,this.saleTransformer=i,this.searchResource=r,this.usersStore=o,this.webRegisterStatusManager=l,this.vdTracking=c,this.vdFeatureManager=d,s(this,"discountProductId",void 0),s(this,"errorRetrievingSales",void 0),s(this,"maxSales",void 0),s(this,"placeHolderImageSrc",void 0),s(this,"sales",void 0),s(this,"salesRetrieved",void 0),this.sales=[],this.maxSales=10,this.salesRetrieved=!1,this.placeHolderImageSrc="products/placeholder.svg",this.discountProductId=this.retailerSettingsManager.get().discount_product_id,this.errorRetrievingSales=!1,this._init()}showAllParkedSales(){this.vdTracking.trackUserEvent({eventName:"Retrieve Sale Popover: Show All Parked Sales"}),window.location.href=pn+"?status=SAVED"}continueSale(e){this.vdTracking.trackUserEvent({eventName:"Retrieve Sale Popover: Continue Sale",metadata:{saleId:e.id}}),this.close(),He.$emit("retrieveSale:loadSale",e.id)}hasValidCustomer({customer:e}){return Boolean(e&&"WALKIN"!==e.customer_code)}_init(){this.vdTracking.trackUserEvent({eventName:"Retrieve Sale Popover Shown"}),this._closePopoverWhenOffline(),this._retrieveSales()}_closePopoverWhenOffline(){this.webRegisterStatusManager.on(Pn.statusChange,this.close,this),this.$scope.$on("$destroy",()=>{this.webRegisterStatusManager.off(Pn.statusChange,this.close)})}_retrieveSales(){const e=this.registerManager.getActiveOutlet(),t=e&&e.id,n=this.vdFeatureManager.get("parked_sales_from_read_api"),s={outlet_id:t,page_size:this.maxSales+1};return n?s.status=qn.PARKED.toLowerCase():s["status[]"]=qn.PARKED.toLowerCase(),this.searchResource.sales(s).then(e=>this._hydrateSales(e)).then(e=>{this.sales=e,this.salesRetrieved=!0}).catch(e=>{Qe.warn("[RetrieveSalePopover] Error when retrieving parked sales",e),this.errorRetrievingSales=!0})}_hydrateSales(e){return We.all({customers:this._getCustomers(e),products:this._getProducts(e),users:this._getUsers(e)}).then(({customers:t,products:n,users:s})=>this._setSaleData({sales:e,customers:t,products:n,users:s})).catch(e=>(Qe.warn("[RetrieveSalePopover] Error when hydrating sales",e),We.reject(e)))}_setSaleData({sales:e,customers:t,products:n,users:s}){return e.map(e=>(e.customer=g(t,{id:e.customer_id}),e.user=g(s,{id:e.user_id}),e.products=this._setProducts(e,n),e.productsSummary=this._setProductsSummary(e.products),e))}_setProducts(e,t){const n=[];return e.line_items.forEach(e=>{if(e.product_id===this.discountProductId)return;const s=c.vn(e.quantity).isNeg(),a=g(n,t=>{const n=c.vn(t.quantity).isNeg();return t.id===e.product_id&&(s&&n||!s&&!n)});if(a)a.quantity=s?c.subtract(a.quantity,c.vn(e.quantity).abs().toNumber()):c.add(a.quantity,e.quantity);else{const s=g(t,{id:e.product_id});n.push(y({},s,{quantity:e.quantity}))}}),n}_setProductsSummary(e){const t=[];return e.some(n=>{if(2===t.length&&e.length>3)return t.push(`and ${e.length-2} more products`),!0;{const e=n.hasFailedToLoad?"Product not found":n.variant_name;return void t.push(`${n.quantity} \xd7 ${e}`)}}),t}_getProducts(e){const t=U(e.map(e=>e.line_items)),n=va(t,"product_id");return We.all(n.map(e=>this.saleTransformer.hydrateProduct(e).then(t=>t?t.variant_parent_id?this._getVariantParentProductImages(t).then(e=>(t.images=e,t)):t:{id:e,hasFailedToLoad:!0})))}_getVariantParentProductImages(e){return this.saleTransformer.hydrateProduct(e.variant_parent_id).then(e=>e&&e.images||[])}_getCustomers(e){const t=va(e,"customer_id");return We.all(t.map(e=>pa.get(e)))}_getUsers(e){const t=va(e,"user_id");return We.all(t.map(e=>this.usersStore.get(e)))}}ya.$inject=["$scope","close","registerManager","retailerSettingsManager","saleTransformer","searchResource","usersStore","webRegisterStatusManager","vdTracking","vdFeatureManager"];const fa="YYYY-MM-DD[T]HH:mm:ss",Sa="applied",Ca="expired",ba="incorrect_outlet",_a="insufficient_buy",wa="insufficient_spend",Ma="insufficient_get",Ta="upcoming",Ea={[Ca]:"Code can no longer be redeemed.",[ba]:"The code cannot be redeemed at this outlet.",[_a]:"This code cannot be redeemed as the buy condition has not been met.",[wa]:"This code cannot be redeemed as the spend condition has not been met.",[Ma]:"This code cannot be redeemed as the get condition has not been met.",["invalid"]:"Invalid code entered.",["other"]:"This code cannot be redeemed as it conflicts with promotions/discounts already applied to products in the sale.",["redeemed"]:"The code has already been redeemed.",["redeemed_multi"]:"This code has run out of redemptions.",[Ta]:"This promo code can't be redeemed just yet.",default:"This code couldn't be validated. Please refresh the page and try again."};function ka(e){return Ke.get("/api/2.0/promotions/"+e).then(({data:e})=>e&&e.data).catch(()=>(Qe.warn("[PromotionsResource] Failed to retrieve promotions"),null))}class Ia{constructor(e,t,n,a,i,r,o){this.close=e,this.saleManager=t,this.vpPromotionModal=n,this.registerManager=a,this.vdFeatureManager=i,this.promotionModalService=r,this.retailerSettingsManager=o,s(this,"promoCode",""),this.saleManager.sale.promoCodeStatus=null}addPromoCode(){this.saleManager.addOrRemovePromoCode(this.promoCode).then(e=>{e===Sa?this.close(this.saleManager.promoCodeAdded):(this.saleManager.sale.promoCode="",He.$emit("invalidPromoCode"))})}isPromoCodeNotCorrect(){return Boolean(this.saleManager.sale.promoCodeStatus&&this.saleManager.sale.promoCodeStatus!==Sa)}removeErrorMsg(){this.isPromoCodeNotCorrect()&&(this.saleManager.sale.promoCodeStatus=null)}getValidationErrorMsg(){const e=this.saleManager.sale.promoCodeStatus;return Ea[e]||Ea.default}isStatusInsufficientBuyOrSpend(){const e=this.saleManager.sale.promoCodeStatus;return e===_a||e===wa}isStatusInsufficientGet(){return this.saleManager.sale.promoCodeStatus===Ma}openPromotionModal(){const e=this.saleManager.sale.promoCodePromotionId;if(e)return ka(e).then(e=>{if(e){if(this.vdFeatureManager.get("react_promotion_modal")){const t=this.retailerSettingsManager.get(),n={culture:t.culture,code:t.currency.code,symbol:t.currency.symbol};return this.promotionModalService.openPromotion({promotion:e,lineItemIds:this.saleManager.getLineItemProductIds(),isTaxExclusive:!this.registerManager.isTaxInclusive(),defaultTab:B.PromoCode,currencyDetails:n})}return this.vpPromotionModal.viewProducts({promotion:e,lineItemIds:this.saleManager.getLineItemProductIds(),isTaxExclusive:!this.registerManager.isTaxInclusive(),defaultTab:"PROMOCODE"})}})}showPromotionModalLink(){switch(this.saleManager.sale.promoCodeStatus){case Ca:case ba:case Ta:case _a:case wa:case Ma:return!0;default:return!1}}}Ia.$inject=["close","saleManager","vpPromotionModal","registerManager","vdFeatureManager","promotionModalService","retailerSettingsManager"];class Pa{constructor(e,t,n,a){this.close=e,s(this,"displaySaleStatus",void 0),s(this,"outletName",void 0),this.displaySaleStatus=a({status:t.saleStatus}),this.outletName=t.saleOutletName,n.trackUserEvent({eventName:"Sale Made on Different Outlet Warning"})}}Pa.$inject=["close","options","vdTracking","wrSaleStatusFilter"];class Ra{constructor(e,t,n){this.close=e,this.saleManager=t,s(this,"cashDiscountingRate",void 0),s(this,"saleServiceFee",void 0),this.cashDiscountingRate=n.getDisplayCashDiscountingRate(),this.saleServiceFee=t.sale.totals.saleServiceFee}removeServiceFee(){this.saleManager.removeServiceFeeFromSale().then(()=>this.close())}}Ra.$inject=["close","saleManager","registerManager"];class Aa{constructor(e,t){this.close=e,this.options=t,s(this,"shouldDisableActions",void 0),s(this,"isEmptySale",void 0),s(this,"isMarkedAsUnfulfilled",void 0),s(this,"isReturn",void 0),this.close=e,this.isEmptySale=t.isEmptySale,this.shouldDisableActions=t.shouldDisableActions,this.isMarkedAsUnfulfilled=t.isMarkedAsUnfulfilled,this.isReturn=t.isReturn}}Aa.$inject=["close","options"];class Da{constructor(e,t,n,a){this.options=n,this.vdEscapeStack=a,s(this,"close",void 0),s(this,"sale",void 0),s(this,"outlets",[]),s(this,"internalClose",void 0),this.internalClose=t,this.close=()=>this.internalClose(We.reject()),this.sale=n.sale,this.outlets=n.outlets,this.vdEscapeStack.register(this.close),e.$on("$destroy",()=>this.vdEscapeStack.deregister(this.close))}}Da.$inject=["$scope","close","options","vdEscapeStack"];class Na{constructor(e,t,n,a){this.currentSaleManager=n,this.saleManager=a,s(this,"disconnectRedux",void 0),s(this,"note",null),s(this,"actions",void 0),s(this,"placeholder",void 0),this.disconnectRedux=e.connect(e=>({note:e.currentSale.note}))(e=>{this.note=e.note}),t.$on("$destroy",this.disconnectRedux)}updateNote(){const{note:e}=this;e?this.currentSaleManager.setNote(e):this.currentSaleManager.setNote(null),this.saleManager.saveSale()}}Na.$inject=["$ngRedux","$scope","currentSaleManager","saleManager"];const xa={controller:Na,template:'<textarea\n\tplaceholder="{{ $ctrl.placeholder }}"\n\thas-credit-card\n  vd-textarea="{ min: {{$ctrl.minSize}}, max: 5 }"\n\tname="saleNote"\n\ttype="text"\n\tng-model="$ctrl.note"\n\tng-change="$ctrl.updateNote()"\n  ng-model-options="{ updateOn: \'default blur\', debounce: { \'default\': 300, \'blur\': 0 } }" />\n<has-cc-error-message ng-if="$ctrl.form.saleNote.$error.hasCreditCard" />\n',require:{form:"^form"},bindings:{minSize:"@",placeholder:"@"}};var Oa=At(({item:e,onDelete:t})=>i.createElement("div",{className:"unknown-line-item vd-pt4 vd-pr4 vd-pl9 vd-flex vd-flex--align-start"},i.createElement(q,{className:"wr-input-error-icon",icon:"exclamation-triangle"}),i.createElement("div",{className:"vd-ml4 vd-pb4"},i.createElement("div",{className:"vd-text-label"},e.name),i.createElement("div",{className:"vd-text-supplementary vd-colour-no"},"This product doesn\u2019t exist.",i.createElement("button",{type:"button",className:"vd-ml1 vd-btn vd-btn--link",onClick:()=>t(e)},"Remove?"))),i.createElement("button",{type:"button",className:"vd-btn vd-btn--icon-no unknown-line-item-remove",onClick:()=>t(e)},i.createElement(q,{icon:"trash"}))),["item","onDelete"]);let $a,La;t.module("webregister").run(["$injector",e=>{$a=e,La=e.get("$rootScope")}]);const Fa=(e,t)=>{const[n,s]=i.useState(()=>t(e));return i.useEffect(()=>La.$watch(()=>t(e),s),[t,e]),n},Ua=(e,t)=>{const[n,s]=i.useState(()=>t(e));return i.useEffect(()=>La.$watchCollection(()=>t(e),s),[t,e]),n},Ba=e=>()=>{let t;return void 0===t&&(t=$a.get(e)),t},qa=Ba("vdTracking"),Va=Ba("vdFeatureManager"),Ka=Ba("vdCurrencyFilter"),Ga=Ba("registerManager"),ja=Ba("saleInventoryData"),Qa=Ba("saleManager"),Wa=Ba("currentSaleManager"),Ha=Ba("customerManager"),Ya=Ba("taxManager"),za=Ba("retailerSettingsManager"),Ja=Ba("saleTracker"),Xa=Ba("userManager"),Za=e=>{const t=Xa(),[n,s]=i.useState(()=>t.hasPermission(e));return i.useEffect(()=>{const n=()=>s(t.hasPermission(e));return t.on("loggedInUserChange",n),()=>t.off("loggedInUserChange",n)},[e,t]),n},ei=(e,{decimalPlaces:t,trimInsignificantDigits:n})=>{let s=e;return null!=e&&(s=String(e)),s&&(s=Fn(s,t,n)),s},ti=(e,{allowedPrefix:t,allowedSuffix:n})=>{let s=!1;return(e=String(e).trim()).startsWith("-")&&(s=!0,e=e.slice(1)),t&&e.startsWith(t)&&(e=e.slice(t.length),!s&&e.startsWith("-")&&(s=!0,e=e.slice(1))),n&&e.length>n.length&&e.endsWith(n)&&(e=e.slice(0,-n.length)),e.trim()&&"."!==e||(e="0"),s&&"0"!==e?"-"+e:e},ni=e=>{"Enter"===e.key&&La.$emit("autocomplete:global-search:focus",{isFocusable:!0,focusDelay:200})},si=i.forwardRef((e,t)=>{const{className:n,error:s,onError:a,onValueChange:r,value:o}=e,[l,c]=i.useState(!1),[{inputValue:d,validationError:u},h]=i.useState(()=>({inputValue:ei(o,e),validationError:null}));let m;m=l||u?d:ei(o,e);return i.createElement("input",{value:m,className:V("vd-input","vd-input--text-align-right",{"vd-error":u||s},n),onBlur:()=>{if(c(!1),!u){const t=ti(d,e),n=ei(t,e);h({inputValue:n,validationError:null})}},onFocus:()=>{if(c(!0),!u){const t=ei(o,e);h({inputValue:t,validationError:null})}},onChange:t=>{const n=t.target.value,s=ti(n,e),i=((e,{max:t,min:n})=>{const s=Number(e);return Number.isNaN(s)?Rs:void 0!==n&&s<n?As:void 0!==t&&s>t?Ds:null})(s,e);h({inputValue:n,validationError:i}),a(i||null),i!==Rs&&r(s)},onKeyUp:ni,ref:t,autoComplete:"off",inputMode:"decimal"})});si.displayName="LineItemInput";const ai=At(({lineItem:e,onError:t})=>{const n=Qa(),s=Za(ts.SALE_DISCOUNT),a=Fa(e,e=>e.displayDiscountPercent),r=!s||e.confirmed||e.isReturn||c.vn(e.basePrice).eq(0);return i.createElement("div",{className:"vd-field li-cell-actions-field"},i.createElement("div",{className:"vd-label"},"Discount (%)"),i.createElement("div",{className:"vd-value li-cell-actions-value"},r?i.createElement("div",null,Fn(a)):i.createElement(si,{className:"li-input--discount-percent",allowedSuffix:"%",decimalPlaces:2,min:0,onError:t,onValueChange:s=>{e.displayDiscountPercent=s,n.updateLineItemDiscountPercent({lineItem:e}),t(null)},value:a})))},["lineItem","onError"]),ii=({totals:e})=>{const t=Ga().isTaxInclusive()?e.inclusivePrice:e.exclusivePrice;return i.createElement("span",{className:"wr-li-cell-summary-price-value vd-text-label"},Fn(t))},ri=({totals:e})=>{const t=Ga().isTaxInclusive()?e.inclusiveBasePrice:e.exclusiveBasePrice;return i.createElement(i.Fragment,null,Fn(t,2))},oi=e=>e.isGiftCard(),li=e=>({calculating:e.calculating,hasVariants:e.hasVariants(),giftCardNumber:e.giftCardNumber,isDeletedProduct:e.isDeletedProduct(),name:e.getName(),readonly:oi(e),quantity:e.quantity,totals:e.totals});var ci=At(({hasInvalidInput:e,lineItem:t,isMarkedAsUnfulfilled:n,onKeyPress:s,onRemove:a,onToggle:r})=>{const o=Ga().getActiveOutlet(),l=o&&o.time_zone,{calculating:d,hasVariants:u,giftCardNumber:h,isDeletedProduct:m,name:g,readonly:p,quantity:v,totals:y}=Ua(t,li);return i.createElement("li",{tabIndex:0,className:V("li-cell-summary-container",{"li-cell-summary-container--readonly":p}),onKeyPress:s,onClick:r},i.createElement(q,{className:V("vd-text--secondary wr-expandable-chevron",{"wr-hide-line-item-chevron":p}),icon:"angle-right"}),i.createElement("div",{className:V("li-cell-summary li-cell-summary--quantity",{"li-cell-summary--quantity-negative":c.vn(v).lessThan(0)})},e?i.createElement(q,{icon:"exclamation-triangle",className:"wr-input-error-icon",title:"There is a problem with this item"}):i.createElement("span",{className:"vd-text-label"},n?"0/":"",Fn(v,3,!0))),i.createElement("div",{className:"li-cell-summary li-cell-summary--name-container"},i.createElement("div",{className:"li-cell-summary pro-li-cell-summary-name vd-text-label",title:g},g,u&&i.createElement("div",{className:"vd-text-supplementary"},t.getVariantsDisplayNames()),m&&i.createElement("div",{className:"vd-text-supplementary"},"Deleted on"," ",Un(t.product.deleted_at,"DD MMMM YYYY",l)),h&&i.createElement("div",{className:"vd-text-supplementary"},"Card Number: ",h),t.promotion&&t.promotion.promotionDetails&&t.promotion.promotionDetails.map(e=>i.createElement("div",{key:e.id,className:"vd-text-supplementary"},i.createElement(q,{icon:"ticket",className:"li-cell-actions-promotion-icon"}),i.createElement("span",{className:"pro-promotion-detail-name"},e.name))))),i.createElement("div",{className:"li-cell-summary--totals-container"},d?i.createElement("span",{className:"vd-loader vd-loader--small"}):i.createElement("div",null,i.createElement("div",{className:"li-cell-summary--total-price"},i.createElement(ii,{totals:y})),t.isPriceDiscounted()&&i.createElement("div",{className:"li-cell-summary--total-base-price"},i.createElement(ri,{totals:y})))),t.confirmed?i.createElement("div",{className:"li-cell-summary--confirmed"},i.createElement(q,{icon:"fa-lock",className:"li-cell-actions-locked-icon"})):i.createElement("button",{onClick:a,className:"vd-btn vd-btn--icon-no vd-ml1 li-cell-summary--remove",type:"button"},i.createElement(q,{icon:"trash"})))},["hasInvalidInput","lineItem","isMarkedAsUnfulfilled","onKeyPress","onRemove","onToggle"]);const di=At(({lineItem:e})=>{const t=Fa(e,e=>e.displayMarkupPercent);return i.createElement("div",{className:"vd-field li-cell-actions-field"},i.createElement("div",{className:"vd-label"},"Markup (%)"),i.createElement("div",{className:"vd-value li-cell-actions-value"},Fn(t)))},["lineItem"]),ui=e=>{let{className:t,maxLines:s=0,minLines:a=2}=e,r=n(e,["className","maxLines","minLines"]);const o=i.useRef(null),l=i.useRef(null);return i.useEffect(()=>{const e=o.current,t=window.getComputedStyle(e),n=parseFloat(t.paddingTop)+parseFloat(t.paddingBottom),i=parseFloat(t.lineHeight),r=a*i+n,c=s&&s*i+n;l.current=[r,c]},[a,s]),i.useEffect(()=>{const e=o.current,[t,n]=l.current,s=n?Math.min(e.scrollHeight,n):e.scrollHeight,a=Math.max(s,t);e.classList.toggle("vd-textarea--scrollable",s===n),e.style.height=a+"px"}),i.createElement("textarea",K({},r,{className:V("vd-input","vd-textarea",t),ref:o}))},hi=At(({confirmed:e,note:t,onBlur:n,onChange:s})=>i.createElement("div",{className:"vd-field"},(!e||t)&&i.createElement("div",{className:"vd-label"},"Notes"),i.createElement("div",{className:"vd-value"},e?t&&i.createElement("div",null,t):i.createElement(ui,{spellCheck:!1,value:t,maxLines:1,minLines:1,name:"lineItemNote",onBlur:n,onChange:s&&(e=>s(e.target.value)),placeholder:"Type to add note..."}))),["confirmed","note","onBlur","onChange"]),mi=i.forwardRef(({lineItem:e,onError:t},n)=>{const s=Qa(),a=Za(ts.SALE_DISCOUNT),r=Fa(e,e=>e.displayPrice),o=!a||e.confirmed||e.isReturn;return i.createElement("div",{className:"vd-field li-cell-actions-field"},i.createElement("div",{className:"vd-label"},"Price"),i.createElement("div",{className:"vd-value li-cell-actions-value"},o?i.createElement("div",null,Fn(r)):i.createElement(si,{className:"li-input--price",allowedPrefix:"$",decimalPlaces:2,onError:t,onValueChange:n=>{e.displayPrice=n,s.updateLineItemDisplayPrice({lineItem:e}),t(null)},ref:n,value:r})))});mi.displayName="LineItemPrice";const gi=At(mi,["lineItem","onError","ref"]),pi=({displayQuantity:e,quantity:t})=>({displayQuantity:e,quantity:t}),vi=i.forwardRef(({lineItem:e,onError:t},n)=>{const s=ja(),a=Qa(),r=Za(ts.SALE_RETURN);let o=-9999999999,l=9999999999;e.isReturn&&c.vn(e.originalQuantity).lessThan(0)?(o=e.originalQuantity,l=0):r&&!a.sale.isMarkedAsUnfulfilled()||(o=0);const{displayQuantity:d,quantity:u}=Ua(e,pi),[h,m]=i.useState(null),g=i.useCallback(()=>{a.sale.isMarkedAsUnfulfilled()||!s.shouldValidateInventory(e)||s.hasInventory(e)?c.vn(e.quantity).greaterThan(9999999999)?(m(Ds),t(Ds)):c.vn(e.quantity).lessThan(-9999999999)||(!r||a.sale.isMarkedAsUnfulfilled())&&c.vn(e.quantity).lessThan(0)?(m(As),t(As)):(m(null),t(null)):(m(Ps),t(Ps))},[e,t,r,s,a.sale]);i.useEffect(()=>(s.on(Ns.LINE_ITEM_UPDATE_VALIDATION,g),()=>{s.off(Ns.LINE_ITEM_UPDATE_VALIDATION,g)}),[g,e,t,s]),i.useEffect(()=>{g()},[g,u]);const p=e.confirmed||e.isReturn&&c.vn(e.originalQuantity).lessThan(0)&&!r,v=i.useCallback(t=>{e.displayQuantity=t,a.updateLineItemQuantity({lineItem:e})},[e,a]);return i.createElement("div",{className:"vd-field li-cell-actions-field"},i.createElement("div",{className:"vd-label"},"Quantity"),i.createElement("div",{className:"vd-value li-cell-actions-value"},p?i.createElement("div",null,d):i.createElement(si,{className:"li-input--quantity",decimalPlaces:3,error:h,max:l,min:o,onError:t,onValueChange:v,ref:n,trimInsignificantDigits:!0,value:u})))});vi.displayName="LineItemQuantity";const yi=At(vi,["lineItem","onError","ref"]),fi=({promotionDetails:e})=>i.createElement(i.Fragment,null,e.map((e,t)=>i.createElement("div",{key:t,className:"vd-text-supplementary","data-cy":"sale-summary-promo-data"},i.createElement("div",null,i.createElement(q,{icon:"ticket"})," ",e.name),e.promoCode&&i.createElement("div",{className:"li-cell-summary-promo-code"},i.createElement(q,{icon:"key"})," ",e.promoCode)))),Si=e=>e.length,Ci=e=>({localId:e.localId,adjusted:e.adjusted,quantity:e.quantity,name:e.getName(),variantNames:e.hasVariants()&&e.getVariantsDisplayNames(),giftCardNumber:e.giftCardNumber,promotionDetails:e.promotion&&e.promotion.promotionDetails,totals:e.totals,isPriceDiscounted:e.isPriceDiscounted(),note:e.note}),bi=({lineItem:e})=>{const{localId:t,adjusted:n,quantity:s,name:a,variantNames:r,giftCardNumber:o,promotionDetails:l,totals:c,isPriceDiscounted:d,note:u}=Ua(e,Ci);return i.createElement("li",null,i.createElement("ul",{className:"li-cell li-cell--readonly","data-line-item-id":t,"data-adjusted":n},i.createElement("li",{className:"li-cell-summary-container li-cell-summary-container--readonly"},i.createElement("div",{className:"li-cell-summary-left-group"},i.createElement("div",{className:"li-cell-summary li-cell-summary--quantity vd-text-label"},s),i.createElement("div",{className:"li-cell-summary li-cell-summary--name-container"},i.createElement("div",{className:"li-cell-summary pro-li-cell-summary-name vd-text-label"},a,r&&i.createElement("div",{className:"vd-text-supplementary"},r),o&&i.createElement("div",{className:"vd-text-supplementary"},"Card Number: ",o),l&&i.createElement(fi,{promotionDetails:l})))),i.createElement("div",{className:"li-cell-summary-right-group"},i.createElement("div",{className:"li-cell-summary li-cell-summary--totals"},i.createElement("div",{className:"li-cell-summary--total-price"},i.createElement(ii,{totals:c})),d&&i.createElement("div",{className:"li-cell-summary--total-base-price","data-cy":"line-item-total-base-price"},i.createElement(ri,{totals:c}))))),u&&i.createElement("li",{className:"li-cell-summary-container-notes vd-text-supplementary"},i.createElement("div",{className:"wr-honour-line-breaks"},"Note: ",u))))};var _i=At(({sale:e})=>{const t=e&&e.lineItems||[];return Ua(t,Si),t.length?i.createElement("ul",{className:"sale-summary-list"},t.map(e=>i.createElement(bi,{lineItem:e,key:e.localId}))):null},["sale"]);const wi=new Bs({entityStoreName:"customerGroups",entityName:"customer_groups"});let Mi,Ti,Ei,ki;!function(e){e[e.METHOD=1]="METHOD",e[e.CUSTOMER=2]="CUSTOMER",e[e.ADD=3]="ADD",e[e.DETAILS=4]="DETAILS"}(Mi||(Mi={})),function(e){e.Delivery="Delivery",e.Pickup="Pickup"}(Ti||(Ti={})),function(e){e.MOBILE="mobile",e.PHONE="phone",e.FAX="fax",e.EMAIL="email"}(Ei||(Ei={})),function(e){e.FIRSTNAME="firstName",e.LASTNAME="lastName"}(ki||(ki={}));const Ii=e=>{const t=e&&e.email&&e.email.trim();return!!t&&!t.match(ss)},Pi=e=>{if(e){if(e.mobile)return Ei.MOBILE;if(e.phone)return Ei.PHONE;if(e.fax)return Ei.FAX}return Ei.MOBILE},Ri=e=>{const t=[];return e&&Object.values(Ei).forEach(n=>{const s=e[n];s&&s.trim()&&t.push(n)}),t.length>0},Ai=e=>{Object.values(Ei).forEach(t=>{const n=e[t];e[t]=n&&n.trim()})},Di=["Method","Customer","Fulfillment Details"],Ni=["Method","Customer","Add","Fulfillment Details"],xi=(e,t)=>{const n=t?Ni:Di;return e!==Mi.DETAILS||t?n[e-1]:n[e-2]},Oi=({step:e,isAddingCustomer:t=!1})=>i.createElement(G,{breadcrumbs:t?Ni:Di,activeBreadcrumb:xi(e,t),separator:">"});let $i;!function(e){e.Delivery="Delivery",e.Pickup="Pickup"}($i||($i={}));const Li=({type:e,onTypeChange:t})=>i.createElement(i.Fragment,null,i.createElement("h4",{className:"vd-text-label"},"Fulfillment"),i.createElement("div",{className:"vd-flex vd-mt2"},i.createElement(j,{name:"fulfilType",checked:e===$i.Delivery,onChange:()=>t($i.Delivery),className:"fulfillment-type-seg-control"},"Delivery"),i.createElement(j,{name:"fulfilType",checked:e===$i.Pickup,onChange:()=>t($i.Pickup),className:"fulfillment-type-seg-control"},"Pickup")));Li.displayName="FulfillmentSelect";const Fi=({outlets:e,className:t,onOutletChange:n,currentOutlet:s})=>i.createElement("div",{className:V("outlet-to-fulfil-from",t)},i.createElement("h4",{className:"vd-text-label"},"Outlet to fulfill from"),i.createElement("select",{className:"vd-select vd-mt2",onChange:e=>{n(e.currentTarget.value)},defaultValue:s},e.map(e=>i.createElement("option",{key:e.id,value:e.id},e.name))));Fi.displayName="OutletToFulfilFrom";const Ui=({onStepChange:e,onClose:t,type:n,outlets:s,onTypeChange:a,onOutletChange:r,currentOutlet:o})=>{const l=Va().get("fulfill_from_another_outlet");return i.createElement(Q,{header:i.createElement("div",null,i.createElement(Oi,{step:Mi.METHOD}),i.createElement("h2",{className:"vd-text-heading vd-mt4 vd-mb3"},"Choose how this order will be fulfilled."),i.createElement("p",{className:"vd-p"},"Inventory will be reserved for all items in the sale.")),content:i.createElement(i.Fragment,null,i.createElement(Li,{type:n,onTypeChange:a}),l&&i.createElement(Fi,{outlets:s,onOutletChange:r,className:"vd-mt5",currentOutlet:o})),onClose:()=>t(),actions:i.createElement("div",{className:"vd-btn-group vd-mt10"},i.createElement(W,{onClick:()=>t(),variant:"supplementary"},"Don\u2019t Mark"),i.createElement(W,{onClick:()=>e(Mi.CUSTOMER),variant:"do"},"Next"))})};Ui.displayName="Step1";const Bi=e=>i.createElement(z,{apiCustomer:e,size:"x-small"}),qi=({onSelect:e,onAdd:t,placeholder:n,searchValue:s=""})=>{const[a,r]=i.useState(s.trim());return i.createElement(H,{leftIcon:"fa fa-user",fetchSuggestions:async e=>{const t=e.trim();r(t);const{data:n,related:s}=await Y("/api/2.0/suggest?type=customer&page_size=30&include_related=true&q="+t);return n.map(e=>s.customers[e.id])},onChange:e,renderSuggestion:Bi,placeholder:n,selectedValue:s,actionBar:i.createElement("div",{className:"customer-suggestion-footer vd-popover-list-item"},i.createElement(W,{link:!0,className:"vd-popover-list-item",onClick:t},i.createElement("span",{className:"vd-colour-do vd-suggestion-query-container"},i.createElement(q,{icon:"fa-plus-circle",className:"vd-mr2"}),a?`Add '${a}' as a new customer`:"Add a new customer")))})},Vi=(e,t)=>e?e[t]:"",Ki=({customer:e,onChange:t,defaultOption:n})=>{const[s,a]=i.useState(n),[r,o]=i.useState(Vi(e,n));return i.createElement("div",{className:"vd-value"},i.createElement("div",{className:"vd-select-group"},i.createElement("select",{className:"vd-select",defaultValue:n,onChange:t=>{a(t.currentTarget.value),o(Vi(e,t.currentTarget.value))}},i.createElement("option",{label:"Mobile",value:Ei.MOBILE},"Mobile"),i.createElement("option",{label:"Phone",value:Ei.PHONE},"Phone"),i.createElement("option",{label:"Fax",value:Ei.FAX},"Fax")),i.createElement("input",{className:"vd-input",placeholder:"Enter number",name:s,value:r||"",onChange:e=>{o(e.currentTarget.value),t(e)}})))},Gi=({onStepChange:e,onClose:t,onAdd:n,onSelect:s,onContactChange:a,type:r,newCustomer:o,selectedCustomer:l,group:c})=>{return i.createElement(Q,{header:i.createElement("div",null,i.createElement(Oi,{step:Mi.CUSTOMER}),i.createElement("h2",{className:"vd-text-heading vd-mt4 vd-mb3"},"Contact info for the"," ",r===Ti.Delivery?"delivery":"pickup","."),i.createElement("p",{className:"vd-p"},"Enter details to contact the customer about this\xa0order.")),content:i.createElement(i.Fragment,null,i.createElement("h4",{className:"vd-text-label vd-mb2 vd-pl1"},"Customer"),l?i.createElement(i.Fragment,null,i.createElement("div",{className:"vd-flex vd-flex--justify-between vd-flex--align-center vd-pl1"},i.createElement(z,{apiCustomer:l,group:c,size:"small"}),i.createElement(W,{modifier:"icon",variant:"no",onClick:()=>s(null)},i.createElement(q,{icon:"fa-trash",className:"fa fa-trash"}))),i.createElement("div",{className:"vd-g-row vd-mt4"},i.createElement("div",{className:"vd-g-col vd-g-xs-12 vd-g-s-6 vd-pl1 vd-pr1"},i.createElement("div",{className:"vd-text-label vd-mb2 vd-mt2"},"Contact Number"),i.createElement(Ki,{customer:l,onChange:a,defaultOption:Pi(l)})),i.createElement("div",{className:"vd-g-col vd-g-xs-12 vd-g-s-6 vd-pl1 vd-pr1"},i.createElement("div",{className:"vd-text-label vd-mb2 vd-mt2"},"Email"),i.createElement("div",{className:"vd-value"},i.createElement("input",{className:V("vd-input",{"vd-input--error":Ii(l)}),placeholder:"Enter email",value:l.email||"",onChange:a,name:Ei.EMAIL}))))):i.createElement("div",{className:"vd-pl1"},i.createElement(qi,{placeholder:"Select or add a customer",onAdd:n,onSelect:s,searchValue:o&&o.firstName||void 0}))),onClose:()=>t(),actions:i.createElement("div",{className:"vd-btn-group"},i.createElement(W,{onClick:()=>e(Mi.METHOD),variant:"supplementary"},"Back"),i.createElement(W,{onClick:()=>e(Mi.DETAILS),disabled:(d=l,Boolean(!d)||!Ri(d)||Ii(d)),variant:"do"},"Next"))});var d};Gi.displayName="Step2";const ji=({onStepChange:e,onClose:t,handleSaleNoteChange:n,type:s,newCustomer:a,selectedCustomer:o,group:l,fulfillmentOutletID:c,contactChanged:d,note:u})=>{const h=Qa(),m=Wa(),g=Ha(),p=ja(),v=Va(),y=Ja();let f=!1;const S=v.get("customer_groups"),C=v.get("fulfill_from_another_outlet"),[b,_]=i.useState(!1),w=Ga().getActiveRegister().print_note_on_receipt,M=()=>{s===Ti.Delivery?h.unfulfilledDelivery():h.unfulfilledPickUp(),p.emit(Ns.LINE_ITEM_UPDATE_VALIDATION),C&&c&&(h.sale.fulfillmentOutletID=c)},T=()=>new Promise((e,t)=>{const n=((e,t)=>{if(e){const n={first_name:e.firstName&&e.firstName.trim(),last_name:e.lastName&&e.lastName.trim(),mobile:e.mobile,email:e.email,phone:e.phone,fax:e.fax,customer_group_id:t.id};return Ai(n),n}return null})(a,l);if(n)return _(!0),g.saveNewCustomer(n).then(e=>(f=!0,h.addCustomer(e))).then(()=>{e()}).catch(()=>t("can not save customer"))}),E=()=>new Promise((e,t)=>(_(!0),d?(Ai(o),g.updateCustomer(o).then(e=>{h.addCustomer(e)}).then(e).catch(()=>t("can not save customer"))):h.sale.customer&&h.sale.customer.id===o.id?e():h.addCustomer(o).then(()=>e()))),k=a&&r({name:`${a[ki.FIRSTNAME]||""} ${a[ki.LASTNAME]||""}`},a);return i.createElement(Q,{header:i.createElement("div",null,i.createElement(Oi,{step:Mi.DETAILS,isAddingCustomer:Boolean(a)}),i.createElement("h2",{className:"vd-text-heading vd-mt4 vd-mb3"},"Add",s===Ti.Delivery?" shipping ":" pickup ","details for this sale."),i.createElement("p",{className:"vd-p"},"Record the",s===Ti.Delivery?" delivery address ":" pickup information ","in the sale note.")),onClose:()=>t(!1),content:i.createElement(i.Fragment,null,i.createElement(z,{customer:k,apiCustomer:o,group:S?l:void 0,size:"small"}),i.createElement("div",{className:"vd-mt6"},i.createElement("span",{className:"vd-text-label vd-mr2"},w?"Sale Note":"Staff Note"),i.createElement("span",{className:"vd-text-supplementary"},w?"Customers will be able to see this note on their receipt.":"Customers will not see this note on their receipt.")),i.createElement("div",{className:"vd-mt3"},i.createElement("textarea",{defaultValue:u,rows:5,className:"vd-input vd-textarea",onChange:n}))),actions:i.createElement("div",{className:"vd-btn-group"},i.createElement(W,{onClick:()=>e(a?Mi.ADD:Mi.CUSTOMER),variant:"supplementary",disabled:b},"Back"),i.createElement(W,{onClick:()=>{(o?E:T)().then(()=>{M(),u!==h.sale.note&&m.setNote(u),h.saveSale(),y.addTrackingData({customerCreated:f,saleId:h.sale.localId}),t(!0)}).catch(e=>{_(!1),e&&"can not save customer"!==e&&J.negative("Failed to mark as unfulfilled, please try again.")})},variant:"do",loading:b},"Mark"))})};ji.displayName="Step3";const Qi=e=>{const t=[];let n=!1;return e&&(Object.values(ki).forEach(n=>{const s=e[n];s&&s.trim()&&t.push(n)}),Ri(e)&&t.length>0&&(n=!0)),!n||Ii(e)},Wi=({onStepChange:e,onClose:t,onChange:n,type:s,newCustomer:a})=>i.createElement(Q,{header:i.createElement("div",null,i.createElement(Oi,{step:Mi.ADD,isAddingCustomer:Boolean(a)}),i.createElement("h2",{className:"vd-text-heading vd-mt4 vd-mb3"},"Contact info for the"," ",s===Ti.Delivery?"delivery":"pickup","."),i.createElement("p",{className:"vd-p"},"Enter details to contact the customer about this\xa0order.")),content:i.createElement(i.Fragment,null,i.createElement("div",{className:"vd-g-row"},i.createElement("div",{className:"vd-g-col vd-g-xs-12 vd-g-s-6 vd-pl1 vd-pr1"},i.createElement("div",{className:"vd-text-label vd-mb2 vd-mt2"},"First Name"),i.createElement("div",{className:"vd-value"},i.createElement("input",{className:"vd-input",placeholder:"Enter first name",value:a.firstName||"",onChange:n,name:ki.FIRSTNAME}))),i.createElement("div",{className:"vd-g-col vd-g-xs-12 vd-g-s-6 vd-pl1 vd-pr1"},i.createElement("div",{className:"vd-text-label vd-mb2 vd-mt2"},"Last Name"),i.createElement("div",{className:"vd-value"},i.createElement("input",{className:"vd-input",placeholder:"Enter last name",value:a.lastName||"",onChange:n,name:ki.LASTNAME})))),i.createElement("div",{className:"vd-g-row vd-mt4"},i.createElement("div",{className:"vd-g-col vd-g-xs-12 vd-g-s-6 vd-pl1 vd-pr1"},i.createElement("div",{className:"vd-text-label vd-mb2 vd-mt2"},"Contact Number"),i.createElement(Ki,{customer:a,onChange:n,defaultOption:Pi(a)})),i.createElement("div",{className:"vd-g-col vd-g-xs-12 vd-g-s-6 vd-pl1 vd-pr1"},i.createElement("div",{className:"vd-text-label vd-mb2 vd-mt2"},"Email"),i.createElement("div",{className:"vd-value"},i.createElement("input",{className:V("vd-input",{"vd-input--error":Ii(a)}),placeholder:"Enter email",value:a.email||"",onChange:n,name:Ei.EMAIL}))))),onClose:()=>t(),actions:i.createElement("div",{className:"vd-btn-group"},i.createElement(W,{onClick:()=>e(Mi.CUSTOMER),variant:"supplementary"},"Back"),i.createElement(W,{onClick:()=>e(Mi.DETAILS),disabled:Qi(a),variant:"do"},"Next"))});Wi.displayName="Step2Add";const Hi=(e,t)=>!(!e||!t)&&Object.values(Ei).some(n=>(e[n]&&e[n].trim())!==(t[n]&&t[n].trim())),Yi=({close:e,sale:t,outlets:n})=>{const[s,a]=i.useState(1),[o,l]=i.useState(Ti.Delivery),[c,d]=i.useState(null),[u,h]=i.useState(null),[m,g]=i.useState(null),[p,v]=i.useState(void 0);Va().get("customer_groups")&&u&&!p&&wi.get(u.customer_group_id).then(e=>{e&&v({id:e.id,name:e.name})}),c&&!p&&wi.all().then(e=>{if(e){const t=e.find(e=>"1111111111"===e.group_id);t&&v({id:t.id,name:t.name})}});const[y,f]=i.useState(null),[S,C]=i.useState(t.note),b=Ga().getActiveOutlet().id;i.useEffect(()=>{t&&t.customer&&"WALKIN"!==t.customer.customer_code&&(g(t.customer),Ai(t.customer),h(t.customer))},[t,h]);const _=e=>{l(e)},w=e=>{a(e)},M=e=>{f(e)},T=e=>{const{value:t}=e.target;C(t||"")},E=t=>{e(We.resolve(t))},k=()=>{const e=document.querySelector(".react-modals-container .vd-autocomplete-input"),t=null==e?void 0:e.value;if(t){const e=cs(t);d(t=>r(r({},t),e)),h(null),g(null),w(Mi.ADD)}},I=e=>{v(void 0),e?(h(e),g(e),d(null)):h(null)},P=e=>{e.preventDefault();const{value:t,name:n}=e.target;n&&d(e=>r(r({},e),{},{[n]:t}))},R=e=>{e.preventDefault();const{value:t,name:n}=e.target;n&&h(e=>r(r({},e),{},{[n]:t}))};return i.createElement("div",null,(()=>{switch(s){case Mi.METHOD:return i.createElement(Ui,{onStepChange:w,onTypeChange:_,onOutletChange:M,onClose:E,type:o,outlets:n,currentOutlet:y||b});case Mi.CUSTOMER:return i.createElement(Gi,{onStepChange:w,onClose:E,onAdd:k,onSelect:I,onContactChange:R,type:o,newCustomer:c,selectedCustomer:u,group:p});case Mi.ADD:return i.createElement(Wi,{onStepChange:w,onClose:E,onChange:P,type:o,newCustomer:c});case Mi.DETAILS:return i.createElement(ji,{onStepChange:w,onClose:E,handleSaleNoteChange:T,note:S,type:o,fulfillmentOutletID:b===y?null:y,newCustomer:c,selectedCustomer:u,group:p,contactChanged:Hi(u,m)});default:return null}})())};Yi.displayName="MarkAsUnfulfilledModal";const zi=At(Yi,["close","sale","outlets"]);class Ji{constructor(e,t,n,a){this.close=e,this.trainingModeManager=n,s(this,"defaultReceipt",void 0),s(this,"receiptTemplates",[]),t.all().then(e=>{e.forEach(e=>{const t={name:e.name,id:e.id};t.id===a.getActiveRegister().receipt_template_id?this.defaultReceipt=t:this.receiptTemplates.push(t)})}).catch(e=>{Qe.warn("Failed to retrieve templates from receiptTemplates store",e)})}selectReceipt(e){this.close({selectedReceipt:e,defaultTemplate:e===this.defaultReceipt})}}Ji.$inject=["close","receiptSettingsStore","trainingModeManager","registerManager"];var Xi='<vd-popover class="wr-receipt-selection-popover" vd-focus-trap>\n  <ul class="vd-popover-list">\n    <li class="wr-receipt-selection-header">\n      <div class="vd-text-label">Receipt Templates</div>\n    </li>\n    <li>\n      <a href="javascript:void(0)" ng-click="$ctrl.selectReceipt($ctrl.defaultReceipt)" class="vd-popover-list-item">\n          {{::$ctrl.defaultReceipt.name}} <vd-flag>DEFAULT</vd-flag>\n      </a>\n    </li>\n    <li ng-repeat="receiptName in $ctrl.receiptTemplates | orderBy: \'name\'">\n      <a href="javascript:void(0)" ng-click="$ctrl.selectReceipt(receiptName)" class="vd-popover-list-item">\n          {{receiptName.name}}\n      </a>\n    </li>\n  </ul>\n</vd-popover>';class Zi{constructor(e,t,n,a,i,r){this.saleManager=e,this.vdPopover=t,this.receiptSettingsStore=n,this.registerManager=a,this.posStateManager=i,this.vdTracking=r,s(this,"email",""),s(this,"shouldSendEmailReceipt",!1),s(this,"receipt",void 0),s(this,"register",void 0),s(this,"sale",void 0),this.register=this.registerManager.getActiveRegister(),this.receipt={name:"",id:""};const o=this.receiptSettingsStore.get(this.register.receipt_template_id).then(e=>{e?this.receipt=e:this.vdTracking.trackError("Failed to fetch receipt templates",{data:{templateId:this.register.receipt_template_id}})}),l=this.saleManager.init().then(()=>{this.sale=this.saleManager.sale,void 0!==this.sale?(this.sale.customer&&this.sale.customer.email&&(this.email=this.sale.customer.email),this.register&&this.sale&&(this.shouldSendEmailReceipt=!this.posStateManager.getTrainingModeEnabled()&&this.register.email_receipt)):Qe.warn("Could not find sale to attach to receipt.")});We.all([o,l]).then(()=>this.updateSaleValues())}updateSaleValues(){this.sale&&(this.shouldSendEmailReceipt?(this.sale.receiptEmailAddress=this.email,this.sale.receiptID=this.receipt.id):(this.sale.receiptEmailAddress="",this.sale.receiptID=""),this.saleManager.saveSale())}selectReceipt(e){this.vdPopover.open({trigger:e.currentTarget,template:Xi,controller:"ReceiptSelectionPopoverController",hasPopoverList:!0,direction:"center",openAsModalAtViewport:"xsmall"}).then(e=>{e.closed.then(e=>{if(e){const{selectedReceipt:t}=e;t.id!==this.receipt.id&&(this.receipt=t,this.updateSaleValues())}})})}}Zi.$inject=["saleManager","vdPopover","receiptSettingsStore","registerManager","posStateManager","vdTracking"];const er={template:'<div class="vd-card">\n\t<div class="vd-ma5 vd-flex">\n\t\t<div class="vd-mr4">\n\t\t\t<vd-switch modifier="small" ng-model="$ctrl.shouldSendEmailReceipt" ng-change="$ctrl.updateSaleValues()"></vd-switch>\n\t\t</div>\n\t\t<div class="vd-align-left">\n\t\t\t<div class="vd-mb2 vd-text-body">\n\t\t\t\tEmail a receipt to <b>{{$ctrl.email}}</b>\n\t\t\t</div>\n\t\t\t<div>Using <a ng-click="$ctrl.selectReceipt($event)" class="vd-link">{{$ctrl.receipt.name}}<i class="fa fa-caret-down vd-ml1" aria-hidden="true"></i></a></div>\n\t\t</div>\n\t</div>\n</div>\n',controller:Zi},tr=[{TrialMessageHeadLine:"You made a sale and printed this receipt",TrialMessage:"Did you know you can change your receipt template under Setup > Outlets and Registers?\n      Better yet, you can default to email receipts and help save the planet!"},{TrialMessageHeadLine:"Make more money with gift cards!",TrialMessage:"Did you know you can enable gift cards under Setup > Gift Cards? 65% of gift card redeemers\n      spend almost 40% above the value of their card! That's free money."},{TrialMessageHeadLine:"Grow repeat business with a loyalty program!",TrialMessage:"You can encourage customers to come back again, and again, by letting them earn loyalty\n      points that they can spend in store. Enable under Setup > Loyalty."},{TrialMessageHeadLine:"Seamlessly integrate your accounting",TrialMessage:"Connecting Vend to Xero is the best way to run retail in the cloud. Start sending all\n      financial transactions to Xero today by going to Setup > Apps."},{TrialMessageHeadLine:"Say goodbye to annual stock takes",TrialMessage:"Staying up until 2am to do a stocktake is a thing of the past with Vend's Partial Inventory\n      Counts. Spread the work over your employees' downtime instead of pulling an all-nighter."},{TrialMessageHeadLine:"Order in, only what sells out",TrialMessage:"Inventory that sits on the floor and doesn't sell is costing you money. Go to Reporting >\n      Inventory and see how the Product Performance Report makes sure you only order products that\n      sell, so you aren't leaving money lying around."}],nr={displayValue:!1,format:"CODE128",height:35,lineColor:"#000",width:2},sr={CompanyName:"",CustomerCode:"",Email:"",FirstName:"",FormattedOnAccountBalance:"$0.00",FormattedPostalAddress:"",FormattedStoreCredit:"",HasCustomerContactDetails:!1,LastName:"",Mobile:"",Phone:"",LoyaltyBalance:0,LoyaltyEnabled:!1,WalkIn:!0},ar="ddd, D MMM YY h:mma",ir="D MMM YYYY h:mma",rr="ddd, D MMM YY",or={Barcode:"",IsReprint:!1,ListItems:[],Loyalty:{},Note:"",DisplayCustomerDetails:!0,DisplayCustomerBalances:!0,DisplayCustomerAddress:!1,DisplayCustomerCompany:!1,DisplayCustomerEmail:!1,DisplayCustomerName:!1,DisplayCustomerPhone:!1,DisplayLoyaltyBalance:!1,DisplayLoyaltyEarned:!1,DisplayLoyaltyLink:!1,DisplayLoyaltySection:!1,DisplayStoreCredit:!1,DisplayGiftCardInformation:!1,DisplayCustomerCode:!0,DisplayProductName:!0,DisplayProductSKU:!1,DisplayTaxPerLineItem:!1};const lr={APPROVE:'<header class="vd-dialog-header">\n  <vd-header category="dialog">\n   Confirm customer signature to accept payment.\n  </vd-header>\n</header>\n\n<div class="vd-dialog-content">\n  <div ng-style="{ \'background-image\': \'url({{$ctrl.signatureSrc}})\' }" class="swiper-signature vd-pa3"></div>\n</div>\n\n<div class="vd-dialog-actions vd-btn-group">\n  <button ng-click="$ctrl.declineSignature()" class="vd-btn vd-btn--supplementary">Decline</button>\n  <button ng-click="$ctrl.close($ctrl.paymentTransaction)" class="vd-btn vd-btn--do">Confirm and Accept</button>\n</div>\n',PARTIAL_APPROVE:'<header class="vd-dialog-header">\n  <vd-header category="dialog">\n    Only {{$ctrl.paymentTransaction.tenders[0].amount | vdCurrency}} of this payment has been approved.\n  </vd-header>\n</header>\n\n<div class="vd-dialog-content">\n  <p class="vd-p" vd-no-widow>\n    Continue to take payment for the remaining balance, or refund this amount to take payment another way of discard the sale.\n  </p>\n</div>\n\n<div class="vd-dialog-actions vd-btn-group">\n  <button ng-click="$ctrl.reversePartialPayment()" class="vd-btn vd-btn--supplementary">Refund Partial Payment</button>\n  <button ng-click="$ctrl.close($ctrl.paymentTransaction)" class="vd-btn vd-btn--do">Continue</button>\n</div>\n',ERROR:'<header class="vd-dialog-header">\n  <vd-header category="dialog">\n   {{$ctrl.getErrorHeader()}}\n  </vd-header>\n</header>\n\n<div class="vd-dialog-content">\n  <p class="vd-p">\n    {{$ctrl.getErrorContent() | vdRemoveWidow}}\n  </p>\n  <p ng-if="$ctrl.econduitErrorMessage" class="vd-p">\n    {{ $ctrl.getAdditionalErrorContent() }}\n  </p>\n</div>\n\n<div class="vd-dialog-actions">\n  <button class="vd-btn vd-btn--do" ng-click="$ctrl.close()">Got it, thanks!</button>\n</div>\n',FAILED_SIGNATURE:'<header class="vd-dialog-header">\n  <vd-header category="dialog">\n   Confirm customer signature to accept payment.\n  </vd-header>\n</header>\n\n<div class="vd-dialog-content">\n  <p ng-if="$ctrl.workflow !== $ctrl.WORKFLOWS.FAILED_SIGNATURE_APPROVE" class="vd-p" vd-no-widow>\n    Print a copy of the receipt for the customer to sign so you can confirm their signature.\n  </p>\n\n  <p ng-if="$ctrl.workflow === $ctrl.WORKFLOWS.FAILED_SIGNATURE_APPROVE" class="vd-p" vd-no-widow>\n    Compare the signature on the receipt to the one on their card to accept the payment.\n  </p>\n</div>\n\n<div class="vd-dialog-actions vd-btn-group">\n  <button class="vd-btn vd-btn--supplementary" ng-click="$ctrl.declineSignature()">Decline</button>\n  <button ng-if="$ctrl.workflow === $ctrl.WORKFLOWS.FAILED_SIGNATURE_APPROVE"\n    class="vd-btn vd-btn--do"\n    ng-click="$ctrl.confirmAndAccept()">\n    Confirm and Accept\n  </button>\n\n  <button ng-if="$ctrl.workflow !== $ctrl.WORKFLOWS.FAILED_SIGNATURE_APPROVE"\n    class="vd-btn vd-btn--do"\n    ng-click="$ctrl.printSignatureReceipt()">\n    Print Signature Receipt\n  </button>\n</div>\n',PROCESSING:'<div class="vd-dialog-content swiper-processing">\n  <div class="vd-align-center">\n    <img ng-if-start="$ctrl.workflow === $ctrl.WORKFLOWS.PROCESSING"\n      ng-src="{{ \'payments/insert-card-v1.svg\' | vdImageCdnPath }}"\n      class="swiper-insert-card vd-mb5">\n    <div ng-if-end class="vd-text-heading" vd-no-widow>\n      Waiting for card\u2026\n    </div>\n\n    <div ng-if-start="$ctrl.workflow === $ctrl.WORKFLOWS.REVERSING" class="vd-loader vd-mb3"></div>\n    <div ng-if-end class="vd-text-heading">\n      Cancelling\u2026\n    </div>\n  </div>\n</div>\n'},cr="APPROVED",dr="APPROVED_PIN",ur="APPROVED_SIGNATURE",hr="CANCELLED",mr="CANCELLED_BAD_CARD",gr="CANCELLED_BUSY",pr="COMPLETED",vr="DECLINED",yr="PROCESSING",fr="REFUNDED",Sr="TIMEOUT",Cr={CANCELLED:"CANCELLED",CANCELLED_BUSY:"CANCELLED BUSY",CANCELLED_BAD_CARD:"CANCELLED BAD CARD",DECLINED:"DECLINED",DECLINED_CASHIER:"DECLINED CASHIER",NO_TERMINAL:"NO TERMINAL",TIMEOUT:"TERMINAL TIMEOUT",NO_PAIRING:"NO PAIRING",INVALID_AMOUNT_INPUT:"INVALID AMOUNT INPUT",INVALID_NEGATIVE_AMOUNT_INPUT:"INVALID NEGATIVE AMOUNT INPUT",UNAVAILABLE_REVERSAL_STATUS:"UNAVAILABLE REVERSAL STATUS",UNKNOWN:"UNKNOWN",ECONDUIT_ERROR:"ECONDUIT ERROR",OVER_REFUND:"OVER REFUND"},br=y({},{APPROVE:"APPROVE",PARTIAL_APPROVED:"PARTIAL_APPROVED",FAILED_SIGNATURE:"FAILED SIGNATURE",FAILED_SIGNATURE_APPROVE:"FAILED SIGNATURE APPROVE",PROCESSING:"PROCESSING",REVERSING:"REVERSING"},Cr),_r={[br.CANCELLED]:{header:"This payment has been cancelled.",content:"The transaction was cancelled, try again."},[br.CANCELLED_BAD_CARD]:{header:"This payment has been declined.",content:"The card that was presented is unsupported by the processor and cannot be accepted, try a different card."},[br.CANCELLED_BUSY]:{header:"This payment has been cancelled.",content:"The terminal was busy and rejected the transaction, wait a moment then try again."},[br.DECLINED_CASHIER]:{header:"This payment has been cancelled.",content:"No payment has been taken because you\u2019ve just declined this transaction. If you feel suspicious about a\n      cardholder, please refer to your store policy or get in touch with your manager."},[br.DECLINED]:{header:"This payment has been cancelled.",content:"The transaction was declined, try again or use a different card."},[br.NO_TERMINAL]:{header:"This register is not set up to use this payment type.",content:"The register needs to be paired with a terminal to be able to use this payment type.\n      Please choose another payment type to complete this sale."},[br.TIMEOUT]:{header:"This payment has been cancelled.",content:"No payment has been taken because this transaction took too long."},[br.INVALID_AMOUNT_INPUT]:{header:"Something went wrong with this payment.",content:"Sorry, that didn\u2019t work. Payments must have a value greater than $0.00."},[br.INVALID_NEGATIVE_AMOUNT_INPUT]:{header:"Something went wrong with this payment.",content:"Sorry, that didn\u2019t work. Payments must have a value greater than $0.00.\n    Refunds can be performed by returning sales in Sales History."},[br.UNAVAILABLE_REVERSAL_STATUS]:{header:"Something went wrong with this payment.",content:"Sorry, that didn\u2019t work. We were unable to reverse this transaction.\n    You can try again, or process a return from Sales History."},[br.ECONDUIT_ERROR]:{header:"Something went wrong with this payment.",content:"You can try this payment type again, or choose another payment type to complete the sale.\n      If this keeps happening, please contact your processor."},[br.OVER_REFUND]:{header:"Choose another payment type to refund this sale.",content:"The Credit Card payment type can only be used to refund sales which were fully paid using this payment type."},[br.UNKNOWN]:{header:"Something went wrong with this payment.",content:"Something went wrong. You can try again, or complete this sale with another payment type."}},wr={1302:Cr.NO_TERMINAL,1400:Cr.UNKNOWN,1401:Cr.UNKNOWN,1402:Cr.INVALID_AMOUNT_INPUT,1403:Cr.INVALID_NEGATIVE_AMOUNT_INPUT,13e4:Cr.NO_TERMINAL,130008:Cr.NO_TERMINAL,130010:Cr.UNAVAILABLE_REVERSAL_STATUS,180002:Cr.OVER_REFUND,19e4:Cr.ECONDUIT_ERROR};class Mr{constructor(e,t,n,a,i,r,o){this.barcodeService=e,this.wrUserNameFilter=t,this.retailerSettingsManager=n,this.registerManager=a,this.loyaltyManager=i,this.customerBalancesManager=r,this.wrCalculateGiftcardExpiryFilter=o,s(this,"renderedTemplate",void 0),s(this,"receiptCSS",void 0),s(this,"receiptSettingsTemplate",void 0),s(this,"customer",void 0),s(this,"data",void 0),s(this,"options",void 0),s(this,"isStandardInvoice",!1),s(this,"vdCurrencyFilter",Ve("vdCurrency")),s(this,"isTaxInclusive",!0),s(this,"wrMakeAbsolute",Ve("wrMakeAbsolute"))}$onInit(){this.receiptCSS=Ye.trustAsCss(`@media print { ${this.options.styling} }`),this.renderedTemplate=this.createMustacheReceipt()}createMustacheReceipt(){return this.createReceiptHash(this.data,this.options),X.render(this.options.templateHtml,this.receiptSettingsTemplate)}createReceiptHash(e,t){const{sale:n,outlet:s,register:a,giftCardsInfo:i,receiptHtmlExtra:o,trainingModeEnabled:l,paymentData:d}=e,{settings:u,default_type:h}=t;this.customer=n.customer,this.isStandardInvoice="a4"===h,this.isTaxInclusive="inclusive"===s.display_prices;const m=ir,g=n.hasCashDiscountingServiceFee(this.registerManager),p=this.setDisplaySettings(u);if(this.receiptSettingsTemplate=r(r({},p),{},{Customer:this.setCustomer(this.customer,n.customerBalances),DateTime:Un(n.saleDate,m,s.time_zone),DisplayCashDiscount:g&&c.vn(n.totals.cashDiscount).isNeg(),DisplayServiceFee:g,InvoiceNumber:n.getFormattedReceiptNumberDetails(),IsParked:n.isParked(),OutletName:s.name,ReceiptHTMLExtra:o,RegisterName:a.name,RegisterShowNotes:a.print_note_on_receipt,Totals:this.setTotals(n,p),UserDisplayName:this.wrUserNameFilter(n.user),IsInTrainingMode:l}),this.receiptSettingsTemplate.DisplayCustomerDetails&&(this.setCustomerDetailsDisplayValues(this.receiptSettingsTemplate.Customer,this.retailerSettingsManager.isStoreCreditEnabled(),p),this.receiptSettingsTemplate.DisplayStoreCredit)){const e=this.customerBalancesManager.calculateStoreCreditBalance(n);this.receiptSettingsTemplate.Customer.FormattedStoreCredit=this.vdCurrencyFilter(e)}const{TotalSavings:v}=this.setItems(n,s,a,i,this.receiptSettingsTemplate.DisplayTaxPerLineItem);let y=v;if(n.discount){const{TotalSavings:e}=this.setSaleDiscount(n,p,y);y=e}y.gt(0)&&(this.receiptSettingsTemplate.Totals.TotalSavings=this.vdCurrencyFilter(y.toNumber()));const f=this.setTaxes(n);(n.discount||this.receiptSettingsTemplate.DisplayTax)&&(this.receiptSettingsTemplate.DisplaySubtotal=!0);const S=n.payments.reduce((e,t)=>c.add(e,c.vn(t.tipAmount)),0);c.vn(S).gt(0)&&(this.receiptSettingsTemplate.DisplayTipAmount=!0,this.receiptSettingsTemplate.Totals.FormattedTipAmount=this.vdCurrencyFilter(S));const C=this.setPayments(n,s,f.TotalTax,i,p,d,S);this.receiptSettingsTemplate.Totals=r(r(r({},this.receiptSettingsTemplate.Totals),C),f),C.Payments.some(e=>e.Transaction)&&(this.receiptSettingsTemplate.ReceiptHTMLExtra=null),a.print_note_on_receipt&&""!==n.note&&(this.receiptSettingsTemplate.Note=n.note.replace(/\n/g,"<br>")),this.setLoyalty(n,this.receiptSettingsTemplate.Customer,p);const b=n.getFormattedReceiptNumberDetails();if(this.receiptSettingsTemplate.Barcode=this.barcodeService.generateBarcodeImage({value:b,options:nr}),this.isTrialling()){const e=tr[Math.floor(Math.random()*tr.length)];this.receiptSettingsTemplate.TrialMessage=e.TrialMessage,this.receiptSettingsTemplate.TrialMessageHeadLine=e.TrialMessageHeadLine}}setDisplaySettings(e){return e?r(r({},e),{},{DisplayCustomerDetails:e.DisplayCustomerDetails&&this.customer&&"WALKIN"!==this.customer.customer_code}):or}setCustomerDetailsDisplayValues(e,t,n){this.receiptSettingsTemplate.DisplayCustomerCompanyName=e.CompanyName&&n.DisplayCustomerCompany,this.receiptSettingsTemplate.DisplayCustomerName=(e.FirstName||e.LastName)&&n.DisplayCustomerName,this.receiptSettingsTemplate.DisplayCustomerEmail=e.Email&&n.DisplayCustomerEmail,this.receiptSettingsTemplate.DisplayCustomerPhone=(e.Phone||e.Mobile)&&n.DisplayCustomerPhone,this.receiptSettingsTemplate.DisplayCustomerAddress=e.FormattedPostalAddress&&n.DisplayCustomerAddress,this.receiptSettingsTemplate.DisplayStoreCredit=t&&!e.WalkIn&&n.DisplayCustomerBalances,this.receiptSettingsTemplate.DisplayCustomerCode=e.CustomerCode&&n.DisplayCustomerCode}setTotals(e,t){return{Change:{},SingleTax:!1,MultipleTaxName:"",FormattedMultipleTaxAmount:"",FormattedServiceFee:e.totals.saleServiceFee,FormattedCashDiscount:e.totals.cashDiscount,FormattedTotalWithServiceFee:e.getCashDiscountedSaleTotal(),ItemCountLabel:"items",TotalNumberOfItems:0,TaxLabel:t.LabelTax,SubtotalLabel:t.LabelSubTotal,TipAmountLabel:t.LabelTipAmount,FormattedSubtotal:this.vdCurrencyFilter(e.finals.subtotal),TotalLabel:t.LabelTotal,FormattedTotal:0,Payments:[],GiftCards:[],TotalSavings:0,ToPayLabel:t.LabelToPay}}isTrialling(){return"trialing"===this.retailerSettingsManager.get().account_status}setCustomer(e,t){if(!e)return sr;const n=Z.sanitize(this.setPostalAddress(e));return{CompanyName:e.company_name,CustomerCode:e.customer_code,Email:e.email,FirstName:e.first_name,FormattedOnAccountBalance:this.vdCurrencyFilter(t&&t.account),FormattedPostalAddress:n,FormattedStoreCredit:"",HasCustomerContactDetails:e.email||e.mobile||e.phone||n.length>0,LastName:e.last_name,Mobile:e.mobile,Phone:e.phone,LoyaltyBalance:e.loyalty_balance,WalkIn:"WALKIN"===e.customer_code,LoyaltyEnabled:e.enable_loyalty}}setLoyalty(e,t,n){const s=this.retailerSettingsManager.isLoyaltyEnabled()&&(t.WalkIn||t.LoyaltyEnabled);if(s){const s=e.isClosed()||e.isMarkedAsUnfulfilled()?this.loyaltyManager.getTotalLoyalty(e):0,a=e.customerBalances&&e.customerBalances.loyalty,i={FormattedEarned:this.vdCurrencyFilter(s),FormattedBalance:this.vdCurrencyFilter(c.add(c.vn(a),c.vn(s))),CustomLoyaltyLink:this.loyaltyManager.getLoyaltyClaimUrl(e)},r=!e.hasValidCustomerWithEmail()&&n.DisplayLoyaltyLink,o=!t.WalkIn&&n.DisplayCustomerBalances&&n.DisplayCustomerDetails&&t.LoyaltyEnabled;this.receiptSettingsTemplate.Loyalty=i,this.receiptSettingsTemplate.DisplayLoyaltyLink=r,this.receiptSettingsTemplate.DisplayLoyaltyBalance=o,this.receiptSettingsTemplate.DisplayCustomerBalances=n.DisplayCustomerBalances&&a&&t.FormattedOnAccountBalance,this.receiptSettingsTemplate.DisplayLoyaltyEarned=n.DisplayLoyaltyEarned&&c.vn(s).gt(0)}this.receiptSettingsTemplate.DisplayLoyaltySection=s}setPayments(e,t,n,s,a,i,r){if(i&&!0===i.isSignatureSlipReceipt){const e=i.transaction.tenders[0],n=this.vdCurrencyFilter(e.amount);return{Payments:[{Name:i.paymentType.payment_type&&i.paymentType.name!==i.paymentType.payment_type.name?i.paymentType.name+"<br>"+i.paymentType.payment_type.name:i.paymentType.name,FormattedAmount:n,PaymentDate:Un(e.created_at,ar,t.time_zone),Transaction:{Tenders:{ExternalTransactionId:e.external_transaction_id,CardDetails:{Card:{LastFour:e.card_details.card.last_four}},TerminalID:e.provider_fields.terminal_id||null,Signature:e.provider_fields.signature_url||e.provider_fields.signature_base64||null}}}],FormattedToPay:n,FormattedTotal:n}}let o=e.payments.map(n=>{let s;switch(n.transactionStatus){case ur:s="Signature Required";break;case dr:s="Signature Not Required"}return{Name:n.paymentType.name,FormattedAmount:this.vdCurrencyFilter(n.amount),ExternalTransactionID:n.paymentType.type_id===hs.AFTER_PAY||n.paymentType.type_id===hs.KLARNA?n.external_transaction_id:"",PaymentDate:Un(n.paymentDate,ar,t.time_zone),PaymentTypeID:n.paymentType.type_id,Transaction:this.getTransaction(n,e.isReturn(),t.time_zone),SignatureRequired:s}}),l="";e.hasChange()&&(this.receiptSettingsTemplate.LabelChange=a.LabelChange?a.LabelChange:"Change",l=this.vdCurrencyFilter(e.getChangeAmountForDisplay()));const d=this.setGiftCardPayments(s,t);d&&(o=o.filter(e=>e.PaymentTypeID!==hs.GIFT_CARD&&e.PaymentTypeID!==hs.BIGCOMMERCE_GIFT_CERT));return{GiftCards:d,ChangeFormattedAmount:l,Payments:o,FormattedToPay:this.vdCurrencyFilter(e.getOutstandingBalanceAfterChange()),FormattedTotal:this.vdCurrencyFilter(c.add(c.vn(e.finals.exclusivePrice),c.vn(n),r))}}getTransaction(e,t,n){return e.paymentType.type_id===hs.CASH?{Tenders:{CreatedAt:Un(e.paymentDate,ar,n)}}:e.card||e.emv||e.paymentType.type_id===hs.KLARNA||e.paymentType.type_id===hs.AFTER_PAY?{Tenders:{CreatedAt:Un(e.paymentDate,ar,n),CardDetails:e.card?{EntryMethod:e.card.entryMethod||null,Card:{Brand:e.card.brand||null,LastFour:e.card.lastFour||null,Type:e.card.type||null}}:null,Type:t&&e.amount<0?"REFUND":"PURCHASE",ExternalTransactionID:e.external_transaction_id,EMV:e.emv?{Aid:e.emv.aid||null,ApplicationLabel:e.emv.applicationPreferredName||e.emv.applicationLabel,CryptogramType:e.emv.cryptogramType,Cryptogram:e.emv.cryptogram,Tags:e.emv.tags?e.emv.tags.map(e=>({Key:e.key,Value:e.value})):null}:null,Status:"ACCEPTED",ProviderFields:e.providerFields}}:null}setGiftCardPayments(e,t){if(e){const n=e.giftCardPaymentsSummary;if(n)return n.map(e=>{const n=e.transactions.find(t=>t.id===e.sourceId);if(n){const s=e.expiresAt,a=t.time_zone;return{ID:e.id,Number:e.code,FormattedExpiresAt:s?Un(s,rr,a):"",FormattedTotalRedeemed:this.vdCurrencyFilter(this.wrMakeAbsolute(n.amount)),TotalRedeemed:this.wrMakeAbsolute(n.amount),FormattedBalance:this.vdCurrencyFilter(e.balance),PaymentDate:Un(n.createdAt,ar,a)}}})}return null}setTaxes(e){const t=e.finals.tax;let n=0;const s=e.finals.taxes,a=Object.keys(s).map(a=>{const i=s[a];let r=Fn(c.multiply(i.rate.rate,100),3,!0)+"%";return 0===i.rate.rate&&(r="",n++),{Name:i.name,Rate:r,FormattedTotalAmount:1===Object.keys(e.finals.taxes).length?this.vdCurrencyFilter(t):this.vdCurrencyFilter(i.total)}});let i="",r="";const o=a.length-n;return o>1&&(i=o+" taxes",r=this.vdCurrencyFilter(t)),this.receiptSettingsTemplate.DisplayTax=this.receiptSettingsTemplate.DisplayTax&&o>0,{Taxes:a,TotalTax:t,SingleTax:1===o,MultipleTaxName:i,FormattedMultipleTaxAmount:r}}calculateGiftCardExpiry(e,t){const n=e.giftCardSettings.expiry_period||"",s=e.giftCardSettings.expiry_period_type||"";return this.wrCalculateGiftcardExpiryFilter(n,s,t.time_zone)}setSaleDiscount(e,t,n){let s=e.discount.price;return this.isTaxInclusive&&(s=c.add(e.discount.price,e.discount.tax)),n=c.add(n,s),this.receiptSettingsTemplate.Totals.OrderDiscountFormattedDollarDiscount=this.vdCurrencyFilter(c.multiply(s,-1)),{TotalSavings:c.vn(n)}}setPostalAddress(e){if(!this.isStandardInvoice)return ls(e,"postal");const t=[],n=e.postal_address_1?e.postal_address_1.trim():"",s=e.postal_address_2?e.postal_address_2.trim():"",a=e.postal_suburb?e.postal_suburb.trim():"",i=e.postal_city?e.postal_city.trim():"",r=e.postal_postcode?e.postal_postcode.trim():"",o=e.postal_state?e.postal_state.trim():"",l=e.postal_country_id?e.postal_country_id.trim():"";return n&&s?t.push(`${n}, ${s}`):n?t.push(n):s&&t.push(s),a&&t.push(a),i?r?t.push(`${i} ${r}`):t.push(i):r&&t.push(r),o?l?t.push(`${o}, ${l}`):t.push(o):l&&t.push(l),t.join("<br>")}setItems(e,t,n,s,a){let i=c.vn(0),r=c.vn(0),o="";s&&s.giftCardSettings&&(o=this.calculateGiftCardExpiry(s,t));const l=e.lineItems.map(e=>{let s="";const{giftCardNumber:l,giftCardExpiresAt:d}=e;l&&d&&(s=Un(d,rr,t.time_zone)),i=c.vn(c.add(i,c.vn(e.displayQuantity)));const u=this.isTaxInclusive?e.totals.inclusivePrice:e.totals.exclusivePrice,h=e.product,m={ProductName:h&&h.name?h.name:"Product not found",ProductSKU:h&&h.sku&&"vend-internal-gift-card"!==h.sku?h.sku:"",ProductVariantName:h?h.variant_name:"Product not found",ProductVariantInfo:"",ProductVariantOptions:h&&h.variant_options,Quantity:e.displayQuantity,FormattedCost:this.vdCurrencyFilter(e.displayPrice),FormattedTotalCost:this.vdCurrencyFilter(u),HasDiscount:e.displayDiscount>0&&n.show_discounts_on_receipts,ItemNote:e.note,FormattedGiftCardExpiry:s||o,GiftCardNumber:e.giftCardNumber,Promotions:"",ItemDiscountFormattedDollarDiscount:"",ItemDiscountFormattedOriginalPrice:"",ItemDiscountFormattedPercentageDiscount:"",LineItemTaxString:"",FirstLineItemTax:"",FormattedLineItemTaxes:[]},g=m.ProductVariantOptions;m.ProductVariantInfo=g.map(e=>e.value).join(" / ");const p=e.promotion;if(p&&p.promotionDetails&&(m.Promotions=p.promotionDetails.map(e=>({Name:e.name,PromoCode:e.promoCode}))),m.HasDiscount){const t=c.multiply(e.displayDiscount,c.vn(e.quantity));r=c.vn(c.add(r,t));const n=this.isTaxInclusive?e.totals.inclusiveBasePrice:e.totals.exclusiveBasePrice;m.ItemDiscountFormattedOriginalPrice=this.vdCurrencyFilter(n),m.ItemDiscountFormattedPercentageDiscount=Fn(e.displayDiscountPercent,2,!0)+"%",m.ItemDiscountFormattedDollarDiscount=this.vdCurrencyFilter(e.displayDiscount)}if(a){const t=e.taxInfo.rates.map(t=>`${t.display_name} (${Fn(c.multiply(t.rate,100),3,!0)+"%"} / ${this.vdCurrencyFilter(c.multiply(e.totals.exclusivePrice,t.rate))})`);this.isStandardInvoice?(m.FirstLineItemTax=t.shift(),m.FormattedLineItemTaxes=t.map(e=>({Value:e}))):m.LineItemTaxString=t.join(", ")}return m});return this.receiptSettingsTemplate.ListItems=l,this.receiptSettingsTemplate.Totals.TotalNumberOfItems=i,this.receiptSettingsTemplate.Totals.ItemCountLabel=i===c.vn(1)||i===c.vn(-1)?"item":"items",{TotalSavings:r}}}Mr.$inject=["barcodeService","wrUserNameFilter","retailerSettingsManager","registerManager","loyaltyManager","customerBalancesManager","wrCalculateGiftcardExpiryFilter"];const Tr={template:'\n  <div>\n    <style ng-bind="$ctrl.receiptCSS"></style>\n    <div ng-bind-html="$ctrl.renderedTemplate"></div>\n  </div>\n  ',controller:Mr,bindings:{data:"=",options:"="}};class Er{constructor(){s(this,"containCreditCardErrorMsg",void 0),this.containCreditCardErrorMsg="You\u2019ve entered information that looks like credit card details, which could be highly sensitive. Please remove them to continue."}}Er.$inject=[];const kr={controller:Er,template:"<vd-error-message>\n  {{$ctrl.containCreditCardErrorMsg}}\n</vd-error-message>\n"};class Ir{constructor(e,t){this.registerManager=e,this.$attrs=t}$postLink(){this.$attrs.$addClass("wr-preload-receipt-images")}}Ir.$inject=["registerManager","$attrs"];const Pr={controller:Ir,template:'<div style="display: none;">\n  <div ng-bind-html="$ctrl.registerManager.getActiveRegisterReceiptSettings().Header"></div>\n  <div ng-bind-html="$ctrl.registerManager.getActiveRegisterReceiptSettings().Footer"></div>\n\n  <img ng-src="{{$ctrl.registerManager.getActiveRegisterReceiptLogo()}}" />\n\n  <img ng-src="{{\'logos/vend-logo-dark-v1.svg\' | vdImageCdnPath }}" />\n  <img ng-src="{{\'logos/vend-logo-higher-res-v1.png\' | vdImageCdnPath }}" />\n\n  \x3c!-- Retrieve Sale Empty Basket --\x3e\n  <img ng-src="{{\'sell/empty-basket-v1.svg\' | vdImageCdnPath }}">\n</div>\n\n\x3c!-- Preload receipt font --\x3e\n<div class="wr-fira-mono">&nbsp;</div>\n'};class Rr{constructor(e,t,n,a,i){this.$attrs=e,this.elementService=t,this.registerClosureManager=n,this.cashMovementsManager=a,this.webRegisterManager=i,s(this,"openingRegister",void 0),s(this,"register",void 0)}openRegister(e){this.openingRegister=!0,this.registerClosureManager.openRegister(this.register,e).then(()=>et.go(jt)).catch(()=>{this.openingRegister=!1})}$postLink(){const e=["open-register-panel-container"],t=this.elementService.getComponentAttrs(this.$attrs,"modifier");t&&t.forEach(t=>e.push("open-register-panel-container--"+t)),this.$attrs.$addClass(e)}}Rr.$inject=["$attrs","elementService","registerClosureManager","cashMovementsManager","webRegisterManager"];const Ar={bindings:{register:"<",webRegisterOnline:"<",minimal:"<?"},controller:Rr,template:'<div ng-if="$ctrl.webRegisterManager.initialisationComplete" class="open-register-panel">\n  <div ng-if-start="!$ctrl.minimal" class="open-register-panel-header vd-align-center">\n    <img class="wr-register-closed-image" ng-src="{{ \'sell/register-closed-v1.svg\' | vdImageCdnPath }}">\n    <vd-header category="subpage" class="vd-mt3 vd-mb3">Register closed</vd-header>\n  </div>\n\n  <p class="vd-p pro-open-register-intro" ng-if-end>\n    <span ng-if="!$ctrl.cashMovementsManager.isCashManagementEnabled()" vd-no-widow>\n      To make a sale, please open the register.\n    </span>\n    <span ng-if="$ctrl.cashMovementsManager.isCashManagementEnabled()" vd-no-widow>\n      Set an opening float to open the register and make a sale.\n    </span>\n  </p>\n\n  <set-cash-float-form form="$ctrl.openRegisterSetFloatForm"\n    ng-class="{ \'open-register-panel-form--minimal\': $ctrl.minimal }"\n    on-submit="$ctrl.openRegister($event.cashFloatSettings)"\n    loading="$ctrl.openingRegister">\n    <button id="pro-open-register-button"\n      type="submit"\n      ng-disabled="!$ctrl.webRegisterOnline || $ctrl.openRegisterSetFloatForm.$invalid || $ctrl.openingRegister"\n      class="vd-btn vd-btn--do open-register-panel-button">\n      <span ng-if="!$ctrl.openingRegister">Open Register</span>\n      <span ng-if="$ctrl.openingRegister">\n        Opening Register <span class="vd-loader vd-loader--small"></span>\n      </span>\n    </button>\n  </set-cash-float-form>\n</div>\n'};class Dr{constructor(e,t,n){this.registerManager=t,this.registerClosureManager=n,s(this,"_close",void 0),s(this,"close",void 0),s(this,"openingRegister",void 0),this._close=e,this.close=()=>this._close(We.reject())}openRegister(e){this.openingRegister=!0,this.registerClosureManager.openRegister(this.registerManager.getActiveRegister(),e).then(()=>this._close(),()=>{this.openingRegister=!1})}}Dr.$inject=["close","registerManager","registerClosureManager"];class Nr{constructor(e){this.$attrs=e,s(this,"fields",void 0),s(this,"registerClosure",void 0)}$onChanges(){this._setFields()}$postLink(){this.$attrs.$addClass("wr-info-fields register-closure-info-fields")}_setFields(){if(!this.registerClosure)return void(this.fields=[]);const e=this.registerClosure.outlet.time_zone,t=[{label:"Outlet",value:this.registerClosure.outlet.name},{label:"Register",value:this.registerClosure.register.name},{label:"Closure #",value:this.registerClosure.register_closure_sequence_number},{label:"Opening time",value:Un(this.registerClosure.register_open_time,void 0,e)}];this.registerClosure.register_close_time&&t.push({label:"Closing time",value:Un(this.registerClosure.register_close_time,void 0,e)}),this.fields=t}}Nr.$inject=["$attrs"];const xr={bindings:{registerClosure:"<"},controller:Nr,template:'<wr-info-field ng-repeat="field in $ctrl.fields" label="field.label" value="field.value"></wr-info-field>\n'};const Or={bindings:{registerClosure:"=",editable:"<"},template:'<div class="vd-field">\n  <div class="vd-label">Note</div>\n  <div class="vd-value">\n    <textarea\n      ng-if="$ctrl.editable"\n      name="note"\n      vd-textarea="{ max: 5 }"\n      class="vd-mb5"\n      ng-model="$ctrl.registerClosure.note"\n      placeholder="Type to add a register closure note"\n    ></textarea>\n    <div\n      ng-if="!$ctrl.editable && $ctrl.registerClosure.note"\n      class="wr-register-closure-notes wr-honour-line-breaks"\n    >\n      <p class="wr-info-field-value vd-p">{{:: $ctrl.registerClosure.note }}</p>\n    </div>\n  </div>\n</div>\n'};class $r{constructor(e,t,n,a,i,r,o,l,c,d,u,h,m,g){this.close=t,this.registerManager=n,this.saleSyncManager=a,this.saleManager=i,this.trainingModeManager=r,this.userManager=o,this.webRegisterStatusManager=l,this.registerModals=d,this.saleModals=h,this.trainingModeModals=m,this.vdTracking=g,s(this,"canShowSwitchRegisterItem",!1),We.all([u.whenCompleteEntityDataAvailable("outlets"),u.whenCompleteEntityDataAvailable("registers")]).then(()=>{qs.on("sync",this._setCanShowSwitchRegisterLink,this),c.on("sync",this._setCanShowSwitchRegisterLink,this),o.on("loggedInUserChange",this._setCanShowSwitchRegisterLink,this),this.webRegisterStatusManager.on(Pn.statusChange,this.close,this),this.saleSyncManager.on("saleSyncRetry",this.close,this),this.trainingModeManager.on("trainingModeEnabledChange",this._setCanShowSwitchRegisterLink,this),this._trackRegisterActions("Register Actions Shown"),this._setCanShowSwitchRegisterLink()}),e.$on("$destroy",()=>{qs.off("sync",this._setCanShowSwitchRegisterLink),c.off("sync",this._setCanShowSwitchRegisterLink),o.off("loggedInUserChange",this._setCanShowSwitchRegisterLink),this.webRegisterStatusManager.off(Pn.statusChange,this.close),this.saleSyncManager.off("saleSyncRetry",this.close),this.trainingModeManager.off("trainingModeEnabledChange",this._setCanShowSwitchRegisterLink)})}toggleTrainingMode(){if(this._closePopoverAndHideSideNav(),this.trainingModeManager.trainingModeEnabled)return this._trackRegisterActions("Exit Training Mode"),this.trainingModeModals.exitTrainingModeConfirmation().then(()=>this.trainingModeManager.exitTrainingMode()).then(()=>et.go(jt,{},{location:"replace"}));this._trackRegisterActions("Switch to Training Mode"),this._actionExistingSale(this.saleModals.CONTEXTS.TRAINING_MODE).then(()=>{this.trainingModeManager.initiateTrainingMode(),this.trainingModeModals.confirmTrainingMode().then(()=>this.trainingModeManager.initiateTrainingTour())})}switchRegister(){this._closePopoverAndHideSideNav(),this._canSwitchRegister().then(()=>{this._trackRegisterActions("Switch Register"),this.registerModals.selectRegister(!0)})}syncOfflineSales(){this._closePopoverAndHideSideNav(),this._trackRegisterActions("Sync Offline Sales"),this.saleSyncManager.retryUnsyncedSales()}_actionExistingSale(e){return We((t,n)=>this.saleManager.actionExistingSaleIfRequired({context:e}).then(e=>e.hasActiveSale?(et.includes(Gt)||et.go(jt),n()):(et.includes(Qt)&&et.go(jt),t())))}_closePopoverAndHideSideNav(){this.close()}_canSwitchRegister(){return We((e,t)=>{let n=We.resolve();if(this.saleSyncManager.uploadSalesCount)n=this.registerModals.actionOfflineSales();else{if(this.saleSyncManager.erroredSalesCount+this.saleSyncManager.attemptedSalesCount>0)return this.registerModals.actionErroredSales(),t();n=this._actionExistingSale(this.saleModals.CONTEXTS.SWITCH_REGISTERS)}return n.then(e,t)})}_setCanShowSwitchRegisterLink(){if(!this.webRegisterStatusManager.isOnline()||this.trainingModeManager.trainingModeEnabled)return void(this.canShowSwitchRegisterItem=!1);const e=this.userManager.getLoggedInUser();this.registerManager.getAllRegistersByOutlet({restrictedOutlets:e.restricted_outlet_ids}).then(e=>{if(!e.length)return void(this.canShowSwitchRegisterItem=!1);const t=e.length>1,n=e[0].registers&&e[0].registers.length>1;this.canShowSwitchRegisterItem=t||n})}_trackRegisterActions(e){this.vdTracking.trackUserEvent({eventName:"Sidenav Register Actions",metadata:{Event:e}})}}$r.$inject=["$scope","close","registerManager","saleSyncManager","saleManager","trainingModeManager","userManager","webRegisterStatusManager","usersStore","registerModals","syncManager","saleModals","trainingModeModals","vdTracking"];class Lr{constructor(e){this.vdTracking=e}open(e){const t=e&&e.id;if("string"!=typeof t)return We.reject("Unable to construct register open query with register: "+e);const n={register_open_time:ee.utc().format()};return Ke.put(`/api/2.0/registers/${t}/actions/open`,n).then(Ue)}getPaymentsSummary(e){const t=e&&e.id;return"string"!=typeof t?We.reject("Unable to construct payments summary query with register: "+e):Ke.get(`/api/2.0/registers/${t}/payments_summary`).then(Ue)}close(e){const t=e.register.id,n={note:e.note,payments:e.payments.map(e=>({payment_type_id:e.payment_type_id,total:e.totalCounted}))};return Ke.put(`/api/2.0/registers/${t}/actions/close`,n).then(Ue)}recordCashMovement(e){return Ke.post(`/api/2.0/register_open_sequences/${e.register_open_sequence_id}/cash_movements`,e).then(t=>(this.vdTracking.trackUserEvent({eventName:"Cash Management",metadata:{"Cash Movement Type":e.type}}),Ue(t)))}getCashTotals(e){return Ke.get(`/api/2.0/register_open_sequences/${e.register_open_sequence_id}/cash_totals`).then(Ue)}getCashMovements(e){return Ke.get(`/api/2.0/register_open_sequences/${e.register_open_sequence_id}/cash_movements`,{params:{type:e.type}}).then(Ue)}updateRegister(e,t){return Ke.put("/api/2.0/registers/"+e.id,t).then(Ue)}}Lr.$inject=["vdTracking"],t.module("webregister.services").service("registersResource",Lr);class Fr{constructor(e,t,n){this.$attrs=e,this.vdTracking=t,this.registerManager=n}$postLink(){this.$attrs.$addClass("register-open-reminder")}dismissReminder(){const e=this.registerManager.getActiveRegister();this.registerManager.setOpenRegisterReminderSeen({registerId:e.id,registerOpenSequenceId:e.register_open_sequence_id}),this.vdTracking.trackUserEvent({eventName:"Register Open Reminder",metadata:{action:"Start selling anyway",daysOpen:this.registerManager.activeRegisterDaysOpen()}})}viewRegisterClosure(){this.vdTracking.trackUserEvent({eventName:"Register Open Reminder",metadata:{action:"Close register first",daysOpen:this.registerManager.activeRegisterDaysOpen()}}),et.go(Jt)}}Fr.$inject=["$attrs","vdTracking","registerManager"];var Ur={controller:Fr,template:'<div class="vd-pa10">\n  <div class="vd-text-heading vd-mb3">\n    This register has been open\n    <ng-pluralize count="$ctrl.registerManager.activeRegisterDaysOpen()"\n      when="{ \'one\': \'since&nbsp;yesterday.\', \'other\': \'for {}&nbsp;days.\' }">\n    </ng-pluralize>\n  </div>\n  <p class="vd-p" vd-no-widow>\n    Having sales from multiple days in one register closure could create problems when you reconcile\n    your accounts.\n  </p>\n</div>\n\n<vd-action-bar class="vd-pl10 vd-pr10 vd-pt5 vd-pb5">\n  <a class="vd-link vd-link--secondary" ng-click="$ctrl.dismissReminder()">\n    Start selling anyway\n  </a>\n\n  <button ng-click="$ctrl.viewRegisterClosure()" class="vd-btn vd-btn--do vd-ml1 register-open-reminder-close">\n    Close Register First\n  </button>\n</vd-action-bar>\n'};t.module("webregister.components").component("registerOpenReminder",Ur);class Br{constructor(e,t,n,a,i){this.close=e,this.options=t,this.cashMovementsManager=a,this.vdToastNotificationService=i,s(this,"availableCashTypes",void 0),s(this,"awaitingServerResponse",void 0),s(this,"cashMovement",void 0),s(this,"cashMovementType",void 0),s(this,"dismissible",!0),s(this,"displayCashMovementType",void 0),s(this,"vendNumberOptions",void 0);const r={add:[us.CASH_IN,us.PETTY_CASH_IN],remove:[us.CASH_OUT,us.PETTY_CASH_OUT]};this.cashMovementType=t.cashMovementType,this.displayCashMovementType=te(this.cashMovementType),this.availableCashTypes=r[this.cashMovementType],this.vendNumberOptions={min:0,allowedPrefix:n.getActiveOutlet().currency_symbol,decimalPlaces:2},this.cashMovement={amount:null,note:null,type:this.availableCashTypes[0]}}recordCashMovement(){const e=t.copy(this.cashMovement);this.awaitingServerResponse=!0,"remove"===this.cashMovementType&&(e.amount=-Math.abs(e.amount)),this.cashMovementsManager.recordCashMovement(e).then(e=>this.close(e)).catch(()=>{this.vdToastNotificationService.negative({message:"There was a problem recording this cash movement, please try again."})}).finally(()=>{this.awaitingServerResponse=!1})}}Br.$inject=["close","options","registerManager","cashMovementsManager","vdToastNotificationService"];class qr{constructor(e,t,n,a,i,r,o){this.close=e,this.options=t,this.vdToastNotificationService=n,this.registerManager=a,this.vdTracking=i,this.registerClosureManager=r,this.cashMovementsManager=o,s(this,"awaitingServerResponse",void 0),s(this,"cashMovementRequestFailed",void 0)}recordCashMovement(e){this.cashMovementsManager.recordCashMovement(e).then(e=>this.close(e)).catch(()=>this._handleCashMovementFailure())}cancelOpenRegisterAndSetFloat(){this.cashMovementRequestFailed&&this.vdToastNotificationService.negative({message:"We had a problem saving the opening cash drawer amount. To retry, open Cash Management in the side\n          menu bar."}),this.close()}openRegisterAndSetFloat(e){const t=this.registerManager.getActiveRegister();this.awaitingServerResponse=!0,this.cashMovementRequestFailed||this.registerManager.isActiveRegisterOpen()?this.recordCashMovement(e):this.registerClosureManager.openRegisterAndSetFloat(t,e).then(({cashMovement:e})=>this.close(e)).catch(()=>this._handleCashMovementFailure())}_handleCashMovementFailure(){this.awaitingServerResponse=!1,this.registerManager.isActiveRegisterOpen()?(this.cashMovementRequestFailed=!0,this.vdToastNotificationService.negative({message:"We had a problem saving the opening cash drawer amount. Retry, or skip this for now."}),this.vdTracking.trackUserEvent({eventName:"Cash Management",metadata:{"Failed Cash Float":!0}})):this.close()}}qr.$inject=["close","options","vdToastNotificationService","registerManager","vdTracking","registerClosureManager","cashMovementsManager"];class Vr{constructor(e,t){this.registerManager=e,this.cashMovementsManager=t,s(this,"cashFloatSettings",void 0),s(this,"currencySymbol",void 0),s(this,"vendNumberOptions",void 0),this.cashFloatSettings={amount:null,note:null,type:us.OPENING_CASH_FLOAT},this._setCashFloatNumberOptions(),this.registerManager.on("activeOutletChange",this._setCashFloatNumberOptions,this)}$onDestroy(){this.registerManager.off("activeOutletChange",this._setCashFloatNumberOptions)}_setCashFloatNumberOptions(){const e=this.registerManager.getActiveOutlet();this.currencySymbol=e&&e.currency_symbol,this.vendNumberOptions={min:0,allowedPrefix:this.currencySymbol,allowEmpty:!0,decimalPlaces:2}}}Vr.$inject=["registerManager","cashMovementsManager"];var Kr={bindings:{form:"=",loading:"<",formId:"@",onSubmit:"&"},controller:Vr,template:'<form name="$ctrl.form"\n  id="{{$ctrl.formId}}"\n  ng-submit="$ctrl.onSubmit({ $event: { cashFloatSettings: $ctrl.cashFloatSettings } })">\n  <div ng-if-start="$ctrl.cashMovementsManager.isCashManagementEnabled()" class="vd-field">\n    <div class="vd-label">Opening Float</div>\n    <div class="vd-value">\n      <input class="vd-input"\n        name="openingFloatAmount"\n        ng-model="$ctrl.cashFloatSettings.amount"\n        placeholder="0.00"\n        vd-number\n        vd-number-options="$ctrl.vendNumberOptions"\n        vd-input-symbol="{ align: \'left\', symbol: $ctrl.currencySymbol }"\n        ng-disabled="$ctrl.loading"\n        inputmode="decimal">\n      <ng-messages class="vd-input-error-message-section" for="$ctrl.form.openingFloatAmount.$error">\n        <ng-message when="validCharacters">\n          <vd-icon icon="fa-exclamation-triangle"></vd-icon>\n          <span class="vd-input-error-message-text">Please use numbers only</span>\n        </ng-message>\n      </ng-messages>\n    </div>\n  </div>\n  <div ng-if-end class="vd-field">\n    <div class="vd-label">\n      Notes <span class="vd-text-supplementary">Optional</span>\n    </div>\n    <div class="vd-value">\n      <textarea vd-textarea="{ max: 3 }"\n        vd-input-char-limit\n        ng-model="$ctrl.cashFloatSettings.note"\n        ng-maxlength="255"\n        placeholder="Enter a note"\n        ng-disabled="$ctrl.loading">\n      </textarea>\n    </div>\n  </div>\n  <div ng-transclude></div>\n</form>\n',transclude:!0};function Gr({data:e}){if(e.errors&&e.errors.length>0)throw new Error(e.errors[0].message);return e.data}const jr=e=>({id:e.id,code:e.number,createdAt:e.created_at,expiresAt:e.expires_at,status:e.status,balance:e.balance,initialAmount:e.total_sold,transactions:Qr(e.gift_card_transactions)}),Qr=e=>e.map(e=>({id:e.id,amount:e.amount,type:e.type,userId:e.user_id,clientId:e.client_id,createdAt:e.created_at})),Wr=e=>{if(!e)return null;const{id:t,code:n,createdAt:s,expiresAt:a,status:i}=e;return{id:t,code:n,createdAt:s,expiresAt:a,status:i,initialAmount:Number(e.initialAmount.amountRounded),balance:Number(e.balance.amountRounded),transactions:[]}};t.module("webregister.components").service("giftCardsResource",class{getGiftCardByCode(e,t){return Ke.post("/api/graphql",{operationName:"GiftCardByCode",query:"query GiftCardByCode($channelId: ID!, $code: String!) {\n      giftCardByCode(channelID: $channelId, code: $code) {\n        id\n        status\n        code\n        createdAt\n        expiresAt\n        initialAmount {\n          amountRounded\n        }\n        balance {\n          amountRounded\n        }\n      }\n    }",variables:{channelId:e,code:t}}).then(Gr).then(e=>Wr(e.giftCardByCode))}getGiftCardByTransactionId(e,t){return Ke.post("/api/graphql",{operationName:"GiftCardByTransactionId",query:"query GiftCardByTransactionId($channelId: ID!, $transactionId: ID!) {\n      giftCardByTransactionId(channelID: $channelId, transactionID: $transactionId) {\n        id\n        status\n        code\n        createdAt\n        expiresAt\n        initialAmount {\n          amountRounded\n        }\n        balance {\n          amountRounded\n        }\n      }\n    }",variables:{channelId:e,transactionId:t}}).then(Gr).then(e=>Wr(e.giftCardByTransactionId))}redeemGiftCard(e,t,n){return Ke.post("/api/graphql",{operationName:"RedeemGiftCard",query:"mutation RedeemGiftCard($channelId: ID!, $giftCardId: ID!, $amount: Float!) {\n      redeemGiftCard(channelID: $channelId, giftCardID: $giftCardId, amount: $amount) {\n        transactionID\n      }\n    }",variables:{channelId:e,giftCardId:t,amount:n}}).then(Gr).then(e=>e.redeemGiftCard.transactionID)}});class Hr{constructor(e){this.close=e,s(this,"dismissible",void 0),this.dismissible=!1}transitionToSaleScreen(){this.close(),et.go(jt)}}Hr.$inject=["close"];class Yr{constructor(e,t){this.Modal=e,this.ModalService=t,s(this,"OFFLINE_MODE_STATES",void 0),s(this,"TRAINING_MODE_STATES",void 0),s(this,"registerOfflineModal",void 0),this.TRAINING_MODE_STATES=[Gt],this.OFFLINE_MODE_STATES=[Gt,en]}isStateAllowedInTrainingMode(e){return this._isStateListed(e,this.TRAINING_MODE_STATES)}isStateAllowedInOfflineMode(e){return this._isStateListed(e,this.OFFLINE_MODE_STATES)}openOfflineModal(){return this._closeAllOpenModals().then(()=>this.Modal({template:'<vd-dialog header="You can\u2019t access this content while offline"\n  close="$ctrl.close"\n  dismissible="$ctrl.dismissible">\n  <div class="vd-dialog-content">\n    <p class="vd-p">\n      You\u2019ll be able to access this again when you\u2019re online. Meanwhile you can continue to make sales on\n      the Sell Screen.\n    </p>\n  </div>\n  <div class="vd-dialog-actions">\n    <button ng-click="$ctrl.transitionToSaleScreen()" class="vd-btn vd-btn--do">\n      Go to the Sell Screen\n    </button>\n  </div>\n</vd-dialog>\n',controller:Hr,controllerAs:"$ctrl"}).then(e=>(this.registerOfflineModal=e,e.closed)).catch(()=>Qe.debug("[RouteManagerService] Failed to open offline modal.")).finally(()=>{this.registerOfflineModal=null}))}closeOfflineModal(){this.registerOfflineModal&&this.registerOfflineModal.closeModal()}_closeAllOpenModals(){let e=We.resolve();const t=this.ModalService.openModals;return t&&t.length&&t.forEach(t=>{t.close(),e=e.finally(()=>t.modal.closed)}),e}_isStateListed(e=et.current,t){const n=e.name||e;return C(t,e=>ne(n,e))}}Yr.$inject=["Modal","ModalService"],t.module("webregister.services").service("routeManager",Yr);class zr{constructor(e){this.vdToastNotificationService=e}shouldDisableAfterpayPayment(e,t){const n=c.vn(e),s=t.finals.inclusivePrice;return!n.eq(s)||(!!this.hasNonAfterpayPayments({payments:t.payments})||(!!t.containsGiftCard()||(t.isReturn()?!!n.gt(0)||(!this.hasAfterpayPayments({payments:t.originalSalePayments})||c.vn(t.getAfterpayOutstandingBalance()).lte(0)):n.lt(0)||n.gt(s)||this.hasAfterpayPayments({payments:t.payments}))))}shouldPreventOtherPayments(e,t){if(!t.isReturn()&&this.hasAfterpayPayments({payments:t.payments}))return!0;if(!t.isReturn())return!1;const n=c.vn(e);if(!n.isNegative())return!1;if(!this.hasAfterpayPayments({payments:t.originalSalePayments}))return!1;const s=c.vn(t.getNonAfterpayOutstandingBalance());return!c.vn(c.add(s,n)).gte(0)}hasAfterpayPayments({payments:e=[]}){return Ss({payments:e,paymentTypeId:hs.AFTER_PAY})}hasNonAfterpayPayments({payments:e=[]}){return Cs({payments:e,paymentTypeId:hs.AFTER_PAY})}shouldPreventExchange(e){return!(!e||!e.isReturn())&&this.hasAfterpayPayments({payments:e.originalSalePayments})}notifyExchangeNotPossible(){return this.vdToastNotificationService.negative({message:"Sorry, you're unable to exchange items paid for using Afterpay. To continue, refund the\n        entire sale and start a new sale."})}}zr.$inject=["vdToastNotificationService"],t.module("webregister.components").service("afterpayPaymentService",zr);t.module("webregister.components").service("econduitPaymentService",class{shouldDisableEconduitPayment(e,t){if(t.isReturn()){const n=t.originalSalePayments.length>1,s=this.hasEconduitPayments(t.originalSalePayments),a=e.id!==t.originalSalePayments[0].paymentType.id;if(n||!s||a)return!0}return!1}hasEconduitPayments(e=[]){return e.some(e=>Es(e.paymentType))}}),t.module("webregister.filters").filter("wrCalculateGiftcardExpiry",(function(){return function(e,t,n){const s=u().utc();let a;switch(t){case"YEARS":a=u(s).add(e,"y");break;case"MONTHS":a=u(s).add(e,"M");break;case"DAYS":a=u(s).add(e,"d")}return a?(n&&a.tz(n),a.format("ddd, DD MMM YY")):""}}));class Jr{constructor(e,t,n){this.vdActiveUser=e,this.vdFeatureManager=t,this.posStateManager=n}getRecommendedProvider(){return We(e=>{const t=this.vdFeatureManager.get("pay_screen_integrated_promo"),n=this.vdActiveUser.hasPermission(ts.PAYMENT_TYPE_ADD_EDIT);if(!t||!n)return e(null);this.getPaymentRecommendation().then(e)})}getPaymentRecommendation(){const e=this.posStateManager.getPaymentRecommendationCache();return e&&e.timestamp>Date.now()-864e5?We.resolve(e.provider):Ke.get("/api/2.0/experiment/integrated_payment").then(e=>{const t=e.data.data.integrated_payment;return this.posStateManager.setPaymentRecommendationCache({provider:t,timestamp:Date.now()}),t}).catch(()=>null)}}Jr.$inject=["vdActiveUser","vdFeatureManager","posStateManager"],t.module("webregister.components").service("wrIntegratedPaymentPromo",Jr);class Xr{constructor(e){this.vdToastNotificationService=e}shouldDisableKlarnaPayment(e,t){const n=c.vn(e),s=t.finals.inclusivePrice;return!n.eq(s)||(!!Vn.includes(t.status)||(!!this.hasNonKlarnaPayments({payments:t.payments})||(!!t.containsGiftCard()||(t.isReturn()?!!n.gt(0)||(!this.hasKlarnaPayments({payments:t.originalSalePayments})||c.vn(t.getKlarnaOutstandingBalance()).lte(0)):n.lt(0)||n.gt(s)||this.hasKlarnaPayments({payments:t.payments})))))}hasKlarnaPayments({payments:e=[]}){return Ss({payments:e,paymentTypeId:hs.KLARNA})}hasNonKlarnaPayments({payments:e=[]}){return Cs({payments:e,paymentTypeId:hs.KLARNA})}shouldPreventOtherPayments(e,t){if(!t.isReturn()&&this.hasKlarnaPayments({payments:t.payments}))return!0;if(!t.isReturn())return!1;const n=c.vn(e);if(!n.isNegative())return!1;if(!this.hasKlarnaPayments({payments:t.originalSalePayments}))return!1;const s=c.vn(t.getNonKlarnaOutstandingBalance());return!c.vn(c.add(s,n)).gte(0)}shouldPreventExchange(e){return!(!e||!e.isReturn())&&this.hasKlarnaPayments({payments:e.originalSalePayments})}notifyExchangeNotPossible(){return this.vdToastNotificationService.negative({message:"Sorry, you're unable to exchange items paid for using Klarna. To continue, refund the\n        entire sale and start a new sale."})}}Xr.$inject=["vdToastNotificationService"],t.module("webregister.components").service("klarnaPaymentService",Xr);const Zr="AMOUNT_EXCEEDED",eo="DECLINED",to="DECLINED_EXCEEDS_AMOUNT",no="INVALID_CODE",so="INVALID_MINIMUM_INPUT",ao="NO_DEVICE",io="NO_PROVIDER",ro="USED_CODE",oo="BARCODE_ENTRY",lo="INVALID_PRE_APPROVAL_MINIMUM_AMOUNT",co={132012:so,132005:Zr,132017:Zr,132002:eo,132003:to,132007:ro,132004:no,132013:ao,132006:oo,132030:lo,1400:io},uo={[Zr]:"The refund amount exceeds the remaining Afterpay balance (available in the\n    customer\u2019s Afterpay app) on this order.",[eo]:"Sorry, that payment was declined. Please try again, or choose a different payment type. Your customer can contact Afterpay Customer Support to find out more information if they need to.",[to]:"The payment exceeds the pre-approved amount for this barcode. Try a smaller amount\n    or a different barcode.",[no]:"This barcode is no longer valid. Please generate a new one.",["INVALID_INPUT"]:"Sorry, that didn\u2019t work. Please try again or use a different payment type.",[so]:"Sorry, that didn\u2019t work. Afterpay requires a minimum value of $2 per sale.",[lo]:"Payment cannot be made with Afterpay as the amount to pay is below the minimum pre-approval amount.",[ao]:"Afterpay is not set up for this register. Please check which registers are set up for Afterpay.",[io]:"Could not contact Afterpay, please complete set up for Afterpay.",["UNKNOWN"]:"Sorry, that didn\u2019t work. Please try again.",[ro]:"This barcode has already been used. Please try a different barcode.",[oo]:"The barcode must be 8 digits or 16 characters."};class ho{constructor(e,t,n,a,i,r,o){this.paymentsResourceService=a,this.registerManager=i,this.vdPerformanceTracking=r,this.vdTracking=o,s(this,"_close",void 0),s(this,"afterPayForm",void 0),s(this,"approvalCodeStartMark",void 0),s(this,"close",void 0),s(this,"data",void 0),s(this,"dismissible",void 0),s(this,"errorMessage",void 0),s(this,"isRefund",void 0),s(this,"isSubmitting",void 0),s(this,"preApprovalCode",void 0),s(this,"registerHasPairing",void 0),this.data=n.data,this._close=t,this.close=()=>this._close(We.reject()),this.preApprovalCode=null,this.errorMessage=null,this.isSubmitting=!1,this.isRefund=Boolean(this.data.originalRegisterSalePaymentId),this.approvalCodeStartMark=!1,this.isRefund&&this._initiateRefund(),this.registerHasPairing=this.data.hasPairing,e.$on("$destroy",()=>{r.clearAllByName("afterPayApprovalCode")})}canCloseModal(){return this.dismissible=!this.isSubmitting&&!this.isRefund,this.dismissible}isFormInErroredState(){return Boolean(this.afterPayForm&&this.afterPayForm.$submitted&&!this.afterPayForm.preApprovalCode.$error.required&&!this.afterPayForm.preApprovalCode.$dirty&&this.errorMessage)}measureApprovalCodeEntry(){this.approvalCodeStartMark||(this.vdPerformanceTracking.start("afterPayApprovalCode"),this.approvalCodeStartMark=!0)}initiatePayment(){let e;if(this.approvalCodeStartMark&&(e=this.vdPerformanceTracking.stop("afterPayApprovalCode"),this.approvalCodeStartMark=!1),this.afterPayForm.$setSubmitted(!0),this.afterPayForm.$invalid)return;this.isSubmitting=!0,this.errorMessage=null;const t=this._getPaymentConfig();return this.paymentsResourceService.processPayment(t).then(t=>{if(e){const{duration:t}=e;this.vdTracking.trackUserEvent({eventName:"Afterpay Approval Code Entry",metadata:{duration:t,isScanner:t<2500}})}return this._handlePaymentSuccess(t)}).catch(e=>this._handlePaymentError(e)).finally(()=>{var e;this.isSubmitting=!1,null===(e=this.afterPayForm)||void 0===e||e.preApprovalCode.$setPristine(!0)})}_initiateRefund(){const e=this._getPaymentConfig();return this.paymentsResourceService.processRefund(e).then(e=>this._handleRefundSuccess(e)).catch(e=>this._handleRefundError(e))}_getPaymentConfig(){const e={registerId:this.registerManager.getActiveRegister().id,transactionId:se(),retailerPaymentTypeId:this.data.paymentType.id,data:{amount:c.vn(this.data.amount).toNumber()}};return this.isRefund?y(e.data,{original_register_sale_payment_id:this.data.originalRegisterSalePaymentId}):y(e.data,{currency:this.registerManager.getActiveOutlet().currency,pre_approval_code:this.preApprovalCode,products:this.data.products}),e}_handlePaymentSuccess(e){return this._evaluateSuccessResponse(e).then(e=>this._resolveWithTransaction(e)).catch(e=>{this.errorMessage=e})}_handlePaymentError(e){this.errorMessage=this._getErrorMessage(e)}_handleRefundSuccess(e){return this._evaluateSuccessResponse(e).then(e=>this._resolveWithTransaction(e)).catch(e=>this._rejectWithErrorMessage(e))}_handleRefundError(e){return this._rejectWithErrorMessage(this._getErrorMessage(e))}_evaluateSuccessResponse(e){return We((t,n)=>{if(e.status===pr||e.status===fr)return void t(e);let s=uo.UNKNOWN;e.status===hr&&e.tenders[0].status===vr&&(s=uo.DECLINED),n(s)})}_resolveWithTransaction(e){return this._close(We.resolve(e))}_rejectWithErrorMessage(e){return this._close(We.reject({error:e}))}_getErrorMessage(e){const t=e.data&&e.data.code;let n=uo[co[t]];switch(e.status){case 400:case 404:n=n||uo.INVALID_INPUT;break;case 402:n=n||uo.DECLINED;break;case 409:n=n||uo.USED_CODE;break;case 412:case 422:n=n||uo.INVALID_CODE;break;default:n=uo.UNKNOWN}return n}}ho.$inject=["$scope","close","options","paymentsResourceService","registerManager","vdPerformanceTracking","vdTracking"];class mo{constructor(e,t){this.options=t,s(this,"close",void 0),s(this,"amountTendered",void 0),s(this,"cashDiscountedBalance",void 0),s(this,"tenderedAmountMatchesBalance",void 0),s(this,"internalClose",void 0),this.internalClose=e,this.close=()=>this.internalClose(We.reject()),this.amountTendered=t.amountTendered,this.cashDiscountedBalance=t.cashDiscountedBalance,this.tenderedAmountMatchesBalance=c.vn(t.amountTendered).eq(t.balance)}payTenderedAmount(){this.internalClose(We.resolve(this.amountTendered))}payCashDiscountedAmount(){this.internalClose(We.resolve(this.cashDiscountedBalance))}}mo.$inject=["close","options"];class go{constructor(e,t){this.options=t,s(this,"close",void 0),s(this,"approvedAmount",void 0),s(this,"internalClose",void 0),this.internalClose=e,this.close=()=>this.internalClose(We.reject()),this.approvedAmount=t.approvedAmount}makePartialAuth(){this.internalClose(We.resolve(!0))}reversePartialAuth(){this.internalClose(We.resolve(!1))}}go.$inject=["close","options"];class po{constructor(e,t){this.close=e,this.options=t,s(this,"paymentTypeName",void 0),this.options.paymentType.type_id===hs.STORE_CREDIT?this.paymentTypeName="Store Credit":this.options.paymentType.type_id===hs.LOYALTY&&(this.paymentTypeName="Loyalty")}makePartialPayment(){this.close(!0)}}po.$inject=["close","options"];let vo;!function(e){e.DATA="DATA",e.SETUP="SETUP",e.PRINT="PRINT",e.ACCEPT="ACCEPT",e.DECLINE="DECLINE",e.EXIT="EXIT",e.DISMISSED="DISMISSED MODAL",e.ACCEPT_SIGNATURE="ACCEPT_SIGNATURE"}(vo||(vo={}));class yo{constructor(e,t,n,a,i,r){this.$scope=e,this.options=n,this.paymentManager=a,this.posStateManager=i,this.vdTracking=r,s(this,"close",void 0),s(this,"dismissible",void 0),s(this,"gatewaySrc",void 0),s(this,"header",null),s(this,"isFullscreen",!1),s(this,"internalClose",void 0),s(this,"canCancelPayment",!0),this.internalClose=t,this.close=()=>this.cancelPayment(),this.setGatewaySource(),this.setInitialConfig(),this.bindMessageHandler()}cancelPayment(){this.internalClose(We.reject({step:vo.DISMISSED}))}canCloseModal(){return this.dismissible=this.canCancelPayment,this.dismissible}bindMessageHandler(){const e=Xe,t=e=>this.gatewayMessageHandler(e);e.addEventListener("message",t),this.$scope.$on("$destroy",()=>e.removeEventListener("message",t))}setInitialConfig(){const{paymentType:e}=this.options.paymentData;this.setFullscreen(e.config.display_gateway_fullscreen)}setFullscreen(e){this.isFullscreen=Boolean(e),this.isFullscreen&&this.canCancelPayment&&this.setEnableClose(!1)}setEnableClose(e){this.isFullscreen?this.canCancelPayment=!1:this.canCancelPayment=Boolean(e)}setGatewaySource(){const{amount:e,currency:t,paymentId:n,paymentType:s,registerId:a}=this.options.paymentData,{customer:i}=this.options.saleData;this.gatewaySrc=this.paymentManager.getPaymentPortalUrl({amount:e,basePaymentPortalUrl:this.getBasePaymentPortalUrl(s),retailerPaymentTypeId:s.id,currency:t,customer:i,referenceId:n,registerId:a})}getBasePaymentPortalUrl(e){let t=e.config?e.config.url:null;if(e.type_id===hs.TYRO){t=`https://iclient.${Ut.isProduction()?"":"test."}tyro.com/vend.html#`}return t}gatewayMessageHandler(e){e&&e.data&&e.source!==Xe&&this.stepEventHandler(e)}stepEventHandler(t){const{paymentType:n}=this.options.paymentData,s={event:t,retailerPaymentType:{id:n.id,paymentTypeId:n.payment_type&&n.payment_type.id}};let a;try{a=JSON.parse(t.data)}catch(e){return void Qe.warn("[IntegratedPaymentModal] Error parsing gateway message",s)}Qe.info("[IntegratedPaymentModal] Gateway message received",a),this.vdTracking.trackUserEvent({eventName:"Payments API",metadata:{retailerPaymentTypeId:n&&n.id,step:a.step,data:!n||152!==n.type_id&&108!==n.type_id?"hidden":t.data}});const i=()=>{const e=qe[0].getElementById("vd-payment-gateway");e.style.display="none",e.offsetHeight,e.style.display="block"};switch(a.step){case vo.SETUP:this.setupStepHandler(a);break;case vo.DATA:this.dataSetupHandler(t);break;case vo.PRINT:this.paymentManager.emit("printReceipt",{receiptHtmlExtra:a.receipt_html_extra}),window.addEventListener("afterprint",i),this.$scope.$on("$destroy",()=>window.removeEventListener("afterprint",i));break;case vo.ACCEPT_SIGNATURE:this.printSignatureSlipHandler(a);break;case vo.ACCEPT:this.internalClose(We.resolve(a));break;case vo.DECLINE:case vo.EXIT:this.internalClose(We.reject(a));break;default:Qe.warn("[IntegratedPaymentModal] Unrecognized gateway message received",s)}}setupStepHandler(e){const t=e.setup;void 0!==t.display_gateway_fullscreen&&this.setFullscreen(t.display_gateway_fullscreen),void 0!==t.enable_close&&this.setEnableClose(t.enable_close),t.heading&&(this.header=t.heading)}dataSetupHandler(e){const t=qe[0].getElementById("vd-payment-gateway").contentWindow,n={payment:{amount:this.options.paymentData.amount,external_transaction_id:this.options.paymentData.externalTransactionIds,register_sale_payment_id:this.options.paymentData.registerSalePaymentIds,reference_id:this.options.paymentData.paymentId,register_id:this.posStateManager.getRegisterId()},register_sale:this.options.saleData,step:vo.DATA,success:!0};t.postMessage(JSON.stringify(n),e.origin)}printSignatureSlipHandler(e){this.preloadSignatureImage(e.signature_url).then(t=>{e.signature_url=t,e.transaction_status="APPROVED_SIGNATURE",this.paymentManager.emit("printReceipt",{isSignatureSlipReceipt:!0,paymentType:this.options.paymentData.paymentType,transaction:{tenders:[{amount:this.options.paymentData.amount,card_details:{card:{last_four:e.card_last_four}},created_at:e.payment_date?e.payment_date:ee.utc().format(),external_transaction_id:e.external_transaction_id,provider_fields:{signature_base64:e.signature_base64?"data:image/png;base64,"+e.signature_base64:null,signature_url:e.signature_url,terminal_id:e.terminal_serial_number}}]}}),this.internalClose(We.resolve(e))})}preloadSignatureImage(e){return We(t=>{if(e){const n=new Image;n.addEventListener("load",()=>t(e)),n.addEventListener("error",()=>t()),n.src=e}else t()})}}yo.$inject=["$scope","close","options","paymentManager","posStateManager","vdTracking"];class fo{constructor(e,t,n,s,a,i){this.Modal=e,this.Confirm=t,this.saleTransformer=n,this.vdCurrencyFilter=s,this.paymentsResourceService=a,this.registerManager=i}partialPayment(e,t){return this.Modal({controller:"partialPaymentModalController",controllerAs:"$ctrl",template:'<vd-dialog size="\'medium\'" close="$ctrl.close">\n  <header class="vd-dialog-header">\n    <vd-header category="dialog">\n      Pay {{$ctrl.options.availableCredit | vdCurrency}} with {{$ctrl.paymentTypeName}}\n    </vd-header>\n  </header>\n  <div class="vd-dialog-content">\n    <p class="vd-p">\n      You can only redeem up to the value of your current {{$ctrl.paymentTypeName | lowercase}} balance.\n      You may still continue with this as a partial payment, then choose another payment method for the\n      remaining balance.\n    </p>\n  </div>\n  <div class="vd-dialog-actions">\n    <div class="vd-btn-group">\n      <button class="vd-btn vd-btn--supplementary" ng-click="$ctrl.close()">Choose a different payment type</button>\n      <button class="vd-btn vd-btn--do" vd-focus="{isFocusable: true}" ng-click="$ctrl.makePartialPayment()">Make partial payment</button>\n    </div>\n  </div>\n</vd-dialog>\n',paymentType:e,availableCredit:t})}swiperPayment({amount:e,paymentType:t,originalRegisterSalePaymentId:n,currency:s}){return We((a,i)=>{this.Modal({controller:"swiperPaymentModalController",controllerAs:"$ctrl",template:'<vd-dialog close="$ctrl.close" dismissible="$ctrl.canCloseModal()">\n  <div class="wr-partial-dialog-content" ng-include="$ctrl.getTemplate()"></div>\n</vd-dialog>\n',amount:e,originalRegisterSalePaymentId:n,currency:s,paymentType:t}).then(e=>e.closed).then(e=>{e?a(e):i()})})}confirmAfterpayRefund(e){const t=this.vdCurrencyFilter(e);return this.Confirm({header:`Refund ${t} with Afterpay`,content:`\n        <p class="vd-p">\n          To continue with this refund, you must pay the full tender amount of ${t} with Afterpay.\n        </p>`,cancel:"Cancel",confirm:{label:"Make Full Refund",resolve:()=>e}})}confirmAfterpayPayment(e){const t=this.vdCurrencyFilter(e);return this.Confirm({header:`Pay ${t} with Afterpay`,content:`\n        <p class="vd-p">\n          To continue with this payment, you must pay the full tender amount of ${t} with Afterpay.\n        </p>`,cancel:"Cancel",confirm:{label:"Make Full Payment",resolve:()=>e}})}afterpayPayment(e){const t=this.registerManager.getActiveRegister(),n=t&&t.id;return this.paymentsResourceService.getPairings(e.paymentType.id).then(t=>this.displayAfterpayModal({data:e,pairings:t,registerId:n})).catch(()=>this.displayAfterpayModal({data:e,registerId:n})).then(e=>e.close)}displayAfterpayModal({data:e,pairings:t,registerId:n}){const s=((e,t)=>e&&e.some(e=>e.register_id===t))(t,n);return e=r(r({},e),{},{hasPairing:s}),this.Modal({controller:"afterpayPaymentModalController",controllerAs:"$ctrl",template:'<vd-dialog close="$ctrl.close" size="$ctrl.isRefund ? \'small\' : \'standard\'" dismissible="$ctrl.canCloseModal()">\n  <header ng-if-start="!$ctrl.isRefund" class="vd-dialog-header">\n    <vd-header category="dialog">\n      {{ $ctrl.registerHasPairing ? \'Scan barcode to accept Afterpay payment.\' : \'This register is not set up to use Afterpay.\'}}\n    </vd-header>\n  </header>\n\n  <div class="vd-dialog-content">\n    <form ng-if="$ctrl.registerHasPairing" id="afterpay-form" name="$ctrl.afterPayForm" novalidate>\n      <div class="vd-field">\n        <div class="vd-label">In-store Barcode</div>\n        <div class="vd-value vd-pb1">\n          <input class="vd-input"\n            autocomplete="off"\n            placeholder="Scan the in-store barcode from the Afterpay mobile app"\n            name="preApprovalCode"\n            ng-keypress="$ctrl.measureApprovalCodeEntry($event)"\n            ng-model="$ctrl.preApprovalCode"\n            ng-required="true"\n            ng-class="{ \'vd-input--error\' : $ctrl.isFormInErroredState() }"\n            vd-focus="{ isFocusable: true }">\n          <span ng-if="$ctrl.isSubmitting" class="vd-loader vd-loader--small vd-loader--input"></span>\n        </div>\n\n        <ng-messages ng-if="$ctrl.afterPayForm.$submitted && $ctrl.afterPayForm.preApprovalCode.$error.required"\n          class="vd-input-error-message-section"\n          for="$ctrl.afterPayForm.preApprovalCode.$error">\n          <ng-message when="required">\n            <vd-icon icon="fa-exclamation-triangle"></vd-icon>\n            <span class="vd-input-error-message-text">Please enter a barcode</span>\n          </ng-message>\n        </ng-messages>\n\n        <div ng-if="$ctrl.isFormInErroredState()" class="vd-input-error-message-section">\n          <vd-icon icon="fa-exclamation-triangle"></vd-icon>\n          <span class="vd-input-error-message-text">\n            {{$ctrl.errorMessage}}\n          </span>\n        </div>\n      </div>\n    </form>\n\n    <div ng-if="!$ctrl.registerHasPairing">\n      <p class="vd-p">Pair this register with Afterpay in your payment type settings to be able to take Afterpay payments. To complete this sale, choose another payment type.</p>\n    </div>\n  </div>\n\n  <div ng-if-end class="vd-dialog-actions">\n    <button ng-if="$ctrl.registerHasPairing"\n      ng-click="$ctrl.initiatePayment()"\n      class="vd-btn vd-btn--do"\n      ng-disabled="$ctrl.isSubmitting"\n      form="afterpay-form"\n      >\n      Accept\n    </button>\n    <button ng-if="!$ctrl.registerHasPairing"\n      ng-click="$ctrl.close()"\n      class="vd-btn vd-btn--do"\n    >\n      Choose Another Payment Type\n    </button>\n  </div>\n\n  <div ng-if="$ctrl.isRefund" class="vd-dialog-content swiper-processing">\n    <div class="vd-align-center">\n      <div class="vd-loader vd-mb3"></div>\n      <div class="vd-text-heading">\n        Processing\u2026\n      </div>\n    </div>\n  </div>\n</vd-dialog>\n',data:e})}integratedPayment({currency:e,retailerPaymentTypeId:t,paymentType:n,amountTendered:s,sale:a,registerId:i,externalTransactionIds:r,registerSalePaymentIds:o}){const l={currency:e,retailerPaymentTypeId:t,amount:c.round(s),paymentType:n,registerId:i,externalTransactionIds:r,registerSalePaymentIds:o,paymentId:se()},d=this.saleTransformer.toClientApi(a);return this.Modal({controller:yo,controllerAs:"$ctrl",template:'<vd-dialog size="\'large\'" close="$ctrl.close" dismissible="$ctrl.canCloseModal()" class="integrated-payment-dialog" ng-class="{ \'integrated-payment-dialog--fullscreen\' : $ctrl.isFullscreen }">\n  <header ng-if="$ctrl.header" class="vd-dialog-header">\n    <vd-header category="dialog">{{$ctrl.header}}</vd-header>\n  </header>\n  <div class="vd-dialog-content vd-pa0">\n    <iframe id="vd-payment-gateway"\n      tabindex="0"\n      ng-src="{{$ctrl.gatewaySrc}}"\n      frameborder="0"\n      class="integrated-payment-iframe"\n      ng-class="{ \'integrated-payment-iframe--fullscreen\' : $ctrl.isFullscreen }">\n    </iframe>\n  </div>\n</vd-dialog>\n',paymentData:l,saleData:d}).then(e=>e.close).then(e=>e?(e.payment_id=l.paymentId,e):We.reject({step:vo.DISMISSED}))}cashPayment(e,t,n,s){return this.Modal({controller:"cashModalController",controllerAs:"$ctrl",template:'<cash-payment-modal\n  class="payment-cash-modal"\n\tamount-to-pay="$ctrl.roundedAmountTendered"\n\tbalance-remainder="$ctrl.roundedBalance.remainder"\n\tclose="$ctrl.internalClose"\n\tcurrency-symbol="$ctrl.currencySymbol"\n\tis-partial-payment="$ctrl.isPartialPayment"\n\topen-cash-drawer="$ctrl.openCashDrawer"\n\trounding="$ctrl.rounding">\n</cash-payment-modal>\n',currencySymbol:e,roundedAmountTendered:t,roundedBalance:n,rounding:s})}cashDiscountingPayment({amountTendered:e,balance:t,cashDiscountedBalance:n}){return this.Modal({controller:"cashDiscountingModalController",controllerAs:"$ctrl",template:'<vd-dialog close="$ctrl.close">\n  <header class="vd-dialog-header vd-mb0" vd-flex vd-flex-align="center" vd-flex-direction="column">\n    <vd-header category="page">\n      Collect {{$ctrl.cashDiscountedBalance | vdCurrency}}\n    </vd-header>\n  </header>\n\n  <div class="vd-dialog-actions vd-align-center">\n    <div class="vd-text--intro vd-text--secondary vd-mb3">Quick cash payment</div>\n    <div class="vd-btn-group">\n      <button ng-if="$ctrl.tenderedAmountMatchesBalance"\n        type="button"\n        class="vd-btn vd-btn--do"\n        ng-click="$ctrl.payCashDiscountedAmount()">\n          {{$ctrl.cashDiscountedBalance | vdCurrency}}\n      </button>\n\n      <button type="button" ng-click="$ctrl.payTenderedAmount()" class="vd-btn"\n        ng-class="{\n          \'vd-btn--supplementary\': $ctrl.tenderedAmountMatchesBalance,\n          \'vd-btn--do\': !$ctrl.tenderedAmountMatchesBalance,\n        }">\n        {{$ctrl.amountTendered | vdCurrency}}\n      </button>\n    </div>\n  </div>\n</vd-dialog>\n',amountTendered:e,balance:t,cashDiscountedBalance:n}).then(e=>e.close)}partialAuth(e){return this.Modal({controller:"partialAuthModalController",controllerAs:"$ctrl",template:'<vd-dialog size="\'medium\'" close="$ctrl.close" dismissible="false">\n  <header class="vd-dialog-header">\n    <vd-header category="dialog">\n      Only {{ $ctrl.approvedAmount | vdCurrency }} of this payment has been approved.\n    </vd-header>\n  </header>\n  <div class="vd-dialog-content">\n    <p class="vd-p">\n      Continue to take payment for the remaining balance, or refund this amount to take payment another way or\n      discard the sale.\n    </p>\n  </div>\n  <div class="vd-dialog-actions">\n    <div class="vd-btn-group">\n      <button class="vd-btn vd-btn--supplementary" ng-click="$ctrl.reversePartialAuth()">Refund Partial Payment</button>\n      <button class="vd-btn vd-btn--do" vd-focus="{isFocusable: true}" ng-click="$ctrl.makePartialAuth()">Continue</button>\n    </div>\n  </div>\n</vd-dialog>\n',approvedAmount:e})}}fo.$inject=["Modal","Confirm","saleTransformer","vdCurrencyFilter","paymentsResourceService","registerManager"];const So="/api/2.0/registers/:registerId/transactions",Co="/api/2.0/payment_types/:retailerPaymentTypeId/pairings";class bo{constructor(e,t,n,a){this.options=n,this.vdEscapeStack=a,s(this,"close",void 0),s(this,"currencySymbol",void 0),s(this,"roundedAmountTendered",void 0),s(this,"roundedBalance",void 0),s(this,"rounding",void 0),s(this,"isPartialPayment",void 0),s(this,"openCashDrawer",void 0),s(this,"internalClose",void 0),this.internalClose=t,this.close=()=>this.internalClose(We.reject()),this.currencySymbol=n.currencySymbol,this.roundedAmountTendered=n.roundedAmountTendered,this.roundedBalance=n.roundedBalance,this.rounding=n.rounding,this.isPartialPayment=c.vn(this.roundedAmountTendered.rounded).abs().lt(c.vn(this.roundedBalance.rounded).abs()),this.openCashDrawer=()=>{He.$emit(Ns.PRINT,{type:"open-drawer"})},this.vdEscapeStack.register(this.close),e.$on("$destroy",()=>this.vdEscapeStack.deregister(this.close))}}bo.$inject=["$scope","close","options","vdEscapeStack"];const _o=[500,1e3,2e3];class wo{constructor(e,t,n,a,i,r,o){this.close=e,this.registerManager=n,this.paymentManager=a,this.paymentsResourceService=i,this.vdTracking=r,this.vdPerformanceTracking=o,s(this,"WORKFLOWS",br),s(this,"dismissible",void 0),s(this,"econduitErrorMessage",void 0),s(this,"paymentConfig",void 0),s(this,"paymentTransaction",void 0),s(this,"paymentType",void 0),s(this,"paymentTypeId",void 0),s(this,"signatureSrc",void 0),s(this,"workflow",void 0),this.paymentTypeId=t.paymentType.type_id,this.paymentType=t.paymentType;const l=c.vn(t.amount),d=t.currency;this.paymentConfig={transactionId:se(),registerId:n.getActiveRegister().id,retailerPaymentTypeId:t.paymentType.id,data:{amount:l.toNumber(),currency:d}},t.originalRegisterSalePaymentId&&(this.paymentConfig.data.original_register_sale_payment_id=t.originalRegisterSalePaymentId);for(const s of Object.keys(lr))ze.put(this._getTemplateUrl(s),lr[s]);this._initiatePaymentProcess({isRefund:l.isNeg()})}declineSignature(){this._declineTransaction("Swiper Decline Signature")}_getTemplateUrl(e){return"SWIPER_PAYMENT_"+e}getTemplate(){let e;switch(this.workflow){case br.PROCESSING:case br.REVERSING:e="PROCESSING";break;case br.APPROVE:e="APPROVE";break;case br.PARTIAL_APPROVED:e="PARTIAL_APPROVE";break;case br.FAILED_SIGNATURE:case br.FAILED_SIGNATURE_APPROVE:e="FAILED_SIGNATURE";break;default:e="ERROR"}return this._getTemplateUrl(e)}getErrorHeader(){return _r[this.workflow].header}getErrorContent(){return _r[this.workflow].content}getAdditionalErrorContent(){return this.workflow===br.ECONDUIT_ERROR?"The processor error is: "+this.econduitErrorMessage:""}canCloseModal(){return this.dismissible=this.workflow in Cr,this.dismissible}printSignatureReceipt(){this.paymentManager.emit("printReceipt",{isSignatureSlipReceipt:!0,paymentType:this.paymentType,transaction:this.paymentTransaction}),this.workflow=br.FAILED_SIGNATURE_APPROVE}_initiatePaymentProcess({isRefund:e}){const t=e?"processRefund":"processPayment";this.workflow=br.PROCESSING,this.vdPerformanceTracking.start("Swiper Payment"),this.paymentsResourceService[t](this.paymentConfig).then(()=>this._pollForTransaction()).then(e=>this._handlePaymentSuccess(e)).catch(e=>this._handleResponseError(e)).finally(()=>{this.vdPerformanceTracking.stop("Swiper Payment",{eventName:"Swiper Payment",metadata:{isRefund:e,paymentTypeId:this.paymentTypeId,transactionId:this.paymentConfig.transactionId}})})}_handlePaymentSuccess(e){let t=We.resolve();switch(e.status){case pr:case fr:{this.paymentTransaction=e;const n=e.tenders[0].status;n===ur?t=this._confirmTransactionSignature(e).then(e=>{this.signatureSrc=e,this.workflow=br.APPROVE}).catch(()=>{this.workflow=br.FAILED_SIGNATURE}):n===cr||n===dr||n===fr?this.close(e):this.workflow=br.UNKNOWN;break}case hr:e.tenders[0].status===vr?(this.workflow=br.DECLINED,this._printDeclinedReceipt(e)):this.workflow=br.CANCELLED;break;case gr:this.workflow=br.CANCELLED_BUSY;break;case mr:this.workflow=br.CANCELLED_BAD_CARD;break;case Sr:this.workflow=br.TIMEOUT;break;default:this.workflow=br.UNKNOWN}return t}_handleResponseError(e){const t=e.data&&e.data.code;switch(e.status){case 400:case 404:case 500:case 501:this.workflow=wr[t]||br.UNKNOWN,this.workflow===br.ECONDUIT_ERROR&&e.data.error&&(this.econduitErrorMessage=e.data.error);break;default:this.workflow=br.UNKNOWN}}_handleReversalSuccess(){this.workflow=br.DECLINED_CASHIER}_getPollingTimeout(e){return _o[e]||2e3}_pollForTransaction(e){return We((t,n)=>{let s,a=0;this.vdTracking.trackUserEvent({eventName:"Swiper Polling For Transaction",metadata:{workflow:this.workflow,paymentTypeId:this.paymentTypeId,transactionId:this.paymentConfig.transactionId}});const i=()=>{a++,this.paymentsResourceService.getTransaction({registerId:this.paymentConfig.registerId,transactionId:this.paymentConfig.transactionId}).then(n=>{!n||!n.status||n.status===yr||e&&n.status!==e?s=Je(i,this._getPollingTimeout(a)):(Je.cancel(s),t(n))}).catch(e=>n(e))};s=Je(i,this._getPollingTimeout(a))})}_printDeclinedReceipt(e){const t=ys({receiptStatus:vr,transaction:e});this.paymentManager.emit("printReceipt",{receiptHtmlExtra:t})}_confirmTransactionSignature(e){return We((t,n)=>{const s=this.registerManager.getActiveRegister().id,a=new Image,i=`/api/2.0/registers/${s}/transactions/${e.register_sale_payment_id}/signature.png`;a.addEventListener("load",()=>t(i)),a.addEventListener("error",()=>n()),a.src=i})}_declineTransaction(e){this.workflow=br.REVERSING,this.vdPerformanceTracking.start(e),this.paymentsResourceService.processPaymentReversal(this.paymentConfig).then(()=>this._handleReversalSuccess()).catch(e=>this._handleResponseError(e)).finally(()=>{this.vdPerformanceTracking.stop(e,{eventName:e,metadata:{paymentTypeId:this.paymentTypeId,transactionId:this.paymentConfig.transactionId}})})}_isPartialApproved(){const e=this.paymentTransaction.tenders[0],t=e.amount,n=e.provider_fields.request_amount;return e.provider_fields.is_partial_approved&&c.vn(t).gt(0)&&c.vn(n).gt(t)}reversePartialPayment(){this._declineTransaction("Swiper Decline Partial Auth")}confirmAndAccept(){this._isPartialApproved()?this.workflow=br.PARTIAL_APPROVED:this.close(this.paymentTransaction)}}wo.$inject=["close","options","registerManager","paymentManager","paymentsResourceService","vdTracking","vdPerformanceTracking"];const Mo=({amountToPay:e})=>{const t=c.vn(e.rounded),n=c.add(e.remainder,t),s=Ka();return i.createElement("div",{className:"payment-cash-modal-header"},i.createElement("div",{className:"payment-cash-modal-header-headline"},i.createElement(ae,null,"Amount to Pay")),i.createElement("div",{className:"payment-cash-modal-header-balance"},i.createElement(ae,null,s(t.toNumber())),i.createElement("span",null,!t.eq(n)&&`Rounded ${t.gt(n)?"up":"down"} from ${s(n)}`)))},To=(e,t)=>c.vn(e).dividedBy(c.vn(t)).mod(1).eq(0),Eo=[[1,5,10,20],[2,5,10,20],[3,5,10,20],[4,5,10,20],[5,10,20,50],[6,10,20,50],[7,10,20,50],[10,8,20,50],[10,20,9,50],[10,20,50,100],[11,20,15,21],[12,20,15,50],[20,13,15,50],[20,14,15,50],[15,20,50,100],[20,16,50,100],[20,17,50,100],[20,18,50,100],[20,19,50,100],[20,50,100,40],[21,25,50,30],[22,25,40,30],[23,25,40,30],[24,25,30,40],[25,40,30,50],[26,40,30,50],[27,30,40,50],[28,30,40,50],[30,40,29,50],[30,40,50,100],[40,31,50,100],[40,32,50,35],[40,33,50,35],[40,34,50,35],[35,40,50,100],[40,36,50,100],[40,37,50,100],[40,38,50,100],[40,50,39,100],[40,50,100,45],[41,50,100,45],[42,50,100,45],[43,50,45,100],[44,45,50,100],[45,50,60,100],[46,50,60,100],[50,47,60,100],[50,48,60,100],[50,60,49,100],[50,60,100,55],[51,60,100,55],[52,60,100,55],[60,53,100,55],[60,54,100,55],[55,60,100,70],[60,56,100,70],[60,57,100,70],[60,58,100,70],[60,59,100,70],[60,100,70,80],[61,100,70,65],[62,100,70,65],[63,100,70,65],[64,100,65,70],[65,100,70,80],[66,100,70,80],[67,70,100,80],[68,70,100,80],[69,70,100,80],[70,100,80,90],[100,80,71,75],[72,100,80,75],[100,80,73,75],[100,80,74,75],[75,100,80,90],[100,80,76,90],[80,100,77,90],[80,100,78,90],[80,100,79,90],[80,100,90,500],[100,81,90,85],[100,82,85,90],[100,83,85,90],[100,84,85,90],[85,100,90,105],[100,86,90,101],[100,87,90,107],[100,88,90,108],[100,89,90,95],[90,100,110,99],[100,91,101,95],[100,92,102,95],[100,93,95,103],[100,94,95,110],[95,100,110,105],[100,96,110,101],[100,97,110,200],[100,98,110,200],[100,99,110,109],[100,110,200,101],[101,120,105,110],[102,105,120,110],[103,105,120,110],[104,105,110,120],[105,110,120,150],[106,120,110,150],[107,110,120,200],[108,110,120,200],[109,110,120,150],[110,120,150,200],[111,120,150,200],[112,120,115,200],[120,113,115,200],[120,114,115,150],[115,120,200,150],[120,116,150,200],[120,117,150,200],[120,118,150,200],[120,119,150,200],[120,150,200,130],[121,200,130,125],[122,125,150,140],[123,125,140,130],[124,125,140,130],[125,140,130,150],[126,140,130,150],[127,130,140,150],[128,140,130,150],[129,130,140,150],[130,140,150,200],[140,131,150,200],[132,140,200,150],[140,133,150,200],[140,134,150,200],[135,140,150,200],[136,140,150,200],[140,137,150,200],[140,138,150,200],[139,140,150,200],[140,150,200,500],[141,150,200,160],[142,150,200,145],[143,150,200,145],[144,150,200,145],[145,150,160,200],[146,150,160,200],[150,147,160,200],[148,150,200,160],[149,150,160,200],[150,160,200,500],[151,160,200,155],[152,160,200,155],[153,160,200,155],[154,160,200,155],[155,160,200,170],[156,160,200,170],[160,157,200,170],[158,160,200,170],[159,160,200,170],[160,200,170,161],[161,200,170,180],[162,200,170,165],[163,200,180,165],[164,200,170,165],[165,200,170,180],[166,200,170,180],[167,170,200,180],[168,200,170,180],[169,200,170,180],[170,200,180,190],[171,200,180,172],[172,180,200,175],[200,173,180,175],[174,200,180,175],[175,200,180,190],[176,180,200,190],[200,177,180,190],[178,180,200,190],[179,200,180,190],[180,200,190,500],[200,181,190,185],[200,182,185,190],[200,183,185,190],[200,184,185,190],[185,200,190,205],[186,200,190,500],[200,187,190,500],[200,188,190,204],[189,200,190,195],[190,200,500,208],[200,191,195,201],[200,192,500,195],[200,193,195,210],[200,194,195,500],[195,200,210,500],[200,196,500,201],[200,197,500,210],[198,200,208,210],[199,200,220],[200,500,210,220],[201,205,210,220],[202,205,210,220],[203,205,220,210],[204,205,220,210],[205,210,220,250],[206,220,210,250],[207,220,210,250],[208,210,220,300],[209,210,220,250],[210,220,250,300],[211,220,215,212],[212,220,215,300],[213,220,215,250],[220,214,300,215],[215,220,250,300],[216,220,300,500],[220,217,250,300],[220,218,300,250],[219,220,250,300],[220,250,300,500],[221,300,500,225],[222,225,300,230],[223,225,250,240],[224,225,240,250],[225,250,240,230],[226,240,230,250],[227,230,240,250],[228,240,230,300],[229,230,240,250],[230,240,250,300],[231,240,300,250],[232,240,300,250],[233,240,235,250],[234,240,250,300],[235,240,250,300],[236,240,250,300],[237,240,250,300],[238,240,250,300],[239,240,250,300],[240,250,300,500],[241,300,250,260],[242,250,300,260],[243,250,300,260],[244,250,245,260],[245,250,300,260],[246,250,300,260],[247,260,250,300],[248,250,260,300],[249,250,300,260],[250,260,300,500],[251,300,260,252],[252,300,260,255],[253,300,260,255],[254,260,300,255],[255,260,300,270],[256,260,300,261],[260,257,300,306],[258,260,300,270],[259,260,300,265],[260,300,270,310],[261,300,280,265],[262,300,270,280],[263,270,300,280],[264,300,270,265],[265,300,270,280],[266,270,300,280],[300,267,270,280],[268,270,300,280],[269,300,270,280],[270,300,280,500],[271,300,280,275],[272,280,300,275],[273,300,280,275],[274,300,280,275],[275,300,280,285],[276,300,280,281],[277,280,300,290],[278,300,280,500],[279,300,280,290],[280,300,500,290],[281,300,290,285],[282,300,285,500],[300,283,285,290],[300,284,285,290],[285,300,290],[286,300,500],[300,287,290,500],[288,300,290,303],[289,300,290,500],[290,300,400,500],[300,291,301],[292,300,295,400],[300,293,295],[294,300,295,304],[295,300,310],[300,296],[297,300],[298,300,310],[299,300,500,310],[300,500],[301,320,305,400],[302,305,320,400],[303,305,310,320],[304,305,320,350],[305,310,320,400],[306,310,320,311],[307,310,320,350],[308,310,320,400],[309,310,320,400],[310,320,350,400],[311,320,400,325],[312,320,400,315],[320,313,323,350],[314,320,400,315],[315,320,350,400],[316,320,400,350],[317,320,400,500],[318,320,350,400],[319,320,350,400],[320,350,400,500],[321,350,340,400],[322,325,400,350],[323,340,330,325],[324,340,400,325],[325,340,400,330],[326,340,400,330],[327,340,350,330],[328,330,350,340],[329,340,330,350],[330,340,400,350],[331,340,400,341],[332,340,350,500],[333,340,400,335],[334,340,400,335],[335,350,340,400],[336,400,350,340],[337,340,350,400],[338,340,350,400],[339,340,350,400],[340,350,400,500],[341,400,350,360],[342,400,345,350],[343,350,400,500],[344,345,350,360],[345,350,400,360],[346,350,360],[347,350,360,400],[348,350,360,400],[349,350,360,400],[350,500,360,400],[351,360,400],[352,360,400],[353,360,355,400],[354,400,360,355],[355,400,360,500],[360,356,400,500],[357,400,360,370],[358,400,360],[359,360,400,370],[360,400,500,370],[361,400,370,380],[362,400,500,370],[363,400,380,365],[364,400,380,370],[365,380,400,370],[366,400,370,367],[367,370,380,400],[368,400,370,380],[369,400,370,380],[370,380,400,500],[371,400,380,375],[372,380,400,375],[373,400,375,380],[374,400,380,420],[375,380,400,390],[376,400,380],[377,380,400],[378,400,380,390],[379,380,400],[380,500,400],[381,400,500],[382,400,500,385],[400,383,390,500],[384,400,385,390],[385,400,390],[386,400,390,500],[400,387,390],[388,400,390,500],[389,400,390,450],[390,400,500],[391,400],[392,400,402],[393,400,395,403],[400,394,500],[395,400],[396,400],[400,397],[398,400,500],[399,400,500],[400,500,410],[401,500],[402,405,420,500],[403,420,405],[404,410,420],[405,410,420,450],[406,420],[407,420,500,410],[408,420,410],[409,420,410,450],[410,420,450,500],[411,415,421],[412,420,415],[413,500,420],[414,420,500,450],[415,420,500,450],[416,450],[417,420,500,450],[418,420,500],[419,420,450,500],[420,500,450],[421],[422,425,430,500],[423,425,440,450],[424,425,430,500],[425,430,440,450],[426,430,440,450],[427,440,450,430],[428,440,500,430],[429,430,450,440],[430,440,500],[431,440,450,451],[432,500,440,450],[433,500,450,435],[434,440,500,435],[435,440,500,450],[436,440,500],[437,440,450],[438,440,450],[439,450,440,500],[440,500,450,460],[500,441,450],[442,450,500],[443,445,450,500],[444,445,450,500],[445,460,500,450],[446,450,500,460],[447,450,460],[448,450,460],[449,450,500,460],[450,500,460],[451,500],[452,460],[453,455,470,500],[460,454,470,500],[455,460,500],[456,500],[457,460,500],[458,460],[459,500,460,470],[460,500],[461,500,465],[462,465,500],[463,500,470],[464,500,470,480],[465,500],[466,500,467,470],[467,500,470,480],[468,500,480,470],[469,480,500],[470,500,480],[500,471],[472,500],[473,480,500],[474,500,480],[475,500,480],[476,500,480],[477,480,500],[478,480,500],[479,480,500],[480,500],[500,481,482,490],[500,482,485,490],[483,490,500],[484,500,485],[485,500,490],[486,490,500],[487,500],[488,500,490],[489,500,490],[490,500],[491,500],[492,500],[500,493,495],[494,500],[495,500],[496,500],[497,500],[498,500],[499,500],[500]],ko=({handlePayment:e,amountToPay:t,currencySymbol:n,rounding:s})=>{const a=Ka(),[r,o]=i.useState(""),l=c.vn(t.rounded),d=(e=>{let t=Eo[Math.ceil(e)-1];return void 0===t?[]:(e%1==0&&(t=t.filter(t=>t!==e)),t.slice(0,3).sort((e,t)=>e-t).map(e=>c.vn(e)))})(l.toNumber()).slice(0,2),u=""===r.trim(),h=(()=>{if(isNaN(Number(r)))return"Please enter a number.";if(l.gt(c.vn(r))){return`Please enter an amount equal to or greater than ${a(l.toNumber())}.`}if(To(r,s))return"";return`Please round the amount to a ${a(c.vn(s).toNumber())} value.`})(),m=!u&&""!==h;return i.createElement(i.Fragment,null,i.createElement("div",{className:"payment-cash-modal-actions"},i.createElement("div",{className:"payment-cash-modal-actions-item"},i.createElement("div",{className:"vd-field"},i.createElement("div",{className:"vd-value"},i.createElement("input",{className:"vd-input payment-cash-modal-actions-input "+(m?"vd-input--error":""),onChange:e=>o(e.target.value),onKeyDown:({key:t})=>(t=>{"Enter"!==t||u||m||e(c.vn(r),"manual_enter")})(t),value:r,placeholder:"0.00",autoFocus:!0,type:"number",inputMode:"decimal"}),i.createElement("div",{className:"payment-cash-modal-actions-input--currency vd-input-icon vd-input-icon--left vd-input-symbol"},n)))),i.createElement("div",{className:"payment-cash-modal-actions-item"},i.createElement(W,{jumbo:!0,block:!0,variant:u?"supplementary":"do",disabled:m,onClick:()=>{u?e(l,"suggestion"):m||e(c.vn(r),"manual_click")}},i.createElement(ie,{in:!u,timeout:500,classNames:"animation",unmountOnExit:!0},i.createElement("span",{className:"payment-cash-modal-actions-item--collect"},"Collect"," ")),a(u?l.toNumber():parseFloat(r)))),i.createElement(re,{component:null},u&&d.map(t=>i.createElement(ie,{classNames:"animation",timeout:500,key:t.toNumber()},i.createElement("div",{className:"payment-cash-modal-actions-item payment-cash-modal-actions-item--suggestion"},i.createElement(W,{jumbo:!0,block:!0,variant:"supplementary",onClick:()=>e(t,"suggestion")},a(t.toNumber()))))))),i.createElement(ie,{in:m,timeout:500,classNames:"animation",unmountOnExit:!0},i.createElement("div",{className:"payment-cash-modal-actions-input-error"},i.createElement(oe,null,h))))},Io=({amountToPay:e,closeWithoutPayment:t,currencySymbol:n,handlePayment:s,rounding:a})=>i.createElement(Q,{header:i.createElement(Mo,{amountToPay:e}),content:i.createElement("span",{className:"vd-text-heading"},"Amount Given by Customer"),actions:i.createElement(ko,{rounding:a,amountToPay:e,handlePayment:s,currencySymbol:n}),onClose:()=>t()}),Po=({amountToPay:e,paid:t,pay:n})=>{const s=Ka(),a=c.subtract(e.rounded,t);return i.createElement("div",{className:"payment-cash-modal-change-refund"},i.createElement(Q,{header:i.createElement("h1",{className:"vd-text-grand vd-align-center"},"Give ",s(-a)," Change"),onClose:()=>n(c.vn(e.rounded)),actions:i.createElement(W,{block:!0,jumbo:!0,onClick:()=>n(c.vn(e.rounded)),variant:"do"},"Next Payment")}))},Ro=({amountToPay:{rounded:e},isPartialPayment:t,closeWithoutPayment:n,pay:s})=>{const a=Ka();return i.createElement("div",{className:"payment-cash-modal-change-refund"},i.createElement(Q,{header:i.createElement("h1",{className:"vd-text-grand vd-align-center"},"Refund ",a(-c.vn(e).toNumber())),onClose:()=>n(),actions:i.createElement(W,{block:!0,jumbo:!0,onClick:()=>s(c.vn(e)),variant:"no"},"Complete ",t?"Partial ":"","Refund")}))};var Ao=At(({amountToPay:e,balanceRemainder:t,close:n,currencySymbol:s,isPartialPayment:a,openCashDrawer:r,rounding:o})=>{const[l,d]=i.useState({display:!1,paid:c.vn(0)}),u=qa();if(void 0===e||void 0===t||void 0===n||void 0===s||void 0===a||void 0===r||void 0===o)return null;const h=(t,n)=>{a&&t.gt(e.rounded)?(d({display:!0,paid:t}),r()):m(t),u.trackUserEvent({eventName:"Cash Modal Payment Handled",metadata:{amountTendered:c.vn(e.rounded).toNumber(),amountPaid:t.toNumber(),isFinalPayment:!a,method:n}})},m=e=>{n(We.resolve({remainder:a?"0":c.vn(t).toString(),cashAmount:e.toString()}))};return c.vn(e.rounded).lt(0)?(r(),i.createElement(Ro,{amountToPay:e,isPartialPayment:a,closeWithoutPayment:()=>n(We.reject()),pay:m})):l.display&&l.paid?i.createElement(Po,{amountToPay:e,paid:l.paid,pay:m}):i.createElement(Io,{amountToPay:e,closeWithoutPayment:()=>n(We.reject()),currencySymbol:s,handlePayment:h,rounding:o})},["amountToPay","balanceRemainder","close","currencySymbol","isPartialPayment","openCashDrawer","rounding"]);var Do=At(()=>i.createElement("h1",{className:"vd-header vd-header--page"},et.current.name!==Ht&&i.createElement("a",{className:"vd-section-back pro-payment-close",href:"/webregister/",onClick:()=>et.go(jt)},i.createElement(q,{className:"vd-section-back-icon vd-mr1",icon:"back-arrow",vend:!0}))," ","Sale"));t.module("webregister.modals").service("paymentModalService",fo),t.module("webregister.services").service("paymentsResourceService",class{constructor(){s(this,"_pairingsResource",void 0),s(this,"_registerPaymentsResource",void 0),this._registerPaymentsResource=Ze(So,{registerId:"@registerId",transactionId:"@transactionId",retailerPaymentTypeId:"@retailerPaymentTypeId"},{processPayment:{method:"PUT",url:So+"/:retailerPaymentTypeId/payment/:transactionId"},processReversal:{method:"PUT",url:So+"/:retailerPaymentTypeId/reverse/:transactionId"},processRefund:{method:"POST",url:So+"/:retailerPaymentTypeId/refund/:transactionId"},getTransaction:{method:"GET",url:So+"/:transactionId"}}),this._pairingsResource=Ze(Co,{retailerPaymentTypeId:"@retailerPaymentTypeId"},{getPairings:{method:"GET",url:""+Co,isArray:!0}})}processPayment({registerId:e,transactionId:t,retailerPaymentTypeId:n,data:s}){return this._registerPaymentsResource.processPayment({registerId:e,transactionId:t,retailerPaymentTypeId:n},s).$promise.then(e=>e.toJSON())}processRefund({registerId:e,transactionId:t,retailerPaymentTypeId:n,data:s}){return this._registerPaymentsResource.processRefund({registerId:e,transactionId:t,retailerPaymentTypeId:n},s).$promise.then(e=>e.toJSON())}processPaymentReversal({registerId:e,transactionId:t,retailerPaymentTypeId:n,data:s}){return this._registerPaymentsResource.processReversal({registerId:e,transactionId:t,retailerPaymentTypeId:n},s).$promise.then(e=>e.toJSON())}getTransaction({registerId:e,transactionId:t}){return this._registerPaymentsResource.getTransaction({registerId:e,transactionId:t}).$promise.then(e=>e.toJSON())}getTransactions({registerId:e,registerSalePaymentIds:t}){return Ke.get(`/api/2.0/registers/${e}/transactions?register_sale_payment_id=${t.join("&register_sale_payment_id=")}`).then(Ue)}getPairings(e){return this._pairingsResource.getPairings({retailerPaymentTypeId:e}).$promise}}),t.module("webregister.controllers").controller("partialPaymentModalController",po).controller("swiperPaymentModalController",wo).controller("afterpayPaymentModalController",ho).controller("cashModalController",bo).controller("cashDiscountingModalController",mo).controller("partialAuthModalController",go),t.module("webregister.components").component("cashPaymentModal",Ao).component("backToSaleHeader",Do);class No{constructor(e,t,n,a,i,r,o,l,c){this.VdSuggestionSource=e,this.vdToastNotificationService=n,this.vdCustomerNameFilter=a,this.vdFeatureManager=i,this.customerModals=l,this.customerManager=c,s(this,"_customerCodeIndex",void 0),s(this,"_customerCodeSource",void 0),s(this,"_customerSearchSource",void 0),s(this,"_formatter",void 0),s(this,"_readOnlySource",void 0),s(this,"_source",void 0),s(this,"_type",void 0),s(this,"customerErrorTemplate",void 0);const d="customer";this.customerErrorTemplate="customer/customer-error.html",this._customerCodeIndex=r.store("customers").index("byCustomerCode"),this._type=d,this._customerSearchSource=new e({types:[d],search:({query:e})=>{const t={q:e};return Ke.get("/api/2.0/suggest?type=customer&page_size=30",{params:t}).then(({data:e})=>e.data||[])}}),this._customerCodeSource=new e({types:[d],init:()=>o.whenCompleteEntityDataAvailable("customers"),search:({query:e})=>this._customerCodeIndex.getAll(e),rawSuggestions:!0}),this._formatter=new t({type:d,displayKey:"displayName",template:'<react-customer-badge customer="$vdSuggestion.customer"\n  size="\'x-small\'"\n  class="vd-suggestion-badge",\n  group="$vdSuggestion.customerGroup">\n  </react-customer-badge>\n',enhance:e=>this._enhance(e)}),this._source=new e({sources:[this._customerCodeSource,this._customerSearchSource],formatters:[this._formatter],feelingLucky:e=>this._feelingLucky(e),create:({query:e})=>this._create({query:e}),isDuplicate:()=>!1}),this._readOnlySource=new e({sources:[this._customerCodeSource,this._customerSearchSource],formatters:[this._formatter],feelingLucky:e=>this._feelingLucky(e)})}getSource(e={}){return e.readOnly?this._readOnlySource:e.customerCodeOnly?this._customerCodeSource:e.create?new this.VdSuggestionSource({sources:[this._customerCodeSource,this._customerSearchSource],formatters:[this._formatter],feelingLucky:e=>this._feelingLucky(e),create:e.create}):this._source}getFormatter(){return this._formatter}_enhance(e){return We((t,n)=>We.resolve(e.customer||pa.get(e.id)).then(t=>t?We.resolve(this.vdFeatureManager.get("customer_groups")?this.customerManager.getCustomerGroup(t):void 0).then(e=>({customer:t,customerGroup:e})).catch(e=>(Qe.warn("[customerSuggestionEnhance] Failed to lookup customer group.",e),{customer:t,customerGroup:void 0})):(n(`Customer with id ${e.id} could not be found.`),We.reject())).then(n=>{const s=y({},e,{customer:n.customer,displayName:this.vdCustomerNameFilter(n.customer),customerGroup:n.customerGroup});t(s)}))}_feelingLucky({query:e,pendingSuggestion:t,pendingCreate:n}){return this._customerCodeIndex.getAll(e).then(s=>{let a;if(s.length>1?a=`More than 1 result found for "${e}". Try typing that into the search field to see results.`:s.length||(a=`No results found for "${e}". Try searching by customer name.`),a){if(t)return t;if(n)return;return Qe.debug("[customerSuggestionSource] "+a,s),void this.vdToastNotificationService.negative({message:a})}const i=this._type;return{id:s[0].id,type:i,[i]:s[0]}})}_create({query:e}){return this.customerModals.createCustomer({query:e}).then(e=>({id:e.id,type:this._type,customer:e})).catch(()=>{He.$emit("autocomplete:customer-search:focus",{isFocusable:!0,focusDelay:200})})}}No.$inject=["VdSuggestionSource","VdSuggestionFormatter","vdToastNotificationService","vdCustomerNameFilter","vdFeatureManager","Database","syncManager","customerModals","customerManager"];const xo={canViewDetails:!0,hideRemoveFromSale:!1,hideViewSales:!1};class Oo{constructor(e,t,n,a,i,r){this.$attrs=e,this.customerManager=t,this.customerModals=n,this.saleManager=a,this.vdTracking=i,this.vdFeatureManager=r,s(this,"customer",void 0),s(this,"customerGroup",void 0),s(this,"hasMadePartialCustomerPaymentsTooltip",void 0),s(this,"isUnfulfilledSaleTooltip",void 0),s(this,"viewOptions",void 0)}$onInit(){this.viewOptions=t.merge({},xo,this.viewOptions),this.saleManager.init().then(()=>this._setCustomerGroup()),this.hasMadePartialCustomerPaymentsTooltip={template:'\n        <vd-tooltip class="wr-tooltip">\n          <div class="vd-text-label vd-pb2">\n            <vd-icon icon="fa-info-circle"></vd-icon>&nbsp;&nbsp;Customer balance used for payment.\n          </div>\n          This customer can\'t be removed from the sale because a partial payment has been made using Loyalty or Store&nbsp;Credit.\n        </vd-tooltip>\n      ',showOnTouch:!0},this.isUnfulfilledSaleTooltip={template:'\n        <vd-tooltip class="wr-tooltip">\n          <div class="vd-text-label vd-pb2">\n            <vd-icon icon="fa-info-circle"></vd-icon>&nbsp;&nbsp;Sale is unfulfilled.\n          </div>\n          This customer can\'t be removed from the sale as the sale is&nbsp;unfulfilled.\n        </vd-tooltip>\n      ',showOnTouch:!0}}$postLink(){this.$attrs.$addClass("wr-customer-badge")}removeCustomerFromSale(){return this.saleManager.removeCustomer().then(()=>this._focusCustomerSearchIfNeeded())}viewCustomer(){this.vdTracking.trackUserEvent({eventName:"Show Customer Lightbox"}),this.customerModals.viewCustomer(this.customer,{hideRemoveFromSale:!this.canRemoveCustomerFromSale(),hideViewSales:this.viewOptions.hideViewSales}).then(()=>this._setCustomerGroup())}canRemoveCustomerFromSale(){const{sale:e}=this.saleManager;if(this.viewOptions.hideRemoveFromSale||!e)return!1;const n=t.isUndefined(e.status);return Boolean(e.customer&&e.customer.id===this.customer.id&&(n||!e.isCompleted()&&!e.isConfirmed())&&!e.hasCustomerRelatedPayments()&&!this.unfulfilledSale())}unfulfilledSale(){return this.saleManager.sale.isMarkedAsUnfulfilled()}inProgressSaleHasCustomerPayments(){const{sale:e}=this.saleManager;if(this.viewOptions.hideRemoveFromSale||!e)return!1;const n=t.isUndefined(e.status);return Boolean(e.customer&&e.customer.id===this.customer.id&&(n||!e.isCompleted()&&!e.isConfirmed())&&e.hasCustomerRelatedPayments())}_focusCustomerSearchIfNeeded(){et.is(jt)&&He.$emit("autocomplete:customer-search:focus",{isFocusable:!0})}_setCustomerGroup(){return this.customer?this.vdFeatureManager.get("customer_groups")?this.customerManager.getCustomerGroup(this.customer).then(e=>{this.customerGroup=e}).catch(e=>{Qe.warn("[WrCustomerBadge] Failed to lookup customer group",e)}):void(this.customerGroup=void 0):We.resolve()}}Oo.$inject=["$attrs","customerManager","customerModals","saleManager","vdTracking","vdFeatureManager"];var $o={bindings:{customer:"<",customerBalances:"<?",viewOptions:"<?"},controller:Oo,template:'<div class="wr-customer-badge-content">\n  <react-customer-badge ng-if="$ctrl.viewOptions.canViewDetails"\n    customer="$ctrl.customer"\n    group="$ctrl.customerGroup"\n    interactive="\'action\'"\n    size="\'x-small\'"\n    ng-click="$ctrl.viewCustomer()">\n  </react-customer-badge>\n\n  <react-customer-badge ng-if="!$ctrl.viewOptions.canViewDetails"\n    customer="$ctrl.customer"\n    group="$ctrl.customerGroup"\n    size="\'x-small\'">\n  </react-customer-badge>\n\n  <button ng-if="$ctrl.canRemoveCustomerFromSale()"\n    ng-click="$ctrl.removeCustomerFromSale()"\n    class="vd-btn vd-btn--icon-no wr-customer-badge-remove"\n    type="button">\n    <vd-icon icon="fa-trash"></vd-icon>\n  </button>\n\n  <vd-icon ng-if="!$ctrl.unfulfilledSale() && $ctrl.inProgressSaleHasCustomerPayments()"\n    vd-tooltip-trigger="$ctrl.hasMadePartialCustomerPaymentsTooltip"\n    icon="fa-lock"\n    class="vd-pa4">\n  </vd-icon>\n\n  <vd-icon ng-if="$ctrl.unfulfilledSale()"\n    vd-tooltip-trigger="$ctrl.isUnfulfilledSaleTooltip"\n    icon="fa-lock"\n    class="vd-pa4">\n</vd-icon>\n\n</div>\n\n<wr-customer-balances ng-if="$ctrl.customerBalances"\n  customer="$ctrl.customer"\n  customer-balances="$ctrl.customerBalances"\n  class="wr-customer-badge-balances">\n</wr-customer-balances>\n'};t.module("webregister.components").component("wrCustomerBadge",$o);var Lo=At(({customer:e,group:t,interactive:n,size:s,noDescription:a=!1})=>i.createElement(z,{apiCustomer:e,group:t,size:s,interactive:n,noDescription:a}),["customer","group","interactive","size","noDescription"]);t.module("webregister.components").service("customerSuggestions",No).directive("customerNote",()=>({restrict:"A",require:"ngModel",link(e,t,n,s){function a(){const e=t.html(),n=m(e);s.$setValidity("hasCreditCard",!n),t[0].classList.toggle("vd-input--error",n),n||s.$setViewValue(Z.sanitize(e))}s&&(t[0].classList.add("vd-input","wr-edit-customer-note","wr-customer-note"),t[0].setAttribute("contenteditable","true"),s.$render=function(){t.html(Z.sanitize(s.$viewValue)||""),a()},t.on("input",(function(){e.$applyAsync(a)})))}})).component("reactCustomerBadge",Lo);const Fo='\n  <vd-product-badge product="$vdSuggestion.product"\n    price="$vdSuggestion.price"\n    exact-match="$vdSuggestion.exactMatch"\n    variant-count="$vdSuggestion.variantCount"\n    highlight="$vdQuery"\n    class="vd-suggestion-badge"\n    size="small">\n  </vd-product-badge>\n';class Uo{constructor(e,t,n,a,i,r,o,l,c,d,u,h,m){this.vdToastNotificationService=n,this.priceManager=r,this.productsStore=o,this.productIndexUtil=l,this.userSwitchingService=d,this.productEmbeddedBarcodeService=u,this.retailerSettingsManager=h,this.vdFeatureManager=m,s(this,"_customerCodeSource",void 0),s(this,"_formatter",void 0),s(this,"_globalSource",void 0),s(this,"_productCodeIndex",void 0),s(this,"_source",void 0),s(this,"productErrorTemplate",void 0);const g=["product","variant"],p=a.store("products"),v=new e({types:g,search:({query:e})=>{const t={q:e};return Ke.get("/api/2.0/suggest?type=product&type=variant&page_size=30",{params:t}).then(({data:e})=>e.data||[])}}),y=this.vdFeatureManager.get("product_codes_sell_screen_scanning");this._productCodeIndex=y?p.index("byProductCode"):p.index("bySku"),this.productErrorTemplate="product/product-error.html";const f=new e({types:g,init:()=>i.whenCompleteEntityDataAvailable("products"),search:({query:e})=>this._searchByProductCode({query:e})});this._formatter=new t({type:"product",displayKey:"displayName",template:Fo,enhance:e=>this.enhance(e)});const S=new t({type:"variant",displayKey:"displayName",template:Fo,enhance:e=>this.enhance(e)});this._source=new e({sources:[f,v],formatters:[this._formatter,S],feelingLucky:e=>this._feelingLucky(e)}),this._customerCodeSource=c.getSource({customerCodeOnly:!0});const C=new e({types:this._customerCodeSource.types,search:()=>[],init:()=>this._customerCodeSource.init()}),b=new t({type:"user",displayKey:"displayName"});this._globalSource=new e({sources:[f,v,C],formatters:[this._formatter,S,c.getFormatter(),b],feelingLucky:e=>this._globalFeelingLucky(e)})}getSource(e={}){return e.global?this._globalSource:this._source}getFormatter(){return this._formatter}_searchByProductCode({query:e,barcodeData:t}){return this._productCodeIndex.getAll(e).then(e=>F(e,this.productIndexUtil.isProductActive)).then(e=>p(e,e=>{const n=e.has_variants||e.variant_parent_id?"variant":"product";return{id:e.id,type:n,[n]:e,product:e,exactMatch:!0,barcodeData:t}}))}enhance(e){const t={};return We((n,s)=>{We.all({product:e.product||this.productsStore.get(e.id),price:this.priceManager.getBasePriceForProduct(e.id)}).then(({product:n,price:a})=>{if(!n||n.deleted_at)return s(`Product with id ${e.id} could not be found.`);const i=e.exactMatch||"variant"===e.type,r=i?n.variant_name:n.name;y(t,e,{[e.type]:n,product:n,price:a,displayName:r,exactMatch:i});return Boolean(n.variant_options.length)?this.productsStore.getVariantCount(e.id):0}).then(e=>{t.variantCount=e,n(t)})})}_feelingLucky({query:e,pendingSuggestion:t}){return this._searchByProductCode({query:e}).then(n=>this._handleFeelingLuckySuggestions({query:e,pendingSuggestion:t,suggestions:n}))}_globalFeelingLucky({query:e,pendingSuggestion:t}){const n=this.retailerSettingsManager.getBarcodeOption();if(this.userSwitchingService.isUserSwitchId(e))return this._handleUserSwitchIdQuery({query:e});if(n&&"none"!==n&&this.productEmbeddedBarcodeService.isEmbeddedBarcode(e)){const n=this.productEmbeddedBarcodeService.extractComponents(e),s=parseInt(n[2],10);return e=String(parseInt(n[1],10)),We.all({embeddedProducts:this._searchByProductCode({query:e,barcodeData:s})}).then(({embeddedProducts:n})=>this._handleFeelingLuckySuggestions({query:e,pendingSuggestion:t,suggestions:n,isGlobal:!0}))}return We.all({products:this._searchByProductCode({query:e}),customers:this._customerCodeSource.search({query:e}).then(e=>e.suggestions)}).then(({products:n,customers:s})=>this._handleFeelingLuckySuggestions({query:e,pendingSuggestion:t,suggestions:n.concat(s),isGlobal:!0}))}_handleUserSwitchIdQuery({query:e}){return this.userSwitchingService.fastSwitch({switchId:e}).then(e=>({user:e,displayName:e.username,type:"user"}))}_handleFeelingLuckySuggestions({query:e,pendingSuggestion:t,suggestions:n,isGlobal:s=!1}){let a;return n.length>1?a=`More than 1 result found for "${e}". Try typing that into the search field to see results.`:n.length||(a=`No results found for "${e}". Try searching by product name.`),a?t||(Qe.debug("[ProductSuggestionSource] "+a,n),this.vdToastNotificationService.negative({message:a}),void(s&&"."!==e&&"+"!==e&&He.$emit("search:unknown-product",{query:e,suggestions:n}))):n[0]}}Uo.$inject=["VdSuggestionSource","VdSuggestionFormatter","vdToastNotificationService","Database","syncManager","priceManager","productsStore","productIndexUtil","customerSuggestions","userSwitchingService","productEmbeddedBarcodeService","retailerSettingsManager","vdFeatureManager"];const Bo="wr-number-colour-negative",qo="wr-number-colour-neutral",Vo="wr-number-colour-positive";const Ko=({number:e,polariseNumberFn:t})=>{const n=function(e,t){let n;return n=t?t(e):"string"==typeof e?parseFloat(e):e,isNaN(n)||0===n?qo:n>0?Vo:Bo}(e,t);return i.createElement("span",{className:n},e.toString())},Go=At(Ko,["number","polariseNumberFn"]),jo=At(({inventory:e,hasFeatureInboundIndicator:t})=>i.createElement(i.Fragment,null,t&&e.hasInboundOrders&&i.createElement(le,{buttonClassName:"vd-mr2",productID:e.product_id,outletID:e.outlet_id}),i.createElement(Ko,{number:e.inventory_level,polariseNumberFn:t=>{const n=e.reorder_point;return"number"==typeof n?t>n?1:-1:0}})),["inventory","hasFeatureInboundIndicator"]),Qo=At(({productId:e,outletId:t})=>i.createElement(le,{buttonClassName:"vd-mr2",productID:e,outletID:t}),["productId","outletId"]),Wo=At(({close:e,options:t})=>{const{title:n,parentProduct:s,variantProducts:a,allowVariantParentSelect:r}=t;return i.createElement(ce,{close:e,title:n,parentProduct:s,variantProducts:a,allowParentSelect:r})},["close","options"]);class Ho{constructor(){s(this,"ean13EmbeddedBarcodeMatcher",void 0),this.ean13EmbeddedBarcodeMatcher=/^(?:20|02|2)([0-9]{5})([0-9]{5})[0-9]$/}isEmbeddedBarcode(e){return this.ean13EmbeddedBarcodeMatcher.test(e)&&this._validateChecksum(e)}extractComponents(e){return this.ean13EmbeddedBarcodeMatcher.test(e)?this.ean13EmbeddedBarcodeMatcher.exec(e):e}_validateChecksum(e){const t=e.substring(0,e.length-1),n=parseInt(e.substring(e.length-1),10);let s=0,a=0;return t.split("").forEach((t,n)=>{const a=parseInt(t,10);e.length%2==0&&(n+=1),s+=n%2==0?a:3*a}),s%=10,a=0===s?0:10-s,a===n}}Ho.$inject=[];class Yo{constructor(e){this.Modal=e}openVariantPicker(e){return this.Modal({controller:"variantPickerModalController",controllerAs:"$ctrl",template:'<sr-variant-picker-modal\n  close="$ctrl.internalClose"\n  options="$ctrl.options">\n</sr-variant-picker-modal>\n',title:e.title,parentProduct:e.parentProduct,variantProducts:e.variantProducts,allowVariantParentSelect:e.allowVariantParentSelect}).then(e=>e.closed).then(e=>e?de(e):We.reject()).catch(()=>{})}}Yo.$inject=["Modal"];class zo{constructor(e,t,n,a){this.options=n,this.vdEscapeStack=a,s(this,"close",void 0),s(this,"internalClose",void 0),this.internalClose=t,this.close=()=>this.internalClose(We.reject()),this.vdEscapeStack.register(this.close),e.$on("$destroy",()=>this.vdEscapeStack.deregister(this.close))}}zo.$inject=["$scope","close","options","vdEscapeStack"],t.module("webregister.components").component("wrInventoryLevel",jo).component("srInboundIndicatorWrapper",Qo).component("srVariantPickerModal",Wo).service("productSuggestions",Uo).service("productEmbeddedBarcodeService",Ho).service("variantPickerModalService",Yo).controller("variantPickerModalController",zo);function Jo(e){e.state(qt,{abstract:!0,resolve:{updateRestrictedAccess:["vdRetailer","vdActiveUser","vdTracking","webRegisterStatusManager",function(e,t,n,s){s.restrictedAccess=!0,nt.onStart({},()=>!1),We.all([t.init(),e.init()]).then(()=>{const s=r(r({},Ks()),{},{retailerDomainPrefix:Xe.location.hostname,retailerId:e.get().id,userId:t.getLoggedInUser().id});n.init(s).then(()=>(n.trackUserEvent({eventName:"Restricted State",metadata:{state:et.current.name}}),!1))})}]}}).state(Vt,{views:{"@webregister":{template:'<div class="restricted-access">\n  <div class="restricted-access-content">\n    <vd-header category="subpage" class="vd-mb3" vd-no-widow>\n      You can\u2019t access the Sell screen\n    </vd-header>\n\n    <p class="vd-p" vd-no-widow>\n      The Sell screen is not available as there are no registers created under the outlet that you\u2019ve been assigned to.\n      Please get in touch with your Manager or Admin if you need help.\n    </p>\n  </div>\n</div>\n'}}}).state(Kt,{views:{"@webregister":{template:'<div class="restricted-access">\n  <div class="restricted-access-content">\n    <img ng-src="{{ \'sell/duplicate-window-v1.svg\' | vdImageCdnPath }}"\n         class="vd-mb3 restricted-access-image">\n    <vd-header category="subpage" class="vd-mb3" vd-no-widow>\n      You can only open one Sell tab at a time.\n    </vd-header>\n    <p class="vd-p" vd-no-widow>\n      Having multiple Sell tabs open at the same time can cause errors in sales.\n    </p>\n  </div>\n</div>\n'}}})}Jo.$inject=["$stateProvider"],t.module("webregister.routes").config(Jo);const Xo=At(()=>i.createElement("div",{className:"no-products-modal"},i.createElement(Q,{size:"large",content:i.createElement("div",{className:"vd-g-row"},i.createElement("div",{className:"vd-g-col vd-g-s-4 no-products-modal-sidebar"},i.createElement("img",{src:"https://vendfrontendassets.freetls.fastly.net/images/sell/no-products-v1.png",alt:"No Products"})),i.createElement("div",{className:"vd-g-col vd-g-s-8"},i.createElement("div",{className:"no-products-modal-content vd-flex vd-flex--column vd-flex--justify-between"},i.createElement("div",null,i.createElement("h2",{className:"vd-header vd-header--dialog"},"Oops, you don't have any products."),i.createElement("p",null,"You'll need to add some products to your store before you can make a sale in Vend.")),i.createElement("div",{className:"vd-dialog-actions"},i.createElement("a",{className:"vd-btn vd-btn--do",href:"/products"},"Add Products"))))),dismissible:!1}))),Zo=At(({close:e,options:t})=>i.createElement(ue,{close:e,options:t}),["close","options"]);class el{constructor(e){this.Modal=e}openPromotion(e){return this.Modal({controller:"promotionModalController",controllerAs:"$ctrl",template:'<vb-promotion-modal\n  close="$ctrl.internalClose"\n  options="$ctrl.options">\n</vb-promotion-modal>\n',defaultTab:e.defaultTab,promotion:e.promotion,totalCustomerGroups:e.totalCustomerGroups,lineItemIds:e.lineItemIds,isTaxExclusive:e.isTaxExclusive,currencyDetails:e.currencyDetails}).then(e=>e.closed).catch(()=>{})}}el.$inject=["Modal"];class tl{constructor(e,t,n,a){this.options=n,this.vdEscapeStack=a,s(this,"close",void 0),s(this,"internalClose",void 0),this.internalClose=t,this.close=()=>this.internalClose(We.reject()),this.vdEscapeStack.register(this.close),e.$on("$destroy",()=>this.vdEscapeStack.deregister(this.close))}}tl.$inject=["$scope","close","options","vdEscapeStack"];class nl{constructor(e){this.vdFeatureManager=e,this.vdFeatureManager=e}sales(e){if(this.vdFeatureManager.get("parked_sales_from_read_api")){const t="/api/2.0/sales",n={params:r({desc:1},e)};return Ke.get(t,n).then(Ue)}{const t="/api/2.0/search",n={params:r(r(r({},{order_by:"date",order_direction:"desc"}),e),{},{type:"sales"})};return Ke.get(t,n).then(Ue)}}}nl.$inject=["vdFeatureManager"],t.module("webregister.components").service("searchResource",nl);const sl="always",al="greater_privilege",il={OFFLINE:"OFFLINE",DISCOUNT:"DISCOUNT",PASSWORD:"PASSWORD",USER_SWITCHING:"USER_SWITCHING"},rl={[il.OFFLINE]:'<header class="vd-dialog-header">\n  <vd-header class="pro-switch-user-header" category="dialog">\n    {{ $ctrl.selectUserForDiscount ?\n        "You can\'t apply a discount right now." :\n        "Continue as the same user to keep selling"\n    }}\n  </vd-header>\n</header>\n\n<div class="vd-dialog-content">\n  <p class="vd-p">\n    {{ $ctrl.selectUserForDiscount ?\n        "You don\'t have permission to apply discounts to a sale. To do this you will need to switch to a user who can, but first you need to be connected to the internet." :\n        "You are currently offline and are unable to switch users. To keep making sales while offline, you have to continue as the same user."\n    }}\n  </p>\n</div>\n<div class="vd-dialog-actions">\n  <button class="vd-btn vd-btn--do" ng-click="$ctrl.close()">\n    {{ $ctrl.selectUserForDiscount ? \'Continue without applying discount\' : \'Continue as same user\' }}\n  </button>\n</div>\n\n',[il.DISCOUNT]:'<header class="vd-dialog-header">\n  <vd-header class="pro-switch-user-header" category="dialog">\n    Permission required to apply a discount\n  </vd-header>\n</header>\n\n<div class="vd-text vd-mb5">\n  You don\'t have permission to apply discounts to a sale. Please switch to another user to proceed.\n</div>\n\n<div ng-if="$ctrl.loading" class="vd-align-center">\n  <div class="vd-loader"></div>\n  <div class="vd-mt3">Loading user&hellip;</div>\n</div>\n\n<div ng-if="$ctrl.fetchingRoles" class="wr-user-switching-loader-container">\n  <div class="vd-loader"></div>\n</div>\n\n<div ng-if="!$ctrl.fetchingRoles" class="wr-partial-dialog-content">\n  <form name="$ctrl.searchUsersForm" class="vd-mb3">\n    <label class="vd-field" ng-if="!$ctrl.loading">\n      <div class="vd-label">Search all users</div>\n      <div class="vd-value">\n        <input name="userQuery"\n          class="vd-input"\n          vd-focus\n          ng-model="$ctrl.query"\n          ng-model-options="{ debounce: 200 }"\n          ng-keyup="$ctrl.checkForSwitchId($event)"\n          vd-input-symbol="{ align: \'left\', icon: \'fa fa-search\' }"\n          placeholder="Enter name of user">\n      </div>\n    </label>\n  </form>\n\n  <div ng-if="!$ctrl.loading" class="wr-user-switching-list-container">\n    <div ng-show="!$ctrl.isFastSwitching && $ctrl.query && !$ctrl.filteredUsers.length">\n      No users found matching \u201c{{ $ctrl.query }}\u201d.\n    </div>\n\n    <div class="vd-field" ng-hide="$ctrl.isFastSwitching || ($ctrl.query && !$ctrl.filteredUsers.length)">\n      <div ng-hide="$ctrl.query || filteredUsers.length === 0" class="vd-mb5">\n        <div class="vd-label">Recent users</div>\n        <ul class="wr-user-switching-list vd-g-row">\n          <li ng-repeat="user in filteredUsers = ($ctrl.recentUsers |\n              filter: $ctrl.canBeSwitchedTo |\n              filter: $ctrl.canSetDiscount |\n              limitTo: 4)"\n            class="vd-g-col vd-g-s-12 vd-g-m-6">\n            <vd-user-badge user="user"\n              interactive="selection"\n              current="$first"\n              ng-keyup="$event.keyCode == 13 ? $ctrl.selectUser(user) : null"\n              ng-click="$ctrl.selectUser(user)">\n            </vd-user-badge>\n          </li>\n        </ul>\n      </div>\n\n      <div class="vd-label" ng-hide="$ctrl.query">\n        All users who have permission to apply a discount\n      </div>\n      <div class="vd-label" ng-show="$ctrl.query">\n        {{ $ctrl.filteredUsers.length + \' user\' + ($ctrl.filteredUsers.length > 1 ? \'s\' : \'\') + \' matching \u201c\' + $ctrl.query + \'\u201d\' }}\n      </div>\n      <ul class="wr-user-switching-list pro-available-user-list vd-g-row">\n        <li ng-repeat="user in $ctrl.filteredUsers = ($ctrl.users |\n            filter: $ctrl.canBeSwitchedTo |\n            filter: $ctrl.canSetDiscount |\n            filter: $ctrl.matchesQuery |\n            orderBy: $ctrl.orderUsers)"\n          class="vd-g-col vd-g-s-12 vd-g-m-6">\n          <vd-user-badge user="user"\n            interactive="selection"\n            highlight="$ctrl.query"\n            ng-keyup="$event.keyCode == 13 ? $ctrl.selectUser(user) : null"\n            ng-click="$ctrl.selectUser(user)">\n          </vd-user-badge>\n        </li>\n      </ul>\n    </div>\n  </div>\n</div>\n',[il.PASSWORD]:'<header class="vd-dialog-header">\n  <vd-header class="pro-switch-user-header" category="dialog">\n    Please enter your password\n  </vd-header>\n</header>\n\n<form ng-if="$ctrl.isOnline && $ctrl.selectedUser"\n  id="userSwitchingForm"\n  name="userSwitchingForm"\n  novalidate>\n\n  <div class="vd-dialog-content">\n    <div class="vd-field">\n      <div class="vd-label">\n        {{ $ctrl.selectedUser | vdUserName }}\n      </div>\n      <div class="vd-text--secondary vd-text--sub" ng-if="$ctrl.selectedUser.email">\n        {{ $ctrl.selectedUser.email }}\n      </div>\n    </div>\n    <div class="vd-field">\n      <div class="vd-label">Password</div>\n      <div class="vd-value">\n        <input ng-if="!$ctrl.submitting"\n          class="vd-input"\n          type="password"\n          placeholder="Enter password"\n          ng-model="$ctrl.password"\n          vd-focus="{ isFocusable: true, selectText: true }"\n          required>\n        <input ng-if="$ctrl.submitting"\n          class="vd-input"\n          type="password"\n          ng-model="$ctrl.password"\n          disabled>\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-dialog-actions vd-btn-group">\n    <button type="button"\n      class="vd-btn vd-btn--supplementary"\n      ng-click="$ctrl.backToUserList()"\n      ng-disabled="$ctrl.submitting">\n      Choose another user\n    </button>\n    <button class="vd-btn vd-btn--do"\n      ng-disabled="userSwitchingForm.$invalid || $ctrl.submitting"\n      ng-click="$ctrl.submitUserSwitch()"\n      form="userSwitchingForm">\n      {{ $ctrl.submitting ? \'Switching user&hellip;\' : \'Switch user\' }}\n      <i class="vd-loader vd-loader--small" ng-if="$ctrl.submitting"></i>\n    </button>\n  </div>\n</form>\n',[il.USER_SWITCHING]:'<header class="vd-dialog-header">\n  <vd-header class="pro-switch-user-header" category="dialog">\n    {{ $ctrl.selectUserForNextSale ?\n        "Choose a user to start the next sale" :\n        "Switch to a different user"\n    }}\n  </vd-header>\n</header>\n\n<div ng-if="$ctrl.loading" class="vd-align-center">\n  <div class="vd-loader"></div>\n  <div class="vd-mt3">Loading user&hellip;</div>\n</div>\n\n<form name="$ctrl.searchUsersForm" class="vd-mb3">\n  <label class="vd-field" ng-if="!$ctrl.loading">\n    <div class="vd-label">Search all users</div>\n    <div class="vd-value">\n      <input name="userQuery"\n        class="vd-input"\n        vd-focus\n        ng-model="$ctrl.query"\n        ng-model-options="{ debounce: 200 }"\n        ng-keyup="$ctrl.checkForSwitchId($event)"\n        vd-input-symbol="{ align: \'left\', icon: \'fa fa-search\' }"\n        placeholder="Enter name of user">\n    </div>\n  </label>\n</form>\n\n<div ng-if="!$ctrl.loading" class="wr-user-switching-list-container">\n  <div ng-show="!$ctrl.isFastSwitching && $ctrl.query && !$ctrl.filteredUsers.length">\n    No users found matching \u201c{{ $ctrl.query }}\u201d.\n  </div>\n\n  <div class="vd-field" ng-hide="$ctrl.isFastSwitching || ($ctrl.query && !$ctrl.filteredUsers.length)">\n    <div ng-hide="$ctrl.query" class="vd-mb5">\n      <div class="vd-label">Recent users</div>\n      <ul class="wr-user-switching-list vd-g-row">\n        <li ng-repeat="user in $ctrl.recentUsers |\n            filter: $ctrl.canBeSwitchedTo |\n            limitTo: 4"\n          class="vd-g-col vd-g-s-12 vd-g-m-6">\n          <vd-user-badge user="user"\n            interactive="selection"\n            current="$first"\n            ng-keyup="$event.keyCode == 13 ? $ctrl.selectUser(user) : null"\n            ng-click="$ctrl.selectUser(user)">\n          </vd-user-badge>\n        </li>\n      </ul>\n    </div>\n\n    <div class="vd-label" ng-hide="$ctrl.query">\n      All users in this outlet\n    </div>\n    <div class="vd-label" ng-show="$ctrl.query">\n      {{ $ctrl.filteredUsers.length + \' user\' + ($ctrl.filteredUsers.length > 1 ? \'s\' : \'\') + \' matching \u201c\' + $ctrl.query + \'\u201d\' }}\n    </div>\n    <ul class="wr-user-switching-list pro-available-user-list vd-g-row">\n      <li ng-repeat="user in $ctrl.filteredUsers = ($ctrl.users |\n          filter: $ctrl.canBeSwitchedTo |\n          filter: $ctrl.matchesQuery |\n          orderBy: $ctrl.orderUsers)"\n        class="vd-g-col vd-g-s-12 vd-g-m-6">\n        <vd-user-badge user="user"\n          interactive="selection"\n          highlight="$ctrl.query"\n          ng-keyup="$event.keyCode == 13 ? $ctrl.selectUser(user) : null"\n          ng-click="$ctrl.selectUser(user)">\n        </vd-user-badge>\n      </li>\n    </ul>\n  </div>\n</div>\n\n'};class ol{constructor(e,t,n,a,i,r,o,l,c,d,u,h){this.usersStore=a,this.userManager=i,this.userSwitchingService=r,this.rolesResourceService=o,this.retailerSettingsManager=c,this.posStateManager=d,this.webRegisterStatusManager=u,this.vdUserImagePathFilter=h,s(this,"STATES",void 0),s(this,"_close",void 0),s(this,"_updateRoleDiscountSetting",void 0),s(this,"canBeSwitchedTo",void 0),s(this,"canCashierSetDiscount",void 0),s(this,"canManagerSetDiscount",void 0),s(this,"canSetDiscount",void 0),s(this,"close",void 0),s(this,"dismissible",void 0),s(this,"fetchingRoles",void 0),s(this,"isFastSwitching",void 0),s(this,"isOnline",void 0),s(this,"loading",void 0),s(this,"matchesQuery",void 0),s(this,"orderUsers",void 0),s(this,"password",void 0),s(this,"query",void 0),s(this,"recentUsers",void 0),s(this,"searchUsersForm",void 0),s(this,"selectUserForDiscount",void 0),s(this,"selectUserForNextSale",void 0),s(this,"selectedUser",void 0),s(this,"submitting",void 0),s(this,"users",void 0),this.STATES=il,this._close=t,this.close=()=>t(We.reject()),this.canManagerSetDiscount=!0,this.canCashierSetDiscount=!1,this.fetchingRoles=!0,this._setUsers(),this._updateOnlineStatus(),n&&(this.selectedUser=n.user,this.selectUserForNextSale=n.selectUserForNextSale,this.selectUserForDiscount=n.selectUserForDiscount);for(const s of Object.keys(rl))ze.put(this.getTemplateUrl(s),rl[s]);a.on("sync",this._setUsers,this),u.on(Pn.statusChange,this._updateOnlineStatus,this),e.$on("$destroy",()=>{a.off("sync",this._setUsers),u.off(Pn.statusChange,this._updateOnlineStatus)}),this.canBeSwitchedTo=e=>i.canUserAccessOutlet(e,this.posStateManager.getOutletId()),this.canSetDiscount=e=>{if(!this.selectUserForDiscount)return!0;switch(e.account_type){case"admin":return!0;case"manager":return this.canManagerSetDiscount;case"cashier":return this.canCashierSetDiscount}},this._updateRoleDiscountSetting=()=>{this.fetchingRoles=!0,this.rolesResourceService.getRoles().then(e=>{const t=g(e.data,{name:"Manager"}),n=g(e.data,{name:"Cashier"});this.canManagerSetDiscount=C(t.permissions,e=>e.name===ts.SALE_DISCOUNT),this.canCashierSetDiscount=C(n.permissions,e=>e.name===ts.SALE_DISCOUNT)}).then(()=>{this.fetchingRoles=!1}).catch(()=>{this.fetchingRoles=!1})},this.matchesQuery=e=>{const t=this.query;if(!t)return!0;const n=new RegExp(he(t),"i");return n.test(e.display_name)||n.test(e.username)||n.test(e.email)},this.orderUsers=e=>l(e)}getTemplateUrl(e){return"USER_SWITCHING_"+e}canCloseModal(){const e=Boolean(!this.selectUserForNextSale&&!this.selectedUser&&!this.isFastSwitching);return this.dismissible=e,e}checkForSwitchId(e){const t=this.searchUsersForm.userQuery.$viewValue;!this.isFastSwitching&&this.userSwitchingService.isUserSwitchId(t)&&13===e.which&&this._fastSwitchUser({switchId:t})}getUserImage(){return this.vdUserImagePathFilter(this.selectedUser,"standard")}backToUserList(){this.selectedUser=null,this.query=null}selectUser(e){return this.loading=!0,this._requiresPassword(e)?(this.selectedUser=e,this.loading=!1,We.resolve()):this._switchToUser(e).finally(()=>{this.loading=!1})}submitUserSwitch(){return this._switchToUser(this.selectedUser,this.password)}_setUsers(){const e=this.posStateManager.getRecentLoggedUserIds();this.recentUsers=[],this.usersStore.all().then(t=>{t=me(t,"deleted_at"),ge(e,e=>{const n=g(t,{id:e});n&&this.recentUsers.push(n)}),this.users=t,this.selectUserForDiscount&&this.isOnline&&this._updateRoleDiscountSetting()})}_updateOnlineStatus(){this.isOnline=this.webRegisterStatusManager.isOnline()}_switchToUser(e,t){const{username:n}=e;return this.submitting=!0,this.userSwitchingService.switchUser({username:n,password:t,switch_id:t}).then(e=>this._close(e)).catch(()=>{this.password="",t||(this.selectedUser=e)}).finally(()=>{this.submitting=!1})}_requiresPassword(e){const t=this.retailerSettingsManager.get().require_password_on_user_switch;return t===sl||!(t!==al||!this.userManager.hasGreaterPrivilege(e,this.userManager.getLoggedInUser()))}_fastSwitchUser({switchId:e}){return this.isFastSwitching=!0,this.userSwitchingService.switchUser({switchId:e}).then(e=>this._close(e)).catch((e={})=>{const{user:t}=e;t&&(this.selectedUser=t),this.query=null,this.isFastSwitching=!1})}}ol.$inject=["$scope","close","options","usersStore","userManager","userSwitchingService","rolesResourceService","vdUserNameFilter","retailerSettingsManager","posStateManager","webRegisterStatusManager","vdUserImagePathFilter"];const ll="Sorry, we were unable to switch users. Please try again.";class cl{constructor(e,t,n,a,i,r,o,l){this.registerManager=e,this.userManager=t,this.vdActiveUser=n,this.webRegisterStatusManager=a,this.vdToastNotificationService=i,this.Modal=r,this.vdTracking=o,this.syncManager=l,s(this,"usiMatcher",new RegExp("^usi:([0-9A-Za-z]){12}$"))}selectUser(e={}){const{user:t,selectUserForNextSale:n,selectUserForDiscount:s}=e;return this.Modal({template:'<vd-dialog dismissible="$ctrl.canCloseModal()"\n  close="$ctrl.close"\n  ng-class="{\'wr-user-switching-password-dialog\': $ctrl.selectedUser}"\n  class="pro-switch-user"\n  size="$ctrl.selectedUser ? \'large\' : \'medium\'">\n\n  <div ng-if="$ctrl.selectedUser" class="wr-user-switching-password-dialog-image-container">\n    <div class="wr-user-switching-user-image" vd-bg-image="{ image: $ctrl.getUserImage() }"></div>\n  </div>\n\n  <div ng-include="$ctrl.getTemplateUrl($ctrl.STATES.OFFLINE)" ng-if="!$ctrl.isOnline"></div>\n  <div ng-include="$ctrl.getTemplateUrl($ctrl.STATES.PASSWORD)" ng-if="$ctrl.isOnline && $ctrl.selectedUser"></div>\n  <div ng-include="$ctrl.getTemplateUrl($ctrl.STATES.DISCOUNT)"\n    ng-if="$ctrl.isOnline && !$ctrl.selectedUser && $ctrl.selectUserForDiscount"\n    class="wr-partial-dialog-content">\n  </div>\n  <div ng-include="$ctrl.getTemplateUrl($ctrl.STATES.USER_SWITCHING)" class="wr-partial-dialog-content"\n    ng-if="$ctrl.isOnline && !$ctrl.selectedUser && !$ctrl.selectUserForDiscount">\n  </div>\n</vd-dialog>\n',controller:ol,controllerAs:"$ctrl",user:t,selectUserForNextSale:n,selectUserForDiscount:s}).then(e=>e.closed)}switchUserIfNeeded(){const e=this.registerManager.getActiveRegister();return e&&e.ask_for_user_on_sale?this.selectUser({selectUserForNextSale:!0}):We.resolve()}isUserSwitchId(e){return this.usiMatcher.test(e)}fastSwitch({switchId:e}){return We((t,n)=>{if(!this.webRegisterStatusManager.isOnline())return this.vdToastNotificationService.negative({message:"You\u2019re currently offline and are unable to switch users."}),n();this.switchUser({switchId:e}).then(e=>t(e)).catch((e={})=>{const{user:s}=e;s?this.selectUser({user:s}).then(e=>t(e)).catch(()=>n()):n()})})}switchUser({username:e,password:n,switchId:s}){return this.syncManager.whenCurrentSyncCompletes().then(()=>this.vdActiveUser.switch({username:e,password:n,switchId:s}).then(t=>(this.userManager.setLoggedInUser(t),this.vdToastNotificationService.success({message:`Switched to user "${t.username}"`}),this.vdTracking.trackUserEvent({eventName:"Switch User",metadata:{"Switch Method":e?"username":"switchId"}}),t)).catch((e={})=>this._handleSwitchUserError({passwordSupplied:t.isDefined(n),switchIdSupplied:t.isDefined(s),response:e})))}_handleSwitchUserError({passwordSupplied:e,switchIdSupplied:t,response:n}){return We((s,a)=>{const{data:i,status:r}=n;if(!i)return this.vdToastNotificationService.negative({message:ll}),a();const o=i.data;switch(r){case 400:t?e?this.vdToastNotificationService.negative({message:"The password you entered is incorrect."}):o||this.vdToastNotificationService.negative({message:"We couldn\u2019t switch users because your Quick Switch ID is invalid.\n                      Please try again, or check your Quick Switch ID is up-to-date.",removeDelay:7e3,respectLineBreaks:!0}):i.error&&"The username and/or password is invalid."===i.error?e&&this.vdToastNotificationService.negative({message:"The password you entered is incorrect."}):this.vdToastNotificationService.negative({message:ll}),a({user:o});break;default:this.vdToastNotificationService.negative({message:ll}),a()}})}}cl.$inject=["registerManager","userManager","vdActiveUser","webRegisterStatusManager","vdToastNotificationService","Modal","vdTracking","syncManager"],t.module("webregister.services").service("userSwitchingService",cl).service("rolesResourceService",class{getRoles(){return Ke.get("/api/1.0/roles").then(({data:e})=>e)}});const dl="vend-service-worker.js",ul="SERVICE_WORKER_UPDATED",hl="SERVICE_WORKER_INSTALLED",ml="UPDATE_CACHES",gl="UPDATE_ALL",pl="[SERVICE-WORKER-MANAGER]";class vl extends Et{constructor(e,t,n){super(),this._vdFeatureManager=e,this._vdTracking=t,n.register("serviceWorkerManager"),this.serviceWorkerRegistration=null,this.activeServiceWorker=null}get serviceWorker(){return Xe.navigator.serviceWorker}get isServiceWorkerSupported(){return Xe.navigator&&"serviceWorker"in Xe.navigator}registerServiceWorker(){return this.isServiceWorkerSupported?this._vdFeatureManager.init().then(()=>{this.serviceWorker.register("/"+dl).then(e=>{e.active&&e.active.postMessage({action:ml}),this.serviceWorkerRegistration=e,this._monitorServiceWorker(),Qe.debug(pl+" Registered",e)}).catch(e=>{this._vdTracking.trackError(pl+" Failed to Register",{data:{error:e&&e.message||"Unknown error"}})})}):We.resolve()}refreshServiceWorkerCache(){if(!this.isServiceWorkerSupported)return;this._refreshTriggered=!0;(this.serviceWorkerRegistration.waiting||this.activeServiceWorker).postMessage({action:gl})}_monitorServiceWorker(){if(this._listenForServiceWorkerEvents(),this.serviceWorkerRegistration&&this.serviceWorkerRegistration.active)return Qe.debug(pl+" Service Worker active"),this.activeServiceWorker=this.serviceWorkerRegistration.active,this.serviceWorkerRegistration.waiting?(Qe.debug(pl+" New Service Worker waiting"),void this.emit(hl)):this.serviceWorkerRegistration.installing?(Qe.debug(pl+" New Service Worker installing"),void this._trackServiceWorkerInstalling(this.serviceWorkerRegistration.installing)):void this.serviceWorkerRegistration.addEventListener("updatefound",e=>{Qe.debug(pl+" Service Worker update found",e),this._trackServiceWorkerInstalling(this.serviceWorkerRegistration.installing)})}_listenForServiceWorkerEvents(){this.serviceWorker.addEventListener("message",e=>{Qe.debug(pl+" Message received from Service Worker",e),this._serviceWorkerMessageReceived(e)}),this.serviceWorker.addEventListener("controllerchange",e=>{Qe.debug(pl+" Service Worker controller changed",e),this.emit(ul)})}_serviceWorkerMessageReceived(e){e&&e.data&&e.data.action===ul&&this._refreshTriggered&&this.emit(ul)}_trackServiceWorkerInstalling(e){e.addEventListener("statechange",()=>{"installed"===e.state&&this.emit(hl)})}}vl.$inject=["vdFeatureManager","vdTracking","wrDebugTools"],t.module("webregister.components").service("serviceWorkerManager",vl);t.module("webregister.services").service("barcodeService",class{generateBarcodeImage({value:e,options:t}){const n=document.createElement("img");return""!==e&&pe(n,e,t),n.src.toString()}});const yl="[SaleVersioningManager]";let fl,Sl;t.module("webregister.components").service("saleVersioningManager",class{convertToLatestModelVersion(e){if(!e||!this._saleModelRequiresMigration(e))return e;if(e.version<11&&!e.saleItems)return void Qe.debug(yl+" Sale is missing sale items");if(!e.lineItems)return void Qe.debug(yl+" Sale is missing line items");let t=e.version||0,n=ve(e);return 0===t&&(this._migrateInventoryItemData(n),t=1),1===t&&(this._migrateAdjustedProp(n),t=2),2===t&&(this._migrateIsReturnProp(n),t=3),3===t&&(this._migrateProductId(n),t=4),4===t&&(this._migrateGiftCardProps(n),t=5),5===t&&(this._migratePriceProps(n),t=6),6===t&&(this._migrateTaxProps(n),t=7),7===t&&(this._migratePromotion(n),t=8),8===t&&(this._deleteConfirmedAndQuantity(n),t=9),9===t&&(this._migrateLoyaltyProps(n),t=10),10===t&&(n=this._removeSaleItemModel(n),t=11),11===t&&(n=this._fixBigDecimalInGiftCardPayments(n),t=12),n}_saleModelRequiresMigration(e){return!e.version||e.version<12}_migrateInventoryItemData(e){const t=e.saleItems.map(e=>(e.inventoryItem&&(e.product_id=e.inventoryItem.product_id,e=ye(e,"inventoryItem")),e));e.saleItems=t}_migrateAdjustedProp(e){const{saleItems:t,lineItems:n}=e;n.forEach(e=>{const n=f(t,{localId:e.saleItem.localId});n>=0&&(e.adjusted=t[n].adjusted,t[n]=ye(t[n],"adjusted"))})}_migrateIsReturnProp(e){const{saleItems:t,lineItems:n}=e;n.forEach(e=>{const n=f(t,{localId:e.saleItem.localId});n>=0&&(e.isReturn=t[n].isReturn,t[n]=ye(t[n],"isReturn"))})}_migrateProductId(e){const{saleItems:t,lineItems:n}=e;n.forEach(e=>{const n=f(t,{localId:e.saleItem.localId});n>=0&&(e.product_id=t[n].product_id,t[n]=ye(t[n],"product_id"))})}_migrateGiftCardProps(e){const{saleItems:t,lineItems:n}=e;n.forEach(e=>{const n=f(t,{localId:e.saleItem.localId});n>=0&&(e.giftCardNumber=t[n].giftCardNumber,e.giftCardReload=t[n].giftCardReload,e.giftCardClientId=t[n].giftCardClientId,e.giftCardExpiresAt=t[n].giftCardExpiresAt,t[n]=ye(t[n],"giftCardNumber"),t[n]=ye(t[n],"giftCardReload"),t[n]=ye(t[n],"giftCardClientId"),t[n]=ye(t[n],"giftCardExpiresAt"))})}_migratePriceProps(e){const{saleItems:t,lineItems:n}=e;n.forEach(e=>{const n=f(t,{localId:e.saleItem.localId});n>=0&&(e.price=t[n].price,e.basePrice=t[n].basePrice,t[n]=ye(t[n],"price"),t[n]=ye(t[n],"basePrice"))})}_migrateTaxProps(e){const{saleItems:t,lineItems:n}=e;n.forEach(e=>{const n=f(t,{localId:e.saleItem.localId});n>=0&&(e.tax=t[n].tax,e.baseTax=t[n].baseTax,e.tax_id=t[n].tax_id,t[n]=ye(t[n],"tax"),t[n]=ye(t[n],"baseTax"),t[n]=ye(t[n],"tax_id"))})}_migratePromotion(e){const{saleItems:t,lineItems:n}=e;n.forEach(e=>{const n=f(t,{localId:e.saleItem.localId});n>=0&&(e.promotion=t[n].promotion,t[n]=ye(t[n],"promotion"))})}_deleteConfirmedAndQuantity(e){const{saleItems:t,lineItems:n}=e;n.forEach(e=>{const n=f(t,{localId:e.saleItem.localId});n>=0&&(t[n]=ye(t[n],"confirmed"),t[n]=ye(t[n],"quantity"))})}_migrateLoyaltyProps(e){const{saleItems:t,lineItems:n}=e;n.forEach(e=>{const n=f(t,{localId:e.saleItem.localId});n>=0&&(e.loyaltyValue=t[n].loyaltyValue,e.explicitLoyaltyValue=t[n].explicitLoyaltyValue,e.bestPriceBookInfo=t[n].bestPriceBookInfo,t[n]=ye(t[n],["loyaltyValue","explicitLoyaltyValue","bestPriceBookInfo"]))})}_removeSaleItemModel(e){return e.lineItems=e.lineItems.map(e=>ye(e,"saleItem")),ye(e,"saleItems")}_fixBigDecimalInGiftCardPayments(e){return e.payments?(e.payments=e.payments.map(e=>{if("object"!=typeof e.amount)return e;const t=c.vn(0);return t.s=e.amount.s,t.e=e.amount.e,t.c=e.amount.c,r(r({},e),{},{amount:t.toNumber()})}),e):e}}),function(e){e.ALT="Alt",e.OPTION="Option"}(fl||(fl={})),function(e){e.BASIC="Basic",e.PAYMENTS="Payments",e.SELLING="Sell Screen"}(Sl||(Sl={}));const Cl=[{combo:[fl.ALT,"/"],summary:"View this modal"},{combo:["Esc"],summary:"Back / Exit / Complete Sale"},{combo:["Tab"],summary:"Focus on next item"}],bl=[{combo:[fl.ALT,"S"],summary:"Focus on product search"},{combo:[fl.ALT,"C"],summary:"Focus on customer search"},{combo:[fl.ALT,"L"],summary:"Edit last added item"},{combo:[fl.ALT,"P"],summary:"Pay for sale"},{combo:["F5"],summary:"Park Sale"},{combo:["F6"],summary:"Go to Sales History"},{combo:["F7"],summary:"Open / Close Register"}],_l=[{combo:[fl.ALT,"1-9"],summary:"Use specific Payment type (1-9)"}],wl={[Sl.BASIC]:Cl,[Sl.SELLING]:bl,[Sl.PAYMENTS]:_l};class Ml{constructor(e,t,n){this.close=e,this.options=t,this.vdTracking=n,s(this,"allHotkeys",wl),s(this,"suggestedHotkey",""),s(this,"errorSendingSuggestion",!1),s(this,"isSendingSuggestion",!1),s(this,"isSuggestionSent",!1),s(this,"suggestionForm",void 0),this.close=e,this.options=t}getEnvSpecificModifier(e){return e===fl.ALT&&k.Mac?fl.OPTION:e}sendShortcutSuggestion(){this.errorSendingSuggestion=!1,this.isSendingSuggestion=!0,this.isSuggestionSent=!1,this.vdTracking.trackUserEvent({eventName:"Suggested Shortcut",metadata:{shortcut:this.suggestedHotkey.replace(/\s+/g," ").trim()},useBatching:!1}).then(()=>{this.isSuggestionSent=!0,this.suggestedHotkey="",this.suggestionForm.$setPristine()}).catch(()=>{this.errorSendingSuggestion=!0}).finally(()=>{this.isSendingSuggestion=!1})}}Ml.$inject=["close","options","vdTracking"];class Tl{constructor(e,t,n,a,i,r){this.Modal=e,this.trainingModeManager=t,this.vdOverlayService=n,this.vdToastNotificationService=a,this.vdTracking=i,this.webRegisterStatusManager=r,s(this,"countHotkeysUsed",!1),s(this,"hotkeys",[]),s(this,"hotkeysCount",0),s(this,"mousetrap",void 0),s(this,"globalHotkeys",[]),this.mousetrap=new fe,this.mousetrap.stopCallback=function(){return!1},this.globalHotkeys=[{action:()=>this.showHotkeyTips(),combo:"alt",event:"keydown"},{action:()=>this.hideHotkeyTips(),combo:["alt+ctrl","alt+mod","alt+shift"],event:"keydown"},{action:()=>this.hideHotkeyTips(),combo:"alt",event:"keyup"},{action:()=>this.navigateToSalesHistory(),combo:"f6",summary:"Navigate to Sales History"},{action:()=>this.navigateToOpenCloseRegister(),combo:"f7",summary:"Navigate to Open / Close Register"},{action:()=>this.openCashDrawer(),combo:["ctrl+e","command+e"],summary:"Open the Cash Drawer"},{action:()=>this.showHotKeysModal(),combo:"alt+/",summary:"Show shortcut modal"}]}init(){this.globalHotkeys.forEach(e=>this.add(e)),this.bindEvents()}add(e){const{combo:t,event:n,summary:s}=e,a=this.hotkeys.find(e=>Boolean(e.combo===t&&e.event===n));a&&(Qe.warn(`[HotkeysService] Hotkey already in use "${a.combo}; replacing it."`),this.remove(a.combo)),this.hotkeys.push({combo:t,event:n,summary:s}),this.mousetrap.bind(t,M(()=>this.triggerHotkey(e),300,{leading:!0}),e.event)}remove(e){this.hotkeys=this.hotkeys.filter(t=>t.combo!==e),this.mousetrap.unbind(e)}triggerHotkey(e){const t=Boolean("alt"===e.combo&&"keyup"===e.event);return this.isModalOpen()&&!t||(this.trackHotKeys(e),e.action()),this.countHotkeysUsed&&e.count&&this.hotkeysCount++,!1}isModalOpen(){return this.vdOverlayService.isVisible()}trackHotKeys({combo:e,summary:t}){t&&this.vdTracking.trackUserEvent({eventName:"HotKey Triggered",metadata:{combo:e,description:t},sendSynchronously:!0,useSendBeacon:!0})}startCountingHotkeys(){this.countHotkeysUsed=!0,this.hotkeysCount=0}stopCountingHotkeys(){return this.countHotkeysUsed=!1,this.hotkeysCount}bindEvents(){qe[0].addEventListener("contextmenu",()=>{this.hideHotkeyTips()}),window.matchMedia("print").addListener(e=>{e.matches&&this.hideHotkeyTips()})}exitTrainingModeIfEnabled(){return this.trainingModeManager.trainingModeEnabled?this.trainingModeManager.exitTrainingMode():We.resolve()}navigateToSalesHistory(){this.isModalOpen()||(this.webRegisterStatusManager.isOnline()?this.exitTrainingModeIfEnabled().then(()=>{window.location.href=gn}):this.vdToastNotificationService.negative({message:"Sales History can only be accessed when you are online."}))}navigateToOpenCloseRegister(){this.isModalOpen()||(this.webRegisterStatusManager.isOnline()?this.exitTrainingModeIfEnabled().then(()=>et.go(zt)):this.vdToastNotificationService.negative({message:"You can only open or close registers when you are online."}))}openCashDrawer(){He.$emit(Ns.PRINT,{type:"open-drawer"})}showHotkeyTips(){qe[0].body.classList.add("show-hotkey-tips")}hideHotkeyTips(){qe[0].body.classList.remove("show-hotkey-tips")}showHotKeysModal(){this.Modal({controller:Ml,controllerAs:"$ctrl",template:'<vd-dialog close="$ctrl.close">\n  <vd-banner type="success" ng-if="$ctrl.isSuggestionSent" class="vd-dialog-banner">\n    Success! Your shortcut suggestion has been sent!\n  </vd-banner>\n  <vd-banner type="negative" ng-if="$ctrl.isErrorSendingSuggestion" class="vd-dialog-banner">\n    This was a problem sending your suggestion, please try again.\n  </vd-banner>\n  <div class="vd-dialog-header">\n    <h2 class="vd-header vd-header--dialog">\n      Keyboard Shortcuts\n    </h2>\n  </div>\n\n  <div class="vd-dialog-content">\n    <p class="vd-p">\n      Speed up your sales process or more quickly navigate to the Sales History and Open/Close Register screens.\n    </p>\n\n    <div ng-repeat="(hotkeyGroup, groupHotkeys) in ::$ctrl.allHotkeys" class="vd-mb10">\n      <h2 class="vd-text-sub-heading vd-mb3">{{::hotkeyGroup}}</h2>\n      <ul>\n        <li class="vd-mb3 vd-flex vd-flex--justify-between" ng-repeat="hotkey in groupHotkeys">\n          <span>\n            {{::hotkey.summary}}\n          </span>\n          <kbd class="vd-text-body hotkey-combo">\n            <span ng-repeat="key in hotkey.combo" class="hotkey-combo-key">\n              {{::$ctrl.getEnvSpecificModifier(key)}}\n            </span>\n          </kbd>\n        </li>\n      </ul>\n    </div>\n\n    <h2 class="vd-text-sub-heading vd-mb3">\n      Do you have a suggestion for a keyboard shortcut?\n    </h2>\n    <div class="vd-field" ng-form name="$ctrl.suggestionForm">\n      <div class="vd-label">Suggestion</div>\n      <div class="vd-value">\n        <textarea vd-textarea="{ max: 5 }"\n          vd-input-char-limit\n          name="hotkey"\n          ng-model="$ctrl.suggestedHotkey"\n          ng-required="true"\n          ng-maxlength="200">\n        </textarea>\n      </div>\n      <div class="vd-align-right">\n        <button class="vd-btn vd-btn--supplementary"\n          ng-disabled="$ctrl.suggestionForm.hotkey.$invalid || $ctrl.suggestedHotkey.trim().length < 5 || $ctrl.isSendingSuggestion"\n          ng-click="$ctrl.sendShortcutSuggestion()">\n          {{ $ctrl.isSendingSuggestion ? \'Sending\u2026\' : \'Send\' }}\n          <span class="vd-loader vd-loader--small vd-ml1" ng-if="$ctrl.isSendingSuggestion"></span>\n        </button>\n      </div>\n    </div>\n  </div>\n</vd-dialog>\n'})}}Tl.$inject=["Modal","trainingModeManager","vdOverlayService","vdToastNotificationService","vdTracking","webRegisterStatusManager"];const El=e=>({restrict:"A",link(t,n,s){const a=t.$eval(s.hotkey);if(!a)return;const i=a.action?a.action:function(){n[0].click()};a.tip&&n[0].setAttribute("data-hotkey-tip",a.tip.toString().toUpperCase());const{combo:r,summary:o,count:l}=a;e.add({action:i,combo:r,summary:o,count:l}),t.$on("$destroy",(function(){e.remove(a.combo)}))}});let kl,Il;El.$inject=["hotkeysService"],t.module("webregister.components").service("hotkeysService",Tl).directive("hotkey",El),function(e){e.SALE="sale",e.LINE_ITEM="line_item"}(kl||(kl={})),function(e){e.STRING="string",e.INTEGER="integer",e.BOOLEAN="boolean",e.DATE="date",e.PRODUCT_ID="product_id"}(Il||(Il={}));class Pl{constructor(e){s(this,"customFields",void 0),e=e||{},this.customFields=e.customFields||[]}setCustomField(e){const t=this.getCustomField(e.name);return t?t.value!==e.value&&(t.definitionId=e.definitionId,t.type=e.type,t.value=e.value,!0):(this.customFields.push(e),!0)}getCustomField(e){return this.customFields.find(t=>t.name===e)||null}}class Rl{constructor(e){this.options=e,s(this,"header",""),s(this,"message",""),s(this,"applicationName",void 0),s(this,"appTooltip",void 0),this.header=e.header,this.message=Ye.trustAsHtml(e.message),this.applicationName=e.applicationName,this.appTooltip={template:`\n        <vd-tooltip class="wr-tooltip">\n        <div class="vd-text-label vd-pb1">\n            <vd-icon icon="fa-bolt" class="vd-mr2"></vd-icon>This message was sent by ${this.applicationName}.\n        </div>\n        <p vd-no-widow>If you need help, please contact the administrator of your Vend account, or reach out to ${this.applicationName}\u2019s Help team.</p>\n        </vd-tooltip>\n      `,attachment:"top center",targetAttachment:"bottom left"}}}Rl.$inject=["options"];class Al extends Rl{constructor(e,t){super(t),this.close=e,this.options=t,s(this,"dismissText",void 0),s(this,"confirmText",void 0),this.close=e,this.confirmText=t.confirmText,this.dismissText=t.dismissText}cancel(){this.close(!1)}continue(){this.close(!0)}}Al.$inject=["close","options"];class Dl extends Rl{constructor(e,t){super(t),this.close=e,this.options=t,s(this,"customField",void 0),s(this,"entity",void 0),s(this,"value",void 0),s(this,"possibleValues",void 0),s(this,"errorMessage",void 0),this.close=e,this.customField=t.customField,this.entity=t.entity,this.possibleValues=t.possibleValues;const n=this.entity.getCustomField(this.customField.name);this.value=n?n.value:""}cancel(){this.close({proceed:!1,modified:!1})}continue(){if(null!==this.value){switch(this.customField.type){case Il.STRING:if(!this.value||""===this.value.trim())return this.possibleValues?this.errorMessage="Please choose one of these options.":this.errorMessage="A value is required.",void He.$emit("focusInput");this.entity.setCustomField({definitionId:this.customField.id,name:this.customField.name,type:this.customField.type,value:this.value});break;case Il.BOOLEAN:this.entity.setCustomField({definitionId:this.customField.id,name:this.customField.name,type:this.customField.type,value:Boolean(this.value)});break;case Il.INTEGER:if(!this.value||""===this.value||isNaN(this.value))return this.possibleValues?this.errorMessage="Please choose one of these options.":this.errorMessage="A number is required.",void He.$emit("focusInput");this.entity.setCustomField({definitionId:this.customField.id,name:this.customField.name,type:this.customField.type,value:Number(this.value)})}this.close({proceed:!0,modified:!0})}}}Dl.$inject=["close","options"];class Nl extends Rl{constructor(e,t,n,a){super(t),this.close=e,this.options=t,this.productsStore=n,this.productSuggestions=a,s(this,"entity",void 0),s(this,"entityType",void 0),s(this,"requiredCustomFields",void 0),this.close=e,this.entity=t.entity,this.requiredCustomFields=t.requiredCustomFields,this.entityType=this.requiredCustomFields[0].field.entity,this.requiredCustomFields.forEach(e=>{const t=this.entity.getCustomField(e.field.name);e.value=t?t.value:"",e.field.type===Il.PRODUCT_ID&&(e.value&&"string"==typeof e.value&&this.productsStore.get(e.value).then(t=>{e.entity=t}),e.values&&e.values.forEach(e=>{this.productsStore.get(e.value).then(t=>{e.entity=t})}))})}productSuggestionsSource(){return this.productSuggestions.getSource()}cancel(){this.close({proceed:!1,modified:!1})}selectEntity(e,t){e.entity=t,e.value=t.id}clearValue(e){e.value=null,e.entity=void 0,He.$emit("focusInput")}continue(){this.requiredCustomFields.forEach(e=>{switch(e.field.type){case Il.STRING:if(!e.value||""===e.value.trim())return void(e.values?e.errorMessage="Please choose one of these options.":e.errorMessage="A value is required.");e.errorMessage=null,this.entity.setCustomField({definitionId:e.field.id,name:e.field.name,type:e.field.type,value:e.value});break;case Il.BOOLEAN:this.entity.setCustomField({definitionId:e.field.id,name:e.field.name,type:e.field.type,value:Boolean(e.value)});break;case Il.INTEGER:if(!e.value||""===e.value||isNaN(e.value))return void(e.values?e.errorMessage="Please choose one of these options.":e.errorMessage="A number is required.");e.errorMessage=null,this.entity.setCustomField({definitionId:e.field.id,name:e.field.name,type:e.field.type,value:Number(e.value)});break;case Il.DATE:if(!e.value)return void(e.errorMessage="A date is required.");if(!ee(e.value,"YYYY-MM-DD").isValid())return void(e.errorMessage="Not a valid date.");e.errorMessage=null,this.entity.setCustomField({definitionId:e.field.id,name:e.field.name,type:e.field.type,value:e.value});break;case Il.PRODUCT_ID:if(!e.value)return void(e.errorMessage="A product is required.");e.errorMessage=null,this.entity.setCustomField({definitionId:e.field.id,name:e.field.name,type:e.field.type,value:e.value})}}),this.requiredCustomFields.some(e=>e.errorMessage)?He.$emit("focusInput"):this.close({proceed:!0,modified:!0})}}Nl.$inject=["close","options","productsStore","productSuggestions"];class xl extends Rl{constructor(e,t){super(t),this.close=e,this.options=t,s(this,"suggestedProducts",void 0),s(this,"hasSelectedProducts",void 0),s(this,"errorMessage",void 0),s(this,"addProduct",void 0),this.close=e,this.suggestedProducts=t.products.map(e=>({product:e,selected:!1})),this.hasSelectedProducts=!1,this.addProduct=t.addProduct}selectProduct(e){let t=this.suggestedProducts[e];t&&(t={product:t.product,selected:!t.selected},this.suggestedProducts[e]=t,this.hasSelectedProducts=this.suggestedProducts.some(e=>e.selected))}addSelectedProducts(){const e=this.suggestedProducts.filter(e=>e.selected).map(e=>this.addProduct(e.product));Promise.all(e).finally(()=>{this.close({proceed:!0,modified:!0})})}continue(){this.close({proceed:!0,modified:!1})}}xl.$inject=["close","options"];let Ol,$l,Ll;!function(e){e.STOP="stop",e.CONFIRM="confirm",e.SET_CUSTOM_FIELD="set_custom_field",e.REQUIRE_CUSTOM_FIELD="require_custom_field",e.REQUIRE_CUSTOM_FIELDS="require_custom_fields",e.ADD_LINE_ITEM="add_line_item",e.REMOVE_LINE_ITEM="remove_line_item",e.SUGGEST_PRODUCTS="suggest_products",e.SET_CUSTOMER="set_customer"}(Ol||(Ol={})),function(e){e.UNKNOWN="unknown",e.REMOTE_RULE_TIMEOUT="remote_rule_timeout",e.REMOTE_RULE_BAD_RESPONSE="remote_rule_bad_response",e.REMOTE_RULE_FAILED="remote_rule_failed"}($l||($l={})),function(e){e.READY_FOR_PAYMENT="sale.ready_for_payment",e.LINE_ITEMS_ADDED="sale.line_items.added",e.SALE_CUSTOMER_CHANGED="sale.customer.changed"}(Ll||(Ll={}));class Fl{constructor(e){s(this,"iteration",0),s(this,"lineItemIdsAdded",[]),s(this,"id",void 0),this.id=se(),e&&e.parentContext&&(this.iteration=e.parentContext.iteration),e&&e.lineItemIdsAdded&&e.lineItemIdsAdded.forEach(e=>this.lineItemAdded(e))}nextIteration(){this.iteration++}lineItemAdded(e){-1===this.lineItemIdsAdded.indexOf(e)&&this.lineItemIdsAdded.push(e)}lineItemRemoved(e){const t=this.lineItemIdsAdded.indexOf(e);-1!==t&&this.lineItemIdsAdded.splice(t,1)}}class Ul{constructor(e,t,n,a,i,r,o,l){this.userManager=e,this.registerManager=t,this.saleManager=n,this.productsStore=a,this.productSkuIndex=i,this.Modal=r,this.vdTracking=o,this.vdFeatureManager=l,s(this,"whenInitialised",void 0),s(this,"configuredEvents",[]),s(this,"lineItemIdsAddedQueue",[]),this.triggerLineItemsAdded=M(this.triggerLineItemsAdded,100)}init(){return this.vdFeatureManager.init().then(()=>(this.vdFeatureManager.get("custom_business_rules")||(this.whenInitialised=Promise.resolve()),this.whenInitialised||(He.$on("sale:add-line-item",this.lineItemAddedListener.bind(this)),He.$on("sale:remove-line-item",this.lineItemRemovedListener.bind(this)),He.$on(Ns.SALE_CUSTOMER_UPDATED,this.saleCustomerUpdatedListener.bind(this)),this.whenInitialised=this.getConfiguredEvents()),this.whenInitialised))}enqueueActions(e,t){return e.reduce((e,n)=>e.then(e=>{let s=Promise.resolve({proceed:!0,modified:!1});switch(n.type){case Ol.CONFIRM:case Ol.STOP:s=this.showStopOrConfirmModal(n);break;case Ol.SET_CUSTOM_FIELD:s=this.setCustomField(n);break;case Ol.REQUIRE_CUSTOM_FIELD:s=this.requireCustomField(n);break;case Ol.REQUIRE_CUSTOM_FIELDS:s=this.requireCustomFields(n);break;case Ol.ADD_LINE_ITEM:s=this.addLineItem(n,t);break;case Ol.REMOVE_LINE_ITEM:s=this.removeLineItem(n,t);break;case Ol.SUGGEST_PRODUCTS:s=this.suggestProducts(n,t);break;case Ol.SET_CUSTOMER:s=this.setCustomer(n);break;default:Qe.warn("[Workflows] Unsupported action",n)}return s.then(t=>({proceed:e.proceed&&t.proceed,modified:e.modified||t.modified}))}),Promise.resolve({proceed:!0,modified:!1}))}setCustomField(e){const{custom_field:t}=e;if(!t||!e.custom_field_value)return Promise.resolve({proceed:!0,modified:!1});const n=this.getCustomFieldEntity(t.entity,e.entity_id);if(!n)return Promise.resolve({proceed:!0,modified:!1});const s=n.setCustomField({definitionId:t.id,name:t.name,type:t.type,value:e.custom_field_value});return Promise.resolve({proceed:!0,modified:s})}requireCustomField(e){const{custom_field:t,custom_field_values:n}=e;if(!t)return Promise.resolve({proceed:!0,modified:!1});const s=this.getCustomFieldEntity(t.entity,e.entity_id);return s?new Promise((t,a)=>{this.Modal({controller:Dl,controllerAs:"$ctrl",template:'<vd-dialog close="$ctrl.close" class="workflow-modal">\n  <div class="vd-dialog-header">\n    <h2 class="vd-header vd-header--dialog">\n      {{:: $ctrl.header }}\n    </h2>\n  </div>\n  <vd-scrollable monobrow="true" goatee="true" class="vd-dialog-content">\n    <p class="vd-p" style="white-space: pre-wrap;" ng-bind-html="$ctrl.message | vdRemoveWidow"></p>\n\n    <p class="vd-p" ng-if="$ctrl.customField.entity === \'line_item\'">\n      <vd-product-badge product="$ctrl.entity.product" size="small" />\n    </p>\n\n    <p class="vd-p">\n      <div class="vd-field" ng-if="$ctrl.customField.type === \'string\'">\n        <label for="custom-field-value" class="vd-label">{{:: $ctrl.customField.title }}</label>\n        <div class="vd-value">\n          <input\n            ng-if="!$ctrl.possibleValues"\n            id="custom-field-value"\n            ng-model="$ctrl.value"\n            required\n            vd-focus="{ focusOn: \'focusInput\' }"\n            class="vd-input"\n            ng-class="{\'vd-input--error\': $ctrl.errorMessage}"\n            placeholder="Enter {{:: $ctrl.customField.title | lowercase}}"\n          >\n\n          <vd-radio-group\n            ng-if="$ctrl.possibleValues"\n            ng-model="$ctrl.value"\n            vd-focus="{ focusOn: \'focusInput\' }"\n          >\n            <vd-radio ng-repeat="item in $ctrl.possibleValues track by item.value"\n              value="item.value"\n              label="{{item.title}}"\n              required\n              class="vd-pt1 vd-pl3 vd-pb1"\n            >\n            </vd-radio>\n          </vd-radio-group>\n\n          <vd-error-message ng-if="$ctrl.errorMessage">{{:: $ctrl.errorMessage}}</vd-error-message>\n        </div>\n      </div>\n\n      <div class="vd-field" ng-if="$ctrl.customField.type === \'integer\'">\n        <label for="custom-field-value" class="vd-label">{{:: $ctrl.customField.title }}</label>\n        <div class="vd-value">\n          <input\n            ng-if="!$ctrl.possibleValues"\n            type="number"\n            step="1"\n            id="custom-field-value"\n            ng-model="$ctrl.value"\n            required\n            vd-focus="{ focusOn: \'focusInput\' }"\n            class="vd-input"\n            ng-class="{\'vd-input--error\': $ctrl.errorMessage}"\n            placeholder="Enter {{:: $ctrl.customField.title | lowercase}}"\n          >\n          <vd-error-message ng-if="$ctrl.errorMessage">{{:: $ctrl.errorMessage}}</vd-error-message>\n\n          <vd-radio-group\n            ng-if="$ctrl.possibleValues"\n            ng-model="$ctrl.value"\n            vd-focus="{ focusOn: \'focusInput\' }"\n          >\n            <vd-radio ng-repeat="item in $ctrl.possibleValues track by item.value"\n              value="item.value"\n              label="{{item.title}}"\n              required\n              class="vd-pt1 vd-pl3 vd-pb1"\n            >\n            </vd-radio>\n          </vd-radio-group>\n        </div>\n      </div>\n\n      <div class="vd-field" ng-if="$ctrl.customField.type === \'boolean\'">\n        <vd-checkbox\n          ng-model="$ctrl.value"\n          label="{{:: $ctrl.customField.title }}"\n        />\n      </div>\n    </p>\n  </vd-scrollable>\n  <div class="vd-dialog-actions">\n    <div class="vd-btn-group">\n      <div ng-if="$ctrl.applicationName" class="app-info">\n        This message was sent by\n        <a vd-tooltip-trigger="$ctrl.appTooltip" class="vd-link vd-link--secondary">{{:: $ctrl.applicationName }}</a>.\n      </div>\n      <button type="button" class="vd-btn vd-btn--do" ng-click="$ctrl.continue()">Continue</button>\n    </div>\n  </div>\n</vd-dialog>\n',header:e.title,message:e.message,customField:e.custom_field,entity:s,possibleValues:n||null,applicationName:e.application&&e.application.name}).then(e=>e.close.then(e=>{e&&e.proceed||a(new Error("Cancelled workflow modal")),t(e)}))}):Promise.resolve({proceed:!0,modified:!1})}requireCustomFields(e){const t=this.getCustomFieldEntity(e.entity,e.entity_id);return t?new Promise((n,s)=>{this.Modal({controller:Nl,controllerAs:"$ctrl",template:'<vd-dialog close="$ctrl.close" class="workflow-modal">\n  <div class="vd-dialog-header">\n    <h2 class="vd-header vd-header--dialog">\n      {{:: $ctrl.header }}\n    </h2>\n  </div>\n\n  <vd-scrollable monobrow="true" goatee="true" class="vd-dialog-content" vd-focus="{ focusOn: \'focusInput\' }">\n    <p class="vd-p" style="white-space: pre-wrap;" ng-bind-html="$ctrl.message | vdRemoveWidow"></p>\n\n    <p class="vd-p" ng-if="$ctrl.entityType === \'line_item\'">\n      <vd-product-badge product="$ctrl.entity.product" size="small" />\n    </p>\n\n    <div ng-repeat="customField in $ctrl.requiredCustomFields" class="vd-p">\n      <div class="vd-field" ng-if="customField.field.type === \'string\'">\n        <label for="cf-{{customField.field.id}}" class="vd-label">{{:: customField.field.title }}</label>\n        <div class="vd-value">\n          <input\n            ng-if="!customField.values"\n            id="cf-{{customField.field.id}}"\n            ng-model="customField.value"\n            tabindex="{{ !customField.value || customField.errorMessage ? $index + 1 : -1 }}"\n            required\n            class="vd-input"\n            ng-class="{\'vd-input--error\': customField.errorMessage}"\n            placeholder="Enter {{:: customField.field.title | lowercase}}"\n          >\n\n          <vd-radio-group\n            ng-if="customField.values"\n            ng-model="customField.value"\n            tabindex="{{ !customField.value || customField.errorMessage ? $index + 1 : -1 }}"\n          >\n            <vd-radio ng-repeat="item in customField.values track by item.value"\n              value="item.value"\n              label="{{item.title}}"\n              required\n              class="vd-pt1 vd-pl3 vd-pb1"\n            >\n            </vd-radio>\n          </vd-radio-group>\n\n          <vd-error-message ng-if="customField.errorMessage">{{:: customField.errorMessage}}</vd-error-message>\n        </div>\n      </div>\n\n      <div class="vd-field" ng-if="customField.field.type === \'integer\'">\n        <label for="cf-{{customField.field.id}}" class="vd-label">{{:: customField.field.title }}</label>\n        <div class="vd-value">\n          <input\n            ng-if="!customField.values"\n            type="number"\n            step="1"\n            id="cf-{{customField.field.id}}"\n            ng-model="customField.value"\n            tabindex="{{ !customField.value || customField.errorMessage ? $index + 1 : -1 }}"\n            required\n            class="vd-input"\n            ng-class="{\'vd-input--error\': customField.errorMessage}"\n            placeholder="Enter {{:: customField.field.title | lowercase}}"\n          >\n          <vd-error-message ng-if="customField.errorMessage">{{:: customField.errorMessage}}</vd-error-message>\n\n          <vd-radio-group\n            ng-if="customField.values"\n            ng-model="customField.value"\n            tabindex="{{ !customField.value || customField.errorMessage ? $index + 1 : -1 }}"\n          >\n            <vd-radio ng-repeat="item in customField.values track by item.value"\n              value="item.value"\n              label="{{item.title}}"\n              required\n              class="vd-pt1 vd-pl3 vd-pb1"\n            >\n            </vd-radio>\n          </vd-radio-group>\n        </div>\n      </div>\n\n      <div class="vd-field" ng-if="customField.field.type === \'boolean\'">\n        <vd-checkbox\n          ng-model="customField.value"\n          label="{{:: customField.field.title }}"\n          tabindex="{{ customField.value || customField.errorMessage ? $index + 1 : -1 }}"\n          />\n      </div>\n\n      <div class="vd-field" ng-if="customField.field.type === \'date\'">\n        <label for="cf-{{customField.field.id}}" class="vd-label">{{:: customField.field.title }}</label>\n        <div class="vd-value">\n          <input\n            ng-if="!customField.values"\n            id="cf-{{customField.field.id}}"\n            ng-model="customField.value"\n            vd-datepicker="{format: \'YYYY-MM-DD\'}"\n            vd-date="{format: \'YYYY-MM-DD\'}"\n            ng-model-options="{ updateOn: \'blur\' }"\n            tabindex="{{ !customField.value || customField.errorMessage ? $index + 1 : -1 }}"\n            required\n            vd-input-symbol="{ align: \'right\', icon: \'fa fa-calendar\' }"\n            class="vd-input"\n            placeholder="Select date"\n            autocomplete="off"\n            spellcheck="false">\n\n          <vd-radio-group\n            ng-if="customField.values"\n            ng-model="customField.value"\n            tabindex="{{ !customField.value || customField.errorMessage ? $index + 1 : -1 }}"\n          >\n            <vd-radio ng-repeat="item in customField.values track by item.value"\n              value="item.value"\n              label="{{item.title}}"\n              required\n              class="vd-pt1 vd-pl3 vd-pb1"\n            >\n            </vd-radio>\n          </vd-radio-group>\n\n          <vd-error-message ng-if="customField.errorMessage">{{:: customField.errorMessage}}</vd-error-message>\n        </div>\n      </div>\n\n      <div class="vd-field" ng-if="customField.field.type === \'product_id\'">\n        <label class="vd-label">{{:: customField.field.title }}</label>\n\n        <div class="vd-value" ng-if="!customField.values">\n          <div ng-if="customField.value && customField.entity" class="selected-entity">\n            <vd-product-badge product="customField.entity" size="x-small" />\n            <button\n              class="vd-btn vd-btn--icon-no clear"\n              type="button"\n              ng-click="$ctrl.clearValue(customField)"\n            >\n              <vd-icon icon="fa-trash"></vd-icon>\n            </button>\n          </div>\n\n          <vd-autocomplete\n            ng-if="!customField.value"\n            source="$ctrl.productSuggestionsSource()"\n            icon="fa-search"\n            on-select="$ctrl.selectEntity(customField, $event.selected.product)"\n            required\n            placeholder="Search for a product..."\n          >\n          </vd-autocomplete>\n        </div>\n\n        <vd-radio-group ng-if="customField.values"\n          ng-model="customField.value"\n          tabindex="{{ customField.errorMessage ? $index + 1 : -1 }}"\n        >\n          <vd-radio ng-repeat="item in customField.values track by item.value"\n            value="item.value"\n            required\n            class="vd-pt1 vd-pl3 vd-pb1"\n          >\n            <vd-product-badge ng-if="item.entity" product="item.entity" size="small" />\n          </vd-radio>\n        </vd-radio-group>\n\n        <vd-error-message ng-if="customField.errorMessage">{{:: customField.errorMessage}}</vd-error-message>\n      </div>\n    </div>\n  </vd-scrollable>\n\n  <div class="vd-dialog-actions">\n    <div class="vd-btn-group">\n      <div ng-if="$ctrl.applicationName" class="app-info">\n        This message was sent by\n        <a vd-tooltip-trigger="$ctrl.appTooltip" class="vd-link vd-link--secondary">{{:: $ctrl.applicationName }}</a>.\n      </div>\n      <button type="button" class="vd-btn vd-btn--do" ng-click="$ctrl.continue()">Continue</button>\n    </div>\n  </div>\n</vd-dialog>\n',header:e.title,message:e.message,entity:t,requiredCustomFields:e.required_custom_fields,applicationName:e.application&&e.application.name}).then(e=>e.close.then(e=>{e&&e.proceed||s(new Error("Cancelled workflow modal")),n(e)}))}):Promise.resolve({proceed:!0,modified:!1})}showStopOrConfirmModal(e){return new Promise((t,n)=>{this.Modal({controller:Al,controllerAs:"$ctrl",template:'<vd-dialog close="$ctrl.close" class="workflow-modal">\n  <div class="vd-dialog-header">\n    <h2 class="vd-header vd-header--dialog">\n      {{:: $ctrl.header }}\n    </h2>\n  </div>\n  <vd-scrollable monobrow="true" goatee="true" class="vd-dialog-content">\n    <p class="vd-p" style="white-space: pre-wrap;" ng-bind-html="$ctrl.message | vdRemoveWidow"></p>\n  </vd-scrollable >\n  <div class="vd-dialog-actions">\n    <div class="vd-btn-group">\n      <div ng-if="$ctrl.applicationName" class="app-info">\n        This message was sent by\n        <a vd-tooltip-trigger="$ctrl.appTooltip" class="vd-link vd-link--secondary">{{:: $ctrl.applicationName }}</a>.\n      </div>\n      <button ng-if="$ctrl.dismissText" type="button" class="vd-btn vd-btn--supplementary" ng-click="$ctrl.cancel()">{{:: $ctrl.dismissText }}</button>\n      <button ng-if="$ctrl.confirmText" type="button" class="vd-btn vd-btn--do" ng-click="$ctrl.continue()">{{:: $ctrl.confirmText }}</button>\n    </div>\n  </div>\n</vd-dialog>\n',header:e.title,message:e.message,confirmText:e.confirm_label,dismissText:e.dismiss_label,applicationName:e.application&&e.application.name}).then(e=>e.close.then(e=>{e||n(new Error("Cancelled workflow modal")),t({proceed:e,modified:!1})}))})}lookupProduct(e){return new Promise((t,n)=>{e.product_id?this.productsStore.get(e.product_id).then(s=>{s?t(s):n(new Error(`There are no products with the ID ${e.product_id}.`))}).catch(e=>n(e)):e.product_sku?this.productSkuIndex.search(e.product_sku).then(s=>s&&s.length?s.length>1?n(new Error(`There are multiple products with SKU ${e.product_sku}.`)):s[0].exactMatch&&"product"===s[0].type?t(s[0].product):n(new Error(`There are no products with the SKU ${e.product_sku}.`)):n(new Error(`There are no products with the SKU ${e.product_sku}.`))).catch(e=>n(e)):n(new Error("You must provide a product_id or product_sku."))})}addLineItem(e,t){return new Promise((n,s)=>{this.lookupProduct(e).then(n=>this.saleManager.addProductToSale(n,{quantity:e.quantity,price:e.unit_price,note:e.note},{workflow:t})).then(e=>{t.lineItemAdded(e.localId||e.id),n({proceed:!0,modified:!0})}).catch(e=>{Qe.warn("[Workflows] Failed to add product",e),n({proceed:!0,modified:!1})})})}removeLineItem(e,t){return new Promise((n,s)=>{const a=this.findLineItem(e.line_item_id);a?(this.saleManager.removeLineItem(a),t.lineItemRemoved(a.localId||a.id),n({proceed:!0,modified:!0})):n({proceed:!0,modified:!1})})}suggestProducts(e,t){var n,s=this;const a=null===(n=e.suggested_products)||void 0===n?void 0:n.map(e=>this.lookupProduct(e)),i=async function(e){const n=await s.saleManager.addProductToSale(e,{quantity:1},{workflow:t});t.lineItemAdded(n.localId||n.id)};return Promise.all(a).then(t=>this.Modal({controller:xl,controllerAs:"$ctrl",template:'<vd-dialog close="$ctrl.close" class="workflow-modal">\n  <div class="vd-dialog-header">\n    <h2 class="vd-header vd-header--dialog">\n      {{:: $ctrl.header }}\n    </h2>\n  </div>\n\n  <vd-scrollable monobrow="true" goatee="true" class="vd-dialog-content">\n    <p class="vd-p" style="white-space: pre-wrap;" ng-bind-html="$ctrl.message | vdRemoveWidow"></p>\n\n    <div class="vd-g-row vd-g-s-up-2">\n      <div ng-repeat="sp in $ctrl.suggestedProducts" class="vd-g-col vd-pa1">\n        <vd-product-badge product="sp.product" ng-click="$ctrl.selectProduct($index)" interactive="selection" current="sp.selected" />\n      </div>\n    </div>\n  </vd-scrollable>\n\n  <div class="vd-dialog-actions">\n    <div class="vd-btn-group">\n      <div ng-if="$ctrl.applicationName" class="app-info">\n        This message was sent by\n        <a vd-tooltip-trigger="$ctrl.appTooltip" class="vd-link vd-link--secondary">{{:: $ctrl.applicationName }}</a>.\n      </div>\n      <button class="vd-btn vd-btn--supplementary" ng-click="$ctrl.continue()">No Thanks</button>\n      <button type="button" class="vd-btn vd-btn--do" ng-click="$ctrl.addSelectedProducts()" ng-disabled="!$ctrl.hasSelectedProducts">Add Products to Basket</button>\n    </div>\n  </div>\n</vd-dialog>\n',products:t,addProduct:i,header:e.title,message:e.message,applicationName:e.application&&e.application.name}).then(e=>e.close))}async setCustomer(e){if(!e.customer_id)return this.saleManager.sale.customer?(await this.saleManager.removeCustomer(),{proceed:!0,modified:!0}):{proceed:!0,modified:!1};if(this.saleManager.sale.customer&&this.saleManager.sale.customer.id===e.customer_id)return{proceed:!0,modified:!1};const t=await pa.get(e.customer_id);return t?(await this.saleManager.addCustomer(t),{proceed:!0,modified:!0}):(Qe.warn("[Workflows] Could not find customer with ID",e.customer_id),{proceed:!0,modified:!1})}getUser(){return{id:this.userManager.getLoggedInUser().id,username:this.userManager.getLoggedInUser().username,email:this.userManager.getLoggedInUser().email,account_type:this.userManager.getLoggedInUser().account_type}}getSale(){const e=this.saleManager.sale;return{outlet_id:this.registerManager.getActiveOutlet().id,register_id:this.registerManager.getActiveRegister().id,note:e.note,total_price:e.totals.exclusivePrice.toString(),total_tax:e.totals.tax.toString(),custom_fields:e.customFields.map(e=>({definition_id:e.definitionId,name:e.name,type:e.type,value:e.value})),line_items:e.lineItems.map(this.lineItemForWorkflows)}}lineItemForWorkflows(e){return{id:e.localId,product_id:e.product.id,quantity:e.quantity.toString(),price:e.price.toString(),price_total:e.totals.exclusivePrice.toString(),tax_total:e.totals.tax.toString(),note:e.note,custom_fields:e.customFields.map(e=>({definition_id:e.definitionId,name:e.name,type:e.type,value:e.value}))}}getCustomer(){const{customer:e}=this.saleManager.sale;return e?{id:e.id,first_name:e.first_name,last_name:e.last_name,customer_code:e.customer_code,customer_group_id:e.customer_group_id,email:e.email,phone:e.phone,mobile:e.mobile,fax:e.fax,do_not_email:e.do_not_email,note:e.note,date_of_birth:e.date_of_birth,year_to_date:e.year_to_date.toString(),balance:e.balance.toString(),loyalty_balance:e.loyalty_balance.toString(),created_at:e.created_at,enable_loyalty:e.enable_loyalty,custom_field_1:e.custom_field_1,custom_field_2:e.custom_field_2,custom_field_3:e.custom_field_3,custom_field_4:e.custom_field_4}:null}getCustomFieldEntity(e,t){switch(e){case kl.SALE:return this.saleManager.sale;case kl.LINE_ITEM:return this.findLineItem(t);default:return Qe.warn("[Workflows] Unsupported entity in requre_custom_field action",{type:e,id:t}),null}}findLineItem(e){return e?this.saleManager.sale.lineItems.find(t=>t.localId===e||t.id===e):null}getConfiguredEvents(){return Ke.get("/api/2.0/workflows/configured_events").then(e=>{this.configuredEvents=Ue(e)})}hasConfiguredEvent(e){return this.configuredEvents.includes(e)}triggerRules(e,t){if(!this.hasConfiguredEvent(e))return Promise.resolve(!0);t||(t=new Fl);const n=[...t.lineItemIdsAdded];return this.iterateOnEvent(e,t).then(s=>{if(Qe.log("[Workflows] Done with event.",{event:e,id:t.id,proceed:s,context:t}),e===Ll.LINE_ITEMS_ADDED)return s;const a=Se(t.lineItemIdsAdded,n);if(a.length){const e=new Fl({parentContext:t,lineItemIdsAdded:a});return this.triggerRules(Ll.LINE_ITEMS_ADDED,e)}return s})}iterateOnEvent(e,t){if(!this.hasConfiguredEvent(e))return Promise.resolve(!0);if(t.iteration>5)return Promise.resolve(!0);t.nextIteration(),Qe.log("[Workflows] Triggering rules.",{event:e,id:t.id,context:t});const n={event_type:e,event_id:t.id,user:this.getUser(),sale:this.getSale(),customer:this.getCustomer()};return e===Ll.LINE_ITEMS_ADDED&&(n.line_items=[],t.lineItemIdsAdded.length&&n.sale.line_items.forEach(e=>{-1!==t.lineItemIdsAdded.indexOf(e.id)&&n.line_items.push(e)})),Ke.post("/api/2.0/workflows/trigger",n).then(n=>{const{actions:s,errors:a}=Ue(n);return a.length>0&&Qe.warn("[Workflows] Some workflows failed.",a),!s.length||this.enqueueActions(s,t).then(n=>!!n.proceed&&(!n.modified||this.iterateOnEvent(e,t))).catch(e=>(Qe.warn("[Workflows] action failed",e),!1))}).catch(e=>(this.vdTracking.trackError("[Workflows] Failed to load workflows.",{data:{error:e}}),!0))}triggerLineItemsAdded(){if(0===this.lineItemIdsAddedQueue.length)return;const e=new Fl({lineItemIdsAdded:this.lineItemIdsAddedQueue});this.lineItemIdsAddedQueue=[],this.triggerRules(Ll.LINE_ITEMS_ADDED,e)}lineItemAddedListener(e,t,n){n&&n.workflow||(this.lineItemIdsAddedQueue.push(t.localId),this.triggerLineItemsAdded())}lineItemRemovedListener(e,t){const n=this.lineItemIdsAddedQueue.indexOf(t.localId);-1!==n&&this.lineItemIdsAddedQueue.splice(n,1),this.triggerLineItemsAdded()}saleCustomerUpdatedListener(e){this.triggerRules(Ll.SALE_CUSTOMER_CHANGED)}}Ul.$inject=["userManager","registerManager","saleManager","productsStore","productSkuIndex","Modal","vdTracking","vdFeatureManager"],t.module("webregister.services").service("workflowService",Ul);class Bl{constructor(e,t){this.vdPerformanceTracking=e,this.vdTracking=t,s(this,"metadata",{})}initialiseTracking(){this.metadata={},this.vdPerformanceTracking.clearAllByName(["vend-sale","start vend-sale","stop vend-sale"]),this.vdPerformanceTracking.start("vend-sale")}isTrackingInitialised(){return Boolean(this.vdPerformanceTracking.getMark("start vend-sale"))}completeTracking(e={}){if(!this.isTrackingInitialised())return;const t=this.vdPerformanceTracking.stop("vend-sale");t&&this.vdTracking.trackUserEvent({eventName:"Sale",metadata:r(r(r({},this.metadata),e),{duration:t.duration}),sendSynchronously:!0})}addTrackingData(e){this.isTrackingInitialised()&&(this.metadata=r(r({},this.metadata),e))}}Bl.$inject=["vdPerformanceTracking","vdTracking"],t.module("webregister.components").service("saleTracker",Bl);const ql=({title:e,subTitle:t,items:n})=>{const s=za();return i.createElement("article",{className:"wr-quick-receipt"},i.createElement("header",{className:"vd-align-center"},i.createElement("div",{className:"vd-align-left vd-text-supplementary vd-mb6"},s.get().name),i.createElement("div",{className:"vd-text-label"},e),t&&i.createElement("div",{className:"vd-text-hero"},t)),i.createElement("section",{className:"wr-quick-receipt-section vd-mt3 vd-pt3 vd-pb3"},i.createElement("ul",null,n)))},Vl=({label:e,value:t})=>i.createElement("li",{className:"wr-quick-receipt-item"},i.createElement("div",{className:"wr-quick-receipt-item-key"},e,":"),i.createElement("div",null,t)),Kl=({label:e="Date",value:t})=>{const n=Ga().getActiveOutlet();return i.createElement(Vl,{label:e,value:Un(t,"D MMM, YYYY @ h:mma",n.time_zone)})},Gl=({label:e="Register"})=>{const t=Ga().getActiveRegister();return i.createElement(Vl,{label:e,value:t.name})};t.module("webregister.components").component("wrPrintCashMovementReceipt",At(({data:e})=>{const t=Ka();return i.createElement(ql,{title:e.type,subTitle:t(e.amount),items:i.createElement(i.Fragment,null,i.createElement(Kl,{value:e.date}),i.createElement(Vl,{label:"User",value:e.username}),i.createElement(Gl,null),i.createElement(Vl,{label:"Note",value:e.note||"-"}))})},["data"]));t.module("webregister.components").component("wrPrintStoreCreditIssueReceipt",At(({data:e})=>{const t=Ka();return i.createElement(ql,{title:e.type,subTitle:t(e.amount),items:i.createElement(i.Fragment,null,i.createElement(Kl,{value:e.date}),i.createElement(Vl,{label:"Customer",value:e.customerInfo}),i.createElement(Vl,{label:"Balance",value:t(e.balance)}),i.createElement(Vl,{label:"Served By",value:e.username}),i.createElement(Gl,null))})},["data"]));const jl=At(({showTaxDetails:e,tax:t})=>{const n=Ya();let s=t.name;if(e){s+=` (${n.calculateDisplayRate(t)}%)`}return i.createElement("span",null,s)},["showTaxDetails","tax"]),Ql=e=>({restrict:"A",link(t,n){e.add({action:()=>function(){const e=n[0].querySelector(".sale-list-item:last-child .li-cell-summary-container");e&&e.click()}(),combo:"alt+l",summary:"Toggle last line item"}),t.$on("$destroy",(function(){e.remove("alt+l")}))}});Ql.$inject=["hotkeysService"],t.module("webregister.components").provider("tracking",Ws).service("salePromotionResourceService",ha).service("saleInventoryData",ua).service("markUnfulfilledModalService",ma).service("promotionModalService",el).directive("saleDiscountInput",Hs).directive("toggleLastLineItem",Ql).component("saleDiscount",Xs).component("salePromoCode",ea).component("saleDiscountError",Ys).component("salePromotion",ra).component("salePayment",ca).component("saleTaxBreakdown",sa).component("hasCcErrorMessage",kr).component("preloadReceiptImages",Pr).component("openRegisterPanel",Ar).component("registerClosureInfo",xr).component("registerClosureSummaryNotes",Or).component("setCashFloatForm",Kr).component("wrColouredNumber",Go).component("wrNoProductsModal",Xo).component("wrDisplayTaxRate",jl).component("saleNoteRedux",xa).component("lineItemDiscountPercent",ai).component("lineItemDisplay",ci).component("lineItemMarkupPercent",di).component("lineItemNote",hi).component("lineItemDisplayPrice",gi).component("lineItemQuantity",yi).component("wrReceiptPreviewLineItems",_i).component("receiptSelectionEmailToggle",er).component("receiptPrintSelected",Tr).component("unknownLineItem",Oa).component("markAsUnfulfilledModal",zi).component("vbPromotionModal",Zo),t.module("webregister.controllers").controller("RegisterActionsPopoverController",$r).controller("CashMovementController",Br).controller("SetCashFloatController",qr).controller("ErroredSalesModalController",ga).controller("OpenRegisterContinueSaleController",Dr).controller("RetrieveSalePopoverController",ya).controller("SalePromoCodePopoverController",Ia).controller("OutletsDifferModalController",Pa).controller("SaleServiceFeePopoverController",Ra).controller("ReceiptSelectionPopoverController",Ji).controller("MoreActionsPopoverController",Aa).controller("markUnfulfilledModalController",Da).controller("promotionModalController",tl),t.module("webregister.directives").directive("attachCustomerTooltip",()=>({restrict:"A",controllerAs:"$ctrl",bindToController:!0,controller:["$element","vdTooltip","trainingModeManager","registerManager","saleManager","vdWindowDelegate",function(e,t,n,s,a,i){const{viewport:r}=i.currentViewport,o=r.match(/large/g)?"left":"center";a.sale.hideAttachCustomerTooltip||(a.sale.hideAttachCustomerTooltip=!0,a.saveSale(),s.isAddCustomerEnabled()&&!n.trainingModeEnabled&&Je(()=>{t.open({trigger:e,template:'\n                <vd-tooltip class="wr-tooltip">\n                  <div class="vd-text-label vd-pb1">\n                    <vd-icon icon="fa-info-circle" class="vd-mr2"></vd-icon>Add a customer to this sale.\n                  </div>\n                  <p vd-no-widow>You haven\'t added a customer to this sale yet. You can search for an existing customer, add a new one, or just continue to pay.</p>\n                  <div class="vd-dialog-actions">\n                    <button class="vd-btn vd-btn--do vd-mt1" ng-click="$ctrl.close()">Got It</button>\n                  </div>\n                </vd-tooltip>\n              ',direction:o})},350))}]}));const Wl="Before you can switch registers, it\u2019s important to have all your sales synced to our\n  servers, otherwise your sales will be deleted and cannot be recovered.";t.module("webregister.modals").factory("registerModals",["Modal","Confirm","registerManager","saleSyncManager","wrDebugTools","vdToastNotificationService",function(e,t,n,s,a,i){return a.register("registerModals"),{selectRegister:t=>e({template:'<vd-dialog size="$ctrl.registersByOutlet.length <= 4 ? \'large\' : \'xlarge\'"\n  close="$ctrl.close"\n  dismissible="$ctrl.dismissible"\n  header="Select Register"\n  class="pro-select-register-dialog">\n  <div class="vd-dialog-content">\n    <vd-tabs model="$ctrl.selectedOutlet">\n      <vd-tab ng-repeat="outletRegisterInfo in $ctrl.registersByOutlet track by outletRegisterInfo.outlet.id"\n        active="$index === $ctrl.selectedOutlet"\n        value="$index">\n        {{outletRegisterInfo.outlet.name}}\n      </vd-tab>\n    </vd-tabs>\n\n    <div ng-repeat="outletRegisterInfo in $ctrl.registersByOutlet track by outletRegisterInfo.outlet.id"\n      ng-if="$index === $ctrl.selectedOutlet"\n      class="wr-cards vd-mt3">\n      <button ng-repeat="register in outletRegisterInfo.registers track by register.id"\n        ng-click="$ctrl.selectRegister(register, outletRegisterInfo.outlet)"\n        vd-focus="{ isFocusable: $first }"\n        ng-class="[\'wr-card\', {\n          \'wr-card--active\': register.id === $ctrl.activeRegister.id\n        }]">\n        <div class="wr-card-content">\n          <h3 class="wr-card-value">{{register.name}}</h3>\n          <div class="wr-card-value-status">\n            {{$ctrl.getRegisterTradingStatus(register, outletRegisterInfo.outlet)}}\n          </div>\n        </div>\n      </button>\n    </div>\n  </div>\n</vd-dialog>\n',controller:"SelectRegisterController",controllerAs:"$ctrl",dismissible:t}),openRegisterToContinueSaleIfNeeded:()=>n.isActiveRegisterOpen()?We.resolve():e({template:'<vd-dialog header="Register Closed" close="$ctrl.close" dismissible="!$ctrl.openingRegister">\n  <div class="vd-dialog-content">\n    <p class="vd-p">To continue this sale, the register must be opened first.</p>\n    <set-cash-float-form form="$ctrl.openRegisterSetFloatForm"\n      form-id="openRegisterContinueSaleForm"\n      on-submit="$ctrl.openRegister($event.cashFloatSettings)"\n      loading="$ctrl.openingRegister">\n    </set-cash-float-form>\n  </div>\n  <div class="vd-dialog-actions vd-btn-group vd-align-center" vd-flex vd-flex-justify="end">\n    <span ng-if="$ctrl.openingRegister" class="vd-loader"></span>\n    <button ng-disabled="$ctrl.openingRegister"\n      ng-click="$ctrl.close()"\n      class="vd-btn vd-btn--supplementary vd-ml3">\n      Cancel\n    </button>\n    <button type="submit"\n      class="vd-btn vd-btn--do"\n      form="openRegisterContinueSaleForm"\n      ng-disabled="$ctrl.openRegisterSetFloatForm.$invalid || $ctrl.openingRegister">\n      Open Register and Continue Sale\n    </button>\n  </div>\n</vd-dialog>\n',controller:"OpenRegisterContinueSaleController",controllerAs:"$ctrl"}).then(e=>e.close),closeRegisterConfirmation:()=>t({header:"Are you sure you want to close this register?",content:'\n          <p class="vd-p vd-mt3 vd-mb5">Your payment and sales totals will be finalised for this period.</p>',confirm:{label:"Close Register",category:"no"}}),actionErroredSales(){const e=s.erroredSalesCount+s.attemptedSalesCount,n=e>1?"sales":"sale";return t({header:`You have ${e} errored ${n}`,content:`<p class="vd-p">${Wl}</p>`,cancel:{isVisible:!1},confirm:{label:"View errored "+n,resolve:()=>{et.go(en)}}})},actionOfflineSales(){const e=s.uploadSalesCount,n=e>1?"sales":"sale";return t({header:`You have ${e} offline ${n}`,content:`<p class="vd-p">${Wl}</p>`,cancel:{isVisible:!1},confirm:{label:"Sync offline "+n,resolve:()=>s.retryUnsyncedSales()}}).then(()=>{if(s.unsyncedSalesCount)return i.negative({message:"There was a problem syncing your offline sales. Please try again."}),We.reject()})}}}]);const Hl=new Bs({entityStoreName:"outlets"});t.module("webregister.modals").factory("productModals",["brandsStore","priceManager","productsStore","productTypesStore","suppliersStore","tagsStore","webRegisterStatusManager","vdToastNotificationService","Modal","variantPickerModalService","vpVariantPicker","vdFeatureManager",function(e,t,n,s,a,i,o,l,d,u,h,m){function g(t){const n=t.brand_id||t.brand&&t.brand.id;return n?e.get(n):We.resolve(null)}function v(e){const t=e.supplier_id||e.supplier&&e.supplier.id;return t?a.get(t):We.resolve(null)}function y(e){let t;return t=e.tag_ids?e.tag_ids:p(e.categories,"id"),We.all(t.map(i.get,i)).then(e=>e.filter(Boolean))}function f(e){const t=e.product_type_id||e.type&&e.type.id;return t?s.get(t):We.resolve(null)}function S(e){let t;return t=e.has_inventory&&o.isOnline()?da([e.id],{include_variants:Boolean(e.variant_options.length)}).then(e=>e.map(e=>({inventory_level:c.add(e.levels.producible,e.levels.on_hand),outlet_id:e.location_id,product_id:e.product_id}))).then(e=>function(e){const t=[...new Set(e.map(e=>e.product_id))];return Ke.post("/api/graphql",{operationName:"ProductInventoryLevels",query:"query ProductInventoryLevels($productIDs:[String!]) {\n    inventoryLevels(options: {productIDs: $productIDs, includeComposites: true, includeInactive: false}) {\n      inventoryLevels {\n        locationID\n        productID\n        inboundLevels {\n          hasInboundOrders\n        }\n      }\n    }\n  }",variables:{productIDs:t}}).then(Ue).then(t=>{const{inventoryLevels:n}=t.inventoryLevels;return e.map(e=>{const t=n.find(t=>t.locationID===e.outlet_id&&t.productID===e.product_id),s=r(r({},e),{},{hasInboundOrders:!1});if(t){const{hasInboundOrders:e}=t.inboundLevels;s.hasInboundOrders=e}return s})})}(e)).catch(()=>{l.negative({message:"Failed to retrieve inventory information, please try again."})}):We.when([]),t}function C(e){let t;return t=e.variant_options.length?n.getAllVariantProducts(e):We.when([]),t.then(b)}function b(e){return We.all(p(e,(function(e){return t.getBasePriceForProduct(e.id).then((function(t){return e.basePrice=t,e}))})))}return{selectVariant:e=>We((t,s)=>{n.getAllVariantProducts(e.parentProduct).then(t=>{const n={parentProduct:e.parentProduct,allowVariantParentSelect:e.allowVariantParentSelect,title:e.title,variantProducts:t};return m.get("react_variant_picker")?u.openVariantPicker(n):h.selectVariant(n)}).then(e=>{e?t(e):s()},s)}),viewDetails(e){return We.all({parentProductData:this._resolveParentProductDetails(e),outlets:Hl.all()}).then(({parentProductData:e,outlets:t})=>d({controller:"ViewProductDetailsCtrl",controllerAs:"viewProductDetailsCtrl",template:'<vd-dialog close="viewProductDetailsCtrl.close"\n  size="viewProductDetailsCtrl.imagesAvailable ? \'xlarge\' : \'large\'"\n  class="wr-view-product-details-dialog"\n  ng-class="{\'wr-view-product-details-dialog--has-images\': viewProductDetailsCtrl.imagesAvailable}">\n\n  <div ng-if="::viewProductDetailsCtrl.imagesAvailable" class="wr-view-product-details-image-container">\n    <div class="wr-view-product-details-image-loader">\n      <span class="vd-loader vd-loader--small"></span>\n    </div>\n    <div class="wr-view-product-details-image"\n      vd-bg-image="{ image: viewProductDetailsCtrl.parentProduct.images[0].url }">\n    </div>\n  </div>\n  <header class="vd-dialog-header vd-dialog-header--center vd-mb0">\n    <vd-header category="dialog" class="pro-view-product-details-name">\n      {{::viewProductDetailsCtrl.parentProduct.name}}\n      <span ng-if="::(!viewProductDetailsCtrl.hasVariants)" class="vd-dialog-header-sub pro-view-product-details-price">\n        {{::viewProductDetailsCtrl.parentProductData.basePrice | vdCurrency}}\n      </span>\n    </vd-header>\n    <div ng-if="::(!viewProductDetailsCtrl.hasVariants)" class="vd-dialog-header-meta pro-view-product-details-sku">\n      {{::viewProductDetailsCtrl.parentProduct.sku}}\n    </div>\n  </header>\n\n  <div class="vd-dialog-content">\n    <div ng-if="viewProductDetailsCtrl.parentProduct.description.length"\n      class="vd-align-center wr-view-product-details-description-toggle">\n      <div ng-if="viewProductDetailsCtrl.showDescription"\n        class="wr-view-product-details-description vd-text--sub">\n        <span class="wr-honour-line-breaks" ng-bind-html="viewProductDetailsCtrl.parentDescription"></span>\n      </div>\n      <a href="javascript:void(0)" class="vd-text-supplementary vd-link vd-link--secondary wr-view-product-details-description-button"\n        ng-click="viewProductDetailsCtrl.showDescription = !viewProductDetailsCtrl.showDescription">\n        {{viewProductDetailsCtrl.showDescription ? \'Hide\' : \'Show\'}} product description\n        <i ng-class="[\'fa\', {\n          \'fa-angle-up\': viewProductDetailsCtrl.showDescription,\n          \'fa-angle-down\': !viewProductDetailsCtrl.showDescription\n        }]"></i>\n      </a>\n    </div>\n\n    <hr class="vd-dialog-header-divider">\n    <ul class="wr-info-fields wr-view-product-info-fields">\n      <li wr-info-field class="pro-view-product-details-type"\n        label="\'Type\'"\n        value="::viewProductDetailsCtrl.parentProductData.productType.name">\n      </li>\n      <li wr-info-field class="pro-view-product-details-supplier"\n        label="\'Supplier\'"\n        value="::viewProductDetailsCtrl.parentProductData.supplier.name">\n      </li>\n      <li wr-info-field class="pro-view-product-details-brand"\n        label="\'Brand\'"\n        value="::viewProductDetailsCtrl.parentProductData.brand.name">\n      </li>\n      <li wr-info-field ng-if="::viewProductDetailsCtrl.canViewSupplierPrice"\n        class="pro-view-product-details-supplier-price"\n        label="\'Supplier Price\'"\n        value="::viewProductDetailsCtrl.parentProduct.supply_price | vdCurrency">\n      </li>\n    </ul>\n\n    <div ng-if="::(viewProductDetailsCtrl.hasVariants || viewProductDetailsCtrl.inventoryAvailable)">\n      <wr-product-variant-inventory-by-outlet\n        ng-if="::(viewProductDetailsCtrl.hasVariants && viewProductDetailsCtrl.inventoryAvailable)"\n        outlets="::viewProductDetailsCtrl.outlets"\n        parent-product="::viewProductDetailsCtrl.parentProduct"\n        variant-products="::viewProductDetailsCtrl.parentProductData.variantProducts"\n        inventory-data="::viewProductDetailsCtrl.parentProductData.inventoryData">\n      </wr-product-variant-inventory-by-outlet>\n\n      <wr-product-variant-table\n        ng-if="::(viewProductDetailsCtrl.hasVariants && !viewProductDetailsCtrl.inventoryAvailable)"\n        parent-product="::viewProductDetailsCtrl.parentProduct"\n        variant-products="::viewProductDetailsCtrl.parentProductData.variantProducts">\n      </wr-product-variant-table>\n\n      <wr-product-outlet-inventory-table\n        ng-if="::(!viewProductDetailsCtrl.hasVariants && viewProductDetailsCtrl.inventoryAvailable)"\n        inventory-data="::viewProductDetailsCtrl.parentProductData.inventoryData"\n        outlets="::viewProductDetailsCtrl.outlets">\n      </wr-product-outlet-inventory-table>\n    </div>\n  </div>\n</vd-dialog>\n',parentProductData:e,outlets:t}))},_resolveParentProductDetails:e=>function(e){return e.variant_parent_id?n.get(e.variant_parent_id):We.when(e)}(e).then(e=>We.all({parentProduct:e,basePrice:t.getBasePriceForProduct(e.id),brand:g(e),supplier:v(e),tags:y(e),productType:f(e),inventoryData:S(e),variantProducts:C(e)}))}}]);t.module("webregister.modals").factory("customerModals",["Modal","saleManager","customerManager",function(e,t,n){return{updateCustomer(e){return this._openEditCustomer({customer:e})},createCustomer(e){return this._openEditCustomer(e)},addCustomerToSale:(t={})=>n.getCustomerGroups().then(n=>e({template:'<vd-dialog header="{{addCustomerToSaleCtrl.title}}"\n  size="\'standard\'"\n  close="addCustomerToSaleCtrl.close"\n  focus-first-element="false">\n  <div class="vd-dialog-content wr-add-customer-to-sale-modal-content">\n    <div class="vd-field">\n      <div class="vd-label">Add a customer</div>\n      <div class="vd-value">\n        <vd-autocomplete source="addCustomerToSaleCtrl.customerSource"\n          error-template="{{ ::addCustomerToSaleCtrl.customerErrorTemplate }}"\n          on-select="addCustomerToSaleCtrl.onSelectResult($event.selected)"\n          placeholder="Enter a customer name"\n          icon="fa-user"\n          vd-focus="{ isFocusable: true }">\n        </vd-autocomplete>\n      </div>\n    </div>\n\n    <wr-customer-badge ng-if="addCustomerToSaleCtrl.customer"\n      customer="addCustomerToSaleCtrl.customer"\n      customer-balances="addCustomerToSaleCtrl.customerBalances"\n      view-options="{ canViewDetails: false, hideRemoveFromSale: true }">\n    </wr-customer-badge>\n\n    <span ng-if="addCustomerToSaleCtrl.customer" class="vd-text--secondary vd-text-supplementary vd-mt2">\n      Search again to choose another customer.\n    </span>\n  </div>\n  <div class="vd-dialog-actions">\n    <div class="vd-btn-group">\n      <button class="vd-btn vd-btn--supplementary" ng-click="addCustomerToSaleCtrl.close()">\n        {{addCustomerToSaleCtrl.cancelButtonLabel}}\n      </button>\n      <button class="vd-btn vd-btn--do"\n        ng-disabled="!addCustomerToSaleCtrl.customer"\n        ng-click="addCustomerToSaleCtrl.addCustomerToSale()">\n        Add customer to sale\n      </button>\n    </div>\n  </div>\n</vd-dialog>\n',controller:"AddCustomerToSaleCtrl",controllerAs:"addCustomerToSaleCtrl",cancelButtonLabel:t.cancelButtonLabel,customerGroups:n}).then(e=>e.closed)),viewCustomer(t,n={}){const{hideRemoveFromSale:s=!1,hideViewSales:a=!1,hideEditCustomer:i=!1}=n;return e({controller:"ViewCustomerCtrl",controllerAs:"viewCustomerCtrl",template:'<vd-dialog size="\'large\'" focus-first-element="false" close="viewCustomerCtrl.close" class="wr-view-customer-dialog">\n  <header class="vd-dialog-header vd-dialog-header--center">\n    <vd-header category="dialog" class="pro-customer-vitals-name">\n      {{ viewCustomerCtrl.customer | wrCustomerName }}\n    </vd-header>\n    <ul class="vd-dialog-header-meta">\n      <li class="wr-view-customer-meta-item">\n        <wr-customer-group customer="viewCustomerCtrl.customer" class="wr-customer-vitals-group"></wr-customer-group>\n      </li>\n      <li class="wr-view-customer-meta-item">\n        Last shopped {{ viewCustomerCtrl.customer.updated_at | vdDateFromNow }}\n      </li>\n    </ul>\n    <hr class="vd-dialog-header-divider">\n  </header>\n  <div class="vd-dialog-content">\n    <wr-customer-balances customer="::viewCustomerCtrl.customer"\n      customer-balances="viewCustomerCtrl.customerBalances">\n    </wr-customer-balances>\n\n    <vd-tabs model="viewCustomerCtrl.selectedCustomerTab">\n      <vd-tab active="true" value="\'customerDetails\'">{{viewCustomerCtrl.customerTabs.customerDetails}}</vd-tab>\n      <vd-tab ng-if="viewCustomerCtrl.isStoreCreditEnabled" value="\'storeCredit\'">\n        {{viewCustomerCtrl.customerTabs.storeCredit}}\n      </vd-tab>\n      <vd-tab value="\'notesOnCustomer\'">{{viewCustomerCtrl.customerTabs.notesOnCustomer}}</vd-tab>\n    </vd-tabs>\n\n    <div ng-switch="viewCustomerCtrl.selectedCustomerTab" class="vd-mt5">\n      <div ng-switch-when="customerDetails">\n        <wr-view-customer-details title="Customer info"\n          customer="::viewCustomerCtrl.customer"\n          fields="::viewCustomerCtrl.customerInfoFields">\n        </wr-view-customer-details>\n        <wr-view-customer-details ng-if="viewCustomerCtrl.contactFieldsHaveData" title="Contact info"\n          customer="::viewCustomerCtrl.customer"\n          fields="::viewCustomerCtrl.customerContactFields">\n        </wr-view-customer-details>\n      </div>\n      <div ng-if="viewCustomerCtrl.isStoreCreditEnabled" ng-switch-when="storeCredit">\n        <wr-customer-store-credit-history\n          store-credit="viewCustomerCtrl.customerBalances.storeCredit">\n        </wr-customer-store-credit-history>\n      </div>\n      <div ng-switch-when="notesOnCustomer">\n        <div ng-if="viewCustomerCtrl.customer.note"\n          class="wr-customer-note"\n          ng-bind-html="::viewCustomerCtrl.customer.note">\n        </div>\n        <p ng-if="!viewCustomerCtrl.customer.note" class="wr-view-customer-no-details">\n          There are no notes for this customer.\n        </p>\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-dialog-actions" ng-switch="viewCustomerCtrl.selectedCustomerTab">\n    <div class="vd-btn-group"\n      ng-switch-when="customerDetails"\n      vd-track-links="viewCustomerCtrl.viewCustomerTrackData">\n      <button ng-if="!viewCustomerCtrl.hideRemoveFromSale"\n        ng-click="viewCustomerCtrl.removeCustomerFromSale()"\n        class="vd-btn vd-btn--supplementary">\n        Remove From Sale\n      </button>\n      <a class="vd-btn vd-btn--do" ng-if="!viewCustomerCtrl.hideViewSales"\n        rel="noreferrer noopener"\n        ng-href={{viewCustomerCtrl.viewCustomerSalesUrl}}>\n        View Customer Sales\n      </a>\n      <button ng-if="!viewCustomerCtrl.hideEditCustomer"\n        ng-disabled="viewCustomerCtrl.trainingModeEnabled || !viewCustomerCtrl.webRegisterOnline"\n        ng-click="viewCustomerCtrl.editCustomer()"\n        vd-focus="{ isFocusable: true, focusDely: 200 }"\n        form="quickAddCustomerForm"\n        class="vd-btn vd-btn--do">\n        Edit Information\n      </button>\n    </div>\n    <div class="wr-view-customer-store-credit-actions" ng-switch-when="storeCredit">\n      <span class="vd-text--sub vd-text--secondary">Showing last 5 transactions.</span>\n      <div class="vd-btn-group">\n        <button ng-if="viewCustomerCtrl.userCanIssueStoreCredit"\n          ng-disabled="viewCustomerCtrl.trainingModeEnabled || !viewCustomerCtrl.webRegisterOnline"\n          ng-click="viewCustomerCtrl.issueStoreCredit()"\n          class="vd-btn vd-btn--do">\n          Issue Store Credit\n        </button>\n      </div>\n    </div>\n  </div>\n</vd-dialog>\n',customer:t,hideRemoveFromSale:s,hideViewSales:a,hideEditCustomer:i}).then(e=>e.closed.then(e=>{if(e&&e.action&&e.action in this)return Je(()=>this[e.action](e.customer))}))},issueStoreCredit:t=>e({controller:"IssueStoreCreditCtrl",controllerAs:"issueStoreCreditCtrl",template:'<vd-dialog size="\'medium\'"\n  header="{{issueStoreCreditCtrl.header}}"\n  close="issueStoreCreditCtrl.close"\n  class="wr-issue-store-credit-dialog">\n  <div class="vd-dialog-content">\n    <div class="vd-mb5">\n      <vd-header>{{issueStoreCreditCtrl.customer | wrCustomerName}}</vd-header>\n      <wr-customer-group customer="issueStoreCreditCtrl.customer" class="vd-text--sub"></wr-customer-group>\n    </div>\n\n    <form ng-if="!issueStoreCreditCtrl.storeCreditIssuedData"\n      name="issueStoreCreditCtrl.issueStoreCreditCtrlForm"\n      id="issueStoreCreditCtrlForm"\n      autocomplete="off">\n      <div class="vd-field">\n        <div class="vd-label">Store credit value</div>\n        <div class="vd-value">\n          <input ng-model="issueStoreCreditCtrl.storeCreditData.amount"\n            vd-number\n            vd-number-options="{ min: 0.01 }"\n            class="vd-input"\n            placeholder="0.00"\n            inputmode="decimal">\n        </div>\n      </div>\n      <div class="vd-field">\n        <div class="vd-label">Notes <span class="vd-text--sub vd-text--secondary">Required</span></div>\n        <div class="vd-value">\n          <textarea vd-textarea="{ max: 5 }"\n            vd-input-char-limit\n            ng-model="issueStoreCreditCtrl.storeCreditData.notes"\n            ng-required="true"\n            ng-maxlength="255">\n          </textarea>\n        </div>\n      </div>\n    </form>\n\n    <ul ng-if="issueStoreCreditCtrl.storeCreditIssuedData" class="wr-store-credit-summary">\n      <li class="wr-store-credit-summary-item">\n        <span>Store credit issued:</span>\n        <span>{{issueStoreCreditCtrl.storeCreditIssuedData.transaction.amount | vdCurrency}}</span>\n      </li>\n      <li ng-if="issueStoreCreditCtrl.storeCreditIssuedData.storeCredit" class="wr-store-credit-summary-item">\n        <span>Store credit balance:</span>\n        <wr-customer-store-credit-balance store-credit="issueStoreCreditCtrl.storeCreditIssuedData.storeCredit">\n        <wr-customer-store-credit-balance>\n      </li>\n    </ul>\n  </div>\n\n  <div class="vd-dialog-actions">\n    <div class="vd-btn-group">\n      <button ng-if="!issueStoreCreditCtrl.storeCreditIssuedData"\n        ng-click="issueStoreCreditCtrl.issueStoreCredit()"\n        form="issueStoreCreditCtrlForm"\n        ng-disabled="issueStoreCreditCtrl.issueStoreCreditCtrlForm.$invalid ||\n        issueStoreCreditCtrl.awaitingServerResponse"\n        class="vd-btn vd-btn--do">\n        Give Store Credit\n      </button>\n      <button ng-if="issueStoreCreditCtrl.storeCreditIssuedData" ng-click="issueStoreCreditCtrl.printReceipt()" class="vd-btn vd-btn--do">\n        Print Receipt\n      </button>\n    </div>\n  </div>\n</vd-dialog>\n',customer:t}),_openEditCustomer:(s={})=>We((a,i)=>{We.all([n.getCustomerGroups(),t.init()]).then(t=>e({controller:"EditCustomerCtrl",controllerAs:"editCustomerCtrl",template:'<vd-dialog header="{{editCustomerCtrl.isExistingCustomer ? \'Edit Customer\' : \'Create New Customer\'}}"\n  size="\'large\'"\n  close="editCustomerCtrl.close"\n  focus-first-element="false"\n  class="wr-edit-customer-dialog">\n  <vd-scrollable monobrow="true" goatee="true" class="vd-dialog-content">\n    <form name="editCustomerCtrl.editCustomerCtrlForm"\n      id="editCustomerCtrlForm"\n      autocomplete="off">\n      <wr-customer-form customer="editCustomerCtrl.customer"\n        form="editCustomerCtrl.editCustomerCtrlForm"\n        customer-groups="editCustomerCtrl.customerGroups">\n      </wr-customer-form>\n    </form>\n  </vd-scrollable>\n  <div class="vd-dialog-actions">\n    <button ng-click="editCustomerCtrl.confirmCustomerEdit()"\n      ng-disabled="editCustomerCtrl.editCustomerCtrlForm.$invalid || editCustomerCtrl.awaitingServerResponse"\n      form="editCustomerCtrlForm"\n      class="vd-btn vd-btn--do">\n      {{editCustomerCtrl.isExistingCustomer ? \'Save Changes\' : \'Create New Customer\'}}\n    </button>\n  </div>\n</vd-dialog>\n',customerGroups:t[0],customer:s.customer,query:s.query})).then(e=>{e.close.then(e=>{e?t.queueSaleCalculation().then(()=>a(e)):i()})})})}}]);const Yl={CONTEXTS:{DEFAULT:"DEFAULT",SWITCH_REGISTERS:"SWITCH_REGISTERS",TRAINING_MODE:"TRAINING_MODE",CLOSE_REGISTER:"CLOSE_REGISTER"},ACTION_CONFIRM_SALE:{CONTENT:{DEFAULT:"You have a sale on the Sell screen that hasn\u2019t been completed. You can choose to return to that sale\n        to complete it, or save that sale and continue with this one.",SWITCH_REGISTERS:"Before you can switch registers, you have to complete the sale on the Sell screen. You can\n        choose to save that sale and continue on to switch registers, or return to that sale to complete it.",TRAINING_MODE:"Before you can switch to Training Mode, you have to complete the sale on the Sell screen.\n        To keep the changes you\u2019ve made to it, return to that sale to complete it. Or you can choose to discard changes\n        made to that sale and switch to Training Mode.",CLOSE_REGISTER:"Before you can close your register, you have to complete the sale on the Sell screen.\n        You can choose to save that sale and continue to close your register, or return to that sale to complete it."}}};t.module("webregister.modals").factory("saleModals",["Modal","Confirm","wrSaleStatusFilter","saleSyncManager","retailerSettingsManager","userManager","vdTracking",function(e,t,n,s,a,i,r){return{get CONTEXTS(){return Yl.CONTEXTS},actionConfirmSale({saveSaleResolver:e,context:n}){const s=jt===et.current.name,a=Yl.ACTION_CONFIRM_SALE.CONTENT,i=a[n]||a.DEFAULT;return r.trackUserEvent({eventName:"Active Sale Confirmation",metadata:{action:"actionConfirmSale",context:n}}),t({header:"Hold up! You currently have a sale in progress",content:`<p class="vd-p">${i}</p>`,cancel:{isVisible:!1},confirm:[{label:"Return to Sale in Progress",category:"supplementary",resolve:s?We.resolve:this._navSellScreen},{label:"Save and Continue",resolve:e}]})},actionConfirmSaleWithGiftCard(){const e=jt===et.current.name;return r.trackUserEvent({eventName:"Active Sale Confirmation",metadata:{action:"actionConfirmSaleWithGiftCard"}}),t({header:"Hold up! You currently have a sale in progress, and it contains an unsold Gift Card.",content:'<p class="vd-p">You have a sale on the Sell screen that hasn\u2019t been completed. As a precaution,\n          unsold Gift Cards cannot be parked with a sale. Please return to the Sell screen to either complete that\n          sale or remove the Gift Card to park that sale.</p>',cancel:{isVisible:!1},confirm:[{label:"Return to Sale in Progress",resolve:e?We.resolve:this._navSellScreen}]})},actionConfirmSaleWithPayments(){const e=jt===et.current.name;return r.trackUserEvent({eventName:"Active Sale Confirmation",metadata:{action:"actionConfirmSaleWithPayments"}}),t({header:"Please complete your previous sale",content:'<p class="vd-p">You\u2019ve taken payments on your previous sale, so that sale must be completed, or put on\n          account or Layby.</p>',cancel:{isVisible:!1},confirm:[{label:"Return to Sale in Progress",resolve:e?We.resolve:this._navSellScreen}]})},actionAddNoteParkSale:(t,n,s)=>We((a,i)=>e({template:'<vd-dialog\n  header="Add a note to the sale"\n  close="$ctrl.close"\n  size="\'small\'"\n  ng-form\n  name="noteForm"\n>\n  <div class="vd-dialog-content">\n    <p class="vd-p">\n      You are about to {{$ctrl.isParkSale ? \'park\' : \'quote\'}} this sale. Add a note so it can be identified by the\n      {{$ctrl.isParkSale ? \'next person who continues\' : \'person who completes\'}} this sale.\n    </p>\n    <div class="vd-field">\n      <div class="vd-value">\n        <textarea\n          has-credit-card\n          name="saleNote"\n          vd-textarea="{ max: 5 }"\n          ng-model="$ctrl.note"\n          vd-focus\n        />\n        <has-cc-error-message ng-if="noteForm.saleNote.$error.hasCreditCard" />\n        <p class="vd-p vd-pt3 vd-text--sub vd-text--secondary">\n          Notes can be used to identify a sale in the future, and can contain\n          information that can help complete the sale.\n        </p>\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-dialog-actions vd-btn-group">\n    <button\n      class="vd-btn vd-btn--supplementary"\n      ng-click="$ctrl.addNoteAndParkSale(true)"\n      ng-disabled="noteForm.saleNote.$invalid || $ctrl.isReturn"\n      ng-if="!$ctrl.isParkSale"\n    >\n      Quote\n    </button>\n    <button\n      class="vd-btn vd-btn--supplementary"\n      ng-click="$ctrl.addNoteAndParkSale(false)"\n      ng-disabled="noteForm.saleNote.$invalid"\n      ng-if="$ctrl.isParkSale"\n    >\n      Park Sale\n    </button>\n  </div>\n</vd-dialog>\n',controller:"ActionAddNoteParkSaleController",controllerAs:"$ctrl",currentNote:t,isParkSale:n,isReturn:s}).then(e=>e.close).then(e=>{e?a(e):i()})),confirmContinuePartialPaidSale:()=>(r.trackUserEvent({eventName:"Active Sale Confirmation",metadata:{action:"confirmContinuePartialPaidSale"}}),t({header:"Continue sale with existing payments?",content:`<p class="vd-p">You\u2019ve already taken some payments for this sale. If you continue the sale, you\n          will not be able to park the sale again.</p>\n          <p class="vd-p">You must:</p>\n          <ul class="wr-bulleted-list">\n            <li>Complete the sale by taking full payment.</li>\n            <li>Change the sale to an ${n(qn.ACCOUNT_SALE)} or\n              ${n(qn.LAYBY_SALE)} sale.\n            </li>\n          </ul>`,confirm:{label:"Continue sale",category:"no"}})),warnThatOutletsDiffer:({saleStatus:t,saleOutletName:n})=>e({template:'<vd-dialog close="$ctrl.close">\n  <header class="vd-dialog-header">\n    <vd-header category="dialog">\n      <vd-icon icon="fa-warning fa-lg" class="vd-colour-no"></vd-icon>\n      You can only continue {{::$ctrl.displaySaleStatus}} sales that were created at this outlet.\n    </vd-header>\n  </header>\n  <div class="vd-dialog-content">\n    <p class="vd-p">\n      This {{::$ctrl.displaySaleStatus}} sale was created at outlet \u201c{{::$ctrl.outletName}}\u201d. Continuing\n      {{::$ctrl.displaySaleStatus}} sales that were created in another outlet can cause discrepancies with your\n      inventory levels.\n    </p>\n  </div>\n\n  <div class="vd-dialog-actions">\n    <button class="vd-btn vd-btn--do" ng-click="$ctrl.close()">\n      Got it, thanks\n    </button>\n  </div>\n</vd-dialog>\n',controller:"OutletsDifferModalController",controllerAs:"$ctrl",saleOutletName:n,saleStatus:t}).then(e=>e.close).then(()=>We.reject()),dismissSale(e){const n={[qn.LAYBY_SALE]:"Layby",[qn.ACCOUNT_SALE]:"Account"};return t({header:"What would you like to do with this sale?",content:`<p class="vd-p" vd-no-widow>You haven't completed this sale and are about to lose the changes you've\n          made. To keep those changes, continue the sale to accept payment or put it back on\n          ${n[e]}.</p>`,cancel:"Continue Sale",confirm:"Discard Changes"})},downloadErroredSales(e){const n=Ye.trustAsHtml(`\n        <a href="${e}"\n          download="errored-sales.json"\n          target="_blank"\n          class="vd-btn vd-btn--do vd-mt1 vd-mb1">\n          Download Errored Sales\n        </a>`);t({header:"Download Errored Sales",content:`\n          <p class="vd-p">\n            You can download your errored sales and\n            <a href="${_n.CONTACT_SUPPORT_URL}" target="_blank" class="vd-link">\n            send it to our Support team\n            </a>. This will help us to resolve the problem as quickly as possible.\n          </p>\n          <div class="vd-align-right">${n}</div>\n        `,cancel:{isVisible:!1},confirm:{isVisible:!1}})},viewErroredSales(){const e=a.get(),t={clientVersion:_n.CLIENT_VERSION,domainPrefix:e.domain_prefix,retailerId:e.id,userId:i.getLoggedInUser().id};return We.all({erroredSales:s.getErroredSales(),erroredSalesFileUrl:s.generateErroredSalesFile(t)}).then(({erroredSales:e,erroredSalesFileUrl:t})=>this._erroredSalesModal(e,t)).then(e=>e.closed).then(()=>s.clearErroredSalesFile())},_erroredSalesModal:(t,n)=>e({template:'<vd-dialog close="$ctrl.close" size="\'large\'">\n  <header class="vd-dialog-header">\n    <vd-header category="dialog">\n      <vd-icon icon="fa-warning fa-lg" class="vd-colour-no"></vd-icon>\n      You have {{$ctrl.saleSyncManager.erroredSalesCount}} errored\n      <ng-pluralize count="$ctrl.saleSyncManager.erroredSalesCount" when="{\'one\': \'sale\',\'other\': \'sales\'}"></ng-pluralize>\n    </vd-header>\n  </header>\n  <div class="vd-dialog-content">\n    <p class="vd-p">\n      We\u2019ve had a problem trying to sync {{$ctrl.saleSyncManager.erroredSalesCount}} of your sales to our servers.\n      <ng-pluralize count="$ctrl.saleSyncManager.erroredSalesCount"\n        when="{\n          \'one\': \'This sale has been temporarily saved in your browser, so it\u2019s important not to clear your browser\n            cache or your sale\',\n          \'other\': \'These sales have been temporarily saved in your browser, so it\u2019s important not to clear your\n            browser cache or your sales\'\n        }">\n      </ng-pluralize>\n      will be deleted and cannot be recovered.\n    </p>\n\n    <p class="vd-p">\n      We\'ve compiled information\n      <ng-pluralize count="$ctrl.saleSyncManager.erroredSalesCount"\n        when="{\n          \'one\': \'about this errored sale, please download it\',\n          \'other\': \'about these errored sales, please download them\'\n        }">\n      </ng-pluralize>\n      and send it our support team. This will help us resolve this as fast as possible.\n    </p>\n\n    <table class="vd-table vd-table--fixed">\n      <thead>\n        <th class="vd-sml-pad-h vd-pl0" width="20%">Date</th>\n        <th class="vd-sml-pad-h">Receipt</th>\n        <th class="vd-sml-pad-h">Sold By</th>\n        <th class="vd-sml-pad-h">Customer</th>\n        <th class="vd-sml-pad-h">Status</th>\n        <th class="vd-sml-pad-h vd-pr0 vd-align-right">Total</th>\n      </thead>\n      <tbody>\n        <tr ng-repeat="sale in $ctrl.erroredSales | orderBy: \'-saleDate\' track by $index">\n          <td class="vd-sml-pad-h vd-pl0 vd-truncate">\n            {{::sale.saleDate | wrDateFormat:\'MMM D, YYYY\':webRegisterCtrl.outlet.time_zone}}\n            <span class="vd-text--secondary">\n              {{::sale.saleDate | wrDateFormat:\'HH:mm\':webRegisterCtrl.outlet.time_zone}}\n            </span>\n          </td>\n          <td class="vd-sml-pad-h">{{::sale.getFormattedReceiptNumberDetails() || \'-\'}}</td>\n          <td class="vd-sml-pad-h vd-truncate">{{::(sale.user | wrUserName) || \'\u2013\'}}</td>\n          <td class="vd-sml-pad-h vd-truncate">{{::(sale.customer | wrCustomerName) || \'\u2013\'}}</td>\n          <td class="vd-sml-pad-h">{{::sale | wrSaleStatus}}</td>\n          <td class="vd-sml-pad-h vd-pr0 vd-align-right">\n            {{::sale.finals.inclusivePrice | vdCurrency}}\n          </td>\n        </tr>\n      </tbody>\n    </table>\n  </div>\n  <div class="vd-dialog-actions">\n    <div class="vd-btn-group pro-download-sales">\n      <span ng-bind-html="$ctrl.erroredSalesButton"></span>\n      <a class="vd-btn vd-btn--no" ng-href="{{$ctrl.contactSupportUrl}}" target="_blank">\n        Contact Support\n      </a>\n    </div>\n  </div>\n</vd-dialog>\n',controller:"ErroredSalesModalController",controllerAs:"$ctrl",erroredSales:t,erroredSalesFileUrl:n}),_navSellScreen:()=>et.go(jt)}}]),t.module("webregister.modals").factory("trainingModeModals",["Confirm",function(e){return{confirmTrainingMode:()=>(et.includes(jt)?We.resolve():et.go(jt)).then(()=>e({header:"You\u2019re now in training mode",content:'<p class="vd-p" vd-no-widow>Sales and payments you make in training mode will not be recorded. Feel\n            free to try out all the features.</p>',cancel:{isVisible:!1},confirm:"Got it"})),exitTrainingModeConfirmation:()=>e({header:"Exit Training Mode?",content:'<p class="vd-p">Once you\'ve left training mode, any sales and payments you make from now on will\n          be recorded.</p>\n          <p class="vd-p" vd-no-widow>To do more training later, click \'Enable training mode\' in the Register\n          settings menu.</p>',cancel:"Continue training",confirm:"Exit training"})}}]);var zl='<vd-dialog close="$ctrl.close"\n  dismissible="$ctrl.dismissible"\n  size="$ctrl.giftCardTransactions.length ? \'large\' : \'medium\'"\n  class="pro-gift-cards">\n  <div ng-include="$ctrl.getTemplate()" class="wr-partial-dialog-content"></div>\n</vd-dialog>\n',Jl='<header class="vd-dialog-header">\n  <vd-header category="dialog">\n    {{$ctrl.getSearchModalTitle()}}\n  </vd-header>\n</header>\n\n<div class="vd-dialog-content">\n  <p class="vd-p">\n    {{$ctrl.getSearchModalText()}}\n  </p>\n  <form name="giftCardsVerifyForm" id="giftCardsVerifyForm" novalidate>\n    <div class="vd-field">\n      <div class="vd-label">\n        {{::$ctrl.providerSettings.terms.giftCardCode | vdTitleCase}}\n      </div>\n      <div class="vd-value">\n        <input ng-model="$ctrl.giftCard.code"\n          ng-pattern="$ctrl.giftCardCodeRegex"\n          ng-trim="false"\n          vd-focus="{ focusDelay: 50 }"\n          class="vd-input"\n          autocomplete="off"\n          spellcheck="false"\n          maxlength="{{::$ctrl.giftCardCodeMaxChars}}"\n          placeholder="Enter {{::$ctrl.providerSettings.terms.giftCardCode}}"\n          required>\n        <i ng-if="$ctrl.waiting" class="vd-loader vd-loader--small vd-loader--input"></i>\n      </div>\n      <ng-messages class="wr-input-messages vd-text-supplementary vd-mt3" for="giftCardsVerifyForm.$error">\n        <ng-message when="pattern">\n          Your {{::$ctrl.providerSettings.terms.giftCardCode}} needs to be letters, numbers or dashes only.\n        </ng-message>\n      </ng-messages>\n    </div>\n  </form>\n</div>\n\n<div class="vd-dialog-actions">\n  <div ng-if="!$ctrl.waiting" class="vd-btn-group">\n    <button ng-click="$ctrl.retrieveGiftCard()"\n      ng-disabled="giftCardsVerifyForm.$invalid"\n      form="giftCardsVerifyForm"\n      type="submit"\n      class="vd-btn vd-btn--do">\n        Find {{::$ctrl.providerSettings.terms.giftCard | vdTitleCase}}\n    </button>\n  </div>\n  <div ng-show="$ctrl.waiting" class="vd-text--secondary">\n    Finding  {{::$ctrl.providerSettings.terms.giftCard}}...\n  </div>\n</div>\n';const Xl="SELLING",Zl="REDEEMING",ec="SET_VALUE",tc="VIEW_DETAILS",nc="ADD_BALANCE",sc={SELLING:Jl,REDEEMING:Jl,VIEW_DETAILS:'<header class="vd-dialog-header vd-dialog-header--center">\n  <vd-header category="dialog">\n    <div class="gift-cards-details-header">\n      {{::$ctrl.providerSettings.terms.giftCard | vdTitleCase}}\n      <span class="vd-ml1">{{::$ctrl.giftCard.code}}</span>\n      <span ng-if="$ctrl.giftCard.status !== \'ACTIVE\'" class="vd-ml1 vd-flag vd-flag--secondary">\n        {{::$ctrl.giftCard.status}}\n      </span>\n    </div>\n  </vd-header>\n\n  <div class="vd-dialog-header-meta" ng-if="$ctrl.providerSettings.recordsTransactions">\n    Last used {{$ctrl.giftCardTransactions[$ctrl.giftCardTransactions.length-1].created_at | vdDateFromNow }}\n  </div>\n\n  <div ng-if="!$ctrl.isSellingWorkflow()">\n    <div ng-if="$ctrl.hasBalance() && !$ctrl.isBalanceSufficient()" class="wr-input-messages">\n      This {{::$ctrl.providerSettings.terms.card}} has insufficient funds to complete the sale. You may still use this {{::$ctrl.providerSettings.terms.giftCard}} to make a partial payment.\n    </div>\n\n    <div ng-if="!$ctrl.hasBalance()"\n      ng-switch="$ctrl.giftCard.status"\n      class="wr-input-messages gift-cards-details-header-error">\n      This {{::$ctrl.providerSettings.terms.card}} has\n      <span ng-switch-when="REDEEMED">been fully redeemed</span>\n      <span ng-switch-when="VOIDED">been cancelled</span>\n      <span ng-switch-when="EXPIRED">expired</span>\n      <span ng-switch-default>no funds</span>\n      and cannot be used.\n    </div>\n  </div>\n\n  <hr class="vd-dialog-header-divider">\n</header>\n\n<div class="vd-dialog-content">\n  <ul class="wr-info-fields wr-info-fields--large wr-info-fields--center vd-mb5">\n    <li wr-info-field\n      label="\'Balance\'"\n      value="::$ctrl.giftCard.balance | vdCurrency">\n    </li>\n    <li ng-if="$ctrl.shouldShowGiftCardExpiry()"\n      wr-info-field\n      label="\'Expiry Date\'"\n      value="::$ctrl.getGiftCardExpiryDate()">\n    </li>\n  </ul>\n\n  <table class="vd-table vd-table-fixed" ng-if="$ctrl.providerSettings.recordsTransactions">\n    <thead>\n      <th class="vd-sml-pad-h vd-pl0">Date</th>\n      <th class="vd-sml-pad-h wr-hide-on-mobile">User</th>\n      <th class="vd-sml-pad-h">Status</th>\n      <th class="vd-sml-pad-h vd-align-right">Total</th>\n      <th class="vd-sml-pad-h vd-pr0 wr-hide-on-mobile vd-align-right">Balance</th>\n    </thead>\n    <tbody>\n      <tr ng-repeat="transaction in $ctrl.giftCardTransactions | orderBy: \'-created_at\' track by transaction.id">\n        <td class="vd-pl0 vd-sml-pad-h">\n          {{transaction.created_at | wrDateFormat:\'MMM DD, YYYY\':$ctrl.outlet.time_zone}}\n          <span class="vd-text--secondary">\n            {{transaction.created_at | wrDateFormat:\'HH:mm\':$ctrl.outlet.time_zone}}\n          </span>\n        </td>\n        <td class="vd-sml-pad-h wr-hide-on-mobile">{{(transaction.user | wrUserName) || \'-\'}}</td>\n        <td class="vd-sml-pad-h">{{transaction.type | wrGiftCardTransactionStatus}}</td>\n        <td class="vd-sml-pad-h vd-align-right">{{transaction.amount | displayRound}}</td>\n        <td class="vd-sml-pad-h vd-pr0 wr-hide-on-mobile vd-align-right">{{transaction.balance | displayRound}}</td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n\n<div ng-if="$ctrl.isSellingWorkflow()" class="vd-dialog-actions">\n  <div class="vd-btn-group">\n    <button ng-click="$ctrl.resetStateAndGiftCard()" type="button" class="vd-btn vd-btn--supplementary">\n      Find a Different {{::$ctrl.providerSettings.terms.giftCard | vdTitleCase}}\n    </button>\n    <button ng-click="$ctrl.addBalance()" type="button" class="vd-btn vd-btn--do">\n      Add Funds to {{::$ctrl.providerSettings.terms.giftCard | vdTitleCase}}\n    </button>\n  </div>\n</div>\n\n<div ng-if="!$ctrl.isSellingWorkflow()" class="vd-dialog-actions">\n  <div ng-if="!$ctrl.waiting" class="vd-btn-group">\n    <button ng-click="$ctrl.resetStateAndGiftCard()" type="button" class="vd-btn vd-btn--supplementary">\n      Find a Different {{::$ctrl.providerSettings.terms.giftCard | vdTitleCase}}\n    </button>\n    <button ng-if="$ctrl.hasBalance()"\n      ng-click="$ctrl.payWithGiftCard()"\n      type="submit"\n      class="vd-btn vd-btn--do">\n      {{$ctrl.isBalanceSufficient() ? \'Pay with \' + $ctrl.providerSettings.terms.giftCard : \'Make partial payment\'}}\n    </button>\n  </div>\n  <div ng-show="$ctrl.waiting" class="gift-cards-loading-text">\n    Paying with {{::$ctrl.providerSettings.terms.giftCard}}\u2026\n  </div>\n</div>\n',SET_VALUE:'<header class="vd-dialog-header">\n  <vd-header category="dialog">\n    Add New {{::$ctrl.providerSettings.terms.giftCard | vdTitleCase}} to Sale\n  </vd-header>\n</header>\n\n<div class="vd-dialog-content">\n  <p class="vd-p">\n    This {{::$ctrl.providerSettings.terms.giftCard}} is not active and has no balance. Enter a value to load a balance, then complete the sale to\n    activate this {{::$ctrl.providerSettings.terms.card}}.\n  </p>\n  <form id="giftCardsValueForm" name="giftCardsValueForm" novalidate>\n    <ul class="wr-info-fields wr-info-fields--large wr-info-fields--block vd-mb5">\n      <li class="wr-info-field">\n        <div class="wr-info-field-label">\n          {{::$ctrl.providerSettings.terms.giftCardCode | ucFirst}}\n        </div>\n        <div class="wr-info-field-value wr-gift-cards-number-number-status">\n          <span class="wr-gift-cards-number">{{::$ctrl.giftCard.code}}</span>\n          <span class="vd-flag vd-flag--secondary vd-ml3 wr-gift-cards-number-status">Inactive</span>\n        </div>\n      </li>\n      <li ng-if="$ctrl.shouldShowGiftCardExpiry()"\n        wr-info-field\n        label="\'Expiry Date\'"\n        value="::$ctrl.getGiftCardExpiryDate()">\n      </li>\n    </ul>\n\n    <div class="vd-field">\n      <div class="vd-label">{{::$ctrl.providerSettings.terms.giftCard | ucFirst}} value</div>\n      <div class="vd-value">\n        <input name="giftCardValue"\n          ng-model="$ctrl.giftCard.value"\n          vd-focus="{ focusDelay: 50 }"\n          vd-number\n          vd-number-options="$ctrl.valueInputOptions"\n          class="vd-input"\n          placeholder="0.00"\n          vd-input-symbol="{align: \'left\', symbol: \'{{$ctrl.outlet.currency_symbol}}\'}"\n          required\n          autocomplete="off"\n          inputmode="decimal">\n        <ng-messages class="wr-input-messages vd-text-supplementary vd-mt3" for="giftCardsValueForm.$error">\n          <ng-message ng-if="giftCardsValueForm.giftCardValue.$dirty" when="validMinValue">\n            Please enter a number above {{::$ctrl.outlet.currency_symbol}}0.\n          </ng-message>\n        </ng-messages>\n      </div>\n    </div>\n  </form>\n</div>\n<div class="vd-dialog-actions">\n  <div ng-if="!$ctrl.waiting" class="vd-btn-group">\n    <button ng-click="$ctrl.close()" class="vd-btn vd-btn--supplementary">\n      Cancel\n    </button>\n    <button ng-click="$ctrl.close($ctrl.giftCard)"\n      form="giftCardsValueForm"\n      ng-disabled="giftCardsValueForm.$invalid"\n      type="submit"\n      class="vd-btn vd-btn--do">\n      Add to sale\n    </button>\n  </div>\n  <div ng-show="$ctrl.waiting" class="vd-text--secondary">\n    Paying with {{::$ctrl.providerSettings.terms.giftCard}}\u2026\n  </div>\n</div>\n',ADD_BALANCE:'<header class="vd-dialog-header">\n  <vd-header category="dialog">\n    Add funds to {{::$ctrl.providerSettings.terms.giftCard}}.\n  </vd-header>\n</header>\n\n<div class="vd-dialog-content">\n  <p class="vd-p">\n    This {{::$ctrl.providerSettings.terms.giftCard}} is active and has a balance. Enter a value to add to the balance, then complete the sale to\n    add funds to this {{::$ctrl.providerSettings.terms.card}}.\n  </p>\n  <form id="giftCardsValueForm" name="giftCardsValueForm" novalidate>\n    <div class=""></div>\n    <div class="vd-field">\n      <ul class="wr-info-fields wr-info-fields--large vd-mb5">\n        <li wr-info-field\n          label="$ctrl.providerSettings.terms.giftCardCode | ucFirst"\n          value="::$ctrl.giftCard.code">\n        </li>\n        <li ng-if="$ctrl.shouldShowGiftCardExpiry()"\n          wr-info-field\n          label="\'Expiry Date\'"\n          value="::$ctrl.getGiftCardExpiryDate()">\n        </li>\n      </ul>\n      <div vd-flex vd-flex-justify="center">\n        <div class="vd-field">\n          <ul class="wr-info-fields wr-info-fields--large">\n            <li wr-info-field\n              label="\'Current balance\'"\n              value="::$ctrl.giftCard.balance | vdCurrency">\n            </li>\n            <div class="wr-info-field">\n                <div class="vd-label">Amount to Add</div>\n                  <div class="vd-value">\n                    <input name="giftCardValue"\n                      ng-model="$ctrl.reloadBalance"\n                      ng-keyup="$ctrl.updatePotentialBalance()"\n                      vd-focus="{ focusDelay: 50 }"\n                      vd-number\n                      vd-number-options="$ctrl.valueInputOptions"\n                      class="vd-input"\n                      placeholder="0.00"\n                      vd-input-symbol="{align: \'left\', symbol: \'{{$ctrl.outlet.currency_symbol}}\'}"\n                      required\n                      autocomplete="off"\n                      inputmode="decimal">\n                    <ng-messages class="wr-input-messages vd-text-supplementary vd-mt3" for="giftCardsValueForm.$error">\n                      <ng-message ng-if="giftCardsValueForm.giftCardValue.$dirty" when="validMinValue">\n                        Please enter a number above {{::$ctrl.outlet.currency_symbol}}0.\n                      </ng-message>\n                    </ng-messages>\n                  </div>\n                <div ng-if="$ctrl.potentialBalance" class="vd-text-supplementary">\n                  New Balance: {{$ctrl.potentialBalance | vdCurrency}}\n                </div>\n              </div>\n            </div>\n          </ul>\n        </div>\n      </div>\n    </div>\n  </form>\n</div>\n<div class="vd-dialog-actions">\n  <div ng-if="!$ctrl.waiting" class="vd-btn-group">\n    <button ng-click="$ctrl.addGiftCardReloadToSale()"\n      form="giftCardsValueForm"\n      ng-disabled="giftCardsValueForm.$invalid"\n      type="submit"\n      class="vd-btn vd-btn--do">\n      Add to sale\n    </button>\n  </div>\n  <div ng-show="$ctrl.waiting" class="vd-text--secondary">\n    Paying with {{::$ctrl.providerSettings.terms.giftCard}}\u2026\n  </div>\n</div>\n'},ac=e=>["Modal","vdToastNotificationService","webRegisterStatusManager","trainingModeManager",(t,n,s,a)=>({sellGiftCard(){return this._canSellGiftCards().then(()=>t({template:zl,controller:e,controllerAs:"$ctrl",workflow:Xl})).then(e=>this._handleModalClose(e))},redeemGiftCard(n){return t({template:zl,controller:e,controllerAs:"$ctrl",workflow:Zl,amount:n}).then(e=>this._handleModalClose(e))},_handleModalClose:e=>e.closed.then(e=>e||We.reject()),_canSellGiftCards:()=>We((e,t)=>a.trainingModeEnabled?(n.negative({message:"Gift cards can not be sold when the Sell screen is in training mode."}),t()):s.isOnline()?e():(n.negative({message:"Gift cards can not be sold when the Sell screen is offline."}),t()))})];t.module("webregister.modals").factory("balancesGiftCardsModal",ac("BalancesGiftCardsController")),t.module("webregister.modals").factory("bigcommerceGiftCertsModal",ac("BigCommerceGiftCertsController"));t.module("webregister.modals").factory("cashManagementModals",["Modal",function(e){return{openRegisterSetFloat:()=>We((t,n)=>e({template:'<vd-dialog header="Set Opening Cash Drawer Amount" close="$ctrl.close" dismissible="!$ctrl.awaitingServerResponse">\n  <div class="vd-dialog-content">\n    <set-cash-float-form form="$ctrl.openRegisterSetFloatForm"\n      form-id="open-register-set-float-form"\n      on-submit="$ctrl.openRegisterAndSetFloat($event.cashFloatSettings)"\n      loading="$ctrl.awaitingServerResponse">\n    </set-cash-float-form>\n  </div>\n\n  <div class="vd-dialog-actions vd-btn-group vd-align-center" vd-flex vd-flex-justify="end">\n    <span ng-if="$ctrl.awaitingServerResponse" class="vd-loader"></span>\n    <button ng-click="$ctrl.cancelOpenRegisterAndSetFloat()"\n      ng-disabled="$ctrl.awaitingServerResponse"\n      class="vd-btn vd-btn--supplementary vd-ml3">\n      {{$ctrl.cashMovementRequestFailed ? \'Skip\' : \'Cancel\'}}\n    </button>\n    <button type="submit"\n      class="vd-btn vd-btn--do"\n      form="open-register-set-float-form"\n      ng-disabled="$ctrl.openRegisterSetFloatForm.$invalid || $ctrl.awaitingServerResponse">\n      {{$ctrl.cashMovementRequestFailed ? \'Retry\' : \'Save Amount\'}}\n    </button>\n  </div>\n</vd-dialog>\n',controller:"SetCashFloatController",controllerAs:"$ctrl"}).then(e=>e.closed).then(e=>e?t(e):n(),n)),recordCashMovement:t=>We((n,s)=>e({template:'<vd-dialog header="{{::$ctrl.displayCashMovementType}} Cash"\n  close="$ctrl.close"\n  dismissible="!$ctrl.awaitingServerResponse">\n  <div class="vd-dialog-content">\n    <form name="$ctrl.cashMovementForm" id="cash-movement-form">\n      <div class="vd-field">\n        <div class="vd-value">\n          <vd-radio-group ng-model="$ctrl.cashMovement.type">\n            <vd-radio ng-repeat="cashType in ::$ctrl.availableCashTypes"\n              value="cashType"\n              label="{{cashType}}">\n            </vd-radio>\n          </vd-radio-group>\n        </div>\n      </div>\n\n      <div class="vd-field">\n        <div class="vd-label">Amount</div>\n        <div class="vd-value">\n          <input class="vd-input"\n            ng-model="$ctrl.cashMovement.amount"\n            placeholder="e.g, 50.00"\n            required\n            vd-number\n            vd-number-options="$ctrl.vendNumberOptions"\n            inputmode="decimal">\n        </div>\n      </div>\n\n      <div class="vd-field">\n        <div class="vd-label">Note</div>\n        <div class="vd-value">\n          <textarea vd-textarea="{ max: 3 }"\n            vd-input-char-limit\n            ng-model="$ctrl.cashMovement.note"\n            ng-maxlength="255"\n            placeholder="Type to add a note">\n          </textarea>\n        </div>\n      </div>\n    </form>\n  </div>\n\n  <div class="vd-dialog-actions">\n    <button type="submit"\n      form="cash-movement-form"\n      ng-class="[\'vd-btn\', $ctrl.displayCashMovementType === \'Remove\' ? \'vd-btn--no\' : \'vd-btn--do\']"\n      ng-click="$ctrl.recordCashMovement()"\n      ng-disabled="$ctrl.cashMovementForm.$invalid || $ctrl.awaitingServerResponse">\n      {{::$ctrl.displayCashMovementType}} Cash\n      <span class="vd-loader vd-loader--small" ng-if="$ctrl.awaitingServerResponse"></span>\n    </button>\n  </div>\n</vd-dialog>\n',controller:"CashMovementController",controllerAs:"$ctrl",cashMovementType:t}).then(e=>e.closed).then(e=>e?n(e):s(),s))}}]),t.module("webregister.factories").provider("wrDebugTools",(function(){this.getEnableDebugLoggingPrefix=function(){return"WR_ENABLE_DEBUG_LOGGING!"};const e=[];return this.register=function(t){e.push(t)},this.$get=function(){const n={reloadWithDebugInfo(){Xe.name="WR_ENABLE_DEBUG_LOGGING!"+Xe.name,t.reloadWithDebugInfo()},get:t=>D(e,t)?(console.warn("This tooling is strictly for use by Vend engineers, use at your own risk."),Ge.get(t)):(console.error(t+" either doesn't exist or is not accessible via the browser console."),null),logUnsyncedSales(){Ge.get("salesStore").getUnsyncedSales().then(e=>console.log(e)).catch(e=>console.error("Error occurred listing unsynced sales",e))},versions:()=>({CLIENT_VERSION:_n.CLIENT_VERSION,SALE_VERSION:12}),logSalesByReceiptNumber(e){const t=[];this.get("Database").store("sales").cursor({iterator:function(n){const s=n.value;return s.receiptNumberDetails&&s.receiptNumberDetails.number===e&&t.push(s),!0}}).catch(t=>{console.error("Error occurred searching for sales with receipt #"+e,t)}).finally(()=>{console.log(`${t.length} sales found with receipt #${e}`),t.length&&console.log(t)})},exportSaleAsJson(e){Ge.get("salesStore").loadSaleJson(e).then(e=>console.log(JSON.stringify(e)))}};return Xe.__wrDebugTools=n,{register(t){e.push(t)}}},this}));class ic{constructor({name:e,types:t,search:n,whenSyncComplete:a,vdTracking:i}){s(this,"_search",void 0),s(this,"_whenSyncComplete",void 0),s(this,"_whenSynced",void 0),s(this,"name",void 0),s(this,"types",void 0),s(this,"vdTracking",void 0),this.name=e,this.types=t,this._search=n,this._whenSyncComplete=a||function(){},this.vdTracking=i}init(){return We.resolve(this)}whenSyncComplete(){return this._whenSynced||(this._whenSynced=We.resolve(this._whenSyncComplete()).then(()=>this)),this._whenSynced}search(e){return We(t=>{let n=!1;const s=Je(()=>{this.vdTracking.trackUserEvent({eventName:"Search Query Timeout",metadata:{query:e,searchSource:this.name,timeout:1e4}}),a()},1e4);function a(e=[]){n||(n=!0,Je.cancel(s),t(e))}We.resolve(this._search(e)).then(e=>a(e),t=>{this.vdTracking.trackError("[Autocomplete] Error searching "+this.name,{data:{error:t,query:e}}),a()})})}}function rc(e,t,n){return{create({name:s,entityName:a,entityStoreName:i,databaseIndexName:r,filterResultsBy:o}){const l=e.store(i).index(r);return new ic({name:s,types:[a],whenSyncComplete:()=>t.whenCompleteEntityDataAvailable(i),search:e=>l.getAll(e).then(e=>F(e,o)).then(e=>p(e,e=>({id:e.id,type:a,exactMatch:!0,[a]:e}))),vdTracking:n})}}}t.module("webregister.factories").factory("customerCodeIndex",["ExactMatchIndex",function(e){return e.create({name:"customerCodeIndex",entityName:"customer",entityStoreName:"customers",databaseIndexName:"byCustomerCode"})}]),rc.$inject=["Database","syncManager","vdTracking"],t.module("webregister.factories").factory("ExactMatchIndex",rc);function oc(e){const t=Boolean(e.active),n=Boolean(e.deleted_at),s="SYSTEM"===e.source;return t&&!n&&!s}function lc(e){return Boolean(e.variant_parent_id)}function cc(e){return oc(e)&&!lc(e)}void 0!==t&&t.module("webregister.factories").factory("productIndexUtil",(function(){return{isProductActive:oc,isProductVariant:lc,shouldUpdateProductInSearchIndex:cc}})),t.module("webregister.factories").factory("productSkuIndex",["ExactMatchIndex","productIndexUtil",function(e,t){return e.create({name:"productSkuIndex",entityName:"product",entityStoreName:"products",databaseIndexName:"byProductCode",filterResultsBy:t.isProductActive})}]),t.module("webregister.factories").factory("typeySearchSource",["vdTracking",function(e){return new ic({name:"typeySearchSource",types:["product","customer"],search:function(e){const t={q:e};return Ke.get("/api/2.0/suggest?type=product&type=customer",{params:t}).then(e=>e.data.data||[])},vdTracking:e})}]);class dc{constructor(e){s(this,"localId",void 0),s(this,"id",void 0),s(this,"registerId",void 0),s(this,"paymentType",void 0),s(this,"amount",void 0),s(this,"tipAmount",void 0),s(this,"paymentDate",void 0),s(this,"source",void 0),s(this,"sourceId",void 0),s(this,"external_transaction_id",void 0),s(this,"merchantId",void 0),s(this,"referenceId",void 0),s(this,"authCode",void 0),s(this,"signatureURL",void 0),s(this,"signatureBase64",void 0),s(this,"transactionStatus",void 0),s(this,"card",void 0),s(this,"emv",void 0),s(this,"terminal",void 0),s(this,"providerFields",void 0),s(this,"retrieved",void 0),this.localId=e.localId||se(),this.id=e.id,this.registerId=e.registerId,this.paymentType=e.paymentType,this.amount=e.amount,this.tipAmount=e.tipAmount,this.paymentDate=e.paymentDate,this.source=e.source,this.sourceId=e.sourceId,this.external_transaction_id=e.external_transaction_id,this.merchantId=e.merchantId,this.referenceId=e.referenceId,this.authCode=e.authCode,this.signatureURL=e.signatureURL,this.signatureBase64=e.signatureBase64,this.transactionStatus=e.transactionStatus,this.card=e.card,this.emv=e.emv,this.terminal=e.terminal,this.retrieved=e.retrieved||!1}toJSON(){const e=r({},this);return r(r({},ye(e,"paymentType")),{},{payment_type_id:e.paymentType.id})}shouldHide(){return gs.indexOf(this.paymentType.type_id)>=0}isForeignCurrency(){return hs.CURRENCY===this.paymentType.type_id}isAfterPay(){return hs.AFTER_PAY===this.paymentType.type_id}isExternalPayment(){return void 0!==this.external_transaction_id}}dc.$inject=["data"];const uc={type:"NON_CASH_FEE",name:"Non-cash Fee",target_type:"LINE_ITEM",target_method:"PROPORTIONED",value_type:"FIXED"},hc={type:"TIP",name:"Tip",target_type:"SALE",target_method:"SINGLE",value_type:"FIXED"};class mc extends Pl{constructor(e){super(e),s(this,"version",12),s(this,"completedByUser",void 0),s(this,"promoCode",void 0),s(this,"promoCodeStatus",void 0),s(this,"promoCodePromotionId",void 0),s(this,"potentialPromotionId",void 0),s(this,"localId",void 0),s(this,"id",void 0),s(this,"returnFor",void 0),s(this,"originalSalePayments",void 0),s(this,"lineItems",void 0),s(this,"unknownLineItems",void 0),s(this,"hideAttachCustomerTooltip",void 0),s(this,"note",void 0),s(this,"receiptEmailAddress",void 0),s(this,"receiptID",void 0),s(this,"payments",void 0),s(this,"customer",void 0),s(this,"giftCards",void 0),s(this,"customerBalances",void 0),s(this,"shortCode",void 0),s(this,"saleDate",void 0),s(this,"status",void 0),s(this,"fulfillmentOutletID",void 0),s(this,"readyToComplete",void 0),s(this,"registerId",void 0),s(this,"user",void 0),s(this,"receiptNumberDetails",void 0),s(this,"displayDiscount",void 0),s(this,"discountPercentage",void 0),s(this,"discountIsPercentage",void 0),s(this,"returnDiscountPercentage",void 0),s(this,"discount",void 0),s(this,"originalReturnTotals",void 0),s(this,"originalConfirmedTotals",void 0),s(this,"change",void 0),s(this,"userRemovedSaleServiceFee",void 0),s(this,"paidBalance",void 0),s(this,"totals",void 0),s(this,"finals",void 0),s(this,"syncStatus",void 0),s(this,"syncAttempts",void 0),s(this,"displayStatus",void 0),s(this,"pickable",void 0),e=e||{},this.completedByUser=e.completedByUser,this.promoCode=e.promoCode||"",this.promoCodeStatus=e.promoCodeStatus||null,this.promoCodePromotionId=e.promoCodePromotionId||null,this.localId=e.localId||se(),this.id=e.id,this.returnFor=e.returnFor||null,this.originalSalePayments=e.originalSalePayments||[],this.lineItems=e.lineItems||[],this.unknownLineItems=e.unknownLineItems||[],this.hideAttachCustomerTooltip=e.hideAttachCustomerTooltip||!1,this.note=e.note||"",this.receiptEmailAddress=e.receiptEmailAddress||"",this.receiptID=e.receiptID||"",this.paidBalance=e.paidBalance||null,this.payments=e.payments||[],this.customer=e.customer||null,this.giftCards=e.giftCards||[],this.customerBalances=null,this.shortCode=e.shortCode,this.saleDate=e.saleDate,this.status=e.status,this.fulfillmentOutletID=e.fulfillmentOutletID||null,this.readyToComplete=e.readyToComplete||!1,this.registerId=e.registerId,this.user=e.user,this.receiptNumberDetails=e.receiptNumberDetails,this.displayDiscount=e.displayDiscount||"0",this.discountPercentage=e.discountPercentage||0,this.discountIsPercentage="boolean"==typeof e.discountIsPercentage?e.discountIsPercentage:function(){const e=window.sessionStorage.getItem("WR_SALE_DISCOUNT_IS_PERCENTAGE");let t;return t=null===e||"true"===e,t}(),this.returnDiscountPercentage=e.returnDiscountPercentage||null,this.discount=e.discount,this.originalReturnTotals=e.originalReturnTotals||null,this.originalConfirmedTotals=e.originalConfirmedTotals||null,this.change=e.change,this.userRemovedSaleServiceFee=e.userRemovedSaleServiceFee||!1;this.totals=r(r({},{exclusivePrice:"0",exclusiveBasePrice:"0",tax:"0",taxes:{},baseTax:"0",inclusivePrice:"0",inclusiveBasePrice:"0",saleServiceFee:"0",saleServiceFeePaid:"0",cashDiscount:"0",rates:[],maxSaleDiscount:"0"}),e.totals);this.finals=r(r({},{exclusivePrice:"0",tax:"0",taxes:{},inclusivePrice:"0",subtotal:"0",tip:"0",taxDisplayProperties:{taxName:"",showRemoveAll:!1,showTaxBreakdown:!1}}),e.finals),this.syncStatus=e.syncStatus||zn.UNMODIFIED,this.syncAttempts=e.syncAttempts||0,this.displayStatus=e.displayStatus,this.pickable=e.pickable}getTaxSummaryFromLineTaxComponents(){const e=[];this.lineItems.forEach(t=>{t.taxComponents.forEach(n=>{const s=t.taxInfo.rates.find(e=>e.id===n.rate_id);e.push(r(r({},n),{},{name:s.display_name||s.name,rate:s.rate}))})}),this.discount&&b(this.discount.taxComponents,t=>{const n=e.find(e=>e.rate_id===t.rate_id);e.push(r(r({},t),{},{name:n.display_name||n.name,rate:n.rate}))});const t={};return e.forEach(e=>{const n=t[e.rate_id]||{total:0,name:e.name,rate:{rate:e.rate}};n.total=c.add(n.total,e.total_tax),t[e.rate_id]=n}),Ce(t)}addPayment(e,t,n,s,a,i){const r=ee().format(),o=new dc({localId:a,registerId:n,paymentType:t,amount:e,paymentDate:r,tipAmount:i});if(s){o.source=s.source,o.sourceId=s.source_id,s.payment_id&&(o.id=s.payment_id),s.external_transaction_id&&(o.external_transaction_id=s.external_transaction_id),s.merchant_id&&(o.merchantId=s.merchant_id),s.reference_id&&(o.referenceId=s.reference_id),s.auth_code&&(o.authCode=s.auth_code),s.signature_url&&(o.signatureURL=s.signature_url),s.signature_base64&&(o.signatureBase64=s.signature_base64),s.transaction_status&&(o.transactionStatus=s.transaction_status);const{card:e,emv:t,terminal:n,provider_fields:a}=s;e&&(o.card=this.getPaymentCard(e)),t&&(o.emv=this.getPaymentEMV(t)),n&&(o.terminal=this.getPaymentTerminal(n)),a&&(o.providerFields=a)}this.payments.push(o)}getPaymentTerminal(e){return{serialNumber:e.serial_number,model:e.model}}getPaymentCard(e){return{entryMethod:e.entry_method,brand:e.brand,type:e.type,lastFour:e.last_four,cardholderName:e.cardholder_name}}getPaymentEMV(e){return{aid:e.aid,applicationLabel:e.application_label,applicationPreferredName:e.application_preferred_name,cryptogramType:e.cryptogram_type,cryptogram:e.cryptogram,pinVerified:e.pin_verified,tags:e.tags}}setSaleLoyaltyClaimCode(){let e="";for(let t=0;t<6;t++){const t=Math.floor(36*Math.random());e+="abcdefghijklmnopqrstuvwxyz1234567890".charAt(t)}this.shortCode=e}getCashDiscountedSaleTotal(){return c.subtract(this.finals.inclusivePrice,this.totals.cashDiscount)}getOutstandingBalance(){return c.subtract(this.finals.inclusivePrice,this.getPaymentsTotal())}getAfterpayOutstandingBalance(){return this.getCurrentAndOriginalPayments().reduce((e,t)=>c.add(e,t.paymentType.type_id===hs.AFTER_PAY?t.amount:0),0)}getNonAfterpayOutstandingBalance(){return this.getCurrentAndOriginalPayments().reduce((e,t)=>c.add(e,t.paymentType.type_id!==hs.AFTER_PAY?t.amount:0),0)}getKlarnaOutstandingBalance(){return this.getCurrentAndOriginalPayments().reduce((e,t)=>c.add(e,t.paymentType.type_id===hs.KLARNA?t.amount:0),0)}getNonKlarnaOutstandingBalance(){return this.getCurrentAndOriginalPayments().reduce((e,t)=>c.add(e,t.paymentType.type_id!==hs.KLARNA?t.amount:0),0)}getOutstandingBalanceAfterChange(){return this.hasChange()?c.subtract(this.getOutstandingBalance(),this.change.amount):this.getOutstandingBalance()}isSaleTotalZero(){return Boolean(c.vn(this.finals.inclusivePrice).eq(0))}isSaleTotalGreaterThanZero(){return Boolean(c.vn(this.finals.inclusivePrice).gt(0))}isSaleTotalLessThanZero(){return Boolean(c.vn(this.finals.inclusivePrice).lt(0))}hasOutstandingBalance(){const e=this.getOutstandingBalanceAfterChange();return Boolean(!c.vn(e).eq(0))}getPaymentsTotal(){return this.payments.reduce((e,t)=>{const{amount:n}=t;return c.add(e,n)},0)}getBasketSize(){let e=be(this.lineItems,(e,t)=>c.add(t.quantity,e),0);return e=c.round(e,3),c.vn(e).toNumber()}isEmptySale(){return Boolean(!this.hasValidCustomer()&&!this.note&&0===this.lineItems.length)}hasPayments(){return 0!==this.getPaymentsTotal()}hasLineItems(){return Boolean(this.lineItems.length)}hasCustomerRelatedPayments(){return this.payments.some(e=>{const t=e.paymentType.type_id;return t===hs.STORE_CREDIT||t===hs.LOYALTY})}getChangeAmountForDisplay(){return this.change?c.vn(this.change.amount).abs().toNumber():0}hasChange(){return Boolean(this.change&&parseFloat(this.change.amount))}hasDiscount(){return Boolean(this.discount&&parseFloat(this.discount.price))}isSaleDiscountValid(e=this.displayDiscount,t=this.discountIsPercentage,n=this.totals.maxSaleDiscount){if(this.isReturn())return!0;if(!c.isFinite(e))return!1;const s=c.vn(e);return!s.lt(0)&&!s.gt(t?100:c.round(n,2))}getTipAdjustments(){return this.payments.filter(e=>c.vn(e.tipAmount).gt(0)).map(e=>r(r({},hc),{},{source_id:e.localId,value:e.tipAmount.toString()}))}getCashDiscountingAdjustments(e){const t=this.payments.map((e,t)=>({id:e.id||e.localId,paymentTypeId:e.paymentType.type_id,amount:this.hasChange()&&t===this.payments.length-1?c.add(e.amount,this.change.amount):e.amount})),n=t.filter(e=>_s(e.paymentTypeId)),s=t.filter(e=>!_s(e.paymentTypeId)),a=e.getCashDiscountingRate(),i=c.divide(a,c.add(1,a)),o=this.lineItems.map(e=>e.id||e.localId);return[...s.map(e=>r(r({},uc),{},{source_id:e.id,targets:o,value:c.round(c.multiply(e.amount,i).toString())})),...n.map(e=>r(r({},uc),{},{source_id:e.id,targets:o,value:c.round(c.multiply(e.amount,a).toString())})),...n.map(e=>r(r({},uc),{},{source_id:e.id,targets:o,value:"-"+c.round(c.multiply(e.amount,a))}))]}hasCashDiscountingServiceFee(e){return Boolean(e.hasCashDiscounting()&&c.vn(this.totals.saleServiceFee).gt(0))}hasTip(){return Boolean(c.vn(this.finals.tip).gt(0))}getFormattedReceiptNumberDetails(){const e=this.receiptNumberDetails;return"string"==typeof e?e:e?e.prefix+e.number+e.suffix:""}toJSON(){return r(r({},ye(this,"customer","user","customerBalances")),{},{lineItems:this.lineItems.map(e=>e.toJSON()),payments:this.payments.map(e=>e.toJSON()),discount:this.discount&&this.discount.toJSON(),change:this.change&&this.change.toJSON(),customer_id:this.customer&&this.customer.id,user_id:this.user&&this.user.id})}isReturn(){return Boolean(this.returnFor)}isExchange(){return this.isReturn()&&this.displayStatus===qn.EXCHANGE_PARKED}isExchangeCompleted(){return this.isReturn()&&this.displayStatus===qn.EXCHANGE_CLOSED}isConfirmed(){return Vn.includes(this.status)}isLayby(){return[qn.LAYBY_SALE,qn.LAYBY_SALE_CLOSED].includes(this.status)}isOnAccount(){return[qn.ACCOUNT_SALE,qn.ACCOUNT_SALE_CLOSED].includes(this.status)}isCompleted(){return jn.includes(this.status)}isReturnAllowed(){return Wn.includes(this.status)}isConfirmedReadyToComplete(){return this.isConfirmed()&&this.readyToComplete}isConfirmedNotReadyToComplete(){return this.isConfirmed()&&!this.readyToComplete}isConfirmedCompleted(){return Kn.includes(this.status)}isClosed(){return Gn.includes(this.status)}isOpen(){return Qn.includes(this.status)}isVoided(){return this.status===qn.VOIDED}isParked(){return this.status===qn.PARKED}isQuote(){return this.status===qn.QUOTE}isMarkedAsUnfulfilled(){return this.status===qn.AWAITING_PICKUP||this.status===qn.AWAITING_DISPATCH}isUnfulfilledPickUp(){return this.status===qn.AWAITING_PICKUP}isSynced(){return Jn.includes(this.syncStatus)}hasPromotions(){return this.lineItems.some(e=>e.promotion&&e.promotion.promotionDetails)}hasValidCustomer(){const e=this.customer;return Boolean(e&&"WALKIN"!==e.customer_code)}hasValidCustomerWithEmail(){return Boolean(this.hasValidCustomer()&&this.customer.email)}hasValidCustomerWithLoyalty(){return Boolean(this.hasValidCustomer()&&this.customer.enable_loyalty)}hasMultipleTaxGroups(){return Object.keys(this.finals.taxes).length>1}containsGiftCard(){return this.lineItems.some(e=>e.isGiftCard())}containsGiftCardByNumber(e){return this.lineItems.some(t=>t.isGiftCard()&&t.giftCardNumber===e)}getCurrentAndOriginalPayments(){return this.payments.concat(this.originalSalePayments)}hasUnknownLineItems(){return Boolean(this.unknownLineItems.length)}isBlindReturn(){return!this.isReturn()&&this.lineItems.some(e=>c.vn(e.quantity).lt(0))}}t.module("webregister.models").factory("Sale",()=>mc);const gc=e=>Boolean(e&&C(e.attributes,{name:"vend.is_gift_card",value:"1"})),pc=e=>{const t={},n=e.map(e=>e.product.id);return[...new Set(n)].forEach(n=>{t[n]=((e,t)=>e.reduce((e,n)=>n.product.id===t?c.add(e,n.quantity):e,0))(e,n)}),t},vc=e=>{const t=[];return e&&e.forEach(e=>{if(e.promotion&&e.promotion.promotionDetails){e.promotion.promotionDetails.forEach(n=>{const s=t.find(e=>e.id===n.id),a=c.multiply(c.vn(n.amount),c.vn(e.quantity));s&&null!=s.total?s.total+=a:t.push({id:n.id,name:n.name,total:a,description:n.description,promo_code:n.promoCode})})}}),t},yc=(e,t=!1)=>e&&e.lineItems?e.lineItems.reduce((e,n)=>c.vn(n.quantity).isNegative()===t?c.add(e,n.quantity):e,0):0,fc=(e,t)=>{const n=Sc(e,t);if(e.isSaleDiscountValid(e.displayDiscount,e.discountIsPercentage,n)){if(e.discountIsPercentage)return c.divide(e.displayDiscount,100);if(c.vn(n).gt(0))return c.divide(e.displayDiscount,n)}return 0},Sc=(e,t)=>{const{lineItems:n}=e;return n.reduce((n,{quantity:s,price:a,tax:i,isReturn:r,confirmed:o})=>{let l;return l=t?c.multiply(c.add(a,i),s):c.multiply(a,s),e.isReturn()&&!r||e.isConfirmed()&&!o?n:c.add(l,n)},0)},Cc=e=>{if(!e.return_for&&!e.returnFor)return e.status;const t=e.line_items||e.lineItems||[],n=t.length>t.filter(e=>e.isReturn||e.is_return).length;return e.status===qn.PARKED?n?qn.EXCHANGE_PARKED:qn.RETURN_PARKED:e.status===qn.CLOSED?n?qn.EXCHANGE_CLOSED:qn.RETURN_CLOSED:e.status},bc=(e,t)=>new Promise((n,s)=>{const a=e.filter(e=>e.product.has_inventory);a.length||n(!0);const i=pc(a),r=Object.keys(i);((e,t)=>new Promise((n,s)=>{const a={};da(e,{include_variants:!1,location_ids:[t]}).then(e=>{e.forEach(e=>{a[e.product_id]=e.levels.on_hand}),n(a)}).catch(e=>{P("Failed to retrieve on hand inventory levels",{data:{error:e}}),s(e)})}))(r,t).then(e=>{const t=r.every(t=>c.vn(e[t]).gte(i[t]));n(t)}).catch(s)});function _c(e,t,n,s){function a(e,t,...n){return Qe.warn("[SaleLoader] "+t,...n),We.reject({type:e,message:t})}return{loadSale(e){return this._loadSale(e).then(e=>e.isCompleted()&&e.isSynced()?a(this.ERROR_TYPES.LOAD_SALE_ABORTED.COMPLETED,"Attempt to load completed sale, aborting.",e):e.isReturn()?We.all({paymentType:n.hasActiveIntegratedPaymentType(),returnSale:this.loadReturnSale(e.returnFor)}).then(({paymentType:t,returnSale:n})=>(t&&(e.originalSalePayments=n.payments),e.returnDiscountPercentage=fc(n,s.isTaxInclusive()),e)):e)},loadReturnSale(e){return this._loadSale(e,!0).then(e=>e.isReturnAllowed()?e:a(this.ERROR_TYPES.LOAD_SALE_ABORTED.COMPLETED,"Attempt to load a non return sale, aborting.",e))},_loadSale(n,s=!1){return e.loadSaleJson(n).then(e=>{return!s&&e&&e.syncStatus!==zn.UPLOADED?t.toModel(e):(a=n,Ke.get("/api/2.0/sales/"+a).then(Ue)).then(e=>t.toModel(e));var a}).then(e=>e&&e instanceof mc?e.isVoided()?a(this.ERROR_TYPES.LOAD_SALE_ABORTED.VOIDED,"Attempt to load voided sale, aborting.",e):e:a(this.ERROR_TYPES.SALE_NOT_FOUND,`No sale with ID ${n} found.`))},ERROR_TYPES:{LOAD_SALE_ABORTED:{VOIDED:"LOAD_SALE_ABORTED.VOIDED",COMPLETED:"LOAD_SALE_ABORTED.COMPLETED"},SALE_NOT_FOUND:"SALE_NOT_FOUND"}}}_c.$inject=["salesStore","saleTransformer","paymentManager","registerManager"],t.module("webregister.factories").factory("saleLoader",_c);class wc extends Pl{constructor(e){super(e),s(this,"localId",void 0),s(this,"id",void 0),s(this,"adjusted",void 0),s(this,"isReturn",void 0),s(this,"product",void 0),s(this,"giftCardNumber",void 0),s(this,"giftCardReload",void 0),s(this,"giftCardClientId",void 0),s(this,"giftCardExpiresAt",void 0),s(this,"price",void 0),s(this,"basePrice",void 0),s(this,"tax",void 0),s(this,"baseTax",void 0),s(this,"taxInfo",void 0),s(this,"promotion",void 0),s(this,"loyaltyValue",void 0),s(this,"explicitLoyaltyValue",void 0),s(this,"bestPriceBookInfo",void 0),s(this,"note",void 0),s(this,"dateAdded",void 0),s(this,"displayPrice",void 0),s(this,"displayDiscount",void 0),s(this,"displayDiscountPercent",void 0),s(this,"displayMarkupPercent",void 0),s(this,"displayBasePrice",void 0),s(this,"quantity",void 0),s(this,"originalQuantity",void 0),s(this,"displayQuantity",void 0),s(this,"taxComponents",void 0),s(this,"totals",void 0),s(this,"confirmed",void 0),s(this,"calculating",!0),e=e||{},this.localId=e.localId||se(),this.id=e.id,this.adjusted=e.adjusted||!1,this.isReturn=e.isReturn||!1,this.product=e.product,this.giftCardNumber=e.giftCardNumber||"",this.giftCardReload=e.giftCardReload||!1,this.giftCardClientId=e.giftCardClientId,this.giftCardExpiresAt=e.giftCardExpiresAt,this.price=e.price||"0",this.basePrice=e.basePrice||"0",this.tax=e.tax||"0",this.baseTax=e.baseTax||"0",this.taxInfo=e.taxInfo,this.promotion=e.promotion,this.loyaltyValue=e.loyaltyValue||"0",this.explicitLoyaltyValue=e.explicitLoyaltyValue||!1,this.bestPriceBookInfo=e.bestPriceBookInfo,this.note=e.note||"",this.dateAdded=e.dateAdded||Date.now(),this.displayPrice=e.displayPrice,this.displayDiscount=e.displayDiscount,this.displayDiscountPercent=e.displayDiscountPercent,this.displayMarkupPercent=e.displayMarkupPercent,this.displayBasePrice=e.displayBasePrice,this.quantity=void 0===e.quantity?"1":e.quantity,this.originalQuantity=this.quantity,this.displayQuantity=e.displayQuantity||this.quantity,this.taxComponents=e.taxComponents||[],this.totals=e.totals||{exclusivePrice:"0",exclusiveBasePrice:"0",tax:"0",inclusivePrice:"0",inclusiveBasePrice:"0",saleDiscount:"0",saleDiscountTax:"0"},this.confirmed=e.confirmed||!1}toJSON(){const e=r({},this);return y(ye(e,"product","taxInfo","promotion"),{product_id:this.product.id,tax_id:this.taxInfo&&this.taxInfo.id,promotion:this.promotion&&this.promotion.toJSON()})}isPriceDiscounted(){return c.vn(this.displayDiscountPercent).gt(0)}isPriceMarkedUp(){return c.vn(this.displayMarkupPercent).gt(0)}getTaxRateNames(){return this.taxComponents.map(e=>{const t=this.taxInfo.rates.find(t=>t.id===e.rate_id);return t.display_name||t.name}).join(", ")}getUnitTaxFromTaxComponents(){const e=this.getTotalTaxFromTaxComponents();return 0===e?0:c.divide(e,this.quantity)}getTotalTaxFromTaxComponents(){return be(this.taxComponents,(e,t)=>c.add(t.total_tax,e),0)}getUnitDisplayPrice(e){let t;return t=e?c.add(this.price,this.getUnitTaxFromTaxComponents()):this.price,t}getTotalDisplayPrice(e){let t;return t=e?c.add(this.totals.exclusivePrice,this.getTotalTaxFromTaxComponents()):this.totals.exclusivePrice,t}isGiftCard(){return gc(this.product)}getProductId(){return this.product.id}getSku(){return this.product.sku}getName(){return this.product.name}getVariantName(){return this.product?this.product.variant_name:"Product not found"}hasVariants(){return Boolean(this.product&&this.product.variant_options&&this.product.variant_options.length)}getVariantsDisplayNames(){return this.product.variant_options.map(e=>e.value).join(" / ")}isDeletedProduct(){return Boolean(this.product&&this.product.deleted_at)}getTaxCode(){if(this.product&&this.product.attributes&&this.product.attributes.length){const e=this.product.attributes.find(e=>"tax_code"===e.name);return e?e.value:""}return""}}class Mc{constructor(e){s(this,"localId",void 0),s(this,"name",void 0),s(this,"dateAdded",void 0),this.localId=e.localId||se(),this.name=e.name,this.dateAdded=e.dateAdded||Date.now()}}class Tc{constructor(e={}){s(this,"localId",void 0),s(this,"id",void 0),s(this,"priceBook",void 0),s(this,"lineItemPromotion",void 0),s(this,"promotionDetails",void 0),this.localId=e.localId||se(),this.id=e.id||null,this.priceBook=e.priceBook||null,this.lineItemPromotion=e.lineItemPromotion||e.blazePromotion||null,this.promotionDetails=e.promotionDetails||null}getName(){return this.priceBook?this.priceBook.name:""}toJSON(){const e=r({},this);if(e.priceBook||e.lineItemPromotion||this.promotionDetails)return r(r({},ye(e,"priceBook")),{},{price_book_id:e.priceBook&&e.priceBook.id||null})}}class Ec{constructor(e={}){s(this,"localId",void 0),s(this,"id",void 0),s(this,"price",void 0),s(this,"tax",void 0),s(this,"taxInfo",void 0),s(this,"taxComponents",void 0),this.localId=e.localId||se(),this.id=e.id||null,this.price=e.price||"0",this.tax=e.tax||"0",this.taxInfo=e.taxInfo||null,this.taxComponents=e.taxComponents||null}toJSON(){const e=r({},this);return r(r({},ye(e,"taxInfo")),{},{tax_id:this.taxInfo&&this.taxInfo.id})}}const kc=new Bs({entityStoreName:"paymentTypes",entityName:"payment_types",syncDeleted:!0});class Ic extends Bs{constructor(){super({entityStoreName:"priceBooks",entityName:"price_books"})}shouldStoreEntity(e){return null!==e.name}}Ic.$inject=[];const Pc=new Ic;class Rc{constructor(e,t,n,s,a,i,r,o,l){this.retailerSettingsManager=e,this.priceManager=t,this.registerManager=n,this.taxManager=s,this.vdTracking=a,this.productsStore=i,this.taxesStore=r,this.usersStore=o,this.saleVersioningManager=l}toApi(e){const t=e.receiptNumberDetails;let n;t&&"string"!=typeof t&&(n=t.number);const s={id:e.id||e.localId,short_code:e.shortCode,sale_date:e.saleDate,status:e.status,customer_id:e.customer&&e.customer.id,register_id:e.registerId,user_id:e.user&&e.user.id,invoice_number:e.getFormattedReceiptNumberDetails(),invoice_sequence:n,total_tax:e.finals.tax,total_price:e.finals.exclusivePrice,note:e.note,receipt_address:e.receiptEmailAddress,receipt_id:e.receiptID,register_sale_products:p(e.lineItems,(e,t)=>this.formatLineItemForApi(e,t)),register_sale_payments:p(e.payments,e=>this.formatPaymentForApi(e)),adjustments:[],custom_fields:e.customFields.map(e=>this.formatCustomFieldForApi(e)),pickable:e.pickable,fulfillment_outlet_id:e.fulfillmentOutletID};return e.hasCashDiscountingServiceFee(this.registerManager)&&s.adjustments.push(...e.getCashDiscountingAdjustments(this.registerManager)),e.hasTip()&&s.adjustments.push(...e.getTipAdjustments()),e.hasChange()&&s.register_sale_payments.push(this.formatPaymentForApi(e.change)),e.hasDiscount()&&s.register_sale_products.push(this.createDiscountLineItem(e)),s}toPromotion(e){const t=this.registerManager.getActiveOutlet();return{channel:"Register",promo_code:e.promoCode||"",customer:{customer_group_id:e.customer&&"WALKIN"!==e.customer.customer_code&&e.customer.customer_group_id||null},is_tax_inclusive:this.registerManager.isTaxInclusive(),outlet_id:t.id,sale:{sale_date:u.tz(t.time_zone).format(fa),line_items:p(e.lineItems,e=>this.formatLineItemForPromotion(e))}}}toModel(e){return We((t,n)=>{if(!e||e instanceof mc)t(e);else if(Array.isArray(e.lineItems)){const s=this.saleVersioningManager.convertToLatestModelVersion(e);this.hydrateSale(s).then(t,n)}else this.formatSaleJsonForModel(e).then(e=>this.hydrateSale(e)).then(t,n)})}toClientApi(e){const n=t.copy(e),s={id:n.id||n.localId,client_id:_n.APPLICATION_NAME,client_sale_id:n.localId,status:n.status,totals:{total_tax:n.finals.tax,total_price:n.finals.exclusivePrice,total_paid:c.round(n.getPaymentsTotal(),2),total_to_pay:n.finals.inclusivePrice}};if(s.line_items=p(n.lineItems,e=>{let t=null;e.taxInfo&&e.taxInfo.id&&(t=e.taxComponents.reduce((e,t)=>c.add(c.vn(e),c.vn(t.rate.rate)),c.vn(0)));const n=c.vn(e.quantity).isZero()?0:c.divide(c.vn(e.totals.tax),c.vn(e.quantity));return{product_id:this.getLineItemProductId(e),name:e.product.name,quantity:e.quantity,sku:e.product.sku,unit_price:c.round(e.price,5),unit_tax:c.round(n,5),tax_id:e.taxInfo&&e.taxInfo.id?e.taxInfo.id:null,tax_rate:t,image_url:e.product.image_url,discount:c.round(e.displayDiscount,5)}}),n.hasValidCustomer()&&(s.customer_id=n.customer.id),n.hasDiscount()){const{discount:e}=n;s.discount={product_id:this.retailerSettingsManager.get().discount_product_id,price:c.round(e.price,5),tax:c.round(e.tax,5),tax_id:e.taxInfo.id}}return s}hydrateProduct(e){return We(t=>{if(!e)return t();this.productsStore.get(e).then(n=>{if(n)return t(n);this.vdTracking.trackUserEvent({eventName:"Retrieving Deleted Product",metadata:{productId:e}}),function(e){return Ke.get("/api/2.0/products/"+e).then(Ue)}(e).then(e=>e?this.productsStore.put(e).then(()=>t(e)):We.reject("Product was not returned from the API")).catch(n=>{this.vdTracking.trackError("[SaleTransformer] Failed to hydrate a product via the API",{data:{error:n,productId:e}}),t()})})})}getLineItemProductId(e){const t=e.getProductId();return t||this.vdTracking.trackError("[Sale Transformer] Failed to get product id from line item",{data:{stack:(new Error).stack}}),t}formatLineItemForPromotion(e){const t=Boolean(e.bestPriceBookInfo&&e.bestPriceBookInfo.price),n={price:e.price,tax:e.tax,loyaltyValue:e.loyaltyValue,explicitLoyaltyValue:e.explicitLoyaltyValue};if(t){const t=e.bestPriceBookInfo;n.price=c.vn(t.price).toNumber(),n.tax=c.vn(t.tax).toNumber(),n.loyaltyValue=c.vn(t.loyaltyValue).toNumber(),n.explicitLoyaltyValue=t.explicitLoyaltyValue}return{id:e.localId,handle:e.product.handle,product_id:this.getLineItemProductId(e),product_brand_id:e.product.brand_id,product_supplier_id:e.product.supplier_id,product_type_id:e.product.product_type_id,product_tag_ids:e.product.tag_ids,quantity:c.vn(e.quantity).toNumber(),unit_price:n.price,unit_tax:n.tax,price_adjusted:e.adjusted,confirmed:e.confirmed,loyalty_value:n.loyaltyValue,explicit_loyalty_value:n.explicitLoyaltyValue,variant_parent_id:e.product.variant_parent_id}}createDiscountLineItem(e){const t=e.discount;let n=[];const s={};return e.lineItems.forEach(e=>{c.vn(e.totals.saleDiscountTax).eq(0)||e.taxComponents.forEach(e=>{s[e.rate_id]=s[e.rate_id]||{total_tax:0,rate_id:e.rate_id},s[e.rate_id].total_tax=c.add(s[e.rate_id].total_tax,c.subtract(e.total_tax,e.total_tax_after_sale_discount))})}),n=Object.keys(s).map(e=>({rate_id:e,total_tax:-s[e].total_tax})),{id:t.id||t.localId,product_id:this.retailerSettingsManager.get().discount_product_id,price_set:1,price:t.price,tax:t.tax,tax_id:t.taxInfo.id,discount:0,loyalty_value:0,tax_components:n.length?n:void 0,status:e.isConfirmed()?"CONFIRMED":"SAVED",quantity:-1,sequence:e.lineItems.length}}formatLineItemForApi(e,t){const n=[{name:"line_note",value:e.note}];e.isGiftCard()&&(n.push({name:"vend.gift_card.number",value:e.giftCardNumber},{name:"vend.gift_card.amount",value:e.basePrice}),e.giftCardReload&&n.push({name:"vend.gift_card.is_reload",value:e.giftCardReload}),e.giftCardClientId&&n.push({name:"vend.gift_card.client_id",value:e.giftCardClientId}),e.giftCardExpiresAt&&n.push({name:"vend.gift_card.expires_at",value:e.giftCardExpiresAt}));const s=c.vn(e.quantity).isZero()?0:c.divide(c.vn(e.totals.tax),c.vn(e.quantity)),a={id:e.id||e.localId,product_id:this.getLineItemProductId(e),price:c.round(e.price,5),price_set:e.adjusted?1:0,discount:e.displayDiscount,tax:c.round(s,5),tax_id:e.taxInfo.id,loyalty_value:e.loyaltyValue,quantity:e.quantity,sequence:t,status:e.confirmed?"CONFIRMED":"SAVED",attributes:n,tax_components:e.taxComponents.map(e=>({rate_id:e.rate_id,total_tax:e.total_tax})),custom_fields:e.customFields.map(e=>this.formatCustomFieldForApi(e))};if(e.promotion&&e.promotion.promotionDetails){const t=[];e.promotion.promotionDetails.forEach(e=>{const n={promotion_id:e.id,name:e.name,amount:e.amount,promo_code:e.promoCode,promo_code_id:e.promoCodeId};t.push(n)}),a.promotions=t}return a}formatCustomFieldForApi(e){switch(e.type){case Il.STRING:case Il.DATE:case Il.PRODUCT_ID:return{name:e.name,string_value:e.value};case Il.INTEGER:return{name:e.name,integer_value:e.value};case Il.BOOLEAN:return{name:e.name,boolean_value:e.value}}}formatPaymentForApi(e){const t=this.registerManager.getActiveOutlet(),n={id:e.id||e.localId,register_id:e.registerId,payment_type_id:e.paymentType.type_id,retailer_payment_type_id:e.paymentType.id,payment_date:e.paymentDate,amount:e.amount,currency:t.currency,source:e.source,source_id:e.sourceId},{terminal:s,card:a,emv:i}=e;return(e.external_transaction_id||e.referenceId||e.merchantId||e.authCode||e.signatureURL||e.signatureBase64||e.transactionStatus||s||a||i)&&(n.external_attributes={transaction_id:e.external_transaction_id,reference_id:e.referenceId,merchant_id:e.merchantId,auth_code:e.authCode,signature_url:e.signatureURL,signature_base64:e.signatureBase64,transaction_status:e.transactionStatus},s&&(n.external_attributes.terminal={serial_number:s.serialNumber,model:s.model}),a&&(n.external_attributes.card={entry_method:a.entryMethod,brand:a.brand,type:a.type,last_four:a.lastFour,cardholder_name:a.cardholderName}),i&&(n.external_attributes.emv={aid:i.aid,application_label:i.applicationLabel,cryptogram_type:i.cryptogramType,cryptogram:i.cryptogram,pin_verified:i.pinVerified,tags:i.tags})),n}formatSaleJsonForModel(e){let t=We.resolve();const n=this.retailerSettingsManager.get().discount_product_id,s={id:e.id,localId:e.localId||e.id,lineItems:[],note:e.note,customer_id:e.customer_id,status:e.status,returnFor:e.return_for,shortCode:e.short_code,displayStatus:Cc(e),receiptNumberDetails:e.invoice_number,saleDate:e.sale_date,registerId:e.register_id,user_id:e.user_id};return b(v(e.line_items,"sequence"),e=>{e.product_id===n?function(e){let t=s.discount;s.discountIsPercentage=!1,t||(t={id:e.id,localId:e.localId||e.id,tax_id:e.tax_id,price:"0",tax:"0"},e.tax_components&&(t.taxComponents=e.tax_components),s.discount=t);const n=c.multiply(e.quantity,-1),a=c.multiply(e.price,n),i=c.multiply(e.tax,n);t.price=c.add(t.price,a),t.tax=c.add(t.tax,i)}(e):t=t.then(()=>this.addLineItemToSaleJson(e,s))}),s.discount&&(s.discount.price=c.round(s.discount.price,5),s.discount.tax=c.round(s.discount.tax,5)),s.payments=p(e.payments,e=>({id:e.id,localId:e.localId||e.id,payment_type_id:e.retailer_payment_type_id,registerId:e.register_id,paymentDate:e.payment_date,amount:e.amount,source:e.source,sourceId:e.source_id,retrieved:!0})),t.then(()=>s)}addLineItemToSaleJson(e,n){const s=e.product_id;return s||this.vdTracking.trackError("[Sale Transformer] Product ID missing from api line item",{data:{stack:(new Error).stack}}),this.taxesStore.get(e.tax_id).then(a=>{const i=a,r={id:e.id,localId:e.localId||e.id,adjusted:Boolean(e.price_set),isReturn:Boolean(e.is_return),product_id:s,giftCardNumber:e.gift_card_number||"",price:e.price,tax:e.tax,tax_id:e.tax_id,loyaltyValue:e.loyalty_value,explicitLoyaltyValue:Boolean(e.price_set||e.is_return),displayDiscount:e.discount,confirmed:"CONFIRMED"===e.status,quantity:e.quantity,note:e.note};if(e.tax_components&&(r.taxComponents=e.tax_components),t.isDefined(e.promotions)&&e.promotions.length){const t=e.promotions.map(e=>(!n.promoCode&&e.promo_code&&(n.promoCode=e.promo_code,n.promoCodeStatus=Sa),{id:e.promotion_id,name:e.name,amount:e.amount,promoCode:e.promo_code,promoCodeId:e.promo_code_id}));r.promotion={promotionDetails:t}}const o=this.priceManager.calculateDisplayPrice(e.price,e.tax),l=c.add(o,e.discount),d=this.taxManager.calculateTaxRate(i),u=this.priceManager.calculatePriceComponents(l,d);r.basePrice=u.price,r.baseTax=u.tax,n.lineItems.push(r)}).catch(e=>(Qe.warn("[SaleTransformer] Failed to retrieve tax information for a confirmed line item",e),We.reject(e)))}hydrateSale(e){const t=We.all(p(e.payments,this.hydratePayment.bind(this))).then(this.linkPayments.bind(this,e)),n=e.discount?this.hydrateSaleDiscount(e):We.when(),s=e.change?this.hydrateSaleChange(e):We.when();return We.all([this.hydrateSaleProducts(e),t,n,s,this.hydrateCustomer(e),this.hydrateUser(e)]).then(t=>(e.lineItems=t[0],new mc(e)))}hydrateSaleProducts(e){let t=!1;const n=[],s=We.all(p(e.lineItems,e=>(e.product_id||(t=!0,n.push(e)),this.hydrateLineItem(e))));if(t){const{saleDate:t,status:s,syncStatus:a}=e;this.vdTracking.trackError("[hydrateSaleProducts] Sale has products with missing ids",{data:{stack:(new Error).stack,lineItemsWithMissingId:n,saleDate:t,status:s,syncStatus:a}})}return s}hydrateCustomer(e){let t;return t=e.customer_id?pa.get(e.customer_id):We.when(void 0),t.then((function(t){e.customer=t}))}hydrateUser(e){let t;const n=e.user_id;return t=n?this.usersStore.get(n):We.when(void 0),t.then((function(t){e.user=t}))}hydrateLineItem(e){return We.all({product:this.hydrateProduct(e.product_id),taxInfo:this.taxesStore.get(e.tax_id),promotion:this.hydratePromotion(e.promotion)}).then((function(t){return y(e,t),new wc(e)}))}hydratePromotion(e){return e?(e.blazePromotion&&(e.lineItemPromotion=e.blazePromotion),e.lineItemPromotion||e.promotionDetails?new Tc({lineItemPromotion:e.lineItemPromotion,promotionDetails:e.promotionDetails}):Pc.get(e.price_book_id).then((function(t){return y(e,{priceBook:t}),new Tc(e)}))):null}hydratePayment(e){return kc.get(e.payment_type_id).then((function(t){return y(e,{paymentType:t}),new dc(e)}))}linkPayments(e,t){e.payments=t}hydrateSaleDiscount(e){const t=e.discount;return this.taxesStore.get(t.tax_id).then(n=>{y(t,{taxInfo:n}),e.discount=new Ec(t),e.discountIsPercentage||(e.displayDiscount=this.registerManager.isTaxInclusive()?c.add(t.price,t.tax):t.price)})}hydrateSaleChange(e){return this.hydratePayment(e.change).then(t=>{e.change=t})}}Rc.$inject=["retailerSettingsManager","priceManager","registerManager","taxManager","vdTracking","productsStore","taxesStore","usersStore","saleVersioningManager"],t.module("webregister.factories").factory("saleTransformer",Rc),t.module("webregister.factories").factory("$sanitize",()=>e=>Z.sanitize(e)),t.module("webregister.factories").factory("versionsStore",(function(){const e=Fs("versions");function t(t){return e.put(t).then((function(){return t}))}return{trackVersion:(n,s)=>(s=s||n,Qe.debug('[VersionsStore] Tracking version of entity: "'+n+'", entityStore: "'+s+'"'),e.get(s).then((function(e){return e||t(e={entityStoreName:s,entityName:n,lastSyncedVersion:0,maxVersion:0,initialSyncHasOccurred:!1})}))),trackVersions(e){let t=this.trackVersion;return e instanceof Array&&(t=e=>this.trackVersion(e)),We.all(p(e,t))},updateVersions:t=>(Qe.debug("[VersionsStore] Latest version data from server:",t),e.all().then((function(n){const s=[],a=[];return b(n,(function(n){const i=t[n.entityName];l(i)&&(i>n.maxVersion&&(n.maxVersion=i,Qe.debug("[VersionsStore] Updating version data for:",n),s.push(e.put(n))),n.maxVersion>n.lastSyncedVersion&&a.push(n))})),We.all(s).then((function(){return Qe.debug("[VersionsStore] "+a.length+" tracked entities require sync:",a),a}))}))),updateEntityVersion:n=>e.get(n.entityStoreName).then((function(e){return t(y(e,n))})),getEntityVersion:t=>e.get(t)}}));class Ac extends Bs{constructor(e){super({entityStoreName:"products"}),this.vdTracking=e}updateEntities(e){return e.forEach(this.transformProduct),super.updateEntities(e)}getAllVariantProducts(e){return We.resolve(this.dbStore.index("byVariantParentId").getAll(e.id)).then((function(t){const n=[...t];return n.unshift(e),n.filter(e=>e.active).sort((e,t)=>e.button_order-t.button_order)}))}getVariantCount(e){return We.resolve(this.dbStore.index("byVariantParentId").count(e).then(e=>e+1))}transformProduct(e){return e.product_codes_array=[e.sku],e.product_codes&&e.product_codes.length>0&&(e.product_codes_array=e.product_codes.map(e=>e.code)),e}removeDeletedProducts(){return this.getDeletedProductIds().then(e=>{if(Object.keys(e).length)return We.resolve(this.dbStore.batch(e))}).catch(e=>(this.vdTracking.trackError("[ProductsStore] Failed to clean up deleted products.",{data:{error:e}}),We.resolve()))}getDeletedProductIds(){const e={};return this.dbStore.index("byDeletedAt").cursor({iterator:t=>{const n=t.value;return e[n.id]=null,!0}}).then(()=>e)}}Ac.$inject=["vdTracking"],t.module("webregister.factories").service("productsStore",Ac);class Dc extends Bs{constructor(){super({entityStoreName:"taxes",syncDeleted:!0})}getTaxByRateId(e){return this.all().then(t=>{const n=t.find(t=>1===t.rates.length&&t.rates[0].id===e);return void 0!==n?n:We.reject("Could not find tax for rate "+e)})}}Dc.$inject=[],t.module("webregister.factories").service("taxesStore",Dc);class Nc extends Bs{constructor(){super({entityStoreName:"productTaxes",entityName:"outlet_taxes",filterByOutlet:!0})}removeEntity(e){return this.dbStore.del(e.product_id)}}Nc.$inject=[];const xc=new Nc;class Oc extends Bs{constructor(){super({entityStoreName:"priceBookProducts",entityName:"price_book_products"})}getByProductId(e){return We.resolve(this.dbStore.index("byProductId").getAll(e))}shouldStoreEntity(e){return null!==e.price_book_id}}Oc.$inject=[];const $c=new Oc;class Lc{constructor(e,t,n,a){this.saleTransformer=e,this.vdTracking=t,this.vdPerformanceTracking=n,this.currentSaleManager=a,s(this,"salesDbStore",void 0),this.salesDbStore=Fs("sales")}getUnsyncedSales(){return We.all(Xn.map(e=>this.getSalesBySyncStatus(e))).then(e=>U(e))}getSalesBySyncStatus(e){return We.resolve(this.salesDbStore.index("syncStatus").getAll(e)).then(e=>We.all(e.map(this.saleTransformer.toModel,this.saleTransformer)))}getErroredSalesJson(){function e(e){return delete e.receiptEmailAddress,delete e.note,e.lineItems&&e.lineItems.forEach(e=>{delete e.note}),e}return this.salesDbStore.index("syncStatus").getAll(zn.ERROR).then(e=>U(e)).then(t=>t.map(e))}saveSale(e){this.checkSaleModelLineItems(e);const t=this.currentSaleManager.hydrateSaleFromRedux(e);return this.writeSaleJson(t.toJSON())}writeSaleJson(e){return We.resolve(this.salesDbStore.put(e))}loadSale(e){return this.loadSaleJson(e).then(e=>e&&this.saleTransformer.toModel(e))}loadSaleJson(e){return We.resolve(this.salesDbStore.get(e)).then(t=>t||We.resolve(this.salesDbStore.index("byId").get(e)))}removeSale(e){return We.resolve(this.salesDbStore.del(e))}count(){return We.resolve(this.salesDbStore.count())}removeUploadedSales(){return this.vdPerformanceTracking.start("REMOVE_UPLOADED_SALES"),this.getUploadedSaleIdsReadyForRemoval().then(e=>{if(!e)return;const t=Object.keys(e).length;return We.resolve(this.salesDbStore.batch(e)).then(()=>{const e=this.vdPerformanceTracking.stop("REMOVE_UPLOADED_SALES"),n=e&&e.duration;this.vdTracking.trackUserEvent({eventName:"Batch Removal of Uploaded Sales",metadata:{batchSize:t,duration:n}})}).catch(e=>{this.vdPerformanceTracking.stop("REMOVE_UPLOADED_SALES"),this.vdTracking.trackError("[Sales Store] Failed to batch delete uploaded sales",{data:{batchSize:t,error:e}})})})}getUploadedSaleIdsReadyForRemoval(){return this.getNextBatchOfRemovableSaleIds().then(e=>{const t={};if(e.forEach(e=>{t[e]=null}),Object.keys(t).length)return t}).catch(e=>{this.vdTracking.trackError("[Sales Store] Failed to get uploaded sales ready for removal",{data:{error:e}})})}getNextBatchOfRemovableSaleIds(){const e=[];return this.salesDbStore.index("syncStatus").cursor({range:zn.UPLOADED,iterator:t=>this.removableSalesIterator(e,t)}).then(()=>e)}removableSalesIterator(e,t){if(e.length>=100)return!1;const n=t.value;if(n){(ee().diff(ee(n.saleDate),"days")>7||!n.saleDate)&&e.push(n.localId)}return!0}checkSaleModelLineItems(e){const{lineItems:t,saleDate:n,syncStatus:s,status:a}=e;if(!t||!t.length)return;t.some(e=>!e.product||!e.product.id)&&this.vdTracking.trackError("[Sale Store] lineItem missing product id",{data:{stack:(new Error).stack,saleDate:n,syncStatus:s,status:a}})}}Lc.$inject=["saleTransformer","vdTracking","vdPerformanceTracking","currentSaleManager"],t.module("webregister.factories").service("salesStore",Lc);class Fc extends Bs{constructor(){super({entityName:"retailer",entityStoreName:"retailerSettings",databaseStoreName:"settings"})}get(){return super.get("RETAILER_SETTINGS")}requestSyncData(){return We.all([Ke.get("/api/2.0/retailer").then(Ue),this.get()]).then(([e,t])=>{const n=t&&t.version,s=[];let a=null;return e.version!==n&&(s.push(e),a=e.version),{data:s,version:{min:a,max:a}}})}syncData(e){const t=e&&e[0];return this.dbStore.put("RETAILER_SETTINGS",t).then(()=>this.emitSyncEvent({removed:[],updated:t}))}}Fc.$inject=[];const Uc=new Fc;t.module("webregister.factories").constant("retailerSettingsStore",Uc),t.module("webregister.factories").factory("usersStore",(function(){return new Bs({entityStoreName:"users",syncDeleted:!0})}));const Bc=new Bs({entityStoreName:"settings"}),qc=new Bs({entityStoreName:"brands"});t.module("webregister.factories").constant("brandsStore",qc),t.module("webregister.factories").factory("suppliersStore",(function(){return new Bs({entityStoreName:"suppliers"})})),t.module("webregister.factories").factory("tagsStore",(function(){return new Bs({entityStoreName:"tags"})}));const Vc=new Bs({entityStoreName:"productTypes",entityName:"product_types"});t.module("webregister.factories").constant("productTypesStore",Vc);const Kc=new Bs({entityStoreName:"receiptTemplateTypes",entityName:"receipt_template_types",syncDeleted:!0});t.module("webregister.factories").constant("receiptTemplateTypesStore",Kc);const Gc=new Bs({entityStoreName:"receiptSettings",entityName:"receipt_settings",syncDeleted:!1});t.module("webregister.factories").constant("receiptSettingsStore",Gc);class jc extends Bs{constructor(){super({entityStoreName:"channels",entityName:"channels"})}getByChannelType(e){return We.resolve(this.dbStore.index("byChannelType").getAll(e))}}jc.$inject=[];const Qc=new jc;function Wc(e,...t){for(const n in e)e.hasOwnProperty(n)&&delete e[n];return Object.assign(e,...t)}class Hc{constructor(e,t,n){this.vdTracking=e,this.vdToastNotificationService=t,this.webRegisterStatusManager=n}getCustomerGroups(){return wi.all().then(e=>e.sort(this._compareCustomerGroups.bind(this)))}hasCustomer(){return pa.all().then(e=>Boolean(e[1]))}saveNewCustomer(e){return function(e){return Ke.post("/api/2.0/customers",e).then(Ue)}(e).then(t=>{const n=e.customer_group_id;return t.customer_group_id!==n&&(t.customer_group_id=n),this._syncCustomer(t)}).catch(e=>this._onSaveCustomerErrorNotify(e))}getCustomerGroup(e){const t=e&&e.customer_group_id;let n=We.resolve();return t&&(n=wi.get(t)),n}refreshCustomer(e){return We(t=>{var n;this.webRegisterStatusManager.isOnline()?(n=e.id,Ke.get("/api/2.0/customers/"+n).then(Ue)).then(n=>{t(this._syncCustomer(Wc(e,n)))}).catch(n=>{this.vdTracking.trackError("[customerManager] Failed to refresh customer",{data:{error:n}}),t(e)}):t(e)})}updateCustomer(e){return function(e){return Ke.put("/api/2.0/customers/"+e.id,e).then(Ue)}(e).then(e=>this._syncCustomer(e)).catch(e=>this._onSaveCustomerErrorNotify(e))}_compareCustomerGroups(e,t){if(is(e))return-1;if(is(t))return 1;const n=String(e.name).toLowerCase(),s=String(t.name).toLowerCase();return n<s?-1:n>s?1:0}_syncCustomer(e){return pa.syncData([e]).then(()=>e)}_onSaveCustomerErrorNotify(e){let t="Failed to save customer, please try again.";if(e){var n;const{field:s}=(null==e||null===(n=e.data)||void 0===n?void 0:n.errors)||{},a=s&&Object.keys(s)[0];!a||"postal_country_id"!==a&&"physical_country_id"!==a||"This value is not a valid country."!==s[a]||(t=`Please select a valid country for the customer's ${a.replace("_country_id","")} address.`)}return this.vdToastNotificationService.negative({message:t}),We.reject(e)}}function Yc(e){const t="VEND_WR_BROWSER_SESSION";let n,s=se();function a(){Xe.localStorage.setItem("VEND_WR_TIMESTAMP",Date.now())}function i(){const e=Xe.localStorage.getItem("VEND_WR_TIMESTAMP");if(e)return parseInt(e,10)}function r(){return Xe.localStorage.getItem(t)}function o(){Xe.localStorage.setItem(t,s),a()}function l(){n&&(je.cancel(n),n=void 0)}function c(){s=null,Xe.localStorage.removeItem(t),Xe.localStorage.removeItem("VEND_WR_TIMESTAMP"),l()}function d(){Xe.addEventListener("pagehide",c),He.$on("$destroy",(function(){c(),Xe.removeEventListener("pagehide",c)})),o(),n=je((function(){r()!==s?(e.negative({message:"Do you have another sell screen open? You should either close or refresh this window."}),l()):a()}),1e4)}return{ensureSingleWindow(){const e=We.defer();return r()?function(){const e=We.defer(),t=i(),n=Date.now()-t;let s;return n>1e4?e.resolve(!1):(s=1e4-n,s<2e3&&(s+=2e3),Je((function(){i()>=t?e.resolve(!0):e.resolve(!1)}),s)),e.promise}().then((function(t){t?e.reject():(d(),e.resolve())})):(d(),e.resolve()),e.promise}}}Hc.$inject=["vdTracking","vdToastNotificationService","webRegisterStatusManager"],t.module("webregister.managers").factory("customerManager",Hc),Yc.$inject=["vdToastNotificationService"],t.module("webregister.managers").factory("duplicateWindowManager",Yc),t.module("webregister.managers").factory("paymentManager",["retailerSettingsManager","cashMovementsManager","BalancesResource","giftCardsResource",function(e,t,n,a){return new class extends Et{constructor(...e){super(...e),s(this,"_paymentIntegrationReceiptMessage",null)}get paymentIntegrationReceiptMessage(){return this._paymentIntegrationReceiptMessage}set paymentIntegrationReceiptMessage(e){this._paymentIntegrationReceiptMessage=e}getPaymentPortalUrl({basePaymentPortalUrl:t,amount:n,currency:s,retailerPaymentTypeId:a,customer:i,registerId:r,referenceId:o}){const l=e.getRetailerUrl(),c=encodeURIComponent(l),d=i&&i.id?"&customer_id="+i.id:"",u=r?"&register_id="+r:"",h=o?"&reference_id="+o:"",m=-1===t.indexOf("?")?"?":"&";return Ye.trustAsResourceUrl(`\n        ${t}${m}amount=${n}${u}&currency=${s}&retailer_payment_type_id=${a}&origin=${c}${d}${h}\n      `)}isCashManagementPaymentType(e){const n=t.getCashManagementPaymentTypeId();return e.payment_type_id===n}getBalancesGiftCardPaymentsSummary(e){const t=[],s=[];return e.filter(e=>(e=>e.paymentType.type_id===hs.GIFT_CARD)(e)).forEach(e=>{s.push(n.getGiftCardByTransactionID(e.sourceId).then(n=>{const s=jr(n);s.sourceId=e.sourceId,t.push(s)}).catch(e=>(Qe.warn("[paymentManager] Failed to retrieve gift card by transaction id",e),We.reject(e))))}),We.all(s).then(()=>t)}getBigCommerceGiftCertPaymentsSummary(e){const t=[],n=[],s=e.filter(e=>(e=>e.paymentType.type_id===hs.BIGCOMMERCE_GIFT_CERT)(e));return 0===s.length?We.resolve([]):Qc.getByChannelType("bigcommerce").then(e=>{if(1===e.length)return s.forEach(s=>{n.push(a.getGiftCardByTransactionId(e[0].id,s.sourceId).then(e=>{e.sourceId=s.sourceId,e.transactions.push({id:s.sourceId,amount:s.amount,type:"REDEEMING",userId:"",createdAt:s.paymentDate}),t.push(e)}).catch(e=>(Qe.warn("[paymentManager] Failed to retrieve gift card by transaction id",e),We.reject(e))))}),We.all(n).then(()=>t)})}getActivePaymentType(e){return kc.all().then(t=>g(t,t=>t.type_id===e&&!t.deleted_at))}hasActiveIntegratedPaymentType(){return kc.all().then(e=>e.some(e=>e.type_id===hs.AFTER_PAY||e.config&&_e(e.config.url)))}}}]);class zc extends Et{constructor(e){super(),s(this,"_posState",void 0),s(this,"_whenInitialised",void 0),e.register("posStateManager")}init(){return this._whenInitialised||(this._whenInitialised=Bc.get("POS_STATE").then(e=>this._init(e))),this._whenInitialised.then(()=>this)}getClientId(){return this._posState.clientId}setClientId(e){this._setProperty("clientId",e)}getUser(){return this._posState.user}setUser(e){this._setProperty("user",e),e&&e.id&&this._addRecentLoggedUserId(e.id)}getOutletId(){return this._posState.outletId}setOutletId(e){this._setProperty("outletId",e)}getRegisterId(){return this._posState.registerId}setRegisterId(e){this._setProperty("registerId",e)}getLastUsedReceiptNumber(){return this._posState.lastUsedReceiptNumber}getLastUsedReceiptNumbersForRegisters(){return this._posState.receiptNumbersForRegisters}setLastUsedReceiptNumbersForRegisters(e){this._setProperty("receiptNumbersForRegisters",e)}getActiveSaleLocalId(){return this._posState.activeSaleLocalId}setActiveSaleLocalId(e){this._setProperty("activeSaleLocalId",e)}getTrainingModeEnabled(){return this._posState.trainingModeEnabled}setTrainingModeEnabled(e){this._setProperty("trainingModeEnabled",e)}getRecentLoggedUserIds(){return this._posState.recentLoggedUserIds||[]}_addRecentLoggedUserId(e){const t=this.getRecentLoggedUserIds(),n=t.indexOf(e);n>-1&&t.splice(n,1),t.unshift(e),this._setProperty("recentLoggedUserIds",t.slice(0,10))}getTourType(){return this._posState.tourType}setTourType(e){this._setProperty("tourType",e)}getTrainingModeOnboardingState(){return this._posState.trainingModeOnboardingState}setTrainingModeOnboardingState(e){this._setProperty("trainingModeOnboardingState",e)}getTourEnabled(){return this._posState.tourEnabled}setTourEnabled(e){this._setProperty("tourEnabled",e)}getInitialSyncComplete(){return this._posState.initialSyncComplete}setInitialSyncComplete(e){this._setProperty("initialSyncComplete",e)}getQkLayoutDuplication(e){const t=this._posState.qkLayoutDuplication||{};return Boolean(t[e])}getAllQkLayoutDuplications(){return Object.keys(this._posState.qkLayoutDuplication||{})}clearQkLayoutDuplication(e){return this.setQkLayoutDuplication(e,!1)}setQkLayoutDuplication(e,t=!0){const n=this._posState.qkLayoutDuplication||{},s=n[e];t?n[e]=!0:delete n[e],this._posState.qkLayoutDuplication=n,this._saveProperties(),t!==s&&this.emit("qkLayoutDuplicationChange",{buttonLayoutId:e,prevValue:s,newValue:Boolean(t)})}getFeatures(){return this._posState.features}setFeatures(e){this._setProperty("features",e)}getAllOpenRegisterRemindersSeen(){const e=this._posState.registerOpenRemindersSeen;return r({},e)}setAllOpenRegisterRemindersSeen(e){this._setProperty("registerOpenRemindersSeen",e)}getPaymentRecommendationCache(){return this._posState.paymentRecommendationCache}setPaymentRecommendationCache(e){this._setProperty("paymentRecommendationCache",e)}getPromotionSuggestion(){return this._posState.promoHelperSuggestion}setPromotionSuggestion(e){this._setProperty("promoHelperSuggestion",e)}getPromotionsHelperClicked(){return this._posState.promoHelperClicked}setPromotionsHelperClicked(){this._setProperty("promoHelperClicked",!0)}resetPromotionsHelperValues(){this._setProperty("promoHelperSuggestion",void 0),this._setProperty("promoHelperClicked",!1)}_init(e){this._posState=e||{}}_setProperty(e,t){const n=this._posState[e];this._posState[e]=t,this._saveProperties(),we(t,n)||this.emit(e+"Change",{prevValue:n,newValue:t})}_saveProperties(){Bc.put("POS_STATE",this._posState)}}zc.$inject=["wrDebugTools"],t.module("webregister.managers").service("posStateManager",zc);const Jc=({lineItems:e},t)=>e.reduce((e,n)=>{const s=n.adjusted||n.isReturn||n.confirmed;return n.product.id!==t||s?e:c.add(e,n.quantity)},0),Xc=(e,t)=>{const n=t.min_units,s=t.max_units,a=null===n||!c.isFinite(n)||c.vn(e).gte(n),i=null===s||!c.isFinite(s)||c.vn(e).lte(s);return a&&i},Zc=["0","1"];class ed{constructor(e,t,n){this.syncManager=e,this.registerManager=t,this.posStateManager=n,s(this,"_basePriceBook",void 0),s(this,"_whenInitialised",void 0),this._basePriceBook=null}init(){return this._whenInitialised||(this._whenInitialised=this.syncManager.whenCompleteEntityDataAvailable("priceBooks").then(()=>(Pc.on("sync",this._determineBasePriceBook,this),this._determineBasePriceBook()))),this._whenInitialised}get basePriceBook(){return this._basePriceBook}get PRICE_BOOK_TYPE_BASE(){return"BASE"}getPriceBookInfoForLineItem(e,t){return $c.getByProductId(t.getProductId()).then(n=>((e,t,n)=>{const s=Jc(e,t.product.id);return n.filter(e=>Xc(s,e))})(e,t,n)).then(e=>this._resolvePriceBooksAndCustomerGroups(e)).then(t=>this._filterPriceBookInfo(e,t))}getBasePriceBookProduct(e){return $c.getByProductId(e).then(e=>{let t;return this.basePriceBook&&(t=g(e,{price_book_id:this.basePriceBook.id})),t})}_determineBasePriceBook(){return Pc.all().then(e=>{const t=v(e,"id");this._basePriceBook=g(t,{type:"BASE"})})}_resolvePriceBooksAndCustomerGroups(e){return We.all(p(e,e=>{const t={priceBookProduct:e};return Pc.get(e.price_book_id).then(e=>{if(t.priceBook=e,e&&e.customer_group_id)return wi.get(e.customer_group_id).then(e=>{t.customerGroup=e})}).then(()=>t)}))}_filterPriceBookInfo(e,t){return F(t,({priceBook:t,priceBookProduct:n,customerGroup:s})=>t?this._passesPriceBookConditions(e,t,s):(Qe.warn("[PriceBook Manager] No pricebook associated with this pricebook product",n),!1))}_passesPriceBookConditions(e,t,n){return!!this._isPriceBookAvailableInStore(t)&&(!!this._isCurrentOutlet(t.outlet_id)&&(!!this._isCustomerInApplicableGroup(e.customer,n)&&!!this._isCurrentDateWithinDateRange(t.valid_from,t.valid_to)))}_isPriceBookAvailableInStore(e){return Zc.indexOf(String(e.restrict_to_platform_key))>=0}_isCurrentOutlet(e){return null===e||e===this.posStateManager.getOutletId()}_isCustomerInApplicableGroup(e,t){return!(t&&!is(t))||!(!e||e.customer_group_id!==t.id)}_isCurrentDateWithinDateRange(e,t){const n=this._getDateInActiveOutletTimezone(),s=n.isBefore(e,"day"),a=n.isSameOrAfter(t,"day");return!s&&!a}_getDateInActiveOutletTimezone(){const e=this.registerManager.getActiveOutlet().time_zone,t=u().tz(e);return u(t.format("YYYY-MM-DD"))}}ed.$inject=["syncManager","registerManager","posStateManager"],t.module("webregister.managers").service("priceBookManager",ed);class td{constructor(e,t,n,a){this.registerManager=e,this.priceBookManager=t,this.taxManager=n,this.retailerSettingsManager=a,s(this,"_whenInitialised",void 0)}init(){return this._whenInitialised||(this._whenInitialised=this.priceBookManager.init()),this._whenInitialised}priceLineItem(e,t,n={}){return n.forceConfirmed||t.isReturn||t.taxInfo&&t.confirmed?We.resolve(t):this._updateLineItemTaxInfo(t,n).then(()=>this._getPriceInfoForLineItem(e,t,n)).then(e=>this._setLineItemPriceInfo(t,e))}_updateLineItemTaxInfo(e,t){return We((n,s)=>{let a=t&&t.forceRefresh;e.adjusted&&(a=!1),!e.taxInfo||a?this.taxManager.getTaxForProduct(e.product).then(t=>{e.taxInfo=t}).then(()=>n(e),s):n(e)})}_getPriceInfoForLineItem(e,t,n={}){return t.isGiftCard()?this._getPriceInfoForGiftCardLineItem(t):this.priceBookManager.getPriceBookInfoForLineItem(e,t).then(e=>this._determinePriceInformation(t,e,n))}_getPriceInfoForGiftCardLineItem(e){return We(t=>{const n=e.basePrice,s=this.taxManager.calculateTaxRate(e.taxInfo);t({base:{price:n,tax:this.taxManager.calculateTax(n,s),loyaltyValue:"0",explicitLoyaltyValue:!0}})})}_determinePriceInformation(e,t,n={}){const s=this.taxManager.calculateTaxRate(e.taxInfo),a=e.promotion&&e.promotion.lineItemPromotion,i=n&&n.lineItemPromotion;let r,o,l;(i||a)&&(i?(l=n.lineItemPromotion,o=n.promotionDetails):(l=e.promotion.lineItemPromotion,o=e.promotion.promotionDetails),l.remove&&(l=null,o=null));const d=this._getBasePriceBookPriceInfo(t,s);return b(t,({priceBook:e,priceBookProduct:t})=>{if(e.type!==this.priceBookManager.PRICE_BOOK_TYPE_BASE){const n=this._calculatePriceBookPriceInfo({priceBook:e,priceBookProduct:t,taxRate:s});if(r){const e=r.price,t=c.vn(n.price);(t.lt(e)||t.eq(e)&&c.vn(n.loyaltyValue).gt(r.loyaltyValue))&&(r=n)}else r=n}}),o?{base:d,promotion:r,promotionDetails:o,lineItemPromotion:l}:{base:d,promotion:r}}_getBasePriceBookPriceInfo(e,t){let n;return b(e,({priceBook:e,priceBookProduct:s})=>{if(e.type===this.priceBookManager.PRICE_BOOK_TYPE_BASE)return n=this._calculatePriceBookPriceInfo({priceBook:e,priceBookProduct:s,taxRate:t}),!1}),n}_calculatePriceBookPriceInfo({priceBook:e,priceBookProduct:t,taxRate:n}){const{price:s}=t,a=this.taxManager.calculateTax(s,n);return{price:s,tax:a,loyaltyValue:this._calculateLoyaltyValue(s,a,t),explicitLoyaltyValue:this.retailerSettingsManager.isLoyaltyEnabled()&&c.isFinite(t.loyalty_value),priceBook:e}}_setLineItemPriceInfo(e,t){return We((n,s)=>{const{base:a,promotion:i,promotionDetails:r,lineItemPromotion:o}=t;if(!a||!c.isFinite(a.price))return s(new Error("No base price book found for line item: "+e));let{price:l,tax:d,loyaltyValue:u,explicitLoyaltyValue:h}=e;if(e.adjusted){const t=this.taxManager.calculateTaxRate(e.taxInfo);d=this.taxManager.calculateTax(l,t),h||(u=this._calculateLoyaltyValue(l,d))}else o?(l=c.add(o.unit_price,o.unit_discount),d=c.add(o.unit_tax,o.unit_tax_discount),u=o.loyalty_value,h=o.explicit_loyalty_value):i&&c.isFinite(i.price)?(l=i.price,d=i.tax,u=i.loyaltyValue,h=i.explicitLoyaltyValue):(l=a.price,d=a.tax,u=a.loyaltyValue,h=a.explicitLoyaltyValue);this.retailerSettingsManager.isLoyaltyEnabled()||(u=0,h=!1),o||(e.bestPriceBookInfo={price:l,tax:d,loyaltyValue:u,explicitLoyaltyValue:h}),e.promotion=i||o?new Tc({priceBook:i&&i.priceBook||null,lineItemPromotion:o,promotionDetails:r}):void 0,e.basePrice=a.price,e.baseTax=a.tax,e.price=l,e.tax=d,e.loyaltyValue=u,e.explicitLoyaltyValue=h,n(e)})}_calculateLoyaltyValue(e,t,n){if(!this.retailerSettingsManager.isLoyaltyEnabled())return 0;if(n&&c.isFinite(n.loyalty_value))return n.loyalty_value;let s;return s=this.registerManager.isTaxInclusive()?c.add(e,t):e,c.round(c.multiply(s,this.retailerSettingsManager.getLoyaltyRatio()),5)}}td.$inject=["registerManager","priceBookManager","taxManager","retailerSettingsManager"],t.module("webregister.managers").service("unitPriceManager",td);const nd=(e,t,n)=>{const{rate:s,rules:a}=e;return a&&a.length&&a[0].type&&"threshold"===a[0].type&&n===a[0].tax_code&&c.vn(t).lt(a[0].value)?0:c.multiply(c.vn(t),s)},sd=(e,t,n)=>{const{quantity:s,price:a,basePrice:i}=t,r=c.multiply(a,s),o=c.multiply(i,s);let l=0;if(e.returnDiscountPercentage)t.isReturn&&(l=c.multiply(e.returnDiscountPercentage,r));else if(c.vn(e.discountPercentage).gt(0)){l=c.multiply(e.discountPercentage,r);e.isConfirmed()&&!t.confirmed&&(l=0)}const d=((e,t)=>{const{quantity:n,price:s,basePrice:a}=e,i=e.taxInfo.rates,r=e.getTaxCode(),o=c.vn(n).eq(0)?"0":c.divide(t,n),l=c.subtract(s,o);return i.map(e=>({rate_id:e.id,rate:e,total_tax:c.multiply(n,nd(e,s,r)),total_tax_after_sale_discount:c.multiply(n,nd(e,l,r)),base_total_tax:c.multiply(n,nd(e,a,r))}))})(t,l),u=d.reduce((e,t)=>c.add(e,c.subtract(t.total_tax,t.total_tax_after_sale_discount)),0),h=d.reduce((e,t)=>c.add(e,t.total_tax),0),m=d.reduce((e,t)=>c.add(e,t.base_total_tax),0),g=h,p=m,v=c.add(r,h),y=c.add(o,m);return[{exclusivePrice:r,exclusiveBasePrice:o,saleDiscount:l,saleDiscountTax:u,tax:g,baseTax:p,inclusivePrice:v,inclusiveBasePrice:y,displayPrice:n?v:r,displayBasePrice:n?y:o},d]};class ad{constructor(e,t,n,a,i){this.vdTracking=e,this.priceBookManager=t,this.registerManager=n,this.taxManager=a,this.unitPriceManager=i,s(this,"noTaxGroup",null),s(this,"whenInitialised",void 0)}init(){return this.whenInitialised||(this.whenInitialised=We.all([this.taxManager.init(),this.priceBookManager.init(),this.unitPriceManager.init()]).then(()=>this.determineNoTaxGroup())),this.whenInitialised}determineNoTaxGroup(){return this.taxManager.getNoTaxGroup().then(e=>{this.noTaxGroup=e})}calculateDisplayBasePrice(e,t){let n;if(this.registerManager.isTaxInclusive()){const s=this.taxManager.calculateTaxRate(t),a=c.round(c.multiply(e,s),5);n=c.add(e,a)}else n=e;return c.round(n,2)}getBasePriceForProduct(e){return e||Qe.debug("[Price Manager] Missing product id when attempting to get base price for product"),We.all({basePriceBookProduct:this.priceBookManager.getBasePriceBookProduct(e),taxInfo:this.taxManager.getTaxForProduct(e)}).then(({basePriceBookProduct:e,taxInfo:t})=>e?this.calculateDisplayBasePrice(e.price,t):null)}updateLineItemsDisplayValues(e,t){const n=c.round(this.calculateLineItemDisplayPrice(e),5),s=this.calculateLineItemDisplayDiscountInfo(e);b(t.lineItems,t=>{t.localId===e.localId&&(t.displayPrice=n,t.displayDiscountPercent=s.discountPercent,t.displayDiscount=c.round(s.discount,5),t.displayMarkupPercent=s.markupPercent,t.displayBasePrice=c.round(this.calculateDisplayPrice(t.basePrice,e.baseTax),5))})}updateLineItemPricesAndTaxes(e,t,n){return this.unitPriceManager.priceLineItem(t,e,n).then(this.updateLineItemsDisplayValues.bind(this,e,t))}recalculateSale(e,t={}){const n={forceRefresh:!0,forceConfirmed:t.forceConfirmed};return We.all(p(e.lineItems,t=>this.updateLineItemPricesAndTaxes(t,e,n))).then(this.updateSaleDiscountPercentage.bind(this,e)).then(this.updateLineItems.bind(this,e,t)).then(this.updateSaleDiscount.bind(this,e)).then(this.updateTotals.bind(this,e)).then(this.updateFinals.bind(this,e)).then(this.updateSaleStatus.bind(this,e))}calculateLineItemTotalTaxRate(e){return this.taxManager.calculateTaxRate(e.taxInfo)}calculateTaxInclusivePriceComponents(e,t){const n=c.divide(e,c.add(1,t));return{tax:c.subtract(e,n),price:n}}calculateTaxExclusivePriceComponents(e,t){const n=c.multiply(e,t);return{tax:c.round(n,5),price:c.round(e,5)}}calculatePriceComponents(e,t){return this.registerManager.isTaxInclusive()?this.calculateTaxInclusivePriceComponents(e,t):this.calculateTaxExclusivePriceComponents(e,t)}calculateDisplayPrice(e,t){let n;return n=this.registerManager.isTaxInclusive()?c.add(e,t):e,n}calculateLineItemDisplayPrice(e){return this.calculateDisplayPrice(e.price,e.tax)}calculateLineItemDisplayBasePrice(e){return this.calculateDisplayPrice(e.basePrice,e.baseTax)}calculateLineItemDisplayDiscountInfo(e){const t=this.calculateLineItemDisplayBasePrice(e),n=this.calculateLineItemDisplayPrice(e),s=c.subtract(t,n),a=c.subtract(n,t);let i=0,r=0;0!==parseFloat(t)&&(i=c.divide(s,t),r=c.divide(a,t));return{discount:s,discountPercent:parseFloat(c.round(c.multiply(i,100),2)),markupPercent:parseFloat(c.round(c.multiply(r,100),2))}}createOriginalTotals(e){const t=e.isExchangeCompleted(),n=be(e.lineItems,(e,n)=>((n.isReturn||!t&&n.confirmed)&&(e.exclusive=c.add(e.exclusive,n.totals.exclusivePrice),e.inclusive=c.add(e.inclusive,n.totals.inclusivePrice),e.tax=c.add(e.tax,n.totals.tax)),e),{exclusive:0,inclusive:0,tax:0,discount:{price:e.discount&&e.discount.price,tax:e.discount&&e.discount.tax}});e.returnFor&&(e.originalReturnTotals=n),(e.isConfirmed()||t)&&(e.originalConfirmedTotals=n)}createOrUpdateReturnDiscount(e){if(!e.discount)return e;e.originalReturnTotals||this.createOriginalTotals(e);const t=this.registerManager.isTaxInclusive(),n=e.discount.taxInfo&&e.discount.taxInfo.id===this.noTaxGroup.id,s=be(e.lineItems,(e,s)=>s.isReturn?(!n&&t?e.price=c.add(e.price,s.totals.inclusivePrice):(e.price=c.add(e.price,s.totals.exclusivePrice),e.tax=c.add(e.tax,s.totals.tax)),e):e,{price:0,tax:0});if(!n&&t){const t=c.divide(s.price,e.originalReturnTotals.inclusive);return e.discount.price=c.multiply(e.originalReturnTotals.discount.price,t),e.discount.tax=c.multiply(e.originalReturnTotals.discount.tax,t),e.displayDiscount=c.add(e.discount.price,e.discount.tax),e}c.isFinite(s.tax)&&c.isFinite(e.originalReturnTotals.tax)||this.vdTracking.trackError("[PriceManager] createOrUpdateReturnDiscount NaN values",{data:{sale:e.toJSON(),currentTotals:s}});const a=c.divide(s.price,e.originalReturnTotals.exclusive);if(e.discount.price=c.multiply(e.originalReturnTotals.discount.price,a),c.vn(s.tax).eq(0)||c.vn(e.originalReturnTotals.tax).eq(0))e.discount.tax=0;else{const t=c.divide(s.tax,e.originalReturnTotals.tax);e.discount.tax=c.multiply(e.originalReturnTotals.discount.tax,t)}return e.displayDiscount=t?c.add(e.discount.price,e.discount.tax):e.discount.price,e}totalSale(e){return this.registerManager.isTaxInclusive()&&this.recalculateLineItemPriceComponents(e),this.updateSaleDiscountPercentage(e),this.updateLineItems(e),this.updateSaleDiscount(e),this.updateTotals(e),this.updateFinals(e),this.updateSaleStatus(e),e}recalculateLineItemPriceComponents(e){e.lineItems.forEach(e=>{if(e.taxInfo.id!==this.noTaxGroup.id){const t=this.taxManager.calculateTaxRate(e.taxInfo),n=this.calculateTaxInclusivePriceComponents(c.round(c.add(e.price,e.tax),5),t);e.price=n.price,e.tax=n.tax}})}updateTotals(e){let t={exclusivePrice:0,exclusiveBasePrice:0,tax:0,baseTax:0,inclusivePrice:0,inclusiveBasePrice:0};t=e.lineItems.reduce((e,t)=>({exclusivePrice:c.add(e.exclusivePrice,t.totals.exclusivePrice),exclusiveBasePrice:c.add(e.exclusiveBasePrice,t.totals.exclusiveBasePrice),tax:c.add(e.tax,t.totals.tax),baseTax:c.add(e.baseTax,t.totals.baseTax),inclusivePrice:c.add(e.inclusivePrice,t.totals.inclusivePrice),inclusiveBasePrice:c.add(e.inclusiveBasePrice,t.totals.inclusiveBasePrice)}),t),e.totals=r(r({},e.totals),t);const n=U(p(e.lineItems,e=>e.taxInfo.rates));if(e.totals.rates=Me(n,"id"),this.registerManager.hasCashDiscounting()){const n=this.calculateSaleServiceFee(t.inclusivePrice);let s=this.calculateServiceFeePaid(e.payments),a=this.calculateCashDiscount(e.payments);c.vn(s).gt(n)&&(s=n),c.vn(c.add(n,a)).lt(s)&&(a=c.subtract(s,n));const i=c.add(t.inclusivePrice,n,a);c.vn(i).isNeg()||e.userRemovedSaleServiceFee?(e.totals.saleServiceFee=0,e.totals.saleServiceFeePaid=0,e.totals.cashDiscount=0):(e.totals.saleServiceFee=n,e.totals.saleServiceFeePaid=s,e.totals.cashDiscount=a)}}updateFinals(e){let t=!1,n=e.totals.exclusivePrice,s=e.totals.tax;const a=this.calculateTips(e.payments),i=e.isConfirmed();e.hasDiscount()&&(n=c.subtract(e.totals.exclusivePrice,e.discount.price),s=c.subtract(e.totals.tax,e.discount.tax));const r=c.add(n,e.totals.saleServiceFee,e.totals.cashDiscount,s,a);e.finals.exclusivePrice=c.round(n,5),e.finals.inclusivePrice=c.round(r,2),e.finals.tax=c.round(s,5),e.finals.tip=c.round(a,2),e.finals.subtotal=this.calculateSubtotal(e),e.finals.subtotal=c.round(e.finals.subtotal,5);let o=!1;e.finals.taxes=e.lineItems.reduce((e,{taxInfo:n,taxComponents:s})=>{const a=(s||[]).length>=3;return a&&(o=!0),n.id===this.noTaxGroup.id&&(t=!0),s.forEach(t=>{e[t.rate_id]=e[t.rate_id]||{total:0,name:t.rate.name,removable:!a&&!i,rate:t.rate},e[t.rate_id].total=c.add(e[t.rate_id].total,t.total_tax_after_sale_discount)}),e},{}),e.finals.taxDisplayProperties&&(this.updateTaxDisplayProperties(e,e.finals.taxes,t),e.finals.taxDisplayProperties.showRemoveAll=o&&!i)}updateSaleDiscount(e){const t=e.lineItems.reduce((e,t)=>c.add(e,c.vn(t.totals.saleDiscount)),0),n=e.lineItems.reduce((e,t)=>c.add(e,c.vn(t.totals.saleDiscountTax)),0);c.vn(c.add(t,n)).abs().gt(0)?(e.discount?(e.discount.price=t,e.discount.tax=n):e.discount=new Ec({price:t,tax:n}),e.discount.taxInfo=this.noTaxGroup):e.discount=null}updateLineItems(e){const t=e.returnDiscountPercentage?e.returnDiscountPercentage:e.discountPercentage;let n=c.multiply(t,c.round(e.totals.maxSaleDiscount,2));if(e.lineItems.forEach(t=>{const[s,a]=sd(e,t,this.registerManager.isTaxInclusive());if(t.totals=s,t.taxComponents=a,s.saleDiscount){const e=c.add(s.saleDiscountTax,s.saleDiscount);n=this.registerManager.isTaxInclusive()?c.subtract(n,e):c.subtract(n,s.saleDiscount)}}),n&&e.lineItems.length){const t=e.lineItems.length-1;if(this.registerManager.isTaxInclusive()){if(!e.lineItems[t].taxComponents.length)return;const s=e.lineItems[t].taxComponents[0].rate.rate,a=this.calculateTaxInclusivePriceComponents(n,s);e.lineItems[t].totals.saleDiscount=c.add(e.lineItems[t].totals.saleDiscount,a.price),e.lineItems[t].totals.saleDiscountTax=c.add(e.lineItems[t].totals.saleDiscountTax,a.tax)}else e.lineItems[t].totals.saleDiscount=c.add(e.lineItems[t].totals.saleDiscount,n)}}updateSaleDiscountPercentage(e){const t=this.registerManager.isTaxInclusive();e.totals.maxSaleDiscount=Sc(e,t),e.discountPercentage=fc(e,t)}updateSaleStatus(e){return e.displayStatus=Cc(e),e}calculateSaleServiceFee(e){if(!this.registerManager.hasCashDiscounting())return;const t=this.registerManager.getCashDiscountingRate();return c.round(c.multiply(e,t))}calculateTips(e){return e.reduce((e,t)=>c.vn(t.tipAmount).gt(0)?c.add(e,t.tipAmount):e,0)}calculateCashDiscount(e){if(!this.registerManager.hasCashDiscounting())return 0;const t=this.registerManager.getCashDiscountingRate(),n=e.reduce((e,t)=>_s(t.paymentType.type_id)?c.add(e,t.amount):e,0),s=c.multiply(n,t),a=c.multiply(s,-1);return c.round(a)}calculateServiceFeePaid(e){const t=this.registerManager.getCashDiscountingRate(),n=c.divide(t,c.add(1,t)),s=e.reduce((e,t)=>_s(t.paymentType.type_id)?e:c.add(e,t.amount),0);return c.round(c.multiply(s,n))}updateTaxDisplayProperties(e,t,n){let s=Te(t);if(e.finals.taxDisplayProperties.showTaxBreakdown=!0,n&&s>1?(delete t[this.noTaxGroup.rates[0].id],s=Te(t)):(n||0===s)&&(e.finals.taxDisplayProperties.showTaxBreakdown=!1),s>1)e.finals.taxDisplayProperties.taxName=s+" Taxes";else if(1===s){const n=t[Ee(t)[0]];e.finals.taxDisplayProperties.taxName=""+n.name,"No Tax"!==n.name&&(e.finals.taxDisplayProperties.taxName+=` ${c.multiply(n.rate.rate,100)}%`)}else e.finals.taxDisplayProperties.taxName=""}calculateSubtotal(e){return this.registerManager.isTaxInclusive()?e.finals.exclusivePrice:e.totals.exclusivePrice}}ad.$inject=["vdTracking","priceBookManager","registerManager","taxManager","unitPriceManager"],t.module("webregister.managers").factory("priceManager",ad);class id extends Et{constructor(e,t,n,a,i,r,o,l,c,d){super(),this.registerManager=e,this.syncManager=t,this.vdTracking=n,this.posStateManager=a,this.expeditedSyncManager=r,this.QuickKeysLayoutDataAdaptor=l,this.vdToastNotificationService=c,this.userManager=d,s(this,"_areDuplicationsComplete",void 0),s(this,"_getProductInformation",void 0),s(this,"_quickKeyLayout",null),s(this,"_whenInitialised",void 0),s(this,"defaultNewLayoutName","New Layout"),i.register("quickKeysManager"),this._getProductInformation=e=>o.get(e)}init(){return this._whenInitialised||(this._whenInitialised=this.syncManager.whenCompleteEntityDataAvailable("quickKeyLayouts").then(()=>this._init())),this._whenInitialised}get quickKeyLayout(){return this._quickKeyLayout}createLayoutDataAdaptor(){return new this.QuickKeysLayoutDataAdaptor({getProductFn:this._getProductInformation})}isCurrentLayout(e){return Boolean(this._quickKeyLayout&&this._quickKeyLayout.id===e.id)}getAllQuickKeyLayouts(){return Vs.all()}createLayout(e){return function(e){return Ke.post("/api/2.0/button_layouts",{name:e}).then(Ue)}(e).then(e=>Vs.syncData([e]).then(()=>e)).catch(e=>(this.vdTracking.trackError("[QuickKeysManager] Error creating new button layout",{data:{error:e}}),this.vdToastNotificationService.negative({message:"Sorry there was a problem creating this layout, please try again."}),We.reject(e)))}navigateToEditState(e,t){return this.getAllQuickKeyLayouts().then(n=>{const s=Boolean(n.length);let a=We.resolve();return s||(a=this.registerManager.setCurrentQuickKeyLayout(e)),a.catch(e=>{this.vdTracking.trackError("[AddQuickKeyLayout] Error setting new layout as the current layout.",{data:{error:e}})}).finally(()=>et.go(sn,{layoutId:e.id,newLayout:t||!1}))})}duplicateLayout(e){return function(e){return Ke.put(`/api/2.0/button_layouts/${e.id}/actions/duplicate`,null).then(Ue)}(e).then(e=>{this.posStateManager.setQkLayoutDuplication(e.id),this._expediteDuplications()}).catch(e=>(this.vdTracking.trackError("[QuickKeysManager] Error duplicating button layout",{data:{error:e}}),We.reject(e)))}updateLayout(e,t){return function(e,t){return Ke.put("/api/2.0/button_layouts/"+e,t).then(Ue)}(e,t).then(e=>Vs.syncData([e]).then(()=>e)).catch(e=>(this.vdTracking.trackError("[QuickKeysManager] Error updating button layout",{data:{error:e}}),We.reject(e)))}deleteLayout(e){return function(e){return Ke.delete("/api/2.0/button_layouts/"+e.id).then(()=>({id:e.id,deleted_at:ee.utc().format()}))}(e).then(e=>Vs.syncData([e])).catch(e=>(this.vdTracking.trackError("[QuickKeysManager] Error deleting button layout",{data:{error:e}}),We.reject(e)))}isQuickKeysEnabled(){const e=this.registerManager.getActiveRegister();return Boolean(e)&&e.is_quick_keys_enabled}hasPermission(){return this.userManager.hasPermission(ts.QUICK_KEYS_MANAGE)}_init(){return this.registerManager.on("activeRegisterChange",this._updateRegisterQuickKeysState,this),Vs.on("sync",this._onQuickKeyLayoutSync,this),We.all([this._updateRegisterQuickKeysState(),this._updateDuplicationsInProgress().then(()=>this._expediteDuplications())])}_updateRegisterQuickKeysState(){return this._resolveLayout()}_resolveLayout(){return We((e,t)=>{const n=this.registerManager.getActiveRegister(),s=n&&n.button_layout_id;s?Vs.get(s).then(e=>e||this.syncManager.whenCompleteEntityDataAvailable("quickKeyLayouts").then(()=>Vs.get(s))).then(e,t):e(null)}).then(e=>this._setLayout(e))}_setLayout(e){const t=this._quickKeyLayout;let n;return n=t?!e||t.id!==e.id||t.version!==e.version:Boolean(e),this._quickKeyLayout=e||null,n&&this.emit("quickKeyLayoutChange",{quickKeyLayout:e}),this._quickKeyLayout}_onQuickKeyLayoutSync(e){if(this._updateDuplicationsInProgress(),!this._quickKeyLayout)return;const t=this._quickKeyLayout.id,n=g(e.updated,{id:t});if(n)this._setLayout(n);else{g(e.removed,{id:t})&&this._setLayout(null)}}_updateDuplicationsInProgress(){const e=this.posStateManager.getAllQkLayoutDuplications();return We.all(e.map(e=>this._updateDuplicationStatus(e)))}_updateDuplicationStatus(e){return Vs.get(e).then(t=>{(t&&t.version)>0&&this.posStateManager.clearQkLayoutDuplication(e)})}_expediteDuplications(){this._areDuplicationsComplete||(this._areDuplicationsComplete=()=>!this.posStateManager.getAllQkLayoutDuplications().length),this.expeditedSyncManager.expedite({isSyncComplete:this._areDuplicationsComplete}).catch(()=>this._onDuplicationTimeout())}_onDuplicationTimeout(){this.posStateManager.getAllQkLayoutDuplications().forEach(e=>this.posStateManager.clearQkLayoutDuplication(e))}}id.$inject=["registerManager","syncManager","vdTracking","posStateManager","wrDebugTools","expeditedSyncManager","productsStore","QuickKeysLayoutDataAdaptor","vdToastNotificationService","userManager"],t.module("webregister.managers").service("quickKeysManager",id);class rd extends Et{constructor(e,t,n,a,i,r,o){super(),this.vdTracking=e,this.posStateManager=t,this.receiptSettingsStore=n,this.registersResource=a,this.wrDebugTools=i,this.vdCurrencySettings=r,this.vdFeatureManager=o,s(this,"_activeOutlet",void 0),s(this,"_activeRegister",void 0),s(this,"_activeRegisterReceiptLogo",void 0),s(this,"_activeRegisterReceiptSettings",void 0),s(this,"_emulateRegisterOpen",void 0),s(this,"_waitForReceiptStoresToRefresh",void 0),s(this,"_whenInitialised",void 0),s(this,"isRetailerMultiTimezone",!1),this.wrDebugTools.register("registerManager"),this._activeOutlet=null,this._activeRegister=null,this._activeRegisterReceiptSettings={},this._activeRegisterReceiptLogo=null,this._emulateRegisterOpen=!1,Hl.on("sync",this._onOutletsSync,this),qs.on("sync",this._onRegistersSync,this),this.receiptSettingsStore.on("sync",this._onReceiptSettingsSync,this),this.on("activeRegisterChange",this._onActiveRegisterChange,this),this.posStateManager.on("trainingModeEnabledChange",this._onTrainingModeEnabledChange,this)}init(){return this._whenInitialised||(this._whenInitialised=this.posStateManager.init().then(()=>{const e=this.posStateManager.getRegisterId();if(this._emulateRegisterOpen=this.posStateManager.getTrainingModeEnabled(),e)return We.all({register:qs.get(e),outlet:Hl.get(this.posStateManager.getOutletId()),allOutlets:Hl.all()})}).then(e=>(e&&(this._setActiveRegister(e.register),this._setActiveOutlet(e.outlet),this._determineIsMultiTimezone(e.allOutlets)),this))),this._whenInitialised}getAllRegistersByOutlet(e={}){const{restrictedOutlets:t=[]}=e;return qs.all().then(e=>{const n={},s=[];return b(e,e=>{const a=e.outlet_id;if(!t.length||D(t,a)){let t=n[a];t?t.registers.push(e):(t={registers:[e]},n[a]=t,s.push(Hl.get(a).then(e=>(t.outlet=e,t))))}}),We.all(s).then(e=>this._sortRegistersByOutlet(e))})}setActiveRegister(e,t){t.id!==e.outlet_id&&this.vdTracking.trackError("Selected register does not belong to selected outlet",{data:{register:e,outlet:t}}),this._setActiveRegister(e),this._setActiveOutlet(t),this.posStateManager.setRegisterId(e.id),this.posStateManager.setOutletId(t.id),this.setLastUsedReceiptNumber(e.invoice_sequence)}getActiveRegister(){return this._activeRegister}getRegisterById(e){return qs.get(e)}getOutletById(e){return Hl.get(e)}getActiveOutlet(){return this._activeOutlet}isActiveRegisterOpen(){return this._emulateRegisterOpen||Boolean(this._activeRegister&&this._activeRegister.is_open)}isTaxInclusive(){return Boolean(this._activeOutlet&&"inclusive"===this._activeOutlet.display_prices)}isLowInventoryWarningEnabled(){if(!this._activeOutlet||!this._activeOutlet.attributes)return!1;const e=g(this._activeOutlet.attributes,{key:"low_stock_warning"});return e&&"1"===e.value}isAddCustomerEnabled(){if(!this._activeOutlet||!this._activeOutlet.attributes)return!1;const e=g(this._activeOutlet.attributes,{key:"add_customer_prompt"});return!e||"1"===e.value}waitForSelectedRegister(){return We(e=>{this._activeRegister?e(this._activeRegister):this.once("activeRegisterChange",t=>{e(t.activeRegister)})})}waitForOpenRegister(){const e=We.defer();function t(t){e.resolve(t.register)}return this.isActiveRegisterOpen()?e.resolve(this._activeRegister):this._activeRegister?this.once("activeRegisterOpen",t):this.posStateManager.once("registerIdChange",n=>{this._activeRegister&&this._activeRegister.id===n.newValue||this.vdTracking.trackError("POS state register ID does not match selected register",{data:{activeRegister:this._activeRegister,updatedRegisterId:n.newValue}}),this.isActiveRegisterOpen()?e.resolve(this._activeRegister):this.once("activeRegisterOpen",t)}),e.promise}hasCashDiscounting(){return Boolean(this.vdFeatureManager.get("cash_discounting")&&this._getActiveOutletAttribute("cash_discounting_rate"))}getCashDiscountingRate(){const e=this._getActiveOutletAttribute("cash_discounting_rate");return e&&c.round(c.divide(e,100))}getDisplayCashDiscountingRate(){return this._getActiveOutletAttribute("cash_discounting_rate")}getNextReceiptNumberDetails(){let e=this.getLastUsedReceiptNumber()+1;return this.posStateManager.getTrainingModeEnabled()?e=99999:this.setLastUsedReceiptNumber(e),{number:e,prefix:this._activeRegister.invoice_prefix,suffix:this._activeRegister.invoice_suffix}}getActiveRegisterReceiptLogo(){return this._activeRegisterReceiptLogo}getActiveRegisterReceiptSettings(){return this._activeRegisterReceiptSettings}setCurrentQuickKeyLayout(e){const t=this.getActiveRegister();return this.registersResource.updateRegister(t,{button_layout_id:e.id}).then(e=>qs.syncData([e])).catch(e=>(this.vdTracking.trackError("[Register Manager] Error setting the current quick key layout",{data:{error:e}}),We.reject(e)))}enableQuickKeys(e){const t=this.getActiveRegister(),n=t.button_layout_id,s={is_quick_keys_enabled:e};return n&&(s.button_layout_id=n),this.registersResource.updateRegister(t,s).then(e=>qs.syncData([e])).catch(e=>(this.vdTracking.trackError("[Register Manager] Error enabling quick keys for register",{data:{error:e}}),We.reject(e)))}getLastUsedReceiptNumber(){const e=this._activeRegister.id,n=this.posStateManager.getLastUsedReceiptNumbersForRegisters();if(!n||t.isUndefined(n[e])){const e=this.posStateManager.getLastUsedReceiptNumber();return this.setLastUsedReceiptNumber(e),e}return n[e]}setLastUsedReceiptNumber(e){const n=this._activeRegister.id,s=this.posStateManager.getLastUsedReceiptNumbersForRegisters()||{},a=s[n];(t.isUndefined(a)||e>a)&&(s[n]=e,this.posStateManager.setLastUsedReceiptNumbersForRegisters(s))}activeRegisterDaysOpen(){const e=this.getActiveRegister(),t=this.getActiveOutlet(),n=e&&e.register_open_time,s=t&&t.time_zone;if(!n||!s)return 0;const a=u().startOf("day").tz(s),i=u(n).startOf("day").tz(s);return a.diff(i,"days")}isRegisterOpenReminderNeeded(){const e=this.activeRegisterDaysOpen()>0;return Boolean(this.isActiveRegisterOpen()&&e&&!this.isRegisterOpenReminderSeen())}isRegisterOpenReminderSeen(){const e=this.getActiveRegister(),t=e.id,n=e.register_open_sequence_id,s=this.posStateManager.getAllOpenRegisterRemindersSeen()[t];return Boolean(s&&s===n)}setOpenRegisterReminderSeen({registerId:e,registerOpenSequenceId:t}){const n=this.posStateManager.getAllOpenRegisterRemindersSeen();n[e]=t,this.posStateManager.setAllOpenRegisterRemindersSeen(n)}clearRegisterOpenReminderSeen({registerId:e}){const t=this.posStateManager.getAllOpenRegisterRemindersSeen();t[e]&&(delete t[e],this.posStateManager.setAllOpenRegisterRemindersSeen(t))}_getActiveOutletAttribute(e){if(!this._activeOutlet||!this._activeOutlet.attributes)return;const t=this._activeOutlet.attributes.find(t=>t.key===e);return t&&t.value}_setActiveRegister(e){const t=this._activeRegister&&this._activeRegister.id;e!==this._activeRegister&&(this._activeRegister=e,t&&t!==e.id&&this.emit("registerIdChange",{register:this._activeRegister}),this.emit("activeRegisterChange",{activeRegister:e}),se.setContext(e.id),(e.is_open||this._emulateRegisterOpen)&&this._emitActiveRegisterOpen(e))}_setActiveOutlet(e){e!==this._activeOutlet&&(this._activeOutlet=e,this.vdCurrencySettings.update({symbol:e.currency_symbol}),this.emit("activeOutletChange",{activeOutlet:e}))}_determineIsMultiTimezone(e){const t=1e3*u().add("1 year").unix(),n=this.isRetailerMultiTimezone;this.isRetailerMultiTimezone=Te(be(e,(e,n)=>{const s=u.tz.zone(n.time_zone),a=[],i=[];s.untils.forEach((function(e,n){e>1264939261e3&&e<t&&(a.push(e),i.push(s.offsets[n]))}));return e[i.join(":")+":"+a.join(":")]=!0,e},{}))>1,null!==n&&this.isRetailerMultiTimezone!==n&&this.emit("settings:timezone-change")}_onOutletsSync(e){let t;e.updated&&e.updated.length&&(Hl.all().then(e=>{this._determineIsMultiTimezone(e)}),t=g(e.updated,{id:this.posStateManager.getOutletId()}),t&&this._setActiveOutlet(t))}_onRegistersSync(e){const t=this._activeRegister;let n;if(e.updated&&e.updated.length&&(n=g(e.updated,{id:this.posStateManager.getRegisterId()}),n)){this._setActiveRegister(n),this.setLastUsedReceiptNumber(this._activeRegister.invoice_sequence);const e=this.isActiveRegisterOpen();e!==t.is_open&&(e?this._emitActiveRegisterOpen(n):this._emitActiveRegisterClose(n))}}_emitActiveRegisterOpen(e){return this.emit("activeRegisterOpen",{register:e}),e}_emitActiveRegisterClose(e){return this.emit("activeRegisterClose",{register:e}),e}_onActiveRegisterChange(){return this.waitForSelectedRegister().then(()=>this._waitForReceiptStoresToRefresh).then(()=>this.receiptSettingsStore.all()).then(e=>this._updateReceiptSettings(e))}_onTrainingModeEnabledChange(e){const t=this.isActiveRegisterOpen();this._emulateRegisterOpen=e.newValue;const n=this.isActiveRegisterOpen();n!==t&&(n?this._emitActiveRegisterOpen(this._activeRegister):this._emitActiveRegisterClose(this._activeRegister))}_onReceiptSettingsSync(e){this._activeRegister&&e.updated&&e.updated.length&&this._updateReceiptSettings(e.updated)}_updateReceiptSettings(e=[]){const t=this._activeRegister.receipt_template_id,n=g(e,{id:t});n&&n.settings&&(this._activeRegisterReceiptLogo=n.settings.LogoURL,Wc(this._activeRegisterReceiptSettings,n.settings))}_sortRegistersByOutlet(e){const t=F(e,e=>{const{registers:t,outlet:n}=e;return n?(e.registers=v(t,"name"),!0):(this.vdTracking.trackError("[Register Manager] Registers missing related outlet",{data:{registers:t}}),!1)});return v(t,e=>e.outlet.name)}}function od(e,t){const n={};return{init(){return this._whenInitialised||(this._whenInitialised=t.whenCompleteEntityDataAvailable("retailerSettings").then(()=>e.get()).then(t=>(ke(n,t||{}),e.on("sync",e=>{He.$applyAsync(()=>Wc(n,e.updated))}),n))),this._whenInitialised},get:()=>n,getRetailerUrl:()=>`https://${n.domain_prefix}.${_n.VEND_URI}`,isLoyaltyEnabled:()=>Boolean(n.loyalty&&n.loyalty.enabled),getLoyaltyRatio(){return this.isLoyaltyEnabled()?n.loyalty.ratio:0},isWebRegisterDefault:()=>Boolean(n.has_web_register),isStoreCreditEnabled:()=>Boolean(n.store_credit),getRegisterMigrationDate:()=>n.register_migration_date,getBarcodeOption:()=>n.embedded_barcode_option,isXeroIntegrationEnabled(){let e=!1;return C(n.enabled_integrations,t=>{if("Xero"===t.name)return e=!0,!0}),e}}}rd.$inject=["vdTracking","posStateManager","receiptSettingsStore","registersResource","wrDebugTools","vdCurrencySettings","vdFeatureManager"],t.module("webregister.managers").service("registerManager",rd),od.$inject=["retailerSettingsStore","syncManager"],t.module("webregister.managers").factory("retailerSettingsManager",od);const ld=t.copy;class cd{constructor(e,t,n,a,i,r,o,l,c,d,u,h,m,g,p,v,y,f,S,C,b,_,w,M,T,E,k,I){this.priceManager=e,this.posStateManager=t,this.salesStore=n,this.saleSyncManager=a,this.registerManager=i,this.syncManager=r,this.taxManager=o,this.taxesStore=l,this.vdTracking=c,this.saleLoader=d,this.userManager=u,this.cashMovementsManager=h,this.customerBalancesManager=g,this.webRegisterStatusManager=p,this.clientApiEventBus=v,this.productsStore=y,this.vdToastNotificationService=f,this.saleTransformer=S,this.saleModals=C,this.salePromotionResourceService=b,this.vdFeatureManager=_,this.vdLocalStorage=w,this.saleInventoryData=M,this.paymentManager=T,this.BalancesResource=E,this.currentSaleManager=k,this.saleTracker=I,s(this,"closeAfterComplete",!1),s(this,"isInitialised",!1),s(this,"promoCodeAdded",!1),s(this,"queueSaleCalculation",void 0),s(this,"sale",void 0),s(this,"saleCalculating",!1),s(this,"hotkeysService",void 0),s(this,"promotionsEnabled",!1),s(this,"whenInitialised",void 0),m.register("saleManager")}init(){if(!this.whenInitialised){this.hotkeysService=Ge.get("hotkeysService"),this.promotionsEnabled=this.vdFeatureManager.get("promotions"),this.queueSaleCalculation=Ie(this.saleCalculationQueue,this.getSaleCalculationDelay());const e=this.registerManager.init().then(()=>this.registerManager.waitForOpenRegister());this.whenInitialised=We.all({activeRegister:e,syncComplete:this.syncManager.whenCompleteDatasetAvailable(),priceManagerInitialised:this.priceManager.init(),taxManagerInitialised:this.taxManager.init()}).then(()=>this._init()).catch(e=>(this.vdTracking.trackError("[SaleManager] Failed to initialise sale manager",{data:{error:e}}),We.reject(e)))}return this.whenInitialised}getTotalSavings(){let e=0,t=0;return this.sale.discount&&(e=this.registerManager.isTaxInclusive()?c.add(this.sale.discount.price,this.sale.discount.tax):this.sale.discount.price),this.sale.lineItems.forEach(e=>{e.isPriceDiscounted()&&(t=this.registerManager.isTaxInclusive()?c.add(t,c.subtract(e.totals.inclusiveBasePrice,e.totals.inclusivePrice)):c.add(t,c.subtract(e.totals.exclusiveBasePrice,e.totals.exclusivePrice)))}),c.round(c.add(e,t))}getPromotionSummary(){return vc(this.sale.lineItems)}getLineItemProductIds(){const e=[];return this.sale.hasLineItems()&&this.sale.lineItems.forEach(t=>{const n=t.product.id;e.includes(n)||e.push(n)}),e}getTotalPromotionAmount(){return this.getPromotionSummary().reduce((e,t)=>c.add(e,t.total),0)}getHasActivePromotions(){return this.syncManager.hasActivePromotions}setActiveSale(e,t){return this.priceManager.recalculateSale(e).then(e=>{let t=We.resolve();return this.sale=e,this.sale.lineItems.forEach(e=>{t=t.finally(()=>this.saleInventoryData.lookupInventoryData(e))}),t}).then(()=>this.updateCustomerBalances()).then(()=>(this.currentSaleManager.hydrateReduxFromSale(this.sale),this.saveSale(t)))}saveSale(e){return this.setSaleModified(e),this._saveSale().then(e=>(this.clientApiEventBus.emitEvent({eventName:this.clientApiEventBus.EVENTS.SALE_UPDATE,data:{sale:this.saleTransformer.toClientApi(e)}}),e))}actionExistingSaleIfRequired({saleToLoad:e,context:t}){const n=e&&(e.id||e.localId||e),s=this.hasActiveSale()?this.sale:null;return!s||n&&(n===s.id||n===s.localId)?We.resolve({hasActiveSale:this.hasActiveSale()}):this.getRequiredExistingSaleAction(s,t).then(()=>({hasActiveSale:this.hasActiveSale()}))}getRequiredExistingSaleAction(e,t){return e.isConfirmed()?this.showActionConfirmSaleAndFinalise(t):e.hasPayments()?this.saleModals.actionConfirmSaleWithPayments():e.containsGiftCard()?this.saleModals.actionConfirmSaleWithGiftCard():e.hasLineItems()?this.showActionConfirmSaleAndFinalise(t):this.clearSale()}showActionConfirmSaleAndFinalise(e){return this.saleModals.actionConfirmSale({saveSaleResolver:()=>this.saveAndFinaliseCurrentSale(),context:e})}addProductToSale(e,t={},n){const s=t.price,a=c.isFinite(t.quantity)?t.quantity:"1",i=t.confirmed||!1,r=t.note,o=c.isFinite(s),l={price:s,quantity:a,confirmed:i,adjusted:o,product:e},d=this.addLineItem(l);return r&&(d.note=r),this.priceManager.updateLineItemPricesAndTaxes(d,this.sale).then(()=>this.evaluateNewLineItemDisplayPrice(d,s)).then(()=>this.saleInventoryData.lookupInventoryData(d)).then(()=>(He.$emit("sale:add-line-item",d,n),this.queueSaleCalculation())).then(()=>d)}addGiftCardItem({product:e,code:t,balance:n,expiresAt:s,isReload:a,clientId:i}){const r=this.addLineItem({product:e,basePrice:n,giftCardNumber:t,giftCardReload:a,giftCardClientId:i,giftCardExpiresAt:s});return this.priceManager.updateLineItemPricesAndTaxes(r,this.sale).then(()=>(He.$emit("sale:add-line-item",r),this.queueSaleCalculation()))}addCustomer(e){return this.sale.customer=e,this.updateCustomerBalances().then(()=>He.$emit(Ns.SALE_CUSTOMER_UPDATED)).then(()=>this.queueSaleCalculation()).then(()=>this.sale)}updateCustomerBalances(){return We((e,t)=>{this.sale.hasValidCustomer()?this.customerBalancesManager.getCustomerBalances(this.sale.customer).then(e=>(this.sale.customerBalances=e,e)).then(e,t):(this.sale.customerBalances=null,e(this.sale.customerBalances))})}removeCustomer(){return this.sale.customer=null,this.sale.customerBalances=null,He.$emit(Ns.SALE_CUSTOMER_UPDATED),this.sale.isEmptySale()?this.saveSale():this.queueSaleCalculation()}addLineItem(e){const t=new wc(e);return t.displayQuantity=t.quantity,this.sale.lineItems.push(t),t}totalSale(){return this.priceManager.totalSale(this.sale),this.saveSale()}removeLineItem(e){return this.saleInventoryData.addRemoveQuantity(e,{onRemove:!0,hasLineItems:Boolean(this.sale.lineItems.length)}),Pe(this.sale.lineItems,e),He.$emit("sale:remove-line-item",e),this.saleInventoryData.emit(Ns.LINE_ITEM_UPDATE_VALIDATION),this.sale.lineItems.length?this.queueSaleCalculation():(this.saleInventoryData.reset(),this.sale.potentialPromotionId=null,this.sale.isReturn()?this.voidSale():this.totalSale())}updateSaleDiscount(){const e=ld(this.sale.discount)||null;return this.priceManager.totalSale(this.sale),we(this.sale.discount,e)?We.when(this.sale):this.saveSale()}removeServiceFeeFromSale(){return this.sale.userRemovedSaleServiceFee=!0,this.priceManager.totalSale(this.sale),this.saveSale()}updateLineItemQuantity(e){const t=e.lineItem;return t.quantity=t.displayQuantity,this.saleInventoryData.reEvaluateQuantity(this.sale.lineItems).then(()=>this.queueSaleCalculation())}updateLineItemDisplayPrice({lineItem:e}){const t=e.displayPrice;this.adjustLineItemPrice(t,e);const n=this.priceManager.calculateLineItemDisplayDiscountInfo(e);return e.displayDiscountPercent=n.discountPercent,e.displayMarkupPercent=n.markupPercent,e.displayDiscount=n.discount,this.queueSaleCalculation()}updateLineItemDiscountPercent(e){const t=e.lineItem,n=parseFloat(c.round(this.priceManager.calculateLineItemDisplayBasePrice(t),5)),s=c.divide(t.displayDiscountPercent,100),a=c.multiply(s,n),i=c.subtract(n,a);return this.adjustLineItemPrice(i,t),t.displayPrice=c.round(i,5),this.queueSaleCalculation()}saleCalculationQueue(){return!this.sale||this.sale.isEmptySale()||this.sale.isCompleted()||this.sale.isConfirmedReadyToComplete()?We.resolve():(this.saleCalculating=!0,this.evaluateSalePromotions().then(()=>this.totalSale()).finally(()=>{He.$emit("saleManager:saleCalculating-complete"),this.saleCalculating=!1}))}hasCashDiscountingServiceFee(){return this.sale.hasCashDiscountingServiceFee(this.registerManager)}getCashDiscountedOutstandingBalance(){if(!this.hasCashDiscountingServiceFee())return;const e=this.sale.getOutstandingBalance(),t=c.add(this.sale.totals.saleServiceFeePaid,c.vn(this.sale.totals.cashDiscount).abs()),n=c.subtract(this.sale.totals.saleServiceFee,t);return c.round(c.subtract(e,n))}canMarkAsUnfulfilled(){return!!this.sale&&Boolean(this.sale.hasLineItems()&&!this.sale.hasUnknownLineItems()&&!this.sale.isReturn()&&!this.sale.isBlindReturn()&&!this.sale.isOnAccount()&&!this.sale.isLayby())}removePromotionsFromLineItems(e){const t=[];return b(e.lineItems,n=>{n.taxInfo&&!this.canUpdateLineItem(n)||t.push(this.priceManager.updateLineItemPricesAndTaxes(n,e,{lineItemPromotion:{remove:!0}}))}),We.all(t).then(()=>e)}evaluateNewLineItemDisplayPrice(e,t){return c.isFinite(t)&&this.registerManager.isTaxInclusive()&&e.displayPrice!==t?(e.displayPrice=t,this.updateLineItemDisplayPrice({lineItem:e})):We.resolve()}addOrRemovePromoCode(e){return this.sale.promoCode=e,this.queueSaleCalculation().then(()=>this.sale.promoCodeStatus)}hasAppliedPromoCode(){if(this.sale.promoCode&&this.sale.promoCodeStatus===Sa)return!0;const e=this.getPromotionSummary();return C(e,e=>e.promo_code)}checkPromotions(){const e=ld(this.sale);return this.removePromotionsFromLineItems(e).then(e=>this.salePromotionResourceService.checkPromotions(e))}evaluateSalePromotions(){if(!this.webRegisterStatusManager.isOnline())return We.resolve();return this.promotionsEnabled&&this.syncManager.hasActivePromotions?this.checkPromotions().then(e=>{if(!e||!e.data)return this.clearAllPromotionDataFromSale();const{data:t}=e;return this.checkForPotentialPromotions(t),t.promo_code_validation||t.promotions&&t.promotions.length?this.applyPromotions(t):this.removePromotionsFromLineItems(this.sale)}).catch(e=>(Qe.error("[saleManager] Failed to evaluate promotions",e),this.clearAllPromotionDataFromSale())):this.clearAllPromotionDataFromSale()}clearAllPromotionDataFromSale(){return this.sale.potentialPromotionId=null,this.removePromotionsFromLineItems(this.sale)}checkForPotentialPromotions(e){const t=e.potential_promotion;t&&t.id?(this.sale.potentialPromotionId=t.id,this.handlePromoHelperDisplayedState()):this.sale.potentialPromotionId=null}applyPromotions(e){const t=[],n=e.promo_code_validation;return n?(this.sale.promoCodeStatus=n.status,n.status===Sa?this.promoCodeAdded=!0:this.sale.promoCode="",this.sale.promoCodePromotionId=n.promotion_id):(this.sale.promoCodeStatus=null,this.promoCodeAdded=!1),this.sale.lineItems.forEach(s=>{const a=g(e.sale.line_items,e=>e.id===s.localId);if(!s.confirmed&&!s.isReturn)if(a&&a.promotion_ids&&a.promotion_ids.length){const i=a.promotion_ids.map(t=>{const s=g(e.promotions,{id:t}),i=n&&n.promotion_id===t&&n.status===Sa;return{id:s.id,name:s.name,description:s.description,promoCode:i?n.promo_code:null,promoCodeId:i?n.promo_code_id:null,amount:this.registerManager.isTaxInclusive()?c.vn(c.add(a.unit_discount,a.unit_tax_discount)).toNumber():Number(a.unit_discount)}}),r=this.priceManager.updateLineItemPricesAndTaxes(s,this.sale,{lineItemPromotion:a,promotionDetails:i});t.push(r)}else if(s.promotion){const e=this.priceManager.updateLineItemPricesAndTaxes(s,this.sale,{lineItemPromotion:{remove:!0}});t.push(e)}}),t.length?We.all(t):We.resolve(t)}adjustLineItemPrice(e,t){const n=this.priceManager.calculateLineItemTotalTaxRate(t),s=this.priceManager.calculatePriceComponents(e,n);if(t.adjusted=!0,this.posStateManager.getTrainingModeEnabled()){let e="sale:line-item-price-adjusted:";this.sale.hasValidCustomer()?e+="has-customer":e+="no-customer",He.$emit(e,t)}t.price=s.price,t.tax=s.tax}canUpdateLineItem(e){return!Boolean(e.giftCardNumber||e.isReturn||e.taxInfo&&e.confirmed)}pay(e,t,n,s,a){const i=this.posStateManager.getRegisterId();if(this.sale.addPayment(e,t,i,n,s,a),this.sale.isConfirmed()){const t=this.sale.paidBalance&&c.vn(this.sale.paidBalance).gt(0)?this.sale.paidBalance:e,n=c.subtract(c.vn(t),c.vn(a));this.sale.customerBalances.account=c.add(this.sale.customerBalances.account,n)}return this.priceManager.totalSale(this.sale),this.determineChangeForSale(t).then(()=>(Qe.debug("[Sale Manager] pay",this.sale.payments),this.saveSale()))}determineChangeForSale(e){return We((t,n)=>{const s=this.sale.finals.inclusivePrice;let a=0;if(c.vn(s).gte(0)){const e=this.sale.getPaymentsTotal();a=Math.min(0,c.subtract(s,e))}if(c.vn(a).lt(0)){const n=this.posStateManager.getRegisterId();let s=We.resolve(e);if(this.cashMovementsManager.isCashManagementEnabled()){const e=this.cashMovementsManager.getCashManagementPaymentTypeId();s=kc.get(e)}s.then(e=>{const s=ee().format();this.sale.change=new dc({registerId:n,paymentType:e,amount:a,paymentDate:s}),t()})}else this.sale.change=null,t()})}voidSale(){return Qe.debug("[Sale Manager] voiding sale",this.sale),this.transitionSaleToStatus(qn.VOIDED).then(()=>this.finaliseSale())}laybySale(){return Qe.debug("[Sale Manager] layby sale",this.sale),this.transitionSaleToStatus(qn.LAYBY_SALE)}onAccountSale(){return Qe.debug("[Sale Manager] on account sale",this.sale),this.transitionSaleToStatus(qn.ACCOUNT_SALE)}parkSale(){return Qe.debug("[Sale Manager] parking sale",this.sale),this.transitionSaleToStatus(qn.PARKED).then(()=>this.finaliseSale()).then(()=>this.vdToastNotificationService.success({message:"Your sale was successfully parked."}))}quoteSale(){return this.transitionSaleToStatus(qn.QUOTE)}unfulfilledPickUp(){return this.transitionSaleToStatus(qn.AWAITING_PICKUP)}unfulfilledDelivery(){return this.transitionSaleToStatus(qn.AWAITING_DISPATCH)}closeSale(){const e=this.sale,t=e.status;let n=qn.CLOSED;t===qn.LAYBY_SALE?n=qn.LAYBY_SALE_CLOSED:t===qn.ACCOUNT_SALE?n=qn.ACCOUNT_SALE_CLOSED:t!==qn.AWAITING_PICKUP&&t!==qn.AWAITING_DISPATCH||(n=t),void 0===e.shortCode&&e.setSaleLoyaltyClaimCode();const s=this.registerManager.getActiveRegister(),a=this.vdLocalStorage.get("VEND_REGISTER_OPEN_SEQUENCE");if(a){const e=a[s.id],t=s.register_open_sequence_id;void 0!==e&&e!==t&&this.vdTracking.trackUserEvent({eventName:"Register open sequence ID mismatch",metadata:{persistedOpenSequenceID:e,currentOpenSequenceID:t}})}return Qe.debug("[Sale Manager] closing sale",this.sale),this.transitionSaleToStatus(n)}removeAllTax(){const e=this.sale;return this.taxManager.getNoTaxGroup().then(t=>We.all(p(e.lineItems,e=>{e.taxInfo=t,e.adjusted=!0}))).then(()=>this.queueSaleCalculation())}removeTax(e){return We.all(p(this.sale.lineItems,t=>this.removeTaxFromLineItem(e,t))).then(()=>this.queueSaleCalculation(),e=>this.vdTracking.trackError("[SaleManager] Error removing tax",{data:{error:e}}))}removeTaxFromLineItem(e,t){const n=t.taxInfo.rates;return We((s,a)=>{if(n.length<=0)return a("Tax group had no rates");if(n.length>=3)return g(n,{id:e.id})?a("Cannot remove a single tax from a tax group with three or more rates"):s();if(1===n.length)return t.taxInfo.rates[0].id===e.id?(t.adjusted=!0,this.taxManager.getNoTaxGroup().then(e=>{t.taxInfo=e}).then(s)):s();let i;if(n[0].id===e.id)i=n[1].id;else{if(n[1].id!==e.id)return s();i=n[0].id}return t.adjusted=!0,this.taxesStore.getTaxByRateId(i).then(e=>{t.taxInfo=e},e=>{this.vdTracking.trackError("[SaleManager] Error fetching tax rate after removing tax from line item",{data:{error:e,lineItem:t,replacementRateId:i}})}).then(s)})}transitionSaleToStatus(e){const t=this.sale,n=this.registerManager.getActiveRegister().id,s=t.isReturn()&&t.registerId!==n;return He.$emit("sale:transitioning-to-status",{sale:t,status:e}),t.status!==qn.PARKED&&e!==qn.PARKED&&e!==qn.QUOTE||(t.returnFor&&0!==t.returnFor.length||(t.user=null),t.saleDate=null,t.registerId=null),t.status=e,t.status!==qn.LAYBY_SALE&&t.status!==qn.ACCOUNT_SALE||(t.lineItems.forEach(e=>{e.confirmed=!0}),t.readyToComplete=!0,t.customerBalances&&(t.customerBalances.account=this.customerBalancesManager.getAdjustedAccountBalance(t))),t.displayStatus=Cc(t),t.saleDate||(t.saleDate=ee().format()),t.receiptNumberDetails&&!s||(t.receiptNumberDetails=this.registerManager.getNextReceiptNumberDetails()),t.registerId||(t.registerId=this.posStateManager.getRegisterId()),t.user||(t.user=this.userManager.getLoggedInUser()),this.saveSale()}newSale(){return this.sale&&this.completeSaleTracking(this.sale),He.$emit("sale:new"),this.sale=new mc(void 0),this.currentSaleManager.clearCurrentSale(),this.saleInventoryData.reset(),this.posStateManager.setActiveSaleLocalId(null),this.hotkeysService.startCountingHotkeys(),this.sale}completeSaleTracking(e){const{status:t,returnFor:n}=e;this.saleTracker.completeTracking({isReturn:Boolean(n&&n.length>0),shortcuts:this.hotkeysService.stopCountingHotkeys(),status:t})}clearSale(){return We((e,t)=>{this.sale&&this.sale.localId?this.salesStore.removeSale(this.sale.localId).then(()=>(Qe.debug("[Sale Manager] clear sale",this.sale),this.newSale())).then(e,t):e()})}clearTrainingModeSale(){return this.clearSale().then(()=>{He.$emit("training-sale:complete")})}finaliseSale(){const e=this.vdLocalStorage.get("VEND_API_LOAD_SALE_CLOSE_AFTER_COMPLETE"),t=this.sale;return this.closeAfterComplete=!!e&&e.closeAfterComplete,t.status?(t.isQuote()&&(this.sale.status=qn.PARKED),t.isConfirmed()&&(t.readyToComplete=!1),this.posStateManager.getTrainingModeEnabled()?(this.vdTracking.trackUserEvent({eventName:"Training Sale",metadata:{Status:t.status}}),this.posStateManager.getTrainingModeOnboardingState()&&this.vdTracking.trackUserEvent({eventName:"Retailer On-Boarding Tour",metadata:{step:"Sale Completed"}}),this.clearTrainingModeSale()):(this.clientApiEventBus.emitEvent({eventName:this.clientApiEventBus.EVENTS.SALE_COMPLETE,data:{sale:this.saleTransformer.toClientApi(t)}}),t.syncStatus=zn.UPLOAD,this._saveSale().then(()=>{if(this.closeAfterComplete)return this.saleSyncManager.postSale(t.localId).then(()=>this.productsStore.removeDeletedProducts()).then(()=>Xe.close()).catch(()=>Qe.debug("[Sale Manager] Sale posting failed, did not auto close the tab")).finally(()=>this.vdLocalStorage.remove("VEND_API_LOAD_SALE_CLOSE_AFTER_COMPLETE"));this.saleSyncManager.postSale(t.localId).then(()=>this.productsStore.removeDeletedProducts())}).then(()=>this.newSale()))):(this.vdTracking.trackError("[Sale Manager] No sale status when attempting to finalise sale",{data:{sale_id:t.id||t.localId}}),We.resolve())}getReceiptData(){const e=this.getBaseReceiptData();return We.all([this.paymentManager.getBalancesGiftCardPaymentsSummary(this.sale.payments),this.paymentManager.getBigCommerceGiftCertPaymentsSummary(this.sale.payments)]).then(t=>{const n=t.reduce((e,t)=>t.concat(e),[]),s=r(r({},e),{},{giftCardsInfo:{giftCardSettings:{},giftCardPaymentsSummary:n}});return t.length>0&&t[0].length>0?this.BalancesResource.getRetailerGiftCardSettings().then(e=>(s.giftCardsInfo.giftCardSettings=e,s)):s}).catch(t=>(Qe.warn("[Sale Manager] Failed to retrieve retailer gift card settings",t),e))}getBaseReceiptData(){return{trainingModeEnabled:this.posStateManager.getTrainingModeEnabled(),sale:this.sale,register:this.registerManager.getActiveRegister(),outlet:this.registerManager.getActiveOutlet(),receiptHtmlExtra:this.paymentManager.paymentIntegrationReceiptMessage}}handlePromoHelperDisplayedState(){this.syncManager.hasActivePromotions&&this.sale.potentialPromotionId&&this.posStateManager.setPromotionSuggestion(this.sale.potentialPromotionId)}_init(){return this.isInitialised=!0,this.syncManager.on("syncComplete",()=>this.queueSaleCalculation()),this.productsStore.on("sync",this.onProductsStoreSync,this),this.loadOrCreateSale()}onProductsStoreSync(e={}){e.removed&&e.removed.length&&this.sale&&this.sale.lineItems.forEach(t=>{const n=t.product,s=g(e.removed,{id:n.id});s&&(n.deleted_at=s.deleted_at)})}loadOrCreateSale(){const e=this.posStateManager.getActiveSaleLocalId();return e?this.saleLoader.loadSale(e).then(e=>e?this.setActiveSale(e,{unconfirmedSalesOnly:e.isConfirmedNotReadyToComplete()}):this.newSale()).then(()=>this.queueSaleCalculation()).catch(()=>this.newSale()):this.newSale()}setSaleModified(e){const t=this.sale,n=e&&e.unconfirmedSalesOnly;return t.isCompleted()||n&&t.isConfirmed()||(this.sale.syncStatus=zn.MODIFIED),this.sale}_saveSale(){return this.saleTracker.isTrackingInitialised()||this.saleTracker.initialiseTracking(),this.salesStore.saveSale(this.sale).then(()=>(this.posStateManager.setActiveSaleLocalId(this.sale.localId),this.sale))}hasActiveSale(){return Boolean(this.posStateManager.getActiveSaleLocalId()&&this.sale)}saveAndFinaliseCurrentSale(){const e=this.sale;if(!e)return We.resolve();if(!e.isConfirmed())return this.parkSale();return(e.status===qn.LAYBY_SALE?this.laybySale():this.onAccountSale()).then(()=>this.finaliseSale()).then(()=>this.vdToastNotificationService.success({message:"Your sale was successfully saved."}))}getSaleCalculationDelay(){let e=250;return!Ut.isTest()&&this.syncManager.hasActivePromotions||(e=0),e}setPickableState(){return new Promise(e=>{const t=this.sale.fulfillmentOutletID||this.registerManager.getActiveOutlet().id;bc(this.sale.lineItems,t).then(t=>{this.sale.pickable=t,e()}).catch(()=>{this.sale.pickable=!1,e()})})}}cd.$inject=["priceManager","posStateManager","salesStore","saleSyncManager","registerManager","syncManager","taxManager","taxesStore","vdTracking","saleLoader","userManager","cashMovementsManager","wrDebugTools","customerBalancesManager","webRegisterStatusManager","clientApiEventBus","productsStore","vdToastNotificationService","saleTransformer","saleModals","salePromotionResourceService","vdFeatureManager","vdLocalStorage","saleInventoryData","paymentManager","BalancesResource","currentSaleManager","saleTracker"],t.module("webregister.managers").factory("saleManager",cd);class dd{constructor(e,t,n,a,i){this.vdTracking=e,this.taxesStore=t,this.retailerSettingsManager=n,this.registerManager=a,this.syncManager=i,s(this,"activeOutletDeferred",void 0),s(this,"defaultTax",void 0),s(this,"noTaxGroup",void 0),s(this,"whenInitialised",void 0)}init(){return this.whenInitialised||(this.whenInitialised=this.retailerSettingsManager.init().then(()=>this._init())),this.whenInitialised.then(()=>void 0!==this.defaultTax?this.defaultTax:this.determineDefaultTax())}getTaxForProduct(e){const t="string"==typeof e?e:e.id;return t||Qe.debug("[Tax Manager] Missing product id when attempting to get tax for product"),xc.get(t).then(e=>e?this.taxesStore.get(e.tax_id).then(t=>(t||Qe.debug("[Tax Manager] Outlet product tax missing from taxes store "+e.tax_id),t)):this.getDefaultTax())}getDefaultTax(){return this.defaultTax||Qe.debug("[Tax Manager] Default tax not set"),this.defaultTax}getNoTaxGroup(){return void 0!==this.noTaxGroup?We.resolve(this.noTaxGroup):this.taxesStore.get(this.retailerSettingsManager.get().no_tax_group_id).then(e=>(this.noTaxGroup=e,e))}calculateTaxRate(e){const t=be(e.rates,(e,t)=>c.add(e,t.rate),0);return c.round(t,5)}calculateTax(e,t){return c.isFinite(e)&&c.isFinite(t)||this.vdTracking.trackError("[TaxManager] calculateTax NaN values",{data:{price:e,taxRate:t}}),c.round(c.multiply(e,t),5)}calculateDisplayRate(e){try{return c.multiply(e.rate.rate,100)}catch(t){return this.vdTracking.trackError("[TaxManager] Tax rate not defined",{data:{error:t}}),0}}_init(){this.registerManager.on("activeOutletChange",e=>{if(this.activeOutletDeferred){const e=this.activeOutletDeferred;this.activeOutletDeferred=null,e.resolve()}else this.determineDefaultTax()})}determineDefaultTax(){const e=this.registerManager.getActiveOutlet();return e?this.syncManager.whenCompleteEntityDataAvailable("taxes").then(()=>this.taxesStore.get(e.default_tax_id)).then(t=>(t?Qe.debug("[Tax Manager] Default tax set "+t.id):Qe.debug("[Tax Manager] Default tax missing from taxes store "+e.default_tax_id),this.defaultTax=t,t)):(Qe.log("[Tax Manager] Missing active outlet when determining default tax"),this.activeOutletDeferred||(this.activeOutletDeferred=We.defer()),this.activeOutletDeferred.promise.then(()=>this.determineDefaultTax()))}}dd.$inject=["vdTracking","taxesStore","retailerSettingsManager","registerManager","syncManager"],t.module("webregister.managers").factory("taxManager",dd);const ud="initiate_web_register_sale_training",hd="is_primary_user",md="has_web_register";let gd;!function(e){e.TRAINING="training",e.PRIMARY_ONBOARDING="primary-onboarding",e.ONBOARDING="onboarding"}(gd||(gd={}));const pd={TRAINING:[{id:"addProduct",title:"Add a product to your sale",text:"Add a product to your sale, simply search or scan a barcode to add an item to your sale.",attachTo:".wr-global-search right",triggerOn:"training-sale:complete"},{id:"addDiscount",title:"Add a discount",text:"Click the product to discount it. You can also change the quantity and add a note.",attachTo:".li-cell left",triggerOn:"sale:add-line-item"},{id:"addCustomer",title:"Record who\u2019s buying",text:"Search for a customer to link the sale to their name.",attachTo:".wr-customer-search right",triggerOn:"sale:line-item-price-adjusted:no-customer"},{id:"takePayment",title:"Take payment",text:'Click the "Pay" button to finalise the sale.',attachTo:".btn--pay top",triggerOn:["search:customer-selected","autocomplete:customer-selected","training-sale:dismiss-payment-screen"]},{id:"choosePaymentType",title:"Choose a payment type",text:"Pick the payment type the customer wishes to use. You can split payments by typing a smaller amount\n        into the tender field.",attachTo:"#payment-options-group bottom",triggerOn:"sale:payment",delay:400},{id:"exit",title:"Got the hang of it?",text:"Once you\u2019ve got the hang of this, click here to exit Training Mode.",nextBtn:!0,attachTo:".register-info-popover-trigger right",triggerOn:["sale:transitioning-to-status","training-sale:force-sale-confirmation-screen"],tetherOptions:{targetAttachment:"top left",offset:"-20px -120px"}}],PRIMARY_ONBOARDING:[{id:"searchBar",title:"Search for a product",text:"The search is designed to be fast and forgiving of spelling mistakes. You can also scan barcodes.",pagination:!0,attachTo:".wr-global-search right",tetherOptions:{attachment:"top left",targetAttachment:"top right",offset:"0px -10px"}},{id:"payment",title:"Click \u201cPay\u201d to continue the sale",text:"After adding all items to the checkout, you're ready to make a payment.",pagination:!0,attachTo:".btn--pay top",triggerOn:["training-sale:dismiss-payment-screen","sale:add-line-item"],trackingData:{"sale:add-line-item":{step:"Product Added to Sale"}}},{id:"paymentOptions",title:"Select Cash",text:"Your Vend store can have many payment types. We've set up Cash for you to try.",pagination:!0,attachTo:{element:'#payment-options-group .vd-btn[data-id="1"]:first-child',on:"bottom"},triggerOn:"sale:payment",delay:600,trackingData:{"sale:payment":{step:"Clicked Pay Button"}}},{id:"exit",title:"Complete Tutorial",text:"Click here to complete this tutorial and start setting up your store.",pagination:!0,attachTo:".sale-confirmation-form-row right",triggerOn:["sale:transitioning-to-status","training-sale:force-sale-confirmation-screen"],delay:400}],ONBOARDING:[{id:"searchBar",title:"Search for a product name or scan a barcode",text:"The search is designed to be fast and forgiving of spelling mistakes. Click the result to add it to the checkout list.",pagination:!0,attachTo:".wr-global-search right",tetherOptions:{attachment:"top left",targetAttachment:"top right",offset:"0px -10px"}},{id:"payment",title:"Click \u201cPay\u201d to continue the sale",text:"After adding all items to the checkout, you're ready to make a payment.",pagination:!0,attachTo:".btn--pay top",triggerOn:["training-sale:dismiss-payment-screen","sale:add-line-item"],trackingData:{"sale:add-line-item":{step:"Product Added to Sale"}}},{id:"paymentOptions",title:"Select Cash",text:"Your Vend store can have many payment types. We've set up Cash for you to try.",pagination:!0,attachTo:{element:'#payment-options-group .vd-btn[data-id="1"]:first-child',on:"bottom"},triggerOn:"sale:payment",delay:600,trackingData:{"sale:payment":{step:"Clicked Pay Button"}}},{id:"exit",title:"Complete Tutorial",text:"Click here to complete this tutorial and start setting up your store.",pagination:!0,attachTo:".sale-confirmation-form-row right",triggerOn:["sale:transitioning-to-status","training-sale:force-sale-confirmation-screen"],delay:400}]};class vd extends Et{constructor(e,t,n,a,i,r,o,l){super(),this.retailerSettingsManager=e,this.posStateManager=t,this.userManager=n,this.routeManager=a,this.vdTracking=i,this.saleManager=r,this.productSkuIndex=o,s(this,"_onBoardingCustomised",void 0),s(this,"_tourType",void 0),s(this,"_unbindPreventStateChange",void 0),s(this,"_unbindStateChangeSuccessListener",void 0),s(this,"trainingModeOnboardingState",void 0),l.register("trainingModeManager")}init(){this.posStateManager.getTrainingModeEnabled()?(this._tourType=this.posStateManager.getTourType(),this.emit("tourEnabledChange",{tourType:this._tourType}),this.posStateManager.getTrainingModeEnabled()&&this._setupTrainingMode()):this._initiateWelcome(),this._shouldPreventStateChange(),this.posStateManager.on("trainingModeEnabledChange",this._onTrainingModeEnabledChange,this),this.posStateManager.on("tourEnabledChange",this._onTourEnabledChange,this),this.userManager.on("loggedInUserChange",this._initiateWelcome,this)}get trainingModeEnabled(){return this.posStateManager.getTrainingModeEnabled()}get tourEnabled(){return this.posStateManager.getTourEnabled()}set tourEnabled(e){this.posStateManager.setTourEnabled(e),e?this.initiateTour():this.exitTour()}getTourSteps(){return We((e,t)=>{if(this._tourType===gd.ONBOARDING)e(pd.ONBOARDING);else if(this._tourType===gd.PRIMARY_ONBOARDING)this._onBoardingCustomised?e(pd.PRIMARY_ONBOARDING):this._customiseSearchBarStep().then(()=>e(pd.PRIMARY_ONBOARDING),t);else if(this._tourType===gd.TRAINING){e(pd.TRAINING)}})}get currentTourType(){return this._tourType}initiateTrainingMode(){return!this.trainingModeEnabled&&(this._setupTrainingMode(),this.posStateManager.setTrainingModeEnabled(!0),!0)}initiateTour(){return!!this.trainingModeEnabled&&(this.posStateManager.setTourEnabled(!0),this.tourEnabled)}initiateTrainingTour(){return this.exitTour(),this._tourType=gd.TRAINING,this.posStateManager.setTourType(this._tourType),this._setupTrainingMode(),this.initiateTour()}exitTrainingMode(){return this.saleManager.clearTrainingModeSale().then(()=>{this._cleanupTrainingMode(),this._setUserAttributeNewToRegister(!1),this.posStateManager.setTrainingModeEnabled(!1),this.exitTour()})}exitTour(){this.tourEnabled&&this.posStateManager.setTourEnabled(!1)}_customiseSearchBarStep(){const e=g(pd.PRIMARY_ONBOARDING,{id:"searchBar"});return this.productSkuIndex.search("10012").then(t=>{this._onBoardingCustomised=!0,t.length&&(e.title=`Search for "${t[0].product.name}"`)})}_getTourType(){const e=this.userManager.getLoggedInUser(),t=Boolean(e&&e[hd]),n=this.retailerSettingsManager.get()[md];let s=gd.TRAINING;return n&&(s=gd.ONBOARDING,t&&(s=gd.PRIMARY_ONBOARDING)),s}_isTourTypeOnboarding(){return this._tourType===gd.ONBOARDING||this._tourType===gd.PRIMARY_ONBOARDING}_isTourTypeTraining(){return this._tourType===gd.TRAINING}_setupTrainingMode(){this._setTrainingModeOnboardingState(),this._unbindStateChangeSuccessListener=nt.onSuccess({},e=>{e.from().name===Wt&&e.to().name===jt&&He.$emit("training-sale:dismiss-payment-screen"),e.from().name===jt&&e.to().name===Ht&&He.$emit("training-sale:force-sale-confirmation-screen")})}_cleanupTrainingMode(){this._clearTrainingModeOnboardingState(),this._unbindStateChangeSuccessListener()}_setTrainingModeOnboardingState(){return this.trainingModeOnboardingState=!1,this._isTourTypeOnboarding()&&(this.trainingModeOnboardingState=!0),this.posStateManager.setTrainingModeOnboardingState(this.trainingModeOnboardingState),this.trainingModeOnboardingState}_clearTrainingModeOnboardingState(){this.trainingModeOnboardingState=!1,this.posStateManager.setTourType(gd.TRAINING)}_onTrainingModeEnabledChange(e){e.newValue&&this.vdTracking.trackUserEvent({eventName:"Training Mode Enabled"}),this._shouldPreventStateChange(),this.emit("trainingModeEnabledChange",e)}_onTourEnabledChange(e){const t=e.newValue;this._isTourTypeTraining()&&t?this.vdTracking.trackUserEvent({eventName:"Tour Initiated"}):t&&this.vdTracking.trackUserEvent({eventName:this._tourType,metadata:{step:"Tour Initiated"}}),this.posStateManager.setTourType(this._tourType),this.emit("tourEnabledChange",e)}_shouldPreventStateChange(){this.trainingModeEnabled?this._unbindPreventStateChange=nt.onStart({},e=>{this._preventNonSaleStateChange(e,e.to())}):this._unbindPreventStateChange&&(this._unbindPreventStateChange(),this._unbindPreventStateChange=null)}_preventNonSaleStateChange(e,t){this.routeManager.isStateAllowedInTrainingMode(t)||e.abort()}_initiateWelcome(){this.exitTour(),this.retailerSettingsManager.init().then(e=>{var n;e.disable_onboarding_tour?this._setUserAttributeNewToRegister(!1):(n=this.userManager.getLoggedInUser().id,Ke.get(`/api/2.0/users/${n}/attributes`).then(Ue)).then(e=>{const t=e&&g(e,{name:ud});if(!t||"true"===t.value){const e=this._getTourType();this._tourType=e,this.posStateManager.setTourType(e),this._isTourTypeOnboarding()&&!this.saleManager.hasActiveSale()&&this._initiateOnboarding()}}).catch(t.noop)})}_setUserAttributeNewToRegister(e){var n;(n={user_id:this.userManager.getLoggedInUser().id,name:ud,value:e.toString()},Ke.post("/api/2.0/user_attributes",n).then(Ue)).catch(t.noop)}_initiateOnboarding(){this.initiateTrainingMode()&&this.initiateTour()}}vd.$inject=["retailerSettingsManager","posStateManager","userManager","routeManager","vdTracking","saleManager","productSkuIndex","wrDebugTools"],t.module("webregister.managers").service("trainingModeManager",vd);const yd=$(L,F,p),fd=Re(2),Sd="admin",Cd={["cashier"]:0,["manager"]:1,[Sd]:2};class bd extends Et{constructor(e,t,n,a){super(),this.usersStore=e,this.posStateManager=t,this.tracking=n,this.vdActiveUser=a,s(this,"_signoutUrl",void 0),s(this,"_whenInitialised",void 0),this._signoutUrl="/signout?return="+Xe.encodeURI(_n.URL)}init(){return this._whenInitialised||(this._whenInitialised=this.vdActiveUser.init().then(()=>this.setLoggedInUser(this.vdActiveUser.get())).then(()=>{je(()=>this._updateLoggedInUser(),fd)}).then(()=>this)),this._whenInitialised}getLoggedInUser(){return this.vdActiveUser.get()}logout(){this._clearUser(),Xe.location.assign(this._signoutUrl)}hasGreaterPrivilege(e,t){return Cd[e.account_type]>Cd[t.account_type]}hasPermission(e){return this.hasAdminAccess()||this.vdActiveUser.hasPermission(e)}userSales(){return e=this.getLoggedInUser().id,Ke.get(`/api/2.0/users/${e}/sale_totals`).then(Ue);var e}hasAdminAccess(){return this._hasAccess(Sd)}canUserAccessOutlet(e,t){return!e.restricted_outlet_ids||!e.restricted_outlet_ids.length||e.restricted_outlet_ids.indexOf(t)>-1}hydrateUsers(e){const t=yd(e,"user_id");return We.all(p(t,e=>this.usersStore.get(e))).then(t=>(p(e,e=>{e.user=g(t,{id:e.user_id})}),e))}setLoggedInUser(e){e||this.logout(),this.posStateManager.setUser(e),this.tracking.setUser(e),this.usersStore.put(e),this.emit("loggedInUserChange",{loggedInUser:e})}_clearUser(){this.posStateManager.setUser(null)}_updateLoggedInUser(){return this.vdActiveUser.reload().then(e=>this.setLoggedInUser(e)).catch(()=>this.logout())}_hasAccess(e){const t=this.getLoggedInUser();return t&&Cd[t.account_type]>=Cd[e]}}bd.$inject=["usersStore","posStateManager","tracking","vdActiveUser"],t.module("webregister.managers").service("userManager",bd);const _d=[hs.XERO];class wd{constructor(e,t,n,s,a,i,r){this.registersResource=e,this.registerManager=t,this.vdTracking=n,this.cashMovementsManager=s,this.vdToastNotificationService=a,this.paymentManager=i,this.vdLocalStorage=r}getRegisterClosureSummary(){const e={registerClosure:this._getSavedRegisterClosure(),paymentsSummary:this.registersResource.getPaymentsSummary(this.registerManager.getActiveRegister())};return this.cashMovementsManager.isCashManagementEnabled()&&(e.cashDrawerTotals=this.cashMovementsManager.getCashDrawerTotals(),e.cashMovements=this.cashMovementsManager.getCashMovements()),We.all(e).then(e=>this._updatePaymentsSummaryWithPaymentTypeInfo(e)).then(e=>this._updateRegisterClosureWithPaymentsSummary(e))}saveRegisterClosure(e){return Bc.put("LATEST_REGISTER_CLOSURE",e).then(()=>e)}getLastRegisterClosureSummary(){return this._getSavedRegisterClosure()}openRegister(e,t){return this.cashMovementsManager.isCashManagementEnabled()?this.openRegisterAndSetFloat(e,t).catch(e=>{if(!this.registerManager.isActiveRegisterOpen())return We.reject(e);this.vdToastNotificationService.negative({message:"We had a problem saving the opening cash drawer amount.\n                To retry, open Cash Management in the side menu bar."})}):this.registersResource.open(e).then(e=>(this._saveRegisterSequenceId(e.id,e.register_open_sequence_id),this._updateRegisterAfterOpen(e))).catch(()=>this._onRegisterOpenErrorNotify())}openRegisterAndSetFloat(e,t){let n,s=!1;return this.registersResource.open(e).then(e=>We((s,a)=>this.cashMovementsManager.isCashManagementEnabled()?this.cashMovementsManager.recordCashMovement(t,e).then(e=>(n=e,s())).catch(()=>a()):a()).then(()=>e).catch(()=>(s=!0,e))).then(e=>(this._saveRegisterSequenceId(e.id,e.register_open_sequence_id),this._updateRegisterAfterOpen(e))).catch(()=>this._onRegisterOpenErrorNotify()).then(e=>s?We.reject():We.resolve({register:e,cashMovement:n}))}closeRegister(e){return this.cashMovementsManager.isCashManagementEnabled()?this._recordClosingCashMovementsForRegister(e).then(()=>this._doCloseRegister(e)):this._doCloseRegister(e)}differenceBetweenExpectedAndCounted(e,t){let n;return O(t)?n="-":(n=c.subtract(c.round(t,2),c.round(e,2)),n=c.round(n,2)),n}determineExpectedPaymentTotal(e,t){const n=Boolean(t.cashDrawerTotals&&t.cashDrawerTotals.cashDrawerBalance);return bs(e)?"-":this.cashMovementsManager.isCashManagementEnabled()&&this.paymentManager.isCashManagementPaymentType(e)&&n?c.round(t.cashDrawerTotals.cashDrawerBalance,2):c.round(e.total,2)}determineSummaryTotals(e,t){const n={expectedTotal:"0.00",countedTotal:"0.00",differenceTotal:"0.00",countedValid:!0};return t&&(n.expectedTotal="-",n.differenceTotal="-"),b(e.payments,s=>{if(n.countedValid&&(this.paymentManager.isCashManagementPaymentType(s)&&e.countedCashInDrawer?n.countedTotal=c.round(c.add(n.countedTotal,e.countedCashInDrawer),2):!this.paymentManager.isCashManagementPaymentType(s)&&s.totalCounted?n.countedTotal=c.round(c.add(n.countedTotal,s.totalCounted),2):(n.countedTotal="-",n.countedValid=!1)),!t){const t=this.determineExpectedPaymentTotal(s,e);n.expectedTotal=c.round(c.add(n.expectedTotal,t),2),n.countedValid?n.differenceTotal=this.differenceBetweenExpectedAndCounted(n.expectedTotal,n.countedTotal):n.differenceTotal="-"}}),n}calculateCashToBank(e,n){let s="0.00";return t.isUndefined(e)||t.isUndefined(n)||(s=this.differenceBetweenExpectedAndCounted(e,n),c.vn(s).isNeg()&&(s="0.00")),s}calculateClosingFloat(e,n){let s="0.00";if(!t.isUndefined(e)&&!t.isUndefined(n)){const t=this.calculateCashToBank(e,n);s=c.round(c.subtract(n,t),2)}return s}generateRegisterClosurePrintData(e){const t={registerClosure:e,isCashManagementEnabled:this.cashMovementsManager.isCashManagementEnabled(),hasCashConcealedPaymentType:!1,summaryTotals:{}};if(t.isCashManagementEnabled){const n=g(t.registerClosure.cashMovements,{type:us.OPENING_CASH_FLOAT});t.cashManagement={isCashFloatSet:Boolean(n),closingFloat:this.calculateClosingFloat(e.openingCashFloat,e.countedCashInDrawer),cashToBank:this.calculateCashToBank(e.openingCashFloat,e.countedCashInDrawer)}}return t.registerClosure.payments.forEach(e=>{bs(e)&&(t.hasCashConcealedPaymentType=!0),t.isCashManagementEnabled&&(e.isCashManagementPaymentType=this.paymentManager.isCashManagementPaymentType(e)),t.isCashManagementEnabled&&e.isCashManagementPaymentType?e.countedPaymentTotal=t.registerClosure.countedCashInDrawer:e.countedPaymentTotal=e.totalCounted,e.expectedPaymentTotal=this.determineExpectedPaymentTotal(e,t.registerClosure)}),t.summaryTotals=this.determineSummaryTotals(t.registerClosure,t.hasCashConcealedPaymentType),t}_doCloseRegister(e){return this.registersResource.close(e).then(e=>(this.registerManager.clearRegisterOpenReminderSeen({registerId:e.id}),this._removeRegisterSequenceId(e.id),this._syncUpdatedRegister(e))).then(t=>this._updateAndSaveRegisterClosure(e,t)).catch(()=>this._onRegisterCloseErrorNotify())}_updateRegisterAfterOpen(e){return this._syncUpdatedRegister(e)}_recordClosingCashMovementsForRegister(e){const{countedCashInDrawer:t,openingCashFloat:n}=e,{cashDrawerBalance:s}=e.cashDrawerTotals,a=[];let i=-Math.abs(c.vn(n).toNumber());if(c.vn(t).lt(n)){let e=c.subtract(t,n);e=-Math.abs(c.vn(c.round(e,2)).toNumber()),i=-Math.abs(c.vn(c.round(t,2)).toNumber()),a.push(this.cashMovementsManager.recordFloatAdjustment(e))}if(0!==c.vn(t).cmp(s)){const e=c.round(c.subtract(t,s),2);a.push(this.cashMovementsManager.recordTillDiscrepancy(e))}return a.push(this.cashMovementsManager.recordClosingFloat(i)),We.all(a).catch(e=>{this.vdTracking.trackUserEvent({eventName:"Failed Cash Management Register Closure",metadata:{error:e}})})}_syncUpdatedRegister(e){return qs.syncData([e]).then(()=>e)}_onRegisterOpenErrorNotify(){return this.vdToastNotificationService.negative({message:"Register failed to open, please try again."}),We.reject()}_onRegisterCloseErrorNotify(){return this.vdToastNotificationService.negative({message:"Register failed to close, please try again."}),We.reject()}_updatePaymentsSummaryWithPaymentTypeInfo(e){return kc.all().then(n=>(e.paymentsSummary.payments.forEach((function(e){e.paymentType=g(n,{id:e.payment_type_id}),e.isSystemPaymentType=t.isUndefined(e.paymentType)||-1!==_d.indexOf(e.paymentType.type_id)})),e))}_updateRegisterClosureWithPaymentsSummary(e){let t=e.registerClosure;const n=e.paymentsSummary;return(t&&t.register_closure_sequence_number)!==n.register_closure_sequence_number&&(t={register:this.registerManager.getActiveRegister(),outlet:this.registerManager.getActiveOutlet()}),t.cashDrawerTotals=e.cashDrawerTotals,t.cashMovements=e.cashMovements,t.payments&&(t.payments=this._filterAndOrderRegisterClosurePaymentTypes(t.payments)),n&&n.payments&&(n.payments=this._filterAndOrderRegisterClosurePaymentTypes(n.payments)),y(t,n),t}_updateAndSaveRegisterClosure(e,t){return e.register=t,e.register_close_time=t.register_close_time,this.saveRegisterClosure(e).then(()=>t)}_getSavedRegisterClosure(){return Bc.get("LATEST_REGISTER_CLOSURE").then(e=>this._validateAndUpdateSavedRegisterClosure(e))}_filterAndOrderRegisterClosurePaymentTypes(e){if(e){if(e=F(e,e=>!e.isSystemPaymentType),e=v(e,e=>e.payment_type_name),this.cashMovementsManager.isCashManagementEnabled()){const t=f(e,e=>this.paymentManager.isCashManagementPaymentType(e)),n=e.splice(t,1)[0];e.unshift(n)}return e}}_validateAndUpdateSavedRegisterClosure(e){const t=this.registerManager.getActiveRegister(),n=t&&t.id;return e&&e.register.id===n?(e.register=t,e.outlet=this.registerManager.getActiveOutlet()):e=null,e}_saveRegisterSequenceId(e,t){const n=this.vdLocalStorage.get("VEND_REGISTER_OPEN_SEQUENCE")||{};n[e]=t,this.vdLocalStorage.save("VEND_REGISTER_OPEN_SEQUENCE",ye(n,e))}_removeRegisterSequenceId(e){const t=this.vdLocalStorage.get("VEND_REGISTER_OPEN_SEQUENCE");t&&(t[e]=null,this.vdLocalStorage.save("VEND_REGISTER_OPEN_SEQUENCE",t))}}function Md(e,t,n,s,a){const i=[us.OPENING_CASH_FLOAT,us.CLOSING_CASH_FLOAT],r=[us.TILL_DISCREPANCY,us.CLOSING_CASH_FLOAT,us.FLOAT_ADJUSTMENT];return new class{getCashManagementPaymentTypeId(){const t=e.getActiveRegister();return t&&t.cash_managed_payment_type_id}getCashDrawerTotals(){return n.getCashTotals(e.getActiveRegister()).then(e=>(e.cashDrawerBalance=c.add(e.movements_total,e.cash_sales_total),e))}isCashManagementEnabled(){return Boolean(this.getCashManagementPaymentTypeId())}getCashMovements(s){const a=e.getActiveRegister(),i={register_open_sequence_id:a&&a.register_open_sequence_id};return n.getCashMovements(Ae(i,s)).then(e=>t.hydrateUsers(e))}recordCashMovement(s,i){const o=i||e.getActiveRegister(),l={amount:c.vn(c.round(s.amount,2)).toNumber(),date:ee.utc().format(),user_id:t.getLoggedInUser().id,register_open_sequence_id:o.register_open_sequence_id};return n.recordCashMovement(Ae(l,s)).then(e=>(D(r,l.type)||a.get(l.user_id).then(e=>{const{amount:t,date:n,type:s,note:a}=l;He.$emit(Ns.PRINT,{type:"cash-movement-receipt",data:{amount:t,date:n,note:a,type:s,username:e.display_name}})}),e)).catch(e=>this._isDuplicateMovementRequest(l,e))}recordFloatAdjustment(e){const t={amount:e,type:us.FLOAT_ADJUSTMENT};return Qe.debug("[CASH MOVEMENTS MANAGER] Float adjustment: "+t.amount),this.recordCashMovement(t)}recordTillDiscrepancy(e){const t={amount:e,type:us.TILL_DISCREPANCY};return Qe.debug("[CASH MOVEMENTS MANAGER] Till discrepancy: "+t.amount),this.recordCashMovement(t)}recordClosingFloat(e){const t={amount:e,type:us.CLOSING_CASH_FLOAT};return Qe.debug("[CASH MOVEMENTS MANAGER] Closing float: "+t.amount),this.recordCashMovement(t)}_isDuplicateMovementRequest(e,t){return We((n,a)=>{function r(){s.trackError("[CashMovementsManager] Error recording a cash movement",{data:{cashMovementData:e,error:t}}),a(t)}400===t.status&&D(i,e.type)?this.getCashMovements({type:e.type}).then(e=>{e.length?n():r()}).catch(()=>r()):r()})}}}function Td(e,t,n,s){return new class{canDisplayReceiptLoyalty(e){const s=e||n.sale;return!(!t.isLoyaltyEnabled()||!s||!s.isCompleted()&&!s.isMarkedAsUnfulfilled())&&(!s.hasValidCustomer()||s.hasValidCustomerWithLoyalty())}saleHasLoyaltyEarned(e){const t=e||n.sale;return Boolean(c.vn(this.getTotalLoyalty(t)).gt(0))}saleHasLoyaltyDeducted(e){const t=e||n.sale;return Boolean(c.vn(this.getTotalLoyalty(t)).lt(0))}getLoyaltyClaimUrl(e){const s=e||n.sale;return`${t.getRetailerUrl()}/loyalty/claim/${s.shortCode}`}getTotalLoyalty(t){const a=t||n.sale;if(!a)return e.trackError("[LoyaltyManager] No active SaleManager sale"),0;const i=a.finals.inclusivePrice,r=s.getTotalPartialPayments(hs.LOYALTY,a,!0),o=a.lineItems.reduce((e,t)=>c.add(e,c.multiply(t.quantity,t.loyaltyValue)),0);let l=o;return c.vn(r).gt(0)&&!c.vn(i).isZero()&&(l=c.multiply(1-c.divide(r,i),o)),c.round(l,2)}getCustomerLoyaltyBalance(e){const t=e||n.sale,a=t&&t.customer,i=a&&a.loyalty_balance||0;if(!a)return i;const r=s.getTotalPartialPayments(hs.LOYALTY,t),o=c.subtract(i,r);return t.isCompleted()||t.isMarkedAsUnfulfilled()&&t.getOutstandingBalance()<=0?c.add(o,this.getTotalLoyalty()):o}}}wd.$inject=["registersResource","registerManager","vdTracking","cashMovementsManager","vdToastNotificationService","paymentManager","vdLocalStorage"],t.module("webregister.managers").service("registerClosureManager",wd),t.module("webregister.managers").factory("cashMovementsManager",Md),Md.$inject=["registerManager","userManager","registersResource","vdTracking","usersStore"],t.module("webregister.managers").factory("loyaltyManager",Td),Td.$inject=["vdTracking","retailerSettingsManager","saleManager","customerBalancesManager"];function Ed(e,t,n,s,a){return{getCustomerBalances(t){return We.all({customer:e.refreshCustomer(t),storeCredit:this.getCustomerStoreCredit(t)}).then(e=>({storeCredit:e.storeCredit,loyalty:e.customer.loyalty_balance,account:e.customer.balance}))},calculateStoreCreditBalance(e){if(!e.customerBalances||!e.customerBalances.storeCredit)return 0;const t=e.customerBalances.storeCredit.balance,n=this.getTotalPartialPayments(hs.STORE_CREDIT,e);return c.subtract(t,n)},getTotalPartialPayments:(e,t,n=!1)=>t?t.payments.reduce((t,s)=>s.paymentType.type_id!==e||!n&&s.retrieved?t:c.add(t,s.amount),0):0,issueStoreCredit:(e,t)=>function(e,t){return Ke.post(`/api/2.0/store_credits/${e}/transactions`,t).then(e=>e.data)}(e,{type:"ISSUE",amount:c.vn(c.round(t.amount,2)).toNumber(),user_id:s.getLoggedInUser().id,notes:t.notes,client_id:se()}),getCustomerStoreCredit(e){return t.isOnline()&&n.isStoreCreditEnabled()?(s=e.id,Ke.get("/api/2.0/store_credits/"+s).then(e=>e.data)).catch(e=>404===e.status?{balance:0}:(a.trackError("[CustomerBalanceManager] Failed to retrieve customer store credit data",{data:{error:e}}),null)):null;var s},getAdjustedAccountBalance(e){if(!e||!e.hasValidCustomer()||!e.customerBalances)return;const t=e.payments,n=e.id&&c.vn(e.paidBalance).gt(0)?c.subtract(c.vn(e.finals.inclusivePrice),c.vn(e.paidBalance)):c.vn(e.finals.inclusivePrice);let s=c.subtract(e.customerBalances.account,n);if(t.length){const n=t.reduce((t,n)=>!n.retrieved||n.retrieved&&e.id?c.add(t,n.amount):t,0);s=c.add(s,c.vn(n))}return s}}}Ed.$inject=["customerManager","webRegisterStatusManager","retailerSettingsManager","userManager","vdTracking"],t.module("webregister.managers").factory("customerBalancesManager",Ed);class kd{constructor(e,t,n){s(this,"_exactMatchSources",void 0),s(this,"_sources",void 0),s(this,"_whenInitialised",void 0),this._sources={all:[e,t,n],product:[e,n],customer:[t,n]},this._exactMatchSources={product:e,customer:t}}init(){return this._whenInitialised||(this._whenInitialised=this._init()),this._whenInitialised}whenSyncComplete(e="all"){return this.init().then(()=>We.all(De(this._sources[e],"whenSyncComplete")))}getSources(e="all"){return this._sources[e]}findExactMatch({query:e,type:t}){return t?this._exactMatchSources[t].search(e):We.all(Ne(this._exactMatchSources,t=>t.search(e)))}_init(){return We.all(De(this._sources.all,"init"))}}kd.$inject=["productSkuIndex","customerCodeIndex","typeySearchSource"],t.module("webregister.managers").service("searchManager",kd);var Id=e=>({type:"SET_NOTE",payload:e});class Pd{constructor(e){this.$ngRedux=e,s(this,"currentSale",void 0),s(this,"actions",void 0)}setNote(e){this.$ngRedux.dispatch(Id(e))}clearCurrentSale(){this.setNote(null)}hydrateSaleFromRedux(e){const t=this.$ngRedux.getState().currentSale;return e.note=t.note||"",e}hydrateReduxFromSale(e){e.note&&this.setNote(e.note)}}Pd.$inject=["$ngRedux"],t.module("webregister.managers").service("currentSaleManager",Pd);const Rd={"add-product":"addProduct","add-customer":"addCustomer","product-add":"addLegacyProduct","customer-add":"addLegacyCustomer"},Ad={SALE_COMPLETE:"sale:complete",SALE_UPDATE:"sale:update"};class Dd extends Et{constructor(e){super(),this.vdTracking=e,s(this,"_onPostMessage",void 0)}get EVENTS(){return Ad}get POST_MESSAGE_SOURCE(){return"Vend Client API"}init(){this._onPostMessage||(this._onPostMessage=e=>this._handlePostMessage(e),Xe.addEventListener("message",this._onPostMessage))}emitEvent({eventName:e,data:t}){const n=Xe===Xe.top?Xe:Xe.parent;if(!D(Ad,e))return void this.vdTracking.trackError("[Client API] Attempt to emit non-published event",{data:{eventName:e}});const s={event_name:e,data:t,source:"Vend Client API"};n.postMessage(JSON.stringify(s),"*")}logError(e,t){const n=JSON.stringify({source:"Vend Client API",error:t});e&&e.source&&e.source.postMessage(n,e.origin),Qe.warn("[Client API] "+t,{error:t,data:e.data}),this.vdTracking.trackUserEvent({eventName:"Client API Error",metadata:{error:t,data:e.data}})}_handlePostMessage(t){let n;try{n=JSON.parse(t.data)||{}}catch(e){return}const{origin:s}=t,{method:a,params:i,source:r}=n,o=Rd[a];if(s===Xe.origin&&o){if(s!==Xe.origin&&this.vdTracking.trackUserEvent({eventName:"Client API Unmatched Origin",metadata:{origin:Xe.origin,messageOrigin:s,data:n}}),r&&"Vend Client API"===r)return;this.vdTracking.trackUserEvent({eventName:"Client API",metadata:{params:i,method:a}}),this.emit("apiEvent",{method:o,params:i,event:t})}}}Dd.$inject=["vdTracking"],t.module("webregister.managers").service("clientApiEventBus",Dd);class Nd{constructor(e,t,n,a,i,r,o,l,c,d){this.clientApiEventBus=e,this.productsStore=t,this.productSkuIndex=n,this.saleManager=a,this.registerManager=i,this.syncManager=r,this.vdTracking=o,this.afterpayPaymentService=l,this.klarnaPaymentService=c,this.webRegisterStatusManager=d,s(this,"_whenInitialised",void 0),s(this,"_whenReadyForProductEvents",void 0)}init(){return this._whenInitialised||(this.clientApiEventBus.init(),this.clientApiEventBus.on("apiEvent",this._onApiEvent,this),this._whenInitialised=We.all([this.registerManager.init(),this.saleManager.init()]),this._whenReadyForProductEvents=We.all([this._whenInitialised,this.productSkuIndex.whenSyncComplete()])),this._whenInitialised}addLegacyProduct(e){const[t,n,s,a]=e;let i=!1;return a&&a.status&&"CONFIRMED"===a.status&&(i=!0),this.addProduct({product_id:t,quantity:n,unit_price:s,confirmed:i})}addProduct(e){return this._whenReadyForProductEvents.then(()=>this._ensureReadyToSell()).then(()=>We((t,n)=>{const s=e.product_id,a=e.sku,i=e.quantity,r=e.unit_price,o=e.note,l=e.confirmed;return s||a?i&&!c.isFinite(i)?n(new Error("Please provide a valid quantity.")):r&&!c.isFinite(r)?n(new Error("Please provide a valid unit price.")):void(s?this.productsStore.get(s).then(e=>e?e.active?void this._addProduct({product:e,quantity:i,price:r,note:o,confirmed:l}).then(t,n):n(new Error("The product with provided ID is not active.")):n(new Error("Cannot find a product with the provided ID."))).catch(n):this.productSkuIndex.search(a).then(e=>{if(!e||!e.length)return n(new Error("Cannot find a product with the provided SKU."));if(e.length>1)return n(new Error("There are multiple products with the provided SKU."));const s=e[0].product;this._addProduct({product:s,quantity:i,price:r,note:o,confirmed:l}).then(t,n)}).catch(n)):n(new Error("No product ID or SKU provided."))}))}addLegacyCustomer(e){return this.addCustomer({customer_id:e[0]})}addCustomer(e){return this._whenInitialised.then(()=>this._ensureReadyToSell()).then(()=>We((t,n)=>{const s=e.customer_id;return this.saleManager.sale.isConfirmedNotReadyToComplete()?n(new Error("The customer can not be changed.")):s?void pa.get(s).then(e=>{if(!e)return n(new Error("Cannot find customer with ID"));Qe.debug("[Client API Manager] Adding customer to sale.",e),this.saleManager.addCustomer(e),t()}):n(new Error("No customer ID provided."))}))}_onApiEvent(e){const{method:t,params:n,event:s}=e;this[t](n).catch(e=>this.clientApiEventBus.logError(s,e.message))}_ensureReadyToSell(){return We((e,t)=>this.registerManager.isActiveRegisterOpen()?et.is(jt)?e():t(new Error("Unable to process API events on the current page.")):t(new Error("The register is not open."))).then(()=>{if(this.webRegisterStatusManager.isOnline())return this.syncManager.sync({skipEmitSyncComplete:!0})})}_addProduct({product:e,quantity:t,price:n,note:s,confirmed:a}){if(this.afterpayPaymentService.shouldPreventExchange(this.saleManager.sale))return this.afterpayPaymentService.notifyExchangeNotPossible(),We.reject(new Error("Unable to add product to the return sale. The original sale had an Afterpay payment"));if(this.klarnaPaymentService.shouldPreventExchange(this.saleManager.sale))return this.klarnaPaymentService.notifyExchangeNotPossible(),We.reject(new Error("Unable to add product to the return sale. The original sale had a Klarna payment"));const i={product:e,quantity:t,price:n,note:s,confirmed:a};return Qe.debug("[Client API Manager] Adding product to sale.",i),this.saleManager.addProductToSale(e,{quantity:t,price:n,note:s,confirmed:a}).then(()=>this.saleManager.sale).catch(e=>(this.vdTracking.trackError("[Client API] Unexpected error adding product to sale",{data:{error:e,data:i}}),We.reject(new Error("Unexpected error occurred adding product to sale"))))}}Nd.$inject=["clientApiEventBus","productsStore","productSkuIndex","saleManager","registerManager","syncManager","vdTracking","afterpayPaymentService","klarnaPaymentService","webRegisterStatusManager"],t.module("webregister.managers").service("clientApiManager",Nd),Od.$inject=["posStateManager","vdTracking"];const xd={channelsStore:Qc,customerGroupsStore:wi,customersStore:pa,outletsStore:Hl,paymentTypesStore:kc,priceBookProductsStore:$c,priceBooksStore:Pc,productTaxesStore:xc,quickKeyLayoutsStore:Vs,registersStore:qs};function Od(e,t){return class extends Et{constructor(e){super(),s(this,"_managedEntityStores",void 0),s(this,"_resyncOnOutletIdChange",void 0),this._managedEntityStores=e.managedEntityStores,this._resyncOnOutletIdChange=[]}init(){return We.all(p(this._managedEntityStores,this._initEntity.bind(this))).then(()=>this)}sync(){return this._getEntitiesToSync().then(this._syncEntities.bind(this))}getEntitiesToResyncOnOutletIdChange(){return this._resyncOnOutletIdChange}prepareEntityForResync(){return We.when()}_getEntityStore(e){const t=e+"Store",n=xd[t];return n||Ge.get(t)}_initEntity(e){const t=this._getEntityStore(e);return t.filterByOutlet&&this._resyncOnOutletIdChange.push(e),this._initEntityStore(t)}_getEntitiesToSync(){return We.when(p(this._managedEntityStores,this._getEntitySyncConfig.bind(this)))}_getEntitySyncConfig(e){const t=We.defer(),n={entityStoreName:e,data:{},deferred:t,promise:t.promise,interrupt:!1,syncComplete:!1};return this.emit("entitySyncTriggered",n),n}_syncEntities(e){return We.all(p(e,this._syncEntity.bind(this)))}_syncEntity(t){const n=t.entityStoreName;let s;if(this._getEntityStore(n).filterByOutlet){if(s=e.getOutletId(),!s)return this._waitForOutletId(t).then(this._syncEntity.bind(this,t));t.outletId=s}Qe.debug('[SyncManager] SYNCING entity store "'+n+'"');const a=We.when(this._doSyncEntity(t)).then(this._completeOrContinueSync.bind(this));return t.deferred.resolve(a),this.emit("entitySync",t),a}_completeOrContinueSync(e){const n=e.entityStoreName;if(e.interrupt)return Qe.debug('[SyncManager] SYNC INTERRUPTED for entity store "'+n+'"'),We.reject(new Mn);if(!e.syncComplete)return this._syncEntity(e);Qe.debug('[SyncManager] SYNC COMPLETE for entity store "'+n+'"');try{this.emit("entitySyncComplete",e)}catch(s){t.trackError("[AbstractSyncManager] Error in entitySyncComplete event",{data:{error:s,entitySyncConfig:e}})}return this._getSyncResult(e)}_waitForOutletId(e){const t=We.defer();return e.outletId=t,this.emit("entitySyncPendingOutletId",e),t.promise}_initEntityStore(e){return We.when()}_doSyncEntity(e){return We.reject("Unexpected: _doSyncEntity method should be overridden")}_getSyncResult(e){return e.data}}}function $d(e,n){return class extends n{prepareEntityForResync(t){return this._getEntityStore(t).clear().then((function(){return e.updateEntityVersion({entityStoreName:t,lastSyncedVersion:0,initialSyncHasOccurred:!1})}))}_initEntityStore(t){return e.trackVersion(t.entityName,t.entityStoreName)}_getEntitiesToSync(){return We.all({entitySyncConfigs:super._getEntitiesToSync(),updatedEntityVersions:this._requestUpdatedEntityVersions()}).then(this._getEntityVersionsForSync.bind(this))}_getEntityVersionsForSync(e){const t=e.entitySyncConfigs,n=e.updatedEntityVersions;return b(t,(function(e){const t=e.entityStoreName,s=g(n,{entityStoreName:t});s&&(e.data.entityVersion=s)})),t}_requestUpdatedEntityVersions(){return Ke.get("/api/2.0/versions").then((function(t){return e.updateVersions(t.data.data)}))}_doSyncEntity(e){return this._requestEntityData(e).then(this._syncEntityData.bind(this)).then(this._updateEntityVersion.bind(this))}_requestEntityData(n){const{entityVersion:s}=n.data,a=n.entityStoreName,i=this._getEntityStore(a);if(!s)return e.getEntityVersion(a).then((function(e){return n.data={entityVersion:e,entityData:{data:[],version:{min:null,max:null}}},n}));let r;return r=t.isFunction(i.requestSyncData)?i.requestSyncData(n):this._doRequestEntityData(n),r.then((function(e){return Qe.debug('[VersionedEntitySyncManager] DATA received for "'+a+'":',e),n.data.entityData=e,n}))}_doRequestEntityData(e){const{entityVersion:t}=e.data,n=this._getEntityStore(e.entityStoreName),s={after:t.lastSyncedVersion,page_size:1e4};if(n.filterByOutlet&&(s.outlet_id=e.outletId),t.initialSyncHasOccurred||n.syncDeleted?s.deleted=1:s.before=t.maxVersion+1,n.getAdditionalSyncParams){const e=n.getAdditionalSyncParams(t);e&&y(s,e)}return Ke.get("/api/2.0/"+t.entityName,{params:s}).then(e=>e.data)}_syncEntityData(e){const t=e.data,n=t.entityData,s=n.data;if(s.length&&!e.interrupt){const a=t.entityVersion;return this._getEntityStore(a.entityStoreName).syncData(s,{payloadVersion:n.version,lastSyncedVersion:a.lastSyncedVersion}).then(()=>e)}return e}_updateEntityVersion(t){const n=t.data,s=n.entityData,a=s.data.length,i=n.entityVersion;let r,o=!1;return t.interrupt?t:(a?(r=s.version.max,r>=i.maxVersion&&(i.initialSyncHasOccurred=!0)):(r=Math.max(i.lastSyncedVersion,i.maxVersion),i.initialSyncHasOccurred?o=!0:i.initialSyncHasOccurred=!0),i.lastSyncedVersion=r,i.maxVersion=Math.max(i.maxVersion,r),e.updateEntityVersion(i).then((function(e){return t.data.entityVersion=e,t.syncComplete=o,t})))}_getSyncResult(e){return e.data.entityVersion}}}t.module("webregister.managers").service("AbstractSyncManager",Od),$d.$inject=["versionsStore","AbstractSyncManager"],t.module("webregister.managers").factory("VersionedEntitySyncManager",$d);class Ld{constructor(e){this.syncManager=e,s(this,"_checkinPeriod",0),s(this,"_expeditedSyncTimer",void 0),s(this,"_expeditedSyncs",[])}expedite({isSyncComplete:e,startTime:t=Date.now(),timeout:n=6e5}){const s=We.defer(),a={isSyncComplete:e,timeout:n,deferred:s,startTime:t};return this._checkExpeditedSync({expeditedSync:a}).then(()=>{a.syncComplete||a.timedOut||this._addExpeditedSync(a)}),s.promise}_addExpeditedSync(e){this._expeditedSyncs.some((t,n)=>t.isSyncComplete===e.isSyncComplete&&(this._expeditedSyncs[n]=e,!0))||this._expeditedSyncs.push(e),this._checkinPeriod=0,this._scheduleSync()}_scheduleSync(){this._checkinPeriod+=1e4;const e=this._checkinPeriod>this.syncManager.syncTimeout;this._expeditedSyncTimer&&(je.cancel(this._expeditedSyncTimer),this._expeditedSyncTimer=null),We.all(this._expeditedSyncs.map(t=>this._checkExpeditedSync({expeditedSync:t,forceTimeout:e}))).then(()=>{this._expeditedSyncs=me(this._expeditedSyncs,e=>e.syncComplete||e.timedOut),this._expeditedSyncs.length?this._expeditedSyncTimer=je(()=>this._onExpeditedSyncTimer(),this._checkinPeriod,1):this._expeditedSyncTimer=null})}_checkExpeditedSync({expeditedSync:e,forceTimeout:t}){return We.resolve(e.isSyncComplete()).then(n=>{e.syncComplete=n,n?e.deferred.resolve():(t||Date.now()-e.startTime>e.timeout)&&(e.timedOut=!0,e.deferred.reject())})}_onExpeditedSyncTimer(){this._expeditedSyncTimer=null,this._expeditedSyncs.length&&this.syncManager.sync().finally(()=>this._scheduleSync())}}Ld.$inject=["syncManager"],t.module("webregister.managers").service("expeditedSyncManager",Ld);function Fd(e,n,a,i,r,o,l,d,u,h){o.register("saleSyncManager");return new class extends Et{constructor(){super(),s(this,"_attemptedSalesCount",void 0),s(this,"_currentActiveSync",void 0),s(this,"_erroredSalesCount",void 0),s(this,"_saleSyncRetryInProgress",void 0),s(this,"_unsyncedSalesCount",void 0),s(this,"_uploadSalesCount",void 0),s(this,"_whenInitialised",void 0),s(this,"erroredSalesFileUrl",void 0),s(this,"scheduledRetryInterval",void 0),this._unsyncedSalesCount=0,this._erroredSalesCount=0,this._attemptedSalesCount=0,this._uploadSalesCount=0,this._currentActiveSync=null,this._saleSyncRetryInProgress=!1}init(){return this._whenInitialised||(this._whenInitialised=We.all([h.init(),a.init()]).then(()=>this._getUnsyncedSalesAndUpdateCounts()).then(()=>(a.on(Pn.transitionOnline,this._transitionOnline,this),a.on(Pn.transitionOffline,this._transitionOffline,this),this._retrySalesWhenRegisterReady(),a.isOnline()?this._trackSalesMadeOffline():this._setOfflineStartTime(),d.on("syncComplete",()=>{e.count().then(e=>{r.trackUserEvent({eventName:"Local Sales Count",metadata:{count:e,erroredCount:this.erroredSalesCount,attemptedCount:this.attemptedSalesCount,uploadSalesCount:this.uploadSalesCount},useBatching:!1})}),e.removeUploadedSales()}),this))),this._whenInitialised}get saleSyncRetryInProgress(){return this._saleSyncRetryInProgress}get unsyncedSalesCount(){return this._unsyncedSalesCount}get attemptedSalesCount(){return this._attemptedSalesCount}get erroredSalesCount(){return this._erroredSalesCount}get uploadSalesCount(){return this._uploadSalesCount}get unsyncedSaleCountByType(){return{attemptedSalesCount:this._attemptedSalesCount,erroredSalesCount:this._erroredSalesCount,uploadSalesCount:this._uploadSalesCount}}get failedToSyncSalesCount(){return this._erroredSalesCount+this._attemptedSalesCount}getErroredSales(){return this._getUnsyncedSalesAndUpdateCounts().then(e=>F(e,e=>Boolean(e.syncStatus===zn.ERROR)))}postSale(t){return this._queueSync(()=>e.loadSale(t).then(e=>{if(e)return e.syncStatus!==zn.UPLOADED?this._doPostSale(e).catch(e=>(this._getUnsyncedSalesAndUpdateCounts().then(()=>this._scheduleSyncRetry()),We.reject(e))):void 0;Qe.debug("[SaleSyncManager] Sale not found when attempting to load the sale")}).catch(e=>{Qe.debug("[SaleSyncManager]",e)}))}retryUnsyncedSales(e={}){const{retryAllSales:t=!1}=e;return this._queueSync(()=>{this._cancelScheduledSyncRetry(),this._saleSyncRetryInProgress=!0,this.emit("saleSyncRetry");const e=t?()=>this._getUnsyncedSalesAndUpdateCounts():()=>this._getRetryableUnSyncedSales();return this._findAndFixLostOrErroredSales().then(()=>e()).then(e=>We(t=>{let n=We.resolve();return e.forEach(e=>{n=n.finally(()=>this._doPostSale(e))}),n.finally(t)})).then(()=>this._getUnsyncedSalesAndUpdateCounts()).then(e=>(this.emit("saleSyncRetryComplete",{unsyncedSales:e}),this._uploadSalesCount||this._attemptedSalesCount?this._scheduleSyncRetry():this._saleSyncRetryInProgress=!1,e))})}generateErroredSalesFile(n){return this.clearErroredSalesFile(),e.getErroredSalesJson().then(e=>{t.merge(n,{erroredSales:e});const s=new Blob([JSON.stringify(n)],{type:"text/json"});return this.erroredSalesFileUrl=Xe.URL.createObjectURL(s),this.erroredSalesFileUrl})}clearErroredSalesFile(){this.erroredSalesFileUrl&&Xe.URL.revokeObjectURL(this.erroredSalesFileUrl)}_retrySalesWhenRegisterReady(){const e={retryAllSales:!0};a.isOnline()&&(!d.syncInProgress()&&d.syncHasOccurred?this.retryUnsyncedSales(e):d.once("syncComplete",()=>{this.retryUnsyncedSales(e)},this))}_getRetryableUnSyncedSales(){return this._getUnsyncedSalesAndUpdateCounts().then(e=>F(e,e=>D(Zn,e.syncStatus)))}_queueSync(e){return this._currentActiveSync?this._currentActiveSync.finally(()=>this._queueSync(e)):(this._currentActiveSync=e().finally(()=>{this._currentActiveSync=null}),this._currentActiveSync)}_scheduleSyncRetry(){0===this._uploadSalesCount+this._attemptedSalesCount||this.scheduledRetryInterval||(this._saleSyncRetryInProgress=!0,this.scheduledRetryInterval=je(()=>this.retryUnsyncedSales(),Re(1),1))}_cancelScheduledSyncRetry(){this.scheduledRetryInterval&&(this.scheduledRetryInterval=null,this._saleSyncRetryInProgress=!1,je.cancel(this.scheduledRetryInterval))}_trackFailedSale({sale:e,eventName:t="Failed Sale"}){if(!(e&&e instanceof mc))return;const n=!(e.customer||e.hasLineItems()||e.hasPayments()||e.registerId||e.status||e.user),s=i.getActiveSaleLocalId();r.trackUserEvent({eventName:t,metadata:{completedByUser:e.completedByUser,hasCustomer:Boolean(e.customer),hasLineItems:e.hasLineItems(),hasPayments:e.hasPayments(),hasRegisterId:Boolean(e.registerId),hasUser:Boolean(e.user),isBlankSale:n,isCurrentSale:s===e.localId,saleLocalId:e.localId,saleDate:e.saleDate,status:e.status,syncAttempts:e.syncAttempts,syncStatus:e.syncStatus}})}_doPostSale(e){if(this._saleIsIncomplete(e))return r.trackUserEvent({eventName:"Incomplete Sale Intercepted",metadata:{}}),this._updateStatusOfIncompleteSale(e);let t;try{t=n.toApi(e)}catch(s){return this._setErroredSyncStatusAndLog({sale:e,error:s}).finally(()=>We.reject(s))}Qe.debug("[SaleSyncManager] Posting sale data to server: ",t);return Ke.post("/api/register_sales",t,{params:{strict:1}}).then(t=>this._handlePostSaleSuccess(e,t.data)).catch(t=>this._handlePostSaleFailure(e,t.data,t.status))}_saleIsIncomplete(e){if(!e)return!0;return!(e.customer||e.hasLineItems()||e.hasPayments()||e.registerId||e.status||e.user)||!e.status&&!e.hasPayments()}_setErroredSyncStatusAndLog({sale:t,error:n}){return t.syncStatus===zn.ERROR?We.resolve():(r.trackError("[SaleSyncManager] Error transforming sale for Api",{data:{error:n,sale:t.toJSON(),unsyncedSalesCount:this._unsyncedSalesCount}}),e.loadSaleJson(t.localId).then(t=>(t.syncStatus=zn.ERROR,e.writeSaleJson(t))))}_handlePostSaleSuccess(t,n){if(!n||"error"===n.status||!n.register_sale){const e="[SaleSyncManager] Sale post error received as a success";return r.trackError(e,{data:{sale:t.toJSON(),data:n}}),this._handlePostSaleFailure(t,n,-999)}const s=n.register_sale;if(Qe.debug("[SaleSyncManager] Sale post succeeded, data returned: ",s),t.isClosed()&&h.get("promotions")){const e=i.getPromotionSuggestion(),n=i.getPromotionsHelperClicked();r.trackUserEvent({eventName:"Promotions Helper Metrics",metadata:{saleId:s.id,basketSize:t.getBasketSize(),activePromotions:vc(t.lineItems).map(e=>e.id),promoHelperClicked:n,promoHelperSuggestion:e}})}return i.resetPromotionsHelperValues(),t.syncStatus=zn.UPLOADED,e.saveSale(t)}_handlePostSaleFailure(t,n,s){function i(){const e=`[SaleSyncManager] Error received when uploading sale [${s}]`;r.trackError(e,{data:{sale:t.toJSON(),responseCode:s,attempts:t.syncAttempts,data:n}})}const o=()=>{t.syncStatus!==zn.ERROR&&(t.syncAttempts++,3===t.syncAttempts?t.syncStatus=zn.ERROR:t.syncStatus=zn.ATTEMPTED),i()};switch(this._trackFailedSale({sale:t}),t.responseStatus=s,t.responseData=n,s){case-1:case 0:a.isOnline()&&l.isOnline?o():(t.syncStatus=zn.UPLOAD,this._incrementSalesMadeOffline(t.localId));break;case 401:o();break;case 500:case 501:case 502:case 503:case 504:o();break;case-999:default:i(),t.syncStatus=zn.ERROR}return e.saveSale(t).then(()=>We.reject(`Error received when uploading sale[${s}]`))}_incrementSalesMadeOffline(e){if(!e)return;const t=u.get("VEND_WR_OFFLINE_SALES")||{};t.sales||(t.sales=[]),D(t.sales,e)||(t.sales.push(e),u.save("VEND_WR_OFFLINE_SALES",t))}_setOfflineStartTime(){const e=u.get("VEND_WR_OFFLINE_SALES")||{};e.time||(e.time=ee().format(),u.save("VEND_WR_OFFLINE_SALES",e))}_trackSalesMadeOffline(){const e=u.get("VEND_WR_OFFLINE_SALES");if(!e)return;const t=e.sales;if(t&&t.length){const n=e.time;let s;if(n){const e=ee().diff(n),t=ee.duration(e);s=c.round(t.asMinutes(),c.ROUNDING_MODES.ROUND_DOWN)}r.trackUserEvent({eventName:"Sales Made Offline",metadata:{count:t.length,minutesOffline:s}})}u.remove("VEND_WR_OFFLINE_SALES")}_transitionOnline(){this._trackSalesMadeOffline(),this._scheduleSyncRetry()}_transitionOffline(){this._setOfflineStartTime(),this._cancelScheduledSyncRetry()}_findAndFixLostOrErroredSales(){return this._findAndFixLostModifiedSales().then(()=>e.getUnsyncedSales()).then(e=>this._findAndDeleteErroredBlankSales(e)).then(e=>We.all([this._findAndFixDuplicatePaymentLocalIdSales(e)])).then(()=>this._updateSyncStatusOfAllIncompleteSales())}_updateStatusOfIncompleteSale(t){return We(n=>{this._saleIsIncomplete(t)?(t.syncStatus=zn.UPLOADED,e.saveSale(t).then(n)):n()})}_updateSyncStatusOfAllIncompleteSales(){return e.getSalesBySyncStatus(zn.ERROR).then(e=>{e&&e.length&&We.all(e.map(e=>this._updateStatusOfIncompleteSale(e)))})}_findAndFixLostModifiedSales(){return e.getSalesBySyncStatus(zn.MODIFIED).then(t=>We.all(t.map(t=>{const n=i.getActiveSaleLocalId();if(t.localId!==n)return t.syncStatus=t.isEmptySale()?zn.ERROR:zn.UPLOAD,e.saveSale(t)})))}_findAndDeleteErroredBlankSales(t){const n=[];return We.all(t.map(t=>{if(t.syncStatus===zn.ERROR&&t.isEmptySale())return e.removeSale(t.localId);n.push(t)})).then(()=>n)}_findAndFixDuplicatePaymentLocalIdSales(e){return We.all(e.map(e=>this._fixDuplicatePaymentLocalIds(e)))}_fixDuplicatePaymentLocalIds(t){const n=[];let s=!1;function a(e){D(n,e.localId)?(e.localId=se(),s=!0):n.push(e.localId)}return b(t.payments,a),t.change&&a(t.change),s?e.saveSale(t):We.resolve()}_getUnsyncedSalesAndUpdateCounts(){return e.getUnsyncedSales().then(e=>{const t=e.filter(e=>!this._saleIsIncomplete(e));return this._updateUnsyncedSalesCount(t),t})}_getUnsyncedSalesCountByType(e){let t=0,n=0,s=0;return e.forEach(e=>{e.syncStatus===zn.ATTEMPTED&&t++,e.syncStatus===zn.ERROR&&n++,e.syncStatus===zn.UPLOAD&&s++}),{attemptedSalesCount:t,erroredSalesCount:n,uploadSalesCount:s}}_updateUnsyncedSalesCount(e){const t=this.unsyncedSaleCountByType,n=this._getUnsyncedSalesCountByType(e);we(t,n)||(this._unsyncedSalesCount=e.length,this._attemptedSalesCount=n.attemptedSalesCount,this._erroredSalesCount=n.erroredSalesCount,this._uploadSalesCount=n.uploadSalesCount,this.emit("unsyncedSalesChange",{prevValue:t,newValue:n})),u.save(Rn.VEND_ERROR_SALES_COUNT,this._erroredSalesCount)}}}t.module("webregister.managers").factory("saleSyncManager",Fd),Fd.$inject=["salesStore","saleTransformer","webRegisterStatusManager","posStateManager","vdTracking","wrDebugTools","vdWindowDelegate","syncManager","vdLocalStorage","vdFeatureManager"];const Ud=Re(5),Bd=["channels","outlets","registers","taxes","productTaxes","products","priceBooks","paymentTypes","customers","customerGroups","brands","suppliers","tags","productTypes","users","quickKeyLayouts","retailerSettings","receiptTemplateTypes","receiptSettings","priceBookProducts"];class qd extends Et{constructor(e,t,n,a,i,r,o,l,c,d,u){super(),this.versionsStore=e,this.posStateManager=t,this.VersionedEntitySyncManager=n,this.webRegisterStatusManager=a,this.registerManager=r,this.apiIdentification=o,this.vdPerformanceTracking=l,this.vdTracking=c,this.vdLocalStorage=d,this.retailerSettingsStore=u,s(this,"hasActivePromotions",void 0),s(this,"syncedEntityVersions",void 0),s(this,"syncHasOccurred",!1),s(this,"_currentActiveSync",null),s(this,"_currentEntitiesBeingSynced",{}),s(this,"_entitiesPendingOutletId",{}),s(this,"_nextScheduledSync",null),s(this,"_nextSyncPoll",null),s(this,"_resyncOnOutletIdChange",void 0),s(this,"_whenInitialised",void 0),s(this,"_whenSyncTriggered",void 0),s(this,"_trackInitialSyncUnload",()=>{if(!this.posStateManager.getInitialSyncComplete()){const e={moduleName:"Web Register",eventName:"Init Sync Abort",sendSynchronously:!0,useSendBeacon:!0};this.vdTracking.trackUserEvent(e)}Xe.removeEventListener("beforeunload",this._trackInitialSyncUnload)}),i.register("syncManager"),this.syncedEntityVersions=new this.VersionedEntitySyncManager({managedEntityStores:Bd}),this.hasActivePromotions=void 0===d.get("VEND_HAS_ACTIVE_PROMOTIONS")||d.get("VEND_HAS_ACTIVE_PROMOTIONS")}get syncTimeout(){return Ud}init(){return this._whenInitialised||(this._whenInitialised=We.all([this.syncedEntityVersions.init(),this.posStateManager.init()]).then(()=>this._init())),this._whenInitialised}sync(e={}){let n;return this.syncInProgress()?(this._nextScheduledSync||(this._currentActiveSync.catch(t.noop).finally(()=>this._executeNextScheduledSync()),this._nextScheduledSync=We.defer()),n=this._nextScheduledSync.promise):(this.cancelPoll(),n=this._executeSync(e)),n}syncInProgress(){return Boolean(this._currentActiveSync)}cancelPoll(){this._cancelNextPoll(),this.syncInProgress()&&this._currentActiveSync.catch(t.noop).finally(()=>this._cancelNextPoll())}whenCurrentSyncCompletes(){return We.resolve(this._currentActiveSync)}whenCompleteEntityDataAvailable(e){return this._whenSyncStarted().then(()=>We(t=>{const n=()=>{this.once("entitySyncComplete:"+e,()=>t())},s=()=>{this.versionsStore.getEntityVersion(e).then(e=>{!e||e.initialSyncHasOccurred?t():n()}).catch(t=>{Qe.warn("[SyncManager] Error checking entity version",{error:t,entityStoreName:e}),n()})},a=this._currentEntitiesBeingSynced[e];this.syncInProgress()&&a?a.promise.then(()=>t(),s):s()}))}whenCompleteDatasetAvailable(){return this._whenSyncStarted().then(()=>We(e=>{const t=()=>{this.posStateManager.getInitialSyncComplete()?e():this.posStateManager.on("initialSyncCompleteChange",()=>e())};this.syncHasOccurred?e():this.syncInProgress()?this._currentActiveSync.then(e,t):t()}))}_init(){return Xe.addEventListener("beforeunload",this._trackInitialSyncUnload),this.posStateManager.on("outletIdChange",this._onOutletIdChangeResync,this),this.webRegisterStatusManager.on(Pn.statusChange,this._onWrStatusChange,this),this._bindSyncManager(this.syncedEntityVersions),this._resyncOnOutletIdChange=this.syncedEntityVersions.getEntitiesToResyncOnOutletIdChange(),this._prepareRetailerSettings().then(()=>this)}_prepareRetailerSettings(){return this.retailerSettingsStore.get().then(e=>{if(e&&!e.terms_and_conditions)return this.syncedEntityVersions.prepareEntityForResync("retailerSettings")})}_whenSyncStarted(){return this.init().then(()=>{if(!this.syncInProgress()&&!this._nextScheduledSync&&!this._whenSyncTriggered)return this._whenSyncTriggered=We.defer(),this._whenSyncTriggered.promise})}_bindSyncManager(e){e.on("entitySyncTriggered",this._onEntitySyncTriggeredEvent,this),e.on("entitySync",this._onEntitySyncEvent,this),e.on("entitySyncComplete",this._onEntitySyncCompleteEvent,this),e.on("entitySyncPendingOutletId",this._onEntitySyncPendingOutletIdEvent,this)}_onEntitySyncTriggeredEvent(e){const{entityStoreName:n}=e;this._currentEntitiesBeingSynced[n]=e,e.promise.catch(t.noop).finally(()=>{this._currentEntitiesBeingSynced[n]=null}),this.emit("entitySyncTriggered",e),this.emit("entitySyncTriggered:"+n,e)}_onEntitySyncEvent(e){const{entityStoreName:t}=e;this.emit("entitySync",e),this.emit("entitySync:"+t,e)}_onEntitySyncCompleteEvent(e){const t=e.entityStoreName;this.emit("entitySyncComplete",e),this.emit("entitySyncComplete:"+t,e)}_onEntitySyncPendingOutletIdEvent(e){this._entitiesPendingOutletId[e.entityStoreName]=e.outletId}_checkForActivePromotions(){const e=this.registerManager.getActiveOutlet(),t=u.tz(e.time_zone).format(fa);return Ke.get("/api/2.0/promotions?end_time_from="+t).then(({data:e})=>{const t=e&&e.data;this.hasActivePromotions=Boolean(t&&t.length),this.vdLocalStorage.save("VEND_HAS_ACTIVE_PROMOTIONS",this.hasActivePromotions)}).catch(()=>{Qe.warn("[SyncManager] Failed to retrieve promotions"),this.hasActivePromotions=!0})}_executeSync(e={}){const t=!this.posStateManager.getInitialSyncComplete(),n=e.isFirstSync&&!t;return this.webRegisterStatusManager.isOnline()?n?this._currentActiveSync=We.resolve():(this.apiIdentification.startCountingRequests(),this.vdPerformanceTracking.start("Register Sync"),this._currentActiveSync=this.syncedEntityVersions.sync().then(e=>this._checkForActivePromotions().then(()=>this._setSyncCompleteFlags(e)).then(()=>{const n=this.vdPerformanceTracking.stop("Register Sync"),s=this.apiIdentification.stopCountingRequests();return this._trackSyncMetrics(s,n,t),e})).then(t=>e.skipEmitSyncComplete?We.resolve():this._emitSyncComplete(t))):this._currentActiveSync=We.reject(new Mn("Application is offline")),this._whenSyncTriggered&&this._whenSyncTriggered.resolve(),this._currentActiveSync.catch(e=>this._handleSyncError(e)).finally(()=>this._finaliseSync({isWarmBoot:n}))}_trackSyncMetrics(e,t={},n){this.vdTracking.trackUserEvent({eventName:"Register Sync",metadata:{apiRequestCount:e,isInitialSync:n,syncStartTime:t.startTime,syncDuration:t.duration}})}_abortSync(){b(this._currentEntitiesBeingSynced,e=>this._interruptEntitySync(e))}_cancelNextPoll(){this._nextSyncPoll&&(this._nextSyncPoll.cancel(),this._nextSyncPoll=null,this._nextScheduledSync&&(this._nextScheduledSync.reject("cancelled"),this._nextScheduledSync=null))}_handleSyncError(e){return!e||e instanceof Mn||Qe.warn("[SyncManager] SYNC FAILED",e),We.reject(e)}_setSyncCompleteFlags(e){return this.syncHasOccurred=!0,this.posStateManager.setInitialSyncComplete(!0),e}_emitSyncComplete(t){try{this.emit("syncComplete",t),He.$emit("syncComplete",t)}catch(e){Qe.warn("Error thrown handling `syncComplete` event",e)}return t}_finaliseSync(e={}){this._currentActiveSync=null,this._nextScheduledSync||(!this.syncHasOccurred&&e.isWarmBoot?this._scheduleNextSyncPoll(5e3):this._scheduleNextSyncPoll())}_executeNextScheduledSync(){const e=this._nextScheduledSync;this._nextScheduledSync=null,this._nextSyncPoll=null;const t=this._executeSync();return e.resolve(t),t}_scheduleNextSyncPoll(e=Ud){const t=this._executeNextScheduledSync.bind(this),n=Xe.setTimeout(t,e);this._nextScheduledSync=We.defer(),this._nextSyncPoll={cancel(){Xe.clearTimeout(n)},__flush(){this.cancel(),t()}}}_interruptEntitySync(e){const n=t.isString(e)?this._currentEntitiesBeingSynced[e]:e;n&&(n.interrupt=!0)}_onOutletIdChangeResync(e){const t=e.newValue;let n;n=this.syncInProgress()?F(this._resyncOnOutletIdChange,e=>{const n=this._entitiesPendingOutletId[e];return n?(n.resolve(t),delete this._entitiesPendingOutletId[e],!1):(this._interruptEntitySync(e),!0)}):this._resyncOnOutletIdChange,n.length&&We.all(p(n,e=>this.syncedEntityVersions.prepareEntityForResync(e))).then(()=>this.sync())}_onWrStatusChange(){this.webRegisterStatusManager.isOnline()?this._nextScheduledSync||this._scheduleNextSyncPoll(Re(1,.5)):this.syncInProgress()&&this._abortSync()}}qd.$inject=["versionsStore","posStateManager","VersionedEntitySyncManager","webRegisterStatusManager","wrDebugTools","registerManager","apiIdentification","vdPerformanceTracking","vdTracking","vdLocalStorage","retailerSettingsStore"],t.module("webregister.managers").factory("syncManager",qd);class Vd extends Error{constructor(...e){super(...e),this.name="RegistersUnavailableError"}}class Kd extends Et{constructor(e,t,n,a,i,r,o,l,c,d,u){super(),this.posStateManager=e,this.searchManager=t,this.syncManager=n,this.userManager=a,this.registerManager=i,this.clientApiManager=r,this.tracking=o,this.vdTracking=l,this.vdPerformanceTracking=c,this.vdNetworkInfo=d,this.workflowService=u,s(this,"_selectRegisterModalShown",!1),s(this,"_selectingRegister",!1),s(this,"initialisationComplete",!1),s(this,"isWarmBoot",!1),this.userManager.on("loggedInUserChange",()=>this._onLoggedInUserChange())}init(){const e=this.searchManager.init(),t=this._performInitialSync(),n=this._waitForSelectRegister();let s,a;return this.vdPerformanceTracking.start("register-selection"),n.then(()=>{s=this.vdPerformanceTracking.stop("register-selection")}),this.vdPerformanceTracking.start("data-stores-synced"),t.then(()=>{let t;return a=this.vdPerformanceTracking.stop("data-stores-synced"),this.vdPerformanceTracking.start("search-indexes-init"),e.then(()=>this.searchManager.whenSyncComplete().then(()=>{t=this.vdPerformanceTracking.stop("search-indexes-init")})).then(()=>{const e=this.vdPerformanceTracking.measure({name:"web-register-available"});this.trackInitMetrics({dataStoresSynced:a,registerSelection:s,searchIndexesInitialised:t,webRegisterAvailable:e}),this.vdPerformanceTracking.trackPageMetrics(),this.vdPerformanceTracking.trackDeviceMetrics(),this.trackFIDMetric()})}),this.workflowService.init(),this.tracking.init(),this.clientApiManager.init(),We.all([e,t,n]).then(()=>{this.initialisationComplete=!0})}trackFIDMetric(){xe(({name:e,delta:t})=>{this.vdTracking.trackUserEvent({eventName:"First Input Delay",metadata:{name:e,delta:t}})})}trackInitMetrics({dataStoresSynced:e,registerSelection:t,searchIndexesInitialised:n,webRegisterAvailable:s}){this.vdPerformanceTracking.canUsePerformanceTracking&&this.vdTracking.trackUserEvent({eventName:"Init Metrics",metadata:r(r(r(r({isInitialSync:!this.isWarmBoot,isWarmBoot:this.isWarmBoot,requests:this._getApiRequests()||"unknown",network:this.vdNetworkInfo.getNetworkInfo()||"unknown"},e&&{dataStoresSynced:e.toJSON()}),t&&{registerSelection:r(r({},t.toJSON()),{},{selectRegisterModalShown:this._selectRegisterModalShown})}),n&&{searchIndexesInitialised:n.toJSON()}),s&&{webRegisterAvailable:s.toJSON()})})}_getApiRequests(){const e=this.vdPerformanceTracking.getResourceEntries();if(!e||!e.length)return;const t=e.filter(e=>e.name.includes("/api/")||e.name.includes("/pos/status"));if(!t.length)return;const n=t.reduce((e,t)=>e.duration>t.duration?e:t);return{count:t.length,slowest:{url:new URL(n.name).pathname,duration:n.duration}}}_performInitialSync(){return this.isWarmBoot=Boolean(this.posStateManager.getInitialSyncComplete()),this.syncManager.sync({isFirstSync:!0}),this.syncManager.whenCompleteDatasetAvailable()}_waitForSelectRegister(){const e=this.registerManager.getActiveRegister(),t=e=>(this._selectingRegister=!1,this.emit("registerSelected",{selectedRegister:e}),We.resolve(e));return e&&this._canLoggedInUserAccessActiveOutlet()?t(e):(this._selectingRegister=!0,this._getAllRegistersByOutlet().then(e=>e&&e.length?(this._selectRegisterModalShown=!0,this._selectRegister(e)):(this.emit("registersUnavailable"),We.reject(new Vd))).then(t).catch(e=>(e instanceof Vd||this.vdTracking.trackError("Error occurred during register selection",{data:{error:e}}),We.reject(e))))}_canLoggedInUserAccessActiveOutlet(){const e=this.userManager.getLoggedInUser(),t=this.posStateManager.getOutletId();return this.userManager.canUserAccessOutlet(e,t)}_getAllRegistersByOutlet(){const e=this.userManager.getLoggedInUser();return We.all([this.syncManager.whenCompleteEntityDataAvailable("outlets"),this.syncManager.whenCompleteEntityDataAvailable("registers")]).then(()=>this.registerManager.getAllRegistersByOutlet({restrictedOutlets:e.restricted_outlet_ids}))}_selectRegister(e){return We(t=>{if(1===e.length&&1===e[0].registers.length){const n=e[0],s=n.registers[0];this.registerManager.setActiveRegister(s,n.outlet),t(s)}else this.registerManager.once("activeRegisterChange",e=>t(e.activeRegister)),this.emit("registerSelectRequired",{registersByOutlet:e})})}_onLoggedInUserChange(){this._selectingRegister||this._waitForSelectRegister()}}Kd.$inject=["posStateManager","searchManager","syncManager","userManager","registerManager","clientApiManager","tracking","vdTracking","vdPerformanceTracking","vdNetworkInfo","workflowService"],t.module("webregister.managers").service("webRegisterManager",Kd);const Gd="[WebRegisterStatusManager]",jd=Re(2);class Qd extends Et{constructor(e,t,n,a,i){super(),this.posStateManager=e,this.vdFeatureManager=t,this.vdLocalStorage=a,this.serviceWorkerManager=i,s(this,"_clientId",null),s(this,"_currentStatus",In.ONLINE),s(this,"_featuresInitialised",void 0),s(this,"_reloadingApplication",void 0),s(this,"_restrictedAccess",!1),s(this,"_softRefreshRequired",!1),s(this,"_whenInitialised",void 0),n.register("webRegisterStatusManager")}get status(){return this._currentStatus}get softRefreshRequired(){return this._softRefreshRequired}get restrictedAccess(){return this._restrictedAccess}set restrictedAccess(e){this._restrictedAccess=e,this._notify(Pn.restrictedAccessChange,{restrictedAccess:e})}init(){return this._whenInitialised||(this._featuresInitialised=this.vdFeatureManager.init(),this._whenInitialised=this.posStateManager.init().then(()=>{this._clientId=this.posStateManager.getClientId(),this._clientId||(this._clientId=se(),this.posStateManager.setClientId(this._clientId))}).then(()=>this._isSufficientStateForOffline()?(this._setStatus(In.ONLINE),this._checkPosStatus(),this):this._checkPosStatus().then(()=>this.isOnline()?this:We.reject(new wn))).finally(()=>this._init())),this._whenInitialised}isOnline(){return this._currentStatus===In.ONLINE}whenOnline(){return We(e=>{this.isOnline()?e():this.once(Pn.transitionOnline,e)})}refreshCacheAndReload(){if(this.serviceWorkerManager.activeServiceWorker)return this.serviceWorkerManager.refreshServiceWorkerCache()}_init(){return je(()=>this._checkPosStatus(),jd),this.on(Pn.transitionOffline,this._ensureSufficientStateForOffline,this),this.serviceWorkerManager.on(hl,this._showSoftRefreshBanner,this),this.serviceWorkerManager.on(ul,this._reloadApplication,this),We.all([this._featuresInitialised,this.serviceWorkerManager.registerServiceWorker()])}_checkPosStatus(){const e={params:{id:this._clientId,version:_n.CLIENT_VERSION,application:_n.APPLICATION_NAME},timeout:12e4},n=this.vdLocalStorage.get(Rn.VEND_ERROR_SALES_COUNT);return t.isDefined(n)&&(e.params.errored_sales_count=n),Ke.get("/pos/status.json",e).then(e=>this._processStatusSuccessResponse(e)).catch(e=>this._processStatusErrorResponse(e))}_processStatusSuccessResponse(e){const n=e.data;if(!t.isObject(n))return this._setStatus(In.UNREACHABLE),e;if(n.sell_screen_online?this._setStatus(In.ONLINE):this._setStatus(In.REMOTE_DISABLED),n.has_command)switch(Qe.debug(Gd+" Remote command received",n),n.command){case"refresh_hard":this.refreshCacheAndReload();break;case"refresh_soft":this._showSoftRefreshBanner()}return e}_processStatusErrorResponse(e){return 401===e.status?this._setStatus(In.UNAUTHENTICATED):this._setStatus(In.UNREACHABLE),e}_setStatus(e){if(e===this._currentStatus)return;if(!In[e])return void Qe.warn(Gd+" Attempt to set unrecognized status: ",e);const t=this._currentStatus;this._currentStatus=e,this._notifyStatusChange(t)}_isSufficientStateForOffline(){return Boolean(this.posStateManager.getUser()&&this.posStateManager.getInitialSyncComplete())}_ensureSufficientStateForOffline(){this._isSufficientStateForOffline()||this._notify(Pn.insufficientStateForOffline)}_notifyStatusChange(e){const t={status:this._currentStatus,previousStatus:e};this._notify(Pn.statusChange,t),this.isOnline()?this._notify(Pn.transitionOnline):e===In.ONLINE&&this._notify(Pn.transitionOffline)}_notify(e,...t){this.emit(e,...t),He.$emit(e,...t)}_showSoftRefreshBanner(){this._softRefreshRequired=!0,this._notify(Pn.softRefreshRequired)}_reloadApplication(){this._reloadingApplication||(Xe.location.reload(!0),this._reloadingApplication=!0)}}Qd.$inject=["posStateManager","vdFeatureManager","wrDebugTools","vdLocalStorage","serviceWorkerManager"],t.module("webregister.managers").service("webRegisterStatusManager",Qd);class Wd{constructor(e,t,n,a,i,r,o,l,c,d,u,h,m,g,p,v,y,f,S,C){this.$scope=e,this.webRegisterManager=t,this.registerModals=n,this.registerManager=a,this.duplicateWindowManager=i,this.trainingModeManager=r,this.webRegisterStatusManager=o,this.routeManager=l,this.retailerSettingsManager=c,this.cashMovementsManager=d,this.userManager=u,this.userSwitchingService=h,this.hotkeysService=m,this.saleSyncManager=g,this.syncManager=p,this.vdTracking=v,this.redirectSigninOn401=y,this.productsStore=f,this.vdFeatureManager=C,s(this,"cashManagementEnabled",void 0),s(this,"hasNoProducts",!1),s(this,"initComplete",!1),s(this,"initialisingModal",void 0),s(this,"outlet",void 0),s(this,"register",void 0),s(this,"restrictedAccess",!1),s(this,"retailer",void 0),s(this,"trainingModeEnabled",void 0),s(this,"user",void 0),s(this,"webRegisterOnline",!0);const b=[];this.user=this.userManager.getLoggedInUser(),this.retailerSettingsManager.init(),this.retailer=this.retailerSettingsManager.get();this.vdTracking.trackUserEvent({eventName:"Dark Mode",metadata:{prefersDarkScheme:window.matchMedia("(prefers-color-scheme: dark)").matches}}),this.duplicateWindowManager.ensureSingleWindow().then(()=>this.webRegisterManager.init().then(()=>{this.trainingModeManager.init(),this.hotkeysService.init();(!this.webRegisterManager.isWarmBoot&&et.includes(en)?et.go(jt):We.resolve()).then(()=>this._checkAndHandleProductCodeMigration(S.store("products"))).then(()=>{this.initComplete=!0})}),()=>et.go(Kt)),this._updateTrainingMode(),this._updateActiveOutletRegister(),this._updateOnlineStatus(),this.userManager.on("loggedInUserChange",this._loggedInUserChange,this),this.trainingModeManager.on("trainingModeEnabledChange",this._updateTrainingMode,this),this.registerManager.on("activeOutletChange",this._updateActiveOutletRegister,this),this.registerManager.on("activeRegisterChange",this._updateActiveOutletRegister,this),this.webRegisterStatusManager.on(Pn.statusChange,this._updateOnlineStatus,this),this.webRegisterStatusManager.on(Pn.restrictedAccessChange,this._updateRestrictedAccessStatus,this),this.webRegisterManager.on("registerSelectRequired",this._onRegisterSelectRequired,this),this.webRegisterManager.on("registersUnavailable",this._onRegistersUnavailable,this),this.webRegisterManager.on("registerSelected",this._onRegisterSelected,this),b.push(nt.onSuccess({},()=>this._updateOnlineStatus())),this.syncManager.on("syncComplete",()=>{this.productsStore.count().then(e=>{this.hasNoProducts=e<=1})}),this.$scope.$on("$destroy",()=>{this.userManager.off("loggedInUserChange",this._loggedInUserChange),this.trainingModeManager.off("trainingModeEnabledChange",this._updateTrainingMode),this.registerManager.off("activeOutletChange",this._updateActiveOutletRegister),this.registerManager.off("activeRegisterChange",this._updateActiveOutletRegister),this.webRegisterStatusManager.off(Pn.statusChange,this._updateOnlineStatus),this.webRegisterStatusManager.off(Pn.restrictedAccessChange,this._updateRestrictedAccessStatus),this.webRegisterManager.off("registerSelectRequired",this._onRegisterSelectRequired),this.webRegisterManager.off("registersUnavailable",this._onRegistersUnavailable),this.webRegisterManager.off("registerSelected",this._onRegisterSelected),b.forEach(e=>e())})}naviSwitchUser(){this.userSwitchingService.selectUser().catch(t.noop)}async _checkAndHandleProductCodeMigration(e){const t=e.index("byProductCode"),n=e.index("bySku");if(!this.vdFeatureManager.get("product_codes_sell_screen_scanning"))return Promise.resolve();{const[s,a]=await Promise.all([t.count(),n.count()]);if(a>0&&s<a)return e.transformAll(e=>this.productsStore.transformProduct(e))}}_updateTrainingMode(){this.$scope.$applyAsync(()=>{this.trainingModeEnabled=this.trainingModeManager.trainingModeEnabled})}_updateActiveOutletRegister(){const e=this.registerManager.getActiveOutlet(),t=this.registerManager.getActiveRegister();this.$scope.$applyAsync(()=>{this.outlet=e,this.register=t,this.cashManagementEnabled=Boolean(t)&&this.cashMovementsManager.isCashManagementEnabled()})}_updateOnlineStatus(){const e=this.webRegisterStatusManager.isOnline();this.$scope.$applyAsync(()=>{this.webRegisterOnline=e}),e||this.routeManager.isStateAllowedInOfflineMode()?this.routeManager.closeOfflineModal():this.routeManager.openOfflineModal()}_onRegisterSelectRequired(){this.registerModals.selectRegister().then(e=>{this.initialisingModal=e})}_onRegistersUnavailable(){et.go(Vt)}_onRegisterSelected(){this.webRegisterManager.initialisationComplete||We.resolve(this.initialisingModal&&this.initialisingModal.closed)}_loggedInUserChange(e){this.$scope.$applyAsync(()=>{this.user=e.loggedInUser})}_updateRestrictedAccessStatus({restrictedAccess:e}){this.restrictedAccess=e}isUnAuthenticated(){return this.redirectSigninOn401.hasEncountered401()}}function Hd(e,t,n){const s=Pn.transitionOnline;function a(){Xe.location.replace(_n.URL)}n.init().then(()=>{this.hasLoggedInUser=Boolean(n.getUser()),this.hasCompletedSync=Boolean(n.getInitialSyncComplete())}),t.init().finally(()=>{t.isOnline()?a():(t.on(s,a),e.$on("$destroy",()=>t.off(s,a)))})}Wd.$inject=["$scope","webRegisterManager","registerModals","registerManager","duplicateWindowManager","trainingModeManager","webRegisterStatusManager","routeManager","retailerSettingsManager","cashMovementsManager","userManager","userSwitchingService","hotkeysService","saleSyncManager","syncManager","vdTracking","redirectSigninOn401","productsStore","Database","vdFeatureManager"],t.module("webregister.controllers").controller("WebRegisterCtrl",Wd),Hd.$inject=["$scope","webRegisterStatusManager","posStateManager"],t.module("webregister.controllers").controller("OfflineErrorCtrl",Hd);class Yd{constructor(e,t,n,a,i,r,o,l,c,d,u,h){function m(e,...t){Qe.warn("[Workspace] "+e,...t),l.negative({message:e})}this.$scope=e,this.productModals=t,this.searchManager=n,this.vdTracking=a,this.syncManager=i,this.registerManager=r,this.quickKeysManager=o,this.productSuggestions=c,this.saleManager=d,this.afterpayPaymentService=u,this.klarnaPaymentService=h,s(this,"productErrorTemplate",void 0),s(this,"quickKeysEnabled",void 0),s(this,"suggestionSource",void 0),s(this,"syncing",!0),this.suggestionSource=this.productSuggestions.getSource({global:!0}),this.productErrorTemplate=this.productSuggestions.productErrorTemplate,this._activeRegisterChange(),this.syncManager.whenCompleteDatasetAvailable().then(()=>this.searchManager.whenSyncComplete()).then(()=>{this.syncing=!1,He.$emit("autocomplete:global-search:focus")});const g=He.$on("vd-quick-keys:product-selected",(e,t)=>{const n={id:t.productId,exactMatch:t.isChild},{label:s}=t,a=`"${s}" has been deleted and can't be sold. Please select another product.`;this.productSuggestions.enhance(n).then(e=>{const{product:t}=e;if(t&&t.active)this.registerManager.isActiveRegisterOpen()&&this.saleManager.isInitialised&&(this.saleManager.saleCalculating=!0),this.vdTracking.trackUserEvent({eventName:"Quick Key Selected",metadata:{"Has Variants":e.variantCount>0,"Exact Match":e.exactMatch,"View Product Info":!this.registerManager.isActiveRegisterOpen()}}),this.onSelectResult(e);else{let n;n=t?`"${s}" has been deactivated and can't be sold. Please select another product.`:a,m(n,e)}}).catch(()=>m(a))});this.registerManager.on("activeRegisterChange",this._activeRegisterChange,this),this.$scope.$on("$destroy",()=>{g(),this.registerManager.off("activeRegisterChange",this._activeRegisterChange)})}_doSelectVariant(e){Qe.debug("[Global Search] Do select variant",e);const t={parentProduct:e};return this.productModals.selectVariant(t)}_selectProduct(e){t.isArray(e)&&(1!==e.length&&Qe.warn("[Global Search] Multiple product matches",e),e=e[0]),Qe.debug("[Global Search] select product",e),He.$emit("search:product-selected",e)}_onSelectCustomerResult(e){const t=e.customer;Qe.debug("[Global Search] Customer result selected",e),He.$emit("search:customer-selected",t)}onSelectProduct(e){if(this.afterpayPaymentService.shouldPreventExchange(this.saleManager.sale))return this.saleManager.saleCalculating=!1,void this.afterpayPaymentService.notifyExchangeNotPossible();if(this.klarnaPaymentService.shouldPreventExchange(this.saleManager.sale))return this.saleManager.saleCalculating=!1,void this.klarnaPaymentService.notifyExchangeNotPossible();const t=e.product;Qe.debug("[Global Search] Product result selected",e),e.variantCount&&!e.exactMatch?(Qe.debug("[Global Search] Product result with variants selected"),this._doSelectVariant(t).then(e=>this._selectProduct(e.variant)).catch(()=>{this.saleManager.saleCalculating=!1})):this._selectProduct(t)}onSelectResult(e){"barcodeData"in e?He.$emit("search:embedded-barcode-selected",{product:e.product,barcodeData:e.barcodeData}):"product"in e?this.onSelectProduct(e):e.customer&&this._onSelectCustomerResult(e)}focusProductSearch(){He.$emit("autocomplete:global-search:focus",{isFocusable:!0})}_activeRegisterChange(){this.quickKeysEnabled=this.quickKeysManager.isQuickKeysEnabled()}}Yd.$inject=["$scope","productModals","searchManager","vdTracking","syncManager","registerManager","quickKeysManager","vdToastNotificationService","productSuggestions","saleManager","afterpayPaymentService","klarnaPaymentService"],t.module("webregister.controllers").controller("WorkspaceCtrl",Yd);const zd=Re(5),Jd="Exchange",Xd="Pay",Zd="Refund";class eu{constructor(e,t,n,a,i,r,o,l,c,d,u,h,m,g,p,v,y,f,S,C,b,_,w,M,T,E,k,I,P,R,A,D,N){this.$scope=e,this.$ngRedux=t,this.priceManager=n,this.saleManager=a,this.posStateManager=i,this.registerManager=r,this.saleLoader=o,this.customerModals=l,this.productModals=c,this.saleModals=d,this.wrSaleStatusFilter=u,this.userSwitchingService=h,this.workflowService=m,this.balancesGiftCardsModal=g,this.customerManager=p,this.vdToastNotificationService=v,this.trainingModeManager=y,this.vdTracking=f,this.registerModals=S,this.syncManager=C,this.vdLocalStorage=b,this.vdPerformanceTracking=w,this.webRegisterStatusManager=M,this.vdFeatureManager=T,this.userManager=E,this.vdPopover=k,this.vpPromotionModal=I,this.promotionModalService=P,this.retailerSettingsManager=R,this.currentSaleManager=A,this.markUnfulfilledModalService=D,this.saleTracker=N,s(this,"customerErrorTemplate",void 0),s(this,"customerSource",void 0),s(this,"readOnlyCustomerSource",void 0),s(this,"hasActiveSale",void 0),s(this,"isFinalisingSale",!1),s(this,"isInitialising",!0),s(this,"saleCalculating",!1),s(this,"saleForm",void 0),s(this,"shouldShowDiscount",!1),s(this,"shouldShowSaleNote",!1),s(this,"showDiscountPopover",!1),s(this,"showRegisterOpenReminder",!1),s(this,"currentSale",void 0),s(this,"expectedRegisterClosureInterval",void 0),s(this,"waitingForWorkflows",!1),s(this,"loadingMarkUnfulfilledModal",!1),s(this,"removeUnknownProduct",e=>{this.saleManager.sale.unknownLineItems=this.saleManager.sale.unknownLineItems.filter(t=>t.localId!==e.localId),this.saleManager.saveSale()}),s(this,"focusCustomerSearch",()=>{He.$emit("autocomplete:customer-search:focus",{isFocusable:!0})}),this.customerSource=_.getSource(),this.readOnlyCustomerSource=_.getSource({readOnly:!0}),this.customerErrorTemplate=_.customerErrorTemplate,this.hasActiveSale=Boolean(this.posStateManager.getActiveSaleLocalId()),this.init()}init(){const e=e=>{this.hasActiveSale=Boolean(e.newValue)};this.posStateManager.on("activeSaleLocalIdChange",e,this);const t=()=>this.pollForExpectedRegisterClosure(),n=()=>this.cancelPollForExpectedRegisterClosure(),s=()=>this.toggleExpectedRegisterClosurePoll();this._init().then(()=>{const e=this.saleManager.sale,t=tt.action;e&&(e.isClosed()||e.isConfirmedReadyToComplete()||e.isQuote())?et.go(Ht):t&&"pay"===t&&this.saleManager.queueSaleCalculation().then(()=>this.readyForPayment()),s()}),this.$scope.$on("sale:remove-line-item",this.handleRemoveLineItem.bind(this));const a=[];this.posStateManager.on("registerOpenRemindersSeenChange",()=>this.isRegisterOpenReminderNeeded(),this),this.registerManager.on("activeRegisterOpen",t,this),this.registerManager.on("activeRegisterClose",n,this),this.registerManager.on("activeRegisterChange",t,this),this.trainingModeManager.on("trainingModeEnabledChange",s,this),this.webRegisterStatusManager.on(Pn.statusChange,s,this),a.push(He.$on("search:product-selected",this.handleProductSelected.bind(this)),He.$on("search:embedded-barcode-selected",this.handleEmbeddedBarcodeSelected.bind(this)),He.$on("search:unknown-product",this.handleUnknownProductSelected.bind(this)),He.$on("search:customer-selected",this.handleCustomerSelected.bind(this)),He.$on("saleManager:saleCalculating-complete",()=>this.setSaleCalculatingState(!1)),He.$on("retrieveSale:loadSale",(e,t)=>this.onRetrieveSale(t)),He.$on("sale:new",this.resetSaleForm.bind(this)));const i=this.$ngRedux.connect(e=>e.currentSale)(e=>{this.currentSale=e});this.$scope.$on("$destroy",()=>{this.posStateManager.off("activeSaleLocalIdChange",e),this.posStateManager.off("registerOpenRemindersSeenChange",()=>this.isRegisterOpenReminderNeeded()),this.registerManager.off("activeRegisterOpen",t),this.registerManager.off("activeRegisterClose",n),this.registerManager.off("activeRegisterChange",t),this.trainingModeManager.off("trainingModeEnabledChange",s),this.webRegisterStatusManager.off(Pn.statusChange,s),a.forEach(e=>e()),n(),i()})}_init(){return(tt.sale?this.loadSale():this.saleManager.init()).finally(()=>{tt.closeAfterComplete&&this.vdLocalStorage.save("VEND_API_LOAD_SALE_CLOSE_AFTER_COMPLETE",{closeAfterComplete:tt.closeAfterComplete}),this.isInitialising=!1,this.shouldShowDiscount=Boolean(this.saleManager.sale.discount),this.shouldShowSaleNote=this.hasActiveSaleNote()||this.saleManager.sale.isMarkedAsUnfulfilled()})}openPromotionModal(e){return this.posStateManager.setPromotionsHelperClicked(),We.all({promotion:ka(e),groups:this.customerManager.getCustomerGroups(),productIds:this.saleManager.getLineItemProductIds(),retailer:this.retailerSettingsManager.get()}).then(e=>{if(e.promotion){if(this.vdFeatureManager.get("react_promotion_modal")){const t={culture:e.retailer.culture,code:e.retailer.currency.code,symbol:e.retailer.currency.symbol};return this.promotionModalService.openPromotion({promotion:e.promotion,lineItemIds:e.productIds,currencyDetails:t,isTaxExclusive:!this.registerManager.isTaxInclusive(),totalCustomerGroups:e.groups?e.groups.length:0,defaultTab:B.Buy})}return this.vpPromotionModal.viewProducts({promotion:e.promotion,lineItemIds:e.productIds,isTaxExclusive:!this.registerManager.isTaxInclusive(),totalCustomerGroups:e.groups?e.groups.length:0,defaultTab:"BUY"})}})}onRetrieveSale(e){return this.saleManager.actionExistingSaleIfRequired({saleToLoad:e}).then(t=>t.hasActiveSale?null:(this.isInitialising=!0,this.showDiscountPopover=!1,this.loadSale(e).then(()=>{this.shouldShowDiscount=Boolean(this.saleManager.sale.discount),this.shouldShowSaleNote=this.hasActiveSaleNote()}).finally(()=>{this.isInitialising=!1})))}loadSale(e){const t=e||tt.sale,n=t.id||t.localId||t;return this.userSwitchingService.switchUserIfNeeded().then(()=>this.syncManager.sync({skipEmitSyncComplete:!0})).then(()=>this.saleLoader.loadSale(n)).then(e=>this.registerModals.openRegisterToContinueSaleIfNeeded().then(()=>e).catch(()=>null)).then(e=>(e&&e.isOpen()&&e.hasValidCustomer()&&this.customerManager.refreshCustomer(e.customer),e)).then(e=>this.saleManager.init().then(()=>{if(e)return this.exitTrainingModeIfNeeded().then(()=>this.checkOutletOfLoadedSale(e)).then(()=>this.saleManager.actionExistingSaleIfRequired({saleToLoad:n})).then(t=>{const n={unconfirmedSalesOnly:e.isConfirmedNotReadyToComplete()};return t.hasActiveSale?null:this.saleManager.setActiveSale(e,n)}).catch(()=>null)})).then(e=>e&&!e.hasValidCustomer()&&e.isReturn()?this.customerModals.addCustomerToSale({cancelButtonLabel:"Skip"}).then(()=>e,()=>e):e).then(e=>(e&&e.isParked()&&this.saleManager.saleCalculationQueue(),e&&(e.isLayby()||e.isOnAccount())&&(e.paidBalance=e.getOutstandingBalance()),e)).catch(e=>{const n=this.saleLoader.ERROR_TYPES;let s,a=e&&e.type;switch(a||404!==e.status||(a=n.SALE_NOT_FOUND),a){case n.SALE_NOT_FOUND:s="This sale can't be found - please contact support.";break;case n.LOAD_SALE_ABORTED.VOIDED:s="This sale can't be opened as it has been discarded.";break;case n.LOAD_SALE_ABORTED.COMPLETED:s="This sale has already been completed.";break;default:this.vdTracking.trackError("[SaleCtrl] Unknown error loading sale",{data:{saleToLoad:t,error:e}}),s="This sale failed to load, please try again."}return this.vdToastNotificationService.negative({message:s}),this.saleManager.init()}).finally(()=>this.setSaleCalculatingState(!1))}dismissSale(){const e=this.saleManager.sale;if(!e||!e.isConfirmedNotReadyToComplete())return void this.vdTracking.trackError("[SaleCtrl] Error dismissing sale",{data:{sale:e&&e.toJSON()}});let t=We.resolve();this.trackSaleActionButton("Dismiss Sale"),e.syncStatus===zn.MODIFIED&&(t=this.saleModals.dismissSale(e.status)),t.then(()=>this.saleManager.clearSale()).then(()=>{this.shouldShowDiscount=!1,this.shouldShowSaleNote=!1})}isCustomerNote(){return this.registerManager.getActiveRegister().print_note_on_receipt}shouldDisableActions(){const e=this.saleManager.sale;return Boolean(!this.hasActiveSale||!e.isConfirmedNotReadyToComplete()&&e.hasPayments()||this.trainingModeManager.trainingModeEnabled||this.saleForm.$invalid&&!this.saleOnlyHasNoInventoryError()||this.isFinalisingSale||this.saleCalculating||this.saleHasUnknownLineItems())}saleOnlyHasNoInventoryError(){const e=this.saleForm.$error&&Object.keys(this.saleForm.$error);return Boolean(e&&1===e.length&&e[0]===Ps)}openMoreActionsDropdown(e){this.vdPopover.open({trigger:e.currentTarget,template:'<vd-popover class="wr-more-actions-popover" vd-focus-trap>\n  <ul class="vd-popover-list">\n    <li>\n      <a\n        href="javascript:void(0)"\n        ng-click="$ctrl.close(\'QUOTE\')"\n        vd-focus="{ isFocusable: true }"\n        ng-class="[\n          \'vd-popover-list-item\', {\n            \'wr-more-actions-disabled\': $ctrl.shouldDisableActions || $ctrl.isEmptySale || $ctrl.isMarkedAsUnfulfilled || $ctrl.isReturn\n          }\n        ]"\n        data-cy="quote-sale-button"\n      >\n        Quote Sale\n      </a>\n    </li>\n    <li>\n      <a\n        href="javascript:void(0)"\n        ng-click="$ctrl.close(\'UNFULFILLED\')"\n        ng-class="[\n          \'vd-popover-list-item\', {\n            \'wr-more-actions-disabled\': $ctrl.shouldDisableActions || $ctrl.isEmptySale || $ctrl.isMarkedAsUnfulfilled || $ctrl.isReturn\n          }\n        ]"\n        data-cy="mark-as-unfulfilled-button"\n      >\n        Mark as Unfulfilled\u2026\n      </a>\n    </li>\n    <li>\n      <a\n        href="javascript:void(0)"\n        ng-click="$ctrl.close(\'DISCARD\')"\n        ng-class="[\n          \'vd-popover-list-item\', {\n            \'wr-more-actions-disabled\': $ctrl.shouldDisableActions\n          }\n        ]"\n        data-cy="discard-sale-button"\n      >\n        Discard Sale\n      </a>\n    </li>\n  </ul>\n</vd-popover>\n',controller:"MoreActionsPopoverController",hasPopoverList:!0,direction:"topLeft",isEmptySale:this.saleManager.sale.isEmptySale(),shouldDisableActions:this.shouldDisableActions()||this.loadingMarkUnfulfilledModal,isMarkedAsUnfulfilled:this.saleManager.sale.isMarkedAsUnfulfilled(),isReturn:this.saleManager.sale.isReturn()||this.saleManager.sale.isBlindReturn()}).then(e=>{e.closed.then(e=>{e&&("QUOTE"===e?this.quoteSale():"DISCARD"===e?this.discardSale():"UNFULFILLED"===e&&this.markAsUnfufilled(!0))})})}markAsUnfufilled(e){this.vdTracking.trackUserEvent({eventName:"Opened Mark Sale as Unfulfilled Modal",metadata:{saleId:this.saleManager.sale.localId,customerAttached:this.saleManager.sale.hasValidCustomer(),openedFrom:e?"moreActionsDropdown":"negativeInventoryBanner"}}),this.openMarkUnfulfilledModal().then(e=>e.closed).then(e=>{e&&(this.shouldShowSaleNote=!0)})}openMarkUnfulfilledModal(){return this.saleTracker.addTrackingData({customerAttached:this.saleManager.sale.hasValidCustomer()}),this.vdFeatureManager.get("fulfill_from_another_outlet")?(this.loadingMarkUnfulfilledModal=!0,Hl.all().then(e=>{const t=[];return e.forEach(e=>{t.push({id:e.id,name:e.name})}),this.loadingMarkUnfulfilledModal=!1,this.markUnfulfilledModalService.markUnfulfilled(t)}).catch(e=>{this.loadingMarkUnfulfilledModal=!1,this.vdToastNotificationService.negative({message:"Sorry, we couldn't begin the fulfillment process. Please try again."}),this.vdTracking.trackError("[SaleCtrl] Failed to fetch all outlets for unfulfilled modal",{data:{error:e}})})):this.markUnfulfilledModalService.markUnfulfilled([])}shouldShowPromoCodeLink(){return!this.saleManager.hasAppliedPromoCode()}shouldShowPromoBanner(){return Boolean(!this.isInitialising&&this.syncManager.hasActivePromotions&&this.hasLineItems()&&this.saleManager.sale.potentialPromotionId&&!this.shouldShowSaleErrorBanner()&&!this.shouldShowMarkUnfulfilledBanner()&&!this.shouldShowUnfulfilledBanner())}saleHasUnknownLineItems(){return Boolean(this.saleManager.sale&&this.saleManager.sale.hasUnknownLineItems())}shouldShowSaleErrorBanner(){return Boolean(!this.isInitialising&&this.saleHasUnknownLineItems())}shouldShowBlindReturnBanner(){return Boolean(!this.isInitialising&&this.saleManager.sale&&this.userManager.hasPermission(ts.SALE_RETURN)&&this.saleManager.sale.isBlindReturn()&&!this.shouldShowSaleErrorBanner()&&!this.shouldShowPromoBanner()&&!this.saleManager.sale.isMarkedAsUnfulfilled())}shouldShowMarkUnfulfilledBanner(){return Boolean(!this.isInitialising&&this.saleManager.sale&&!this.saleManager.sale.isMarkedAsUnfulfilled()&&this.hasLineItems()&&!this.shouldShowSaleErrorBanner()&&this.saleOnlyHasNoInventoryError()&&this.saleManager.canMarkAsUnfulfilled()&&!this.loadingMarkUnfulfilledModal)}shouldShowUnfulfilledBanner(){return Boolean(!this.isInitialising&&this.saleManager.sale&&!this.shouldShowSaleErrorBanner()&&this.saleManager.sale.isMarkedAsUnfulfilled())}getCompleteSaleLabel(){const e=this.saleManager.sale;if(!e)return Xd;if(e.isConfirmedNotReadyToComplete()||e.hasPayments()){const t=e.getOutstandingBalance();return c.vn(t).lt(0)?Zd:Xd}return e.displayStatus===qn.RETURN_PARKED?Zd:e.displayStatus===qn.EXCHANGE_PARKED?Jd:Xd}quickAddCustomer(){return this.customerModals.createCustomer().then(e=>{this.saleManager.addCustomer(e),this.focusGlobalSearch()})}onCustomerSelect({customer:e}){this.saleManager.addCustomer(e).then(()=>{He.$emit("autocomplete:customer-selected"),He.$emit("autocomplete:global-search:focus")})}parkSale(){this.parkOrQuoteSale(!0)}quoteSale(){this.parkOrQuoteSale(!1)}parkOrQuoteSale(e){if(this.saleManager.saleCalculating)return void this.setSaleCalculatingState(!0);const n=this.saleManager.sale;if(n.containsGiftCard())return void this.vdToastNotificationService.negative({message:"Sales with gift cards can't be parked. Remove the gift card, then park the sale."});const s=this.registerManager.getActiveRegister(),a=s&&s.ask_for_note_on_save,i=2===a||1===a,r=this.currentSale.note,o=i?this.saleModals.actionAddNoteParkSale(r,e,n.isReturn()||n.isBlindReturn()):We.resolve({note:r});this.isFinalisingSale=!0,o.then(({note:e,isQuote:t})=>(this.currentSaleManager.setNote(e),t?this.saleManager.quoteSale().then(()=>et.go(Ht)):this.finaliseParkSale())).then(()=>{this.shouldShowDiscount=!1,this.shouldShowSaleNote=!1}).catch(t.noop).finally(()=>{this.isFinalisingSale=!1})}discardSale(){const e=this.saleManager.sale;if(this.saleManager.saleCalculating)return void this.setSaleCalculatingState(!0);this.isFinalisingSale=!0,this.trackSaleActionButton("Discard Sale");const t=()=>(this.trainingModeManager.trainingModeOnboardingState?this.vdTracking.trackUserEvent({eventName:this.trainingModeManager.currentTourType,metadata:{step:"Discard Sale and Print Receipt"}}):this.vdTracking.trackUserEvent({eventName:"Discard Sale and Print Receipt"}),this.saleManager.getReceiptData().then(e=>{He.$emit(Ns.PRINT,{type:"receipt-settings-and-template",data:e})}));(()=>{const n=!e.id;if(!e.hasLineItems()&&n)return this.saleManager.clearSale();if(n&&0===e.payments.length)return this.saleManager.clearSale();return(e.payments.length?t():We.resolve()).then(()=>{this.saleManager.voidSale()})})().then(()=>{this.userSwitchingService.switchUserIfNeeded().then(()=>this.focusGlobalSearch()).finally(()=>{this.isFinalisingSale=!1,this.shouldShowDiscount=!1,this.shouldShowSaleNote=!1})})}retrieveSale(e){this.vdPopover.open({trigger:e.currentTarget,template:'<vd-popover class="wr-retrieve-sale-popover" vd-focus-trap>\n  <div ng-if="!$ctrl.salesRetrieved" class="vd-pa10 vd-align-center">\n    <div class="vd-loader"></div>\n  </div>\n\n  <div ng-if="$ctrl.salesRetrieved && !$ctrl.errorRetrievingSales && !$ctrl.sales.length" class="wr-retrieve-sale-empty vd-pa5">\n    <img ng-src="{{ \'sell/empty-basket-v1.svg\' | vdImageCdnPath }}" alt="" class="wr-retrieve-sale-empty-image vd-mb5">\n    <h2 class="vd-text-label">You don\u2019t have any parked sales.</h2>\n    <p class="vd-p vd-mt3">\n      Parked Sales allow you to put products on hold, while you serve other customers.\n    </p>\n  </div>\n\n  <ul ng-if="$ctrl.salesRetrieved && $ctrl.sales.length" class="vd-popover-list">\n    <li class="wr-retrieve-sale-header wr-retrieve-sale-item">\n      <div class="vd-text-label wr-retrieve-sale-item-details">Parked Sale</div>\n      <div class="vd-text-label wr-retrieve-sale-item-customer">Customer</div>\n    </li>\n\n    <li ng-repeat="sale in $ctrl.sales | orderBy: \'-updated_at\' | limitTo: $ctrl.maxSales track by sale.id">\n      <a ng-click="$ctrl.continueSale(sale)"\n        vd-focus="{ isFocusable: $first }"\n        href="javascript:void(0);"\n        class="vd-popover-list-item wr-retrieve-sale-item">\n\n        <div class="wr-retrieve-sale-item-details">\n          <vd-id-badge modifier="avatar-multi">\n            <avatar>\n              <vd-avatar-multi ng-if="sale.products.length" entities="sale.products"></vd-avatar-multi>\n              <div ng-if="!sale.products.length"\n                vd-lazy-load="{ backgroundImage: \'{{ $ctrl.placeHolderImageSrc | vdImageCdnPath }}\' }"\n                class="vd-avatar-multi-tile wr-retrieve-sale-no-products-tile">\n              </div>\n            </avatar>\n            <header>\n              <vd-id-badge-title>\n                <div ng-if="sale.products.length" ng-repeat="summary in sale.productsSummary track by $index"\n                  class="wr-retrieve-sale-product-summary">\n                  {{::summary}}\n                </div>\n                <div ng-if="!sale.products.length">\n                  No Products\n                </div>\n              </vd-id-badge-title>\n            </header>\n            <description>\n              Parked {{::sale.updated_at | vdDateFromNow}} by&nbsp;{{::sale.user | wrUserName }}\n            </description>\n          </vd-id-badge>\n\n          <div ng-if="sale.note" class="wr-retrieve-sale-item-note vd-text-supplementary">\n            <strong>Note:</strong> {{::sale.note | vdRemoveWidow}}\n          </div>\n        </div>\n\n        <div class="wr-retrieve-sale-item-customer">\n          <span ng-if="::!$ctrl.hasValidCustomer(sale)">-</span>\n          <react-customer-badge ng-if="::$ctrl.hasValidCustomer(sale)"\n            customer="sale.customer"\n            no-description="true"\n            size="\'x-small\'">\n          </react-customer-badge>\n        </div>\n        <vd-icon icon="fa-share" class="wr-retrieve-sale-item-icon"></vd-icon>\n      </a>\n    </li>\n    <li ng-if="$ctrl.sales.length > $ctrl.maxSales" class="vd-colour-go">\n      <a ng-click="$ctrl.showAllParkedSales()"\n        href="javascript:void(0);"\n        class="vd-link vd-link-seconary vd-popover-list-item vd-align-center">\n        Show All Parked Sales\n      </a>\n    </li>\n  </ul>\n</vd-popover>\n',controller:"RetrieveSalePopoverController",hasPopoverList:!0,direction:"center",openAsModalAtViewport:"xsmall"})}preventTransitionToPaymentScreen(){return Boolean(!this.hasActiveSale||this.saleForm.$invalid||!this.hasLineItems()||this.saleCalculating||this.waitingForWorkflows||this.saleHasUnknownLineItems())}transitionToPaymentScreen(){this.trainingModeManager.trainingModeEnabled||this.vdPerformanceTracking.start("sale-process");let e=We.resolve();this.saleManager.sale.hasValidCustomer()&&(e=this.customerManager.refreshCustomer(this.saleManager.sale.customer)),this.priceManager.totalSale(this.saleManager.sale),this.saleManager.saleCalculating?this.setSaleCalculatingState(!0):(this.setSaleCalculatingState(!1),e.then(()=>this.readyForPayment()))}readyForPayment(){const e=()=>{et.go(Wt)};if(this.vdFeatureManager.get("custom_business_rules"))return this.waitingForWorkflows=!0,this.workflowService.triggerRules(Ll.READY_FOR_PAYMENT).then(t=>{t&&e()}).finally(()=>{this.waitingForWorkflows=!1});e()}hasLineItems(){return Boolean(this.saleManager.sale&&this.saleManager.sale.lineItems.length)}showSaleNote(){this.shouldShowSaleNote=!0}hideSaleNote(){this.shouldShowSaleNote=!1,this.currentSaleManager.setNote(null),this.saleManager.sale.note="",this.saleManager.saveSale()}discountClickHandler(){this.isDiscountDisabled()||(this.hasPermissionToDiscount()?this._showSaleDiscount():this.userSwitchingService.selectUser({selectUserForDiscount:!0}).catch(t.noop))}hideSaleDiscount(){this.shouldShowDiscount=!1,this.saleManager.sale.displayDiscount=0,this.saleManager.updateSaleDiscount()}isDiscountDisabled(){const e=this.saleManager.sale,t=e&&e.returnFor;return Boolean(!this.hasActiveSale||t||e.isConfirmed())}hasPermissionToDiscount(){return this.userManager.hasPermission(ts.SALE_DISCOUNT)}showRemoveServiceFeePopover(e){this.vdPopover.open({trigger:e.currentTarget,template:'<vd-popover class="sale-popover">\n  <h1 class="vd-text-label">Remove fee from sale</h1>\n  <hr class="vd-hr vd-mb0">\n  <div class="wr-sale-popover-item vd-flex--align-center">\n    <div>\n      Service Fee ({{::$ctrl.cashDiscountingRate}}%)\n    </div>\n    <div>\n      <span class="vd-mr1">\n        {{ $ctrl.saleServiceFee | vdCurrency }}\n      </span>\n      <button type="button"\n        class="vd-btn vd-btn--icon-no"\n        ng-click="$ctrl.removeServiceFee()">\n        <vd-icon icon="fa-trash"></vd-icon>\n      </button>\n    </div>\n  </div>\n</vd-popover>\n',direction:"left",controller:"SaleServiceFeePopoverController"})}checkOutletOfLoadedSale(e){return e.status!==qn.LAYBY_SALE&&e.status!==qn.ACCOUNT_SALE?We.resolve():this.registerManager.getRegisterById(e.registerId).then(t=>{if(!t)return;return this.registerManager.getActiveOutlet().id!==t.outlet_id?this.registerManager.getOutletById(t.outlet_id).then(t=>this.saleModals.warnThatOutletsDiffer({saleOutletName:t.name,saleStatus:e.status})):void 0})}exitTrainingModeIfNeeded(){return this.trainingModeManager.trainingModeEnabled?this.trainingModeManager.exitTrainingMode():We.resolve()}_showSaleDiscount(){this.shouldShowDiscount=!0,this.showDiscountPopover=!0}setSaleCalculatingState(e){this.saleManager.sale.lineItems.forEach(t=>{t.calculating=e}),this.saleCalculating=e}finaliseParkSale(){return this.saleManager.parkSale().then(()=>this.userSwitchingService.switchUserIfNeeded()).then(()=>this.focusGlobalSearch())}handleProductSelected(e,t){this.registerManager.isActiveRegisterOpen()&&this.saleManager.sale?(gc(t)?this.balancesGiftCardsModal.sellGiftCard().then(e=>{this.saleManager.addGiftCardItem({product:t,code:e.code,balance:e.value,expiresAt:e.expiresAt,isReload:e.isReload,clientId:e.clientId})}).catch(()=>{this.saleManager.saleCalculating=!1}):this.saleManager.addProductToSale(t),this.focusGlobalSearch()):(this.vdTracking.trackUserEvent({eventName:"Show Product Information",metadata:{view:"Register Closed Product Selected",isGiftCard:gc(t)}}),this.productModals.viewDetails(t))}handleUnknownProductSelected(e,{query:t,suggestions:n}){if(this.registerManager.isActiveRegisterOpen()&&this.saleManager.sale&&!n.length){const e=new Mc({name:t});this.saleManager.sale.unknownLineItems.push(e),this.saleManager.saveSale(),He.$emit("sale:add-unknown-line-item"),this.vdTracking.trackUserEvent({eventName:"Unknown Product Added",metadata:{query:t}})}}handleEmbeddedBarcodeSelected(e,{product:t,barcodeData:n}){if(this.registerManager.isActiveRegisterOpen()&&this.saleManager.sale){let e;const s=this.retailerSettingsManager.getBarcodeOption();"price"===s?e={price:n/100}:"weight"===s&&(e={quantity:n/1e3}),this.saleManager.addProductToSale(t,e),this.focusGlobalSearch()}}handleCustomerSelected(e,t){const n=this.saleManager.sale;if(this.registerManager.isActiveRegisterOpen()&&n){if(n.isConfirmedNotReadyToComplete()){const e=`You are currently viewing a retrieved ${this.wrSaleStatusFilter(this.saleManager.sale.status,"")} sale.\n            The customer can not be changed.`;this.vdToastNotificationService.negative({message:e})}else n.hasCustomerRelatedPayments()?this.vdToastNotificationService.negative({message:"The current sale has been partially paid. The customer can not be changed."}):(this.customerManager.refreshCustomer(t),this.saleManager.addCustomer(t));He.$emit("autocomplete:global-search:focus")}else this.vdTracking.trackUserEvent({eventName:"Show Customer Information",metadata:{view:"Register Closed Customer Selected"}}),this.customerModals.viewCustomer(t)}handleRemoveLineItem(e,t){this.saleManager.removeLineItem(t),this.focusGlobalSearch()}focusGlobalSearch(){Je(()=>He.$emit("autocomplete:global-search:focus"))}trackSaleActionButton(e){this.vdTracking.trackUserEvent({eventName:"Sale Action Buttons",metadata:{saleState:this.saleManager.sale.displayStatus,button:e}})}isRegisterOpenReminderNeeded(){Qe.debug("[SaleController] Register open reminder check"),this.showRegisterOpenReminder=this.registerManager.isRegisterOpenReminderNeeded(),(this.showRegisterOpenReminder||this.registerManager.isRegisterOpenReminderSeen())&&this.cancelPollForExpectedRegisterClosure()}pollForExpectedRegisterClosure(){this.expectedRegisterClosureInterval||(this.expectedRegisterClosureInterval=je(()=>this.isRegisterOpenReminderNeeded(),zd)),this.isRegisterOpenReminderNeeded()}cancelPollForExpectedRegisterClosure(){this.expectedRegisterClosureInterval&&(Qe.debug("[SaleController] Cancel open register reminder poll"),je.cancel(this.expectedRegisterClosureInterval),this.expectedRegisterClosureInterval=null)}toggleExpectedRegisterClosurePoll(){!this.trainingModeManager.trainingModeEnabled&&this.webRegisterStatusManager.isOnline()?this.pollForExpectedRegisterClosure():(this.cancelPollForExpectedRegisterClosure(),this.showRegisterOpenReminder=!1)}hasActiveSaleNote(){return Boolean(this.currentSale&&this.currentSale.note)}resetSaleForm(){this.saleForm&&(Qe.debug("[SaleController] Resetting sale form"),this.saleForm.$setPristine(),this.saleForm.$setUntouched(),this.saleForm.$error={},this.saleForm.$invalid=!1,this.saleForm.$valid=!0)}}eu.$inject=["$scope","$ngRedux","priceManager","saleManager","posStateManager","registerManager","saleLoader","customerModals","productModals","saleModals","wrSaleStatusFilter","userSwitchingService","workflowService","balancesGiftCardsModal","customerManager","vdToastNotificationService","trainingModeManager","vdTracking","registerModals","syncManager","vdLocalStorage","customerSuggestions","vdPerformanceTracking","webRegisterStatusManager","vdFeatureManager","userManager","vdPopover","vpPromotionModal","promotionModalService","retailerSettingsManager","currentSaleManager","markUnfulfilledModalService","saleTracker"],t.module("webregister.controllers").controller("SaleCtrl",eu);class tu{constructor(e,t,n,a,i,r,o,l,c,d,u,h,m,g,p,v,y,f,S,C,b,_,w,M,T,E,k,I,P){this.$scope=e,this.vdToastNotificationService=t,this.saleManager=n,this.wrSaleStatusFilter=a,this.balancesGiftCardsModal=i,this.bigcommerceGiftCertsModal=r,this.paymentManager=o,this.retailerSettingsManager=l,this.userManager=c,this.trainingModeManager=d,this.vdTracking=u,this.customerModals=h,this.webRegisterStatusManager=m,this.vdEscapeStack=g,this.customerBalancesManager=p,this.registerManager=v,this.paymentModalService=y,this.Confirm=f,this.vdWindowDelegate=S,this.vdPerformanceTracking=C,this.customerManager=b,this.vdActiveUser=_,this.wrIntegratedPaymentPromo=w,this.afterpayPaymentService=M,this.econduitPaymentService=T,this.klarnaPaymentService=E,this.paymentsResourceService=k,this.vdFeatureManager=I,s(this,"amountTendered",void 0),s(this,"currentBalance",void 0),s(this,"customerErrorTemplate",void 0),s(this,"customerGroup",void 0),s(this,"customerPaymentOptions",void 0),s(this,"customerSource",void 0),s(this,"hasValidTenderedAmount",void 0),s(this,"isStoreCreditEnabled",void 0),s(this,"loyaltyButtonConfig",void 0),s(this,"paymentFormCtrl",void 0),s(this,"paymentProcessing",!1),s(this,"paymentTypes",void 0),s(this,"sale",void 0),s(this,"showIntegratedPayPromo",!1),s(this,"paymentTypeDisabledTooltip",{template:'\n    <vd-tooltip>\n      <div class="vd-pa3">\n        <p class="vd-text-label vd-mb3"><i class="fa fa-info-circle vd-mr1"></i> You can\u2019t use this payment type while offline.</p>\n        <p class="vd-p">You need to be connected to the internet to take<br> payments using this payment type.</p>\n      </div>\n    </vd-tooltip>\n  '}),s(this,"vendNumberOptions",{updateOnChange:!0}),s(this,"balance",void 0),s(this,"closePaymentScreen",void 0),s(this,"hasXeroEnabled",void 0),s(this,"storeCreditButtonConfig",void 0),s(this,"currencyAdjustmentPaymentType",void 0),s(this,"loyaltyPaymentType",void 0),s(this,"roundingPaymentType",void 0),s(this,"storeCreditPaymentType",void 0),s(this,"whenPaymentTypesFetched",void 0),this.balance=n.sale.getOutstandingBalance(),this.closePaymentScreen=()=>{et.go(jt)},this.amountTendered=this.balance,this.trainingModeManager.trainingModeEnabled?this.customerSource=P.getSource({readOnly:!0}):this.customerSource=P.getSource({create:({query:e})=>this.customerModals.createCustomer({query:e}).then(e=>this.addCustomer(e))}),this.customerErrorTemplate=P.customerErrorTemplate,n.sale.hasValidCustomer()&&!n.sale.hideAttachCustomerTooltip&&(n.sale.hideAttachCustomerTooltip=!0,n.saveSale()),this.isStoreCreditEnabled=l.isStoreCreditEnabled(),this.hasXeroEnabled=l.isXeroIntegrationEnabled(),this.sale=this.saleManager.sale,this.init()}getAddCustomerPlaceholder(){let e="Add a customer to this sale.";return(this.saleManager.sale.getOutstandingBalance()>0||this.isStoreCreditEnabled)&&(e="Add a customer to pay with the following options:"),e}addCustomer(e){this.saleManager.addCustomer(e).then(()=>this.buildPaymentOptions()).then(()=>this.resolveCustomerGroup(this.sale.customer))}onCustomerResultSelected(e){const{customer:t}=e;this.addCustomer(t)}isLoyaltyEnabled(){return this.retailerSettingsManager.isLoyaltyEnabled()}laybyOnAccountSale(e){if(this.paymentProcessing)return;let t;this.paymentProcessing=!0,t=e===qn.LAYBY_SALE?this.saleManager.laybySale():this.saleManager.onAccountSale(),this.saleManager.sale.setSaleLoyaltyClaimCode(),t.then(()=>{this.vdTracking.trackUserEvent({eventName:"Open Sale Confirmation",metadata:{id:this.saleManager.sale.localId}}),this.paymentProcessing=!1,et.go(Ht)})}pay(e){let t;if(!this.paymentProcessing&&!this.paymentFormCtrl.$invalid){switch(this.trainingModeManager.trainingModeEnabled?this.vdTracking.trackUserEvent({eventName:this.trainingModeManager.currentTourType,metadata:{step:"Selected Payment Type",paymentType:e.name}}):this.vdPerformanceTracking.start("payment-tender"),this.paymentManager.paymentIntegrationReceiptMessage=null,this.paymentProcessing=!0,e.type_id){case hs.WORLDPAY:t=this.payWithSwiper(e);break;case hs.AFTER_PAY:t=this.payWithAfterpay(e);break;case hs.GIFT_CARD:t=this.payWithGiftCard(e);break;case hs.LOYALTY:t=this.payWithLoyalty(e);break;case hs.STORE_CREDIT:t=this.payWithStoreCredit(e);break;case hs.CASH:case hs.CASH_CONCEALED:case hs.CURRENCY:t=this.payWithCash(e);break;case hs.BIGCOMMERCE_GIFT_CERT:t=this.payWithBigCommerceGiftCert(e);break;default:{const n=e.config;t=n&&_e(n.url)?ks(e)&&this.vdFeatureManager.get("direct_econduit")?this.payWithSwiper(e):this.payWithIntegration(e):this.completePayment({paymentType:e})}}return t.finally(()=>{this.paymentProcessing=!1})}}shouldDisableTenderedAmount(){const e=this.klarnaPaymentService.hasKlarnaPayments({payments:this.sale.originalSalePayments}),t=this.afterpayPaymentService.hasAfterpayPayments({payments:this.sale.originalSalePayments})||e;return this.sale.isReturn()&&t}disableOnlinePaymentInOfflineMode(e){const t=e.payment_type&&e.payment_type.online_only,n=!this.webRegisterStatusManager.isOnline();return t&&n}disablePayment(e){if(this.disableOnlinePaymentInOfflineMode(e))return!0;if(!this.hasValidTenderedAmount)return!0;if(ks(e)&&this.vdFeatureManager.get("direct_econduit"))return this.econduitPaymentService.shouldDisableEconduitPayment(e,this.sale);switch(e.type_id){case hs.KLARNA:return this.klarnaPaymentService.shouldDisableKlarnaPayment(this.amountTendered,this.sale);case hs.AFTER_PAY:return this.afterpayPaymentService.shouldDisableAfterpayPayment(this.amountTendered,this.sale);case hs.BIGCOMMERCE_GIFT_CERT:case hs.GIFT_CARD:if(c.vn(this.sale.getOutstandingBalance()).lte(0))return!0;break;case hs.PAYJUNCTION:if(this.sale.isReturn()&&this.saleManager.sale.originalSalePayments.length>1)return!0}return this.checkDisabledStateForOtherPayments()}checkDisabledStateForOtherPayments(){const e=this.afterpayPaymentService.shouldPreventOtherPayments(this.amountTendered,this.sale),t=this.klarnaPaymentService.shouldPreventOtherPayments(this.amountTendered,this.sale);return e||t}payWithIntegration(e){const t=this.registerManager.getActiveRegister(),n=this.registerManager.getActiveOutlet(),s=t&&t.id,a=n.currency;if(this.vdEscapeStack.deregister(this.closePaymentScreen),this.sale.isReturn()){const t=fs({payments:this.saleManager.sale.originalSalePayments,paymentTypeId:e.type_id}).map(e=>e.id);if(t.length>0)return this.paymentsResourceService.getTransactions({registerId:s,registerSalePaymentIds:t}).then(n=>{if(n&&n.length>0){const i=this.getAllExternalTransactionIds(n);return this._payWithIntegration({currency:a,paymentType:e,registerId:s,externalTransactionIds:i,registerSalePaymentIds:t})}return this._payWithIntegration({currency:a,paymentType:e,registerId:s})}).catch(t=>(this.vdTracking.trackError("[Payment] could not get payment transactions.",{data:{error:t}}),this._payWithIntegration({currency:a,paymentType:e,registerId:s})))}return this._payWithIntegration({currency:a,paymentType:e,registerId:s})}getAllExternalTransactionIds(e){const t=[];return e.forEach(e=>e.tenders.forEach(e=>{"SALE"===e.type&&""!==e.external_transaction_id&&t.push(e.external_transaction_id)})),t}_payWithIntegration({currency:e,paymentType:t,registerId:n,externalTransactionIds:s,registerSalePaymentIds:a}){return this.paymentModalService.integratedPayment({currency:e,paymentType:t,amountTendered:this.amountTendered,sale:this.sale,registerId:n,externalTransactionIds:s,registerSalePaymentIds:a}).then(s=>this.handleAcceptIntegratedPayment({currency:e,paymentType:t,registerId:n,eventData:s})).catch(e=>this.handleDeclineIntegratedPayment({paymentType:t,eventData:e})).finally(()=>this.vdEscapeStack.register(this.closePaymentScreen))}completePayment({paymentAmount:e,paymentType:t,transactionData:n,paymentId:s,tipAmount:a}){const i=isFinite(e)?e:this.amountTendered;return this.saleManager.pay(i,t,n,s,a).then(e=>{this.balance=this.saleManager.sale.getOutstandingBalance();const t=e.finals.inclusivePrice,n=c.vn(t).gte(0),s=c.vn(t).lt(0),a=c.vn(this.balance).lte(0),i=c.vn(this.balance).eq(0);if(!this.trainingModeManager.trainingModeEnabled){const t=Oe(e.payments),{paymentType:n}=t;this.vdPerformanceTracking.stop("payment-tender",{metadata:{paymentTypeName:n.name,paymentTypeId:n.type_id,paymentDate:t.paymentDate,retailerPaymentTypeId:n.id,salePaymentId:t.localId}})}return n&&a||s&&i?this.saleManager.closeSale().then(()=>(this.vdTracking.trackUserEvent({eventName:"Open Sale Confirmation",metadata:{id:this.saleManager.sale.localId}}),et.go(Ht))).catch(e=>{this.vdTracking.trackError("[Payment view] could not complete payment.",{data:{error:e}})}):(this.amountTendered=this.balance,this.updateStoreCreditButtonDisabledState(),this.updateLoyaltyButtonDisabledState())})}payWithGiftCard(e){const t=this.getPaymentAmountForCashDiscounting();return c.vn(t).lte(0)?We.resolve(this.vdToastNotificationService.negative({message:"Please enter a positive amount."})):this.balancesGiftCardsModal.redeemGiftCard(t).then(t=>this.completePayment({paymentAmount:t.amountTendered,paymentType:e,transactionData:t}))}payWithBigCommerceGiftCert(e){const t=this.getPaymentAmountForCashDiscounting();return c.vn(t).lte(0)?We.resolve(this.vdToastNotificationService.negative({message:"Please enter a positive amount."})):this.bigcommerceGiftCertsModal.redeemGiftCard(t).then(t=>this.completePayment({paymentAmount:t.amountTendered,paymentType:e,transactionData:t}))}payWithCash(e){if(e.config){if(_e(e.config.url))return this.payWithIntegration(e);if(e.config.conversionRate)return this.payWithInternationalCurrency(e)}return this.saleManager.sale.hasCashDiscountingServiceFee(this.registerManager)?this.payWithCashDiscounting(e):this.vdFeatureManager.get("tender_flow_for_non_cash_rounding")||e.config&&e.config.rounding?this.payWithRoundedCash(e):this.completePayment({paymentType:e})}payWithInternationalCurrency(e){const t=c.multiply(this.amountTendered,e.config.conversionRate),n=c.subtract(t-this.amountTendered);return this.saleManager.pay(n,this.currencyAdjustmentPaymentType).then(e=>{this.balance=c.subtract(this.balance,n)}).then(()=>this.completePayment({paymentType:e}))}payWithRoundedCash(e){const n=c.vn(this.amountTendered),s=e.config&&e.config.rounding?e.config.rounding:"0.01",a=this.roundCash(n,e),i=this.roundCash(this.balance,e);if(To(n,c.vn(s))&&(n.isZero()||n.gt(0)&&n.gt(this.balance))){const t={remainder:i.remainder.toString(),cashAmount:n.toString()};return this.completeRoundedCashPayment(t,e)}{const n=this.registerManager.getActiveOutlet().currency_symbol;return this.paymentModalService.cashPayment(n,a,i,s).then(e=>e.close).then(t=>this.completeRoundedCashPayment(t,e)).catch(t.noop)}}payWithCashDiscounting(e){return this.paymentModalService.cashDiscountingPayment({amountTendered:this.amountTendered,balance:this.balance,cashDiscountedBalance:this.saleManager.getCashDiscountedOutstandingBalance()}).then(t=>{this.amountTendered=t,this.completePayment({paymentType:e})})}dismissIntegratedPayPromo(){this.vdActiveUser.setAttribute("dismiss_promo_ip_pay_screen",!0),this.vdTracking.trackUserEvent({moduleName:"Integrated Payments",eventName:"Recommendation Promo Dismissed",metadata:{source:"Sell Screen Payment"}}),this.showIntegratedPayPromo=!1}tenderRoundedCash(e,t){return We(n=>{this.amountTendered=e,this.$scope.$applyAsync(()=>{this.completePayment({paymentType:t}).then(n)})})}completeRoundedCashPayment(e,t){const{remainder:n,cashAmount:s}=e;return c.vn(0).eq(n)?this.tenderRoundedCash(s,t):this.saleManager.pay(n,this.roundingPaymentType).then(()=>(this.balance=c.subtract(this.balance,n),this.tenderRoundedCash(s,t)))}roundCash(e,t){const n={"round-up-always":(e,t)=>e.isZero()?t:t.plus(1),"round-mid-up":(e,t)=>e.greaterThanOrEqualTo(.5)?t.plus(1):t,"round-mid-down":(e,t)=>e.greaterThan(.5)?t.plus(1):t,"round-down-always":(e,t)=>t},s=c.vn(e).abs(),a=c.vn(e).isNegative();if(!t.config||!t.config.rounding)return{rounded:a?s.mul(-1):s,remainder:c.vn(0),wasNegative:a};const i=c.vn(t.config.rounding),r=c.vn(1).div(i),o=s.mul(r),l=o.truncated(),d=o.sub(l),u=(0,n[t.config.algorithm||"round-mid-down"])(d,l).dividedBy(r),h=s.minus(u);return{rounded:a?u.mul(-1):u,remainder:a?h.mul(-1):h,wasNegative:a}}payWithStoreCredit(e){const t=c.vn(this.balance).isNeg(),n=this.getPaymentAmountForCashDiscounting();if(t)return t&&!c.vn(this.amountTendered).isNeg()?We.resolve(this.vdToastNotificationService.negative({message:"Invalid tendered amount.\n    Please change the amount to tender, or choose another payment type."})):this.completePayment({paymentAmount:n,paymentType:e});{const t=this.getAvailableStoreCredit();return c.vn(n).gt(this.balance)?We.resolve(this.vdToastNotificationService.negative({message:"Amount tendered exceeds payment balance.\n    Please change the amount to pay with Store Credit, or choose another payment type."})):c.vn(n).isNeg()?We.resolve(this.vdToastNotificationService.negative({message:"Invalid tendered amount.\n    Please change the amount to tender, or choose another payment type."})):c.vn(n).gt(t)?this.paymentModalService.partialPayment(e,t).then(n=>n.close.then(n=>{if(n)return this.completePayment({paymentAmount:t,paymentType:e})})):this.completePayment({paymentAmount:n,paymentType:e})}}payWithLoyalty(e){const t=this.getPaymentAmountForCashDiscounting(),n=this.getAvailableLoyaltyBalance();return c.vn(t).gt(this.sale.getOutstandingBalance())?We.resolve(this.vdToastNotificationService.negative({message:"Amount tendered exceeds payment balance.\n    Please change the amount to pay with Loyalty, or choose another payment type."})):c.vn(t).gt(n)?this.paymentModalService.partialPayment(e,n).then(t=>t.close.then(t=>{if(t)return this.completePayment({paymentAmount:n,paymentType:e})})):this.completePayment({paymentAmount:t,paymentType:e})}resolveCustomerGroup(e){return this.customerManager.getCustomerGroup(e).then(e=>{this.customerGroup=e}).catch(e=>{Qe.warn("[paymentCtrl] Failed to lookup customer group",e)})}init(){this.sale&&this.sale.customer&&this.resolveCustomerGroup(this.sale.customer);const e=()=>{this.$scope.$applyAsync(()=>{this.buildPaymentOptions()})};this.userManager.on("loggedInUserChange",e,this);const t=e=>{if(!0===e.isSignatureSlipReceipt){const{paymentType:t,transaction:n}=e;this.printSignatureSlipReceipt(t,n)}else this.paymentManager.paymentIntegrationReceiptMessage=e.receiptHtmlExtra,this.printIntegratedPaymentReceipt()};this.paymentManager.on("printReceipt",t);const n=()=>{this.updateLoyaltyButtonDisabledState(),this.saleManager.updateCustomerBalances().then(()=>this.updateStoreCreditButtonDisabledState())};this.webRegisterStatusManager.on(Pn.statusChange,n,this),this.$scope.$watch("paymentCtrl.amountTendered",()=>{this.updateLoyaltyButtonDisabledState(),this.validateTenderedAmount()});const s=He.$on(Ns.SALE_CUSTOMER_UPDATED,()=>{this.fetchPaymentTypes().then(()=>this.buildCustomerPaymentOptions())});this.vdEscapeStack.register(this.closePaymentScreen),this.$scope.$on("$destroy",()=>{this.userManager.off("loggedInUserChange",e),this.paymentManager.off("printReceipt",t),this.webRegisterStatusManager.off(Pn.statusChange,n),this.vdEscapeStack.deregister(this.closePaymentScreen),s()}),this.buildPaymentOptions(),this.determineShowIntegratedPayPromo(),He.$emit("sale:payment")}buildPaymentOptions(){return We.all([this.fetchPaymentTypes(),this.saleManager.updateCustomerBalances()]).then(()=>this.buildCustomerPaymentOptions())}fetchPaymentTypes(){return this.whenPaymentTypesFetched||(this.whenPaymentTypesFetched=kc.all().then(e=>{this.setSystemPaymentTypes(e),this.paymentTypes=this.filterPaymentTypesForDisplay(e)})),this.whenPaymentTypesFetched}setSystemPaymentTypes(e){e.forEach(e=>{e.type_id===hs.STORE_CREDIT&&(this.storeCreditPaymentType=e),e.type_id===hs.ROUNDING&&(this.roundingPaymentType=e),e.type_id===hs.CURRENCY_ADJUST&&(this.currencyAdjustmentPaymentType=e),e.type_id===hs.LOYALTY&&(this.loyaltyPaymentType=e)})}filterPaymentTypesForDisplay(e){const t=this.trainingModeManager.trainingModeEnabled,n=this.vdFeatureManager.get("payment_type_controls"),s=this.registerManager.getActiveOutlet().id,a=[hs.LOYALTY,hs.XERO,hs.STORE_CREDIT,hs.ROUNDING,hs.CURRENCY_ADJUST];return t&&(a.push(hs.AFTER_PAY),a.push(hs.GIFT_CARD),a.push(hs.KLARNA),a.push(hs.WORLDPAY),a.push(hs.BIGCOMMERCE_GIFT_CERT)),e.filter(e=>{if(!!e.deleted_at)return!1;return!e.disabled&&(!(e=>{if(e&&e.platforms){const t=e.platforms;return t.includes("IPAD")&&1===t.length}return!1})(e.payment_type)&&(!a.includes(e.type_id)&&(!(t&&e.config&&e.config.url)&&!(n&&!Ts(e,s)))))})}buildCustomerPaymentOptions(){const e=[],{displayStatus:t}=this.sale,n=c.vn(this.balance).isNeg(),s=this.sale.hasValidCustomer(),a=this.userManager.hasPermission(ts.STORE_CREDIT_ISSUE_RETURN),i=!this.sale.isReturn()&&!n,r=t=>{e.push({id:t,label:this.wrSaleStatusFilter(t),action:()=>this.laybyOnAccountSale(t),isDisabled:!s||this.sale.isMarkedAsUnfulfilled()})};let o;if(i&&this.loyaltyPaymentType&&(o={id:"loyalty",label:this.loyaltyPaymentType.name,action:()=>this.pay(this.loyaltyPaymentType)},e.push(o)),(i||this.hasXeroEnabled&&this.sale.isReturn()&&!n)&&t!==qn.ACCOUNT_SALE&&!this.sale.containsGiftCard()&&this.userManager.hasPermission(ts.SALE_LAYBY)&&r(qn.LAYBY_SALE),this.isStoreCreditEnabled&&(!n||a)){const t={id:"storeCredit",label:this.storeCreditPaymentType.name,action:()=>this.pay(this.storeCreditPaymentType)};this.storeCreditButtonConfig=t,this.updateStoreCreditButtonDisabledState(),e.push(t)}(i||this.hasXeroEnabled)&&t!==qn.LAYBY_SALE&&this.userManager.hasPermission(ts.SALE_ON_ACCOUNT)&&r(qn.ACCOUNT_SALE),this.loyaltyButtonConfig=o,this.updateLoyaltyButtonDisabledState(),this.customerPaymentOptions=e}validateTenderedAmount(){this.hasValidTenderedAmount=t.isDefined(this.amountTendered),this.currentBalance=this.saleManager.sale.getOutstandingBalance();const e=c.vn(this.currentBalance).isNeg();this.hasValidTenderedAmount&&e&&(this.vendNumberOptions={updateOnChange:!0,min:this.currentBalance})}getAvailableStoreCredit(){if(!this.webRegisterStatusManager.isOnline()||!this.sale.customerBalances)return 0;const e=this.sale.customerBalances.storeCredit,t=e&&e.balance||0,n=this.customerBalancesManager.getTotalPartialPayments(hs.STORE_CREDIT,this.sale),s=c.subtract(t,n);return c.round(s,2,c.ROUNDING_MODES.ROUND_DOWN)}getAvailableLoyaltyBalance(){const e=this.customerBalancesManager.getTotalPartialPayments(hs.LOYALTY,this.sale),t=this.sale.customer.loyalty_balance;return c.round(c.subtract(t,e),2)}updateStoreCreditButtonDisabledState(){if(!this.storeCreditButtonConfig)return;const e=c.vn(this.balance).isNeg();if(this.sale.hasValidCustomer()){const t=this.getAvailableStoreCredit();if(this.storeCreditButtonConfig.isDisabled=!1,c.vn(t).lte(0)&&!e)return void(this.storeCreditButtonConfig.isDisabled=!0);e||this.sale.customerBalances&&this.sale.customerBalances.storeCredit||(this.storeCreditButtonConfig.isDisabled=!0),this.afterpayPaymentService.hasAfterpayPayments({payments:this.sale.originalSalePayments})&&(this.storeCreditButtonConfig.isDisabled=!0),this.klarnaPaymentService.hasKlarnaPayments({payments:this.sale.originalSalePayments})&&(this.storeCreditButtonConfig.isDisabled=!0)}else this.storeCreditButtonConfig.isDisabled=!0}updateLoyaltyButtonDisabledState(){if(!this.loyaltyButtonConfig)return;const e=this.webRegisterStatusManager.isOnline(),t=this.sale.hasValidCustomerWithLoyalty();if(e&&t){const e=this.getAvailableLoyaltyBalance();this.loyaltyButtonConfig.isDisabled=!1,(c.vn(e).lte(0)||c.vn(this.amountTendered).lte(0))&&(this.loyaltyButtonConfig.isDisabled=!0)}else this.loyaltyButtonConfig.isDisabled=!0}printIntegratedPaymentReceipt(){He.$emit(Ns.PRINT,{type:"receipt-settings-and-template",data:{trainingModeEnabled:this.trainingModeManager.trainingModeEnabled,sale:this.sale,receiptHtmlExtra:this.paymentManager.paymentIntegrationReceiptMessage,register:this.registerManager.getActiveRegister(),outlet:this.registerManager.getActiveOutlet()}})}printSignatureSlipReceipt(e,t){const n={isSignatureSlipReceipt:!0,paymentType:e,transaction:t};He.$emit(Ns.PRINT,{type:"receipt-settings-and-template",data:{trainingModeEnabled:this.trainingModeManager.trainingModeEnabled,sale:this.sale,paymentData:n,register:this.registerManager.getActiveRegister(),outlet:this.registerManager.getActiveOutlet()}})}trackIntegratedPaymentStep({paymentType:e,eventData:t}){if(!t)return;const{step:n,approved_amount:s="",message:a=""}=t;this.vdTracking.trackUserEvent({eventName:"Integrated Payment",metadata:{paymentId:t.payment_id,"Payment Type ID":e.type_id,Outcome:n,approvedAmount:s,message:a}})}handleAcceptIntegratedPayment({currency:e,paymentType:t,registerId:n,eventData:s}){s&&s.receipt_html_extra&&(this.paymentManager.paymentIntegrationReceiptMessage=s.receipt_html_extra),this.trackIntegratedPaymentStep({paymentType:t,eventData:s});let a=!1,i=null,r=this.amountTendered;s.approved_amount&&c.vn(this.amountTendered).gt(c.vn(s.approved_amount))&&(r=s.approved_amount,a=!0),this.vdFeatureManager.get("terminal_tipping")&&s.approved_amount&&c.vn(this.amountTendered).lt(c.vn(s.approved_amount))&&(r=s.approved_amount,i=c.subtract(s.approved_amount,this.amountTendered)),this.completePayment({paymentAmount:r,tipAmount:i,paymentType:t,transactionData:this.handleExternalPaymentData(s),paymentId:s.payment_id}).then(()=>{a&&this.paymentModalService.partialAuth(r).then(a=>{a.close.then(a=>{if(!a){const a=[];return s.external_transaction_id&&a.push(s.external_transaction_id),this.amountTendered=-r,this._payWithIntegration({currency:e,paymentType:t,registerId:n,externalTransactionIds:a})}})})})}handleExternalPaymentData(e){const t={};return e.external_transaction_id&&(t.external_transaction_id=e.external_transaction_id.substring(0,36),t.source="Swiper",t.source_id=e.external_transaction_id.substring(0,255)),e.merchant_id&&(t.merchant_id=e.merchant_id.substring(0,36)),e.reference_id&&(t.reference_id=e.reference_id.substring(0,36)),e.signature_url&&(t.signature_url=e.signature_url.substring(0,200)),e.signature_base64&&(t.signature_base64=e.signature_base64),e.transaction_status&&(t.transaction_status=e.transaction_status),e.auth_code&&(t.auth_code=e.auth_code.substring(0,16)),t.card=this.handlePaymentCard(e),t.terminal=this.handlePaymentTerminal(e),t.emv=this.handlePaymentEMV(e),t}handlePaymentCard(e){if(e.entry_method||e.card_brand||e.card_type||e.card_last_four||e.cardholder_name){const t={};return e.entry_method&&(t.entry_method=e.entry_method.substring(0,16)),e.card_brand&&(t.brand=e.card_brand.substring(0,20)),e.card_type&&(t.type=e.card_type.substring(0,6)),e.card_last_four&&(t.last_four=e.card_last_four.substring(0,4)),e.cardholder_name&&(t.cardholder_name=e.cardholder_name),t}return null}handlePaymentEMV(e){if(e.emv_aid||e.emv_application_label||e.emv_cryptogram_type||e.emv_cryptogram||e.emv_pin_verified||e.emv_tags){const t={};return e.emv_aid&&(t.aid=e.emv_aid.substring(0,16)),e.emv_application_label&&(t.application_label=e.emv_application_label.substring(0,16)),e.emv_cryptogram_type&&(t.cryptogram_type=e.emv_cryptogram_type.substring(0,4)),e.emv_cryptogram&&(t.cryptogram=e.emv_cryptogram),e.emv_pin_verified&&(t.pin_verified=e.emv_pin_verified),e.emv_tags&&(t.tags=e.emv_tags),t}return null}handlePaymentTerminal(e){if(e.terminal_serial_number||e.terminal_model){const t={};return e.terminal_serial_number&&(t.serial_number=e.terminal_serial_number.substring(0,36)),e.terminal_model&&(t.model=e.terminal_model.substring(0,36)),t}return null}handleDeclineIntegratedPayment({paymentType:e,eventData:t}){t&&t.receipt_html_extra&&(this.paymentManager.paymentIntegrationReceiptMessage=t.receipt_html_extra,this.printIntegratedPaymentReceipt()),this.trackIntegratedPaymentStep({paymentType:e,eventData:t})}payWithSwiper(e){if(this.vdEscapeStack.deregister(this.closePaymentScreen),!this.webRegisterStatusManager.isOnline()||!this.vdWindowDelegate.isOnline)return this.Confirm({header:"You\u2019re offline",content:`<p class="vd-p">${e.name} payments can not be accepted while the register is offline.</p>`,cancel:{isVisible:!1},confirm:{label:"Choose Another Payment Type"}}),this.vdEscapeStack.register(this.closePaymentScreen),We.reject();const t=this.registerManager.getActiveOutlet().currency;let n;if(this.sale.isReturn()){const t=fs({payments:this.saleManager.sale.originalSalePayments,paymentTypeId:e.type_id});n=t.length?t[0].id:null}return this.paymentModalService.swiperPayment({amount:this.amountTendered,paymentType:e,originalRegisterSalePaymentId:n,currency:t}).then(t=>this.handleSwiperPaymentSuccess({transaction:t,paymentType:e})).finally(()=>this.vdEscapeStack.register(this.closePaymentScreen))}handleSwiperPaymentSuccess({transaction:e,paymentType:t}){if(!e||!e.tenders)return this.vdTracking.trackError("[Payment] Missing required Swiper transaction details",{data:{transaction:e}}),We.reject();this.vdTracking.trackUserEvent({eventName:"Swiper Payment Completed",metadata:{paymentyTypeId:t.type_id,transactionId:e.id,amount:this.amountTendered}}),this.paymentManager.paymentIntegrationReceiptMessage=ys({receiptStatus:"ACCEPTED",transaction:e});const n=e.tenders[0],s={source:"Swiper",source_id:e.id,payment_id:e.register_sale_payment_id,external_transaction_id:n.external_transaction_id,signature_url:n.provider_fields.signature_url?n.provider_fields.signature_url:null,transaction_status:n.status,card:{entry_method:n.card_details.entry_method,brand:n.card_details.card.brand,type:n.card_details.card.type,last_four:n.card_details.card.last_four},emv:n.emv||null,provider_fields:n.provider_fields};let a,i=0;return"REFUND"===n.type?a=-n.amount:(a=(e=>{const t=e.filter(e=>e.type===ps.SALE||e.type===ps.TIP).map(e=>c.vn(e.amount));return t.length>0?c.add(...t):0})(e.tenders),i=(e=>{const t=e.filter(e=>e.type===ps.TIP).map(e=>c.vn(e.amount));return t.length>0?c.add(...t):0})(e.tenders)),this.completePayment({paymentAmount:a,paymentType:t,transactionData:s,tipAmount:i})}determineShowIntegratedPayPromo(){We.all({paymentOptions:this.buildPaymentOptions(),promoDismissed:this.vdActiveUser.getOrFetchBooleanAttribute("dismiss_promo_ip_pay_screen")}).then(({promoDismissed:e})=>e||this.paymentTypes.length>3?null:this.wrIntegratedPaymentPromo.getRecommendedProvider()).then(e=>{this.showIntegratedPayPromo=Boolean(e),this.showIntegratedPayPromo&&this.vdTracking.trackUserEvent({moduleName:"Integrated Payments",eventName:"Recommendation Promo Displayed",metadata:{source:"Sell Screen Payment",paymentProvider:e}})})}payWithAfterpay(e){this.vdEscapeStack.deregister(this.closePaymentScreen);return(c.vn(this.amountTendered).isNegative()?this.initiateAfterpayRefund(e):this.initiateAfterpayPayment(e)).finally(()=>this.vdEscapeStack.register(this.closePaymentScreen))}initiateAfterpayPayment(e){const t=p(this.saleManager.sale.lineItems,e=>({name:e.getName(),sku:e.getSku(),quantity:c.vn(e.quantity).toNumber(),price:c.vn(c.round(e.displayPrice)).toNumber()})),n=c.vn(this.amountTendered).abs();return We.resolve(n.toNumber()).then(n=>this.paymentModalService.afterpayPayment({amount:n,paymentType:e,products:t})).then(t=>this.completePayment({paymentType:e,transactionData:{payment_id:t.register_sale_payment_id,source:"Swiper",source_id:t.id,external_transaction_id:t.tenders[0].external_transaction_id}}))}initiateAfterpayRefund(e){const t=fs({payments:this.saleManager.sale.originalSalePayments,paymentTypeId:hs.AFTER_PAY}),n=c.vn(this.amountTendered).abs();return We.resolve(n.toNumber()).then(n=>this.paymentModalService.afterpayPayment({amount:n,paymentType:e,originalRegisterSalePaymentId:t[0].id})).then(t=>this.completePayment({paymentType:e,transactionData:{payment_id:t.register_sale_payment_id,source:"Swiper",source_id:t.id,external_transaction_id:t.tenders[0].external_transaction_id}})).catch(e=>{e&&e.error&&this.vdToastNotificationService.negative({message:e.error})})}getPaymentAmountForCashDiscounting(){const e=c.vn(this.amountTendered).eq(this.saleManager.sale.getOutstandingBalance());return this.saleManager.sale.hasCashDiscountingServiceFee(this.registerManager)&&e?this.saleManager.getCashDiscountedOutstandingBalance():this.amountTendered}getRemainingAmountIfTendered(){return c.subtract(this.saleManager.sale.getOutstandingBalance(),this.amountTendered)}invalidCustomerPaymentAmount(e){return(e===qn.LAYBY_SALE||e===qn.ACCOUNT_SALE)&&this.isPartialPayment()}isPartialPayment(){return this.getRemainingAmountIfTendered()>0&&this.saleManager.sale.getOutstandingBalance()>0}}tu.$inject=["$scope","vdToastNotificationService","saleManager","wrSaleStatusFilter","balancesGiftCardsModal","bigcommerceGiftCertsModal","paymentManager","retailerSettingsManager","userManager","trainingModeManager","vdTracking","customerModals","webRegisterStatusManager","vdEscapeStack","customerBalancesManager","registerManager","paymentModalService","Confirm","vdWindowDelegate","vdPerformanceTracking","customerManager","vdActiveUser","wrIntegratedPaymentPromo","afterpayPaymentService","econduitPaymentService","klarnaPaymentService","paymentsResourceService","vdFeatureManager","customerSuggestions"],t.module("webregister.controllers").controller("PaymentCtrl",tu);class nu{constructor(e,t,n,a,i,r,o,l,c,d,u,h,m,g,p,v){this.$scope=e,this.saleManager=t,this.vdTracking=n,this.registerManager=a,this.userManager=i,this.userSwitchingService=r,this.trainingModeManager=o,this.loyaltyManager=l,this.paymentManager=c,this.vdFeatureManager=d,this.vdEscapeStack=u,this.vdPerformanceTracking=h,this.vdPopover=m,this.customerModals=g,this.customerSuggestions=p,this.receiptSettingsStore=v,s(this,"_navigatingTo",void 0),s(this,"_unsubscribeStateChange",void 0),s(this,"_whenInitialised",void 0),s(this,"whenSaleCanBeFinalised",Promise.resolve()),s(this,"autoPrintEnabled",void 0),s(this,"clickedPrintReceiptButton",void 0),s(this,"completeSaleLabel",void 0),s(this,"customerErrorTemplate",void 0),s(this,"customerSource",void 0),s(this,"displayEmailReceipt",void 0),s(this,"hasMultipleReceipts",void 0),s(this,"hasTrackedSaleNoteUpdated",void 0),s(this,"isCompleted",void 0),s(this,"isConfirmedReadyToComplete",void 0),s(this,"isFinalisingSale",void 0),s(this,"loading",!0),s(this,"sale",void 0),s(this,"user",void 0),this._unsubscribeStateChange=nt.onStart({},e=>{if(!this.trainingModeManager.trainingModeEnabled)return this.closeSaleConfirmation({targetRoute:e.to().name,routeParams:e.params("to"),source:"stateChange"}),!1}),this.receiptSettingsStore.count().then(e=>{this.hasMultipleReceipts=e>1}).catch(e=>{Qe.warn("Failed to retrieve settings from receiptSettings store",e)}),this.user=this.userManager.getLoggedInUser(),this.trainingModeManager.trainingModeEnabled?this.customerSource=this.customerSuggestions.getSource({readOnly:!0}):this.customerSource=this.customerSuggestions.getSource({create:({query:e})=>this.customerModals.createCustomer({query:e}).then(e=>this.addCustomer(e))}),this.customerErrorTemplate=this.customerSuggestions.customerErrorTemplate,this.userManager.on("loggedInUserChange",this._onLoggedInUserChange,this),this._init();const y=()=>{this.trainingModeManager.trainingModeOnboardingState?this.completeTutorial({viaEscape:!0}):this.closeSaleConfirmation({source:"escape"})};this.vdEscapeStack.register(y),this.$scope.$on("$destroy",()=>{this._unsubscribeStateChange(),this.userManager.off("loggedInUserChange",this._onLoggedInUserChange),this.registerManager.off("activeRegisterChange",this._setRegisterSettings),this.vdEscapeStack.deregister(y)})}_onLoggedInUserChange(e){this.$scope.$applyAsync(()=>{this.user=e.loggedInUser})}getModelOptions(){return{updateOn:"default blur",debounce:{default:300,blur:0}}}shouldDisplaySaleNote(){return((e,t)=>{switch(e&&e.ask_for_note_on_save){case 1:return Boolean(t&&Hn.indexOf(t.displayStatus)>=0);case 2:return!0}return!1})(this.registerManager.getActiveRegister(),this.sale)}_setRegisterSettings(){const e=this.registerManager.getActiveRegister();this.displayEmailReceipt=e.email_receipt,this.autoPrintEnabled=e.print_receipt}_init(){return this._whenInitialised||(this._whenInitialised=this.registerManager.waitForSelectedRegister().then(()=>this.registerManager.isActiveRegisterOpen()?this.saleManager.init():(this._navigatingTo=[Xt,{}],We.reject("Register is closed"))).then(()=>{if(!this.saleManager.sale||!(this.saleManager.sale.isCompleted()||this.saleManager.sale.isConfirmedReadyToComplete()||this.saleManager.sale.isQuote()||this.saleManager.sale.isMarkedAsUnfulfilled()))return We.reject("Sale is not ready to be closed");this.sale=this.saleManager.sale,this.saleManager.sale.isMarkedAsUnfulfilled()&&(this.whenSaleCanBeFinalised=this.saleManager.setPickableState()),this.isCompleted=this.sale.isCompleted(),this.isConfirmedReadyToComplete=this.sale.isConfirmedReadyToComplete(),this.trainingModeManager.trainingModeEnabled?(this.completeSaleLabel="Start a new sale in training mode",this._unsubscribeStateChange()):this.completeSaleLabel="Complete Sale",this._setRegisterSettings(),this.registerManager.on("activeRegisterChange",this._setRegisterSettings,this),this.loading=!1}).catch(e=>{Qe.warn("[Sale Confirmation Ctrl] Redirecting due to error loading confirmation screen:",e),this._unsubscribeStateChange();const t=this._navigatingTo||[jt,{}],[n,s]=t;return et.go(n,s,{replace:!0}),We.reject()})),this._whenInitialised}completeTutorial(e){const t=this.trainingModeManager.currentTourType;this.trainingModeManager.trainingModeEnabled&&this.trainingModeManager.exitTrainingMode().then(()=>et.go(jt,{},{location:"replace",notify:!0})).then(()=>{this.vdTracking.trackUserEvent({eventName:t,metadata:{step:"Completed Tutorial",triggeredBy:e&&e.viaEscape?"Escape Key":"Button"}})})}canPrintGiftReceipt(){return this.vdFeatureManager.get("gift_receipts")&&this.sale&&Yn.indexOf(this.sale.displayStatus)>-1}printReceipt(e,t){this.trainingModeManager.trainingModeOnboardingState?this.vdTracking.trackUserEvent({eventName:this.trainingModeManager.currentTourType,metadata:{step:"Print Receipt Clicked"}}):this.vdTracking.trackUserEvent({eventName:"Print Receipt Clicked",metadata:{default_template:!1!==t,sale_id:this.sale.localId,sale_status:this.sale.status,template_id:e}}),this.saleManager.getReceiptData().then(t=>{e&&(t.selectedReceiptId=e),He.$emit(Ns.PRINT,{type:"receipt-settings-and-template",data:t})})}openReceiptSelectionPopover(e){this.clickedPrintReceiptButton=t.element(e.currentTarget)[0],this.clickedPrintReceiptButton.classList.add("vd-btn--active"),this.vdPopover.open({trigger:e.currentTarget,template:Xi,controller:"ReceiptSelectionPopoverController",hasPopoverList:!0,direction:"center",openAsModalAtViewport:"xsmall"}).then(e=>{e.closed.then(e=>{if(e){const{selectedReceipt:t,defaultTemplate:n}=e;this.printReceipt(t.id,n)}this.clickedPrintReceiptButton.classList.remove("vd-btn--active")})})}printGiftReceipt(){this.vdTracking.trackUserEvent({eventName:"Gift Receipt Clicked"}),this.saleManager.getReceiptData().then(e=>{He.$emit(Ns.PRINT,{type:"styled-gift-receipt",data:e})})}getNegativeQuantity(){return yc(this.sale,!0)}isExchange(){return(e=>{if(!e||!e.lineItems)return!1;const t=yc(e);if(c.vn(t).lte(0))return!1;const n=yc(e,!0);return c.vn(n).lt(0)})(this.sale)}saveSale(){this.saleManager.saveSale(),this.hasTrackedSaleNoteUpdated||(this.vdTracking.trackUserEvent({eventName:"User Updated Sale Note on Confirmation Screen"}),this.hasTrackedSaleNoteUpdated=!0)}editCustomerInformation(){this.customerModals.updateCustomer(this._getCustomer())}_getCustomer(){return this.saleManager.sale.customer}closeSaleConfirmation({targetRoute:e=jt,routeParams:t,source:n}){this._navigatingTo=[e,t],this.isFinalisingSale=!0,this._init().then(()=>{if(this.autoPrintEnabled&&!this.trainingModeManager.trainingModeOnboardingState&&this.printReceipt(),this._unsubscribeStateChange(),this.vdTracking.trackUserEvent({eventName:"Close Sale Confirmation",metadata:{id:this.sale.localId}}),this.sale.status===qn.ACCOUNT_SALE||this.sale.status===qn.ACCOUNT_SALE_CLOSED){const e=this.sale.lineItems;let t=0;e.forEach((function(e){null!=e.id&&t++})),t>0&&t<e.length&&this.vdTracking.trackUserEvent({eventName:"Added additional product(s) to on-account sale"})}const s=this.saleManager.sale.payments.map(e=>({paymentTypeName:e.paymentType.name,paymentTypeId:e.paymentType.type_id,paymentDate:e.paymentDate,retailerPaymentTypeId:e.paymentType.id,salePaymentId:e.localId}));this.saleManager.sale.completedByUser={source:n},this.whenSaleCanBeFinalised.then(()=>this.saleManager.finaliseSale()).then(()=>{this.paymentManager.paymentIntegrationReceiptMessage=null,et.go(e,t,{location:"replace"}).then(()=>(this.trainingModeManager.trainingModeEnabled||this.vdPerformanceTracking.stop("sale-process",{metadata:{payments:s}}),this.userSwitchingService.switchUserIfNeeded())).then(()=>Je(()=>He.$emit("autocomplete:global-search:focus")))})})}onCustomerResultSelected(e){const{customer:t}=e;this.addCustomer(t)}addCustomer(e){this.saleManager.addCustomer(e).then(()=>this.saleManager.saveSale())}}nu.$inject=["$scope","saleManager","vdTracking","registerManager","userManager","userSwitchingService","trainingModeManager","loyaltyManager","paymentManager","vdFeatureManager","vdEscapeStack","vdPerformanceTracking","vdPopover","customerModals","customerSuggestions","receiptSettingsStore"],t.module("webregister.controllers").controller("SaleConfirmationCtrl",nu);class su{constructor(e,t,n,a,i){this.saleManager=e,this.registerManager=t,this.retailerSettingsManager=n,this.$scope=a,this.$ngRedux=i,s(this,"disconnectRedux",void 0),s(this,"isStoreCreditEnabled",void 0),s(this,"isTaxInclusive",void 0),s(this,"note",void 0),s(this,"sale",void 0),this.isTaxInclusive=this.registerManager.isTaxInclusive(),this.isStoreCreditEnabled=this.retailerSettingsManager.isStoreCreditEnabled(),this.disconnectRedux=this.$ngRedux.connect(e=>e.currentSale)(e=>{this.note=e.note}),this.saleManager.init().then(()=>{this.sale=this.saleManager.sale}),this.$scope.$on("$destroy",()=>{this.disconnectRedux()})}closePaymentScreen(){et.go(jt)}}su.$inject=["saleManager","registerManager","retailerSettingsManager","$scope","$ngRedux"],t.module("webregister.controllers").controller("SaleSummaryCtrl",su);class au{constructor(e,t,n){this.$scope=e,this.quickKeysManager=t,this.userSwitchingService=n,s(this,"initialised",void 0),s(this,"layoutDataAdaptor",void 0),s(this,"quickKeyLayout",void 0),s(this,"quickKeysSetupInProgress",void 0),this.quickKeysManager.init().then(()=>{this.layoutDataAdaptor=this.quickKeysManager.createLayoutDataAdaptor(),this.quickKeysManager.on("quickKeyLayoutChange",this._setLayout,this),this.$scope.$on("$destroy",()=>{this.quickKeysManager.off("quickKeyLayoutChange",this._setLayout)}),this._setLayout()})}_setLayout(){this.$scope.$applyAsync(()=>{this.quickKeysSetupInProgress=!1,this.quickKeyLayout=this.quickKeysManager.quickKeyLayout,this.initialised=!0})}setUpQuickKeys(){this.quickKeysSetupInProgress=!0,this._retailerHasQuickKeyLayouts().then(e=>{e?et.go(tn):this.quickKeysManager.createLayout(this.quickKeysManager.defaultNewLayoutName).then(e=>this.quickKeysManager.navigateToEditState(e,!0),()=>{this.quickKeysSetupInProgress=!1})})}switchUser(){this.userSwitchingService.selectUser().catch(t.noop)}_retailerHasQuickKeyLayouts(){return this.quickKeysManager.getAllQuickKeyLayouts().then(e=>Boolean(e.length))}}au.$inject=["$scope","quickKeysManager","userSwitchingService"],t.module("webregister.controllers").controller("wrQuickKeysCtrl",au);class iu{constructor(e,n,a,i,r,o,l){this.close=e,this.options=n,this.customerModals=a,this.saleManager=i,this.trainingModeManager=r,this.customerBalancesManager=o,this.customerSuggestions=l,s(this,"cancelButtonLabel",void 0),s(this,"customer",void 0),s(this,"customerBalances",void 0),s(this,"customerErrorTemplate",void 0),s(this,"customerGroups",void 0),s(this,"customerSource",void 0),s(this,"isTrainingModeEnabled",void 0),s(this,"title",void 0),this.trainingModeManager.trainingModeEnabled?this.customerSource=this.customerSuggestions.getSource({readOnly:!0}):this.customerSource=this.customerSuggestions.getSource({create:({query:e})=>{const n=this.customerModals.createCustomer({query:e}).then(e=>this.saleManager.addCustomer(e)).catch(t.noop);this.close(n)}}),this.customerErrorTemplate=this.customerSuggestions.customerErrorTemplate,this.customerGroups=this.options.customerGroups;const c=Boolean(this.saleManager.sale.returnFor);this.title=`Add a customer to the ${c?"return ":""}sale`,this.cancelButtonLabel=this.options.cancelButtonLabel||"Cancel",this.isTrainingModeEnabled=this.trainingModeManager.trainingModeEnabled}onSelectResult(e){this.customerBalancesManager.getCustomerBalances(e.customer).then(e=>{this.customerBalances=e}),this.customer=e.customer}addNewCustomer(){const e=this.customerModals.createCustomer().then(e=>this.saleManager.addCustomer(e));this.close(e)}addCustomerToSale(){this.saleManager.addCustomer(this.customer).then(()=>this.close())}}iu.$inject=["close","options","customerModals","saleManager","trainingModeManager","customerBalancesManager","customerSuggestions"],t.module("webregister.controllers").controller("AddCustomerToSaleCtrl",iu);class ru{constructor(e,n,a,i,r,o){this.close=e,this.options=n,this.customerManager=a,this.saleManager=i,this.retailerSettingsManager=r,this.vdTracking=o,s(this,"awaitingServerResponse",void 0),s(this,"confirmCustomerEdit",void 0),s(this,"customer",void 0),s(this,"customerGroups",void 0),s(this,"editCustomerCtrlForm",void 0),s(this,"isExistingCustomer",void 0),this.customerGroups=this.options.customerGroups,this.isExistingCustomer=Boolean(this.options.customer),this.isExistingCustomer?(this.customer=t.copy(this.options.customer),this.confirmCustomerEdit=this._updateCustomer):(this._setNewCustomerDetails(this.options),this.confirmCustomerEdit=this._saveNewCustomer)}_haveAddressFieldsBeenModified(e){return ns.some(t=>{const n=this.editCustomerCtrlForm&&this.editCustomerCtrlForm[`${e}_${t}`];return n&&n.$dirty})}_trackCustomerAddressChanges(e){["postal","physical"].forEach(t=>{this._haveAddressFieldsBeenModified(t)&&this.vdTracking.trackUserEvent({eventName:"Modified customer address",metadata:{action:e,addressType:t}})})}_updateCustomer(){this.awaitingServerResponse=!0,this.customerManager.updateCustomer(this.customer).then(e=>{const t=this.saleManager.sale,n=t&&t.customer;n&&n.id===e.id&&(t.customer=e,He.$emit(Ns.SALE_CUSTOMER_UPDATED)),this.vdTracking.trackUserEvent({eventName:"Update customer"}),this._trackCustomerAddressChanges("Update"),this.close(e)}).finally(()=>{this.awaitingServerResponse=!1})}_saveNewCustomer(){this.awaitingServerResponse=!0,this.customerManager.saveNewCustomer(this.customer).then(e=>{this.vdTracking.trackUserEvent({eventName:"Create customer"}),this._trackCustomerAddressChanges("Create"),this.close(e)}).finally(()=>{this.awaitingServerResponse=!1})}_setNewCustomerDetails({query:e}){const t=this.customerGroups&&this.customerGroups[0],n=t&&t.id;this.customer={customer_group_id:n,enable_loyalty:this.retailerSettingsManager.isLoyaltyEnabled()},e&&this._setCustomerFieldFromQuery(e)}_setCustomerFieldFromQuery(e){const{email:t,mobile:n,firstName:s,lastName:a}=cs(e);this.customer.email=t,this.customer.mobile=n,this.customer.first_name=s,this.customer.last_name=a}}function ou(e){return{eventName:"Customer Lightbox",metadata:{Action:e}}}ru.$inject=["close","options","customerManager","saleManager","retailerSettingsManager","vdTracking"],t.module("webregister.controllers").controller("EditCustomerCtrl",ru);class lu{constructor(e,t,n,a,i,r,o,l,c,d){this.$scope=e,this.close=t,this.options=n,this.saleManager=a,this.posStateManager=i,this.webRegisterStatusManager=r,this.customerBalancesManager=o,this.retailerSettingsManager=l,this.userManager=c,this.vdTracking=d,s(this,"contactFieldsHaveData",void 0),s(this,"customer",void 0),s(this,"customerBalances",void 0),s(this,"customerContactFields",void 0),s(this,"customerInfoFields",void 0),s(this,"customerTabs",void 0),s(this,"hideEditCustomer",void 0),s(this,"hideRemoveFromSale",void 0),s(this,"hideViewSales",void 0),s(this,"isStoreCreditEnabled",void 0),s(this,"selectedCustomerTab",void 0),s(this,"trainingModeEnabled",void 0),s(this,"userCanIssueStoreCredit",void 0),s(this,"viewCustomerSalesUrl",void 0),s(this,"viewCustomerTrackData",void 0),s(this,"webRegisterOnline",void 0);const u=this.userManager.hasPermission(ts.STORE_CREDIT_ISSUE_MANUAL);this.customer=this.options.customer,this.hideRemoveFromSale=!this.saleManager.sale||this.options.hideRemoveFromSale,this.hideViewSales=this.options.hideViewSales,this.hideEditCustomer=this.options.hideEditCustomer,this.trainingModeEnabled=this.posStateManager.getTrainingModeEnabled(),this.isStoreCreditEnabled=this.retailerSettingsManager.isStoreCreditEnabled(),this.userCanIssueStoreCredit=u,this.selectedCustomerTab="customerDetails",this.viewCustomerSalesUrl=`${gn}?customerId=${this.customer.id}`,this.viewCustomerTrackData=ou("View customer sales"),this.customerInfoFields=["customer_code","gender","date_of_birth","custom_field_1","custom_field_2","custom_field_3","custom_field_4"],this.customerContactFields=["mobile","phone","fax","email","website","twitter","physical_address","postal_address"],this.customerTabs={customerDetails:"Customer details",storeCredit:"Store credit",notesOnCustomer:"Notes on customer"},this.customerBalancesManager.getCustomerBalances(this.customer).then(e=>{this.customerBalances=e}),this.contactFieldsHaveData=C(this.customerContactFields,e=>os(this.customer,e)),this._updateOnlineStatus(),this.webRegisterStatusManager.on(Pn.statusChange,this._updateOnlineStatus,this);let h=!0;this.$scope.$watch("viewCustomerCtrl.selectedCustomerTab",e=>{h?h=!1:this._trackCustomerModalAction(this.customerTabs[e])}),this.$scope.$on("$destroy",()=>{this.webRegisterStatusManager.off(Pn.statusChange,this._updateOnlineStatus)})}_trackCustomerModalAction(e){this.vdTracking.trackUserEvent(ou(e))}removeCustomerFromSale(){return this._trackCustomerModalAction("Remove from sale"),this.saleManager.removeCustomer().then(this.close())}editCustomer(){this._trackCustomerModalAction("Edit information"),this.close({customer:this.customer,action:"updateCustomer"})}issueStoreCredit(){this._trackCustomerModalAction("Issue store credit"),this.close({customer:this.customer,action:"issueStoreCredit"})}_updateOnlineStatus(){this.webRegisterOnline=this.webRegisterStatusManager.isOnline()}}lu.$inject=["$scope","close","options","saleManager","posStateManager","webRegisterStatusManager","customerBalancesManager","retailerSettingsManager","userManager","vdTracking"],t.module("webregister.controllers").controller("ViewCustomerCtrl",lu);class cu{constructor(e,t,n,a,i,r){this.close=e,this.options=t,this.customerBalancesManager=n,this.userManager=a,this.saleManager=i,this.vdToastNotificationService=r,s(this,"awaitingServerResponse",void 0),s(this,"customer",void 0),s(this,"header","Issue store credit"),s(this,"storeCreditData",void 0),s(this,"storeCreditIssuedData",void 0),this.customer=this.options.customer,this.storeCreditData={amount:null,notes:null}}issueStoreCredit(){this.awaitingServerResponse=!0,this.customerBalancesManager.issueStoreCredit(this.customer.id,this.storeCreditData).then(e=>{const t={transaction:e,customer:this.customer,user:this.userManager.getLoggedInUser()};return this.customerBalancesManager.getCustomerStoreCredit(this.customer).then(e=>(t.storeCredit=e,this.saleManager.sale&&this.saleManager.sale.customerBalances&&(this.saleManager.sale.customerBalances.storeCredit=e),t))}).then(e=>{this.header="Store credit issued",this.storeCreditIssuedData=e,He.$emit(Ns.SALE_CUSTOMER_UPDATED)}).catch(()=>this.vdToastNotificationService.negative({message:"There was an error issuing the store credit."})).finally(()=>{this.awaitingServerResponse=!1})}printReceipt(){const{user:e,customer:t,transaction:n}=this.storeCreditIssuedData,{amount:s,created_at:a,type:i}=n,r=this.saleManager.sale,o=r&&r.customer?this.customerBalancesManager.calculateStoreCreditBalance(r):s;He.$emit(Ns.PRINT,{type:"store-credit-issue-receipt",data:{amount:s,balance:c.round(o,2,c.ROUNDING_MODES.ROUND_DOWN),customerInfo:`${Bn(t)} (${t.customer_code})`,date:a,type:i,username:e.display_name}})}}cu.$inject=["close","options","customerBalancesManager","userManager","saleManager","vdToastNotificationService"],t.module("webregister.controllers").controller("IssueStoreCreditCtrl",cu),t.module("webregister.controllers").controller("StatusCtrl",(function(){}));class du{constructor(e,t,n,a,i,r){this.$scope=e,this.saleSyncManager=t,this.saleModals=n,this.userManager=a,this.retailerSettingsManager=i,this.vdTracking=r,s(this,"contactSupportUrl",void 0),s(this,"erroredSales",void 0),this.contactSupportUrl=_n.CONTACT_SUPPORT_URL,this.saleSyncManager.getErroredSales().then(e=>{this.erroredSales=e,this.saleSyncManager.on("saleSyncRetryComplete",this._onSaleSyncRetryComplete,this),this.$scope.$on("$destroy",()=>{this.saleSyncManager.off("saleSyncRetryComplete",this._onSaleSyncRetryComplete),this.saleSyncManager.clearErroredSalesFile()})})}_onSaleSyncRetryComplete(){this.saleSyncManager.getErroredSales().then(e=>{this.erroredSales=e})}_generateErroredSalesFile(){const e=this.retailerSettingsManager.get(),t={clientName:_n.APPLICATION_NAME,clientVersion:_n.CLIENT_VERSION,domainPrefix:e.domain_prefix,retailerId:e.id,userId:this.userManager.getLoggedInUser().id};return this.saleSyncManager.generateErroredSalesFile(t)}showDownloadErroredSalesModal(){this.vdTracking.trackUserEvent({eventName:"Download Errored Sales",metadata:{"Errored Sales Count":this.erroredSales.length}}),this._generateErroredSalesFile().then(e=>this.saleModals.downloadErroredSales(e))}}du.$inject=["$scope","saleSyncManager","saleModals","userManager","retailerSettingsManager","vdTracking"],t.module("webregister.controllers").controller("StatusErrorSalesCtrl",du);class uu{constructor(e,t,n,a,i,r){this.$scope=e,this.quickKeysManager=t,this.registerManager=n,this.vdTracking=a,this.vdToastNotificationService=i,this.retailerSettingsManager=r,s(this,"_isQuickKeysEnabled",void 0),s(this,"awaitingServerResponse",void 0),s(this,"registerMigrationDate",void 0),this._isQuickKeysEnabled=this.quickKeysManager.isQuickKeysEnabled(),this.$scope.$on("$destroy",()=>this.registerManager.off("activeRegisterChange",this._onActiveRegisterChange)),this.retailerSettingsManager.init().then(()=>{this.registerMigrationDate=this.retailerSettingsManager.getRegisterMigrationDate(),this.registerManager.on("activeRegisterChange",this._onActiveRegisterChange,this)})}toggleQuickKeysEnabled(e){return t.isUndefined(e)?this._isQuickKeysEnabled:(this._isQuickKeysEnabled=e,this.awaitingServerResponse=!0,this.registerManager.enableQuickKeys(this._isQuickKeysEnabled).then(()=>this.vdTracking.trackUserEvent({eventName:"Quick Key Actions",metadata:{Event:"Quick Keys "+(this._isQuickKeysEnabled?"Enabled":"Disabled")}})).catch(()=>{this.vdToastNotificationService.negative({message:`There was a problem ${this._isQuickKeysEnabled?"enabling":"disabling"} Quick Keys, please try\n            again.`}),this._isQuickKeysEnabled=!this._isQuickKeysEnabled}).finally(()=>(this.awaitingServerResponse=!1,this._isQuickKeysEnabled)))}_onActiveRegisterChange(){this._isQuickKeysEnabled=this.quickKeysManager.isQuickKeysEnabled()}}uu.$inject=["$scope","quickKeysManager","registerManager","vdTracking","vdToastNotificationService","retailerSettingsManager"],t.module("webregister.controllers").controller("SettingsCtrl",uu);class hu{constructor(e,t,n,a,i,r,o,l){this.$scope=e,this.quickKeysManager=t,this.syncManager=n,this.vdToastNotificationService=a,this.registerManager=i,this.vdTracking=r,this.productModals=o,this.productSuggestions=l,s(this,"isCloseFolderEnabled",void 0),s(this,"isNewLayout",void 0),s(this,"isSaving",!1),s(this,"layoutDataAdaptor",void 0),s(this,"quickKeyLayout",void 0),s(this,"quickKeyLayoutName",void 0),s(this,"quickKeySettingsForm",void 0),s(this,"settingsState",tn),s(this,"suggestionSource",void 0),this.suggestionSource=this.productSuggestions.getSource();const c=nt.onStart({},()=>this.syncManager.sync());this.$scope.$on("$destroy",()=>{this.layoutDataAdaptor&&(this.layoutDataAdaptor.off("layoutUpdate",this._onLayoutUpdate),this.layoutDataAdaptor.off("layoutUpdateError",this._onLayoutUpdateError)),this.registerManager.off("activeRegisterChange",this._onActiveRegisterChange),c()}),this.quickKeysManager.init().then(()=>Vs.get(tt.layoutId)).then(e=>{e?(this.quickKeyLayout=e,this.isNewLayout=tt.newLayout,this.quickKeyLayoutName=this.isNewLayout?"":this.quickKeyLayout.name,this.layoutDataAdaptor=this.quickKeysManager.createLayoutDataAdaptor(),this.layoutDataAdaptor.whenRegistered().then(()=>{this.layoutDataAdaptor.on("layoutUpdate",this._onLayoutUpdate,this),this.layoutDataAdaptor.on("layoutUpdateError",this._onLayoutUpdateError,this),this.registerManager.on("activeRegisterChange",this._onActiveRegisterChange,this),this.isCloseFolderEnabled=!this.layoutDataAdaptor.getCloseFolderOption()})):this._notifyLayoutNotFound()})}onSelectResult(e){if(t.isArray(e)&&(e.length>1&&Qe.warn("[Edit Quick Key Layout Search] Multiple product matches",e),e=e[0]),Qe.debug("[Edit Quick Key Layout Search] Product Selected",e),e.variantCount&&!e.exactMatch){const t={parentProduct:e.product,title:"What would you like to set as this Quick Key?",allowVariantParentSelect:!0};this.productModals.selectVariant(t).then(e=>{e.exactMatch?this.layoutDataAdaptor.addProduct(e.variant,{exactMatch:e.exactMatch}):this.layoutDataAdaptor.addProduct(e.product,{exactMatch:e.exactMatch})}).catch(()=>{})}else this.layoutDataAdaptor.addProduct(e.product,{exactMatch:e.exactMatch})}canUpdateLayout(){return!this.isSaving}save(){return this.isSaving=!0,this.quickKeySettingsForm.$invalid?(this.isSaving=!1,this.quickKeySettingsForm.layoutName.$setDirty(),void this.vdToastNotificationService.negative({message:"Please complete the highlighted fields to continue."})):this.quickKeySettingsForm.$dirty?void this.layoutDataAdaptor.setCloseFolderOption(!this.isCloseFolderEnabled).then(()=>this._updateLayoutName()).then(()=>this.quickKeySettingsForm.$setPristine()).catch(()=>{this.vdToastNotificationService.negative({message:"There was a problem updating the layout, please try again."})}).finally(()=>{this.isSaving=!1,this.isNewLayout=!1}):(this.isSaving=!1,et.go(this.settingsState))}_updateLayoutName(){return this.quickKeysManager.updateLayout(this.quickKeyLayout.id,{name:this.quickKeyLayoutName}).then(()=>{this.quickKeyLayout.name=this.quickKeyLayoutName})}_setQuickKeyLayout(){return Vs.get(tt.layoutId).then(e=>{this.quickKeyLayout=e})}_onLayoutUpdate(e){e&&e.layoutData&&Vs.put(e.layoutData)}_onLayoutUpdateError(e){Qe.warn("[Edit Quick Key Layout] Error updating quick key layout",e.error),this.vdToastNotificationService.negative({message:"There was an error making that change, please wait while we refresh your quick keys."}),this.quickKeyLayout=null,this.syncManager.sync().then(()=>this._setQuickKeyLayout())}_onActiveRegisterChange(){et.go(this.settingsState)}_notifyLayoutNotFound(){this.vdToastNotificationService.negative({message:"There was a problem loading the quick key layout. Please try again."}),this.vdTracking.trackError("[EditQuickKeyLayoutCtrl] Error attempting to edit unknown layout",{data:{layoutId:tt.layoutId}}),et.go(tn)}}hu.$inject=["$scope","quickKeysManager","syncManager","vdToastNotificationService","registerManager","vdTracking","productModals","productSuggestions"],t.module("webregister.controllers").controller("EditQuickKeyLayoutCtrl",hu);class mu{constructor(e,t,n,a,i,r){this.$scope=e,this.cashManagementModals=t,this.cashMovementsManager=n,this.registerManager=a,this.userManager=i,this.userSwitchingService=r,s(this,"activeRegister",void 0),s(this,"canEnableCashManagement",void 0),s(this,"cashManagementEnabled",void 0),s(this,"cashMovements",void 0),s(this,"enableCashManagementUrl",void 0),s(this,"failedCashMovementsRetrieval",void 0),s(this,"isCashFloatSet",void 0),s(this,"waitingForInitialCashMovements",void 0),this.registerManager.on("activeRegisterChange",this._init,this),this.userManager.on("loggedInUserChange",this._setCanEnableCashManagement,this),this.$scope.$on("$destroy",()=>{this.registerManager.off("activeRegisterChange",this._init),this.userManager.off("loggedInUserChange",this._setCanEnableCashManagement)}),this._init()}recordCashMovement(e){this.cashManagementModals.recordCashMovement(e).then(()=>this.retrieveCashMovements())}retrieveCashMovements(){this.cashMovementsManager.getCashMovements().then(e=>{this.failedCashMovementsRetrieval=!1,this.cashMovements=e,this.isCashFloatSet=Boolean(g(e,{type:us.OPENING_CASH_FLOAT}))}).catch(()=>{this.failedCashMovementsRetrieval=!0}).finally(()=>{this.waitingForInitialCashMovements=!1})}_setCashManagementEnabled(){this.cashManagementEnabled=this.cashMovementsManager.isCashManagementEnabled()}switchUser(){this.userSwitchingService.selectUser().catch(t.noop)}_setCanEnableCashManagement(){this.canEnableCashManagement=this.userManager.hasAdminAccess()}_init(){this.activeRegister=this.registerManager.getActiveRegister(),this.activeRegister&&(this.enableCashManagementUrl=`/register/${this.activeRegister.id}/edit`,this._setCashManagementEnabled(),this._setCanEnableCashManagement()),this.registerManager.isActiveRegisterOpen()&&this.cashManagementEnabled&&(this.waitingForInitialCashMovements=!0,this.retrieveCashMovements())}}function gu(e,t,n,s){this.close=e,this.parentProductData=t.parentProductData,this.parentProduct=t.parentProductData.parentProduct,this.outlets=t.outlets,this.hasVariants=Boolean(this.parentProduct.variant_options.length),this.hasInventory=this.parentProduct.has_inventory,this.canViewSupplierPrice=s.hasPermission(ts.PRODUCT_VIEW_COST)&&!this.hasVariants,this.imagesAvailable=Boolean(this.parentProduct.images.length)&&n.isOnline(),this.inventoryAvailable=this.hasInventory&&n.isOnline(),this.parentDescription=Ye.trustAsHtml(Z.sanitize(this.parentProduct.description))}mu.$inject=["$scope","cashManagementModals","cashMovementsManager","registerManager","userManager","userSwitchingService"],t.module("webregister.controllers").controller("CashManagementCtrl",mu),gu.$inject=["close","options","webRegisterStatusManager","userManager"],t.module("webregister.controllers").controller("ViewProductDetailsCtrl",gu);const pu={recordsTransactions:!1,terms:{card:"certificate",code:"code",giftCard:"gift certificate",giftCardCode:"gift certificate code"}},vu={recordsTransactions:!0,terms:{card:"card",code:"number",giftCard:"gift card",giftCardCode:"gift card number"}};class yu{constructor(e,t,n,a,i,r,o,l){this.providerSettings=e,this.close=t,this.amountTendered=n,this.giftCardCodeRegex=a,this.giftCardCodeMaxChars=i,this.workflow=r,this.outlet=o,this.valueInputOptions=l,s(this,"dismissible",!0),s(this,"giftCard",{code:""}),s(this,"giftCardTransactions",void 0),s(this,"potentialBalance",void 0),s(this,"reloadBalance",void 0),s(this,"state",void 0),s(this,"waiting",!1),this.state=this.workflow;for(const s of Object.keys(sc))ze.put(this.getTemplateUrl(s),sc[s])}isSellingWorkflow(){return this.workflow===Xl}getTemplateUrl(e){return"GIFT_CARD_"+e}getTemplate(){return this.getTemplateUrl(this.state)}resetStateAndGiftCard(){this.giftCard={code:""},this.giftCardTransactions=null,this.state=this.workflow}addBalance(){this.state=nc,this.giftCardTransactions=null}addGiftCardReloadToSale(){this.close({code:this.giftCard.code,value:this.reloadBalance,isReload:!0,clientId:se(),expiresAt:this.giftCard.expiresAt})}updatePotentialBalance(){this.reloadBalance=this.reloadBalance||c.vn(0);const e=c.add(this.reloadBalance,this.giftCard.balance);this.potentialBalance=c.round(e,2)}getGiftCardExpiryDate(){return this.giftCard.expiresAt?Un(this.giftCard.expiresAt,"MMM DD, YYYY",this.outlet.time_zone):"None"}shouldShowGiftCardExpiry(){return!!this.giftCard.expiresAt}getPayableAmount(){return this.isBalanceSufficient()?this.amountTendered:this.giftCard.balance}hasBalance(){return c.vn(this.giftCard.balance).gt(0)}isBalanceSufficient(){return c.vn(this.giftCard.balance).gte(this.amountTendered)}calculateTransactionsBalance(e){this.giftCardTransactions=v(e,"created_at"),this.giftCardTransactions.forEach((e,t)=>{e.balance=0===t?e.amount:c.add(this.giftCardTransactions[t-1].balance,e.amount)})}}class fu extends yu{constructor(e,t,n,s,a,i,r){super(vu,e,t.amount,/^[-0-9a-zA-Z]{1,64}$/,64,t.workflow,n.getActiveOutlet(),{min:.01,decimalPlaces:2,allowedPrefix:n.getActiveOutlet().currency_symbol}),this.vdToastNotificationService=s,this.saleManager=a,this.BalancesResource=i,this.userManager=r}getSearchModalTitle(){return this.isSellingWorkflow()?"Add new or manage existing gift card.":"Scan or Enter a Gift Card Number"}getSearchModalText(){return this.isSellingWorkflow()?"Add a new gift card to the sale, check the balance of an existing gift card, or reload an existing gift card.":"Check an existing card\u2019s status and balance."}retrieveGiftCard(){const e=this.giftCard.code;this.saleManager.sale.containsGiftCardByNumber(e)?this.vdToastNotificationService.negative({message:"This gift card has been added to the sale. Please use a different gift card number."}):(this.waiting=!0,this.BalancesResource.getGiftCard(e).then(e=>(this.giftCard=jr(e),this.userManager.hydrateUsers(e.gift_card_transactions).then(e=>{this.calculateTransactionsBalance(e),this.state=tc}))).catch(e=>{switch(e.status){case 0:{const e=this.isSellingWorkflow()?"Gift cards can only be sold when the Sell screen is online.":"Gift cards can not be redeemed when the Sell screen is offline.";this.vdToastNotificationService.negative({message:e});break}case 404:this.isSellingWorkflow()?(this.giftCard.expiresAt=e.headers("expected-expiry-date"),this.state=ec):this.vdToastNotificationService.negative({message:"Gift card not activated. Please check again or enter another number."});break;default:this.vdToastNotificationService.negative({message:"Sorry, something went wrong. Please try again."})}}).finally(()=>{this.waiting=!1}))}payWithGiftCard(){const e=this.getPayableAmount(),t=this.giftCard.code;this.dismissible=!1,this.waiting=!0,this.BalancesResource.postGiftCardTransaction(t,{type:"REDEEMING",amount:-Number(e)}).then(t=>{this.close({amountTendered:e,source:"Vend Gift Card",source_id:t.id})}).catch(()=>{this.vdToastNotificationService.negative({message:"Sorry, something went wrong. Please try again."}),this.waiting=!1,this.dismissible=!0})}}fu.$inject=["close","options","registerManager","vdToastNotificationService","saleManager","BalancesResource","userManager"];const Su="NOT_FOUND",Cu="INSUFFICIENT_FUNDS",bu="EXPIRED",_u=new Error("Sorry, could not find a BigCommerce channel.");class wu extends yu{constructor(e,t,n,s,a){super(pu,e,t.amount,/^[-0-9a-zA-Z]{1,15}$/,15,t.workflow,n.getActiveOutlet(),{min:.01,decimalPlaces:2,allowedPrefix:n.getActiveOutlet().currency_symbol}),this.vdToastNotificationService=s,this.giftCardsResource=a}getSearchModalTitle(){return"Enter a Gift Certificate Code"}getSearchModalText(){return"Check an existing certificate\u2019s status and balance."}retrieveGiftCard(){const e=this.giftCard.code;this.waiting=!0,Qc.getByChannelType("bigcommerce").then(e=>{if(e.length<1)throw _u;return e[0].id}).then(t=>this.giftCardsResource.getGiftCardByCode(t,e)).then(e=>{e?(this.giftCard=e,this.state=tc):this.vdToastNotificationService.negative({message:"Gift certificate not activated. Please check again or enter another number."})}).catch(e=>{if(e!==_u)switch(e.status){case 0:{const e="Gift certificates can not be redeemed when the Sell screen is offline.";this.vdToastNotificationService.negative({message:e});break}default:this.vdToastNotificationService.negative({message:"Sorry, something went wrong. Please try again."})}else this.vdToastNotificationService.negative({message:"Sorry, could not find a BigCommerce channel."})}).finally(()=>{this.waiting=!1})}payWithGiftCard(){const e=this.getPayableAmount(),t=this.giftCard.id;this.dismissible=!1,this.waiting=!0,Qc.getByChannelType("bigcommerce").then(e=>{if(e.length<1)throw _u;return e[0].id}).then(n=>this.giftCardsResource.redeemGiftCard(n,t,Number(e))).then(t=>{this.close({amountTendered:e,source:"BigCommerce Gift Certificate",source_id:t})}).catch(e=>{switch(e.message){case bu:this.vdToastNotificationService.negative({message:"Sorry, Gift Certificate has expired."});break;case Cu:this.vdToastNotificationService.negative({message:"Sorry, insufficient funds available."});break;case Su:this.vdToastNotificationService.negative({message:"Sorry, Gift Certificate couldn\u2019t be found."});break;default:this.vdToastNotificationService.negative({message:"Sorry, something went wrong. Please try again."})}this.waiting=!1,this.dismissible=!0})}}wu.$inject=["close","options","registerManager","vdToastNotificationService","giftCardsResource"];class Mu{constructor(e,t,n){this.close=e,this.vdTracking=n,s(this,"note",void 0),s(this,"isParkSale",void 0),s(this,"isReturn",void 0),this.note=t.currentNote,this.isParkSale=t.isParkSale,this.isReturn=t.isReturn}addNoteAndParkSale(e){e&&this.vdTracking.trackUserEvent({eventName:"Quote Clicked",metadata:{has_note:Boolean(this.note)}}),this.close({note:this.note,isQuote:e})}}Mu.$inject=["close","options","vdTracking"];class Tu{constructor(e,t,n,a,i,r){this.close=t,this.options=n,this.registerManager=a,this.userManager=i,s(this,"activeRegister",void 0),s(this,"dismissible",void 0),s(this,"registersByOutlet",[]),s(this,"selectedOutlet",0),this.dismissible=n.dismissible||!1,this.activeRegister=a.getActiveRegister(),this._setRegistersByOutlet(),i.on("loggedInUserChange",this._setRegistersByOutlet,this),r.on(Pn.statusChange,this.close,this),e.$on("$destroy",()=>{i.off("loggedInUserChange",this._setRegistersByOutlet),r.off(Pn.statusChange,this.close)})}selectRegister(e,t){this.activeRegister&&this.activeRegister.id===e.id||this.registerManager.setActiveRegister(e,t),this.close()}getRegisterTradingStatus(e,t){function n(e){return u(e).tz(t.time_zone).format("h:mma, Do MMM")}return e.is_open?"Opened at "+n(e.register_open_time):null!==e.register_close_time?"Closed at "+n(e.register_close_time):"Closed"}_setRegistersByOutlet(){const e=this.userManager.getLoggedInUser();this.registerManager.getAllRegistersByOutlet({restrictedOutlets:e.restricted_outlet_ids}).then(e=>{this.registersByOutlet=e,this._setTabForActiveOutlet()})}_setTabForActiveOutlet(){const e=this.registerManager.getActiveOutlet();let t=0;e&&(t=f(this.registersByOutlet,t=>t.outlet.id===e.id)),this.selectedOutlet=-1!==t?t:0}}Tu.$inject=["$scope","close","options","registerManager","userManager","webRegisterStatusManager"];class Eu{constructor(e,t,n,a,i){this.registerManager=t,this.registerClosureManager=n,this.vdTracking=i,s(this,"CLOSE_REGISTER_STATE",Jt),s(this,"isCashManagementEnabled",void 0),s(this,"isRegisterOpen",void 0),s(this,"registerClosure",void 0),s(this,"registerClosureSalesUrl",void 0),this.isCashManagementEnabled=a.isCashManagementEnabled(),this.isRegisterOpen=t.isActiveRegisterOpen(),this._getLastRegisterClosureSummary(),t.on("registerIdChange",this._evaluateRegisterState,this),t.getActiveRegister()||t.once("activeRegisterChange",this._evaluateRegisterState,this),e.$on("$destroy",()=>{this.registerManager.off("registerIdChange",this._evaluateRegisterState),this.registerManager.off("activeRegisterChange",this._evaluateRegisterState)})}registerSaleTracking(){this.vdTracking.trackUserEvent({eventName:"Register Closure Summary Visit"})}printSummary(){He.$emit(Ns.PRINT,{type:"register-closure",data:this.registerClosureManager.generateRegisterClosurePrintData(this.registerClosure)})}_evaluateRegisterState(){this.isRegisterOpen=this.registerManager.isActiveRegisterOpen(),this.isRegisterOpen?et.go(this.CLOSE_REGISTER_STATE):this._getLastRegisterClosureSummary()}_setRegisterClosureSalesUrl(e){let t;if(e){t="/register/closure/summary/"+e.register_closure_id}this.registerClosureSalesUrl=t}_getLastRegisterClosureSummary(){this.registerClosureManager.getLastRegisterClosureSummary().then(e=>{this.registerClosure=e,this._setRegisterClosureSalesUrl(e)})}}Eu.$inject=["$scope","registerManager","registerClosureManager","cashMovementsManager","vdTracking"];class ku{constructor(e,t,n){this.registerClosureManager=t,this.registerManager=n,s(this,"OPEN_REGISTER_STATE",Xt),s(this,"isErrored",!1),s(this,"isRetrieving",!0),s(this,"registerClosure",void 0),this._getRegisterClosureSummary(),n.on("registerIdChange",this._onRegisterIdChange,this),e.$on("$destroy",()=>n.off("registerIdChange",this._onRegisterIdChange))}_onRegisterIdChange(){this.registerManager.isActiveRegisterOpen()?this._getRegisterClosureSummary():et.go(this.OPEN_REGISTER_STATE)}_getRegisterClosureSummary(){this.isRetrieving=!0,this.registerClosureManager.getRegisterClosureSummary().then(e=>{this.registerClosure=e,this.isRetrieving=!1,this.isErrored=!1}).catch(()=>{this.isRetrieving=!1,this.isErrored=!0})}}ku.$inject=["$scope","registerClosureManager","registerManager"],t.module("webregister.controllers").controller("BalancesGiftCardsController",fu).controller("BigCommerceGiftCertsController",wu).controller("ActionAddNoteParkSaleController",Mu).controller("SelectRegisterController",Tu).controller("OpenRegisterController",Eu).controller("CloseRegisterController",ku);var Iu=$e({note:(e=null,t)=>{switch(t.type){case"SET_NOTE":return t.payload||null;default:return e}}});const Pu=Le($e({currentSale:Iu}),window.__REDUX_DEVTOOLS_EXTENSION__&&window.__REDUX_DEVTOOLS_EXTENSION__());function Ru(e,t,n,s){const a=s.getEnableDebugLoggingPrefix(),i=new RegExp("^"+a),r=n.$get(),o=Ut.isDevelopment();let l=o;r&&i.test(r.name)&&(o||(l=!0),r.name=r.name.replace(i,"")),e.debugInfoEnabled(o),t.debugEnabled(l)}t.module("webregister.vendor",["ngAnimate","ngResource","ngMessages","ui.router","product-ui","vend.js","vend.ui","vendQuickKeys",Fe]).config(["$ngReduxProvider",e=>{e.provideStore(Pu)}]),t.module("webregister").config(["vdActiveUserProvider",function(e){e.addResourceWrapper(["$q","VdUserModel","webRegisterStatusManager","posStateManager",function(e,t,n,s){function a(){return e((e,n)=>{const a=s.getUser();a?e(new t(a)):n(new wn("No logged in user found"))})}return function(e){return n.init().then(()=>n.isOnline()?e().catch(()=>a()):a())}}])}]),Ru.$inject=["$compileProvider","$logProvider","$windowProvider","wrDebugToolsProvider"],t.module("webregister").config(Ru),t.module("webregister").config(["$httpProvider",function(e){e.interceptors.push("abortRequestWhenOffline"),e.interceptors.push("apiIdentification"),e.interceptors.push("redirectSigninOn401"),e.interceptors.push("redirectBillingOn402")}]),t.module("webregister").config(["vdFeatureManagerProvider","wrDebugToolsProvider",function(e,t){t.register("vdFeatureManager");const{ENVS:n}=Ut,s=Tn[n.PRODUCTION];(Ut.isTest()||Ut.isDevelopment())&&(y(s,Tn[n.TEST]),Ut.isDevelopment()&&y(s,Tn[n.DEVELOPMENT])),e.requireFeatures(s)}]),t.module("webregister").config(["$animateProvider",function(e){e.classNameFilter(/wr-transition-*|vd-quick-key-folder-view-container|sale-body|sale-list-item/)}]);t.module("webregister").run(["$uiRouter",function(e){ze.put("current-sale/faux-quick-keys.html",'<div class="vd-quick-keys wr-faux-quick-keys vd-mb4">\n  <div class="vd-quick-key-grid">\n    <div class="vd-quick-key-page">\n      <div class="vd-quick-key-page-column">\n        <div class="vd-quick-key vd-quick-key--yellow vd-quick-key--quick-key">\n          <div class="vd-quick-key-inner">\n              <span class="vd-quick-key-label">\n                  Giftcard\n              </span>\n          </div>\n        </div>\n      </div>\n      <div class="vd-quick-key-page-column">\n        <div class="vd-quick-key vd-quick-key--purple vd-quick-key--quick-key">\n          <div class="vd-quick-key-inner">\n              <span class="vd-quick-key-label">\n                  Bracelet\n              </span>\n          </div>\n        </div>\n      </div>\n      <div class="vd-quick-key-page-column">\n        <div class="vd-quick-key vd-quick-key--orange vd-quick-key--quick-key">\n          <div class="vd-quick-key-inner">\n              <span class="vd-quick-key-label">\n                  Sunnies\n              </span>\n          </div>\n        </div>\n      </div>\n      <div class="vd-quick-key-page-column">\n        <div class="vd-quick-key vd-quick-key--red vd-quick-key--quick-key">\n          <div class="vd-quick-key-inner">\n              <span class="vd-quick-key-label">\n                  Red Beanie\n              </span>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n'),ze.put("customer/wr-customer-form--contact.html",'<fieldset class="vd-fieldset">\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">First Name</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="firstName"\n          ng-model="customerFormCtrl.customer.first_name"\n          ng-required="!customerFormCtrl.form.lastName.$viewValue && !customerFormCtrl.form.companyName.$viewValue"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter first name">\n        <has-cc-error-message ng-if="customerFormCtrl.form.firstName.$error.hasCreditCard"></has-cc-error-message>\n        <vd-error-message ng-if="customerFormCtrl.form.firstName.$dirty && customerFormCtrl.hasMissingContactInfo()">\n          Please enter a first name, last name, or company name.\n        </vd-error-message>\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Last Name</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="lastName"\n          ng-model="customerFormCtrl.customer.last_name"\n          ng-required="!customerFormCtrl.form.firstName.$viewValue && !customerFormCtrl.form.companyName.$viewValue"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter last name">\n        <has-cc-error-message ng-if="customerFormCtrl.form.lastName.$error.hasCreditCard"></has-cc-error-message>\n        <vd-error-message ng-if="customerFormCtrl.form.lastName.$dirty && customerFormCtrl.hasMissingContactInfo()">\n          Please enter a first name, last name, or company name.\n        </vd-error-message>\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Email</div>\n      <div class="vd-value">\n        \x3c!-- Email Validation Rules reference link: http://rumkin.com/software/email/rules.php--\x3e\n        <input has-credit-card type="text" name="email"\n          ng-model="customerFormCtrl.customer.email"\n          ng-maxlength="255"\n          ng-pattern="customerFormCtrl.emailRegex"\n          ng-class="{\n            \'vd-input--error\': customerFormCtrl.form.email.$invalid,\n            \'vd-dott-border\': !customerFormCtrl.customer.email\n          }"\n          class="vd-input"\n          placeholder="Enter email address"\n          inputmode="email">\n        <has-cc-error-message ng-if="customerFormCtrl.form.email.$error.hasCreditCard" />\n        <ng-messages ng-if="!customerFormCtrl.form.email.$error.hasCreditCard && customerFormCtrl.form.email.$error.pattern">\n          <vd-error-message>Invalid email entered</vd-error-message>\n        </ng-messages>\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Contact Number</div>\n      <div class="vd-value">\n        <div class="vd-select-group">\n          <select class="vd-select"\n            ng-model="customerFormCtrl.selectedPhoneOption"\n            ng-options="option.value as option.name for option in customerFormCtrl.phoneOptions">\n          </select>\n          <input ng-model="customerFormCtrl.customer[customerFormCtrl.selectedPhoneOption]"\n            ng-maxlength="255"\n            class="vd-input"\n            placeholder="Enter {{ customerFormCtrl.selectedPhoneOption }} number"\n            inputmode="tel">\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div ng-if="customerFormCtrl.showCustomerGroup" class="vd-g-col vd-field">\n      <div class="vd-label">Customer Group</div>\n      <div class="vd-value">\n        <select class="vd-select"\n          ng-model="customerFormCtrl.customer.customer_group_id"\n          ng-options="group.id as group.name for group in customerFormCtrl.customerGroups">\n        </select>\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-value wr-media wr-media--center vd-mt6">\n        <vd-switch modifier="small"\n          ng-model="customerFormCtrl.customerOptIn"\n          ng-change="customerFormCtrl.customer.do_not_email = !customerFormCtrl.customerOptIn"\n          class="vd-mr3 wr-media-object">\n        </vd-switch>\n        <span class="wr-media-text-body">Opt-In to Marketing and Promotional Emails</span>\n      </div>\n    </div>\n  </div>\n\n  <div class="wr-media wr-media--center wr-media--card vd-mt2" ng-if="!customerFormCtrl.form.email.$viewValue">\n    <div class="wr-media-object">\n      <vd-dott></vd-dott>\n    </div>\n    <div class="wr-media-body vd-text-label">\n      Add an email address to this customer so that you can email their receipts or send them promotional&nbsp;emails.\n    </div>\n  </div>\n</fieldset>\n'),ze.put("customer/wr-customer-form--details.html",'<fieldset class="vd-fieldset">\n  <legend class="vd-legend vd-text-signpost">Postal Address</legend>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Street</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="postalStreet1"\n          ng-model="customerFormCtrl.customer.postal_address_1"\n          name="postal_address_1"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter street address">\n        <has-cc-error-message ng-if="customerFormCtrl.form.postalStreet1.$invalid" />\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Street</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="postalStreet2"\n          ng-model="customerFormCtrl.customer.postal_address_2"\n          name="postal_address_2"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter street address">\n        <has-cc-error-message ng-if="customerFormCtrl.form.postalStreet2.$invalid" />\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Suburb</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="postalSuburb"\n          ng-model="customerFormCtrl.customer.postal_suburb"\n          name="postal_suburb"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter suburb">\n        <has-cc-error-message ng-if="customerFormCtrl.form.postalSuburb.$invalid" />\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">City</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="postalCity"\n          ng-model="customerFormCtrl.customer.postal_city"\n          name="postal_city"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter city">\n        <has-cc-error-message ng-if="customerFormCtrl.form.postalCity.$invalid" />\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Postcode</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="postalPostcode"\n          ng-model="customerFormCtrl.customer.postal_postcode"\n          name="postal_postcode"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter postcode">\n        <has-cc-error-message ng-if="customerFormCtrl.form.postalPostcode.$invalid" />\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">State</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="postalState"\n          ng-model="customerFormCtrl.customer.postal_state"\n          name="postal_state"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter state">\n        <has-cc-error-message ng-if="customerFormCtrl.form.postalState.$invalid" />\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Country</div>\n      <div class="vd-value">\n        <select class="vd-select"\n          ng-class="{\'vd-text--secondary\': !customerFormCtrl.customer.postal_country_id}"\n          ng-model="customerFormCtrl.customer.postal_country_id"\n          ng-options="option.code as option.name for option in customerFormCtrl.countryOptions">\n          <option value="">Please select a country</option>\n        </select>\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-field vd-mt8" vd-flex vd-flex-align="center">\n        <vd-checkbox ng-model="customerFormCtrl.differentAddresses"\n          ng-click="customerFormCtrl.updateMatchingAddresses()"\n          label="Use different address for physical address">\n        </vd-checkbox>\n      </div>\n    </div>\n  </div>\n</fieldset>\n\n<fieldset ng-if="customerFormCtrl.differentAddresses" class="vd-fieldset">\n  <legend class="vd-legend vd-text-signpost">Physical Address</legend>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Street</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="physicalStreet1"\n          ng-model="customerFormCtrl.customer.physical_address_1"\n          name="physical_address_1"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter street address">\n        <has-cc-error-message ng-if="customerFormCtrl.form.physicalStreet1.$invalid" />\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Street</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="physicalStreet2"\n          ng-model="customerFormCtrl.customer.physical_address_2"\n          name="physical_address_2"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter street address">\n        <has-cc-error-message ng-if="customerFormCtrl.form.physicalStreet2.$invalid" />\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Suburb</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="physicalSuburb"\n          ng-model="customerFormCtrl.customer.physical_suburb"\n          name="physical_suburb"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter suburb">\n        <has-cc-error-message ng-if="customerFormCtrl.form.physicalSuburb.$invalid" />\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">City</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="physicalCity"\n          ng-model="customerFormCtrl.customer.physical_city"\n          name="physical_city"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter city">\n        <has-cc-error-message ng-if="customerFormCtrl.form.physicalCity.$invalid" />\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Postcode</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="physicalPostcode"\n          ng-model="customerFormCtrl.customer.physical_postcode"\n          name="physical_postcode"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter postcode">\n        <has-cc-error-message ng-if="customerFormCtrl.form.physicalPostcode.$invalid" />\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">State</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="physicalState"\n          ng-model="customerFormCtrl.customer.physical_state"\n          name="physical_state"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter state">\n        <has-cc-error-message ng-if="customerFormCtrl.form.physicalState.$invalid" />\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Country</div>\n      <div class="vd-value">\n        <select class="vd-select"\n          ng-class="{\'vd-text--secondary\': !customerFormCtrl.customer.physical_country_id}"\n          ng-model="customerFormCtrl.customer.physical_country_id"\n          ng-options="option.code as option.name for option in customerFormCtrl.countryOptions">\n          <option value="">Please select a country</option>\n        </select>\n      </div>\n    </div>\n  </div>\n</fieldset>\n\n<fieldset class="vd-fieldset">\n  <legend class="vd-legend vd-text-signpost">Additional Information</legend>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Company Name</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="companyName"\n          ng-model="customerFormCtrl.customer.company_name"\n          ng-required="!customerFormCtrl.form.firstName.$viewValue && !customerFormCtrl.form.lastName.$viewValue"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter company name">\n        <has-cc-error-message ng-if="customerFormCtrl.form.companyName.$error.hasCreditCard"></has-cc-error-message>\n        <vd-error-message ng-if="customerFormCtrl.form.companyName.$dirty && customerFormCtrl.hasMissingContactInfo()">\n          Please enter a first name, last name, or company name.\n        </vd-error-message>\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-g-col vd-field">\n        <div class="vd-label">Website</div>\n        <div class="vd-value">\n          <input ng-model="customerFormCtrl.customer.website"\n            ng-maxlength="255"\n            class="vd-input"\n            placeholder="Enter website"\n            inputmode="url">\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Date of Birth</div>\n      <div class="vd-value">\n          <input\n            vd-date="customerFormCtrl.DOBFormatOptions"\n            vd-datepicker="customerFormCtrl.DOBOptions"\n            ng-model="customerFormCtrl.customer.date_of_birth"\n            vd-input-symbol="{ align: \'left\', icon: \'fa fa-calendar\' }"\n            placeholder="Choose a date\u2026"\n            class="vd-select">\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Gender</div>\n      <div class="vd-value">\n        <select class="vd-select"\n          ng-class="{\'vd-text--secondary\': !customerFormCtrl.customer.gender}"\n          data-cy="customer-gender"\n          ng-model="customerFormCtrl.customer.gender"\n          ng-options="option.value as option.name for option in customerFormCtrl.genderOptions">\n        </select>\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Customer Code</div>\n      <div class="vd-value">\n        <input ng-model="customerFormCtrl.customer.customer_code"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter customer code">\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Note</div>\n      <div class="vd-value">\n        <div customer-note name="note" ng-model="customerFormCtrl.customer.note" placeholder="Enter a note for this customer"></div>\n        <has-cc-error-message ng-if="customerFormCtrl.form.note.$invalid" />\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2" ng-if="customerFormCtrl.loyaltyEnabled">\n    <div class="vd-g-col vd-field" ng-if="customerFormCtrl.loyaltyEnabled">\n      <div class="vd-value wr-media wr-media--center">\n        <vd-switch modifier="small" ng-model="customerFormCtrl.customer.enable_loyalty" class="vd-mr3"></vd-switch>\n        <span class="wr-media-text-body">Enable loyalty for this customer</span>\n      </div>\n    </div>\n  </div>\n</fieldset>\n\n<fieldset class="vd-fieldset">\n  <legend class="vd-legend vd-text-signpost">Custom Fields</legend>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Custom Field 1</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="customField1"\n          ng-model="customerFormCtrl.customer.custom_field_1"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter custom value">\n        <has-cc-error-message ng-if="customerFormCtrl.form.customField1.$invalid" />\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Custom Field 2</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="customField2"\n          ng-model="customerFormCtrl.customer.custom_field_2"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter custom value">\n        <has-cc-error-message ng-if="customerFormCtrl.form.customField2.$invalid" />\n      </div>\n    </div>\n  </div>\n\n  <div class="vd-g-row vd-g-row--gutter-l vd-g-xs-up-1 vd-g-m-up-2">\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Custom Field 3</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="customField3"\n          ng-model="customerFormCtrl.customer.custom_field_3"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter custom value">\n        <has-cc-error-message ng-if="customerFormCtrl.form.customField3.$invalid" />\n      </div>\n    </div>\n    <div class="vd-g-col vd-field">\n      <div class="vd-label">Custom Field 4</div>\n      <div class="vd-value">\n        <input has-credit-card\n          name="customField4"\n          ng-model="customerFormCtrl.customer.custom_field_4"\n          ng-maxlength="255"\n          class="vd-input"\n          placeholder="Enter custom value">\n        <has-cc-error-message ng-if="customerFormCtrl.form.customField4.$invalid" />\n      </div>\n    </div>\n  </div>\n</fieldset>\n'),ze.put("customer/customer-error.html",'<p class="vd-p">\n  We\u2019re currently unable to search your customers.<br />\n  You can still add a customer to the sale using their customer&nbsp;code.\n</p>\n<span class="vd-text-supplementary">\n  You can find customer codes in the Customers tab.\n</span>\n'),ze.put("loading-skeleton/loading-skeleton.html",'<div class="loading-skeleton">\n  <div class="loading-skeleton-sidebar"></div>\n  <div class="loading-skeleton-topbar"></div>\n  <div class="loading-skeleton-content vd-pa5">\n    <div class="vd-loader loading-skeleton-loader"></div>\n    <div class="vd-text-heading vd-mb3">\n      Getting ready to sell\u2026\n    </div>\n    <p class="vd-p">\n      If you\u2019re loading for the first time, this might take a while.\n    </p>\n  </div>\n  <noscript class="loading-skeleton-noscript vd-pa5">\n    <img src="https://vendfrontendassets.freetls.fastly.net/images/error/cannot-fetch-data-v3.svg" />\n    <h2 class="vd-mt3 vd-header vd-header--subpage">Sorry, we couldn\u2019t load this&nbsp;page.</h2>\n    <p class="vd-p vd-mt5 vd-mb5">\n      Please make sure JavaScript is enabled in your browser, then refresh the page.<br> See\n      <a href="https://www.enable-javascript.com/"\n        class="vd-link vd-link--secondary"\n        target="_blank"\n        rel="noreferrer noopener">\n        how&nbsp;to&nbsp;enable&nbsp;JavaScript\n      </a>.\n    </p>\n  </noscript>\n</div>\n'),ze.put("product/product-error.html",'<p class="vd-p">\n  We\u2019re currently unable to search your&nbsp;products.<br />\n  You can still add products to the sale using the barcode&nbsp;or&nbsp;SKU.\n</p>\n'),ze.put("status/status-error-sales.html",'<vd-section ng-if="statusErrorSalesCtrl.erroredSales.length" class="status-error-sales">\n  <vd-header>\n    <span class="fa fa-warning status-error-sales-heading-icon vd-mr1"></span>\n    Sales with errors - {{statusErrorSalesCtrl.erroredSales.length}} of your sales couldn\'t be saved to our servers.\n  </vd-header>\n\n  <p class="vd-p">\n    We\u2019ve had a problem trying to save {{statusErrorSalesCtrl.erroredSales.length}} of your sales to our servers. Don\u2019t\n    worry, these sales have been saved in your browser. It\u2019s important not to clear your browser cache or reset data,\n    as your sales will be deleted and cannot be recovered.\n  </p>\n\n  <table class="vd-table vd-table--fixed">\n    <thead>\n    <tr>\n      <th class="vd-pl0">Date</th>\n      <th class="vd-pl1">Status</th>\n      <th class="vd-pl1">User</th>\n      <th class="vd-pl1">Customer</th>\n      <th class="vd-pl1 vd-align-right">Total</th>\n      <th class="vd-pl1">Note</th>\n    </tr>\n    </thead>\n\n    <tbody>\n      <tr ng-repeat="sale in statusErrorSalesCtrl.erroredSales | orderBy : \'saleDate\' : true">\n        <td class="vd-pl0">{{::sale.saleDate | wrDateFormat:\'MMM D, YYYY HH:mm:ss\':webRegisterCtrl.outlet.time_zone}}</td>\n        <td class="vd-pl1">{{::sale | wrSaleStatus}}</td>\n        <td class="vd-pl1">{{::(sale.user | wrUserName) || \'\u2013\'}}</td>\n        <td class="vd-pl1">{{::(sale.customer | wrCustomerName) || \'\u2013\'}}</td>\n        <td class="vd-pl1 vd-align-right">\n          {{::sale.finals.inclusivePrice | vdCurrency}}\n        </td>\n        <td class="vd-pl1 vd-truncate">{{::sale.note || \'-\'}}</td>\n      </tr>\n    </tbody>\n\n  </table>\n  <div class="status-error-sales-actions vd-mt5">\n    <button class="vd-btn vd-btn--supplementary"\n      ng-click="statusErrorSalesCtrl.showDownloadErroredSalesModal()"\n      ng-disabled="statusErrorSalesCtrl.saleSyncManager.saleSyncRetryInProgress">\n      {{ statusErrorSalesCtrl.saleSyncManager.saleSyncRetryInProgress ?\n        \'Syncing Sales\u2026\' :\n        \'Download Errored Sales\'\n      }}\n    </button>\n  </div>\n</vd-section>\n'),e.stateService.defaultErrorHandler(e=>{if(e.detail&&!(e.detail instanceof wn))throw e})}]);
